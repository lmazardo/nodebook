<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Créer une application&#160;web</title>
<style>
#header,
#content,
#footer {
  margin: 2rem auto;
  max-width: 46rem;
}

#header {
  margin-top: 0;
}

.title,
#toctitle {
  color: var(--dark-accent);
}

a {
  /* white-space: nowrap; */
}

img, iframe, video, audio {
  max-width: 100%;
}

p {
  font-weight: normal;
}

/* Taken out from book.css */
dl dt {
  margin-bottom: 0.3125em;
  font-weight: bold;
}
dl dd {
  margin-bottom: 1.25em;
}

dt,
th.tableblock,
td.content,
div.footnote {
  text-rendering: optimizeLegibility;
}

.literalblock pre,
.literalblock pre[class],
.listingblock pre,
.listingblock pre[class] {
  overflow: auto;
  word-wrap: break-word;
}
.literalblock pre.nowrap,
.literalblock pre[class].nowrap,
.listingblock pre.nowrap,
.listingblock pre[class].nowrap {
  overflow-x: auto;
  white-space: pre;
  word-wrap: normal;
}

.listingblock {
  margin: 0 0 2em;
}
.listingblock > .content {
  position: relative;
}
.listingblock > .title {
  font-weight: bold;
}
.listingblock code[data-lang]::before {
  display: none;
  content: attr(data-lang);
  position: absolute;
  font-size: 0.75em;
  top: 1em;
  right: 1em;
  line-height: 1;
  text-transform: uppercase;
  color: #999;
}
.listingblock:hover code[data-lang]::before {
  display: block;
}
.listingblock.terminal pre .command::before {
  content: attr(data-prompt);
  padding-right: 0.5em;
  color: #999;
}

td.hdlist1,
td.hdlist2 {
  vertical-align: top;
  padding-right: 0.625em;
}
td.hdlist1 {
  font-weight: bold;
}
.literalblock + .colist,
.listingblock + .colist {
  margin-top: -1.5em;
}
.colist td:not([class]):first-child {
  padding: 0.4em 0.75em 0 0.75em;
  line-height: 1;
  vertical-align: top;
}
.colist td:not([class]):first-child img {
  max-width: none;
}
.colist td:not([class]):last-child {
  padding: 0.25em 0;
}

/* Custom classes */

.line-through {
  text-decoration: line-through;
}

.RemarquePreTitre,
#toctitle {
  font-style: normal;
  font-weight: bold;
}
  .RemarquePreTitre::after {
    content: "•";
    padding-left: 5px;
  }
.admonitionblock {
}
.admonitionblock > table,
.exampleblock {
  --commented: rgba(17, 17, 68, .65);
  --border-radius-base: 8px;

  background-color: #fafafa;
  border: 1px solid var(--dark-shade);
  border-left: none;
  border-right: none;
  margin: 1.5em 0;
  padding: 1em;
}
.exampleblock .title {
  font-weight: bold;
}
.icon .title {
  font-size: 2em;
}
  .admonitionblock > table td.icon {
    display: none;
  }

  @media screen and (min-width: 769px) {
    .admonitionblock > table td.icon {
      display: table-cell;
    }
  }

  .admonitionblock > table td.icon {
    padding-right: 1em;
  }
  .admonitionblock > table td.icon img {
    max-width: none;
  }

.colist ol {
  margin-left: 1.5em;  /* aligns with the listing edge */
  padding-left: 0;
  font-weight: bold;   /* makes it stand out more */
}
  .colist ol p {
    margin: 0 0 .5em;
  }
.listingblock:not(.prismjs) pre,
.language-bash.hljs {
  background: #323232;
  color: wheat;
  margin: 0;
  padding: 1rem;
}
.language-bash.hljs .hljs-built_in,
.language-bash.hljs .hljs-builtin-name {
  color: white;
}
.language-bash.hljs .hljs-string {
  color: lightgreen;
}
.language-bash.hljs .hljs-variable {
  color: lightskyblue;
}
.keyseq {
  font-weight: normal;
  white-space: nowrap;
}
.language-bash.hljs .keyseq {
  color: white;
}
.language-bash.hljs kbd {
  background: transparent;
  box-shadow: none;
  color: white;
  font-size: 0.8em;
  font-weight: bold;
  padding: 0.1em 0.4em;
}
.listingblock pre.highlightjs,
.listingblock.prismjs pre {
  background-color: transparent;
  margin: 0;
  padding: 0;
}
.listingblock pre.highlightjs > code,
.listingblock.prismjs .highlight {
  border-left: 4px solid var(--dark-accent);
  padding-left: 1em;
  font-size: .8em;
}
.listingblock pre.highlightjs > code.language-bash {
  border-left-color: limegreen;
}

.hdlist .hdlist1 {
  text-align: right;
  white-space: nowrap;
}

td > p:first-child {
  margin-top: 0;
}

.hljs-comment {
  font-style: normal !important;
}

#toc.toc2 a {
  text-decoration: none;
  white-space: normal;
}
  #toc.toc2 a:hover,
  #toc.toc2 a:focus {
    text-decoration: underline;
  }

#toc.toc2 ul {
  list-style: none;
}

  #toc.toc2 > ul {
    padding-left: 0;
  }

  #toc.toc2 ul ul {
    padding-left: 1em;
  }

@media screen and (min-width: 769px) {
  body {
    padding-left: 25vw !important;
  }

  #header,
  #content,
  #footer {
    margin-left: 0;
  }

  #toc.toc2 {
    height: 100%;
    left: 0;
    max-width: 20vw;
    overflow: auto;
    padding: 1rem;
    position: fixed;
    top: 0;
    z-index: 1000;
  }

  #toc.toc2 > ul {
    font-size: 0.85em;
  }

  #toc li.active > a[href^="#"],
  [id]:target {
    background: #ffc;
  }
}

.admonitionblock.context-callout > table {
  border-width: 5px;
  border-color: var(--brand-color);
}

</style>
<link rel="stylesheet" href="https://oncletom.io/styles/blog.css?v=v3.3.2">
<!-- WebMentions -->
<link rel="pingback" href="https://webmention.io/oncletom.io/xmlrpc">
<link rel="webmention" href="https://webmention.io/oncletom.io/webmention">
<!-- Open Graph -->
<meta property="og:type" content="book">
<meta property="og:book:author" content="Thomas Parisot">
<meta property="og:book:isbn" content="978-2212139938">
<meta property="og:book:release_date" content="978-2212139938">
<meta property="og:book:tag" content="Node.js">
<meta property="og:book:tag" content="JavaScript">
<meta property="og:book:tag" content="npm">
<meta property="og:book:tag" content="Développement front-end">
<meta property="og:book:tag" content="Développement back-end">
<meta property="og:locale" content="fr_FR">
<meta property="og:site_name" content="Node.js • Apprendre par la pratique">
<!-- Twitter OpenGraph -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@oncletom">
<meta name="twitter:creator" content="@oncletom">
<style type="text/css" class="prism-theme">/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<style type="text/css" class="extension-interactive-runner">[data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
  background-color: #fcfcfc;
  border: 1px solid #0c2;
  border-radius: 1px;
  color: #0c2;
  cursor: pointer;
  display: inline-block;
  font-weight: bold;
  padding: .5em 1em;
  top: -2em;
}

  [lang="en"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "▶ run code";
  }
  [lang="fr"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "▶ voir le résultat";
  }
  .interactive--javascript code[data-label]:before {
    content: attr(data-label);
  }

.interactive iframe {
  position: absolute;
  visibility: hidden;
}

.interactive.status--loaded iframe {
  position: inherit;
  visibility: visible;
}

.interactive.status--loading {
  opacity: .5;
}
</style>
<script class="extension-interactive-runner">
(function(d){
  document.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://embed.runkit.com/';
    script.async = true;
    script.onload = function(){
      function makeListingInteractive (element){
  if (element.classList.contains('interactive--installed') || element.classList.contains('status--loading')) {
    return;
  }

  const code = element.querySelector('code');
  const nodeVersion = /interactive--runtime--node-([^\s]+)/.exec(element.className)[1];
  const isEndpoint = element.classList.contains('interactive--endpoint');
  const mode = isEndpoint ? 'endpoint' : null;
  let preamble = '';

  const source = code
    .textContent
    .replace(/\/\/\s*\(\d+\)$/gm, '')
    .replace(/^["']?use strict["'][; ]*\n/, '');

  if (isEndpoint) {
    preamble = `process.nextTick(() => {
      if (typeof module.exports === 'function') {
        exports.endpoint = module.exports;
      }
      else if (typeof server !== 'undefined') {
        exports.endpoint = server.listeners("request").pop();
      }
});`
  }

  element.classList.add('status--loading');

  // eslint-disable-next-line no-undef
  RunKit.createNotebook({
    nodeVersion,
    element,
    source,
    mode,
    preamble,
    onLoad: function(ntbk) {
      element.classList.add('interactive--installed');
      element.classList.remove('status--loading');
      element.classList.add('status--loaded');
      code.parentNode.setAttribute('hidden', true);

      ntbk.evaluate();
    }
  });
}
function installEvents () {
  function getParent(el, condition) {
    let parent = el;

    while(parent = parent.parentNode) {
      if (condition(parent)) {
        return parent;
      }
    }
  }

  function hasClass(className) {
    return function check(el) {
      return el.classList.contains(className);
    }
  }

  document.querySelector('body').addEventListener('click', function(el) {
    if (el.target.classList.contains('language-javascript') || el.target.classList.contains('language-js')) {
      const parentNode = getParent(
        el.target,
        hasClass('interactive--javascript')
      );

      makeListingInteractive(parentNode);
    }
  });
}
      installEvents();
      document.body.dataset.interactiveRuntime = 'loaded';
    };
    document.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
.listingblock [data-bash-subs]::before {
  content: attr(data-bash-subs) " ";
  opacity: .5; }

.listingblock [data-bash-conum]::before {
  content: "(" attr(data-bash-conum) ")";
  font-weight: bold;
  opacity: .7;
}</style>
<script>
(function(d){
  d.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://unpkg.com/menuspy@1.3.0/dist/menuspy.js';
    script.async = true;
    script.onload = () => new MenuSpy(document.querySelector('#toc'), {enableLocationHash: false});
    d.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
#toc li.active > a[href^="#"] {
  font-weight: bold;
}
#toc li.active > a[href^="#"]::before {
  content: "▶ ";
  display: inline-block;
  position: absolute;
  margin-left: -1.2em;
  font-size: .8em;
  margin-top: 3px;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Créer une application&#160;web</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table des matières</div>
<ul class="sectlevel1">
<li><a href="#webapp">1. Composer son application&#160;web</a>
<ul class="sectlevel2">
<li><a href="#server">1.1. Démarrer un serveur&#160;HTTP</a></li>
<li><a href="#path">1.2. Répondre à un chemin (routing)</a></li>
<li><a href="#static">1.3. Répondre avec des fichiers statiques</a></li>
<li><a href="#arguments">1.4. Réagir aux arguments&#160;d&#8217;URL</a></li>
<li><a href="#post">1.5. Recevoir des données de formulaire&#160;(POST)</a></li>
<li><a href="#upload">1.6. Téléverser des fichiers</a></li>
<li><a href="#cookies">1.7. Garder un lien avec les cookies</a></li>
<li><a href="#templating">1.8. Structurer l&#8217;affichage avec les gabarits de présentation</a></li>
<li><a href="#dev">1.9. Pendant le développement : relancer le serveur automatiquement</a></li>
</ul>
</li>
<li><a href="#express">2. Organiser une application avec le framework Express</a>
<ul class="sectlevel2">
<li><a href="#setup">2.1. Configuration du framework</a></li>
<li><a href="#middleware">2.2. Greffer des extensions (middlewares)</a></li>
<li><a href="#views">2.3. Brancher les gabarits de présentation</a></li>
<li><a href="#frontend">2.4. Intégrer les ressources front-end (CSS, images, JavaScript)</a></li>
<li><a href="#database">2.5. Brancher une base de données</a></li>
<li><a href="#sessions">2.6. Sessions utilisateurs</a></li>
<li><a href="#logs">2.7. Tracer les actions&#160;(logs)</a></li>
</ul>
</li>
<li><a href="#modularity">3. Vers un code réutilisable et testable</a>
<ul class="sectlevel2">
<li><a href="#modulariser_le_code_des_routes">3.1. Modulariser le code des routes</a></li>
<li><a href="#tests.unit">3.2. Un code testable est un code indépendant du framework</a></li>
<li><a href="#deployment">3.3. Déployer automatiquement</a></li>
</ul>
</li>
<li><a href="#advanced">4. Pour aller plus loin</a>
<ul class="sectlevel2">
<li><a href="#advanced.server">4.1. Pourquoi lancer un serveur ?</a></li>
<li><a href="#http">4.2. Comprendre le modèle&#160;HTTP</a></li>
<li><a href="#database-choice">4.3. Quel(s) moteur(s) de base(s) de données choisir ?</a></li>
<li><a href="#security">4.4. Protéger nos applications</a></li>
<li><a href="#lambda">4.5. Une application minimaliste avec les Lambda</a></li>
</ul>
</li>
<li><a href="#conclusion">5. Conclusion</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock tip context-callout">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="paragraph">
<p>Vous êtes en train de lire le
<a href="https://oncletom.io/node.js/">livre &#8220;Node.js&#8221;</a>, écrit par
<a href="https://oncletom.io">Thomas Parisot</a> et publié par les
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">Éditions Eyrolles</a>.</p>
</div>
<div class="paragraph">
<p>Il vous plaît&#160;? Achetez-le en ligne sur
<a href="https://amzn.to/2E58PEw">Amazon</a>,
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">Eyrolles</a> ou
<a href="https://www.placedeslibraires.fr/livre/9782212139938">Place des Libraires</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons apprendre à composer et à tester une application web créée de toutes
pièces ou avec l&#8217;aide du framework Express.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Sommaire</div>
<ul>
<li>
<p>Composer son application web</p>
</li>
<li>
<p>Organiser une application avec le framework Express</p>
</li>
<li>
<p>Vers un code réutilisable et testable</p>
</li>
<li>
<p>Pour aller plus loin</p>
</li>
</ul>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Le modèle d&#8217;application web de Node se rapproche de celui de Ruby et diffère
de l&#8217;univers PHP.</p>
</div>
<div class="paragraph">
<p>Nous allons mieux comprendre le mécanisme de requête et de réponse HTTP en
créant une application web module par module, fonctionnalité par fonctionnalité.</p>
</div>
<div class="paragraph">
<p>Dans un second temps, nous organiserons notre code avec le framework Express.
Nous verrons en quoi notre application gagne en clarté, comment générer du HTML
de façon dynamique avec des informations issues d&#8217;une base de données.</p>
</div>
<div class="paragraph">
<p>Nous consoliderons notre savoir en organisant notre code de sorte à le
rendre plus résilient et testable&#160;– chose que nous apprendrons à faire pas à pas.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Versions de Node et npm</div>
<div class="paragraph">
<p>Le contenu de ce chapitre utilise les versions <strong>Node&#160;v10</strong>
et <strong>npm&#160;v6</strong>.
Ce sont les versions stables recommandées en&#160;2019.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une application web est une <strong>construction applicative qui est à l&#8217;écoute</strong>
de connexions réseau initiées par un client&#160;– un navigateur, un automate, etc.
Elle est structurée autour de la lecture d&#8217;une requête entrante (lecture)
et de l&#8217;émission d&#8217;une réponse sortante (écriture).
Chaque <strong>requête porte en elle une intention</strong> (un chemin d&#8217;accès, une préférence
de format, des éléments d&#8217;identification) et implique une réponse en retour
(des données et des éléments pour les contextualiser).</p>
</div>
<div class="paragraph">
<p>L&#8217;ingénierie d&#8217;une application web consiste à comprendre les requêtes entrantes
et à construire une réponse appropriée à chaque fois, le plus rapidement possible.</p>
</div>
<div class="paragraph">
<p>Ce chapitre s&#8217;inscrit dans la continuité de la découverte du
<a href="../chapter-04/index.html#http">module <code>http</code></a>
(<a href="../chapter-04/index.html">chapitre&#160;4</a>).
</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> En-têtes&#160;HTTP</div>
<div class="paragraph">
<p>


Ce chapitre fait souvent référence à des en-têtes HTTP.
La documentation <em>MDN&#160;web&#160;docs</em>
les liste tous, avec le détail de leurs valeurs possibles&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://developer.mozilla.org/fr/docs/Web/HTTP/Headers" class="bare">developer.mozilla.org/fr/docs/Web/HTTP/Headers</a></span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est un onglet intéressant à ouvrir en parallèle de cette lecture
– je l&#8217;ai ouvert en permanence pour écrire ce chapitre.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="webapp">1. Composer son application&#160;web</h2>
<div class="sectionbody">
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Dans cette première section, nous allons nous focaliser sur la construction
d&#8217;une application web avec une approche modulaire.
Nous partirons du concept de requête et de réponse.
Petit à petit, nous allons greffer des modules pour comprendre et
donner du sens à leurs contenus respectifs.</p>
</div>
<div class="paragraph">
<p>Le <em>protocole HTTP</em> est le dialecte informatique utilisé et compris pour exprimer
les requêtes (émises par un client) et les réponses (émises par un serveur).

Les navigateurs web sont des clients tandis que notre application Node est un serveur.</p>
</div>
<div class="paragraph">
<p>Le logiciel <em>curl</em> (<span class="URL"><a href="https://curl.haxx.se" class="bare">curl.haxx.se</a></span>) est un client en ligne de commandes.
Il est souvent installé par défaut sur les distributions Linux, sur macOS et
à partir de Windows&#160;7&#160;– via le terminal <em>PowerShell</em>.</p>
</div>
<div class="paragraph">
<p>Utilisons <em>curl</em> pour observer le contenu d&#8217;une requête et de sa réponse.

</p>
</div>
<div class="listingblock">
<div class="title">Exemple de requête HTTP vers le site <span class="URL">perdu.com</span></div>
<div class="content">
<pre><span data-bash-subs="$"></span>curl -v http://perdu.com   <span data-bash-conum="1"></span>
GET / HTTP/1.1               <span data-bash-conum="2"></span>
Host: perdu.com              <span data-bash-conum="3"></span>
User-Agent: curl/7.54.0
Accept: */*</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Exécution de la requête.</p>
</li>
<li>
<p>Expression de la méthode, du chemin d&#8217;accès demandé et du protocole de discussion employé&#160;– ici, HTTP dans sa version&#160;<code>1.1</code>.</p>
</li>
<li>
<p>En-tête de requête.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Un en-tête est exprimé sous la forme <code>Clé: Valeur</code>.

Chacun précise un élément de contexte.
Certains influencent plus que d&#8217;autres la réponse du serveur, si
celui-ci les comprend.</p>
</div>
<div class="paragraph">
<p>Voyons maintenant la réponse&#160;:
</p>
</div>
<div class="listingblock">
<div class="title">Exemple de réponse HTTP transmise en retour</div>
<div class="content">
<pre>HTTP/1.1 200 OK                                        <span data-bash-conum="1"></span>
Date: Thu, 28 Jun 2018 19:02:27 GMT                    <span data-bash-conum="2"></span>
Server: Apache
Last-Modified: Thu, 02 Jun 2016 06:01:08 GMT
ETag: "cc-5344555136fe9"
Accept-Ranges: bytes
Content-Length: 204
Vary: Accept-Encoding
Content-Type: text/html                                <span data-bash-conum="3"></span>

&lt;html>&lt;head>&lt;title>Vous Etes Perdu ?&lt;/title> …&lt;/html>  <span data-bash-conum="4"></span></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Expression du statut de la réponse avec un code numérique et une version intelligible.</p>
</li>
<li>
<p>En-tête de réponse.</p>
</li>
<li>
<p>En-tête de réponse&#160;– celle-ci indique au client comment interpréter le corps du message.</p>
</li>
<li>
<p>Corps du message.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La réponse dispose elle aussi d&#8217;en-têtes.
Cette fois, ils guident le client dans son interprétation du résultat.
Le corps du message est séparé par une ligne vide.
C&#8217;est la partie visible de la réponse dans un navigateur web, le contenu
qui s&#8217;affiche sous nos&#160;yeux.</p>
</div>
<div class="paragraph">
<p>Dans la prochaine section, nous visualiserons ces mêmes informations
à partir d&#8217;un serveur HTTP que nous allons créer par nous-même.
Nous retracerons plus en détail l&#8217;odyssée d&#8217;une requête HTTP dans la section
&#8220;<a href="#http">Comprendre le modèle HTTP</a>&#8221;, en fin de chapitre.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Jouer avec les exemples dans un terminal</div>
<div class="paragraph">
<p>Les exemples titrés d&#8217;un nom de fichier peuvent être installés sur votre ordinateur.
Exécutez-les dans un terminal et amusez-vous à les modifier en parallèle de
votre lecture pour voir ce qui change.</p>
</div>
<div class="listingblock">
<div class="title">Installation des exemples via le module npm <code>nodebook</code></div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm install --global nodebook
<span data-bash-subs="$"></span>nodebook install chapter-07
<span data-bash-subs="$"></span>cd $(nodebook dir chapter-07)</pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante devrait afficher un résultat qui confirme que vous êtes
au bon endroit&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node hello.js</pre>
</div>
</div>
<div class="paragraph">
<p>Suivez à nouveau les instructions d&#8217;installation pour rétablir les exemples
dans leur état initial.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="server">1.1. Démarrer un serveur&#160;HTTP</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Nous l&#8217;avons dit&#160;: une requête HTTP envoyée vers un hôte reçoit une réponse.
Cet hôte doit au préalable avoir installé et démarré un serveur HTTP qui
écoute ces demandes.</p>
</div>
<div class="paragraph">
<p>Le script d&#8217;exemple <code>server/start.js</code> répond à ce besoin.
Une fois démarré, il est joignable à l&#8217;adresse <code><a href="http://localhost:4000" class="bare">localhost:4000</a></code>.
Il affichera alors les en-têtes des requêtes et de leurs réponses&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node server/start.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10 interactive--endpoint">
<div class="title">server/start.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Hello World&lt;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Comme nous retournons du HTML au client, nous explicitons le type de contenu de la réponse.</p>
</li>
<li>
<p>Affiche les en-têtes de la requête reçue par le serveur&#160;– le contenu varie selon le client utilisé.</p>
</li>
<li>
<p>Affiche les en-têtes de la réponse&#160;– en l&#8217;occurrence <code>{ 'content-type': 'text/html' }</code>.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous avons composé les fondations minimales pour créer une application web
en mesure d&#8217;accepter des requêtes et de répondre quelque chose
d&#8217;arbitraire certes mais compréhensible par un navigateur web.</p>
</div>
<div class="paragraph">
<p><strong>Pourquoi avoir démarré le serveur sur le port&#160;4000</strong> dans l&#8217;exemple précédent&#160;?


C&#8217;est un choix arbitraire de ma part&#160;: nous pouvons démarrer un serveur HTTP
sur n&#8217;importe quel port tant qu&#8217;il est libre et supérieur ou égal à&#160;1000.
Quand on cherche à se connecter à une adresse comme <span class="URL"><a href="http://localhost" class="bare">localhost</a></span> (HTTP)
et <span class="URL"><a href="https://localhost" class="bare">localhost</a></span> (HTTPS), la valeur du port vaut implicitement 80
et&#160;443, respectivement.</p>
</div>
<div class="paragraph">
<p>Le module&#160;<code>npm</code> <em>get-port</em> (<span class="URL"><a href="https://npmjs.com/get-port" class="bare">npmjs.com/get-port</a></span>) retourne
un numéro de port parmi ceux disponibles sur le système d&#8217;exploitation.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node server/port.js
http://localhost:51765</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">server/port.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getPort <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'get-port'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token punctuation">:</span> <span class="token number">4000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">port</span> <span class="token operator">=></span> <span class="token punctuation">{</span>      <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>
  server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Exprime une préférence pour retourner le port 4000 s&#8217;il est disponible.</p>
</li>
<li>
<p>Affiche <code><a href="http://localhost:4000" class="bare">localhost:4000</a></code> si le port est disponible&#160;; sinon, un autre nombre.</p>
</li>
<li>
<p>Le serveur se met à l&#8217;écoute sur ce port.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour vous en rendre compte, démarrez le script <code>server/start.js</code> pour utiliser
le port 4000 et démarrez ensuite <code>server/port.js</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performance</span> Programme de longue durée</div>
<div class="paragraph">
<p>Une application web est un programme qui tourne en continu, pendant des heures
et des journées entières.</p>
</div>
<div class="paragraph">
<p>Chaque requête entrante occupe 1&#160;Ko de mémoire&#160;– davantage si nous
recevons des données de formulaire ou une pièce&#160;jointe.
Une application web peut en recevoir plusieurs centaines à plusieurs milliers
par seconde, selon la popularité du service.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="path">1.2. Répondre à un chemin (routing)</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Nous avons vu qu&#8217;une URL est un identifiant qui se décompose en plusieurs
parties grâce au <a href="../chapter-04/index.html#url">module <code>url</code></a>
(<a href="../chapter-04/index.html">chapitre&#160;4</a>).

Une d&#8217;elles est le <em>chemin d&#8217;accès</em> à une ressource.<br>
Par exemple, le chemin de l&#8217;URL <span class="URL"><a href="http://localhost:4000/coucou" class="bare">localhost:4000/coucou</a></span> est <code>/coucou</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node path/request-url.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">path/request-url.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment">// <b class="conum">(1)</b></span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;a href="/hello">clique-moi&lt;/a>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/coucou'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token comment">// <b class="conum">(2)</b></span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;a href="/">coucou !&lt;/a>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche un message spécifique au chemin&#160;<code>/</code>.</p>
</li>
<li>
<p>Affiche un autre message spécifique au chemin <code>/coucou</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les deux seules ressources mises à disposition sur <span class="URL"><a href="http://localhost:4000" class="bare">localhost:4000</a></span>
sont accessibles avec les chemins&#160;<code>/</code> et <code>/coucou</code>.
Aucun autre chemin n&#8217;aboutira.</p>
</div>
<div class="paragraph">
<p>C&#8217;est d&#8217;ailleurs un problème puisque, en réalité, nous n&#8217;envoyons pas de réponse
pour un chemin inconnu.
Et c&#8217;est à nous de gérer ce cas de figure&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node path/404.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">path/404.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment">// <b class="conum">(1)</b></span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;a href="/hello">clique-moi&lt;/a>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(2)</b></span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Page introuvable&lt;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Seul le chemin&#160;<code>/</code> est disponible dans l&#8217;application.</p>
</li>
<li>
<p>Le code HTTP de la réponse est réglé sur&#160;<code>404</code>.</p>
</li>
<li>
<p>Une requête vers une page introuvable peut quand même recevoir du contenu.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La prise en compte d&#8217;une ressource inconnue de notre application fait émerger
un nouveau concept&#160;: le <em>statut de la réponse</em>.



Ce statut est un code numérique qui donne des indications sur la ressource retournée.
Dans ce cas de figure, le statut&#160;<code>404</code> de la réponse indique au client de
ne pas considérer le contenu comme celui qui était demandé.<br>
Par défaut et sauf mention contraire, le statut est&#160;<code>200</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 1. Principaux codes HTTP et leur signification</caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Code</th>
<th class="tableblock halign-left valign-top">Raison</th>
<th class="tableblock halign-left valign-top">Explication</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>200</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OK</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource demandée est retournée en réponse.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>301</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Moved Permanently</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource demandée a été déplacée.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>304</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not Modified</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource n&#8217;a pas été modifiée depuis la dernière&#160;fois.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>400</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bad Request</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La requête est incomplète ou incompréhensible par le serveur.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>401</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Unauthorized</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource n&#8217;est accessible que sur preuve d&#8217;identification.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>403</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Forbidden</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L&#8217;accès à la ressource est interdit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>404</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not Found</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource n&#8217;existe&#160;pas.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Internal Server Error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Le serveur distant est en erreur.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Les statuts HTTP sont importants dans la création d&#8217;applications web.
Leur code permet de vérifier que le client et le serveur se sont bien compris.<br>
Si une page d&#8217;erreur est affichée avec un statut&#160;<code>200</code>, le client sera dans
l&#8217;impossibilité de deviner qu&#8217;il ne s&#8217;agit pas du contenu attendu.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 2. D&#8217;autres codes HTTP utiles à connaître</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Code</th>
<th class="tableblock halign-left valign-top">Raison</th>
<th class="tableblock halign-left valign-top">Explication</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>201</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Created</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource demandée a été créée.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>202</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Accepted</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La demande a été acceptée et la ressource sera disponible ultérieurement.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>204</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>No Content</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource demandée n&#8217;a pas de contenu.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>302</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Found</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource demandée est temporairement disponible à une autre adresse.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>503</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Service Unavailable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Le serveur distant répond qu&#8217;il n&#8217;est pas disponible pour l&#8217;instant.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Une application web devient vite compliquée à gérer si nous devons lister
tous les chemins possibles.
C&#8217;est à ce moment qu&#8217;entre en jeu le <em>routing</em>, une technique pour décrire
des chemins d&#8217;accès au lieu de s&#8217;embourber dans une longue liste de <code>if &#8230;&#8203; else</code>.
</p>
</div>
<div class="paragraph">
<p>Nous utilisons le module&#160;<code>npm</code> <em>find-my-way</em> (<span class="URL"><a href="https://npmjs.com/find-my-way" class="bare">npmjs.com/find-my-way</a></span>)
pour transformer l&#8217;exemple <code>path/request-url.js</code>
en quelque chose de plus modulaire&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node path/routes.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">path/routes.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'find-my-way'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// <b class="conum">(1)</b></span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                <span class="token comment">// <b class="conum">(2)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;a href="/coucou">clique-moi&lt;/a>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/coucou'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>          <span class="token comment">// <b class="conum">(3)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;a href="/">retour&lt;/a>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> router<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(4)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création de la table de routage.</p>
</li>
<li>
<p>Définition de la réponse du chemin d&#8217;accès&#160;<code>/</code>.</p>
</li>
<li>
<p>Définition de la réponse du chemin d&#8217;accès <code>/coucou</code>.</p>
</li>
<li>
<p>Intégration du routeur aux requêtes entrantes du serveur&#160;HTTP.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les routeurs commencent à vraiment nous faire gagner du temps
lorsqu&#8217;il s&#8217;agit d&#8217;extraire des informations utiles depuis le chemin et
de les gérer dynamiquement&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node path/route-params.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">path/route-params.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'find-my-way'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/hello/:word'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> response<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(1)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`&lt;p>hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>word<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p>`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> router<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création d&#8217;une route paramétrée&#160;– le symbole <code>:word</code> est accessible dans le troisième argument, en tant que <code>params.word</code>.</p>
</li>
<li>
<p>Affiche une phrase composée avec le paramètre de notre route.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dirigez-vous vers <span class="URL"><a href="http://localhost:4000/hello/word" class="bare">localhost:4000/hello/word</a></span> pour voir le résultat s&#8217;afficher.
Changez le dernier segment du chemin pour observer le changement.</p>
</div>
<div class="paragraph">
<p>Ce mécanisme est utile pour relier un identifiant à un enregistrement précis
en base de données, par exemple.
Il se complète avec les <a href="#argument">arguments d&#8217;URL</a> pour véhiculer des
éléments optionnels&#160;– nous y reviendrons plus loin.

</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">⚠️</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Sécurité</span> Filtrer les données entrantes</div>
<div class="paragraph">
<p>
C&#8217;est le moment de rappeler que <strong>toute information saisie par l&#8217;utilisateur</strong>
doit être filtrée et nettoyée avant d&#8217;être utilisée.
L&#8217;exemple <code>path/route-params.js</code> n&#8217;est pas sécurisé&#160;; vous vous en rendrez
compte en visitant <span class="URL"><a href="http://localhost:4000/hello/&lt;script&gt;alert(h4ck)&lt;%2Fscript&gt;" class="bare">localhost:4000/hello/&lt;script&gt;alert(h4ck)&lt;%2Fscript&gt;</a></span>.<br>
Ce type de failles s&#8217;exploite pour faire fuiter des données confidentielles.</p>
</div>
<div class="paragraph">
<p>Nous verrons tous ces aspects plus en détail dans la section
&#8220;<a href="#security">Protéger l&#8217;application</a>&#8221;.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enfin, les routeurs contextualisent les actions à effectuer vis-à-vis d&#8217;une
ressource grâce au <em>verbe HTTP</em>.

Ce dernier communique une intention&#160;– récupération, mise à jour, suppression.
Le routeur organise notre code pour déclencher une action adaptée
à la méthode employée&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node path/method.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">path/method.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'find-my-way'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>          <span class="token comment">// <b class="conum">(1)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Bienvenue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>         <span class="token comment">// <b class="conum">(2)</b></span>
  response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                       <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token string">'X-Jobs'</span><span class="token punctuation">:</span> <span class="token string">'https://jobs.humancoders.com'</span>      <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Invisible'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(5)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> router<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Définition du chemin d&#8217;accès&#160;<code>/</code>&#160;– verbe <code>GET</code> (récupération).</p>
</li>
<li>
<p>Définition du chemin d&#8217;accès&#160;<code>/</code>&#160;– verbe <code>HEAD</code> cette fois.</p>
</li>
<li>
<p>La méthode <code>response.writeHead</code> est un moyen de définir le statut en même temps que les en-têtes de réponse.</p>
</li>
<li>
<p>Définition d&#8217;un en-tête personnalisé&#160;– le préfixe <code>X-</code> indique qu&#8217;il n&#8217;est pas lié au standard&#160;HTTP.</p>
</li>
<li>
<p>Écriture du corps du message&#160;– nous verrons qu&#8217;il est ignoré et n&#8217;est pas transmis au client.


</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les navigateurs web affichent seulement notre route <code>GET</code> car c&#8217;est
leur fonctionnement par défaut.
Ils comprennent le verbe <code>POST</code> pour <a href="#upload">téléverser des fichiers</a> ou
<a href="#post">transmettre des formulaires</a>.<br>


Tournons-nous à nouveau vers le programme <code>curl</code> pour observer les différences
entre les réponses nos deux verbes HTTP <code>GET</code> et&#160;<code>HEAD</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>curl http://localhost:4000
Bienvenue
<span data-bash-subs="$"></span>curl <mark>--head</mark> http://localhost:4000
HTTP/1.1 200 OK
<mark>X-Jobs: https://jobs.humancoders.com</mark>
Date: Sun, 01 Jul 2018 15:43:56 GMT
Connection: keep-alive</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <code>HEAD</code> renvoie uniquement les en-têtes de réponse et nous
économise la <a href="#templating">génération d&#8217;un gabarit</a>.
D&#8217;un point de vue client, le verbe <code>HEAD</code> aide à inspecter des ressources
sans avoir à télécharger le contenu&#160;– ce sont autant de kilo ou mégaoctets
économisés.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 3. Principaux verbes HTTP et leur utilisation</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Verbe</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Récupération d&#8217;une ressource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HEAD</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Récupération d&#8217;une ressource – seulement les en-têtes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Création d&#8217;une ressource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mise à jour d&#8217;une ressource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PATCH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mise à jour partielle d&#8217;une ressource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Demande de suppression d&#8217;une ressource.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>La responsabilité de comprendre ces verbes revient à notre application.
C&#8217;est donc à nous de leur associer une action pour les prendre en charge.</p>
</div>
</div>
<div class="sect2">
<h3 id="static">1.3. Répondre avec des fichiers statiques</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Les <a href="#path">chemins d&#8217;accès</a> s&#8217;associent aussi à des fichiers statiques.
Ainsi, à une URL correspond un fichier placé sur notre disque dur.
J&#8217;ai placé trois fichiers de différentes natures (texte, image, PDF) pour
illustrer les exemples de cette section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>tree -a static/files
static/files
├── .eslintrc.yaml
├── doc.pdf
└── screenshot.jpg</pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons commencer par mettre à disposition un seul fichier, quel que soit
le chemin demandé&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node static/stream.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">static/stream.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">requet<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> filepath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">,</span> <span class="token string">'doc.pdf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token function">createReadStream</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous constituons un chemin d&#8217;accès avec <code>path.join()</code> (<a href="../chapter-04/index.html#path">chapitre&#160;4</a>, module&#160;<code>path</code>).</p>
</li>
<li>
<p>Nous créons un flux de lecture vers ce fichier (<a href="../chapter-04/index.html#stream">chapitre&#160;4</a>, module <code>stream</code>) et nous le redirigeons vers la réponse.



</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce que cet exemple nous apprend,
c&#8217;est que l'<strong>objet de réponse est aussi un flux d&#8217;écriture</strong>.

Peu importe le volume du fichier, l&#8217;envoi se régulera en fonction de la capacité
de téléchargement du client et en consommant le minimum de mémoire possible.
La lecture sera interrompue si le client annule le téléchargement.</p>
</div>
<div class="paragraph">
<p>Nous pouvons à présent étendre ce savoir nouvellement acquis en
<a href="#path">routant un chemin d&#8217;accès</a> vers le répertoire qui contient nos fichiers.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node static/routes.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">static/routes.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'find-my-way'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">staticFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token function">createReadStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/files/:file'</span><span class="token punctuation">,</span> staticFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(1)</b></span>
router<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token string">'/files/:file'</span><span class="token punctuation">,</span> staticFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> router<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création d&#8217;une route paramétrée qui répond avec la fonction&#160;<code>staticFiles</code>.</p>
</li>
<li>
<p>Composition dynamique du chemin d&#8217;accès au fichier.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si nous accédons à <span class="URL"><a href="http://localhost:4000/files/doc.pdf" class="bare">localhost:4000/files/doc.pdf</a></span> et <span class="URL"><a href="http://localhost:4000/files/screenshot.jpg" class="bare">localhost:4000/files/screenshot.jpg</a></span>,
nous verrons les deux documents s&#8217;afficher dans notre navigateur.
Il reste cependant un problème&#160;: l&#8217;accès à un chemin inconnu fait planter l&#8217;application.</p>
</div>
<div class="paragraph">
<p>Nous constatons que notre approche est un peu trop naïve en regardant les en-têtes
de réponse d&#8217;un peu plus&#160;près&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>curl --head 'http://localhost:4000/files/doc.pdf'  <span data-bash-conum="1"></span>
HTTP/1.1 200 OK
Date: Mon, 02 Jul 2018 15:47:33 GMT
Connection: keep-alive</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>C&#8217;est pour exécuter cette commande que j&#8217;ai ajouté l&#8217;écoute de la méthode&#160;<code>HEAD</code>.

En fait, nous gagnerions à documenter la ressource en transmettant
des en-têtes supplémentaires.
La question est&#160;: lesquels&#160;?</p>
</li>
</ol>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">⚠️</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Sécurité</span> Filtrer les données entrantes</div>
<div class="paragraph">
<p>
<strong>Toute information saisie par l&#8217;utilisateur</strong> doit être filtrée et nettoyée avant
d&#8217;être utilisée.
L&#8217;exemple <code>static/routes.js</code> n&#8217;est pas sécurisé&#160;; vous vous rendrez
compte en visitant <span class="URL"><a href="http://localhost:4000/files/..%2F..%2Fhello.js" class="bare">localhost:4000/files/..%2F..%2Fhello.js</a></span> que ce chemin
permet de remonter jusqu&#8217;à un fichier situé hors du répertoire <code>static/files</code>.<br>
Ce type de faille s&#8217;exploite pour accéder aux données confidentielles de notre
système d&#8217;exploitation.</p>
</div>
<div class="paragraph">
<p>Nous verrons tous ces aspects plus en détail dans la section
&#8220;<a href="#security">Protéger l&#8217;application</a>&#8221;.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons nous baser sur le module&#160;<code>npm</code> <em>send</em> (<span class="URL"><a href="https://npmjs.com/send" class="bare">npmjs.com/send</a></span>)
pour améliorer l&#8217;exemple précédent et constater par nous-même quels
en-têtes sont utiles.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node static/send.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">static/send.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> send <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'send'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'find-my-way'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">staticFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pathname <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">,</span> pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">send</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/files/*'</span><span class="token punctuation">,</span> staticFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span>
router<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token string">'/files/*'</span><span class="token punctuation">,</span> staticFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> router<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>En utilisant la syntaxe&#160;<code>*</code>, le routeur accepte une arborescence de chemins&#160;– <code>doc.pdf</code> tout comme <code>un/long/chemin.pdf</code>.</p>
</li>
<li>
<p>L&#8217;arborescence se récupère avec un paramètre du même&#160;nom&#160;–&#160;<code>*</code>.</p>
</li>
<li>
<p>Le module <em>send</em> prend en charge la suite de la transmission.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous n&#8217;avons pas apporté de grands bouleversements, si ce n&#8217;est que les
fichiers inexistants ne font plus planter l&#8217;application
et que les en-têtes de réponses sont plus fournis qu&#8217;avant&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>curl --head 'http://localhost:4000/files/doc.pdf'
HTTP/1.1 200 OK
Accept-Ranges: bytes
Cache-Control: public, max-age=0
Last-Modified: Tue, 12 Jun 2018 08:02:40 GMT
ETag: W/"10c5d-163f304b0d2"
Content-Type: application/pdf
Content-Length: 68701
Date: Mon, 02 Jul 2018 15:52:18 GMT
Connection: keep-alive</pre>
</div>
</div>
<div class="paragraph">
<p>Parmi les en-têtes les plus importants, nous trouvons <code>Content-Type</code>,
<code>Content-Length</code> et <code>Last-Modified</code>.



Ils aident le client à interpréter ou représenter le contenu de manière optimale,
à informer de la taille du contenu (utile à l&#8217;animation de la barre de
téléchargement du navigateur web) et à distinguer l&#8217;ancienneté du fichier.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 4. En-têtes de réponse utiles pour transmettre des fichiers</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">En-tête</th>
<th class="tableblock halign-left valign-top">Utilité</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-Type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicite la nature du contenu mis à disposition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-Disposition</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indique si le contenu doit être affiché dans le client ou téléchargé sous un nom particulier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cache-Control</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active ou désactive la mise en cache de ce fichier par le client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Last-Modified</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indique la date de dernière modification du contenu.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-Length</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indique la longueur (en octets) du contenu.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-Encoding</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indique le mode de compression utilisé pour transmettre les données.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Accept-Ranges</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indique la possibilité ou non de reprendre un téléchargement ou d&#8217;en choisir un segment avec l&#8217;en-tête de requête <code>Range</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>

</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performance</span> Utiliser Apache ou nginx en production</div>
<div class="paragraph">
<p>


Si Node s&#8217;en sort bien pour envoyer des fichiers vers le client,
les serveurs web Apache et nginx sont encore plus performants à ce niveau.
C&#8217;est quelque chose à considérer si votre application sert principalement
des fichiers statiques.</p>
</div>
<div class="paragraph">
<p>Lisez le <a href="../chapter-06/index.html">chapitre&#160;6</a> pour apprendre à
configurer Node derrière un autre serveur&#160;web.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="arguments">1.4. Réagir aux arguments&#160;d&#8217;URL</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Les arguments d&#8217;une URL servent à <strong>affiner le contexte d&#8217;affichage</strong> d&#8217;une
ressource donnée.
Ces options servent par exemple à paginer du contenu ou spécifier une dimension,
un filtre d&#8217;affichage ou encore une expression de recherche.
En clair, elles servent à influencer la représentation d&#8217;une ressource
ou information.</p>
</div>
<div class="paragraph">
<p>Par défaut, les arguments sont représentés de manière textuelle avec
le chemin d&#8217;accès, dans l&#8217;attribut <code>request.url</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node arguments/intro.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">arguments/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La page demandée affiche l&#8217;attribut de requête <code>url</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous voyons s&#8217;afficher <code>/test?cle=valeur&amp;option</code> en nous rendant à l&#8217;adresse
<span class="URL"><a href="http://localhost:4000/test?cle=valeur&amp;option" class="bare">localhost:4000/test?cle=valeur&amp;option</a></span>.
Ce n&#8217;est pas utilisable en l&#8217;état.</p>
</div>
<div class="paragraph">
<p>Le <a href="../chapter-04/index.html#url">module <code>url</code></a>
(<a href="../chapter-04/index.html">chapitre&#160;4</a>) entre en jeu.
En plus de déstructurer une URL entière, il sait aussi décomposer les options
et les transformer en un objet utilisable côté&#160;Node&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node arguments/parse.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">arguments/parse.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>parse<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>search<span class="token punctuation">,</span> query<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>search<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(2)</b></span>
  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(3)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le deuxième argument de la fonction <code>url.parse()</code> décompose les arguments, disponibles dans l&#8217;attribut <code>query</code> de l&#8217;objet retourné.</p>
</li>
<li>
<p>L&#8217;attribut <code>search</code> correspond aux arguments, sous forme textuelle.</p>
</li>
<li>
<p>L&#8217;attribut <code>query</code> est un objet&#160;– ici, transformé pour être affiché dans la page sous forme de texte.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette fois, nous voyons s&#8217;afficher <code>{"cle": "valeur", "option": ""}</code> dans notre
navigateur lorsque nous nous rendons sur <span class="URL"><a href="http://localhost:4000/test?cle=valeur&amp;option" class="bare">localhost:4000/test?cle=valeur&amp;option</a></span>.
C&#8217;est tout ce qu&#8217;il nous fallait pour l&#8217;utiliser dans notre application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node arguments/format.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">arguments/format.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>parse<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>format<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'date-fns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>query<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>format <span class="token operator">===</span> <span class="token string">'svg'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(2)</b></span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`&lt;svg viewBox="0 0 200 100">
      &lt;text x="0" y="50"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/text>
    &lt;/svg>`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous rentrons dans ce bloc en présence de l&#8217;argument d&#8217;URL <code>format=svg</code>.</p>
</li>
<li>
<p>L&#8217;en-tête <code>Content-Type</code> fait que le contenu est interprété (et affiché) comme du HTML&#160;– en retirant cette ligne, le document sera alors téléchargé.</p>
</li>
<li>
<p>Sinon, le reste du temps, nous affichons la date telle quelle, en tant que texte.

Les deux URL <span class="URL"><a href="http://localhost:4000/date?format=svg" class="bare">localhost:4000/date?format=svg</a></span> et <span class="URL"><a href="http://localhost:4000/date" class="bare">localhost:4000/date</a></span> font
référence à une même ressource, mais l&#8217;affichage s&#8217;adapte au contexte.</p>
</li>
</ol>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 5. Exemples d&#8217;arguments et leurs représentations en structure ECMAScript</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Argument</th>
<th class="tableblock halign-left valign-top">Représentation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>?cle=valeur</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{cle: "valeur"}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>?cle</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{cle: ""}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>?cle[]=1&amp;cle[]=2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{cle: [1,2]}</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performance</span> Module npm parseurl</div>
<div class="paragraph">
<p>
Si vous êtes à la recherche de performance, le module&#160;<code>npm</code> <em>parseurl</em>
(<span class="URL"><a href="https://npmjs.com/parseurl" class="bare">npmjs.com/parseurl</a></span>) retourne les mêmes résultats
tout en étant jusqu&#8217;à 10&#160;fois plus rapide que le module natif de&#160;Node.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="post">1.5. Recevoir des données de formulaire&#160;(POST)</h3>
<div class="paragraph">
<p>


</p>
</div>
<div class="paragraph">
<p>Lorsque nous ne précisons pas la méthode employée, les outils et logiciels
utilisent par défaut la méthode&#160;<code>GET</code>.
Elle est associée à une récupération de données sans transmettre autre chose
que des en-têtes et un chemin d&#8217;accès.</p>
</div>
<div class="paragraph">
<p>Il y a des cas où nous avons besoin d&#8217;envoyer des données, pour les stocker
ou pour demander à créer un enregistrement.
Dans ce cas, nous utilisons la méthode <code>POST</code> et nous transmettons les informations
d&#8217;une manière différente.</p>
</div>
<div class="paragraph">
<p>Le serveur suivant affichera deux choses à chaque requête reçue&#160;: l&#8217;en-tête
<code>Content-Type</code> et le corps du message transmis par la requête.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node post/server.js</pre>
</div>
</div>
<div class="paragraph">
<p>La commande <code>curl</code> règle le nom et la valeur d&#8217;un champ de formulaire
avec l&#8217;option&#160;<code>-d</code>.

Nous pouvons ainsi transmettre des données avec la méthode <code>POST</code> à notre
serveur&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>curl -XPOST -d 'fromage=cabécou' -d 'remember_me=1' \
  http://localhost:4000</pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est vraiment l&#8217;équivalent d&#8217;un classique formulaire&#160;HTML.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/send-data.png" alt="send data">
</div>
<div class="title">Figure 1. Représentation d&#8217;un formulaire HTML qui envoie les mêmes informations que la commande <code>curl</code> précédente</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">post/index.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost:4000<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <b class="conum">(1)</b>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>fromage=
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fromage<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cabécou<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>remember_me=
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>remember_me<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">checked</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Transmettre<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous retrouvons l&#8217;indication de la méthode&#160;<code>POST</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Lorsque la page HTML est ouverte dans un navigateur et qu&#8217;on appuie sur le bouton
<b class="button">Transmettre</b>, les mêmes informations qu&#8217;avec la commande <code>curl</code> s&#8217;affichent.</p>
</div>
<div class="paragraph">
<p>Il se trouve que Node aussi sait envoyer des informations de formulaire
avec le <a href="../chapter-04/index.html#http">module <code>http</code></a>
(<a href="../chapter-04/index.html">chapitre&#160;4</a>).
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node post/send.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">post/send.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>stringify<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> fromage<span class="token punctuation">:</span> <span class="token string">'cabécou'</span><span class="token punctuation">,</span> <span class="token string">'remember_me'</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  hostname<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> <span class="token number">4000</span><span class="token punctuation">,</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>                                      <span class="token comment">// <b class="conum">(2)</b></span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(4)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création de la structure des données à transmettre.</p>
</li>
<li>
<p>Indication de la méthode&#160;<code>POST</code>.</p>
</li>
<li>
<p>Cet en-tête caractérise la manière d&#8217;organiser les données de formulaire&#160;– personnellement, je n&#8217;arrive jamais à retenir cette valeur et je la copie/colle toujours depuis Stack Overflow ou une documentation technique.</p>
</li>
<li>
<p>Les données sont sérialisées sous forme d&#8217;une chaîne de caractères, identique à ce que ferait un navigateur avec les données d&#8217;un formulaire.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous retrouvons l&#8217;en-tête <code>Content-Type</code> dans l&#8217;affichage du script <code>post/server.js</code>.
Le contenu du message envoyé ressemble beaucoup à des arguments d&#8217;URL
encodés avec <a href="#encode-uri">encodeURIComponent()</a>.

</p>
</div>
<div class="listingblock">
<div class="title">Extrait d&#8217;affichage d&#8217;un message reçu par <code>post/server.js</code></div>
<div class="content">
<pre>application/x-www-form-urlencoded
fromage=cab%C3%A9cou&amp;remember_me=1</pre>
</div>
</div>
<div class="paragraph">
<p>Comme dans les sections précédentes, nous devons <em>décoder</em> une chaîne de
caractères pour en extraire sa signification et en faire quelque chose
en ECMAScript.</p>
</div>
<div class="paragraph">
<p>Nous pourrions utiliser la fonction <code>parse()</code> du module Node <code>querystring</code>
pour décoder le contenu de cette chaîne, mais nous allons plutôt faire appel
au module&#160;<code>npm</code> <em>co-body</em> (<span class="URL"><a href="https://npmjs.com/co-body" class="bare">npmjs.com/co-body</a></span>).

Ce module décode plusieurs types de requêtes <code>POST</code>, illustrés dans d&#8217;autres
exemples de cette même section.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node post/server-parse.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">post/server-parse.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> parse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co-body'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">onRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>                                    <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">body</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">createServer</span><span class="token punctuation">(</span>onRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le module <em>co-body</em> transforme une requête HTTP en un objet utilisable dans&#160;Node.</p>
</li>
<li>
<p>Le contenu de la variable ressemblera à quelque chose comme <code>{fromage: 'cabécou', remember_me: '1'}</code>.</p>
</li>
<li>
<p>Une erreur s&#8217;affichera en cas de problème pour décoder le corps de la requête entrante.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il nous suffit d&#8217;exécuter à nouveau le script <code>post/send.js</code> pour observer
la différence et constater que nous pouvons désormais interpréter les données
d&#8217;un formulaire.</p>
</div>
<div class="paragraph">
<p>Le fichier <code>post/send.js</code> se simplifie si on utilise le module&#160;<code>npm</code> <em>superagent</em>
(<span class="URL"><a href="https://npmjs.com/superagent" class="bare">npmjs.com/superagent</a></span>).

Je le trouve simple d&#8217;utilisation et il fonctionne avec des promesses,
des formulaires et les <a href="#upload">téléversements de fichiers</a>.

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node post/send-data.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">post/send-data.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>post<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'superagent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:4000'</span><span class="token punctuation">)</span>                 <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'fromage=cabécou'</span><span class="token punctuation">)</span>                    <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'remember_me=1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>URL de la ressource vers laquelle poster les informations.</p>
</li>
<li>
<p>La définition d&#8217;un champ de formulaire s&#8217;effectue à l&#8217;aide de la méthode <code>send()</code> et d&#8217;une valeur ayant la forme d&#8217;une chaîne de caractères.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>À ce stade-là, nous avons fait le nécessaire pour interpréter le contenu d&#8217;un
formulaire sans pièce&#160;jointe.
Notre serveur est même prêt à recevoir des données transmises en dehors d&#8217;un
formulaire, au format&#160;JSON&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node post/send-json.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">post/send-json.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>post<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'superagent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:4000'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                         <span class="token comment">// <b class="conum">(1)</b></span>
    fromage<span class="token punctuation">:</span> <span class="token string">'cabécou'</span><span class="token punctuation">,</span>
    remember_me<span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>L&#8217;utilisation d&#8217;un objet ECMAScript suffit au module <em>superagent</em> pour transmettre les données au format&#160;JSON.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous constatons que la valeur de l&#8217;en-tête <code>Content-Type</code> change pour devenir
<code>application/json</code>.

Là aussi, le module <em>co-body</em> nous est utile, car il s&#8217;adapte au type des données
entrantes et les décode de manière transparente.</p>
</div>
<div class="paragraph">
<p>Il existe un dernier type d&#8217;encodage de données que nous pouvons nous
attendre à recevoir.
Ce sont les formulaires dits <em>multipart</em>.

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node post/send-multipart.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">post/send-multipart.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>post<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'superagent'</span><span class="token punctuation">)</span>

<span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:4000'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">'fromage'</span><span class="token punctuation">,</span> <span class="token string">'cabécou'</span><span class="token punctuation">)</span>                <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">'remember_me'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le module <em>superagent</em> utilise la méthode <code>field()</code> pour définir la valeur d&#8217;un champ <em>multipart</em>.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le serveur va pourtant afficher une erreur du type&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Unsupported content-type: multipart/form-data;
  boundary=--------------------------070345340228095473881249</pre>
</div>
</div>
<div class="paragraph">
<p>Ce type d&#8217;encodage de données est plus complexe à gérer.
Il va nous falloir passer à une autre stratégie, incontournable
pour gérer le <a href="#upload">téléversement de fichiers</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="upload">1.6. Téléverser des fichiers</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Le téléversement de fichier implique un peu plus de travail qu&#8217;un <a href="#post">simple formulaire</a>
car la structure des données envoyées diffère mais aussi, surtout,
parce que la réception et la gestion des fichiers demandent encore plus
d&#8217;attention.</p>
</div>
<div class="paragraph">
<p>Voyons par nous-même à quoi ressemble une requête qui contient une pièce&#160;jointe.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node upload/server.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">upload/server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'get-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">onRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">getStream</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">body</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">createServer</span><span class="token punctuation">(</span>onRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce serveur affiche le contenu d&#8217;une requête entrante.
La requête suivante illustre le téléversement d&#8217;un fichier avec le programme <code>curl</code>.

Notez que, cette fois-ci, nous utilisons l&#8217;option&#160;<code>-F</code> et que la valeur
est préfixée avec le caractère&#160;<code>@</code>, suivi du chemin d&#8217;accès au fichier en question.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>curl -XPOST -F 'hello=<mark>@upload/hello.txt</mark>' \
    http://localhost:4000</pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande est équivalente à l&#8217;envoi du formulaire HTML suivant&#160;:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/send-file.png" alt="send file">
</div>
<div class="title">Figure 2. Représentation d&#8217;un formulaire HTML qui téléverse un fichier</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">upload/index.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost:4000<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span>
  <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <b class="conum">(1)</b>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>hello=
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hello<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <b class="conum">(2)</b>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Transmettre<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous retrouvons l&#8217;encodage <code>multipart/form-data</code> dans l&#8217;attribut <code>enctype</code>.</p>
</li>
<li>
<p>Un fichier se téléverse avec un champ de type <code>file</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La structure du corps de message d&#8217;une requête <code>multipart/form-data</code> envoyée
avec la commande <code>curl</code> ou un formulaire HTML ressemble ce qui suit&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>multipart/form-data; boundary=-----1acfa07ebbd71d3c  <span data-bash-conum="1"></span>

-----1acfa07ebbd71d3c                                <span data-bash-conum="2"></span>
Content-Disposition: form-data; name="hello";
  filename="hello.txt"                               <span data-bash-conum="3"></span>
Content-Type: text/plain                             <span data-bash-conum="4"></span>

Hello World

-----1acfa07ebbd71d3c----                            <span data-bash-conum="5"></span></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Contenu de l&#8217;en-tête <code>Content-Type</code>&#160;– l&#8217;attribut <code>boundary</code> précise le motif de délimitation des différents champs.</p>
</li>
<li>
<p>Ouverture des informations du premier champ.</p>
</li>
<li>
<p>Les attributs <code>name</code> et <code>filename</code> définissent respectivement le nom du champ de formulaire et celui du fichier en question.</p>
</li>
<li>
<p>L&#8217;attribut <code>Content-Type</code> concerne le fichier et aide à comprendre comment interpréter son contenu&#160;– ici, du texte brut.</p>
</li>
<li>
<p>Fermeture des informations du premier champ.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Courriels et pièces&#160;jointes</div>
<div class="paragraph">
<p>
Les courriels utilisent aussi l&#8217;encodage <code>multipart/form-data</code> pour joindre
des fichiers à un message.
Si vous savez encoder ou décoder des fichiers pour le&#160;Web, vous savez scripter
l&#8217;ajout de pièces&#160;jointes pour les courriels.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il nous faudrait écrire davantage que 20&#160;lignes de code si nous devions
nous-même interpréter un contenu de requête qui contient des pièces&#160;jointes.
C&#8217;est suffisamment compliqué à programmer de manière robuste pour que le module
<em>co-body</em> vu dans la <a href="#post">section précédente</a> ne s&#8217;en charge pas et recommande
le module <em>formidable</em> (<span class="URL"><a href="https://npmjs.com/formidable" class="bare">npmjs.com/formidable</a></span>).

C&#8217;est exactement ce que nous allons faire pour outiller un nouveau serveur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node upload/server-parse.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">upload/server-parse.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> formidable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'formidable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">onRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">formidable<span class="token punctuation">.</span>IncomingForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">const</span> testFile <span class="token operator">=</span> files<span class="token punctuation">.</span>hello<span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(2)</b></span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testFile<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(3)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testFile<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(4)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testFile<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(5)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testFile<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(6)</b></span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">createServer</span><span class="token punctuation">(</span>onRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le module <em>formidable</em> différencie les données et les fichiers.</p>
</li>
<li>
<p>Nous accédons aux informations d&#8217;un fichier au travers d&#8217;une clé, identique à celle de son champ <code>name</code> dans le formulaire.</p>
</li>
<li>
<p>Affiche <code>text/plain</code>&#160;– la valeur du <code>Content-Type</code> du fichier.</p>
</li>
<li>
<p>Affiche <code>hello.txt</code>&#160;– c&#8217;est le nom du fichier tel qu&#8217;il était nommé sur le poste client.</p>
</li>
<li>
<p>Affiche&#160;<code>12</code>&#160;– c&#8217;est le poids total du fichier.</p>
</li>
<li>
<p>Affiche un chemin d&#8217;accès vers l&#8217;emplacement de stockage temporaire du fichier téléversé.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous sommes en mesure de recevoir des pièces&#160;jointes depuis un formulaire.
Le <a href="../chapter-04/index.html#fs">module&#160;<code>fs</code></a> (<a href="../chapter-04/index.html">chapitre&#160;4</a>)
propose le nécessaire pour déplacer le fichier ailleurs sur le système ou
pour en lire le contenu et le stocker ailleurs&#160;– sur un service de stockage distant
(Amazon&#160;S3, par exemple).
</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">⚠️</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Sécurité</span> Un fichier texte n&#8217;a de texte que le nom</div>
<div class="paragraph">
<p>
Comme pour toute donnée transmise par un utilisateur ou une utilisatrice,
nous devons rester vigilant·e sur le contenu des fichiers pour
éviter des attaques mal intentionnées.</p>
</div>
<div class="paragraph">
<p>Un fichier texte qui contient du JavaScript pourrait être exécuté comme un
script sur le poste client et ainsi servir à subtiliser des données privées
ou aider quelqu&#8217;un à usurper une identité sur le service.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Je recommande deux approches à appliquer avant même de faire quoi que ce soit
avec une pièce&#160;jointe fraîchement téléversée&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>S&#8217;il s&#8217;agit d&#8217;un <strong>fichier texte</strong>&#160;: filtrer le contenu du fichier en retirant
tout ce qui ressemble à du code arbitraire et filtrer le contenu à l&#8217;affichage
pour retirer tout balisage HTML (voir section &#8220;<a href="#security">Protéger son application</a>&#8221;).</p>
</li>
<li>
<p>S&#8217;il s&#8217;agit d&#8217;un <strong>fichier binaire</strong> (image, vidéo, PDF)&#160;: utiliser un antivirus
en ligne de commande pour scanner le contenu&#160;– <em>ClamAV</em> (<span class="URL"><a href="https://www.clamav.net" class="bare">www.clamav.net</a></span>)
est un excellent antivirus open source.
</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces opérations risquent de prendre du temps&#160;– de quelques secondes à plusieurs
minutes dans le cas de fichiers volumineux.
Au lieu de faire attendre l&#8217;utilisateur devant son écran, je recommande
de faire appel à un <a href="#job-queue">mécanisme de file d&#8217;attente</a> pour traiter
l&#8217;effort indépendamment, en fonction des capacités de calcul disponibles.
</p>
</div>
<div class="paragraph">
<p>Enfin, quand vous avez fini d&#8217;utiliser la pièce&#160;jointe&#160;– ou si vous ne l&#8217;utilisez pas&#160;–
pensez aussi à la <strong>supprimer du répertoire temporaire</strong>.
Le disque dur du serveur pourrait manquer d&#8217;espace si plusieurs fichiers volumineux
étaient déposés en peu de temps.</p>
</div>
</div>
<div class="sect2">
<h3 id="cookies">1.7. Garder un lien avec les cookies</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Un cookie est une information partagée entre un client et un serveur pour
une durée limitée dans le temps.
Le client transmet les cookies au serveur afin que ce dernier contextualise
la demande&#160;– un identifiant utilisateur, des préférences ou autre.
Un cookie créé par le domaine <code>example.com</code> est envoyé seulement lors d&#8217;une
visite à <code>example.com</code>&#160;– sous-domaines inclus.</p>
</div>
<div class="paragraph">
<p>Ce mécanisme est aujourd&#8217;hui tristement célèbre pour son détournement
par les industries de la publicité, du marketing et de la revente de données.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node cookies/set-cookie.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">cookies/set-cookie.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token string">'compteur=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>L&#8217;en-tête de réponse <code>Set-Cookie</code> crée/modifie la valeur d&#8217;un cookie chez le client&#160;– ici, le cookie <code>compteur</code> est créé avec la valeur&#160;<code>1</code>.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous pouvons observer la création du cookie en nous rendant sur <span class="URL"><a href="http://localhost:4000" class="bare">localhost:4000</a></span>
avec un navigateur, puis en ouvrant les outils de développement.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/cookies-browser.png" alt="cookies browser">
</div>
<div class="title">Figure 3. Visualisation des cookies avec les outils de développement du navigateur Firefox</div>
</div>
<div class="paragraph">
<p>Les cookies sont transmis du client au serveur <strong>à chaque requête</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node cookies/read.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">cookies/read.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cookie <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Contenu : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cookie<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Les cookies se lisent en inspectant l&#8217;en-tête de requête <code>Cookie</code>.</p>
</li>
<li>
<p>Affiche <code>Contenu&#160;: compteur=1</code>.
intexterm:[HTTP, en-tête, Cookie]
intexterm:[application web, cookie]</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous avons récupéré la valeur de l&#8217;en-tête contenant le cookie.
Nous devons faire un effort supplémentaire pour transformer cette valeur textuelle
en une structure ECMAScript qui fait sens pour notre application.</p>
</div>
<div class="paragraph">
<p>Nous allons nous aider pour cela du module&#160;<code>npm</code> <em>cookie</em>
(<span class="URL"><a href="https://npmjs.com/cookie" class="bare">npmjs.com/cookie</a></span>).

Il sait interpréter le contenu d&#8217;un en-tête HTTP et il sait également faire
l&#8217;inverse, transformer une structure ECMAScript vers du texte utilisable
dans l&#8217;en-tête de réponse <code>Set-Cookie</code>.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node cookies/parse.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">cookies/parse.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>parse<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cookies <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous passons l&#8217;intégralité de l&#8217;en-tête de requête <code>Cookie</code> à la fonction <code>cookie.parse</code>.</p>
</li>
<li>
<p>Affiche <code>{"compteur":"1"}</code>.

</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La méthode <code>response.setHeader()</code> accepte un tableau pour créer plusieurs
cookies en même temps&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node cookies/set-multiple.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">cookies/set-multiple.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>parse<span class="token punctuation">,</span> serialize<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>compteur<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> compteur2 <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>compteur<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

  response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>                    <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token string">'language=fr; Max-Age: 9000000'</span><span class="token punctuation">,</span>                    <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token string">'is_admin=1; Path=/admin; HttpOnly'</span><span class="token punctuation">,</span>                <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token string">'compteur'</span><span class="token punctuation">,</span> compteur2<span class="token punctuation">,</span> <span class="token punctuation">{</span>httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// <b class="conum">(4)</b></span>
    <span class="token comment">//`compteur=${compteur2}; HttpOnly`                 // <b class="conum">(5)</b></span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous créons plusieurs cookies en passant un tableau de valeurs à la méthode <code>response.setHeader()</code>.</p>
</li>
<li>
<p>Crée un cookie dont la durée est limitée à 9&#160;millions de secondes (~104&#160;jours).</p>
</li>
<li>
<p>Crée un cookie visible pour le chemin d&#8217;accès <code>/path</code> (et les sous-chemins)&#160;– la deuxième directive empêche les scripts clients d&#8217;en lire ou modifier la valeur.</p>
</li>
<li>
<p>L&#8217;utilisation de <code>cookie.serialize()</code> est une autre manière de créer des cookies en construisant un objet ECMAScript au lieu d&#8217;une chaîne de caractères.</p>
</li>
<li>
<p>La ligne précédente équivaut à l&#8217;écriture de cette ligne.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cet exemple est aussi l&#8217;occasion de compléter les cookies avec
des directives, qui modifient leur durée de vie et leur visibilité.</p>
</div>
<div class="paragraph">
<p>Cela s&#8217;observe en lançant à nouveau le script <code>cookies/parse.js</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node cookies/parse.js</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;accès à <span class="URL"><a href="http://localhost:4000" class="bare">localhost:4000</a></span> affiche quelque chose comme <code>{"compteur":"1","language":"fr"}</code>
tandis que <span class="URL"><a href="http://localhost:4000/admin" class="bare">localhost:4000/admin</a></span> affiche un cookie supplémentaire&#160;–
<code>{"is_admin":"1","compteur":"1","language":"fr"}</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 6. Directives complémentaires à la valeur d&#8217;un cookie</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Directive</th>
<th class="tableblock halign-left valign-top">Explication</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Max-Age</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Durée de vie du cookie en secondes.<br>
Si le nombre est inférieur ou égal à zéro, le cookie est supprimé.<br>
Si cette valeur n&#8217;est pas précisée, le cookie est supprimé à la fin de la session.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Domain</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Spécifie le domaine ou les sous-domaines applicables au cookie.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Path</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Contraint le cookie à ce répertoire et tous ses sous-répertoires.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Secure</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Le cookie est envoyé seulement si le document est demandé via&#160;HTTPS.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HttpOnly</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Le cookie ne peut pas être lu ou modifié côté client, via la variable <code>document.cookie</code>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Nous savons maintenant garder le lien avec nos utilisateurs.
Nous utiliserons d&#8217;ailleurs les cookies pour <a href="#sessions">maintenir une session</a>
avec un framework&#160;web.
</p>
</div>
</div>
<div class="sect2">
<h3 id="templating">1.8. Structurer l&#8217;affichage avec les gabarits de présentation</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Les gabarits de présentation (ou <em>templates</em>) répondent à deux problèmes&#160;:
séparer le code applicatif (le fond) de la présentation (la forme) et aussi
structurer la complexité visuelle avec des composants réutilisables.</p>
</div>
<div class="paragraph">
<p>Nous allons nous pencher sur le module <em>nunjucks</em> (<span class="URL"><a href="https://npmjs.com/nunjucks" class="bare">npmjs.com/nunjucks</a></span>).

Je l&#8217;apprécie pour son élégance et pour son caractère extensible.
Il existe d'<a href="#templating-engines">autres modules de présentation</a> bien sûr
et je vous invite à choisir celui qui vous parle le plus,
quitte à en changer par la suite.</p>
</div>
<div class="paragraph">
<p>J&#8217;attends plusieurs choses d&#8217;un système de gabarits&#160;: itérer facilement
sur des collections (tableaux, objets), appliquer des filtres, inclure des
portions de présentation et imbriquer ma page dans un modèle de présentation
– une sorte de décoration qui contient des choses que je veux garder hors du gabarit
(comme le menu principal ou les balises <code>&lt;meta&gt;</code>).</p>
</div>
<div class="paragraph">
<p>Dans la suite de cette section, nous allons créer une présentation à partir
d&#8217;une liste de modules&#160;<code>npm</code> contenue dans un fichier&#160;JSON.
L&#8217;image suivante illustre très bien ce que nous cherchons à atteindre.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/template.png" alt="template" width="70%">
</div>
<div class="title">Figure 4. Exemple de présentation qui met en scène des données dynamiques et des composants&#160;HTML</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">templating/server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>createServer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>dependencies<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> njk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nunjucks'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">const</span> <span class="token function-variable function">onRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> njk<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'list.njk'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                 <span class="token comment">// <b class="conum">(2)</b></span>
    title<span class="token punctuation">:</span> <span class="token string">'Liste des dépendances'</span><span class="token punctuation">,</span>
    dependencies
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">createServer</span><span class="token punctuation">(</span>onRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous configurons le module <em>nunjucks</em> pour qu&#8217;il cherche les gabarits dans le même répertoire que le script de l&#8217;application.</p>
</li>
<li>
<p>La méthode <code>render()</code> prend le contenu du fichier <code>list.njk</code> ainsi que les variables passées en argument pour compiler du&#160;HTML.</p>
</li>
<li>
<p>Ce HTML est envoyé en réponse pour être interprété par un navigateur&#160;web.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dans cet exemple, nous répondons la même chose, peu importe le chemin demandé
au serveur.
Nous pourrions tout à fait ajouter un <a href="#path">routeur</a> afin de répondre avec
un gabarit différent pour chacune des routes.
Nous verrons aussi dans la section &#8220;<a href="#express">Organiser une application</a>&#8221;
qu&#8217;un des buts des <em>frameworks</em> est d&#8217;apporter ce genre de cohérence.</p>
</div>
<div class="paragraph">
<p>Côté serveur, nous prenons une structure qui ne change pas (le gabarit)
et nous la combinons avec une structure qui change (les données) pour générer
un rendu HTML adapté au client à l&#8217;origine de la requête.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">templating/list.njk</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">{% extends "layout.njk" %}                      <b class="conum">(1)</b>

{% block content %}                             <b class="conum">(2)</b>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
  Il y a {{ dependencies | length }} modules    <b class="conum">(3)</b>
  dans le fichier <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">></span></span>package.json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">></span></span>.
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
  {% for pkg,version in dependencies %}         <b class="conum">(4)</b>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">></span></span>{{ pkg }}@{{ version }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span> <b class="conum">(5)</b>
  {% endfor %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
{% endblock %}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous indiquons à <em>nunjuck</em> d&#8217;envelopper ce gabarit avec la structure décrite dans <code>layout.njk</code>.</p>
</li>
<li>
<p>Début de la déclaration d&#8217;un bloc nommé <code>content</code>.</p>
</li>
<li>
<p>L&#8217;objet <code>dependencies</code> (qui est passé en paramètre au gabarit) est affiché après avoir été filtré avec la fonction native <em>nunjucks</em> <code>length</code>.</p>
</li>
<li>
<p>La boucle&#160;<code>for</code> répète le bloc de gabarit pour chaque élément de la collection&#160;– à la manière des méthodes <code>map()</code> et <code>forEach</code> des <a href="../chapter-03/index.html#array">tableaux ECMAScript</a>.</p>
</li>
<li>
<p>Les valeurs de&#160;<code>pkg</code> et de <code>version</code> changent à chaque itération.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le gabarit se concentre sur la <strong>transformation de données</strong>.
Il faut au préalable avoir réuni et structuré les données nécessaires à l&#8217;affichage.
Nous avons la possibilité de fragmenter notre code de sorte que chaque
gabarit contienne uniquement ce qui dépend de sa responsabilité.</p>
</div>
<div class="paragraph">
<p>Nous retrouvons ces principes de fonctionnement dans d&#8217;autres langages, à quelques
variations&#160;près.</p>
</div>
<div class="hdlist">
<div class="title">Fonctionnement des expressions nunjucks</div>
<table>
<tr>
<td class="hdlist1">
<code>{%&#160;&#8230;&#8203;&#160;%}</code>
</td>
<td class="hdlist2">
<p>Expression <em>nunjucks</em> qui marque le début ou la fin d&#8217;un bloc.
Ce dernier contient une expression dont le contenu est affiché, inclus ou répété
selon certaines conditions.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>{{&#160;variable&#160;}}</code>
</td>
<td class="hdlist2">
<p>Affichage de la valeur d&#8217;une variable sous forme d&#8217;une chaîne de caractères.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>{{&#160;variable&#160;|&#160;filtre&#160;}}</code>
</td>
<td class="hdlist2">
<p>Affichage de la valeur d&#8217;une variable après application d&#8217;un filtre de transformation.
Ce dernier n&#8217;est autre qu&#8217;une fonction ECMAScript intégrée au mécanisme de <em>nunjucks</em>.
Nous pouvons accumuler les filtres pour transformer la valeur jusqu&#8217;à obtenir
le résultat attendu.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Intéressons-nous maintenant au gabarit parent, <code>layout.njk</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">templating/layout.njk</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fr<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>        <b class="conum">(1)</b>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>

    {% block content %}{% endblock %} <b class="conum">(2)</b>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La variable <code>title</code> est un argument passé au gabarit dans <code>templating/server.js</code>.</p>
</li>
<li>
<p>Le bloc <code>content</code> défini dans le fichier <code>list.njk</code> est injecté à cet endroit du gabarit.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce gabarit sert de &#8220;décoration&#8221;, en englobant puis injectant son contenu de
manière précise et contrôlée.
Nous sommes en mesure de hiérarchiser l&#8217;organisation de la présentation et de
choisir comment imbriquer les gabarits entre eux.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Gabarit et API</div>
<div class="paragraph">
<p>La documentation complète des fonctions de gabarit se trouve sur
<span class="URL"><a href="https://mozilla.github.io/nunjucks/templating.html" class="bare">mozilla.github.io/nunjucks/templating.html</a></span>.
La section <span class="Menu">API</span> vous aidera à ajuster son intégration à
votre application&#160;Node.</p>
</div>
</td>
</tr>
</table>
</div>
<table id="templating-engines" class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 7. Sélection de moteurs de gabarits et dans quelle situation les utiliser</caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Module</th>
<th class="tableblock halign-left valign-top">Adresse</th>
<th class="tableblock halign-left valign-top">Pourquoi l&#8217;utiliser ?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ejs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="URL"><a href="https://npmjs.com/ejs" class="bare">npmjs.com/ejs</a></span></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Pour écrire ses gabarits avec ECMAScript.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">handlebars</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="URL"><a href="https://npmjs.com/handlebars" class="bare">npmjs.com/handlebars</a></span></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Performant, éprouvé et large catalogue de filtres prêts à l&#8217;emploi.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nunjucks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="URL"><a href="https://npmjs.com/nunjucks" class="bare">npmjs.com/nunjucks</a></span></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Mécanisme élégant de blocs, de filtres et d&#8217;héritage de gabarit.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="URL"><a href="https://npmjs.com/pug" class="bare">npmjs.com/pug</a></span></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Écriture très concise des balises avec un système d&#8217;indentation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">react</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="URL"><a href="https://npmjs.com/react" class="bare">npmjs.com/react</a></span></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Pour réutiliser les mêmes composants que le <em>front-end</em>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>




</p>
</div>
<div class="paragraph">
<p>Nous détaillons des <a href="../appendix-a/index.html#templating">exemples de rendu de gabarit</a>
en <a href="../appendix-a/index.html">annexe&#160;A</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="dev">1.9. Pendant le développement : relancer le serveur automatiquement</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Vous avez modifié un des exemples de ce chapitre pendant qu&#8217;il était en
cours d&#8217;exécution et vous avez remarqué que résultat ne changeait pas&#160;?</p>
</div>
<div class="paragraph">
<p>C&#8217;est normal&#160;: la version du code utilisée par Node est celle qui a été évaluée
au lancement du script.
Les <strong>changements sont pris en compte manuellement, à la prochaine exécution</strong>,
c&#8217;est-à-dire après avoir stoppé et lancé à nouveau le script.</p>
</div>
<div class="paragraph">
<p>Le module&#160;<code>npm</code> exécutable <em>nodemon</em> (<span class="URL"><a href="https://npmjs.com/nodemon" class="bare">npmjs.com/nodemon</a></span>)
relance automatiquement une commande dès qu&#8217;il détecte un changement
dans le répertoire courant.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>nodemon cookies/parse.js
<span data-bash-subs="#"></span>au lieu de "node cookies/parse.js"</pre>
</div>
</div>
<div class="paragraph">
<p>La commande précédente relance <code>cookies/parse.js</code> si ce fichier change,
si un fichier dans le répertoire <code>cookies/</code> évolue, mais aussi si un fichier
dans les répertoires voisins au répertoire <code>cookies/</code> est modifié.</p>
</div>
<div class="paragraph">
<p>L&#8217;option <code>--watch</code> restreint ou élargit le champ d&#8217;observation.
La commande suivante relance le serveur seulement si un fichier JavaScript
est modifié dans le répertoire <code>cookies/</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>nodemon --watch cookies cookies/parse.js</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;option <code>--ext</code> filtre les fichiers observés en fonction de leur type.
La commande suivante relance le serveur si un fichier JavaScript, CSS ou HTML
est modifié dans le répertoire courant&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>nodemon --ext js,css,html cookies/parse.js</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Question</span> Installation globale ou installation locale ?</div>
<div class="paragraph">
<p>

Vous n&#8217;êtes pas sûr·e de la meilleure manière d&#8217;installer et d&#8217;utiliser
le module <em>nodemon</em>&#160;?
Je vous invite à relire la section
&#8220;<a href="../chapter-05/index.html#install.global">Exécutable système</a>&#8221;
du <a href="../chapter-05/index.html">chapitre&#160;5</a> consacré à&#160;<code>npm</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="express">2. Organiser une application avec le framework Express</h2>
<div class="sectionbody">
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>La section précédente a détaillé un ensemble de fonctionnalités individuelles
qui permettent à la fois de mieux comprendre comment fonctionne HTTP, mais aussi
comment constituer des briques d&#8217;une application web avec&#160;Node.</p>
</div>
<div class="paragraph">
<p>Les <em>frameworks applicatifs web</em> sont des outils qui proposent de créer une
cohérence dans l&#8217;organisation de ces fonctionnalités, de sorte que nos
efforts se concentrent plus sur l&#8217;écriture du code et moins sur la création du cadre.</p>
</div>
<div class="paragraph">
<p>Dans cette section, je vous propose d&#8217;appliquer ces connaissances au framework
<em>Express</em> (<span class="URL"><a href="https://npmjs.com/express" class="bare">npmjs.com/express</a></span>).
C&#8217;est un outil flexible et bien documenté, un choix de prédilection pour commencer.</p>
</div>
<div class="paragraph">
<p>Vous pouvez vous en tenir à ce framework ou bien évoluer ou compléter son utilisation
avec <em>fastify</em> (plus récent et plus rapide), <em>restify</em> (orienté <a href="#api">API&#160;REST</a>),
<em>koa</em> (asynchrone et plus rapide) ou encore <em>hapi</em> (plus structuré et plus complexe).



</p>
</div>
<div class="paragraph">
<p>J&#8217;ai une préférence pour les outils qui ne font pas trop de choix à notre place,
bien documentés et, si possible, qui travaillent autour du
<a href="../chapter-04/index.html#http">module&#160;<code>http</code></a>&#160;– cela conserve une certaine
clarté autour des concepts que nous manipulons.
</p>
</div>
<div class="sect2">
<h3 id="setup">2.1. Configuration du framework</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>La configuration initiale d'<em>Express</em> définit un serveur&#160;HTTP&#160;– à la manière
de ce que nous faisions avec <code>http.createServer()</code>&#160;– et retourne
un <a href="#paths">routeur</a> pour attacher des comportements à des chemins d&#8217;accès.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/setup.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/setup.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(1)</b></span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>             <span class="token comment">// <b class="conum">(2)</b></span>
  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;a href="/login">connexion&lt;/a>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;p>En travaux&lt;/p>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">// <b class="conum">(4)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création de l&#8217;application Express.</p>
</li>
<li>
<p>Déclaration d&#8217;une <a href="#paths">route</a> pour la page d&#8217;accueil.</p>
</li>
<li>
<p>La méthode <code>response.send()</code> est un raccourci qui combine et configure <code>response.write()</code>, <code>response.statusCode</code> et de <code>response.end()</code>.</p>
</li>
<li>
<p>Branchement du serveur HTTP sur l&#8217;interface réseau du système d&#8217;exploitation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>C&#8217;est vraiment très proche de ce que nous avons déjà appris
à faire dans les sections &#8220;<a href="#server">Démarrer un serveur HTTP</a>&#8221; et
&#8220;<a href="#paths">Répondre à un chemin</a>&#8221;.


</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Quelles méthodes et pour quoi faire ?</div>
<div class="paragraph">
<p>

La documentation d&#8217;Express est le meilleur endroit pour savoir quoi faire
avec les différents objets du module.
Sa lecture vous aidera à mieux suivre cette section car vous comprendrez
d&#8217;où sortent les méthodes utilisées.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Express</strong>&#160;: <span class="URL"><a href="https://expressjs.com/fr/4x/api.html#express" class="bare">expressjs.com/fr/4x/api.html#express</a></span></p>
</li>
<li>
<p><strong>Application</strong>&#160;: <span class="URL"><a href="https://expressjs.com/fr/4x/api.html#app" class="bare">expressjs.com/fr/4x/api.html#app</a></span></p>
</li>
<li>
<p><strong>Requête</strong>&#160;: <span class="URL"><a href="https://expressjs.com/fr/4x/api.html#req" class="bare">expressjs.com/fr/4x/api.html#req</a></span></p>
</li>
<li>
<p><strong>Réponse</strong>&#160;: <span class="URL"><a href="https://expressjs.com/fr/4x/api.html#res" class="bare">expressjs.com/fr/4x/api.html#res</a></span></p>
</li>
<li>
<p><strong>Routeur</strong>&#160;: <span class="URL"><a href="https://expressjs.com/fr/4x/api.html#routeur" class="bare">expressjs.com/fr/4x/api.html#routeur</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="middleware">2.2. Greffer des extensions (middlewares)</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Un des premiers éléments différenciant est le <strong>branchement d&#8217;extensions</strong>.
Une fois configurées, ces extensions s&#8217;appliquent à chaque requête entrante.
Elles ajoutent des capacités de compréhension de la requête
(<a href="#post">parser des données de formulaire</a> par exemple), de modifier la réponse
ou de <a href="#views">connecter des gabarits de présentation</a>.

</p>
</div>
<div class="paragraph">
<p>Chaque couche de transformation est appelée un middleware&#160;– une fonction
intermédiaire entre la requête et la réponse.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/middleware.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/middleware.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>random<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pokemon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>            <span class="token comment">// <b class="conum">(1)</b></span>
  response<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>pokemon <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>pokemon<span class="token punctuation">}</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>locals<span class="token punctuation">;</span>              <span class="token comment">// <b class="conum">(4)</b></span>
  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Pokémon aléatoire : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pokemon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(5)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Un middleware se branche avec la méthode <code>app.use()</code>.</p>
</li>
<li>
<p>L&#8217;objet <code>response.locals</code> passe des données jusqu&#8217;à la route&#160;– qui sont effacées une fois la réponse envoyée.</p>
</li>
<li>
<p>La fonction <code>next()</code> passe la main au prochain middleware.</p>
</li>
<li>
<p>Nous récupérons l&#8217;objet <code>response.locals.pokemon</code> créé par notre middleware.</p>
</li>
<li>
<p>Affichage d&#8217;un message similaire à <code>Pokémon aléatoire&#160;: Patrat</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Un middleware n&#8217;est pas très différent d&#8217;une route&#160;: c&#8217;est une fonction
qui a accès à la requête et à la réponse HTTP.
Elle n&#8217;est pas forcément affectée à une méthode HTTP (<code>app.get()</code>, <code>app.post()</code>)
ni à un chemin d&#8217;accès.</p>
</div>
<div class="paragraph">
<p>Dans l&#8217;exemple suivant, nous allons connecter plusieurs middlewares grâce
aux modules&#160;<code>npm</code> <em>helmet</em> (<span class="URL"><a href="https://npmjs.com/helmet" class="bare">npmjs.com/helmet</a></span>) et <em>serve-static</em>
(<span class="URL"><a href="https://npmjs.com/serve-static" class="bare">npmjs.com/serve-static</a></span>).




Ce dernier est une version embarquée de <a href="#static">serve</a> par le module <em>Express</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/middleware-multi.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/middleware-multi.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> helmet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'helmet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filepath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'static'</span><span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/files'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">helmet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">// <b class="conum">(2)</b></span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;img src="/files/screenshot.jpg">'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous branchons le middleware utilisé dans la section <a href="#static">répondre avec des fichiers statiques</a> sur l&#8217;URL <code>{serveUrl}/files</code>.</p>
</li>
<li>
<p>Nous branchons les middlewares de <a href="#security">sécurité</a> à notre application.</p>
</li>
<li>
<p>La racine de l&#8217;application affiche une image contenue dans un autre répertoire.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le mécanisme de middlewares est minimaliste, et pourtant, il nous permet de
brancher des modules dont le seul pré-requis est de comprendre les objets
de requête et de réponse HTTP.
<strong>Les middlewares relient tous les concepts</strong> évoqués dans la section
&#8220;<a href="#webapp">Composer son application&#160;web</a>&#8221;.</p>
</div>
<div class="listingblock">
<div class="title">Extraits des en-têtes d&#8217;une réponse HTTP une fois le module helmet configuré</div>
<div class="content">
<pre><span data-bash-subs="$"></span>curl --head http://localhost:4000
HTTP/1.1 200 OK
X-DNS-Prefetch-Control: off
X-Frame-Options: SAMEORIGIN
Strict-Transport-Security: max-age=15552000; includeSubDomains
X-Download-Options: noopen
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Content-Type: text/html; charset=utf-8
Content-Length: 33
ETag: W/"21-tmPtjMCysQ8MzbRDY67vN+isCos"
Date: Sun, 15 Jul 2018 17:12:48 GMT
Connection: keep-alive</pre>
</div>
</div>
<div class="paragraph">
<p>Le module <em>helmet</em> agit seulement sur les en-têtes de réponse.
Nous verrons dans la section &#8220;<a href="#security">Protéger nos applications</a>&#8221; quels
en-têtes sont essentiels à la sécurité et pourquoi.
</p>
</div>
<div class="paragraph">
<p>Enfin, notons une méthode alternative pour appliquer un middleware&#160;: au niveau
d&#8217;une route, au lieu de toutes les routes&#160;– avec <code>app.use()</code>.
Pour cela, nous allons transformer l&#8217;exemple <code>framework/middleware.js</code> et
l&#8217;appliquer à une seule route&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/middleware-function.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/middleware-function.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>random<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pokemon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">pokéMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>pokemon <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">affichePoké</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>        <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>pokemon<span class="token punctuation">}</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>locals<span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Pokémon aléatoire : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pokemon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> pokéMiddleware<span class="token punctuation">,</span> affichePoké<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(2)</b></span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/rondoudou'</span><span class="token punctuation">,</span> affichePoké<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(3)</b></span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous avons factorisé la route dans une fonction afin de la rendre réutilisable.</p>
</li>
<li>
<p>La route&#160;<code>/</code> reçoit d&#8217;abord le middleware, puis la fonction d&#8217;affichage.</p>
</li>
<li>
<p>La route <code>/rondoudou</code> reçoit uniquement la fonction d&#8217;affichage.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous verrons que, même si la fonction d&#8217;affichage est identique, les routes
<code><a href="http://localhost:4000/" class="bare">localhost:4000/</a></code> et <code><a href="http://localhost:4000/rondoudou" class="bare">localhost:4000/rondoudou</a></code> produisent des résultats différents.
Cette dernière n&#8217;ayant pas reçu le middleware <code>pokéMiddleware</code>, sa variable
<code>response.locals.pokemon</code> n&#8217;a pas été définie et elle vaut donc <code>undefined</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="views">2.3. Brancher les gabarits de présentation</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>La configuration des gabarits de présentation n&#8217;est pas très différente
de ce que nous avons vu dans la section <a href="#templating">qui leur est consacrée</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/templating.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/templating.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> njk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nunjucks'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>
njk<span class="token punctuation">.</span><span class="token function">express</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment">// <b class="conum">(2)</b></span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index.njk'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'Coucou !'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configuration de <em>nunjucks</em>, comme dans la section &#8220;<a href="#templating">structurer l&#8217;affichage avec les gabarits de présentation</a>&#8221;.</p>
</li>
<li>
<p>Utilisation de la méthode <code>express()</code> pour laisser à <em>nunjucks</em> le travail de configuration d&#8217;Express.</p>
</li>
<li>
<p>Nous appelons la méthode <code>response.render()</code> au lieu de <code>response.send()</code>&#160;– elle charge le gabarit donné et lui passe un objet dont chaque clé devient une variable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous avons de la chance car <em>nunjucks</em> prend en charge toute la configuration
d'<em>Express</em> pour nous.

La seule différence avec les précédents exemples est l&#8217;utilisation de la
méthode <code>response.render()</code>.
Le premier effet que cela me fait est une sensation de légèreté&#160;– nous avons
le strict minimum à gérer pour que cela fonctionne.</p>
</div>
<div class="paragraph">
<p>En comparaison, voici comment <em>Express</em> se configure à la main&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/templating-manual.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/templating-manual.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> njk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nunjucks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> __dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(1)</b></span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">'njk'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> options<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> njk<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// <b class="conum">(4)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index.njk'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'Coucou !'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On indique à <em>Express</em> de contextualiser le répertoire racine où se trouvent les gabarits.</p>
</li>
<li>
<p>Déclaration de la fonction de rendu pour les fichiers&#160;<code>.njk</code>&#160;– elle est lancée à chaque fois que <code>response.render()</code> est appelée avec un fichier&#160;<code>.njk</code>.</p>
</li>
<li>
<p>Rendu du fichier passé en paramètre.</p>
</li>
<li>
<p>Le HTML généré est passé à la fonction de rappel <code>next()</code>&#160;– le premier argument est utilisé pour transmettre une erreur, le second le résultat en cas de succès.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette méthode demande davantage de travail.
Elle implique aussi d&#8217;être suffisamment familier·ère avec <em>Express</em> pour en
venir à créer cette fonction de rendu.</p>
</div>
<div class="paragraph">
<p>Au final, nous pourrions utiliser différents moteurs de gabarits si le besoin
se faisait ressentir, pour les exploiter à leur(s) avantage(s).
Leur intégration demande un effort minimum et retire tous les aspects de
présentation de la configuration du routeur.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Un module pour les présenter tous</div>
<div class="paragraph">
<p>
Le module&#160;<code>npm</code> <em>consolidate</em> (<span class="URL"><a href="https://npmjs.com/consolidate" class="bare">npmjs.com/consolidate</a></span>)
gomme les différences de configuration pour plusieurs dizaines de moteurs
de gabarit.</p>
</div>
<div class="paragraph">
<p>Il vous sera utile si vous peinez à configurer <em>Express</em> avec votre
moteur de gabarits favori.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="frontend">2.4. Intégrer les ressources front-end (CSS, images, JavaScript)</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>La gestion des ressources <em>front-end</em> ne demande pas à changer nos habitudes.
Les fichiers CSS, JavaScript et les images sont des fichiers statiques
à mettre à disposition via un <a href="#middleware">middleware</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/assets.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/assets.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> files_dir <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'static'</span><span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/static'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>files_dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;img src="/static/screenshot.jpg">'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(2)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La méthode <code>express.static()</code> configure le module&#160;<code>npm</code> <em>send</em>.</p>
</li>
<li>
<p>Affichage d&#8217;une image dont la source <code>screenshot.jpg</code> est à la racine du répertoire virtuel <code>/static</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>J&#8217;ai tendance à exposer les fichiers statiques depuis un répertoire virtuel dédié
– ici, <code>/static</code>.
Cela rend <strong>plus clairement identifiables</strong> et évite toute ambiguïté avec les
autres routes de l&#8217;application.
Cela a aussi l&#8217;avantage de dissocier les fichiers sources (Sass, Less, etc.)
des fichiers compilés.</p>
</div>
<div class="paragraph">
<p>Dans le <a href="../chapter-05/index.html">chapitre&#160;5</a>, j&#8217;explique comment
<a href="../chapter-05/index.html#run-all">automatiser l&#8217;outillage projet</a>.


Ces connaissances s&#8217;appliquent dans notre cas de figure, sans distinction.<br>
L&#8217;extrait suivant de fichier <code>package.json</code> illustre l&#8217;organisation
des scripts pour démarrer le site en temps normal, pour générer les fichiers
compilés et pour le faire en continu dans un contexte de développement.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">package.json</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json"><span class="token punctuation">{</span>
  <span class="token property">"..."</span><span class="token operator">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"npm-run-all 'build:*'"</span><span class="token punctuation">,</span>
    <span class="token property">"build:css"</span><span class="token operator">:</span> <span class="token string">"node-sass ./assets --output ./assets"</span><span class="token punctuation">,</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node assets.js"</span><span class="token punctuation">,</span>
    <span class="token property">"..."</span><span class="token operator">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"npm-run-all 'watch:*'"</span><span class="token punctuation">,</span>
    <span class="token property">"watch:server"</span><span class="token operator">:</span> <span class="token string">"nodemon assets.js"</span><span class="token punctuation">,</span>
    <span class="token property">"watch:css"</span><span class="token operator">:</span> <span class="token string">"npm run build:css -- --watch --source-map"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La première partie est dédiée aux scripts dits &#8220;de production&#8221;&#160;:
<code>npm run build</code> génère les fichiers utiles quand le serveur tourne,
après avoir lancé <code>npm start</code>.</p>
</div>
<div class="paragraph">
<p>La seconde partie lance le serveur de développement et la construction
des fichiers Sass en continu avec l&#8217;option <code>--watch</code>.
L&#8217;option <code>--source-map</code> s&#8217;utilisent dans un contexte de développement pour
associer les lignes du fichier compilé aux fichiers sources.
Les doubles tirets&#160;(<code>--</code>) nous permettent de réutiliser le script
<code>build:css</code> en lui passant deux options supplémentaires.</p>
</div>
<div class="paragraph">
<p>Le middleware statique s&#8217;utilise aussi avec des fichiers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/assets-file.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/assets-file.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> files_dir <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'static'</span><span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> image_path <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>files_dir<span class="token punctuation">,</span> <span class="token string">'screenshot.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/wikipedia.jpg'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;img src="/wikipedia.jpg">'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// <b class="conum">(2)</b></span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous définissions le fichier statique <code>/wikipedia.jpg</code> alors qu&#8217;il était initialement nommé <code>screenshot.jpg</code>.</p>
</li>
<li>
<p>Ce chemin d&#8217;accès affiche bien l&#8217;image attendue.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette technique est utilisable pour exposer un seul fichier au lieu d&#8217;un répertoire entier.</p>
</div>
<div class="paragraph">
<p>Enfin, le module&#160;<code>npm</code> <em>express-minify</em> (<span class="URL"><a href="https://npmjs.com/express-minify" class="bare">npmjs.com/express-minify</a></span>)
est à considérer pour profiter d&#8217;une mise en place rapide ou
pour prototyper quelque chose en attendant de mettre en place un outillage
plus robuste.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/minify.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/minify.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> minify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-minify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

express<span class="token punctuation">.</span>static<span class="token punctuation">.</span>mime<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'text/x-scss'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'scss'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(1)</b></span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">minify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment">// <b class="conum">(2)</b></span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/static'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'assets'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
    <span class="token string">'&lt;link rel="stylesheet" href="/static/main.scss">'</span>  <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;p>Coucou !&lt;/p>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le module <em>express-minify</em> transforme les fichiers Sass si leur en-tête de réponse <code>Content-Type</code> vaut <code>text/x-scss</code>&#160;– cette ligne affecte cet en-tête aux fichiers dont l&#8217;extension est&#160;<code>.scss</code>.</p>
</li>
<li>
<p>Ajout du module comme <a href="#middleware">middleware</a>.</p>
</li>
<li>
<p>Le fichier <code>main.scss</code> sera converti en&#160;CSS.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si ce module permet de démarrer plus vite, sans avoir à se familiariser
avec les scripts&#160;<code>npm</code> ni même avec la commande <code>node-sass</code>,
je lui vois deux inconvénients majeurs&#160;: les <strong>erreurs sont difficiles à déceler</strong>
et elles risquent de se produire au cas où notre machine de développement est
significativement différente du serveur de production (compilateur,
installation manquée).
Cela représente aussi un <strong>gâchis de ressources</strong> dans la mesure où ces fichiers
ne changent plus une fois mis en ligne&#160;; cela ne justifie pas d&#8217;ajouter
du temps de compilation à la volée.</p>
</div>
<div class="paragraph">
<p>En clair, c&#8217;est pratique pour dépanner et pour démarrer.</p>
</div>
</div>
<div class="sect2">
<h3 id="database">2.5. Brancher une base de données</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;utilisation d&#8217;une base de données sert à mémoriser des informations entre
deux redémarrages de notre application&#160;– sinon, ce qui est en mémoire
applicative disparaît.
Je vous recommande de lire la section &#8220;<a href="#database-choice">Quel(s) moteur(s) de base(s) de données choisir ?</a>&#8221; pour éclairer votre choix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/database.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/database.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sqlite <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sqlite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sqlite<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'db.sqlite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">db</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(1)</b></span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'book/1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/book/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'SELECT * from books WHERE id = ?'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>      <span class="token comment">// <b class="conum">(2)</b></span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">record</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                                 <span class="token comment">// <b class="conum">(3)</b></span>
        record
          <span class="token operator">?</span> response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span>                       <span class="token comment">// <b class="conum">(4)</b></span>
          <span class="token punctuation">:</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Livre inconnu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La connexion à la base de données est asynchrone&#160;– l&#8217;objet&#160;<code>db</code> qui permet d&#8217;exécuter des requêtes est renvoyé par la promesse.</p>
</li>
<li>
<p>Exécution d&#8217;une requête avec un paramètre issu du <a href="#path">routage</a>&#160;– le champ&#160;<code>:id</code>.</p>
</li>
<li>
<p>Le résultat est fourni lors de la résolution de la promesse&#160;– il vaut <code>undefined</code> si aucun enregistrement n&#8217;a été trouvé.</p>
</li>
<li>
<p>Affichage de l&#8217;enregistrement côté client (sans mise en forme aucune).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;intégration d&#8217;une base de données se fait en deux temps&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>D&#8217;abord, on ouvre une connexion asynchrone.
Les connexions HTTP sont acceptées seulement si la connexion à la base réussit.</p>
</li>
<li>
<p>La réponse est renvoyée après avoir fait un aller-retour vers la base
afin d&#8217;en extraire un ou plusieurs résultat(s).</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">⚠️</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Sécurité</span> Systématiser les emplacements de paramètre</div>
<div class="paragraph">
<p>
L&#8217;utilisation des <em>emplacements de paramètre</em> dans les requêtes SQL avec
le caractère&#160;<code>?</code> renforce la sécurité de notre application.</p>
</div>
<div class="paragraph">
<p>La valeur est filtrée pour éviter de déjouer le moteur de base de données en
le faisant planter ou en exposant davantage d&#8217;informations que prévues.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous verrons dans la section &#8220;<a href="#modularity">Vers un code réutilisable et testable</a>&#8221; qu&#8217;un des enjeux est de rendre
le fichier de démarrage le plus fin possible.</p>
</div>
</div>
<div class="sect2">
<h3 id="sessions">2.6. Sessions utilisateurs</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Nous avons appris à mémoriser des données et à les partager avec un serveur
grâce au mécanisme des <a href="#cookies">cookies</a>.
Les sessions utilisateur centralisent cette mémoire du côté du serveur.
Elles se basent sur un <strong>cookie de session</strong> pour garder un lien.</p>
</div>
<div class="paragraph">
<p>Les sessions sont destinées à <strong>stocker des données temporaires</strong>, liées à une
personne.
Un utilisateur peut avoir plusieurs sessions&#160;– une par appareil par exemple.
Chaque session est propre à son environnement immédiat.
Elles sont pratiques pour mémoriser des informations liées à un état
(connecté·e, déconnecté·e, date de dernière activité).</p>
</div>
<div class="paragraph">
<p>Tout stockage qui serait permanent relève des <em>préférences utilisateur</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;extension <em>express-session</em> (<span class="URL"><a href="https://npmjs.com/express-session" class="bare">npmjs.com/express-session</a></span>)
se charge de ce travail pour nous.


Il ajoute un élément <code>request.session</code> qu&#8217;il mémorise et récupère à partir
d&#8217;un identifiant de session difficile à deviner.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/session.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/session.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>random<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pokemon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token punctuation">:</span> <span class="token string">'fromage'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>pokemon <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(2)</b></span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'my-pokemon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/my-pokemon'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>pokemon<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Mon Pokémon en session : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pokemon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configuration du middleware avec un secret qui rend moins prévisible le nom du <a href="#cookies">cookie</a>.</p>
</li>
<li>
<p>Création d&#8217;une donnée de session nommée <code>pokemon</code>, de valeur aléatoire.</p>
</li>
<li>
<p>Affiche un message similaire à <code>Mon Pokémon en session&#160;: Pikachu</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La même valeur s&#8217;affiche si vous ouvrez un nouvel onglet dans le même navigateur
et en vous rendant sur <span class="URL"><a href="http://localhost:4000/my-pokemon" class="bare">localhost:4000/my-pokemon</a></span>.
Le serveur fait le lien entre votre identifiant de session (stocké en cookie)
et les valeurs associées (stockées en mémoire, pour l&#8217;instant) grâce à un identifiant
unique stocké dans le cookie de session.</p>
</div>
<div class="paragraph">
<p>Le middleware de session retrouve les informations associées à cet identifiant
depuis l&#8217;espace de stockage des données de sessions.</p>
</div>
<div class="listingblock">
<div class="title">Extrait des en-têtes de réponse à l&#8217;origine de la création du cookie de session</div>
<div class="content">
<pre><span data-bash-subs="$"></span>curl -i -L http://localhost:4000
HTTP/1.1 302 Found
Location: my-pokemon
Content-Type: text/plain; charset=utf-8
Content-Length: 32
<mark>set-cookie</mark>: connect.sid=s%3AWfP...SRr5Q; Path=/; HttpOnly
Date: Tue, 17 Jul 2018 09:46:15 GMT</pre>
</div>
</div>
<div class="paragraph">
<p>Le seul inconvénient à notre exemple est que, si nous stoppons puis relançons
le serveur, la page <span class="URL"><a href="http://localhost:4000/my-pokemon" class="bare">localhost:4000/my-pokemon</a></span> affiche
<code>undefined</code> comme nom de Pokémon.
C&#8217;est normal&#160;: le stockage par défaut étant en mémoire, les données de session
sont détruites dès que le processus Node s&#8217;interrompt.</p>
</div>
<div class="paragraph">
<p>Fort heureusement pour nous, ces données se stockent avec la
<a href="#database-choice">base de données de notre choix</a>.
Nous allons utiliser le moteur de base de données <em>SQLite</em>
à l&#8217;aide du module <em>connect-sqlite3</em> (<span class="URL"><a href="https://npmjs.com/connect-sqlite3" class="bare">npmjs.com/connect-sqlite3</a></span>)
pour illustrer la persistance des données de session.

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node framework/session-database.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">framework/session-database.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> SQLiteStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect-sqlite3'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>random<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pokemon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token punctuation">:</span> <span class="token string">'fromage'</span><span class="token punctuation">,</span>
  store<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SQLiteStore</span><span class="token punctuation">(</span><span class="token string">'./sessions'</span><span class="token punctuation">)</span>                  <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>pokemon <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(3)</b></span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'my-pokemon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/my-pokemon'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>pokemon<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Mon Pokémon en session : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pokemon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Branchement du module de stockage au gestionnaire de sessions d'<em>Express</em>.</p>
</li>
<li>
<p>Configuration du connecteur de stockage et de l&#8217;emplacement du fichier qui contient les données des sessions.</p>
</li>
<li>
<p>L&#8217;écriture et la lecture des données de session est inchangée.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette fois, si nous stoppons le serveur puis le relançons, le gestionnaire de
sessions affiche le nom de Pokémon associé à notre identifiant.
La persistance a fonctionné&#160;!</p>
</div>
</div>
<div class="sect2">
<h3 id="logs">2.7. Tracer les actions&#160;(logs)</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Consigner les actions (<em>logging</em> en anglais) est une pratique courante
en informatique pour créer une mémoire de l&#8217;activité d&#8217;une application.
Ces consignes aident à garder des traces de choses invisibles en surface,
d&#8217;événements sensibles ou critiques (envoi de mot de passe, création de compte)
afin de détecter des anomalies de fréquence.</p>
</div>
<div class="paragraph">
<p>C&#8217;est un endroit idéal pour répertorier les erreurs avec des indications qui
aideraient à reproduire le problème.
D&#8217;ailleurs, l&#8217;usage est de tenir un journal d&#8217;erreurs séparé du journal des
événements afin de retrouver plus facilement ces premières.
J&#8217;ai tendance à préférer l&#8217;installation d&#8217;une sonde (section
&#8220;<a href="../chapter-06/index.html#exceptions">S&#8217;informer des erreurs applicatives</a>&#8221;
du <a href="../chapter-06/index.html">chapitre&#160;6</a>).</p>
</div>
<div class="paragraph">
<p>C&#8217;est <strong>à nous de choisir la granularité des informations</strong> enregistrées.
Nous sommes responsables de l&#8217;anonymat de ces informations et de ne
rendre personnel que l&#8217;identifiant (numérique ou généré)
pour rattacher des informations à un utilisateur si c&#8217;est nécessaire
– dans le cas de transaction bancaire ou de renvoi de mot de passe par exemple.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">⚠️</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Rotation de&#160;logs</div>
<div class="paragraph">
<p>Consigner des informations est bien jusqu&#8217;au moment où l&#8217;historique finit
par saturer le disque dur de la machine qui héberge l&#8217;application.</p>
</div>
<div class="paragraph">
<p>Sous Linux, le logiciel <em>logrotate</em> (<span class="URL"><a href="https://doc.ubuntu-fr.org/logrotate" class="bare">doc.ubuntu-fr.org/logrotate</a></span>)
est souvent installé par défaut.
Il indique au système quand tronquer le fichier d&#8217;historique&#160;–
tous les X&#160;mégaoctets, tous les X&#160;jours.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les modules&#160;<code>npm</code> pour consigner nos actions fonctionnent comme des
<code>console.log()</code> finement configurables&#160;: <em>winston</em> (<span class="URL"><a href="https://npmjs.com/winston" class="bare">npmjs.com/winston</a></span>),
<em>morgan</em> (<span class="URL"><a href="https://npmjs.com/morgan" class="bare">npmjs.com/morgan</a></span>) et <em>bunyan</em> (<span class="URL"><a href="https://npmjs.com/bunyan" class="bare">npmjs.com/bunyan</a></span>)
sont à essayer, pour voir celui qui vous convient le mieux.



</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/heroku-logs.png" alt="heroku logs">
</div>
<div class="title">Figure 5. Extrait de logs retournés par une application hébergée chez Heroku</div>
</div>
<div class="paragraph">
<p>Les journaux de sortie se connectent à des logiciels comme <em>rsyslog</em>
(<span class="URL"><a href="https://rsyslog.com" class="bare">rsyslog.com</a></span>) ou à des services en ligne comme
<em>Papertrail</em> (<span class="URL"><a href="https://papertrailapp.com" class="bare">papertrailapp.com</a></span>), <em>Logstash</em>
(<span class="URL"><a href="https://elastic.co/products/logstash" class="bare">elastic.co/products/logstash</a></span>) et <em>AWS&#160;CloudWatch</em>
(<span class="URL"><a href="https://aws.amazon.com/cloudwatch" class="bare">aws.amazon.com/cloudwatch</a></span>).
Elles vous aident&#160;– ou vous demandent de travailler davantage&#160;– pour visualiser,
orchestrer et déclencher des actions quand des valeurs spécifiques sont rencontrées
dans les journaux.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modularity">3. Vers un code réutilisable et testable</h2>
<div class="sectionbody">
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;intention de cette section est de consolider les différents concepts
évoqués au cours de ce chapitre.
Nous avons composé pas à pas une application web jusqu&#8217;à l&#8217;organiser avec
le framework <em>Express</em>.
Maintenant, nous allons réorganiser les composants pour améliorer la
maintenance et la robustesse aux changements de nos applications&#160;web.</p>
</div>
<div class="paragraph">
<p>Notre but&#160;?
<strong>Diminuer la taille du script de lancement</strong>, rendre les composants indépendants
et préparer au mieux les données passées à nos gabarits pour faciliter
l&#8217;écriture de tests et favoriser l&#8217;automatisation du déploiement.</p>
</div>
<div class="sect2">
<h3 id="modulariser_le_code_des_routes">3.1. Modulariser le code des routes</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Le défi de lisibilité et de maintenance augmente au fur et à mesure que
le volume de code augmente.
C&#8217;est particulièrement vrai quand le nombre de lignes dépasse un seuil
psychologique dans un même fichier&#160;– je commence à saturer au-delà de 100&#160;lignes,
par exemple.
Ce phénomène se renforce quand plusieurs concepts s&#8217;entrecroisent visuellement.</p>
</div>
<div class="paragraph">
<p>La modularisation des routes et de notre application web va nous rendre la vie
plus confortable.
Nous ouvrons la porte à l&#8217;écriture de <a href="#tests.unit">tests unitaires</a>, à un
déplacement plus aisé du code et à une quasi-disparition des variables globales.
Nous en profitons pour rendre nos intentions explicites, ce à quoi nous obligent
les réflexions de nommage de fichiers et de fonctions.

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node modularity/01/server.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modularity/01/server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dbPromise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/database.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/routes.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span>

dbPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/books/:id'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>books<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(3)</b></span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous déplaçons la configuration de et la connexion à la base de données dans son propre module.</p>
</li>
<li>
<p>Nous déplaçons aussi le code des routes.</p>
</li>
<li>
<p>Au premier coup d&#8217;œil, la route est une association de chemin et d&#8217;une fonction.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous créons des modules qui retournent des fonctions ou des objets.
Nous connectons ensuite ces fonctions aux chemins d&#8217;accès du routeur.</p>
</div>
<div class="paragraph">
<p>Profitons du mécanisme de promesses pour que tout autre module
puisse réagir à l&#8217;aboutissement de la connexion&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modularity/01/src/database.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sqlite <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sqlite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> db_dir <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>
  __dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'framework'</span>              <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> sqlite<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>db_dir<span class="token punctuation">,</span> <span class="token string">'db.sqlite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous réutilisons la base de données d&#8217;un exemple précédent.</p>
</li>
<li>
<p>La fonction <code>sqlite.open()</code> retourne une promesse résolue lorsque la connexion à la base est établie.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notons que nous exploitons le <a href="../chapter-04/index.html#require">mécanisme de cache</a>
des modules Node dans cette dernière ligne.
Chaque appel au fichier <code>database.js</code> retourne la même promesse.
Nous créons ainsi une seule connexion à la base de données même si nous chargeons
plusieurs fois ce module.</p>
</div>
<div class="paragraph">
<p>Je trouve agréable de regrouper ce genre de lignes de code dans un même fichier.
Les dépendances aux modules Node et&#160;<code>npm</code> deviennent vraiment claires.
Je suis moins dérangé par l&#8217;organisation visuelle du code&#160;– elle aurait ralenti
ma lecture du fichier <code>server.js</code> autrement.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modularity/01/src/routes.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>books <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/books.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier de routes a vocation à réexporter les fonctions de routage.
Je trouve que cette organisation sous forme de catalogue fait énormément
gagner en lisibilité lors de l&#8217;intégration avec le routeur.</p>
</div>
<div class="paragraph">
<p>Le dernier morceau est la route elle-même&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modularity/01/src/routes/books.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dbPromise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../database.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  dbPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">db</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                              <span class="token comment">// <b class="conum">(2)</b></span>
    db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'SELECT * from books WHERE id = ?'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">record</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Livre inconnu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Récupération de la promesse de connexion à la base de données&#160;– déjà pré-configurée.</p>
</li>
<li>
<p>De fait, l&#8217;exécution d&#8217;une requête dépend de la résolution de la connexion.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le code de la route est quasi inchangé mais on voit à quel point elle prenait
de la place dans le code d&#8217;origine.
Ce déplacement révèle le positionnement du point d&#8217;attention et quels fichiers
sont amenés à changer au quotidien.
Peu importe l&#8217;organisation du vôtre, ce qui compte c&#8217;est que cette organisation
vous convienne, qu&#8217;elle soit communicable aux personnes qui utilisent ce code
et que nous puissions en suivre le fil logique.</p>
</div>
<div class="paragraph">
<p>Je vois toutefois apparaître une zone d&#8217;ombre&#160;: je ne suis pas satisfait
de la connexion à la base de données.
C&#8217;est la résolution de la promesse dans la route qui me fait dire ça&#160;; elle ne
semble pas à sa place.</p>
</div>
<div class="paragraph">
<p>Faisons une nouvelle itération pour ajuster ce code et tendre vers quelque
chose d&#8217;un peu plus explicite.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node modularity/02/server.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modularity/02/server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>dbPromise<span class="token punctuation">,</span> routes<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./configure'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

dbPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/books/:id'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span><span class="token function">books</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(2)</b></span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous regroupons les éléments de configuration de l&#8217;application.</p>
</li>
<li>
<p>Nous passons les dépendances du module en argument&#160;– ici, l&#8217;objet de base de données.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La grande différence ici est l&#8217;invocation d&#8217;une fonction pour définir la route.
C&#8217;est le moyen le plus propre pour transmettre une variable en enlevant la
dépendance au module <code>database.js</code> dans le script <code>books.js</code>&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modularity/02/src/routes/books.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                          <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                   <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">;</span>

    db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'SELECT * from books WHERE id = ?'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">record</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Livre inconnu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Cette fois, nous exportons une fonction qui accepte un objet de base de données en argument.</p>
</li>
<li>
<p>Le code exécuté par le routeur est la fonction qui est retournée&#160;ici.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;appel à la fonction <code>require()</code> a disparu.
La résolution de la promesse aussi.
Notre module est autonome tant qu&#8217;il reçoit un objet de base de données en
paramètres.
Cela le rend nettement plus lisible&#160;– le code est désormais uniquement lié
à la réception d&#8217;une requête HTTP et à l&#8217;établissement d&#8217;une réponse.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modularity/02/configure.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dbPromise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/database.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/routes.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>dbPromise<span class="token punctuation">,</span> routes<span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous utilisons la syntaxe raccourcie de création d&#8217;objets pour les exporter en une seule&#160;fois.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous retrouvons le même mécanisme que celui rencontré dans le fichier <code>routes.js</code>.</p>
</div>
<div class="paragraph">
<p>Au final, le motif qui émerge est celui de
l'<strong>encapsulation de code dans des fonctions paramétrables</strong>.
Les paramètres sont les seuls points d&#8217;entrée.
Les arguments font office de contrat et les fichiers font office de regroupement
logique&#160;– de fonctions et d&#8217;objets.</p>
</div>
<div class="paragraph">
<p>Nous avons allégé le fichier <code>server.js</code> et rendu lisibles les points importants
de l&#8217;application&#160;: la connexion à la base de données, le rendu d&#8217;une route
et la configuration de l&#8217;application.
Ce travail va nous permettre de tester petit à petit les différents éléments
de l&#8217;application web, par ordre de criticité.</p>
</div>
</div>
<div class="sect2">
<h3 id="tests.unit">3.2. Un code testable est un code indépendant du framework</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;écriture de tests unitaires est influencée par et influence l&#8217;organisation
de notre code en unités réutilisables.
Ils accroissent la qualité, la confiance et la prédictibilité d&#8217;une éventuelle
mise en ligne.</p>
</div>
<div class="paragraph">
<p>Cette section se déroule dans la continuité de la précédente.
Nous allons préparer et mettre en place pas à pas un environnement de test
pour vérifier les intentions de notre&#160;code.</p>
</div>
<div class="paragraph">
<p>Les tests unitaires sont destinés à couvrir les différents cas de figure
des entrées et des sorties de nos fonctions.
Nous testons leurs réactions aux arguments pour vérifier que nous obtenons
le résultat attendu.
Je teste en priorité le code critique, partagé (en tant que bibliothèque) et
qui est au plus proche de l&#8217;interface utilisateur.</p>
</div>
<div class="paragraph">
<p>De quoi a-t-on besoin pour tester <code>routes/books.js</code>&#160;?
La fonction qui est exportée par le module dépend d&#8217;une connexion établie
à une base de données et de deux objets&#160;– la requête entrante et la réponse sortante.
Nous avons aussi besoin d&#8217;écrire des <em>assertions</em> et, dans un premier temps, nous
allons utiliser le module dédié de&#160;Node.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/initial.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strict<span class="token punctuation">;</span>
<span class="token keyword">const</span> configRoute <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/routes/books.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

assert<span class="token punctuation">.</span><span class="token function">deepEqual</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> configRoute<span class="token punctuation">,</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token comment">/*
const db = require('../src/database.js');         // <b class="conum">(2)</b>
const route = configRoute(db);
assert.deepEqual(route(request, response));
*/</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>C&#8217;est notre première assertion&#160;– l&#8217;élément retourné par <code>routes/books.js</code> est une fonction.</p>
</li>
<li>
<p>En commentaire&#160;: comment allons-nous nous connecter à la base de données&#160;?</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node testing/tests/initial.js</pre>
</div>
</div>
<div class="paragraph">
<p>Le script n&#8217;affiche rien de particulier.
C&#8217;est normal, parce que le test s&#8217;est bien passé.
Une assertion lance une erreur si elle constate un résultat différent de l&#8217;attente.</p>
</div>
<div class="paragraph">
<p>Nous avons toutefois testé une évidence, que le module retourne une fonction.
Ce qui serait plus révélateur serait de tester l&#8217;invocation de cette fonction
pour vérifier qu&#8217;elle produit un résultat prédictible.</p>
</div>
<div class="paragraph">
<p>Modifions notre fichier de test pour établir une connexion à la base de données.
Nous avons une contrainte toutefois&#160;: nous devons utiliser une base dont
l&#8217;emplacement est différent de notre environnement de développement.
Le raisonnement est de pouvoir la recréer et la détruire sans craindre
de générer des effets secondaires, y compris si nous exécutons les tests
sur le serveur de production.</p>
</div>
<div class="paragraph">
<p>Pour ce faire, commençons par simplifier le fichier <code>src/database.js</code> en
supprimant tout chemin d&#8217;accès écrit en&#160;dur&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/src/database.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sqlite <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sqlite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">connect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">db_path</span><span class="token punctuation">)</span> <span class="token operator">=></span> sqlite<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> connect<span class="token punctuation">;</span>                           <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le module n&#8217;a plus d&#8217;opinion sur l&#8217;emplacement de la base de données.</p>
</li>
<li>
<p>Le module exporte désormais une fonction à paramétrer lors de son exécution.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cela ouvre la voie pour nous connecter à une base de données différente
dans notre script de tests.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/with-db.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strict<span class="token punctuation">;</span>
<span class="token keyword">const</span> configRoute <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/routes/books.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> database <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/database.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// assert.deepEqual(typeof configRoute, 'function');// <b class="conum">(1)</b></span>

<span class="token function">database</span><span class="token punctuation">(</span><span class="token string">':memory:'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">db</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                   <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">configRoute</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// <b class="conum">(3)</b></span>
  assert<span class="token punctuation">.</span><span class="token function">deepEqual</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> route<span class="token punctuation">,</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token comment">/*
  assert.deepEqual(route(request, response));       // <b class="conum">(5)</b>
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous pouvons nous passer de ce test puisque nous allons tester l&#8217;exécution de la fonction.</p>
</li>
<li>
<p>La valeur <code>:memory:</code> est une valeur spéciale de chemin d&#8217;accès pour <em>SQLite</em>&#160;– la base est créée en mémoire et disparaît à la fin de l&#8217;exécution du script.</p>
</li>
<li>
<p>Configuration de la route&#160;– comme nous le faisons dans le fichier <code>configure.js</code>.</p>
</li>
<li>
<p>La route configurée retourne bien une fonction, mais cela ne suffit pas à affirmer que son fonctionnement correspond à nos attentes.</p>
</li>
<li>
<p>En commentaire&#160;: comment tester le résultat de la route <em>Express</em>&#160;?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Résultat&#160;: la connexion à la base de données réussit et nous sommes en mesure
de la transmettre à la fonction de paramétrage de la route.</p>
</div>
<div class="paragraph">
<p>Le chemin d&#8217;accès était exprimé de la manière suivante&#160;: <code>/books/:id</code>.
Autrement dit, la requête à la base de données dépend d&#8217;un objet <code>request.params</code>
dont la clé&#160;<code>id</code> vaut&#160;<code>1</code>.</p>
</div>
<div class="paragraph">
<p>C&#8217;est ce que nous allons passer à la fonction <code>route</code>.
Mais qu&#8217;en est-il de la réponse&#160;? Doit-on réécrire un objet qui reproduit
l&#8217;objet <code>response</code> d'<em>Express</em>&#160;?
Je déconseille cette option car elle nous oblige à écrire du code, faillible,
et donc à introduire des biais dans nos propres tests.</p>
</div>
<div class="paragraph">
<p>Les <em>bibliothèques d&#8217;interception</em> évitent ce cas de figure.
Elles se greffent à du code existant pour observer ses réactions, voire pour les
remplacer temporairement, le temps des tests.
J&#8217;ai l&#8217;habitude d&#8217;utiliser le module&#160;<code>npm</code> <em>sinon.js</em> (<span class="URL"><a href="https://npmjs.com/sinon" class="bare">npmjs.com/sinon</a></span>,
<span class="URL"><a href="https://sinonjs.org/" class="bare">sinonjs.org/</a></span>).

Il propose tout le nécessaire, est bien documenté et fonctionne aussi bien
côté Node que côté navigateurs&#160;web.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/with-sinon.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strict<span class="token punctuation">;</span>
<span class="token keyword">const</span> configRoute <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/routes/books.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> database <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/database.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sinon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sinon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>response<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">database</span><span class="token punctuation">(</span><span class="token string">':memory:'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">db</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">configRoute</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sendFake <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'send'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>

  <span class="token keyword">return</span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">{</span>params<span class="token punctuation">:</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sendFake<span class="token punctuation">.</span>called<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous récupérons l&#8217;objet de réponse d'<em>Express</em>&#160;– je l&#8217;ai découvert en fouillant dans les objets exportés par le module.</p>
</li>
<li>
<p>Nous neutralisons la fonction <code>response.send()</code> avec un <em>stub</em> pour observer les données qui lui sont données en argument.</p>
</li>
<li>
<p>La propriété <code>called</code> d&#8217;un <em>stub</em> ou d&#8217;un espion passe à <code>true</code> si elle a été appelée.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>C&#8217;est une chance que le module <em>Express</em> expose directement un objet de réponse
sans avoir à attendre qu&#8217;une vraie requête HTTP atteigne notre serveur web.
Le <em>stub</em> neutralise son action&#160;– nous nous contentons d&#8217;observer
comment la fonction est appelée.
L&#8217;enjeu est de constater que la connexion à la base de données se passe bien,
que la requête retourne bien la ligne attendue et que ses valeurs soient
bien transmises en réponse.</p>
</div>
<div class="paragraph">
<p>Malheureusement pour nous&#160;: la base en mémoire n&#8217;a aucune donnée.
Le test échoue donc.
Notre nouvel objectif est de maintenir l&#8217;intention du test et de lui ajouter
les données nécessaires à son exécution.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Glossaire</span> Espions, stubs et mocks</div>
<div class="paragraph">
<p>Les espions, <em>stubs</em> et <em>mocks</em> couvrent trois aspects complémentaires.
Les <strong>espions enregistrent les appels</strong> à des attributs et à des fonctions
– le nombre de fois, quels arguments, quels résultats.
Les <strong><em>stubs</em> interceptent les appels</strong> à des fonctions&#160;– vous pouvez même définir
les valeurs de retours ou de rappel en fonction des paramètres d&#8217;appel.
Les <strong><em>mocks</em> interceptent les résultats</strong>&#160;– je n&#8217;en parle pas car notre
exemple ne s&#8217;y prête&#160;pas.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>C&#8217;est la raison d&#8217;être des fichiers dits de <em>fixtures</em>.
Ces données peuplent une base de données d&#8217;enregistrements suffisamment
réalistes pour illustrer les différents cas de figure de notre application.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/fixtures.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`CREATE TABLE books
  (id INTEGER PRIMARY KEY, title VARCHAR, isbn VARCHAR);`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`INSERT INTO books (title, isbn) VALUES
  ("Design Systems", "978-3945749586"),
  ("Sass pour les web designers", "977-2212141474"),
  ("Node.js", "978-2212139938");`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> db<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce cas est particulièrement adapté à la syntaxe
<a href="../chapter-03/index.html#async-await"><code>async</code>/<code>await</code></a>.



Ces promesses sont séquentielles et la syntaxe linéarise leur lecture.
Le même exemple sans <code>async</code>/<code>await</code> et juste avec les promesses est moins
digeste à&#160;lire.</p>
</div>
<div class="paragraph">
<p>Il ne nous reste plus qu&#8217;à appeler cette fonction de génération de données
depuis notre script de tests&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/with-sinon-data.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">// ...</span>
<span class="token keyword">const</span> loadFixtures <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./fixtures.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">database</span><span class="token punctuation">(</span><span class="token string">':memory:'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">db</span> <span class="token operator">=></span> <span class="token function">loadFixtures</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">db</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">configRoute</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sendFake <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'send'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">{</span>params<span class="token punctuation">:</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sendFake<span class="token punctuation">.</span><span class="token function">calledWith</span><span class="token punctuation">(</span>sinon<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(3)</b></span>
        <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'Design Systems'</span>                   <span class="token comment">// <b class="conum">(4)</b></span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Chargement du module qui contient les requêtes SQL nécessaires à l&#8217;initialisation de la table et des données.</p>
</li>
<li>
<p>Les données sont chargées après la connexion à la base et avant l&#8217;exécution des tests.</p>
</li>
<li>
<p>Nous remplaçons l&#8217;appel à <code>sendFake.called()</code> par <code>sendFake.calledWith()</code> pour affirmer plus explicitement le résultat attendu.</p>
</li>
<li>
<p>Le module sinon propose un ensemble de fonctions de vérification (les <em>matchers</em>)&#160;– ici, nous vérifions que <code>response.send()</code> est appelée avec un objet, qui contient au moins une clé <code>title</code> dont la valeur est <code>Design Systems</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le test est concluant&#160;!
Et nous n&#8217;avons plus de doute que la fonction <code>response.send()</code>
est bien appelée avec la valeur issue de la base de données.
Le module <em>sinon</em> a été d&#8217;une grande aide pour intercepter l&#8217;exécution de cette
fonction et pour nous faciliter son introspection, après&#160;coup.</p>
</div>
<div class="paragraph">
<p>Pour être exhaustifs, il nous faudrait maintenant tester le deuxième cas de figure,
celui où le paramètre&#160;<code>id</code> de l&#8217;URL fait référence à un enregistrement qui
n&#8217;existe pas en base de données pour générer une erreur&#160;404.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/with-sinon-full.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">// ...</span>
<span class="token function">database</span><span class="token punctuation">(</span><span class="token string">':memory:'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">db</span> <span class="token operator">=></span> <span class="token function">loadFixtures</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">db</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">configRoute</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sendFake <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'send'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> statusSpy <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">spy</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

    <span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">{</span>params<span class="token punctuation">:</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sendFake<span class="token punctuation">.</span>called<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">{</span>params<span class="token punctuation">:</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(2)</b></span>
      assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>statusSpy<span class="token punctuation">.</span><span class="token function">calledWith</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(3)</b></span>
      assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sendFake<span class="token punctuation">.</span><span class="token function">calledWith</span><span class="token punctuation">(</span><span class="token string">'Livre inconnu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(4)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création d&#8217;un espion sur la méthode <code>response.status()</code> du module <em>Express</em>.</p>
</li>
<li>
<p>Création d&#8217;un deuxième cas de test, pour couvrir l&#8217;appel à un enregistrement inconnu en base de données.</p>
</li>
<li>
<p>La méthode <code>calledWith()</code> détermine si une fonction est appelée avec cette exacte valeur.</p>
</li>
<li>
<p>Cette méthode s&#8217;applique aussi aux <em>stubs</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dans ce cas, nous avons eu recours à un <em>espion</em> pour observer la méthode
<code>response.status()</code> d&#8217;Express.
Nous avons procédé ainsi car nous n&#8217;avions pas à neutraliser son fonctionnement
mais seulement à observer la valeur de son argument.
Le fait qu&#8217;il soit de&#160;<code>404</code> prouve que la branche de code à l&#8217;intérieur de la
condition&#160;<code>if</code> a bien été visitée.</p>
</div>
<div class="paragraph">
<p>Je constate un problème dans cette écriture cependant.
L&#8217;espion et le <em>stub</em> sont créés une seule fois et partagés entre chaque test.
Cette pratique entraînera des effets de bord si nous ne prêtons pas attention
au déroulé des tests.
Ils devraient être remis à zéro entre chaque&#160;test.</p>
</div>
<div class="paragraph">
<p>Les <em>suites de tests</em> sont des outils qui renforcent la cohérence
et la structure, notamment pour automatiser l&#8217;exécution d&#8217;actions avant et après
des tests.
J&#8217;utilise le module&#160;<code>npm</code> <em>mocha</em> (<span class="URL"><a href="https://npmjs.com/mocha" class="bare">npmjs.com/mocha</a></span>,
<span class="URL"><a href="https://mochajs.org" class="bare">mochajs.org</a></span>), par habitude, parce qu&#8217;il ne demande aucune
configuration et parce qu&#8217;il fait le travail à la fois côté Node et côté
navigateurs.

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>../node_modules/.bin/mocha testing/tests/with-mocha.js</pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/with-mocha.js (modules)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strict<span class="token punctuation">;</span>
<span class="token keyword">const</span> configRoute <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/routes/books.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> database <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/database.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sinon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sinon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>response<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loadFixtures <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./fixtures.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>describe<span class="token punctuation">,</span> before<span class="token punctuation">,</span> afterEach<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mocha'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>it<span class="token punctuation">:</span>test<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mocha'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token comment">// ...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Import des fonctions qui décrivent respectivement la suite de tests, l&#8217;exécution de code avant le démarrage de la suite et l&#8217;exécution de code après chaque&#160;test.</p>
</li>
<li>
<p>Import de la fonction de&#160;test.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notre script de test comporte désormais ce qu&#8217;on appelle une <em>suite de tests</em>,
c&#8217;est-à-dire, un <strong>ensemble de tests qui expriment nos attentes</strong> vis-à-vis
d&#8217;une fonctionnalité&#160;– ici, une route d&#8217;application&#160;web.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/with-mocha.js (configuration)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">// ... (modules)</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'routes/books.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                   <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">let</span> db<span class="token punctuation">,</span> route<span class="token punctuation">;</span>

  <span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                                <span class="token comment">// <b class="conum">(2)</b></span>
    db <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">database</span><span class="token punctuation">(</span><span class="token string">':memory:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">loadFixtures</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    route <span class="token operator">=</span> <span class="token function">configRoute</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> sinon<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Déclaration de la suite de tests&#160;– sa valeur reflète généralement le sujet des tests.</p>
</li>
<li>
<p>Avant le démarrage des tests, nous créons la base de données et configurons la route.</p>
</li>
<li>
<p>Après chaque test, nous remettons à zéro l&#8217;état de <em>sinon</em>&#160;– nos tests n&#8217;ont plus la possibilité de se parasiter entre&#160;eux.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce découpage a le mérite de clarifier les différents temps de nos tests,
à savoir la préparation de l&#8217;environnement d&#8217;exécution, le nettoyage puis
l&#8217;exécution des&#160;tests.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">testing/tests/with-mocha.js (tests)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">// ... (modules)</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'routes/books.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                   <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token comment">// ... (configuration)</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'statut 200'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                          <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">const</span> sendFake <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'send'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">{</span>params<span class="token punctuation">:</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sendFake<span class="token punctuation">.</span><span class="token function">calledWith</span><span class="token punctuation">(</span>sinon<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'Design Systems'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'statut 404'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                          <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">const</span> sendFake <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">stub</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'send'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> statusSpy <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">spy</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">{</span>params<span class="token punctuation">:</span> <span class="token punctuation">{</span>id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>statusSpy<span class="token punctuation">.</span><span class="token function">calledWith</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sendFake<span class="token punctuation">.</span><span class="token function">calledWith</span><span class="token punctuation">(</span><span class="token string">'Livre inconnu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La suite compte deux tests.</p>
</li>
<li>
<p>Premier test&#160;: se termine quand la promesse retournée par la fonction <code>route()</code> est résolue.</p>
</li>
<li>
<p>Deuxième test&#160;: cette fois, l&#8217;espion et le stub ne sont pas affectés par le précédent&#160;test.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La suite de tests ne cherche pas à savoir comment nous testons notre code.
Son objectif est de capturer les messages d&#8217;erreur des assertions qui échouent
et de nous les communiquer en contexte.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/tests-ok.png" alt="tests ok" width="66%">
</div>
<div class="title">Figure 6. Exemple d&#8217;une suite de tests mocha qui se termine avec succès</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">⚠️</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Réflexion</span> Écriture optimiste</div>
<div class="paragraph">
<p>Nous avons l&#8217;habitude d&#8217;écrire des tests de manière optimiste.
Ce biais naturel fait que nous ne testons pas les cas
dont nous n&#8217;avons pas encore connaissance.</p>
</div>
<div class="paragraph">
<p>Trouver les cas de figure qui font échouer notre code est un vrai travail
de réflexion.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;approche <em>Test Driven Development</em> (<em>TDD</em>) est pilotée par les tests.
Dans ce contexte, nous écrivons les tests avant même d&#8217;avoir écrit notre code.
Cela nous force à réfléchir à l&#8217;intention et à concevoir
le code de manière à ce qu&#8217;il soit testable.
Qu&#8217;on adopte ou non cette méthode, nous gagnons en qualité en faisant échouer
les tests, juste pour nous assurer que ce n&#8217;est pas un bogue (oui ça arrive)
quand ils indiquent que tout est correct.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/tests-ko.png" alt="tests ko" width="80%">
</div>
<div class="title">Figure 7. Exemple d&#8217;une suite de tests mocha dont un test échoue</div>
</div>
<div class="paragraph">
<p>Maintenant que nos tests sont écrits, nous sommes en mesure de
<a href="#deployment">déployer notre application</a> automatiquement, seulement
si leur exécution est réussie.</p>
</div>
</div>
<div class="sect2">
<h3 id="deployment">3.3. Déployer automatiquement</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Cette section continue à ajouter de l&#8217;automatisation
dans notre manière de fonctionner.
Elle n&#8217;est donc pas spécifique aux <em>frameworks</em> et est tout à fait valide
si vous vous constituez votre propre application, brique par brique.</p>
</div>
<div class="paragraph">
<p>Le déploiement automatique sert principalement à <strong>révéler les points de friction</strong>.
Si nous manquons de confiance dans le déploiement, c&#8217;est probablement qu&#8217;il
y a des nœuds à démêler.
L&#8217;automatisation du déploiement et la facilité de sa répétabilité nous aident
à gommer ces frictions petit à petit.
La pression de la mise en production se transforme en incitation au changement.</p>
</div>
<div class="paragraph">
<p>La fréquence des déploiements <strong>révèle les points de congestion</strong>.
Tout ce qui est trop lent à notre goût est un appel à gommer cette lenteur,
à trouver une autre approche pour finalement observer le résultat du déploiement
plus rapidement.</p>
</div>
<div class="paragraph">
<p>L&#8217;enjeu des livraisons automatisées est double&#160;: d&#8217;abord,
<strong>faciliter le transport du code vers le serveur de production</strong>
(en cas de bogue, le temps passé concerne seulement la résolution du problème et non
la livraison elle-même) et servir de <strong>documentation du processus de livraison</strong>.</p>
</div>
<div class="paragraph">
<p>Nous abordons plus en détail les différents mécanismes techniques
dans le <a href="../chapter-06/index.html">chapitre&#160;6</a>, que ce soit &#8220;à la main&#8221;,
avec des recettes de déploiement ou par le biais de notre service d&#8217;hébergement.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced">4. Pour aller plus loin</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="advanced.server">4.1. Pourquoi lancer un serveur ?</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Il y a des environnements où des logiciels comme Apache et Nginx intègrent
notre langage de programmation avec des modules&#160;: par exemple, PHP avec le <code>mod_php</code>
ou Perl avec le <code>mod_cgi</code>.
Les requêtes entrantes sont dirigées vers un script que le module interprète
et qui retourne une réponse, dynamiquement.</p>
</div>
<div class="paragraph">
<p>Le <strong>script PHP est interprété à chaque requête</strong> et toute cette représentation
est détruite une fois la réponse envoyée (mémoire, valeurs des variables, configuration).
Il faut recourir à un ensemble de modules additionnels pour optimiser ce gâchis
de ressources informatiques&#160;: cache d&#8217;interprétation, cache applicatif, cache de configuration.</p>
</div>
<div class="paragraph">
<p>Démarrer un serveur HTTP dans le langage de notre application nous éloigne de
ce modèle coûteux et nous rapproche d&#8217;un fonctionnement plus performant, organisé
autour des trois piliers suivants&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Node et Apache/Nginx fonctionnent ensemble</strong>&#160;– ils se relaient les requêtes
et les réponses car ils parlent le même protocole.</p>
</li>
<li>
<p><strong>Le serveur Node est &#8220;préchauffé&#8221;</strong>&#160;– une requête entrante trouve une application
déjà opérationnelle, déjà configurée, déjà connectée à une base de données
et prête à répondre.</p>
</li>
<li>
<p><strong>Le code exécuté est spécifique à la requête</strong>&#160;– l&#8217;application reçoit chaque
requête de manière indépendante en ayant le minimum d&#8217;effort à faire pour
générer une réponse.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Autrement dit, ce modèle réduit le temps de parcours entre une requête entrante
et une réponse sortante.
Cela a un effet significatif sur le temps d&#8217;apparition de l&#8217;icône de chargement
côté client.</p>
</div>
</div>
<div class="sect2">
<h3 id="http">4.2. Comprendre le modèle&#160;HTTP</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Deux éléments ressortent du modèle de fonctionnement du protocole HTTP&#160;:
<strong>tout est du texte</strong> (en-têtes et contenu) et <strong>chaque requête est indépendante</strong>.
Cela revient à dire que chaque requête emporte son contexte avec elle, toutes les
informations nécessaires à sa compréhension.</p>
</div>
<div class="paragraph">
<p>Que se passe-t-il lorsque notre navigateur web ou le programme <code>curl</code>
demande à accéder à <span class="URL"><a href="http://example.com" class="bare">example.com</a></span>&#160;?



</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Résolution de DNS</strong>&#160;: un des annuaires DNS est interrogé pour savoir quelle
adresse&#160;IP est associée au nom de domaine.</p>
</li>
<li>
<p><strong>Établissement de la connexion</strong>&#160;: le client (nous) ouvre une connexion réseau
avec le serveur pour échanger des données.</p>
</li>
<li>
<p><strong>Envoi de la requête HTTP</strong>&#160;: la requête contient des informations au format
texte (méthode, en-têtes, parfois un corps de message) pour que le serveur
s&#8217;adapte au mieux à notre demande.</p>
</li>
<li>
<p><strong>Réception de la requête</strong>&#160;: le serveur interprète la demande
(est-ce qu&#8217;il la comprend&#160;?), cherche la ressource associée au chemin demandé.</p>
</li>
<li>
<p><strong>Envoi de la réponse</strong>&#160;: le serveur répond avec des données au format texte
(statut, en-têtes, corps de message).</p>
</li>
<li>
<p><strong>Interprétation de la réponse</strong>&#160;: l&#8217;en-tête <code>Content-Type</code> aide le client à déterminer
comment afficher les informations - XML, HTML, JSON, CSS, vidéo etc&#160;– et si
le document contient d&#8217;autres ressources à aller récupérer.

</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dans le cas du programme <code>curl</code>, la réponse est affichée telle quelle, en texte.</p>
</div>
<div class="paragraph">
<p>Avec un navigateur en revanche, le HTML est interprété.
Le navigateur demande les ressources listées dans les différentes balises
(<code>img</code>, <code>video</code>, <code>audio</code>)&#160;; l&#8217;indicateur de chargement
s&#8217;arrête quand toutes les ressources ont été demandées et téléchargées.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/http-waterfall.png" alt="http waterfall">
</div>
<div class="title">Figure 8. Cascade de requêtes HTTP suite à l&#8217;interprétation d&#8217;un document HTML par un navigateur</div>
</div>
<div class="paragraph">
<p>Le nombre de requêtes et la taille des ressources affectent donc la vitesse de
chargement d&#8217;une page.
Plus il y en a, plus le client doit en demander et plus le serveur multiplie le
nombre de réponses.
Le temps de téléchargement augmente.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Technique</span> Les WebViews sur mobile</div>
<div class="paragraph">
<p>Les WebViews sont des composants proposés par les systèmes d&#8217;exploitation
pour embarquer du contenu HTML dans une application native.</p>
</div>
<div class="paragraph">
<p>Elles fonctionnent comme des navigateurs, sans les boutons de navigation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le module&#160;<code>npm</code> <em>jshttp</em> (<span class="URL"><a href="https://github.com/jshttp" class="bare">github.com/jshttp</a></span>) affiche les en-têtes
de réponse comme le programme <code>curl</code> le ferait et détaille le parcours réseau,
de la résolution du nom de domaine jusqu&#8217;au temps passé à négocier une transaction
sécurisée.

Nous comprenons ainsi mieux des temps qui sont rendus invisibles et sur lesquels nous
pouvons faire des efforts&#160;– réduire les temps de transfert ou le temps de réponse
de notre application par exemple.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/httpstat.png" alt="httpstat">
</div>
<div class="title">Figure 9. En-têtes de réponse et durée des différentes étapes de l&#8217;exécution d&#8217;une requête&#160;HTTP</div>
</div>
</div>
<div class="sect2">
<h3 id="database-choice">4.3. Quel(s) moteur(s) de base(s) de données choisir ?</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Quand je codais en PHP, nous parlions beaucoup de la pile technique <em>LAMP</em>
(Linux, Apache, MySQL et&#160;PHP).
C&#8217;était la combinaison <em>de&#160;facto</em> des différents projets.
MySQL était la base de données de choix tandis que les Pythonistes et Rubyistes
se focalisaient plutôt sur PostgreSQL.


</p>
</div>
<div class="paragraph">
<p>J&#8217;ai croisé beaucoup de développeurs et développeuses qui se lançaient dans
les bases de données dites &#8220;documents&#8221; comme MongoDB
&#8220;parce que les données sont stockées en&#160;JSON et donc c&#8217;est un choix logique pour Node&#8221;.</p>
</div>
<div class="paragraph">
<p>Je suis fortement en désaccord avec cette dernière affirmation et je pense que la bonne
base de données est celle qui tient la route par rapport à Node.
Le <strong>débit de données</strong> entre Node et la base compte davantage, ainsi que
la <strong>rapidité de la base à exécuter une requête</strong> et retourner des résultats
(certaines gèrent mieux que d&#8217;autres la concurrence d&#8217;accès ou les critères
de filtrage).
Le troisième critère est subjectif&#160;: c&#8217;est le <strong>confort d&#8217;utilisation</strong>&#160;;
PostgreSQL est peut-être plus rapide pour un cas d&#8217;usage précis, mais si vous
êtes plus à l&#8217;aise avec MariaDB ou MySQL, commencez avec la base qui vous parle
le plus&#160;– ou expérimentez et réservez-vous le droit de changer d&#8217;avis après
avoir joué avec un nombre représentatif de données.</p>
</div>
<div class="paragraph">
<p>Je choisis une base de données en fonction de plusieurs critères&#160;:
la rapidité de lecture, l&#8217;intégrité des données, la volumétrie acceptée avant
de devoir distribuer les données sur plusieurs machines et enfin,
des fonctionnalités spéciales (recherche géographique, type de champ particulier
comme le champ&#160;JSON de PostgreSQL).



</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Stockage fichier</dt>
<dd>
<p>Nous pourrions tout à fait décider d&#8217;utiliser un fichier&#160;JSON ou CSV pour
lire et écrire des données.
C&#8217;est facile à mettre en œuvre, mais c&#8217;est la solution la plus lente à tout
point de vue&#160;: recherche comme écriture.
</p>
</dd>
<dt class="hdlist1">Stockage en mémoire</dt>
<dd>
<p>Redis et Memcached sont des gestionnaires très rapides en lecture et en écriture.
C&#8217;est idéal pour accéder fréquemment aux données et les modifier, avant
de les sauvegarder sur un stockage moins rapide mais plus sûr.
Ils sont généralement dits &#8220;clé/valeur&#8221; car nous cherchons un identifiant
donné pour récupérer un, voire plusieurs champ(s) associé(s).

</p>
</dd>
<dt class="hdlist1">Stockage sur disque</dt>
<dd>
<p>MySQL, MSSQL, PostgreSQL et MongoDB stockent leurs données sur disque,
dans des fichiers optimisés pour la recherche d&#8217;informations&#160;– les <em>index</em>.
Ces moteurs sont souvent rapides en lecture et plus lents en écriture&#160;– selon
le type de disque dur utilisé pour le stockage.
Certains sont contraints par des schémas (bases&#160;SQL) tandis que d&#8217;autres
ont une structure libre (MongoDB).<br>
En pratique, nous typons ou structurons les données d&#8217;une manière ou d&#8217;une autre,
a&#160;minima pour les manipuler de manière cohérente dans notre code.
Certaines bases SQL ont un type de champ&#160;JSON, en structure libre.




</p>
</dd>
<dt class="hdlist1">Stockage sur un service en ligne</dt>
<dd>
<p>Firebase, DynamoDB, Parse et Kinto sont des gestionnaires de bases de données
accessibles comme des services, avec des requêtes HTTP.
Les services d&#8217;hébergement gèrent la distribution des données et leur sauvegarde.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>J&#8217;utilise souvent SQLite pour prototyper quelque chose de rapide sur ma machine.
Je passe ensuite à MySQL ou PostsgreSQL selon le projet&#160;– je me sens autonome sur
le premier pour l&#8217;installation tandis que je préfère un service qui gère tout de
bout en bout avec le second.</p>
</div>
<div class="paragraph">
<p>Je peux être amené à indexer les données dans une base Elasticsearch
ou Algolia pour leur donner une autre structure, spécialement optimisée pour
la recherche&#160;: une lecture très rapide sur des critères variables.
Je le fais si un des aspects principaux du projet est de préserver des performances
élevées, qui ne soient pas ralenties par l&#8217;activité d&#8217;une base&#160;SQL.
</p>
</div>
<div class="paragraph">
<p>Je complète en général avec Redis pour gérer les <a href="#job-queues">files d&#8217;attente</a>,
des données intermédiaires que je considère comme &#8220;jetables&#8221;.

</p>
</div>
<div class="paragraph">
<p>S&#8217;il est plus simple de tout gérer avec un seul support de stockage, utiliser
<strong>plusieurs gestionnaires de bases de données</strong> dans une même application est quelque chose de tout
à fait encouragé pour profiter de leurs caractéristiques.</p>
</div>
</div>
<div class="sect2">
<h3 id="security">4.4. Protéger nos applications</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Il faut prendre des mesures de précaution dès lors que nous utilisons des
données saisies par un utilisateur, c&#8217;est-à-dire
<strong>toute variable dont la valeur provient de l&#8217;extérieur</strong>.
Je pense à des données de formulaire, des paramètres d&#8217;URL, des chemins d&#8217;accès,
des fichiers téléversés mais aussi des scripts qui sont injectés dans la page,
volontairement ou via un logiciel vérolé installé sur leur ordinateur.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><span class="URL"><a href="https://npmjs.com/helmet" class="bare">npmjs.com/helmet</a></span></dt>
<dd>
<p>Déjoue les injections de scripts et d&#8217;iframes non&#160;sollicitées.
</p>
</dd>
<dt class="hdlist1"><span class="URL"><a href="https://npmjs.com/safe-regex" class="bare">npmjs.com/safe-regex</a></span></dt>
<dd>
<p>Filtre une expression régulière fournie ou composée avec une valeur fournie par un utilisateur.
Cela évite certains bogues qui surchargent la CPU ou qui déjouent les motifs des expressions.
</p>
</dd>
<dt class="hdlist1"><span class="URL"><a href="https://npmjs.com/dompurify" class="bare">npmjs.com/dompurify</a></span></dt>
<dt class="hdlist1"><span class="URL"><a href="https://npmjs.com/xss" class="bare">npmjs.com/xss</a></span></dt>
<dd>
<p>Nettoie le HTML d&#8217;attributs et de balises non&#160;sollicités.
Les injections de scripts et les événements malintentionnés de clics sont supprimés.


</p>
</dd>
<dt class="hdlist1"><span class="URL"><a href="https://npmjs.com/sql-escape-string" class="bare">npmjs.com/sql-escape-string</a></span></dt>
<dd>
<p>Nettoie une saisie utilisateur de tout caractère qui pourrait déjouer nos attentes
au sein d&#8217;une requête&#160;SQL.
</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Outre les données arbitraires, il faut toujours s&#8217;assurer des <strong>permissions</strong>.
L&#8217;utilisateur a-t-il vraiment le droit d&#8217;être là ou il est&#160;?
Le volume du fichier téléversé est-il vraiment cohérent&#160;?</p>
</div>
<div class="paragraph">
<p>L&#8217;utilisation du <a href="../chapter-03/index.html#strict">mode strict</a> a l&#8217;avantage
de nous protéger de l&#8217;exploitation d&#8217;anciennes bizarreries d&#8217;ECMAScript.
Ce qui doit planter plante au lieu d&#8217;être passé sous silence.
</p>
</div>
<div class="paragraph">
<p>Parfois, même les caractères autorisés suffisent à déjouer notre attention.
C&#8217;est le cas si une variable est utilisée pour composer un chemin avec
<code>path.resolve()</code> ou <code>path.join()</code> par exemple.



La saisie utilisateur crée un chemin de traverse qui permet d&#8217;aller exploiter
des données ailleurs sur l&#8217;ordinateur.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path-traversal.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>resolve<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> base_dir <span class="token operator">=</span> __dirname<span class="token punctuation">;</span>
<span class="token keyword">const</span> bad_user_input <span class="token operator">=</span> <span class="token string">'/etc/passwd'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> bad_user_input<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resolved<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>base_dir<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resolved<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> doit commencer par </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base_dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>/etc/passwd</code>&#160;– notre chemin de base a été complètement remplacé.</p>
</li>
<li>
<p>Affiche <code>/.../chapter-07/examples</code>&#160;– notre chemin de base a été complètement remplacé.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Un moyen solide de vérifier que nous n&#8217;avons pas été dérouté·e en dehors
d&#8217;un répertoire racine&#160;– ici, <code>base_dir</code>&#160;– est de vérifier que le chemin final
débute bien par le chemin du répertoire racine.

</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 8. En-têtes de réponse qui ont un impact sur la sécurité de navigation</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">En-tête</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-DNS-Prefetch-Control</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Avec la valeur <code>off</code>, le navigateur ne va pas proactivement chercher les informations DNS des ressources contenues dans la page. Nos informations de navigation ne sont pas divulguées à notre&#160;insu.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-Frame-Options</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Avec la valeur <code>SAMEORIGIN</code>, le navigateur autorise la création d'<code>&lt;iframe&gt;</code> seulement depuis le même domaine – les <code>&lt;iframe&gt;</code> tierces sont bloquées.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Strict-Transport-Security</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Lorsque l&#8217;option est activée, le navigateur accède par défaut à ce site en HTTPS au lieu de&#160;HTTP.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-Download-Options</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Avec la valeur <code>noopen</code>, Internet Explorer télécharge un fichier au lieu de tenter de l&#8217;ouvrir dans le navigateur – cela risque d&#8217;être exploité pour pirater le navigateur par des fichiers malintentionnés.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-Content-Type-Options</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Avec la valeur <code>nosniff</code>, les navigateurs bloquent les scripts et les styles qui n&#8217;ont respectivement pas l&#8217;en-tête <code>Content-Type</code> à <code>application/javascript</code> et <code>text/css</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-XSS-Protection</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Avec la valeur <code>1; mode=block</code>, les navigateurs interrompent le chargement d&#8217;une page s&#8217;ils détectent une exploitation malintentionnée de chargement de données ou de fichier.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Open Web Application Security Project (OWASP)</div>
<div class="paragraph">
<p>

L&#8217;organisme <em>Open Web Application Security Project</em> (<em>OWASP</em>) recueille et
diffuse nombre de critères de sécurité à connaître et vérifier pour déjouer
au mieux les attaques.</p>
</div>
<div class="paragraph">
<p>Il met à disposition un guide spécialisé pour Node à l&#8217;adresse suivante&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodegoat.herokuapp.com/tutorial" class="bare">nodegoat.herokuapp.com/tutorial</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="lambda">4.5. Une application minimaliste avec les Lambda</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Le principe d&#8217;une application web est d&#8217;afficher un résultat à partir d&#8217;un
chemin d&#8217;accès et de rester allumée en permanence, sauf exception.
Les <em>Lambda</em> sont une approche minimaliste d&#8217;application web&#160;: il n&#8217;y a qu&#8217;une
seule route, c&#8217;est <strong>une seule fonction qui retourne un résultat</strong>.</p>
</div>
<div class="paragraph">
<p>L&#8217;application s&#8217;endort quand elle ne reçoit pas de trafic dans un laps de temps donné.
Elle est &#8220;réveillée&#8221; quand du trafic arrive.
La facturation se fait à l&#8217;échelle de la seconde et au nombre de requêtes entrantes.
Nous en parlons un peu plus en détails dans le <a href="../chapter-06/index.html">chapitre&#160;6</a>.</p>
</div>
<div class="paragraph">
<p>Ce mécanisme s&#8217;adapte à des résultats en réaction à un événement&#160;: <em>webhook</em>,
notification, erreur, etc.</p>
</div>
<div class="paragraph">
<p>Le module&#160;<code>npm</code> <em>micro</em> (<span class="URL"><a href="https://npmjs.com/micro" class="bare">npmjs.com/micro</a></span>) est un serveur minimaliste
qui répond à ce principe de micro-application, prête à être mise en pause à
tout instant.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10 interactive--endpoint">
<div class="title">micro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> micro <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'micro'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>random<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pokemon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">micro</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous avons accès à la requête et à la réponse, mais nous avons aussi la liberté de renvoyer un résultat à la fonction de rappel.</p>
</li>
<li>
<p>À la manière d&#8217;une <a href="#server">application classique</a>, nous la démarrons sur le port HTTP de notre choix.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Un service comme <em>AWS&#160;Lambda</em> (<span class="URL"><a href="https://aws.amazon.com/lambda" class="bare">aws.amazon.com/lambda</a></span>) pousse
le concept encore plus loin.

La fonction réagit à un événement interne (notification SQS, quelque chose lié
à notre infrastructure, déploiement) ou à un événement externe (via l&#8217;API
ou un autre service ouvert vers l&#8217;extérieur).
Elle n&#8217;est pas forcément exposée sur le&#160;Web.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">lambda.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> lambda <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'apex.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>random<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pokemon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">lambda</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=></span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>C&#8217;est tout ce qu&#8217;il faut pour qu&#8217;une <em>Lambda</em> retourne un résultat utilisable pour l&#8217;appelant.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;adaptabilité de ce mécanisme permet de créer une API complète en agrégeant
plusieurs <em>Lambda</em> derrière un <em>portail d&#8217;API</em> comme <em>AWS&#160;API Gateway</em>
(<span class="URL"><a href="https://aws.amazon.com/api-gateway" class="bare">aws.amazon.com/api-gateway</a></span>).
À une API et une ressource (chemin et méthode HTTP) est associée une ressource
AWS, dont les <em>Lambda</em> font partie.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">5. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons vu qu&#8217;une <strong>application web est bâtie autour du protocole HTTP</strong>.
Elle passe son temps à interpréter le texte des requêtes entrantes et à produire
des réponses, elles aussi au format texte.
Ces données de sortie sont aussi bien issues des fichiers placés sur notre disque
que des pages HTML assemblées dynamiquement depuis une base de données.</p>
</div>
<div class="paragraph">
<p>Les frameworks structurent notre pensée et automatisent l&#8217;application de
vérifications et de transformations pour toutes les requêtes entrantes.
Une fois le concept maîtrisé, il devient plus facile d&#8217;en essayer de nouveaux
et d&#8217;utiliser celui qui nous plaît le plus.</p>
</div>
<div class="paragraph">
<p>Nous avons aussi constaté qu&#8217;une <strong>approche modulaire permet d&#8217;interchanger des modules</strong>
entre eux, mais aussi qu&#8217;elle amène naturellement à une structure adaptée aux
frameworks et à l&#8217;écriture de tests, indispensables pour améliorer la
confiance dans notre code et pour en automatiser les déploiements.</p>
</div>
<div class="paragraph">
<p>Le protocole HTTP est une pierre angulaire du Web tel que nous l&#8217;utilisons.
Le pratiquer avec Node est un bon moyen de le comprendre par la pratique.</p>
</div>
</div>
</div>
</div>
<section class="next">
  <a href="#top">Haut de page</a> ou
  <a href="https://oncletom.io/node.js/#apprendre-node-js-en-ligne" class="read-more">retour au sommaire</a>.
</section>
</body>
</html>