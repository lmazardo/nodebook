<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Créer une application front-end</title>
<style>
#header,
#content,
#footer {
  margin: 2rem auto;
  max-width: 46rem;
}

#header {
  margin-top: 0;
}

.title,
#toctitle {
  color: var(--dark-accent);
}

a {
  /* white-space: nowrap; */
}

img, iframe, video, audio {
  max-width: 100%;
}

p {
  font-weight: normal;
}

/* Taken out from book.css */
dl dt {
  margin-bottom: 0.3125em;
  font-weight: bold;
}
dl dd {
  margin-bottom: 1.25em;
}

dt,
th.tableblock,
td.content,
div.footnote {
  text-rendering: optimizeLegibility;
}

.literalblock pre,
.literalblock pre[class],
.listingblock pre,
.listingblock pre[class] {
  overflow: auto;
  word-wrap: break-word;
}
.literalblock pre.nowrap,
.literalblock pre[class].nowrap,
.listingblock pre.nowrap,
.listingblock pre[class].nowrap {
  overflow-x: auto;
  white-space: pre;
  word-wrap: normal;
}

.listingblock {
  margin: 0 0 2em;
}
.listingblock > .content {
  position: relative;
}
.listingblock > .title {
  font-weight: bold;
}
.listingblock code[data-lang]::before {
  display: none;
  content: attr(data-lang);
  position: absolute;
  font-size: 0.75em;
  top: 1em;
  right: 1em;
  line-height: 1;
  text-transform: uppercase;
  color: #999;
}
.listingblock:hover code[data-lang]::before {
  display: block;
}
.listingblock.terminal pre .command::before {
  content: attr(data-prompt);
  padding-right: 0.5em;
  color: #999;
}

td.hdlist1,
td.hdlist2 {
  vertical-align: top;
  padding-right: 0.625em;
}
td.hdlist1 {
  font-weight: bold;
}
.literalblock + .colist,
.listingblock + .colist {
  margin-top: -1.5em;
}
.colist td:not([class]):first-child {
  padding: 0.4em 0.75em 0 0.75em;
  line-height: 1;
  vertical-align: top;
}
.colist td:not([class]):first-child img {
  max-width: none;
}
.colist td:not([class]):last-child {
  padding: 0.25em 0;
}

/* Custom classes */

.line-through {
  text-decoration: line-through;
}

.RemarquePreTitre,
#toctitle {
  font-style: normal;
  font-weight: bold;
}
  .RemarquePreTitre::after {
    content: "•";
    padding-left: 5px;
  }
.admonitionblock {
}
.admonitionblock > table,
.exampleblock {
  --commented: rgba(17, 17, 68, .65);
  --border-radius-base: 8px;

  background-color: #fafafa;
  border: 1px solid var(--dark-shade);
  border-left: none;
  border-right: none;
  margin: 1.5em 0;
  padding: 1em;
}
.exampleblock .title {
  font-weight: bold;
}
.icon .title {
  font-size: 2em;
}
  .admonitionblock > table td.icon {
    display: none;
  }

  @media screen and (min-width: 769px) {
    .admonitionblock > table td.icon {
      display: table-cell;
    }
  }

  .admonitionblock > table td.icon {
    padding-right: 1em;
  }
  .admonitionblock > table td.icon img {
    max-width: none;
  }

.colist ol {
  margin-left: 1.5em;  /* aligns with the listing edge */
  padding-left: 0;
  font-weight: bold;   /* makes it stand out more */
}
  .colist ol p {
    margin: 0 0 .5em;
  }
.listingblock:not(.prismjs) pre,
.language-bash.hljs {
  background: #323232;
  color: wheat;
  margin: 0;
  padding: 1rem;
}
.language-bash.hljs .hljs-built_in,
.language-bash.hljs .hljs-builtin-name {
  color: white;
}
.language-bash.hljs .hljs-string {
  color: lightgreen;
}
.language-bash.hljs .hljs-variable {
  color: lightskyblue;
}
.keyseq {
  font-weight: normal;
  white-space: nowrap;
}
.language-bash.hljs .keyseq {
  color: white;
}
.language-bash.hljs kbd {
  background: transparent;
  box-shadow: none;
  color: white;
  font-size: 0.8em;
  font-weight: bold;
  padding: 0.1em 0.4em;
}
.listingblock pre.highlightjs,
.listingblock.prismjs pre {
  background-color: transparent;
  margin: 0;
  padding: 0;
}
.listingblock pre.highlightjs > code,
.listingblock.prismjs .highlight {
  border-left: 4px solid var(--dark-accent);
  padding-left: 1em;
  font-size: .8em;
}
.listingblock pre.highlightjs > code.language-bash {
  border-left-color: limegreen;
}

.hdlist .hdlist1 {
  text-align: right;
  white-space: nowrap;
}

td > p:first-child {
  margin-top: 0;
}

.hljs-comment {
  font-style: normal !important;
}

#toc.toc2 a {
  text-decoration: none;
  white-space: normal;
}
  #toc.toc2 a:hover,
  #toc.toc2 a:focus {
    text-decoration: underline;
  }

#toc.toc2 ul {
  list-style: none;
}

  #toc.toc2 > ul {
    padding-left: 0;
  }

  #toc.toc2 ul ul {
    padding-left: 1em;
  }

@media screen and (min-width: 769px) {
  body {
    padding-left: 25vw !important;
  }

  #header,
  #content,
  #footer {
    margin-left: 0;
  }

  #toc.toc2 {
    height: 100%;
    left: 0;
    max-width: 20vw;
    overflow: auto;
    padding: 1rem;
    position: fixed;
    top: 0;
    z-index: 1000;
  }

  #toc.toc2 > ul {
    font-size: 0.85em;
  }

  #toc li.active > a[href^="#"],
  [id]:target {
    background: #ffc;
  }
}

.admonitionblock.context-callout > table {
  border-width: 5px;
  border-color: var(--brand-color);
}

</style>
<link rel="stylesheet" href="https://oncletom.io/styles/blog.css?v=v3.3.2">
<!-- WebMentions -->
<link rel="pingback" href="https://webmention.io/oncletom.io/xmlrpc">
<link rel="webmention" href="https://webmention.io/oncletom.io/webmention">
<!-- Open Graph -->
<meta property="og:type" content="book">
<meta property="og:book:author" content="Thomas Parisot">
<meta property="og:book:isbn" content="978-2212139938">
<meta property="og:book:release_date" content="978-2212139938">
<meta property="og:book:tag" content="Node.js">
<meta property="og:book:tag" content="JavaScript">
<meta property="og:book:tag" content="npm">
<meta property="og:book:tag" content="Développement front-end">
<meta property="og:book:tag" content="Développement back-end">
<meta property="og:locale" content="fr_FR">
<meta property="og:site_name" content="Node.js • Apprendre par la pratique">
<!-- Twitter OpenGraph -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@oncletom">
<meta name="twitter:creator" content="@oncletom">
<style type="text/css" class="prism-theme">/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<style type="text/css" class="extension-interactive-runner">[data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
  background-color: #fcfcfc;
  border: 1px solid #0c2;
  border-radius: 1px;
  color: #0c2;
  cursor: pointer;
  display: inline-block;
  font-weight: bold;
  padding: .5em 1em;
  top: -2em;
}

  [lang="en"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "▶ run code";
  }
  [lang="fr"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "▶ voir le résultat";
  }
  .interactive--javascript code[data-label]:before {
    content: attr(data-label);
  }

.interactive iframe {
  position: absolute;
  visibility: hidden;
}

.interactive.status--loaded iframe {
  position: inherit;
  visibility: visible;
}

.interactive.status--loading {
  opacity: .5;
}
</style>
<script class="extension-interactive-runner">
(function(d){
  document.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://embed.runkit.com/';
    script.async = true;
    script.onload = function(){
      function makeListingInteractive (element){
  if (element.classList.contains('interactive--installed') || element.classList.contains('status--loading')) {
    return;
  }

  const code = element.querySelector('code');
  const nodeVersion = /interactive--runtime--node-([^\s]+)/.exec(element.className)[1];
  const isEndpoint = element.classList.contains('interactive--endpoint');
  const mode = isEndpoint ? 'endpoint' : null;
  let preamble = '';

  const source = code
    .textContent
    .replace(/\/\/\s*\(\d+\)$/gm, '')
    .replace(/^["']?use strict["'][; ]*\n/, '');

  if (isEndpoint) {
    preamble = `process.nextTick(() => {
      if (typeof module.exports === 'function') {
        exports.endpoint = module.exports;
      }
      else if (typeof server !== 'undefined') {
        exports.endpoint = server.listeners("request").pop();
      }
});`
  }

  element.classList.add('status--loading');

  // eslint-disable-next-line no-undef
  RunKit.createNotebook({
    nodeVersion,
    element,
    source,
    mode,
    preamble,
    onLoad: function(ntbk) {
      element.classList.add('interactive--installed');
      element.classList.remove('status--loading');
      element.classList.add('status--loaded');
      code.parentNode.setAttribute('hidden', true);

      ntbk.evaluate();
    }
  });
}
function installEvents () {
  function getParent(el, condition) {
    let parent = el;

    while(parent = parent.parentNode) {
      if (condition(parent)) {
        return parent;
      }
    }
  }

  function hasClass(className) {
    return function check(el) {
      return el.classList.contains(className);
    }
  }

  document.querySelector('body').addEventListener('click', function(el) {
    if (el.target.classList.contains('language-javascript') || el.target.classList.contains('language-js')) {
      const parentNode = getParent(
        el.target,
        hasClass('interactive--javascript')
      );

      makeListingInteractive(parentNode);
    }
  });
}
      installEvents();
      document.body.dataset.interactiveRuntime = 'loaded';
    };
    document.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
.listingblock [data-bash-subs]::before {
  content: attr(data-bash-subs) " ";
  opacity: .5; }

.listingblock [data-bash-conum]::before {
  content: "(" attr(data-bash-conum) ")";
  font-weight: bold;
  opacity: .7;
}</style>
<script>
(function(d){
  d.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://unpkg.com/menuspy@1.3.0/dist/menuspy.js';
    script.async = true;
    script.onload = () => new MenuSpy(document.querySelector('#toc'), {enableLocationHash: false});
    d.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
#toc li.active > a[href^="#"] {
  font-weight: bold;
}
#toc li.active > a[href^="#"]::before {
  content: "▶ ";
  display: inline-block;
  position: absolute;
  margin-left: -1.2em;
  font-size: .8em;
  margin-top: 3px;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Créer une application front-end</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table des matières</div>
<ul class="sectlevel1">
<li><a href="#quel_rapport_entre_node_et_les_navigateursweb">1. Quel rapport entre Node et les navigateurs&#160;web ?</a></li>
<li><a href="#écrire_dès_à_présent_le_code_dufutur">2. Écrire dès à présent le code du&#160;futur</a>
<ul class="sectlevel2">
<li><a href="#la_fin_de_lapproche_par_le_dénominateur_commun">2.1. La fin de l&#8217;approche par le dénominateur commun</a></li>
<li><a href="#transpilation">2.2. Écrire au plus proche des standards</a></li>
<li><a href="#polyfills">2.3. Combler les manques avec des polyfills</a></li>
</ul>
</li>
<li><a href="#modules">3. Importer des modules</a>
<ul class="sectlevel2">
<li><a href="#modules-script">3.1. La balise &lt;script&gt;</a></li>
<li><a href="#modules-es2015">3.2. Les modules ECMAScript</a></li>
<li><a href="#browserify">3.3. Importer des modules&#160;npm pour le&#160;Web</a></li>
<li><a href="#récapitulatif">3.4. Récapitulatif</a></li>
</ul>
</li>
<li><a href="#conception_modulaire">4. Conception modulaire</a>
<ul class="sectlevel2">
<li><a href="#le_syndrome_du_plug_in_jquery">4.1. Le syndrome du plug-in jQuery</a></li>
<li><a href="#vers_une_approche_jquery_composite">4.2. Vers une approche jQuery composite</a></li>
<li><a href="#partager_le_code_métier_avecnode">4.3. Partager le code métier avec&#160;Node</a></li>
<li><a href="#séparation_du_fond_et_de_la_forme_données_rendu_et_interactions">4.4. Séparation du fond et de la forme : données, rendu et interactions</a></li>
<li><a href="#react">4.5. Rapprocher données, rendu et interactions avec&#160;React</a></li>
</ul>
</li>
<li><a href="#io">5. Des requêtes Ajax vers du temps&#160;réel</a>
<ul class="sectlevel2">
<li><a href="#io-fetch">5.1. Échange ponctuel de données avec <code>fetch()</code></a></li>
<li><a href="#io-eventsource">5.2. Approche unidirectionnelle avec EventSource</a></li>
<li><a href="#io-websocket">5.3. Échanges en temps&#160;réel avec WebSocket</a></li>
</ul>
</li>
<li><a href="#développer_au_quotidien">6. Développer au quotidien</a>
<ul class="sectlevel2">
<li><a href="#watchify">6.1. Reconstruire en continu avec <code>watchify</code></a></li>
<li><a href="#livereload">6.2. Changements en temps&#160;réel dans le navigateur</a></li>
<li><a href="#node-sass">6.3. Modulariser ses feuilles de styles avec&#160;Sass</a></li>
<li><a href="#ui-bundling">6.4. Lier composants visuels et feuilles de&#160;styles</a></li>
<li><a href="#optimiser_ses_ressources_graphiques">6.5. Optimiser ses ressources graphiques</a></li>
</ul>
</li>
<li><a href="#testing">7. Tester son code</a>
<ul class="sectlevel2">
<li><a href="#testing-101">7.1. Que tester ?</a></li>
<li><a href="#soutiller_pour_écrire_des_assertions">7.2. S&#8217;outiller pour écrire des assertions</a></li>
<li><a href="#tester_ses_composants_react_sans_navigateur">7.3. Tester ses composants React sans navigateur</a></li>
<li><a href="#tester_code_et_composants_dans_les_navigateurs">7.4. Tester code et composants dans les navigateurs</a></li>
<li><a href="#ci">7.5. Intégration continue et compatibilité navigateurs</a></li>
</ul>
</li>
<li><a href="#conclusion">8. Conclusion</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock tip context-callout">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="paragraph">
<p>Vous êtes en train de lire le
<a href="https://oncletom.io/node.js/">livre &#8220;Node.js&#8221;</a>, écrit par
<a href="https://oncletom.io">Thomas Parisot</a> et publié par les
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">Éditions Eyrolles</a>.</p>
</div>
<div class="paragraph">
<p>Il vous plaît&#160;? Achetez-le en ligne sur
<a href="https://amzn.to/2E58PEw">Amazon</a>,
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">Eyrolles</a> ou
<a href="https://www.placedeslibraires.fr/livre/9782212139938">Place des Libraires</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Node et l&#8217;écosystème&#160;<code>npm</code> sont devenus des acteurs majeurs de l&#8217;outillage
web <em>front-end</em> alors profitons-en pour partager du code entre client et serveur.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Sommaire</div>
<ul>
<li>
<p>Polyfills et compatibilité ECMAScript</p>
</li>
<li>
<p>Importer des modules&#160;<code>npm</code> pour le&#160;Web</p>
</li>
<li>
<p>Créer du code modulaire, avec ou sans framework</p>
</li>
<li>
<p>Échanges de données en temps&#160;réel</p>
</li>
<li>
<p>Outillage utile au quotidien</p>
</li>
<li>
<p>Tester son code et la compatibilité avec les navigateurs web</p>
</li>
</ul>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Avant l&#8217;apparition de Node, rare était l&#8217;outillage n&#8217;imposant pas une ou
plusieurs plates-formes de développement&#160;: <em>YUICompressor</em> et <em>Google Closure Compiler</em>
demandaient Java, <em>sprockets</em> demandait Ruby et <em>pngquant</em> reposait sur des
dépendances système comme <em>libpng</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;existence de Node et du registre <code>npm</code> a favorisé le développement d&#8217;un
écosystème orienté <em>front-end</em> plus simple à appréhender.
Cela s&#8217;étend de la découverte au téléchargement des bibliothèques tierces ainsi
qu&#8217;à la compilation, l&#8217;optimisation et l&#8217;exécution des tests des applications
web côté client.</p>
</div>
<div class="paragraph">
<p><strong>Cet écosystème rend l&#8217;écriture de code moderne normale</strong>&#160;; un code anticipant
les futurs standards d&#8217;ECMAScript et <em>HTML5</em>, sur les navigateurs actuels et anciens.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Versions de Node et npm</div>
<div class="paragraph">
<p>Le contenu de ce chapitre utilise les versions <strong>Node&#160;v10</strong>
et <strong>npm&#160;v6</strong>.
Ce sont les versions stables recommandées en&#160;2019.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quel_rapport_entre_node_et_les_navigateursweb">1. Quel rapport entre Node et les navigateurs&#160;web ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce chapitre peut sembler confus au premier abord.
Si Node s&#8217;exécute au niveau du système d&#8217;exploitation&#160;– &#8220;côté serveur&#8221;&#160;–,
en quoi est-il lié au développement <em>front-end</em>&#160;– &#8220;côté client&#8221;&#160;?
Est-ce parce que du code écrit pour Node peut aussi fonctionner dans un navigateur&#160;web&#160;?
Quid de l&#8217;utilisation de <code>require('fs')</code> pour accéder au système de fichiers&#160;?</p>
</div>
<div class="paragraph">
<p>La réponse courte est&#160;: nous n&#8217;exécutons pas Node dans un navigateur.</p>
</div>
<div class="paragraph">
<p>Et voici la réponse longue&#160;: <strong>Node est utilisé pour assembler du code</strong>, le <em>transformer</em>
et le rendre fonctionnel dans une paire de balises <code>&lt;script&gt;&lt;/script&gt;</code>.
Ce code peut aussi aussi bien être fourni par des bibliothèques tierces
installées via&#160;<code>npm</code> (<em>jQuery</em>, <em>React</em> ou <em>d3</em> par exemple) que par de
l&#8217;outillage (optimiseurs, suite de tests, orchestration de tâches) ou encore
par le code réutilisable de notre propre application&#160;web.</p>
</div>
<div class="paragraph">
<p>Il faut également bien comprendre qu&#8217;il y a plusieurs &#8220;problèmes&#8221; cachés sous
une même question&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les navigateurs et Node utilisent différentes machines virtuelles JavaScript,
implémentant ECMAScript de façon plus ou moins complète.</p>
</li>
<li>
<p>Ils n&#8217;ont pas accès aux mêmes APIs&#160;– Node accède à <code>fs</code> et <code>http</code> tandis que
les navigateurs ont <code>File</code> et <code>fetch</code>/<code>XmlHttpRequest</code>.</p>
</li>
<li>
<p>Ils ne gèrent pas le chargement de modules de la même manière
(voir la section &#8220;<a href="#managing-dependencies">Dépendences de développement</a>&#8221;).</p>
</li>
<li>
<p>L&#8217;implémentation même d&#8217;ECMAScript diffère selon les versions de Node
employées&#160;– un navigateur moderne et Node&#160;v10 comprennent
l&#8217;objet natif <code>Promise</code>, mais pas Node&#160;0.12.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce processus n&#8217;est <em>pas magique</em> et nous verrons graduellement au cours des
prochaines sections comment tout ceci fonctionne.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Jouer avec les exemples dans un terminal</div>
<div class="paragraph">
<p>Les exemples titrés d&#8217;un nom de fichier peuvent être installés sur votre ordinateur.
Exécutez-les dans un terminal et amusez-vous à les modifier en parallèle de
votre lecture pour voir ce qui change.</p>
</div>
<div class="listingblock">
<div class="title">Installation des exemples via le module npm <code>nodebook</code></div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm install --global nodebook
<span data-bash-subs="$"></span>nodebook install chapter-09
<span data-bash-subs="$"></span>cd $(nodebook dir chapter-09)</pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante devrait afficher un résultat qui confirme que vous êtes
au bon endroit&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node hello.js</pre>
</div>
</div>
<div class="paragraph">
<p>Suivez à nouveau les instructions d&#8217;installation pour rétablir les exemples
dans leur état initial.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="écrire_dès_à_présent_le_code_dufutur">2. Écrire dès à présent le code du&#160;futur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transformer du code ECMAScript a pendant longtemps été chose pénible.
Je pense par exemple à de la minification de code (pour réduire les temps de
transfert sur les antiques lignes ADSL&#160;128&#160;K) ou à de la conversion automatique
de code ECMAScript&#160;3 en ECMAScript&#160;5.
Cela nécessitait systématiquement l&#8217;utilisation d&#8217;un autre environnement
qu&#8217;ECMAScript lui-même: Rhino nécessitait Java, Spidermonkey nécessitait&#160;C&#43;&#43;
et Trident nécessitait un environnement Windows en plus de&#160;C&#43;&#43;.</p>
</div>
<div class="paragraph">
<p><em>esprima</em> (<span class="URL"><a href="https://npmjs.com/esprima" class="bare">npmjs.com/esprima</a></span>) chamboule les règles du jeu en
décembre 2011&#160;: ce parseur ECMAScript&#160;– lui-même écrit en ECMAScript&#160;–
exporte une compréhension de code sous forme d&#8217;arbre syntaxique abstrait
(<em>Abstract Syntax Tree</em>, <em>AST</em>).
Cet arbre est lui-même analysable par de nouveaux outils&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les <em>source maps</em> pour associer le code transformé au code d&#8217;origine,
notamment dans les outils de développement des navigateurs&#160;;</p>
</li>
<li>
<p>des minifieurs plus efficaces et ayant connaissance des portions de code exécutées&#160;;</p>
</li>
<li>
<p>des analyseurs de code pour informer le développeur d&#8217;erreurs de syntaxe,
de non-respect de styles de développement, etc.&#160;;</p>
</li>
<li>
<p>des convertisseurs de code pour passer d&#8217;ECMAScript vers CoffeeScript,
de modules CommonJS vers des modules ECMAScript, etc.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Annonce d&#8217;esprima</div>
<div class="paragraph">
<p>Aryia&#160;Hidayat présente esprima dans ce billet de blog&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://ariya.io/2011/12/introducing-esprima" class="bare">ariya.io/2011/12/introducing-esprima</a></span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il y présente notamment des comparatifs de performances d&#8217;exécution sur
différentes machines virtuelles ECMAScript et face à d&#8217;autres parseurs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="la_fin_de_lapproche_par_le_dénominateur_commun">2.1. La fin de l&#8217;approche par le dénominateur commun</h3>
<div class="paragraph">
<p>Qui n&#8217;a pas déjà entamé un projet en posant la question à un client, en regardant
les statistiques de trafic ou en se posant une question à soi-même&#160;: quelles
sont les versions de navigateurs avec lesquelles notre site ou application web
doit être compatible&#160;?</p>
</div>
<div class="paragraph">
<p>La version de navigateur la plus ancienne ou la moins conforme aux standards
était celle qui donnait le&#160;<em>la</em>.
Cela voulait dire se priver de techniques modernes, standardisées ou en cours
de standardisation.
Cela signifiait des <em>hacks</em> dans ses CSS, dans son code ECMAScript et dans
ses ressources graphiques.</p>
</div>
</div>
<div class="sect2">
<h3 id="transpilation">2.2. Écrire au plus proche des standards</h3>
<div class="paragraph">
<p>Fort heureusement, l&#8217;arrivée d'<em>esprima</em> change la donne et permet d&#8217;écrire un
code proche des standards qui résiste au temps.
Son existence facilite l'<strong>émergence d&#8217;outils automatisant les transformations de code</strong>
pour satisfaire nos besoins spécifiques.</p>
</div>
<div class="paragraph">
<p>Il y a plusieurs éléments à prendre en compte concernant la standardisation
de nouvelles versions d&#8217;ECMAScript et les évolutions de sa syntaxe&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La cadence de standardisation a été revue pour devenir prédictible&#160;– une
volonté d&#8217;une fois par&#160;an.</p>
</li>
<li>
<p>Les fonctionnalités et éléments de syntaxe sont implémentés un par un, à des
vitesses différentes par les différents navigateurs.</p>
</li>
<li>
<p>Deux tiers de navigateurs fonctionnent sur des rythmes de mise à jour en cycle court
(de six à neuf semaines)&#160;– le tiers restant est cadencé à une seule mise à
jour par&#160;an.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il vaut mieux <strong>parier sur les standards comme stratégie à long terme</strong> si on tient
compte du temps de développement et du temps de maintenance d&#8217;une base de&#160;code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Question</span> Standards, quels standards ?</div>
<div class="paragraph">
<p>Plusieurs organismes prennent part à la standardisation de langages et
d&#8217;API lorsque l&#8217;on touche aux navigateurs&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HTML&#160;: <em>WHATWG</em> (<span class="URL"><a href="https://html.spec.whatwg.org" class="bare">html.spec.whatwg.org</a></span>)&#160;;</p>
</li>
<li>
<p>API&#160;DOM&#160;: <em>WHATWG</em> (<span class="URL"><a href="https://dom.spec.whatwg.org" class="bare">dom.spec.whatwg.org</a></span>)&#160;;</p>
</li>
<li>
<p>CSS&#160;: <em>W3C</em> (<span class="URL"><a href="https://www.w3.org/standards/techs/css" class="bare">www.w3.org/standards/techs/css</a></span>)&#160;;</p>
</li>
<li>
<p>ECMAScript&#160;: <em>TC39</em> (<span class="URL"><a href="https://github.com/tc39" class="bare">github.com/tc39</a></span>)&#160;;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lorsque nous écrivons du code, nous pouvons rencontrer trois cas de figure&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>élément de syntaxe non&#160;implémenté&#160;: transformer le code pour l&#8217;adapter aux
navigateurs cibles&#160;;</p>
</li>
<li>
<p>élément de syntaxe partiellement implémenté&#160;: utiliser l&#8217;implémentation native
des navigateurs et, à défaut, transformer le code pour l&#8217;adapter aux autres navigateurs&#160;;</p>
</li>
<li>
<p>élément de syntaxe totalement implémenté&#160;: utiliser l&#8217;implémentation native des navigateurs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il arrive que certains éléments de syntaxe soient abandonnés pendant le
processus de standardisation&#160;– ou que leur implémentation change beaucoup
(on pensera à <code>Object.observe()</code>).</p>
</div>
<div class="paragraph">
<p>La question qui nous taraude est&#160;: comment transformer le code pour satisfaire
à la fois les navigateurs compatibles et les autres&#160;?
<em>Babel</em> (<span class="URL"><a href="https://babeljs.io" class="bare">babeljs.io</a></span>) est un outil de choix  pour parvenir à ses
fins d&#8217;écrire du code résistant au(x standards du) temps.</p>
</div>
<div class="paragraph">
<p>Ce module convertit de manière sélective toute syntaxe ECMAScript&#160;2015/2016/etc.
vers de l&#8217;ECMAScript&#160;5, compréhensible par les navigateurs modernes.
L&#8217;intérêt de sa sélectivité fait que l&#8217;on peut progressivement arrêter de
convertir les éléments de syntaxe couverts par 100&#160;% des navigateurs.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Histoire</span> Traceur</div>
<div class="paragraph">
<p><em>Traceur</em> est un des premiers transpilateurs ECMAScript&#160;2015 vers
ECMAScript&#160;5 à avoir émergé dans l&#8217;écosystème&#160;Node.</p>
</div>
<div class="paragraph">
<p>Grâce à lui, il a été possible d&#8217;écrire des modules en ECMAScript&#160;2015
bien avant que la spécification ne soit entièrement terminée et donc on a pu
anticiper son apprentissage tout en mettant le langage à l&#8217;épreuve avant sa finalisation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre un code utilisant des éléments de syntaxe
d&#8217;ECMAScript&#160;2018.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">babel/es2018.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>one<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> two<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>three<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> four<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span>a<span class="token punctuation">,</span> <span class="token operator">...</span>b<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>{ one: 1, two: 2, three: 3, four: 4 }</code> si le navigateur supporte l&#8217;opérateur <em>spread</em> sur les objets (<a href="../chapter-03/index.html#object.assign">chapitre&#160;3</a>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce code représente l&#8217;idéal de ce que l&#8217;on souhaite écrire.
Le seul obstacle consiste à traduire ce code pour l&#8217;ensemble des navigateurs
compatibles avec ECMAScript&#160;5.</p>
</div>
<div class="paragraph">
<p>Exécutons cette commande&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>npm run babel -- examples/babel/es2018.js</pre>
</div>
</div>
<div class="paragraph">
<p>La sortie a changé et renvoie un code totalement fonctionnel sur des navigateurs
ne prenant pas ECMAScript&#160;2018 en charge&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">babel/es2018-es5.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">"use strict"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> source <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">var</span> ownKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Object<span class="token punctuation">.</span>getOwnPropertySymbols <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> ownKeys <span class="token operator">=</span> ownKeys<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sym</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> sym<span class="token punctuation">)</span><span class="token punctuation">.</span>enumerable<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> ownKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> target<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> value<span class="token punctuation">,</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>one<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> two<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>three<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> four<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque fonctionnalité d&#8217;ECMAScript est transformée selon une règle personnalisable,
intégrée à <em>Babel</em> ou disponible sous forme d&#8217;un plug-in.
Les <em>presets</em> sont des modules&#160;<code>npm</code> qui regroupent les règles
de transformation selon un certaine logique.</p>
</div>
<div class="paragraph">
<p><em>preset-env</em> <span class="URL"><a href="https://npmjs.com/babel-preset-env" class="bare">npmjs.com/babel-preset-env</a></span> convertit
notre code dans une version compatible avec la majorité des navigateurs
supportés sur le marché.
Si vos besoins sont différents, sa configuration sait cibler des navigateurs
en fonction soit de leur version, soit de leur part de marché.</p>
</div>
<div class="paragraph">
<p>La configuration des presets et d&#8217;autres aspects de Babel se fait
dans un fichier nommé <code>.babelrc</code>.
L&#8217;exemple suivant configure Babel pour préserver les commentaires,
transformer la syntaxe JSX pour <a href="#react"><em>React</em></a> et transformer pour les
dernières versions des navigateurs sur le marché&#160;:</p>
</div>
<div class="listingblock">
<div class="title">.babelrc</div>
<div class="content">
<pre>{
  "comments": false,
  "presets": [
    "@babel/preset-react",
    "@babel/preset-env"
  ],
  "plugins": [
    "@babel/plugin-proposal-object-rest-spread"
  ]
}</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Documentation de Babel</div>
<div class="paragraph">
<p>Toutes les options de configuration sont documentées sur le site officiel
de Babel&#160;: <span class="URL"><a href="https://babeljs.io/docs/en/babel-core/#options" class="bare">babeljs.io/docs/en/babel-core/#options</a></span>.</p>
</div>
<div class="paragraph">
<p>Une autre page explique où placer et quoi mettre dans les fichiers
<code>.babelrc</code>&#160;: <span class="URL"><a href="https://babeljs.io/docs/en/config-files/" class="bare">babeljs.io/docs/en/config-files/</a></span>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="polyfills">2.3. Combler les manques avec des polyfills</h3>
<div class="paragraph">
<p>Des outils comme Babel nous permettent d&#8217;écrire avec une syntaxe moderne qui
<strong>comblent les fonctionnalités manquantes</strong>&#160;– leur implémentation.</p>
</div>
<div class="paragraph">
<p>Un <em>polyfill</em> harmonise la présence d&#8217;une fonctionnalité au sein d&#8217;une variété de
navigateurs et d&#8217;environnements ECMAScript.
Cela se fera au prix de quelques kilo-octets de code à charger en plus
dans nos applications.
L&#8217;appel à un service de <em>polyfill</em> externe entraîne un léger ralentissement du
chargement de notre&#160;page.</p>
</div>
<div class="paragraph">
<p>Prenons le bloc de code suivant&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprenons que&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cette syntaxe est valide dans toutes les versions d&#8217;ECMAScript
(Babel ne change rien à ce code).</p>
</li>
<li>
<p>L&#8217;objet global <code>Promise</code> existe dans un navigateur moderne.</p>
</li>
<li>
<p>L&#8217;objet global <code>Promise</code> n&#8217;existe pas dans <em>Internet Explorer 11</em>, entre autres.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce code fonctionnerait donc sur un navigateur moderne mais pas dans <em>IE11</em>.
L&#8217;inclusion d&#8217;un <em>polyfill</em> de <code>Promise</code> résoudrait le problème.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Bonne pratique</span> Quand inclure les polyfills ?</div>
<div class="paragraph">
<p><strong>Un <em>polyfill</em> se charge toujours en premier</strong>.
On inclut tous les <em>polyfills</em> en une seule fois avant notre propre code.</p>
</div>
<div class="paragraph">
<p>Nous garantissons ainsi cohérence et stabilité de comportement au sein de
notre application, peu importe l&#8217;ordre d&#8217;exécution de nos scripts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Parlons maintenant des méthodes d&#8217;inclusion des <em>polyfills</em> pour mieux
comprendre comment procéder.</p>
</div>
<div class="paragraph">
<p>Le service <em>polyfill.io</em> est de loin la méthode la plus simple à utiliser.
Il suffit d&#8217;inclure un script dans toutes vos pages web et cet outil
détermine les <em>polyfills</em> à charger en fonction de la
compatibilité du navigateur&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">polyfill.io.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Example polyfill.io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.polyfill.io/v2/polyfill.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> polyfill.io</div>
<div class="paragraph">
<p>polyfill.io possède une documentation très complète qui aide à configurer
finement le service en fonction de nos besoins&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://qa.polyfill.io/v2/docs/" class="bare">qa.polyfill.io/v2/docs/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous pouvons déduire deux règles de cet exemple&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inclure les <em>polyfills</em> en tout premier.</p>
</li>
<li>
<p>Les inclure en dehors de notre code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La deuxième méthode est d&#8217;embarquer les <em>polyfills</em> dans notre base de code.
L&#8217;avantage est de maîtriser notre base de code et de ne pas dépendre d&#8217;un service externe.
L&#8217;inconvénient est que nous chargeons du code qui sera inutile dans les
navigateurs et environnements disposant déjà de ces fonctionnalités.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">polyfill-import.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Exemple polyfill custom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">import</span> <span class="token string">'es6-promise/auto'</span><span class="token punctuation">;</span>        <span class="token comment">// <b class="conum">(1)</b></span>
      <span class="token keyword">import</span> <span class="token string">'core-js/fn/number/is-nan'</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(2)</b></span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous verrons <a href="#modules">comment importer des modules</a> ci-après.</p>
</li>
<li>
<p>On importe un deuxième <em>polyfill</em>, celui de la méthode <code>Number.isNaN</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le module <em>npm</em> <code>core-js</code> est une bibliothèque exhaustive de <em>polyfills</em>
pouvant être inclus un à un ou par versions d&#8217;ECMAScript.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> core-js</div>
<div class="paragraph">
<p>La documentation en ligne de <code>core-js</code> liste l&#8217;ensemble des <em>polyfills</em>
pris en charge, ainsi que des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/core-js" class="bare">npmjs.com/core-js</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">⚠️</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Performance et duplication</div>
<div class="paragraph">
<p>Il faut veiller à ne pas alourdir inutilement une application.</p>
</div>
<div class="paragraph">
<p>Laissons la responsabilité de <em>polyfiller</em> aux utilisateurs de notre code&#160;;
particulièrement si celui-ci est redistribué en tant que module&#160;<code>npm</code> public.</p>
</div>
<div class="paragraph">
<p>Si plusieurs scripts nécessitent des <em>polyfills</em>, mieux vaut inclure ces
derniers en une&#160;fois&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>polyfills.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-a.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-b.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enfin, une dernière méthode est d&#8217;importer la fonction de <em>polyfill</em> sans
réécrire les objets globaux.
Cette pratique a l&#8217;avantage de ne pas entraîner d&#8217;effets secondaires et de
garantir le même comportement dans tous les navigateurs.
L&#8217;inconvénient est qu&#8217;on n&#8217;utilise pas la fonctionnalité native des navigateurs
lorsqu&#8217;elle est présente.
Nous nous retrouvons tributaires de la qualité d&#8217;implémentation du <em>polyfill</em>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">polyfill-require.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>Promise <span class="token keyword">as</span> PromisePolyfill<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'es6-promise'</span><span class="token punctuation">;</span>

PromisePolyfill<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>PromisePolyfill <span class="token operator">===</span> window<span class="token punctuation">.</span>Promise<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>true</code> si le navigateur implémente l&#8217;API <em>Promise</em>&#160;– sinon affiche <code>false</code> et l&#8217;utilisation d&#8217;un <em>polyfill</em> prend tout son&#160;sens.</p>
</li>
<li>
<p>Affiche <code>false</code>, car le <em>polyfill</em> de <em>Promise</em> est une fonction strictement différente de <code>window.Promise</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Bonnes pratiques constatées</div>
<div class="paragraph">
<p>De bons usages des <em>polyfills</em> ainsi que les risques liés à leur utilisation
sont compilés dans un guide édité par le&#160;W3C&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://w3ctag.github.io/polyfills/" class="bare">w3ctag.github.io/polyfills/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modules">3. Importer des modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Importer des modules est une pratique courante avec Node.
Elle l&#8217;est en revanche beaucoup moins dans l&#8217;univers du Web puisqu&#8217;il n&#8217;existait
rien de natif avant les <a href="#modules-es2015">modules ECMAScript</a>.</p>
</div>
<div class="paragraph">
<p>Auparavant, on aura vu débarquer les modules AMD (<em>Asynchronous Module Definition</em>)
pour gérer les dépendances entre scripts.
Les bibliothèques Dojo, RequireJS et YUI ont popularisé ce motif de conception.
Un désir d&#8217;universalité a ensuite émergé avec la popularité croissante de Node,
conduisant aux modules&#160;UMD, conciliant AMD et CommonJS.</p>
</div>
<div class="paragraph">
<p>Les modules ECMAScript ont émergé de ce bouillonnement.</p>
</div>
<div class="sect2">
<h3 id="modules-script">3.1. La balise &lt;script&gt;</h3>
<div class="paragraph">
<p>Rappelons-le, la méthode incontournable pour charger du code dans un navigateur
est l&#8217;utilisation de la base <code>&lt;script&gt;</code>.
Le chargement, l&#8217;évaluation et l&#8217;exécution du script bloquent le temps
nécessaire au rendu d&#8217;un document&#160;HTML.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/script.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>global-dom-log.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les différents scripts partagent le même espace mémoire, permettant ainsi à
<code>script.js</code> d&#8217;avoir accès à la fonction <code>log</code> définie dans <code>global-dom-log.js</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/global-dom-log.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#logs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/script.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">/* global log */</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'KO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche une erreur car <code>&lt;div id="logs"&gt;</code> n&#8217;existe pas encore dans le document
à ce stade de l&#8217;exécution.</p>
</li>
<li>
<p>Cette ligne est exécutée une fois le document chargé&#160;– <code>&lt;div id="logs"&gt;</code>
contient désormais le texte&#160;<code>OK</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>S&#8217;il est facile d&#8217;ajouter du code dans le navigateur, on constate plusieurs problèmes&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Partager du code entre scripts repose sur une attente explicite.</p>
</li>
<li>
<p>Le partage de variables entre scripts risque d&#8217;entraîner des collisions
(par exemple, deux variables du même nom définies dans des scripts différents).</p>
</li>
<li>
<p>Il n&#8217;y a pas de moyen évident de rendre des parties de code privées au sein de
chaque script.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le développement <em>front-end</em> basé sur de l&#8217;outillage Node va justement nous aider
à <strong>solidifier et renforcer la réutilisabilité de notre&#160;code</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="modules-es2015">3.2. Les modules ECMAScript</h3>
<div class="paragraph">
<p>Nous avons évoqué les <a href="../chapter-03/index.html#primitives">primitives ECMAScript&#160;2015</a> dans le chapitre&#160;3.
Les modules font partie des fonctionnalités tant attendues.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/module-import.png" alt="module import" width="85%">
</div>
<div class="title">Figure 1. Utilisation des modules ECMAScript dans un navigateur web (ici, Safari pour macOS)</div>
</div>
<div class="paragraph">
<p>L&#8217;attribut <code>type="module"</code> sert à maintenir une compatibilité entre les scripts
classiques et les modules ECMAScript.
Ce mécanisme s&#8217;appuie sur plusieurs concepts importants&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Toute variable est privée sauf si elle est exportée avec l&#8217;opérateur <code>export</code>.</p>
</li>
<li>
<p>Les modules sont explicitement inclus avec l&#8217;opérateur <code>import</code>.</p>
</li>
<li>
<p>Les variables globales définies par l&#8217;utilisateur ne sont pas accessibles depuis un module.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Retravaillons le document HTML de la section précédente&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/import.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token keyword">const</span> pro <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-import.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous voulons maintenant (sa)voir si la variable&#160;<code>pro</code> définie avant l&#8217;inclusion
du module <code>script-import.js</code> est accessible.
Nous voulons également savoir si la syntaxe d&#8217;import de la fonction&#160;<code>log</code> fonctionne&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/script-import.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>log<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dom-log.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> pro<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>undefined</code>.</p>
</li>
<li>
<p>Affiche <code>function</code>.</p>
</li>
<li>
<p>Affiche <code>object</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>De même que nous avons utilisé <code>import</code> pour importer de manière sélective une
fonction du module <code>dom-log.js</code>, l&#8217;opérateur <code>export</code> nous aide à exposer des
objets, fonctions et variables&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/dom-log.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> target <span class="token operator">=</span> <span class="token string">'#logs'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="browserify">3.3. Importer des modules&#160;npm pour le&#160;Web</h3>
<div class="paragraph">
<p>Qu&#8217;en est-il alors des modules&#160;<code>npm</code>&#160;?
Nous pouvons transpiler et importer du code.
Ce serait très utile si nous pouvions également importer du code tiers.
Cela nous éviterait de réinventer la roue, nous donnerait accès à du code bien testé
et trop coûteux à écrire nous-mêmes.</p>
</div>
<div class="paragraph">
<p>Nous avons vu comment <a href="../chapter-05/index.html#modules">charger des modules&#160;<code>npm</code></a>
dans le chapitre 5.
Intéressons-nous à leur utilisation dans le contexte d&#8217;une application <em>front-end</em>.
Pour cela, adaptons l&#8217;exemple de la section précédente&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/script-import-jquery.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>jquery<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#logs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>$.fn.jquery</code> contient le numéro de version de jQuery.</p>
</li>
<li>
<p>Substitut jQuery pour remplacer le texte dans <code>&lt;div id="logs"&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le document HTML chargeant ce module est en tout point similaire au précédent exemple&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/import-jquery.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-import-jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le seul hic, c&#8217;est que <strong>cela ne fonctionne pas</strong>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Le navigateur ne peut pas savoir où se trouve la dépendance demandée.</p>
</li>
<li>
<p>Rien ne garantit que <code>jquery</code> expose son code en tant que module ECMAScript.</p>
</li>
<li>
<p>On n&#8217;a certainement pas envie d&#8217;exposer publiquement le répertoire <code>node_modules</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est alors qu&#8217;entre en jeu <em>Browserify</em>.
Il s&#8217;agit d&#8217;un outil générique de transformation de code.
Il peut être utilisé en ligne de commandes, via son API Node, mais aussi par
le biais de plug-in pour d&#8217;autres outils (comme Gulp ou Grunt).</p>
</div>
<div class="paragraph">
<p><em>Browserify</em> a été initialement créé pour transformer du code écrit pour Node en
code fonctionnel dans les navigateurs.
Il expose notamment un concept d&#8217;intégrations (les <em>transforms</em>) afin d&#8217;effectuer
des remplacements ligne à ligne.</p>
</div>
<div class="paragraph">
<p>Là où <em>Babel</em> cherche uniquement à traduire un langage vers un autre,
<em>Browserify</em> est le couteau suisse pour effectuer des remplacements majeurs dans le code&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>portage de la fonction <code>require()</code> et inclusion du code des modules sous-jacents&#160;;</p>
</li>
<li>
<p>suppression de code conditionnel&#160;;</p>
</li>
<li>
<p>remplacement d&#8217;API spécifiques à Node par des <em>polyfills</em> pour le&#160;Web&#160;;</p>
</li>
<li>
<p>extraction de&#160;CSS&#160;;</p>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Browserify</em> est intéressant au sens où il nous apprend à nous constituer
notre outillage, pour nos propres besoins.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Utiliser Browserify</div>
<div class="paragraph">
<p><em>Browserify</em> (<span class="URL"><a href="https://npmjs.com/browserify" class="bare">npmjs.com/browserify</a></span>) est un outil extrêmement
adaptable, modulaire et puissant.
Son apprentissage progressif peut faire de lui un allié de choix dans tous
vos projets Node et&#160;Web.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://github.com/substack/browserify-handbook" class="bare">github.com/substack/browserify-handbook</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Revenons maintenant à notre code auquel il manque la compréhension des
modules&#160;<code>npm</code>.
Nous allons maintenant chercher à transformer le fichier <code>script-import-jquery.js</code>,
non seulement pour rendre la syntaxe <code>import</code> intelligible
(c&#8217;est le <a href="#transpilation">rôle de Babel</a>), mais aussi pour faire le
lien avec les modules&#160;<code>npm</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>npm run browserify -- \
  -t babelify \
  -e examples/import/script-import-jquery.js \
  -o examples/import/script-import-jquery-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande exécute trois choses&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-t babelify</code> indique d&#8217;utiliser une intégration Babel (un <em>transform</em>) pour
transformer la syntaxe ECMAScript&#160;2015.</p>
</li>
<li>
<p><code>-e &#8230;&#8203;</code> indique le script d&#8217;entrée à transformer.</p>
</li>
<li>
<p><code>-o &#8230;&#8203;</code> indique où stocker le script transformé.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il en résultera un fichier nommé <code>script-import-jquery-browserify.js</code> compatible
ECMAScript&#160;5 et qui inclut désormais le code source de jQuery.</p>
</div>
<div class="paragraph">
<p>Il ne nous reste plus qu&#8217;à charger le fichier transformé dans notre page web pour
voir le résultat&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/import-jquery-browserify.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-import-jquery-browserify.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="récapitulatif">3.4. Récapitulatif</h3>
<div class="paragraph">
<p>En résumé, nous avons besoin de nous baser sur deux ou trois outils pour écrire
un code modulaire et compatible avec n&#8217;importe quel type de syntaxe&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Babel pour transformer la syntaxe&#160;;</p>
</li>
<li>
<p>des <em>polyfills</em> pour harmoniser les fonctionnalités&#160;;</p>
</li>
<li>
<p><em>browserify</em> pour l&#8217;intégration avec les modules&#160;<code>npm</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ceux-ci ont l&#8217;avantage d&#8217;être faciles à prendre en main, modulaires et évolutifs.
Nous pourrons aussi nous tourner vers d&#8217;autres outils de transformation de code
pour explorer d&#8217;autres horizons&#160;– et il en existe énormément&#160;: webpack, rollup,
broccoli, etc.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conception_modulaire">4. Conception modulaire</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un autre paradigme change avec la mise à disposition des modules et de
l&#8217;outillage&#160;: le code que l&#8217;on écrit dépend surtout d&#8217;ECMAScript et de
l&#8217;environnement dans lequel on l&#8217;exécute, à savoir Node ou un navigateur.</p>
</div>
<div class="paragraph">
<p>La section suivante s&#8217;intéresse à l&#8217;évolution de l&#8217;écriture du code, autrefois
dirigée par la structure du document HTML, vers un monde de
fonctions consommant des données, transformées pour un type d&#8217;affichage, que ce
soit HTML ou autre.</p>
</div>
<div class="paragraph">
<p>Nous illustrerons cette évolution au travers d&#8217;un exemple relativement simple&#160;:
une balise HTML affichant l&#8217;heure dont nous actualisons le contenu toutes les secondes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/modules-time.png" alt="modules time" width="85%">
</div>
<div class="title">Figure 2. Résultat de l&#8217;exemple développé dans les sections suivantes</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>jQuery</em></div>
<div class="paragraph">
<p>Les exemples suivants se basent sur l&#8217;utilisation de la bibliothèque <em>jQuery</em>
(<span class="URL"><a href="https://api.jquery.com" class="bare">api.jquery.com</a></span>).</p>
</div>
<div class="paragraph">
<p>Elle facilite la manipulation du DOM tout en gérant les incompatibilités des
différents navigateurs.
Son utilisation est devenue moins dominante du fait d&#8217;une nette amélioration de
la qualité de ces derniers.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://learn.jquery.com/using-jquery-core/" class="bare">learn.jquery.com/using-jquery-core/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="le_syndrome_du_plug_in_jquery">4.1. Le syndrome du plug-in jQuery</h3>
<div class="paragraph">
<p>Ce que j&#8217;appelle le &#8220;syndrome du plug-in <em>jQuery</em>&#8221;, c&#8217;est une combinaison
des éléments suivants&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>création de code métier inutilisable en dehors de <em>jQuery</em>&#160;;</p>
</li>
<li>
<p>mélange de la présentation des données et de l&#8217;organisation du code métier&#160;;</p>
</li>
<li>
<p>un code aveugle car éloigné de la structure HTML nécessaire à son fonctionnement&#160;;</p>
</li>
<li>
<p>fragilité du code en cas de changement de la structure HTML associée&#160;;</p>
</li>
<li>
<p>en général, un code difficilement testable&#160;– difficile de ne pas aboutir à une interface boguée.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voici un exemple de document HTML fragile et mélangeant tous les concepts en même temps.
Il est parfaitement valide, mais illustre un ensemble de pratiques courantes que
nous allons chercher à déconstruire.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/jquery-plugin.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time</span> <span class="token attr-name">datetime</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">data-interval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>---<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>../../node_modules/jquery/dist/jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jquery-plugin.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que la structure HTML est définie, nous devons écrire le
code affichant l&#8217;heure dans un élément HTML toutes les secondes.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/jquery-plugin.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">/* global jQuery */</span>

<span class="token punctuation">(</span><span class="token parameter">$</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  $<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">displaySeconds</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">displaySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> dateElement</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                  <span class="token comment">// <b class="conum">(1)</b></span>
        <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(2)</b></span>
        <span class="token keyword">const</span> seconds <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">$</span><span class="token punctuation">(</span>dateElement<span class="token punctuation">)</span>                     <span class="token comment">// <b class="conum">(3)</b></span>
          <span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span>seconds <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">'pair'</span><span class="token punctuation">:</span> <span class="token string">'impair'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span>seconds <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">'impair'</span><span class="token punctuation">:</span> <span class="token string">'pair'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'datetime'</span><span class="token punctuation">,</span> now<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span>dateElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'interval'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(4)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>      <span class="token comment">// <b class="conum">(5)</b></span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">displaySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(6)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>jQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ce bloc de code est exécuté toutes les secondes.</p>
</li>
<li>
<p>La donnée de temps est obtenue chaque seconde par notre plug-in <em>jQuery</em>.</p>
</li>
<li>
<p>Certaines décisions métier sont mélangées avec l&#8217;affichage de la donnée temps.</p>
</li>
<li>
<p>L&#8217;intervalle est déterminé par la valeur de l&#8217;attribut <code>data-interval</code>.</p>
</li>
<li>
<p>Ce bloc de code est exécuté dès que le document HTML est prêt&#160;– toute sa structure HTML est disponible.</p>
</li>
<li>
<p>Le plug-in <em>jQuery</em> est appliqué à toutes les occurrences de <code>&lt;time&gt;</code> dans lequel il est exécuté.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Certains motifs illustrés dans la section &#8220;<a href="#modules">Importer des modules</a>&#8221;
refont surface&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Variables globales&#160;: que faire si <code>jQuery</code> n&#8217;existe pas&#160;?</p>
</li>
<li>
<p>Connaissance implicite du document&#160;: que faire si une personne tierce remplace
la balise <code>&lt;time&gt;</code> par une autre balise&#160;?</p>
</li>
<li>
<p>Code ECMAScript piloté par le document&#160;: que faire si une personne tierce
exprime l&#8217;intervalle en secondes et non en millisecondes&#160;?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La faute n&#8217;est pas vraiment celle de <em>jQuery</em> mais plutôt la nôtre&#160;– enfin, la mienne.
Nous avons mélangé règles de fonctionnement (contenu de balise, classe&#160;CSS
à ajouter/enlever) et données (date courante, parité des secondes, événement de
mise à jour <code>setInterval()</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="vers_une_approche_jquery_composite">4.2. Vers une approche jQuery composite</h3>
<div class="paragraph">
<p>Nous allons maintenant reprendre les concepts appris précédemment et conserver
le même outil, à savoir <em>jQuery</em>.
Certains outils encouragent de bons motifs de conception et donnent la sensation
de résoudre des problèmes.
Apprendre ces motifs et à capitaliser sur les outils que nous connaissons déjà
peuvent nous emmener tout aussi&#160;loin.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/jquery-app.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time</span> <span class="token attr-name">datetime</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>---<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jquery-app-browserify.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le changement majeur réside dans la réorganisation du code applicatif&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/jquery-app.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> timerFn <span class="token keyword">from</span> <span class="token string">'./timer.js'</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(4)</b></span>

<span class="token keyword">const</span> <span class="token function-variable function">displaySeconds</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tickData<span class="token punctuation">,</span> dateElement</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(5)</b></span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>className<span class="token punctuation">,</span> now<span class="token punctuation">}</span> <span class="token operator">=</span> tickData<span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span>dateElement<span class="token punctuation">)</span>                                    <span class="token comment">// <b class="conum">(6)</b></span>
    <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'datetime'</span><span class="token punctuation">,</span> now<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dateElements <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">const</span> <span class="token function-variable function">onTick</span> <span class="token operator">=</span> <span class="token parameter">tickData</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                      <span class="token comment">// <b class="conum">(2)</b></span>
    dateElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> <span class="token function">displaySeconds</span><span class="token punctuation">(</span>tickData<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">timerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> interval<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> onTick <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous sélectionnons les éléments de la page à actualiser chaque seconde.</p>
</li>
<li>
<p>Nous définissons quoi faire avec les données transmises chaque seconde.</p>
</li>
<li>
<p>Nous démarrons un minuteur.</p>
</li>
<li>
<p>Le minuteur est une fonction externe, dont le comportement n&#8217;est pas régi par <em>jQuery</em> ou une autre bibliothèque.</p>
</li>
<li>
<p>Cette fonction est responsable de l&#8217;affichage de données dans un élément&#160;HTML.</p>
</li>
<li>
<p>Cette fois-ci, nous nous contentons de seulement mettre à jour attributs et contenus&#160;– la logique métier a été déplacée dans le module <code>timer.js</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le code a été divisé en deux sections distinctes&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>celle qui décrit la réaction à une donnée&#160;;</p>
</li>
<li>
<p>celle qui intègre le minuteur avec les éléments du DOM.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous n&#8217;avons pas réellement besoin de savoir comment fonctionne le minuteur à
ce niveau&#160;– nous devons pouvoir compter sur les données qu&#8217;il nous fournit.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/timer.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">tick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>              <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>                        <span class="token comment">// <b class="conum">(2)</b></span>
    now<span class="token punctuation">,</span>
    className<span class="token punctuation">:</span> now<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">'impair'</span><span class="token punctuation">:</span> <span class="token string">'pair'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">timer</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onTick<span class="token punctuation">,</span> interval <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onTick</span><span class="token punctuation">(</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(4)</b></span>

  <span class="token keyword">return</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(5)</b></span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Cette fonction (privée) est chargée de décrire le temps présent sous forme d&#8217;une structure de données.</p>
</li>
<li>
<p>Cette structure de données pourra retourner de nouvelles clés/valeurs sans remettre en cause le fonctionnement du code y ayant recours.</p>
</li>
<li>
<p>Le paramètre <code>onTick</code> est une fonction passée en argument qui sera appelée à chaque nouvel intervalle de temps.</p>
</li>
<li>
<p>La responsabilité de <code>timer</code> est de communiquer une nouvelle structure de données à un intervalle de temps donné.</p>
</li>
<li>
<p>On retourne immédiatement une structure de données par commodité et de manière synchrone.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour un résultat identique, nous avons désormais séparé notre code en trois
domaines distincts&#160;: le minuteur, son intégration, sa représentation sous forme HTML.
Cerise sur le gâteau, cette distinction se constate visuellement,
au premier coup&#160;d&#8217;œil.</p>
</div>
<div class="paragraph">
<p>Tout n&#8217;est pas parfait, car nous sommes encore liés à la structure du
document&#160;HTML.</p>
</div>
</div>
<div class="sect2">
<h3 id="partager_le_code_métier_avecnode">4.3. Partager le code métier avec&#160;Node</h3>
<div class="paragraph">
<p>Cette séparation de principes (<em>separation of concerns</em>) va au-delà du plaisir
de l&#8217;esthète.
Nous venons sans le savoir de créer du <strong>code ECMAScript universel</strong>.</p>
</div>
<div class="paragraph">
<p>Pourquoi universel&#160;?
Parce que nous pouvons tout aussi bien l&#8217;inclure et l&#8217;exécuter dans Node que
dans un navigateur&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/node-timer.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> timerFn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./timer.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">timerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> interval<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> onTick<span class="token punctuation">:</span> console<span class="token punctuation">.</span>log <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exécution du script <code>node-timer.js</code> afficherait quelque chose comme ce
qui suit dans votre terminal&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node examples/modules/node-timer.js
{ now: 2017-02-17T11:07:29.752Z, className: 'impair' }
{ now: 2017-02-17T11:07:30.762Z, className: 'pair' }
{ now: 2017-02-17T11:07:31.768Z, className: 'impair' }
{ now: 2017-02-17T11:07:32.770Z, className: 'pair' }
{ now: 2017-02-17T11:07:33.775Z, className: 'impair' }
{ now: 2017-02-17T11:07:34.779Z, className: 'pair' }
<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque seconde, la fonction <code>console.log</code> est appelée et affiche la structure
de données de notre minuteur dans la sortie standard du terminal.</p>
</div>
<div class="paragraph">
<p>Nous pourrions dès à présent utiliser le minuteur dans d&#8217;autres applications,
côté client, côté serveur et, pourquoi pas, un jour le publier sur le
registre&#160;<code>npm</code>&#160;?</p>
</div>
</div>
<div class="sect2">
<h3 id="séparation_du_fond_et_de_la_forme_données_rendu_et_interactions">4.4. Séparation du fond et de la forme : données, rendu et interactions</h3>
<div class="paragraph">
<p>Les praticien·ne·s de l&#8217;intégration web nous le dirons souvent&#160;: il faut
<strong>séparer le fond de la forme</strong>.
Il en est de même dans notre code&#160;– et pas que pour le développement <em>front-end</em>.</p>
</div>
<div class="paragraph">
<p>Un code maintenable n&#8217;a pas besoin d&#8217;être complexe.
Il nécessite surtout de bien isoler ses périmètres d&#8217;intervention.</p>
</div>
<div class="paragraph">
<p>Les exemples précédents nous ont permis de déceler trois périmètres phares&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>données&#160;: des structures prédictibles, obtenues ou modifiées&#160;;</p>
</li>
<li>
<p>rendu&#160;: la représentation des données en contexte, que ce soit une page HTML,
un terminal ou un fichier&#160;CSV&#160;;</p>
</li>
<li>
<p>interactions&#160;: des événements déclenchés par les utilisateurs, par des
facteurs externes ou des règles métier&#160;– ils affectent les données et leur
représentation.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="react">4.5. Rapprocher données, rendu et interactions avec&#160;React</h3>
<div class="paragraph">
<p><em>React</em> a atteint un pic de popularité certain en&#160;2015 et&#160;2016,
pas seulement parce que c&#8217;est un outil bien conçu, mais justement parce
qu&#8217;il encourage cette pratique de la représentation des données.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> API&#160;React</div>
<div class="paragraph">
<p>Les exemples suivants se basent sur la bibliothèque <em>React</em> (<span class="URL"><a href="https://reactjs.org" class="bare">reactjs.org</a></span>).
Sa documentation offre de bons exemples pour se familiariser avec son utilisation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notre code HTML n&#8217;est qu&#8217;un résultat exposant des surfaces d&#8217;interaction.
Il se structure en composants.
Un composant est responsable de deux choses&#160;: la représentation de données et
la réaction à des événements.</p>
</div>
<div class="paragraph">
<p>Cela se traduira par un changement de taille&#160;: l&#8217;exemple que nous avons fait
évoluer ne fait plus mention de balise <code>&lt;time&gt;</code> mais expose une balise dédiée à
contenir notre composant minuteur&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/react-app.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>react-app-browserify.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notre code applicatif est réduit à son plus strict minimum&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/react-app.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> DateInterval <span class="token keyword">from</span> <span class="token string">'./date-interval.jsx'</span><span class="token punctuation">;</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>                                  <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token function">createElement</span><span class="token punctuation">(</span>DateInterval<span class="token punctuation">,</span> <span class="token punctuation">{</span>interval<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// <b class="conum">(2)</b></span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>                  <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Méthode responsable du rendu HTML de notre composant <code>TimeInterval</code> dans l&#8217;élément <code>&lt;div id="app"&gt;</code>.</p>
</li>
<li>
<p>Création de notre composant minuteur avec un intervalle de mise à jour de 1&#160;000 millisecondes.</p>
</li>
<li>
<p>Indication que le rendu du composant sera effectué dans l&#8217;élément <code>&lt;div id="app"&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cela ressemble fortement au contenu de nos précédentes invocations de
<code>$(document).ready()</code> mais sans avoir à se soucier du fonctionnement interne du minuteur.</p>
</div>
<div class="paragraph">
<p>La représentation et le fonctionnement du minuteur sont désormais regroupés
dans un seul composant.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/date-interval.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> timerFn <span class="token keyword">from</span> <span class="token string">'./timer.js'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">DateInterval</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>    <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                   <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>interval<span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onTick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onTick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      tickData<span class="token punctuation">:</span> <span class="token function">timerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> interval<span class="token punctuation">,</span> onTick<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onTick <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onTick</span> <span class="token punctuation">(</span><span class="token parameter">tickData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tickData <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                       <span class="token comment">// <b class="conum">(5)</b></span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>className<span class="token punctuation">,</span> now<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>tickData<span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(6)</b></span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span> <span class="token attr-name">dateTime</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>now<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>
      <span class="token punctuation">{</span>now<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous exportons un composant <em>React</em> grâce à l&#8217;opérateur <code>extends</code> (<a href="../chapter-03/index.html#primitive-class">chapitre&#160;3</a>).</p>
</li>
<li>
<p>Le <code>constructor</code> est exécuté quand le composant est rendu dans le document.</p>
</li>
<li>
<p>La propriété <code>interval</code> nous est fournie dans <code>react-app.js</code> et nous stockons la structure de donnée retournée par le minuteur tout en déclenchant son actualisation toutes les 1&#160;000 millisecondes.</p>
</li>
<li>
<p>À chaque intervalle, nous mettons à jour la valeur <code>tickData</code> de l&#8217;état interne du composant (<code>this.state</code>).</p>
</li>
<li>
<p>La méthode <code>render()</code> est exécutée quand le composant est inséré dans un document pour la première fois et quand l&#8217;état interne (<code>this.state</code>) change.</p>
</li>
<li>
<p>Nous déstructurons la valeur connue de <code>tickData</code> pour effectuer une opération qui nous rappelle les différents appels à <code>.attr('class')</code> et <code>.text()</code> de <em>jQuery</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>React</em> introduit trois concepts au sein des composants&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un cycle de vie basé sur des propriétés (<em>props</em>) et un état interne (<em>state</em>)&#160;;</p>
</li>
<li>
<p>des propriétés immuables pour le paramétrage initial&#160;;</p>
</li>
<li>
<p>un état interne mutable pour contenir les changements et demander une
actualisation de leur représentation dans le document.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>React</em> détermine les opérations à effectuer dans le document HTML en fonction
de leur lourdeur&#160;: (re)création complète de <code>&lt;time&gt;</code> dans le nœud
parent, simple mise à jour d&#8217;un ou plusieurs attribut(s) ou encore déplacement
du composant ailleurs dans le document HTML, etc.</p>
</div>
<div class="paragraph">
<p>L&#8217;intelligence d&#8217;une bibliothèque comme <em>React</em> est d&#8217;encourager à décrire
les données et leur rendu pour se charger des opérations d&#8217;écriture dans le DOM.
Cela conduit à créer des composants faciles à isoler, à réutiliser et à tester.</p>
</div>
<div class="paragraph">
<p>Cette approche nous a laissés réutiliser notre minuteur simplement en l&#8217;adaptant.
<em>React</em> nous permet de diriger l&#8217;affichage du document plutôt que d&#8217;en dépendre.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Outil</span> React Developer Tools</div>
<div class="paragraph">
<p>Une extension pour les navigateurs Chrome et Firefox détaille l&#8217;arborescence
des composants montés dans le document HTML ainsi qu&#8217;une vue de leurs propriétés
respectives&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://chrome.google.com/webstore/detail/fmkadmapgofadopljbjfkapdkoienihi" class="bare">chrome.google.com/webstore/detail/fmkadmapgofadopljbjfkapdkoienihi</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://addons.mozilla.org/firefox/addon/react-devtools/" class="bare">addons.mozilla.org/firefox/addon/react-devtools/</a></span></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/react-devtools.png" alt="react devtools" width="85%">
</div>
<div class="title">Figure 3. React Developer Tools</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="io">5. Des requêtes Ajax vers du temps&#160;réel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les technologies web offrent un panel de fonctionnalités créatives et adaptables.
L&#8217;explosion du <em>Web 2.0</em> a coïncidé avec la redécouverte de <code>XMLHttpRequest</code>,
une API initialement créée par Microsoft pour transférer des données entre
client et serveur, de manière non&#160;bloquante.
Cette fonctionnalité a permis de basculer vers un monde de pages dynamiques et
rapides à charger.
Des applications web comme Google&#160;Maps, Gmail ou la recherche instantanée de
Google ont parachevé la popularisation de cette technique.</p>
</div>
<div class="paragraph">
<p>Toutefois, son API est peu intuitive et est unidirectionnelle, dirigée
du client vers le serveur.
Le terme <code>XMLHttpRequest</code> est parfois nommé <code>Ajax</code> ou <code>xhr</code>.</p>
</div>
<div class="paragraph">
<p>Un même exemple côté client sera développé et successivement adapté aux
technologies <code>fetch()</code>, <em>EventSource</em> puis <em>WebSocket</em>.
Il nous permettra d&#8217;en faire émerger les principes, leurs cas d&#8217;usage ainsi
que leur possible intégration avec&#160;Node.</p>
</div>
<div class="paragraph">
<p>L&#8217;implémentation côté serveur est basée sur un serveur
<a href="../chapter-07/index.html#express">Express.js</a> dont l&#8217;usage est expliqué au
<a href="../chapter-07/index.html">chapitre&#160;7</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/io-example.png" alt="io example" width="85%">
</div>
<div class="title">Figure 4. Résultat attendu dans les exemples des sections suivantes</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Node, mais pas&#160;que</div>
<div class="paragraph">
<p><code>fetch()</code>, <em>EventSource</em> et <em>WebSocket</em> reposent sur le protocole HTTP/1 et ses extensions.
Il est important de comprendre que leur contrepartie &#8220;côté serveur&#8221; existe aussi
dans d&#8217;autres langages et environnements comme Ruby, Python et PHP.</p>
</div>
<div class="paragraph">
<p>Il se trouve que la nature asynchrone même de Node rend cette intégration
relativement aisée et triviale, aussi et en grande partie grâce à l&#8217;écosystème&#160;<code>npm</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="io-fetch">5.1. Échange ponctuel de données avec <code>fetch()</code></h3>
<div class="paragraph">
<p><code>fetch()</code> offre une interface très simple pour appeler une ressource HTTP.
Le résultat est retourné sous forme de promesse
(<a href="../chapter-03/index.html#promise">chapitre&#160;3</a>).
Cette fonction sert aussi bien à obtenir des ressources avec des requêtes de
type&#160;<code>GET</code> et <code>HEAD</code> qu&#8217;à en créer et modifier avec des requêtes de type <code>POST</code>,
<code>PUT</code>, <code>DELETE</code> et <code>PATCH</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple associé est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/fetch.html" class="bare">localhost:4000/examples/io/fetch.html</a></span>.
Nous pouvons vérifier la compatibilité navigateur de <code>fetch()</code> sur
<span class="URL"><a href="http://caniuse.com#feat=fetch" class="bare">caniuse.com#feat=fetch</a></span>.</p>
</div>
<div class="paragraph">
<p>Le déroulé d&#8217;exécution d&#8217;un appel à <code>fetch()</code> est le suivant&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Construction de la requête (URL ou objet <code>Request</code>, options).</p>
</li>
<li>
<p>Réception des en-têtes de la réponse (objet <code>Response</code>).</p>
</li>
<li>
<p>Décodage de la réponse.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Plusieurs décodeurs de réponse sont fournis nativement&#160;: texte
(<code>response.text()</code>), JSON (<code>response.json()</code>), ArrayBuffer
(<code>response.arrayBuffer()</code>), Blob (<code>response.blob()</code>) et FormData
(<code>response.formData()</code>).</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/fetch-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> userList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#user-list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/new-users'</span><span class="token punctuation">)</span>                             <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                               <span class="token comment">// <b class="conum">(3)</b></span>
      <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>now<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
      userList<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Exécution de la requête HTTP <em>GET</em> vers <code>/new-users</code> depuis le navigateur courant.</p>
</li>
<li>
<p>Décodage progressif de la réponse.</p>
</li>
<li>
<p>Une fois le décodage terminé, le résultat de la requête HTTP est mis à disposition&#160;– ici, sous forme de chaîne de caractères.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/fetch-frames.png" alt="fetch frames" width="85%">
</div>
<div class="title">Figure 5. Traces réseau d&#8217;appels successifs à <code>fetch()</code> ; chacun résultant en une nouvelle requête&#160;HTTP</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation d&#8217;une ressource HTTP côté serveur s&#8217;effectue simplement
en retournant une réponse lors d&#8217;une requête.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/fetch-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> chance <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Chance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/new-users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>chance<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Collection d&#8217;exemples</div>
<div class="paragraph">
<p>Le site communautaire MDN met à disposition une dizaine d&#8217;exemples
pour illustrer différents cas d&#8217;utilisation de <code>fetch()</code>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://github.com/mdn/fetch-examples" class="bare">github.com/mdn/fetch-examples</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En résumé, <code>fetch()</code> est idéal pour des demandes ponctuelles de données,
du client vers le serveur.
Le module&#160;<code>npm</code> <code>node-fetch</code> (<span class="URL"><a href="https://npmjs.com/node-fetch" class="bare">npmjs.com/node-fetch</a></span>) est une
implémentation de <code>fetch()</code> pour Node, tandis que <code>whatwg-fetch</code>
(<span class="URL"><a href="https://npmjs.com/whatwg-fetch" class="bare">npmjs.com/whatwg-fetch</a></span>) s&#8217;occupe uniquement de <em>polyfiller</em> les
navigateurs.</p>
</div>
</div>
<div class="sect2">
<h3 id="io-eventsource">5.2. Approche unidirectionnelle avec EventSource</h3>
<div class="paragraph">
<p><em>EventSource</em> est un mécanisme moins connu que <code>fetch()</code> ou <em>WebSocket</em> mais qui
tire ses origines de la technologie <em>Comet</em>.
On peut l&#8217;assimiler à une inversion de <code>fetch()</code>&#160;: le client appelle une ressource
serveur, maintient une connexion de longue durée et attend un ou plusieurs
message(s) dudit serveur.</p>
</div>
<div class="paragraph">
<p>Chaque connexion est ouverte en faisant appel à la construction d&#8217;un objet
<code>EventSource</code>, qui émet alors plusieurs types d&#8217;événements en fonction des actions&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>open</code>&#160;: lorsque le client s&#8217;est connecté au serveur&#160;;</p>
</li>
<li>
<p><code>message</code>&#160;: lorsque le serveur émet des données à destination du client&#160;;</p>
</li>
<li>
<p><code>close</code>&#160;: lorsque la connexion est fermée par le serveur&#160;;</p>
</li>
<li>
<p><code>error</code>&#160;: lorsque la connexion est accidentellement interrompue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce modèle de connexion permet tout aussi bien d&#8217;avoir un canal de données
unique avec chaque utilisateur ou encore d&#8217;émettre les mêmes données en temps
réel à destination de tous les usagers.</p>
</div>
<div class="paragraph">
<p>L’exemple associé est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/eventsource.html" class="bare">localhost:4000/examples/io/eventsource.html</a></span>.
Nous pouvons vérifier la compatibilité navigateur de <em>EventSource</em> sur
<span class="URL"><a href="http://caniuse.com#feat=eventsource" class="bare">caniuse.com#feat=eventsource</a></span>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/eventsource-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">'/new-users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> userList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#user-list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>now<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  userList<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous ouvrons une nouvelle connexion <em>EventSource</em> de longue durée depuis
le navigateur courant.</p>
</li>
<li>
<p>Fonction appelée à chaque fois que le serveur transmet un message au client.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/eventsource-frames.png" alt="eventsource frames" width="85%">
</div>
<div class="title">Figure 6. Plusieurs messages peuvent être transmis par le biais d&#8217;une seule connexion HTTP avec <em>EventSource</em></div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation d'<em>EventSource</em> demande un peu d&#8217;efforts côté serveur, mais ne
nécessite pas de framework particulier.
La complexité réside dans le maintien d&#8217;une transmission de données dédiée à
chaque client ainsi qu&#8217;à la libération de la connexion lorsque le client se déconnecte.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/eventsource-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'faye-websocket'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>EventSource<span class="token punctuation">}</span> <span class="token operator">=</span> WebSocket<span class="token punctuation">;</span>

<span class="token keyword">const</span> chance <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Chance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/new-users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>EventSource<span class="token punctuation">.</span><span class="token function">isEventSource</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// <b class="conum">(1)</b></span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> es <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">const</span> loop <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      es<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>chance<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    es<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
      es <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Une connexion <em>EventSource</em> s&#8217;effectue (presque) comme une requête HTTP classique&#160;– il convient de vérifier qu&#8217;elle s&#8217;annonce en tant que&#160;telle.</p>
</li>
<li>
<p>Création d&#8217;un canal unique entre le client et le serveur.</p>
</li>
<li>
<p>Chaque appel à <code>es.send</code> enverra un nouveau message au client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le serveur est responsable de la gestion des connexions demandées par les
différents clients.</p>
</div>
<div class="admonitionblock note info">
<table>
<tr>
<td class="icon">
<div class="title">📖</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> EventSource</div>

Rendez-vous sur <em>MDN web docs</em> pour en savoir plus sur EventSource.<br>
<a href="https://developer.mozilla.org/docs/fr/Server-sent_events" class="bare URL" target="_blank" rel="noopener">developer.mozilla.org/docs/fr/Server-sent_events</a>

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En résumé, <em>EventSource</em> est idéal pour maintenir une connexion avec le serveur
et souscrire à des mises à jour en continu.
Chaque connexion <em>EventSource</em> devrait concerner qu&#8217;un seul et même type d&#8217;événement.</p>
</div>
</div>
<div class="sect2">
<h3 id="io-websocket">5.3. Échanges en temps&#160;réel avec WebSocket</h3>
<div class="paragraph">
<p><em>WebSocket</em> est une technologie web favorisant les échanges bidirectionnels
entre client et serveur.</p>
</div>
<div class="paragraph">
<p>À l&#8217;inverse du protocole HTTP/1, tout message envoyé par le client ou par le
serveur n&#8217;appelle pas à une réponse de la part du receveur.
Cet élément et le maintien d&#8217;une connexion permanente expliquent la
rapidité du protocole en comparaison avec le modèle requête/réponse.</p>
</div>
<div class="paragraph">
<p>L’exemple associé est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/websocket.html" class="bare">localhost:4000/examples/io/websocket.html</a></span>.
Nous pouvons vérifier la compatibilité navigateur de <em>WebSocket</em> sur
<span class="URL"><a href="http://caniuse.com#feat=websocket" class="bare">caniuse.com#feat=websocket</a></span>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/websocket-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:4000/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> userList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#user-list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> interval<span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> action<span class="token punctuation">:</span> <span class="token string">'getName'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>          <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>now<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  userList<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  ws <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous ouvrons une connexion <em>WebSocket</em> depuis le navigateur courant.</p>
</li>
<li>
<p>Émission d&#8217;un message à destination du serveur.</p>
</li>
<li>
<p>Réaction à un message émis par le serveur.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/websocket-frames.png" alt="websocket frames" width="85%">
</div>
<div class="title">Figure 7. Trame de messages envoyés par le client (sur fond vert) et par le serveur</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation côté serveur est légèrement plus compliquée qu&#8217;avec
<em>EventSource</em> pour la simple et bonne raison que <em>Websocket</em> est une surcouche
du protocole&#160;<code>ws</code>.
HTTP n&#8217;est utilisé que comme canal de communication pour établir un lien avec
le serveur&#160;<code>ws</code>.
HTTP sert de tunnel tandis que le dialogue entre client et serveur s&#8217;effectue
dans un dialecte compréhensible uniquement de clients <em>WebSocket</em>.</p>
</div>
<div class="paragraph">
<p>Il est nécessaire d&#8217;utiliser un module&#160;<code>npm</code> <em>WebSocket</em> comme <em>faye</em>
(<span class="URL"><a href="https://npmjs.com/faye-websocket" class="bare">npmjs.com/faye-websocket</a></span>) ou <em>socket.io</em>
(<span class="URL"><a href="https://npmjs.com/socket.io" class="bare">npmjs.com/socket.io</a></span>) à moins de vouloir réimplémenter le protocole
soi-même.
Le motif de conception est similaire à celui d'<em>EventSource</em>, à la différence près
qu&#8217;il faut aussi écouter les messages transmis par le client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> HTTP et le statut 101 Switching Protocols</div>
<div class="paragraph">
<p>Voici ce qui se passe lorsqu&#8217;un client <em>WebSocket</em> se connecte sur <code>ws://example.com</code>&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Requête HTTP <code><a href="http://example.com" class="bare">example.com</a></code> standard contenant les en-têtes <code>Upgrade: websocket</code> et <code>Connection: Upgrade</code>.</p>
</li>
<li>
<p>Le serveur HTTP répond avec un statut <code>101 Switching Protocols</code>.</p>
</li>
<li>
<p>Le serveur <em>WebSocket</em> prend le relais dans le dialogue client/serveur.</p>
</li>
<li>
<p>Client et serveur communiquent désormais via le protocole <code>ws</code> au sein de la connexion HTTP initiale.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Par extension et de par la nature même du protocole <code>ws</code>, il serait tout à
fait possible que <em>et</em> clients <em>et</em> serveur soient des agents Node.
Autrement dit, un client <em>WebSocket</em> ne doit pas nécessairement être un navigateur.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/websocket-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'faye-websocket'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chance <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Chance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">server</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'upgrade'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> body<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>WebSocket<span class="token punctuation">.</span><span class="token function">isWebSocket</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment">// <b class="conum">(2)</b></span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(3)</b></span>

    ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                  <span class="token comment">// <b class="conum">(4)</b></span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">'getName'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>chance<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(5)</b></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      ws <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le serveur HTTP vient de répondre avec un statut <code>101 Switching Protocols</code> et délègue désormais la responsabilité du dialogue client/serveur.</p>
</li>
<li>
<p>Nous vérifions que le changement de protocole concerne le protocole <code>ws</code>.</p>
</li>
<li>
<p>La connexion réseau (<code>socket</code>) est transmise au serveur <em>WebSocket</em> pour amorcer le dialogue client/serveur avec le protocole <code>ws</code>.</p>
</li>
<li>
<p>Réaction à la réception d&#8217;un message client.</p>
</li>
<li>
<p>Émission d&#8217;un message à destination d&#8217;un client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Là aussi, le serveur est responsable de la gestion des connexions demandées par
les différents clients.</p>
</div>
<div class="admonitionblock note info">
<table>
<tr>
<td class="icon">
<div class="title">📖</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> WebSockets</div>

Rendez-vous sur <em>MDN web docs</em> pour en savoir plus sur WebSockets.<br>
<a href="https://developer.mozilla.org/docs/fr/WebSockets" class="bare URL" target="_blank" rel="noopener">developer.mozilla.org/docs/fr/WebSockets</a>

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En résumé, <em>WebSocket</em> est idéal pour maintenir une connexion en temps&#160;réel et
pour relayer plusieurs messages à l&#8217;initiative du serveur et de tout client
connecté&#160;– qu&#8217;il s&#8217;agisse d&#8217;un navigateur ou d&#8217;un agent Node.
Chaque connexion <em>WebSocket</em> peut encapsuler plusieurs types de messages.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="développer_au_quotidien">6. Développer au quotidien</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons beaucoup parlé de nouvelles techniques et de modularisation.
Cela peut sembler rebutant, notamment par l&#8217;introduction d&#8217;outils auxquels
nous ne sommes pas encore familiers.</p>
</div>
<div class="paragraph">
<p>L&#8217;écosystème Node fournit énormément d&#8217;outils qui devraient nous faire
gagner du temps, en nous aidant à organiser notre travail ou à exécuter des actions
lorsqu&#8217;un fichier est modifié, mais aussi en actualisant automatiquement
notre application web au fil du développement
(fini les appuis répétés sur la touche&#160;<kbd>F5</kbd>) ou encore en
optimisant nos fichiers graphiques.</p>
</div>
<div class="sect2">
<h3 id="watchify">6.1. Reconstruire en continu avec <code>watchify</code></h3>
<div class="paragraph">
<p>L&#8217;utilisation de <a href="#browserify">browserify</a> nous apporte du confort avec la
possibilité d&#8217;inclure des modules&#160;<code>npm</code> dans les navigateurs.
En revanche, cela nous demande de générer des artefacts&#160;– des <em>bundles</em>&#160;– à
chaque modification pour consolider ces changements.</p>
</div>
<div class="paragraph">
<p>C&#8217;est à ce moment qu&#8217;intervient le module <em>watchify</em> (<span class="URL"><a href="https://npmjs.com/watchify" class="bare">npmjs.com/watchify</a></span>).
Il fonctionne exactement comme <em>browserify</em>, mais au lieu de compiler une seule
fois, il compile dès qu&#8217;un changement est détecté&#160;– où que ce soit dans l&#8217;arbre
de dépendances du point d&#8217;entrée (paramètre&#160;<code>-e</code>, <code>--entrypoint</code>).</p>
</div>
<div class="paragraph">
<p>La commande suivante compilerait le fichier <code>examples/modules/react-app.js</code>
une seule fois&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/browserify -t babelify \
  -e examples/modules/react-app.js \
  -o examples/modules/react-app-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit de remplacer <code>browserify</code> par <code>watchify</code>&#160;– le programme garde la main
et indique chaque nouvelle compilation sur une nouvelle ligne.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/watchify -dv -t babelify \
  -e examples/modules/react-app.js \
  -o examples/modules/react-app-browserify.js
1840601 bytes written to react-app-browserify.js (2.58 seconds) at 4:44:28 PM
352482 bytes written to react-app-browserify.js (0.10 seconds) at 4:45:09 PM
1840605 bytes written to react-app-browserify.js (0.25 seconds) at 4:45:15 PM</pre>
</div>
</div>
<div class="paragraph">
<p><em>watchify</em> utilise un mécanisme dit de <strong>compilation incrémentale</strong>&#160;: il ne
recompile pas tout, mais uniquement les différences depuis le dernier changement.
C&#8217;est beaucoup plus rapide et tout aussi efficace.</p>
</div>
<div class="paragraph">
<p>Trois arguments sont utiles à <em>watchify</em>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-v</code>&#160;(<code>--verbose</code>)&#160;: force la création du fichier compilé au lancement de la commande.</p>
</li>
<li>
<p><code>-o</code>&#160;(<code>--outfile</code>)&#160;: spécifie le chemin d&#8217;enregistrement du fichier compilé&#160;– il est impossible d&#8217;utiliser la <a href="../chapter-04/index.html#stdio">sortie standard</a> (<a href="../chapter-04/index.html">chapitre&#160;4</a>).</p>
</li>
<li>
<p><code>-d</code>&#160;(<code>--debug</code>)&#160;: (lire &#8220;<a href="#browserify-sourcemaps">Les source&#160;maps</a>&#8221; dans ce même chapitre).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="livereload">6.2. Changements en temps&#160;réel dans le navigateur</h3>
<div class="paragraph">
<p>Modifier un fichier. Changer de fenêtre. Recharger. Changer de fenêtre. Re-modifier
un fichier. Changer de fenêtre. Recharger. Là c&#8217;est bon.</p>
</div>
<div class="paragraph">
<p>La quantité d&#8217;outils à disposition et leurs différentes opinions sur notre manière
de travailler nous obligent à prendre des postures de travail qui ne vont
pas nécessairement dans le sens de la productivité.</p>
</div>
<div class="paragraph">
<p>L&#8217;intégration de Node avec le système d&#8217;exploitation va nous aider à déclencher
des actions lorsque des fichiers sont modifiés.
Ces modifications sont parfois de notre fait, directement ou par le biais d&#8217;un
autre logiciel (un optimiseur d&#8217;images ou la <a href="#node-sass">compilation d&#8217;un fichier Sass</a> par exemple).</p>
</div>
<div class="paragraph">
<p>Nous allons explorer deux stratégies d&#8217;actualisation&#160;: le rafraîchissement
automatique du navigateur et le remplacement de modules à chaud
(<em>Hot Module Replacement</em>, HMR).</p>
</div>
<div class="paragraph">
<p><em>browser-sync</em> est un outil formidable de développement pour
rafraîchir automatiquement une page web si son contenu ou une des ressources
associées change.
Il offre également la possibilité de propager les changements sur plusieurs
fenêtres et terminaux&#160;– y compris les clics, défilements et toute interaction
avec des formulaires.</p>
</div>
<div class="videoblock">
<div class="title">Exemple de synchronisation d&#8217;affichage et de contenus entre deux fenêtres avec browser-sync</div>
<div class="content">
<video src="./videos/browser-sync.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p><em>browser-sync</em> maintient la position du curseur de défilement lors d&#8217;un rechargement de contenu.
L&#8217;outil se lance soit de manière autonome, soit en <em>proxy</em> entre l&#8217;utilisateur
et tout autre serveur web.
Il ne nécessite pas non plus de plug-in ou d&#8217;extension navigateur pour fonctionner,
ce qui le rend idéal pour du prototypage, de la recherche utilisateur ou du
développement local.</p>
</div>
<div class="listingblock">
<div class="title">Lancement d&#8217;un serveur web autonome avec synchronisation sur le port&#160;4000</div>
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/browser-sync start --server --port 4000 .</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre l&#8217;intégration de <em>browser-sync</em> avec le serveur
web exposant les exemples de ce chapitre (voir le détail dans le fichier <code>server.js</code>)&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">livereload/server-sync.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">server</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>             <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">return</span> <span class="token parameter">port</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                         <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">const</span> <span class="token constant">PUBLIC_PORT</span> <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>              <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(4)</b></span>

    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                              <span class="token comment">// <b class="conum">(5)</b></span>
      files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./examples'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      port<span class="token punctuation">:</span> <span class="token constant">PUBLIC_PORT</span><span class="token punctuation">,</span>
      open<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      logPrefix<span class="token punctuation">:</span> <span class="token string">'nodebook'</span><span class="token punctuation">,</span>
      proxy<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span><span class="token comment">// <b class="conum">(6)</b></span>
        ws<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On passe un serveur&#160;HTTP en argument (obtenu via <code>http.createServer()</code> par exemple).</p>
</li>
<li>
<p>Ce port sera affecté au serveur web mais ne sera pas voué à être public.</p>
</li>
<li>
<p>Ce port, lui, sera public.</p>
</li>
<li>
<p>Démarrage du serveur web sur le port privé.</p>
</li>
<li>
<p>Initialisation de <em>browser-sync</em>.</p>
</li>
<li>
<p>Interfaçage avec le serveur web créé au point&#160;4.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La synchronisation peut être activée avec tous les exemples du chapitre en
suffixant la commande <code>npm start</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>cd $(nodebook dir chapter-09)
<span data-bash-subs="$"></span>npm start -- --with-sync</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>browser-sync</em></div>
<div class="paragraph">
<p><em>browser-sync</em> (<span class="URL"><a href="https://browsersync.io" class="bare">browsersync.io</a></span>) est richement documenté et
illustré, y&#160;compris ses intégrations avec les outils Gulp et Grunt.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>browser-sync</em> a beau maintenir la position du défilement, il n&#8217;en reste pas
moins que chaque changement remet à zéro l&#8217;espace mémoire de la page.
C&#8217;est là qu&#8217;entre en jeu le remplacement des modules à chaud.</p>
</div>
<div class="paragraph">
<p>Le <strong>remplacement des modules à chaud</strong> (<em>Hot Module Replacement</em> ou HMR) est
une technique basée sur le remplacement de fonctions ou d&#8217;objets tout en assurant
le maintien de leurs variables ou états internes.
Cette technique a notamment été popularisée par la combinaison de la bibliothèque
<em>React</em> et de l&#8217;outil d&#8217;assemblage <em>Webpack</em>.
Il est toutefois possible de procéder à du remplacement à chaud sans <em>React</em>
et sans <em>Webpack</em>.</p>
</div>
<div class="paragraph">
<p>Quatre actions sont effectuées&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un serveur de remplacement à chaud est démarré localement.</p>
</li>
<li>
<p>L&#8217;outil d&#8217;assemblage (<em>browserify</em>, <em>Webpack</em>, etc.) insère du code client
pour établir un lien entre la page web et le serveur de remplacement à chaud.</p>
</li>
<li>
<p>L&#8217;outil d&#8217;assemblage déclare les fichiers modifiés, transmis par le serveur
de remplacement à chaud vers le navigateur.</p>
</li>
<li>
<p>Le code client remplace les modules et maintient leur état interne.</p>
</li>
</ul>
</div>
<div class="videoblock">
<div class="title">Exemple de rechargement à chaud avec des composants React</div>
<div class="content">
<video src="./videos/react-hmr.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Le plug-in <em>Browserify</em> nommé <em>livereactload</em> (<span class="URL"><a href="https://npmjs.com/livereactload" class="bare">npmjs.com/livereactload</a></span>)
est très certainement le plus facile à mettre en place pour remplacer des
modules <em>React</em> à la volée.
Il nécessite une ligne de configuration côté <em>browserify</em> mais aucun
changement de code côté client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> livereactload</div>
<div class="paragraph">
<p>Des aides à l&#8217;installation du module <em>livereactload</em> sont disponibles dans
son fichier README.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le remplacement à chaud n&#8217;est possible que lorsque nous sommes dans un état
de reconstruction en continu, par exemple avec <a href="#watchify">watchify</a>.</p>
</div>
<div class="paragraph">
<p>Nous pouvons constater les effets du remplacement à chaud avec un des exemples
de ce chapitre, accessible sur <span class="URL"><a href="http://localhost:4000/examples/livereload/react-app-hmr.html" class="bare">localhost:4000/examples/livereload/react-app-hmr.html</a></span>.
La commande <code>npm run watch</code> de ce chapitre démarre un serveur web et reconstruit
en continu le fichier <code>./examples/livereload/react-app-hmr.js</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>cd $(nodebook dir chapter-09)
<span data-bash-subs="$"></span>npm run watch</pre>
</div>
</div>
<div class="paragraph">
<p>Qui n&#8217;est autre qu&#8217;un équivalent de&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/watchify -dv \
  -t babelify \
  -p livereactload \
  -e ./examples/livereload/react-app-hmr.js \
  -o ./examples/livereload/react-app-hmr-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>Dans cet exemple, le <em>transform</em>&#160;(<code>-t</code>) modifie le code source à la volée&#160;–
ici, pour adapter le code écrit dans une syntaxe compréhensible par la majorité
des navigateurs grâce à l&#8217;outil <a href="#transpilation">Babel</a>.</p>
</div>
<div class="paragraph">
<p>Le plug-in &#160;(<code>-p</code>) ne transforme pas le code mais le fonctionnement de
<em>watchify</em> pour y ajouter des fonctionnalités&#160;– ici, refléter les
changements du fichier source vers le navigateur en temps réel.</p>
</div>
<div class="paragraph">
<p>Il faudra ensuite modifier l&#8217;un des deux fichiers suivants&#160;– en décommentant les lignes concernées par exemple&#160;– pour constater les changements dans notre navigateur.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">livereload/react-app-hmr.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ButtonCount <span class="token keyword">from</span> <span class="token string">'./button-count.jsx'</span><span class="token punctuation">;</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span>ButtonCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span>ButtonCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// createElement(ButtonCount),</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque instance du composant <code>livereload/button-count.jsx</code> gère un état interne
indépendant des autres instances de même type.
Nous aurions perdu cet état interne en cas d&#8217;utilisation de <em>browser-sync</em>, sans
remplacement à chaud&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">livereload/button-count.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ButtonCount</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      clickCount<span class="token punctuation">:</span> <span class="token number">0</span>                                           <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleClick</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> clickCount<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>clickCount <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// style = {</span>
    <span class="token comment">//   fontFamily: 'monospace',</span>
    <span class="token comment">//   fontWeight: 'bold',</span>
    <span class="token comment">//   textTransform:' uppercase',</span>
    <span class="token comment">// };</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>
      Clics <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>clickCount<span class="token punctuation">}</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initialisation du compteur de clics propre à chaque instance de <code>ButtonCount</code>.</p>
</li>
<li>
<p>Incrémentation du compteur de clics en réaction à un clic sur le composant <code>ButtonCount</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> ud et browserify-hmr</div>
<div class="paragraph">
<p>Deux modules vont nous aider&#160;: <em>ud</em> (<span class="URL"><a href="https://npmjs.com/ud" class="bare">npmjs.com/ud</a></span>)
et <em>browserify-hmr</em> (<span class="URL"><a href="https://npmjs.com/browserify-hmr" class="bare">npmjs.com/browserify-hmr</a></span>), respectivement pour
déclarer des modules remplaçables et pour démarrer un serveur de remplacement
à chaud minimaliste.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="node-sass">6.3. Modulariser ses feuilles de styles avec&#160;Sass</h3>
<div class="paragraph">
<p>La modularité et l&#8217;écriture d&#8217;un code isolé facilitent sa réutilisation et
préviennent les effets de bord.
Dans le cas des feuilles de styles CSS, cela peut éviter de faire
déborder la cascade&#160;– si l&#8217;on peut&#160;dire.</p>
</div>
<div class="paragraph">
<p>Avec le langage Sass (<span class="URL"><a href="http://sass-lang.com" class="bare">sass-lang.com</a></span>), nous pourrions songer à
générer des blocs de code selon des listes (idéal pour des thèmes de couleurs,
des rubriques produits, etc.), à concevoir des composants comme des fonctions
ou à bénéficier de fonctions de calcul de couleurs ou d&#8217;unités de mesure.</p>
</div>
<div class="paragraph">
<p>Le langage Sass est originaire du monde Ruby, mais il a été depuis rendu
accessible nativement à l&#8217;écosystème Node par le biais de <em>node-sass</em>
(<span class="URL"><a href="https://npmjs.com/node-sass" class="bare">npmjs.com/node-sass</a></span>)– et, par extension,
par la bibliothèque&#160;C <em>libsass</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lecture</span> CSS maintenables avec Sass et Compass</div>
<div class="paragraph">
<p>Je recommande la lecture de l&#8217;ouvrage de référence
<em>CSS&#160;maintenables avec Sass et Compass</em>,
écrit par Kaelig&#160;Deloumeau-Prigent aux éditions Eyrolles.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://editions-eyrolles.com/Livre/9782212136401" class="bare">editions-eyrolles.com/Livre/9782212136401</a></span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il décrit très bien les tenants et aboutissants de Sass, ainsi que de bonnes
méthodes d&#8217;organisation du code et de maintenabilité au sein d&#8217;une équipe de
travail.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>node-sass</em> offre un outil en ligne de commande pour compiler un fichier Sass,
plusieurs fichiers Sass ou encore une arborescence de répertoires contenant des
fichiers Sass vers des fichiers CSS compréhensibles par les navigateurs.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">ui/buttons.scss</div>
<div class="content">
<pre class="highlight"><code class="language-sass" data-lang="sass"><span class="token variable-line"><span class="token variable">$sizes</span><span class="token punctuation">:</span> (                             <span class="token operator">/</span><span class="token operator">/</span> <b class="conum">(1)</b></span>
<span class="token property-line">  <span class="token property">small</span><span class="token punctuation">:</span> .8,</span>
<span class="token property-line">  <span class="token property">regular</span><span class="token punctuation">:</span> 1,</span>
<span class="token property-line">  <span class="token property">large</span><span class="token punctuation">:</span> 1.2</span>
<span class="token selector">);</span>

<span class="token selector">.btn {</span>
<span class="token atrule-line">  <span class="token atrule">@each</span> $size, $factor in $sizes {    // <b class="conum">(2)</b></span>
    <span class="token selector">&amp;amp;.btn--#{$size} {                 // <b class="conum">(3)</b></span>
<span class="token property-line">      <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token variable">$factor</span> <span class="token operator">*</span> 1em;       <span class="token operator">/</span><span class="token operator">/</span> <b class="conum">(4)</b></span>
    <span class="token selector">}</span>
  <span class="token selector">}</span>

  <span class="token selector">&amp;amp;.btn--icon {                       // <b class="conum">(5)</b></span>
    <span class="token selector">svg {</span>
<span class="token property-line">      <span class="token property">height</span><span class="token punctuation">:</span> 16px;</span>
<span class="token property-line">      <span class="token property">width</span><span class="token punctuation">:</span> 16px;</span>
<span class="token property-line">      <span class="token property">margin-right</span><span class="token punctuation">:</span> .5em;</span>
    <span class="token selector">}</span>
  <span class="token selector">}</span>
<span class="token selector">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Définition d&#8217;une <code>Map</code> nommée <code>$sizes</code> (ensemble clé/valeur) décrivant des tailles et leur facteur multiplicateur.</p>
</li>
<li>
<p>Itération et extraction des clés/valeurs de <code>$sizes</code>.</p>
</li>
<li>
<p>Interpolation d&#8217;une variable pour composer un sélecteur CSS (<code>.btn&#8212;&#8203;small</code>, <code>.btn&#8212;&#8203;regular</code> etc.).</p>
</li>
<li>
<p>Calcul de la taille de la police de caractères (<code>.8em</code>, <code>1em</code>, etc.).</p>
</li>
<li>
<p>Composition d&#8217;un sélecteur de classe à partir du sélecteur courant (<code>.btn.btn&#8212;&#8203;icon</code>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La compilation des fichiers s&#8217;effectue très simplement&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/node-sass -o ./examples ./examples/buttons.scss</pre>
</div>
</div>
<div class="paragraph">
<p>Elle produit le fichier CSS <code>button.css</code>, lisible par tout navigateur&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">ui/buttons.css</div>
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css"><span class="token selector">.btn.btn--small</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token selector">.btn.btn--regular</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token selector">.btn.btn--large</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 1.2em<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token selector">.btn.btn--icon svg</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
  <span class="token property">margin-right</span><span class="token punctuation">:</span> .5em<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Astuce</span> Oublions les vendor prefix</div>
<div class="paragraph">
<p>Les navigateurs évoluent plus vite que le cycle de vie de nos projets.
Certaines propriétés CSS sont abritées derrière des préfixes (<code>-moz</code>, <code>-webkit</code>,
etc.) avant d&#8217;être standardisées.</p>
</div>
<div class="paragraph">
<p>Les modules <em>autoprefixer</em> (<span class="URL"><a href="https://npmjs.com/autoprefixer" class="bare">npmjs.com/autoprefixer</a></span>) et
<em>postcss</em> (<span class="URL"><a href="https://npmjs.com/postcss" class="bare">npmjs.com/postcss</a></span>) nous facilitent la tâche en préfixant
et réécrivant automatiquement les attributs en fonction de nos exigences de
compatibilité avec les navigateurs.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ui-bundling">6.4. Lier composants visuels et feuilles de&#160;styles</h3>
<div class="paragraph">
<p>Souvenons-nous de la section expliquant le
<a href="#react">rapprochement entre données, rendu et interactions avec React</a>.
Finalement, nous avons presque tout rapproché, exception faite de la présentation
avec Sass ou CSS.</p>
</div>
<div class="paragraph">
<p>En suivant la logique de notre approche modulaire, nous pourrions imaginer
un <em>transform browserify</em> pour compiler et/ou extraire notre code Sass ou
CSS depuis nos modules CommonJS ou ECMAScript.</p>
</div>
<div class="paragraph">
<p>C&#8217;est exactement la proposition du module <em>sassify</em>.
Il intègre <em>node-sass</em> en tant que <em>transform browserify</em> et transforme le
code à la volée durant la phase de compilation.
Il se charge lui-même d&#8217;ajouter les styles dans le document HTML ou expose le
code CSS compilé via la fonction <code>require()</code>.</p>
</div>
<div class="paragraph">
<p>Une saine stratégie serait de charger des CSS de base dans une feuille de styles
en tête de <code>&lt;head&gt;</code> puis de laisser les composants graphiques injecter leurs
feuilles CSS respectives après coup.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant expose deux composants <em>React</em>, regroupés dans une thématique
de composants de boutons HTML.
Une feuille de styles est importée à même le module afin de gérer au même niveau
présentation, rendu et interactions&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">ui/Buttons.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./buttons.scss'</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">const</span> <span class="token function-variable function">Icon</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>use</span> <span class="token attr-name">xlinkHref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">'symbols.svg#'</span> <span class="token operator">+</span> props<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">BaseButton</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">'btn btn--'</span> <span class="token operator">+</span> props<span class="token punctuation">.</span>variant<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">IconButton</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn--icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Icon</span></span> <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>icon<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
    <span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Import d&#8217;un fichier Sass qui sera par la suite compilé en CSS par le <em>transform sassify</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Sans surprise, le module <em>sassify</em> se charge comme la majorité des
<em>transforms browserify</em> comme vu dans la section
&#8220;<a href="#browserify">Importer des modules&#160;<code>npm</code> pour le Web</a>&#8221; dans ce même chapitre&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/browserify \
  -t sassify \
  -t babelify \
  -e ./examples/Buttons.jsx \
  -o ./examples/Button-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante injectera automatiquement les feuilles de style compilées
dans le document HTML lors de son exécution dans un navigateur&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/browserify \
  -t [ sassify --auto-inject ] \
  -t babelify \
  -e ./examples/Buttons.jsx \
  -o ./examples/Button-browserify.js</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="optimiser_ses_ressources_graphiques">6.5. Optimiser ses ressources graphiques</h3>
<div class="paragraph">
<p>Node est un outil de choix lorsque l&#8217;on souhaite s&#8217;atteler au développement
<em>front-end</em> et ce n&#8217;est pas sans raison.
Outre l&#8217;outillage lié à la réécriture du code, il regorge de modules&#160;<code>npm</code>
réduisant les tâches manuelles répétitives et possiblement sujettes à erreur.</p>
</div>
<div class="paragraph">
<p>Nous retrouvons l&#8217;optimisation des ressources graphiques parmi cet ensemble de
tâches rébarbatives.
Quand j&#8217;écris ressources graphiques, j&#8217;entends par là le redimensionnement ou
la création de vignettes d&#8217;images, l&#8217;optimisation de leur poids, la fusion de
fichiers&#160;SVG sous forme de symboles, la création de piles de
polices de caractères et même l&#8217;encodage audio/vidéo&#160;– via des logiciels
spécialisés comme <em>FFmpeg</em> ou <em>LAME</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;outil en ligne de commande <em>imagemin-cli</em> (<span class="URL"><a href="https://npmjs.com/imagemin-cli" class="bare">npmjs.com/imagemin-cli</a></span>)
est le module de référence pour optimiser les fichiers graphiques.
Il est basé sur la bibliothèque <em>imagemin</em> (<span class="URL"><a href="https://npmjs.com/imagemin" class="bare">npmjs.com/imagemin</a></span>) et
se charge de réduire le poids de nos images JPEG, PNG mais aussi GIF (animés
et statiques) ainsi que le format vectoriel&#160;SVG.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/imagemin images/* --out-dir images
8 images minified</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Glossaire</span> Compression destructive et non&#160;destructive</div>
<div class="paragraph">
<p>Il existe deux types de compression&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>destructive&#160;: poids réduit au maximum, possibles artefacts visuels, destruction
potentielle de couleurs dans le cas d&#8217;images complexes&#160;;</p>
</li>
<li>
<p>sans perte&#160;: poids réduit, les couleurs supprimées ne sont pas perceptibles
à l&#8217;œil&#160;nu.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il vaut mieux privilégier la <em>compression sans perte</em> pour éviter les artefacts
visuels et respecter la création d&#8217;origine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le redimensionnement d&#8217;images est une autre de ces tâches courantes et récurrentes
qui tombe rapidement aux oubliettes de par sa gourmandise en temps.
On voudra par exemple redimensionner des photos depuis des fichiers originaux,
générer des vignettes ou encore différentes tailles d&#8217;image adaptées
aux différentes dispositions d&#8217;un site web <em>responsive</em>.</p>
</div>
<div class="paragraph">
<p><em>sharp-cli</em> (<span class="URL"><a href="https://npmjs.com/sharp-cli" class="bare">npmjs.com/sharp-cli</a></span>) répond exactement à ce cahier
des charges.
Ce module en ligne de commande est basé sur <em>sharp</em> (<span class="URL"><a href="https://npmjs.com/sharp" class="bare">npmjs.com/sharp</a></span>),
une bibliothèque Node de modification d&#8217;images écrite en ECMAScript et <em>C&#43;&#43;</em>.
<em>sharp</em> nous aidera entre autres à redimensionner, découper, retourner, recentrer,
assembler et appliquer des effets graphiques de manière prédictible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/sharp resize 500 \
  --min \
  -i images/*.png \
  --output ./images/thumbs</pre>
</div>
</div>
<div class="paragraph">
<p>La commande précédente illustre une opération de redimensionnement d&#8217;images&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>d&#8217;une dimension de 500 pixels de largeur&#160;;</p>
</li>
<li>
<p>minimum, pour respecter les proportions initiales&#160;– sans cet attribut les images seraient des carrés
de 500 pixels de large et de haut&#160;;</p>
</li>
<li>
<p>ciblant toutes les images PNG du répertoire <code>images</code>&#160;;</p>
</li>
<li>
<p>puis exportées dans le répertoire <code>images/thumbs</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/sharp grayscale \
  -i images/*.png \
  --output ./images/square</pre>
</div>
</div>
<div class="paragraph">
<p>À l&#8217;inverse, cette commande illustre la conversion en noir et blanc
d&#8217;images ainsi que leur export dans un répertoire différent.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface en ligne de commande de <em>sharp-cli</em> ne permet pas de créer
des opérations composites (redimensionner et convertir en niveaux de gris par exemple).
Il faudra recourir à l&#8217;API Node de <em>sharp</em> et chaîner les opérations en
s&#8217;aidant des exemples documentés sur <span class="URL"><a href="http://sharp.dimens.io" class="bare">sharp.dimens.io</a></span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> gm</div>
<div class="paragraph">
<p><em>gm</em>&#160;(<span class="URL"><a href="https://npmjs.com/gm" class="bare">npmjs.com/gm</a></span>) est le module classique de
redimensionnement dans l&#8217;écosystème Node.
Il s&#8217;interface avec les programmes <em>GraphicsMagick</em> et <em>ImageMagick</em>&#160;–
et nécessite donc leur présence sur le système d&#8217;exploitation.</p>
</div>
<div class="paragraph">
<p>Cela rend l&#8217;utilisation de <em>gm</em> légèrement moins triviale que celle de <em>sharp</em>
mais la quantité de ressources et la qualité du module en font une bonne
alternative à considérer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation d&#8217;un <a href="../chapter-05/index.html#npm-scripts">script&#160;<code>npm</code></a>
(<a href="../chapter-05/index.html">chapitre&#160;5</a>) est idéale pour décrire les
différentes actions d&#8217;optimisation.
Les scripts sont alors à invoquer manuellement, sur un crochet Git
(<em>git&#160;hook</em>) ou automatiquement lors du déploiement avec un
<a href="../chapter-06/index.html#deploy.ci">service d&#8217;intégration continue</a>, par
exemple.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">7. Tester son code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>C&#8217;est bien connu&#160;: &#8220;lorsqu&#8217;on produit du code de qualité, écrire des tests est amplement superflu et ne sert qu&#8217;à nous ralentir&#8221;.</p>
</div>
<div class="paragraph">
<p>La réalité est tout autre et suit un paradigme très simple&#160;:
<strong>plus il y a de lignes de code, plus il y a de risques de commettre des erreurs</strong>.
Cela vaut aussi bien pour du HTML que du CSS ou encore de l&#8217;ECMAScript.</p>
</div>
<div class="paragraph">
<p>Cette dernière section nous aidera à comprendre quoi et comment tester
pour diminuer le coût de maintenance de nos applications.</p>
</div>
<div class="sect2">
<h3 id="testing-101">7.1. Que tester ?</h3>
<div class="paragraph">
<p>L&#8217;idée d&#8217;écrire des tests pour améliorer la qualité de son code est attrayante,
mais quand on ne sait pas quoi tester et ni à qui demander pour se lancer,
il est évident qu&#8217;on ne va pas s&#8217;y mettre pour s&#8217;assurer que 1+1 valent bien 2.</p>
</div>
<div class="paragraph">
<p>Je pense à ces trois règles lorsque je souhaite écrire des tests&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Qu&#8217;est-ce qui est public/exporté&#160;?</p>
</li>
<li>
<p>Qu&#8217;est-ce qui crée des branches dans mon code&#160;?</p>
</li>
<li>
<p>Qu&#8217;est-ce qui vient du monde extérieur&#160;?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La syntaxe de modules ECMAScript est idéale pour visualiser les segments
de code qui sont exportés par nos différents fichiers.
Élément marquant&#160;: ce code est simple et devrait arriver à compter le nombre
de mots mais nous n&#8217;avons aucune idée s&#8217;il fera correctement le travail sans
l&#8217;exécuter dans une application.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">test-export.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">isString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">thing</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">typeof</span> thing <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">isWord</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">word</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">isString</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> <span class="token regex">/^[\w\s.,\-?!;+]{2,}$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">countWords</span> <span class="token punctuation">(</span><span class="token parameter">sentence</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">return</span> sentence<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isWord<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La fonction <code>countWords</code> est le seul élément exporté par notre module et devrait donc être le seul sujet de nos&#160;tests.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Une branche est une portion de code qui s&#8217;exécute de manière ponctuelle.
Ces sections de code s&#8217;activent ou non selon l&#8217;état d&#8217;une structure de données.
Il faut prévoir au moins autant de tests que de branches pour valider les
attentes.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">test-branches.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">isOdd</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isFinite</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'number devrait être un nombre'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Première branche activée dans deux cas de figure.</p>
</li>
<li>
<p>Seconde branche.</p>
</li>
<li>
<p>Troisième branche.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Enfin, l&#8217;accès à toute donnée externe est susceptible de mal fonctionner
sans que nous puissions maîtriser l&#8217;origine des problèmes.
En revanche, l&#8217;écriture de tests nous aidera à accepter ce cas de figure et
à le signaler à nos applications.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">test-outside-world.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getLinkElementContent</span> <span class="token punctuation">(</span><span class="token parameter">linkElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>href<span class="token punctuation">}</span> <span class="token operator">=</span> linkElement<span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(1)</b></span>

  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>                    <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">pkg</span> <span class="token operator">=></span> pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>linkElement</code> peut ne pas être un lien hypertexte (<code>document.querySelector</code> retourne&#160;<code>null</code>).</p>
</li>
<li>
<p>Ici, tout peut arriver&#160;: <code>href</code> n&#8217;est pas une URL valide (balise <code>href</code> vide), serveur indisponible, etc.</p>
</li>
<li>
<p>Et là, le fichier JSON peut être mal formé ou la réponse est exprimée dans un autre format que&#160;JSON.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous savons désormais à peu près tout ce qu&#8217;il faut suspecter pour renforcer
nos applications en écrivant quelques tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="soutiller_pour_écrire_des_assertions">7.2. S&#8217;outiller pour écrire des assertions</h3>
<div class="paragraph">
<p>Avant de nous lancer directement dans la conception et l&#8217;écriture des tests,
penchons-nous sur la structure de l&#8217;outillage.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Assertion</dt>
<dd>
<p>C&#8217;est la vérification d&#8217;une vérité, d&#8217;une attente, du résultat d&#8217;une opération.
Une assertion couvre une branche de&#160;code.</p>
</dd>
<dt class="hdlist1">Test</dt>
<dd>
<p>C&#8217;est un regroupement d&#8217;assertions couvrant toutes les branches des
fonctionnalités publiques de notre&#160;code.</p>
</dd>
<dt class="hdlist1">Suite de tests</dt>
<dd>
<p>C&#8217;est un ensemble de tests couvrant un aspect logique d&#8217;un code applicatif.
Une application peut comporter plusieurs suites selon sa complexité&#160;:
tests <strong>unitaires</strong> (interface de code),
tests <strong>fonctionnels</strong> (scénarios d&#8217;utilisation d&#8217;une application),
tests d'<strong>intégration</strong> (dépendance vis à vis d&#8217;autres applications et services).</p>
</dd>
<dt class="hdlist1">Exécuteur de tests</dt>
<dd>
<p>C&#8217;est le logiciel responsable de créer l&#8217;environnement d&#8217;exécution d&#8217;une suite de tests.
Il exprime une opinion sur la structuration des tests ainsi que sur des
automatismes à fournir pour accélérer l&#8217;écriture des&#160;tests.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>L&#8217;outillage varie selon chacun de ces niveaux.
Certains outils offrent une écriture d&#8217;assertion plus fluide, d&#8217;autres proposent une écriture plus spécifiquement adaptée.</p>
</div>
<div class="paragraph">
<p>Les sections suivantes sont complémentaires.
J&#8217;ai favorisé des approches itératives et modulaires pour faciliter l&#8217;ajout ou le retrait de tout outil de notre outillage&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la bibliothèque <em>chai</em> pour les assertions&#160;;</p>
</li>
<li>
<p>la bibliothèque <em>mocha</em> pour les tests&#160;;</p>
</li>
<li>
<p>la bibliothèque <em>mocha</em> pour la suite de tests exécutable par&#160;Node&#160;;</p>
</li>
<li>
<p>l&#8217;exécuteur de tests nommé  <em>karma</em> pour faire fonctionner la suite de tests
dans les navigateurs.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> chai, mocha et karma</div>
<div class="paragraph">
<p>Ces trois bibliothèques disposent d&#8217;une documentation en ligne expliquant leurs
options respectives, ainsi que des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>chai</em>&#160;: <span class="URL"><a href="http://chaijs.com/api/bdd/" class="bare">chaijs.com/api/bdd/</a></span>&#160;;</p>
</li>
<li>
<p><em>mocha</em>&#160;: <span class="URL"><a href="https://mochajs.org" class="bare">mochajs.org</a></span>&#160;;</p>
</li>
<li>
<p><em>karma</em>&#160;: <span class="URL"><a href="https://karma-runner.github.io" class="bare">karma-runner.github.io</a></span>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">Exemple d&#8217;assertion avec la bibliothèque&#160;chai</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>expect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span><span class="token punctuation">;</span>

<span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">Exemple de test avec la bibliothèque mocha</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'functionName'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should succeed with parameter cheese'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should throw an error with parameter meat'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Exemple d&#8217;exécution de suites de tests avec mocha et karma</div>
<div class="content">
<pre><span data-bash-subs="$"></span>mocha tests/**/*.js
<span data-bash-subs="$"></span>karma start</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exécuteur de tests <em>karma</em> se configure par le biais d&#8217;un fichier <code>karma.conf.js</code>.
Nous en trouverons un à la racine du répertoire des ressources du
<a href="../chapter-04/index.html">chapitre&#160;4</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="tester_ses_composants_react_sans_navigateur">7.3. Tester ses composants React sans navigateur</h3>
<div class="paragraph">
<p>Un des points forts de <a href="#react">React</a> évoqués dans ce chapitre est la
description de son rendu à même le composant.
Nous bénéficions ainsi du résultat final (son HTML par exemple) ainsi que d&#8217;un
arbre représentant une structure de sous-éléments et de propriétés.</p>
</div>
<div class="paragraph">
<p>Nous disposons de deux stratégies pour tester les différents comportements d&#8217;un
composant <em>React</em>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tester le rendu en comparant des chaînes de caractères&#160;;</p>
</li>
<li>
<p>tester l&#8217;état en validant la présence d&#8217;attributs ou le déclenchement de
certaines méthodes du composant.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La bibliothèque <em>Enzyme</em> (<span class="URL"><a href="https://npmjs.com/enzyme" class="bare">npmjs.com/enzyme</a></span>) s&#8217;occupe très bien des
deux, en plus de s&#8217;intégrer avec n&#8217;importe quelle bibliothèque de tests.
Dans tous les cas, elle nous permettra de monter nos composants, soit de manière
isolée, soit dans un véritable arbre DOM, soit en rendu&#160;HTML.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Enzyme</div>
<div class="paragraph">
<p>L&#8217;équipe d&#8217;Airbnb offre une documentation exhaustive sur <span class="URL"><a href="http://airbnb.io/enzyme/" class="bare">airbnb.io/enzyme/</a></span>.
J&#8217;ai beaucoup apprécié les exemples complets d&#8217;intégration avec
<em>mocha</em>, <em>webpack</em> et&#160;<em>tape</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons nous baser sur le composant créé dans la section
&#8220;<a href="#react">Rapprocher données, rendu et interactions avec React</a>&#8221; pour s&#8217;assurer
de son comportement avant même de l&#8217;inclure dans notre application.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests/date-interval.js (configuration)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> expect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> shallow <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'enzyme'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> DateInterval <span class="token keyword">from</span> <span class="token string">'../modules/date-interval.jsx'</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;DateInterval />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ... (tests)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Import du module <code>DateInterval</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notre premier test consiste à vérifier que notre composant React génère
bien une balise <code>&lt;time&gt;</code> en sortie.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests/date-interval.js (tests)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">// (configuration)</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;DateInterval />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>DateInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'affiche un élément &lt;time>'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>               <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(2)</b></span>

    <span class="token function">expect</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>have<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création d&#8217;un test destiné à vérifier la nature de la balise HTML à générer.</p>
</li>
<li>
<p>Création du composant isolé (<em>shallow</em>)&#160;– aucun élément DOM ne sera créé ni inséré dans le document.</p>
</li>
<li>
<p>On écrit une assertion garantissant que l&#8217;on retourne un élément <code>&lt;time&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le deuxième aspect à tester concerne les données du composant, et leur effet
sur la valeur de classe de l&#8217;élément HTML généré en sortie.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests/date-interval.js (tests, suite)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">// (configuration)</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;DateInterval />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>DateInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'la propriété tickDate influence la classe HTML'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">OK_CLASS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'pair'</span><span class="token punctuation">,</span> <span class="token string">'impair'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>tickData<span class="token punctuation">}</span> <span class="token operator">=</span> component<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(2)</b></span>

    <span class="token keyword">const</span> time <span class="token operator">=</span> tickData<span class="token punctuation">.</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">closeTo</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token function">expect</span><span class="token punctuation">(</span>tickData<span class="token punctuation">.</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">oneOf</span><span class="token punctuation">(</span><span class="token constant">OK_CLASS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création d&#8217;un second composant isolé dont l&#8217;état est indépendant du premier.</p>
</li>
<li>
<p>Récupération de l&#8217;état (<em>state</em>) du composant.</p>
</li>
<li>
<p>Assertion vérifiant que la date utilisée par le composant est proche de la date courante (à quelques millisecondes&#160;près).</p>
</li>
<li>
<p>Assertion vérifiant qu&#8217;une propriété de l&#8217;état ne peut être qu&#8217;une des deux valeurs parmi <code>pair</code> et <code>impair</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En complément, la bibliothèque <em>chai-enzyme</em> (<span class="URL"><a href="https://npmjs.com/chai-enzyme" class="bare">npmjs.com/chai-enzyme</a></span>)
étend le vocabulaire de <em>chai</em> pour ajouter des assertions de composants.
C&#8217;est une question de goût plus qu&#8217;une nécessité.<br>
L&#8217;exemple suivant reprend le composant créé dans la section
&#8220;<a href="#livereload">Changements en temps&#160;réel dans le navigateur</a>&#8221; et illustre une
assertion suite à un clic sur le bouton&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests/button-count.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> chai<span class="token punctuation">,</span> <span class="token punctuation">{</span> expect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> chaiEnzyme <span class="token keyword">from</span> <span class="token string">'chai-enzyme'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> shallow <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'enzyme'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ButtonCount <span class="token keyword">from</span> <span class="token string">'../livereload/button-count.jsx'</span><span class="token punctuation">;</span>

chai<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">chaiEnzyme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;ButtonCount />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should increment state on click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>       <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>ButtonCount <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    component<span class="token punctuation">.</span><span class="token function">simulate</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(2)</b></span>

    <span class="token function">expect</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>have<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'clickCount'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le libellé du test décrit le résultat attendu dans les assertions.</p>
</li>
<li>
<p>Simulation du clic sur le composant.</p>
</li>
<li>
<p>L&#8217;état interne a bien été changé et correspond à la valeur attendue.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le fichier <code>package.json</code> des ressources de ce chapitre
contient une tâche exécutant les tests exécutables dans un environnement Node uniquement.
Elle se lance de la manière suivante&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>npm run test:node</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/mocha-react.png" alt="mocha react" width="80%">
</div>
<div class="title">Figure 8. Extrait de la sortie de la commande npm&#160;run&#160;test:node</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> jest</div>
<div class="paragraph">
<p><em>jest</em> (<span class="URL"><a href="https://npmjs.com/jest" class="bare">npmjs.com/jest</a></span>) est un exécuteur de tests moderne et
rapide particulièrement adapté au test de composants côté serveur.
Au moment d&#8217;écrire cet ouvrage, il n&#8217;était pas encore possible de l&#8217;exécuter
dans un navigateur.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est intéressant de retenir que les tests navigateurs ne sont pas indispensables
pour s&#8217;assurer du bon fonctionnement de nos composants.
Des bibliothèques comme <em>React</em> sont déjà solidement testées.
Cela nous laisse l&#8217;opportunité de nous concentrer uniquement sur notre logique métier.</p>
</div>
<div class="paragraph">
<p>Les tests navigateurs sont en revanche utiles pour tester la compatibilité
navigateurs, que ce soit au niveau de la syntaxe ECMAScript ou du rendu&#160;CSS.</p>
</div>
</div>
<div class="sect2">
<h3 id="tester_code_et_composants_dans_les_navigateurs">7.4. Tester code et composants dans les navigateurs</h3>
<div class="paragraph">
<p>C&#8217;est bien beau de tester uniquement l&#8217;interface de composants <em>React</em>
(ou autre technologie) mais comment faire lorsqu&#8217;on a besoin de tester avec un
vrai DOM ou dans plusieurs navigateurs&#160;?</p>
</div>
<div class="paragraph">
<p>Il est nécessaire d&#8217;effectuer des tests dans des navigateurs pour&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>s&#8217;assurer de la compatibilité de notre code avec les variations d&#8217;implémentation de navigateurs&#160;;</p>
</li>
<li>
<p>valider notre choix de <em>polyfills</em>&#160;;</p>
</li>
<li>
<p>tester fidèlement contre des API de navigateurs ou du DOM (comme <em>Web&#160;Audio</em> ou
<em>Service&#160;Workers</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Autrement dit, nous avons besoin d&#8217;un exécuteur de tests qui les fasse fonctionner
dans l&#8217;environnement d&#8217;un navigateur.
Idéalement, nous voulons que cet exécuteur de tests n&#8217;influe pas sur l&#8217;outillage
employé pour écrire nos tests et donc nous permette d&#8217;utiliser <em>mocha</em> et <em>chai</em>
comme dans la section précédente.</p>
</div>
<div class="paragraph">
<p><em>karma</em> (<span class="URL"><a href="https://npmjs.com/karma" class="bare">npmjs.com/karma</a></span>) est l&#8217;outil phare de l&#8217;écosystème
Node dédié aux tests dans les navigateurs.
Il a été créé en&#160;2012 pour faciliter l&#8217;exécution des suites de tests de la
bibliothèque <em>Angular</em> et s&#8217;exécute en ligne de commandes.</p>
</div>
<div class="paragraph">
<p>Les fonctionnalités de <em>karma</em> s&#8217;étendent à l&#8217;aide de modules&#160;<code>npm</code>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>intégrations avec des suites de tests&#160;;</p>
</li>
<li>
<p>lanceurs de navigateurs&#160;;</p>
</li>
<li>
<p>préprocesseurs pour transformer des fichiers, les servir et/ou les inclure
dans l&#8217;environnement de tests.</p>
</li>
</ul>
</div>
<div class="videoblock">
<div class="title">Exemple de tests multi-navigateurs en continu avec <em>karma</em></div>
<div class="content">
<video src="./videos/karma-browsers.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Le pilotage de <em>karma</em> se fait via un fichier de configuration <code>karma.conf.js</code>.
Il est possible de surcharger ultérieurement cette configuration avec des
arguments de la ligne de commandes.</p>
</div>
<div class="listingblock">
<div class="title">Initialisation automatique d&#8217;un fichier de configuration <code>karma.conf.js</code></div>
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/karma init</pre>
</div>
</div>
<div class="paragraph">
<p><em>karma</em> fonctionne avec des navigateurs installés sur notre machine de
développement tout comme avec des services distants comme <em>SauceLabs</em> ou
<em>BrowserStack</em> (voir &#8220;<a href="#ci">Intégration continue et compatibilité navigateurs</a>&#8221;).
Les navigateurs doivent déjà être disponibles sur la machine de test (Firefox
et Chrome par exemple) et nous devons en parallèle installer les lanceurs
(<code>karma-firefox-launcher</code> et <code>karma-chrome-launcher</code> respectivement).</p>
</div>
<div class="paragraph">
<p>Les navigateurs lancés par défaut lors des tests sont listés dans l&#8217;option <code>browsers</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L49</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">autoWatch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>karma</em> se charge d&#8217;inclure les fichiers ECMAScript ou de servir des fichiers
statiques en fonction de motifs de chemins.
Ces fichiers peuvent être locaux (de préférence) ou distants et même de
types différents comme JSON ou&#160;HTML.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L7-17</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">files<span class="token punctuation">:</span> <span class="token punctuation">[</span>
  <span class="token comment">//'https://cdn.polyfill.io/v2/polyfill.min.js',  // <b class="conum">(1)</b></span>
  <span class="token string">'examples/tests-browser/**/*.js'</span><span class="token punctuation">,</span>                <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token string">'examples/tests/**/*.js'</span><span class="token punctuation">,</span>
  <span class="token string">'examples/tests-browser/**/*.html'</span><span class="token punctuation">,</span>              <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">{</span>
    pattern<span class="token punctuation">:</span> <span class="token string">'package.json'</span><span class="token punctuation">,</span>                       <span class="token comment">// <b class="conum">(4)</b></span>
    served<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    included<span class="token punctuation">:</span> <span class="token boolean">false</span>                                <span class="token comment">// <b class="conum">(5)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Il suffirait de décommenter cette ligne pour inclure les <a href="#polyfills"><em>polyfills</em> de navigateurs</a> sans toucher à notre&#160;code.</p>
</li>
<li>
<p>Inclusion des fichiers de tests&#160;– ils sont appelés dans des balises HTML <code>&lt;script&gt;</code>.</p>
</li>
<li>
<p>Inclusion de fichiers HTML&#160;– ils sont accessibles via&#160;HTTP.</p>
</li>
<li>
<p>Mise à disposition du fichier <code>package.json</code>&#160;– accessible via HTTP à l&#8217;adresse <code>/base/package.json</code>.</p>
</li>
<li>
<p>Indique que ce fichier ne doit pas être inclus dans une balise HTML <code>&lt;script&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Des intégrations doivent être déclarées pour augmenter les fonctionnalités de
base de <em>karma</em>.
Ces dernières se résument à charger des fichiers ECMAScript
dans une balise <code>&lt;script&gt;</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;extrait de configuration suivant illustre le chargement des plug-ins pour
<em>Browserify</em> (modules <em>CommonJS</em> et transpilation), <em>mocha</em> (suites de tests)
et <em>fixture</em> (données représentant des cas d&#8217;utilisation)&#160;– respectivement
les modules <code>npm</code> <code>karma-browserify</code>, <code>karma-mocha</code> et <code>karma-fixture</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L5</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">frameworks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'browserify'</span><span class="token punctuation">,</span> <span class="token string">'mocha'</span><span class="token punctuation">,</span> <span class="token string">'fixture'</span><span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une fois encore, des motifs de chemins sont utilisés pour indiquer aux plug-ins
leur responsabilité de prise en charge.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L21-25</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">preprocessors<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token string">'examples/tests/**/*.js'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'browserify'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token string">'examples/tests-browser/**/*.js'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'browserify'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">'examples/tests-browser/**/*.html'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'html2js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ces fichiers seront transpilés par <em>browserify</em> avant d&#8217;être chargés dans les tests de navigateurs.</p>
</li>
<li>
<p>Ces fichiers seront pris en charge par le préprocesseur nommé <em>html2js</em>, utilisé par <code>karma-fixture</code> pour transformer du HTML en arbre&#160;DOM.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous avons vu un exemple de code reposant sur un élément du DOM dans la section
&#8220;<a href="#testing-101">Que tester&#160;?</a>&#8221;.
Nous allons nous intéresser à une manière possible de tester la fonction
exportée <code>getLinkElementContent()</code> en se basant sur un véritable appel HTTP et
un véritable élément du DOM, créé à partir du fichier de <em>fixture</em> suivant&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests-browser/fixtures/link-package.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/base/package.json<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce fichier de fixture est chargé dans le DOM par le plug-in <code>karma-fixture</code>
pour prouver que l&#8217;on peut récupérer les dépendances exposées par le fichier
<code>package.json</code> des ressources de ce chapitre&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests-browser/test-outside-world.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> expect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getLinkElementContent <span class="token keyword">from</span> <span class="token string">'../test-outside-world.js'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'getLinkElementContent'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fixture<span class="token punctuation">.</span><span class="token function">setBase</span><span class="token punctuation">(</span><span class="token string">'examples/tests-browser/fixtures'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'fetches dependencies from remote package.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>link<span class="token punctuation">]</span> <span class="token operator">=</span> fixture<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'link-package.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span>

    <span class="token keyword">return</span> <span class="token function">getLinkElementContent</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">deps</span> <span class="token operator">=></span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(3)</b></span>
      <span class="token function">expect</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>contain<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>                 <span class="token comment">// <b class="conum">(4)</b></span>
        <span class="token string">'@babel/core'</span><span class="token punctuation">,</span> <span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'enzyme'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>before()</code> indique à <em>mocha</em> d&#8217;exécuter ce bloc de code avant tout&#160;test.</p>
</li>
<li>
<p>Appel du plug-in de fixture pour obtenir l&#8217;élément du DOM nécessaire à la fonction <code>getLinkElementContent()</code>.</p>
</li>
<li>
<p>Appel réel de la fonction <code>getLinkElementContent()</code>, résolu comme une <a href="../chapter-03/index.html#promise">promesse</a> et dont nous testons le résultat à la ligne suivante.</p>
</li>
<li>
<p>Assertion vérifiant que le résultat contient bien les clés de dépendances&#160;<code>npm</code> attendues&#160;– nous avons bien récupéré le bon fichier et le bon contenu&#160;!</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;invocation de <em>karma</em> se fait en invoquant <code>./node_modules/.bin/karma start</code>.
Par mesure de simplicité, cette commande a été abstraite en tant que
<a href="../chapter-05/index.html#npm-scripts">script&#160;<code>npm</code></a>&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Exécution ponctuelle de karma</div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm run test:browser</pre>
</div>
</div>
<div class="paragraph">
<p>Les tests peuvent être relancés en continu&#160;– dès qu&#8217;un fichier change&#160;– en
désactivant l&#8217;exécution unique (<em>single run</em>).
C&#8217;est idéal lorsque les tests sont écrits en parallèle de l&#8217;implémentation du
code ou que des ajustements fréquents ont lieu en phase de développement&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Exécution continue de karma</div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm run test:browser -- --no-single-run</pre>
</div>
</div>
<div class="paragraph">
<p>Comme tout processus de longue durée, il s&#8217;interrompt à l&#8217;aide de la combinaison
de touches <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span>.</p>
</div>
<div class="paragraph">
<p>Nous en savons désormais suffisamment pour tester dans les conditions des
navigateurs avec du code modulaire et réutilisable.
La question qui se pose désormais est la suivante&#160;:
<strong>comment faire pour tester plusieurs versions d&#8217;un même navigateur</strong>, pour
tester sur un système d&#8217;exploitation que l&#8217;on n&#8217;a pas ou encore plusieurs
terminaux mobiles de type <em>smartphone</em> ou tablette&#160;?</p>
</div>
</div>
<div class="sect2">
<h3 id="ci">7.5. Intégration continue et compatibilité navigateurs</h3>
<div class="paragraph">
<p>Deux cas de figure se présentent en complément de la section précédente&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la difficulté d&#8217;accès à certaines combinaisons navigateur + système d&#8217;exploitation&#160;;</p>
</li>
<li>
<p>l&#8217;envie d&#8217;automatiser les tests de navigateurs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sous Windows, il sera difficile de tester la version macOS de Safari.
Inversement, sous macOS, il sera difficile de tester
Internet&#160;Explorer ou Edge.
Que dire d&#8217;anciennes versions de navigateurs Android, dont la rapidité de
développement et donc la compatibilité sont bien en-deçà des versions de Chrome
pour ordinateur ou mobile&#160;?</p>
</div>
<div class="videoblock">
<div class="title">Exemple de tests multi-navigateurs en continu avec karma et BrowserStack</div>
<div class="content">
<video src="./videos/karma-browserstack.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>L&#8217;écosystème de modules&#160;<code>npm</code> liés à <em>karma</em> s&#8217;est déjà penché sur la question.
C&#8217;est le cas notamment du produit <em>BrowserStack</em> qui offre une intégration pour
déléguer l&#8217;exécution des tests sur leur plate-forme commerciale.
Il s&#8217;agit du module <code>karma-browserstack-launcher</code>
(<span class="URL"><a href="https://npmjs.com/karma-browserstack-launcher" class="bare">npmjs.com/karma-browserstack-launcher</a></span>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> BrowserStack</div>
<div class="paragraph">
<p>La documentation de <em>BrowserStack</em> (<span class="URL"><a href="https://www.browserstack.com/automate/node" class="bare">www.browserstack.com/automate/node</a></span>)
décrit les différents systèmes d&#8217;exploitation à disposition ainsi que les
navigateurs compatibles, pour PC, Mac, iOS et Android.</p>
</div>
<div class="paragraph">
<p>L&#8217;intégration avec Node est également documentée au cas où vous souhaiteriez
effectuer des tests sans passer par <em>karma</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>BrowserStack</em> n&#8217;est pas un navigateur en soi, mais offre un accès à une multitude
de navigateurs.
Il faut donc créer de nouvelles configurations dans la propriété <code>customLaunchers</code>.
L&#8217;extrait de configuration suivant illustre la création d&#8217;un navigateur Safari
pour iPhone&#160;4S sous iOS&#160;5.1.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L51-58</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

customLaunchers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  iphone4<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    base<span class="token punctuation">:</span> <span class="token string">'BrowserStack'</span><span class="token punctuation">,</span>
    device<span class="token punctuation">:</span> <span class="token string">'iPhone 4S'</span><span class="token punctuation">,</span>
    os<span class="token punctuation">:</span> <span class="token string">'ios'</span><span class="token punctuation">,</span>
    os_version<span class="token punctuation">:</span> <span class="token string">'5.1'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <em>BrowserStack</em> nécessite un compte et l&#8217;obtention d&#8217;une clé
d&#8217;API afin d&#8217;utiliser leur service.
Notre nom d&#8217;utilisateur et la clé d&#8217;API doivent être renseignés en tant que
variables d&#8217;environnement pour établir une connexion au service et démarrer
notre bon vieil iPhone&#160;4&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>export BROWSER_STACK_USERNAME=...
<span data-bash-subs="$"></span>export BROWSER_STACK_ACCESS_KEY=...
<span data-bash-subs="$"></span>npm run test:browser -- --browsers iphone4</pre>
</div>
</div>
<div class="paragraph">
<p><em>BrowserStack</em> est configurable plus finement selon nos besoins.
Le réglage suivant s&#8217;assure de faire transiter les données HTTP
(scripts, HTML) via la connexion sécurisée entre notre ordinateur et
<em>BrowserStack</em>.
C&#8217;est un réglage utile en cas de proxy exigeant ou de
réglages de connexion à Internet bien spécifiques.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L41-43</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">browserStack<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  forcelocal<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> Sauce&#160;Labs</div>
<div class="paragraph">
<p><em>Sauce&#160;Labs</em> (<span class="URL"><a href="https://saucelabs.com" class="bare">saucelabs.com</a></span>) est un concurrent de <em>BrowserStack</em>.
Il offre des fonctionnalités similaires et il est gratuit pour les projets open source.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Indépendamment de <em>BrowserStack</em>, l&#8217;intégration continue est un mécanisme
permettant l&#8217;exécution automatique des tests, de manière reproductible et
dans un environnement systématiquement propre&#160;– sans trace d&#8217;exécution d&#8217;un
précédent&#160;test.</p>
</div>
<div class="paragraph">
<p>Cela a deux avantages indéniables&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>exécuter les tests pour tout changement de code, peu importe qui en est l&#8217;auteur&#160;;</p>
</li>
<li>
<p>s&#8217;assurer de l&#8217;exécution systématique des tests&#160;;</p>
</li>
<li>
<p>mettre en commun la logique d&#8217;exécution de tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On évite ainsi les <em>oublis</em> tout en enlevant le coût de mise en place de
l&#8217;infrastructure de tests chez des personnes contribuant de manière occasionnelle.
Cerise sur le gâteau, on prévient en partie les régressions&#160;– changements qui
cassent le fonctionnement attendu d&#8217;une fonctionnalité.</p>
</div>
<div class="paragraph">
<p>Le service Travis&#160;CI (<span class="URL"><a href="https://travis-ci.com" class="bare">travis-ci.com</a></span>) est un service
d&#8217;intégration continue (<em>Continuous Integration</em>, <em>CI</em>) parmi d&#8217;autres, mais
qui a été rendu populaire pour son intégration avec GitHub.
Il est gratuit pour les projets open source.</p>
</div>
<div class="paragraph">
<p>Un service d&#8217;intégration continue est configuré pour définir ce qui est
exécuté avant, pendant et après les tests.
Il a donc l&#8217;avantage de faciliter l&#8217;automatisation des tests de navigateurs
à même la machine virtuelle (<em>Virtual Machine</em>, <em>VM</em>) de test ou bien
vers des plates-formes comme <em>BrowserStack</em>.
Son mécanisme de variables d&#8217;environnement cryptées nous évitera de donner
accès à notre compte au premier&#160;venu.</p>
</div>
<div class="paragraph">
<p>Un fichier de configuration minimal au format YAML est nécessaire.
Des services comme GitHub facilitent la connexion avec Travis&#160;CI et
déclenchent automatiquement l&#8217;exécution des tests à chaque <em>commit</em>
ou <em>pull&#160;request</em>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">.travis.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml"><span class="token key atrule">language</span><span class="token punctuation">:</span> node_js             <span class="token comment"># <b class="conum">(1)</b></span>
<span class="token key atrule">node_js</span><span class="token punctuation">:</span> v10                  <span class="token comment"># <b class="conum">(2)</b></span>

<span class="token key atrule">addons</span><span class="token punctuation">:</span>
  <span class="token key atrule">firefox</span><span class="token punctuation">:</span> latest             <span class="token comment"># <b class="conum">(3)</b></span>

<span class="token key atrule">env</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> MOZ_HEADLESS=1                                      <span class="token comment"># <b class="conum">(4)</b></span>
<span class="token punctuation">-</span> BROWSER_STACK_USERNAME="$BROWSER_STACK_USERNAME"    <span class="token comment"># <b class="conum">(5)</b></span>
<span class="token punctuation">-</span> BROWSER_STACK_ACCESS_KEY="$BROWSER_STACK_ACCESS_KEY"

<span class="token key atrule">script</span><span class="token punctuation">:</span> npm run test<span class="token punctuation">:</span>browser <span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>browsers Firefox</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configuration de la&#160;VM pour utiliser&#160;Node.</p>
</li>
<li>
<p>Configuration de la&#160;VM pour utiliser la version la plus récente de Node&#160;v10.</p>
</li>
<li>
<p>Installation de la dernière version stable de Firefox.</p>
</li>
<li>
<p>La variable d&#8217;environnement <code>MOZ_HEADLESS</code> indique à Firefox de démarrer sans afficher d&#8217;interface graphique à l&#8217;écran.</p>
</li>
<li>
<p>J&#8217;ai paramétré la clé d&#8217;accès à <em>BrowserStack</em> dans les réglages de <a href="#travis-ci">Travis&#160;CI</a> (voir encadré).</p>
</li>
</ol>
</div>
<div id="travis-ci" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Travis&#160;CI</div>
<div class="paragraph">
<p>Des services comme Travis&#160;CI sont puissants et amplement configurable
pour de nombreux besoins&#160;– dont Node (<span class="URL"><a href="https://docs.travis-ci.com/user/languages/javascript-with-nodejs/" class="bare">docs.travis-ci.com/user/languages/javascript-with-nodejs/</a></span>)&#160;–
et y&#160;compris pour se connecter à des bases de données PostgreSQL ou MariaDB.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/travis-ci-encrypted-env.png" alt="travis ci encrypted env" width="85%">
</div>
<div class="title">Figure 9. Écran de paramétrage des variables d&#8217;environnement secrètes sur Travis&#160;CI</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">8. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous sommes désormais en mesure d'<strong>exécuter des tests unitaires</strong> impliquant
des <strong>navigateurs web</strong> sur notre machine, sur des <strong>services distants</strong> mais
également de manière automatique avec des services d'<strong>intégration continue</strong>
comme Travis&#160;CI.</p>
</div>
<div class="paragraph">
<p>Le recours aux modules&#160;<code>npm</code> combinés aux modules ECMAScript facilite
<strong>la conception et la maintenance de code testable et réutilisable</strong>.</p>
</div>
<div class="paragraph">
<p>Ces pratiques de modularisation&#160;– jusqu&#8217;au rendu intermédiaire de <em>React</em>
– incitent à la <strong>rigueur qui a un effet positif</strong> sur la qualité de notre
code et renforce notre confiance à le déployer en production.</p>
</div>
</div>
</div>
</div>
<section class="next">
  <a href="#top">Haut de page</a> ou
  <a href="https://oncletom.io/node.js/#apprendre-node-js-en-ligne" class="read-more">retour au sommaire</a>.
</section>
</body>
</html>