<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Cr√©er une application front-end</title>
<style>
#header,
#content,
#footer {
  margin: 2rem auto;
  max-width: 46rem;
}

#header {
  margin-top: 0;
}

.title,
#toctitle {
  color: var(--dark-accent);
}

a {
  /* white-space: nowrap; */
}

img, iframe, video, audio {
  max-width: 100%;
}

p {
  font-weight: normal;
}

/* Taken out from book.css */
dl dt {
  margin-bottom: 0.3125em;
  font-weight: bold;
}
dl dd {
  margin-bottom: 1.25em;
}

dt,
th.tableblock,
td.content,
div.footnote {
  text-rendering: optimizeLegibility;
}

.literalblock pre,
.literalblock pre[class],
.listingblock pre,
.listingblock pre[class] {
  overflow: auto;
  word-wrap: break-word;
}
.literalblock pre.nowrap,
.literalblock pre[class].nowrap,
.listingblock pre.nowrap,
.listingblock pre[class].nowrap {
  overflow-x: auto;
  white-space: pre;
  word-wrap: normal;
}

.listingblock {
  margin: 0 0 2em;
}
.listingblock > .content {
  position: relative;
}
.listingblock > .title {
  font-weight: bold;
}
.listingblock code[data-lang]::before {
  display: none;
  content: attr(data-lang);
  position: absolute;
  font-size: 0.75em;
  top: 1em;
  right: 1em;
  line-height: 1;
  text-transform: uppercase;
  color: #999;
}
.listingblock:hover code[data-lang]::before {
  display: block;
}
.listingblock.terminal pre .command::before {
  content: attr(data-prompt);
  padding-right: 0.5em;
  color: #999;
}

td.hdlist1,
td.hdlist2 {
  vertical-align: top;
  padding-right: 0.625em;
}
td.hdlist1 {
  font-weight: bold;
}
.literalblock + .colist,
.listingblock + .colist {
  margin-top: -1.5em;
}
.colist td:not([class]):first-child {
  padding: 0.4em 0.75em 0 0.75em;
  line-height: 1;
  vertical-align: top;
}
.colist td:not([class]):first-child img {
  max-width: none;
}
.colist td:not([class]):last-child {
  padding: 0.25em 0;
}

/* Custom classes */

.line-through {
  text-decoration: line-through;
}

.RemarquePreTitre,
#toctitle {
  font-style: normal;
  font-weight: bold;
}
  .RemarquePreTitre::after {
    content: "‚Ä¢";
    padding-left: 5px;
  }
.admonitionblock {
}
.admonitionblock > table,
.exampleblock {
  --commented: rgba(17, 17, 68, .65);
  --border-radius-base: 8px;

  background-color: #fafafa;
  border: 1px solid var(--dark-shade);
  border-left: none;
  border-right: none;
  margin: 1.5em 0;
  padding: 1em;
}
.exampleblock .title {
  font-weight: bold;
}
.icon .title {
  font-size: 2em;
}
  .admonitionblock > table td.icon {
    display: none;
  }

  @media screen and (min-width: 769px) {
    .admonitionblock > table td.icon {
      display: table-cell;
    }
  }

  .admonitionblock > table td.icon {
    padding-right: 1em;
  }
  .admonitionblock > table td.icon img {
    max-width: none;
  }

.colist ol {
  margin-left: 1.5em;  /* aligns with the listing edge */
  padding-left: 0;
  font-weight: bold;   /* makes it stand out more */
}
  .colist ol p {
    margin: 0 0 .5em;
  }
.listingblock:not(.prismjs) pre,
.language-bash.hljs {
  background: #323232;
  color: wheat;
  margin: 0;
  padding: 1rem;
}
.language-bash.hljs .hljs-built_in,
.language-bash.hljs .hljs-builtin-name {
  color: white;
}
.language-bash.hljs .hljs-string {
  color: lightgreen;
}
.language-bash.hljs .hljs-variable {
  color: lightskyblue;
}
.keyseq {
  font-weight: normal;
  white-space: nowrap;
}
.language-bash.hljs .keyseq {
  color: white;
}
.language-bash.hljs kbd {
  background: transparent;
  box-shadow: none;
  color: white;
  font-size: 0.8em;
  font-weight: bold;
  padding: 0.1em 0.4em;
}
.listingblock pre.highlightjs,
.listingblock.prismjs pre {
  background-color: transparent;
  margin: 0;
  padding: 0;
}
.listingblock pre.highlightjs > code,
.listingblock.prismjs .highlight {
  border-left: 4px solid var(--dark-accent);
  padding-left: 1em;
  font-size: .8em;
}
.listingblock pre.highlightjs > code.language-bash {
  border-left-color: limegreen;
}

.hdlist .hdlist1 {
  text-align: right;
  white-space: nowrap;
}

td > p:first-child {
  margin-top: 0;
}

.hljs-comment {
  font-style: normal !important;
}

#toc.toc2 a {
  text-decoration: none;
  white-space: normal;
}
  #toc.toc2 a:hover,
  #toc.toc2 a:focus {
    text-decoration: underline;
  }

#toc.toc2 ul {
  list-style: none;
}

  #toc.toc2 > ul {
    padding-left: 0;
  }

  #toc.toc2 ul ul {
    padding-left: 1em;
  }

@media screen and (min-width: 769px) {
  body {
    padding-left: 25vw !important;
  }

  #header,
  #content,
  #footer {
    margin-left: 0;
  }

  #toc.toc2 {
    height: 100%;
    left: 0;
    max-width: 20vw;
    overflow: auto;
    padding: 1rem;
    position: fixed;
    top: 0;
    z-index: 1000;
  }

  #toc.toc2 > ul {
    font-size: 0.85em;
  }

  #toc li.active > a[href^="#"],
  [id]:target {
    background: #ffc;
  }
}

.admonitionblock.context-callout > table {
  border-width: 5px;
  border-color: var(--brand-color);
}

</style>
<link rel="stylesheet" href="https://oncletom.io/styles/blog.css?v=v3.3.2">
<!-- WebMentions -->
<link rel="pingback" href="https://webmention.io/oncletom.io/xmlrpc">
<link rel="webmention" href="https://webmention.io/oncletom.io/webmention">
<!-- Open Graph -->
<meta property="og:type" content="book">
<meta property="og:book:author" content="Thomas Parisot">
<meta property="og:book:isbn" content="978-2212139938">
<meta property="og:book:release_date" content="978-2212139938">
<meta property="og:book:tag" content="Node.js">
<meta property="og:book:tag" content="JavaScript">
<meta property="og:book:tag" content="npm">
<meta property="og:book:tag" content="D√©veloppement front-end">
<meta property="og:book:tag" content="D√©veloppement back-end">
<meta property="og:locale" content="fr_FR">
<meta property="og:site_name" content="Node.js ‚Ä¢¬†Apprendre par la pratique">
<!-- Twitter OpenGraph -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@oncletom">
<meta name="twitter:creator" content="@oncletom">
<style type="text/css" class="prism-theme">/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<style type="text/css" class="extension-interactive-runner">[data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
  background-color: #fcfcfc;
  border: 1px solid #0c2;
  border-radius: 1px;
  color: #0c2;
  cursor: pointer;
  display: inline-block;
  font-weight: bold;
  padding: .5em 1em;
  top: -2em;
}

  [lang="en"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "‚ñ∂ run code";
  }
  [lang="fr"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "‚ñ∂ voir le r√©sultat";
  }
  .interactive--javascript code[data-label]:before {
    content: attr(data-label);
  }

.interactive iframe {
  position: absolute;
  visibility: hidden;
}

.interactive.status--loaded iframe {
  position: inherit;
  visibility: visible;
}

.interactive.status--loading {
  opacity: .5;
}
</style>
<script class="extension-interactive-runner">
(function(d){
  document.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://embed.runkit.com/';
    script.async = true;
    script.onload = function(){
      function makeListingInteractive (element){
  if (element.classList.contains('interactive--installed') || element.classList.contains('status--loading')) {
    return;
  }

  const code = element.querySelector('code');
  const nodeVersion = /interactive--runtime--node-([^\s]+)/.exec(element.className)[1];
  const isEndpoint = element.classList.contains('interactive--endpoint');
  const mode = isEndpoint ? 'endpoint' : null;
  let preamble = '';

  const source = code
    .textContent
    .replace(/\/\/\s*\(\d+\)$/gm, '')
    .replace(/^["']?use strict["'][; ]*\n/, '');

  if (isEndpoint) {
    preamble = `process.nextTick(() => {
      if (typeof module.exports === 'function') {
        exports.endpoint = module.exports;
      }
      else if (typeof server !== 'undefined') {
        exports.endpoint = server.listeners("request").pop();
      }
});`
  }

  element.classList.add('status--loading');

  // eslint-disable-next-line no-undef
  RunKit.createNotebook({
    nodeVersion,
    element,
    source,
    mode,
    preamble,
    onLoad: function(ntbk) {
      element.classList.add('interactive--installed');
      element.classList.remove('status--loading');
      element.classList.add('status--loaded');
      code.parentNode.setAttribute('hidden', true);

      ntbk.evaluate();
    }
  });
}
function installEvents () {
  function getParent(el, condition) {
    let parent = el;

    while(parent = parent.parentNode) {
      if (condition(parent)) {
        return parent;
      }
    }
  }

  function hasClass(className) {
    return function check(el) {
      return el.classList.contains(className);
    }
  }

  document.querySelector('body').addEventListener('click', function(el) {
    if (el.target.classList.contains('language-javascript') || el.target.classList.contains('language-js')) {
      const parentNode = getParent(
        el.target,
        hasClass('interactive--javascript')
      );

      makeListingInteractive(parentNode);
    }
  });
}
      installEvents();
      document.body.dataset.interactiveRuntime = 'loaded';
    };
    document.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
.listingblock [data-bash-subs]::before {
  content: attr(data-bash-subs) " ";
  opacity: .5; }

.listingblock [data-bash-conum]::before {
  content: "(" attr(data-bash-conum) ")";
  font-weight: bold;
  opacity: .7;
}</style>
<script>
(function(d){
  d.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://unpkg.com/menuspy@1.3.0/dist/menuspy.js';
    script.async = true;
    script.onload = () => new MenuSpy(document.querySelector('#toc'), {enableLocationHash: false});
    d.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
#toc li.active > a[href^="#"] {
  font-weight: bold;
}
#toc li.active > a[href^="#"]::before {
  content: "‚ñ∂ ";
  display: inline-block;
  position: absolute;
  margin-left: -1.2em;
  font-size: .8em;
  margin-top: 3px;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Cr√©er une application front-end</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table des mati√®res</div>
<ul class="sectlevel1">
<li><a href="#quel_rapport_entre_node_et_les_navigateursweb">1. Quel rapport entre Node et les navigateurs&#160;web ?</a></li>
<li><a href="#√©crire_d√®s_√†_pr√©sent_le_code_dufutur">2. √âcrire d√®s √† pr√©sent le code du&#160;futur</a>
<ul class="sectlevel2">
<li><a href="#la_fin_de_lapproche_par_le_d√©nominateur_commun">2.1. La fin de l&#8217;approche par le d√©nominateur commun</a></li>
<li><a href="#transpilation">2.2. √âcrire au plus proche des standards</a></li>
<li><a href="#polyfills">2.3. Combler les manques avec des polyfills</a></li>
</ul>
</li>
<li><a href="#modules">3. Importer des modules</a>
<ul class="sectlevel2">
<li><a href="#modules-script">3.1. La balise &lt;script&gt;</a></li>
<li><a href="#modules-es2015">3.2. Les modules ECMAScript</a></li>
<li><a href="#browserify">3.3. Importer des modules&#160;npm pour le&#160;Web</a></li>
<li><a href="#r√©capitulatif">3.4. R√©capitulatif</a></li>
</ul>
</li>
<li><a href="#conception_modulaire">4. Conception modulaire</a>
<ul class="sectlevel2">
<li><a href="#le_syndrome_du_plug_in_jquery">4.1. Le syndrome du plug-in jQuery</a></li>
<li><a href="#vers_une_approche_jquery_composite">4.2. Vers une approche jQuery composite</a></li>
<li><a href="#partager_le_code_m√©tier_avecnode">4.3. Partager le code m√©tier avec&#160;Node</a></li>
<li><a href="#s√©paration_du_fond_et_de_la_forme_donn√©es_rendu_et_interactions">4.4. S√©paration du fond et de la forme : donn√©es, rendu et interactions</a></li>
<li><a href="#react">4.5. Rapprocher donn√©es, rendu et interactions avec&#160;React</a></li>
</ul>
</li>
<li><a href="#io">5. Des requ√™tes Ajax vers du temps&#160;r√©el</a>
<ul class="sectlevel2">
<li><a href="#io-fetch">5.1. √âchange ponctuel de donn√©es avec <code>fetch()</code></a></li>
<li><a href="#io-eventsource">5.2. Approche unidirectionnelle avec EventSource</a></li>
<li><a href="#io-websocket">5.3. √âchanges en temps&#160;r√©el avec WebSocket</a></li>
</ul>
</li>
<li><a href="#d√©velopper_au_quotidien">6. D√©velopper au quotidien</a>
<ul class="sectlevel2">
<li><a href="#watchify">6.1. Reconstruire en continu avec <code>watchify</code></a></li>
<li><a href="#livereload">6.2. Changements en temps&#160;r√©el dans le navigateur</a></li>
<li><a href="#node-sass">6.3. Modulariser ses feuilles de styles avec&#160;Sass</a></li>
<li><a href="#ui-bundling">6.4. Lier composants visuels et feuilles de&#160;styles</a></li>
<li><a href="#optimiser_ses_ressources_graphiques">6.5. Optimiser ses ressources graphiques</a></li>
</ul>
</li>
<li><a href="#testing">7. Tester son code</a>
<ul class="sectlevel2">
<li><a href="#testing-101">7.1. Que tester ?</a></li>
<li><a href="#soutiller_pour_√©crire_des_assertions">7.2. S&#8217;outiller pour √©crire des assertions</a></li>
<li><a href="#tester_ses_composants_react_sans_navigateur">7.3. Tester ses composants React sans navigateur</a></li>
<li><a href="#tester_code_et_composants_dans_les_navigateurs">7.4. Tester code et composants dans les navigateurs</a></li>
<li><a href="#ci">7.5. Int√©gration continue et compatibilit√© navigateurs</a></li>
</ul>
</li>
<li><a href="#conclusion">8. Conclusion</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock tip context-callout">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="paragraph">
<p>Vous √™tes en train de lire le
<a href="https://oncletom.io/node.js/">livre &#8220;Node.js&#8221;</a>, √©crit par
<a href="https://oncletom.io">Thomas Parisot</a> et publi√© par les
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">√âditions Eyrolles</a>.</p>
</div>
<div class="paragraph">
<p>Il vous pla√Æt&#160;? Achetez-le en ligne sur
<a href="https://amzn.to/2E58PEw">Amazon</a>,
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">Eyrolles</a> ou
<a href="https://www.placedeslibraires.fr/livre/9782212139938">Place des Libraires</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Node et l&#8217;√©cosyst√®me&#160;<code>npm</code> sont devenus des acteurs majeurs de l&#8217;outillage
web <em>front-end</em> alors profitons-en pour partager du code entre client et serveur.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Sommaire</div>
<ul>
<li>
<p>Polyfills et compatibilit√© ECMAScript</p>
</li>
<li>
<p>Importer des modules&#160;<code>npm</code> pour le&#160;Web</p>
</li>
<li>
<p>Cr√©er du code modulaire, avec ou sans framework</p>
</li>
<li>
<p>√âchanges de donn√©es en temps&#160;r√©el</p>
</li>
<li>
<p>Outillage utile au quotidien</p>
</li>
<li>
<p>Tester son code et la compatibilit√© avec les navigateurs web</p>
</li>
</ul>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Avant l&#8217;apparition de Node, rare √©tait l&#8217;outillage n&#8217;imposant pas une ou
plusieurs plates-formes de d√©veloppement&#160;: <em>YUICompressor</em> et <em>Google Closure Compiler</em>
demandaient Java, <em>sprockets</em> demandait Ruby et <em>pngquant</em> reposait sur des
d√©pendances syst√®me comme <em>libpng</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;existence de Node et du registre <code>npm</code> a favoris√© le d√©veloppement d&#8217;un
√©cosyst√®me orient√© <em>front-end</em> plus simple √† appr√©hender.
Cela s&#8217;√©tend de la d√©couverte au t√©l√©chargement des biblioth√®ques tierces ainsi
qu&#8217;√† la compilation, l&#8217;optimisation et l&#8217;ex√©cution des tests des applications
web c√¥t√© client.</p>
</div>
<div class="paragraph">
<p><strong>Cet √©cosyst√®me rend l&#8217;√©criture de code moderne normale</strong>&#160;; un code anticipant
les futurs standards d&#8217;ECMAScript et <em>HTML5</em>, sur les navigateurs actuels et anciens.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Versions de Node et npm</div>
<div class="paragraph">
<p>Le contenu de ce chapitre utilise les versions <strong>Node&#160;v10</strong>
et <strong>npm&#160;v6</strong>.
Ce sont les versions stables recommand√©es en&#160;2019.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quel_rapport_entre_node_et_les_navigateursweb">1. Quel rapport entre Node et les navigateurs&#160;web ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce chapitre peut sembler confus au premier abord.
Si Node s&#8217;ex√©cute au niveau du syst√®me d&#8217;exploitation&#160;‚Äì &#8220;c√¥t√© serveur&#8221;&#160;‚Äì,
en quoi est-il li√© au d√©veloppement <em>front-end</em>&#160;‚Äì &#8220;c√¥t√© client&#8221;&#160;?
Est-ce parce que du code √©crit pour Node peut aussi fonctionner dans un navigateur&#160;web&#160;?
Quid de l&#8217;utilisation de <code>require('fs')</code> pour acc√©der au syst√®me de fichiers&#160;?</p>
</div>
<div class="paragraph">
<p>La r√©ponse courte est&#160;: nous n&#8217;ex√©cutons pas Node dans un navigateur.</p>
</div>
<div class="paragraph">
<p>Et voici la r√©ponse longue&#160;: <strong>Node est utilis√© pour assembler du code</strong>, le <em>transformer</em>
et le rendre fonctionnel dans une paire de balises <code>&lt;script&gt;&lt;/script&gt;</code>.
Ce code peut aussi aussi bien √™tre fourni par des biblioth√®ques tierces
install√©es via&#160;<code>npm</code> (<em>jQuery</em>, <em>React</em> ou <em>d3</em> par exemple) que par de
l&#8217;outillage (optimiseurs, suite de tests, orchestration de t√¢ches) ou encore
par le code r√©utilisable de notre propre application&#160;web.</p>
</div>
<div class="paragraph">
<p>Il faut √©galement bien comprendre qu&#8217;il y a plusieurs &#8220;probl√®mes&#8221; cach√©s sous
une m√™me question&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les navigateurs et Node utilisent diff√©rentes machines virtuelles JavaScript,
impl√©mentant ECMAScript de fa√ßon plus ou moins compl√®te.</p>
</li>
<li>
<p>Ils n&#8217;ont pas acc√®s aux m√™mes APIs&#160;‚Äì Node acc√®de √† <code>fs</code> et <code>http</code> tandis que
les navigateurs ont <code>File</code> et <code>fetch</code>/<code>XmlHttpRequest</code>.</p>
</li>
<li>
<p>Ils ne g√®rent pas le chargement de modules de la m√™me mani√®re
(voir la section &#8220;<a href="#managing-dependencies">D√©pendences de d√©veloppement</a>&#8221;).</p>
</li>
<li>
<p>L&#8217;impl√©mentation m√™me d&#8217;ECMAScript diff√®re selon les versions de Node
employ√©es&#160;‚Äì un navigateur moderne et Node&#160;v10 comprennent
l&#8217;objet natif <code>Promise</code>, mais pas Node&#160;0.12.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce processus n&#8217;est <em>pas magique</em> et nous verrons graduellement au cours des
prochaines sections comment tout ceci fonctionne.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Jouer avec les exemples dans un terminal</div>
<div class="paragraph">
<p>Les exemples titr√©s d&#8217;un nom de fichier peuvent √™tre install√©s sur votre ordinateur.
Ex√©cutez-les dans un terminal et amusez-vous √† les modifier en parall√®le de
votre lecture pour voir ce qui change.</p>
</div>
<div class="listingblock">
<div class="title">Installation des exemples via le module npm <code>nodebook</code></div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm install --global nodebook
<span data-bash-subs="$"></span>nodebook install chapter-09
<span data-bash-subs="$"></span>cd $(nodebook dir chapter-09)</pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante devrait afficher un r√©sultat qui confirme que vous √™tes
au bon endroit&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node hello.js</pre>
</div>
</div>
<div class="paragraph">
<p>Suivez √† nouveau les instructions d&#8217;installation pour r√©tablir les exemples
dans leur √©tat initial.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="√©crire_d√®s_√†_pr√©sent_le_code_dufutur">2. √âcrire d√®s √† pr√©sent le code du&#160;futur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transformer du code ECMAScript a pendant longtemps √©t√© chose p√©nible.
Je pense par exemple √† de la minification de code (pour r√©duire les temps de
transfert sur les antiques lignes ADSL&#160;128&#160;K) ou √† de la conversion automatique
de code ECMAScript&#160;3 en ECMAScript&#160;5.
Cela n√©cessitait syst√©matiquement l&#8217;utilisation d&#8217;un autre environnement
qu&#8217;ECMAScript lui-m√™me: Rhino n√©cessitait Java, Spidermonkey n√©cessitait&#160;C&#43;&#43;
et Trident n√©cessitait un environnement Windows en plus de&#160;C&#43;&#43;.</p>
</div>
<div class="paragraph">
<p><em>esprima</em> (<span class="URL"><a href="https://npmjs.com/esprima" class="bare">npmjs.com/esprima</a></span>) chamboule les r√®gles du jeu en
d√©cembre 2011&#160;: ce parseur ECMAScript&#160;‚Äì lui-m√™me √©crit en ECMAScript&#160;‚Äì
exporte une compr√©hension de code sous forme d&#8217;arbre syntaxique abstrait
(<em>Abstract Syntax Tree</em>, <em>AST</em>).
Cet arbre est lui-m√™me analysable par de nouveaux outils&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les <em>source maps</em> pour associer le code transform√© au code d&#8217;origine,
notamment dans les outils de d√©veloppement des navigateurs&#160;;</p>
</li>
<li>
<p>des minifieurs plus efficaces et ayant connaissance des portions de code ex√©cut√©es&#160;;</p>
</li>
<li>
<p>des analyseurs de code pour informer le d√©veloppeur d&#8217;erreurs de syntaxe,
de non-respect de styles de d√©veloppement, etc.&#160;;</p>
</li>
<li>
<p>des convertisseurs de code pour passer d&#8217;ECMAScript vers CoffeeScript,
de modules CommonJS vers des modules ECMAScript, etc.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Annonce d&#8217;esprima</div>
<div class="paragraph">
<p>Aryia&#160;Hidayat pr√©sente esprima dans ce billet de blog&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://ariya.io/2011/12/introducing-esprima" class="bare">ariya.io/2011/12/introducing-esprima</a></span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il y pr√©sente notamment des comparatifs de performances d&#8217;ex√©cution sur
diff√©rentes machines virtuelles ECMAScript et face √† d&#8217;autres parseurs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="la_fin_de_lapproche_par_le_d√©nominateur_commun">2.1. La fin de l&#8217;approche par le d√©nominateur commun</h3>
<div class="paragraph">
<p>Qui n&#8217;a pas d√©j√† entam√© un projet en posant la question √† un client, en regardant
les statistiques de trafic ou en se posant une question √† soi-m√™me&#160;: quelles
sont les versions de navigateurs avec lesquelles notre site ou application web
doit √™tre compatible&#160;?</p>
</div>
<div class="paragraph">
<p>La version de navigateur la plus ancienne ou la moins conforme aux standards
√©tait celle qui donnait le&#160;<em>la</em>.
Cela voulait dire se priver de techniques modernes, standardis√©es ou en cours
de standardisation.
Cela signifiait des <em>hacks</em> dans ses CSS, dans son code ECMAScript et dans
ses ressources graphiques.</p>
</div>
</div>
<div class="sect2">
<h3 id="transpilation">2.2. √âcrire au plus proche des standards</h3>
<div class="paragraph">
<p>Fort heureusement, l&#8217;arriv√©e d'<em>esprima</em> change la donne et permet d&#8217;√©crire un
code proche des standards qui r√©siste au temps.
Son existence facilite l'<strong>√©mergence d&#8217;outils automatisant les transformations de code</strong>
pour satisfaire nos besoins sp√©cifiques.</p>
</div>
<div class="paragraph">
<p>Il y a plusieurs √©l√©ments √† prendre en compte concernant la standardisation
de nouvelles versions d&#8217;ECMAScript et les √©volutions de sa syntaxe&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La cadence de standardisation a √©t√© revue pour devenir pr√©dictible&#160;‚Äì une
volont√© d&#8217;une fois par&#160;an.</p>
</li>
<li>
<p>Les fonctionnalit√©s et √©l√©ments de syntaxe sont impl√©ment√©s un par un, √† des
vitesses diff√©rentes par les diff√©rents navigateurs.</p>
</li>
<li>
<p>Deux tiers de navigateurs fonctionnent sur des rythmes de mise √† jour en cycle court
(de six √† neuf semaines)&#160;‚Äì le tiers restant est cadenc√© √† une seule mise √†
jour par&#160;an.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il vaut mieux <strong>parier sur les standards comme strat√©gie √† long terme</strong> si on tient
compte du temps de d√©veloppement et du temps de maintenance d&#8217;une base de&#160;code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Question</span> Standards, quels standards ?</div>
<div class="paragraph">
<p>Plusieurs organismes prennent part √† la standardisation de langages et
d&#8217;API lorsque l&#8217;on touche aux navigateurs&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HTML&#160;: <em>WHATWG</em> (<span class="URL"><a href="https://html.spec.whatwg.org" class="bare">html.spec.whatwg.org</a></span>)&#160;;</p>
</li>
<li>
<p>API&#160;DOM&#160;: <em>WHATWG</em> (<span class="URL"><a href="https://dom.spec.whatwg.org" class="bare">dom.spec.whatwg.org</a></span>)&#160;;</p>
</li>
<li>
<p>CSS&#160;: <em>W3C</em> (<span class="URL"><a href="https://www.w3.org/standards/techs/css" class="bare">www.w3.org/standards/techs/css</a></span>)&#160;;</p>
</li>
<li>
<p>ECMAScript&#160;: <em>TC39</em> (<span class="URL"><a href="https://github.com/tc39" class="bare">github.com/tc39</a></span>)&#160;;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lorsque nous √©crivons du code, nous pouvons rencontrer trois cas de figure&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>√©l√©ment de syntaxe non&#160;impl√©ment√©&#160;: transformer le code pour l&#8217;adapter aux
navigateurs cibles&#160;;</p>
</li>
<li>
<p>√©l√©ment de syntaxe partiellement impl√©ment√©&#160;: utiliser l&#8217;impl√©mentation native
des navigateurs et, √† d√©faut, transformer le code pour l&#8217;adapter aux autres navigateurs&#160;;</p>
</li>
<li>
<p>√©l√©ment de syntaxe totalement impl√©ment√©&#160;: utiliser l&#8217;impl√©mentation native des navigateurs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il arrive que certains √©l√©ments de syntaxe soient abandonn√©s pendant le
processus de standardisation&#160;‚Äì ou que leur impl√©mentation change beaucoup
(on pensera √† <code>Object.observe()</code>).</p>
</div>
<div class="paragraph">
<p>La question qui nous taraude est&#160;: comment transformer le code pour satisfaire
√† la fois les navigateurs compatibles et les autres&#160;?
<em>Babel</em> (<span class="URL"><a href="https://babeljs.io" class="bare">babeljs.io</a></span>) est un outil de choix  pour parvenir √† ses
fins d&#8217;√©crire du code r√©sistant au(x standards du) temps.</p>
</div>
<div class="paragraph">
<p>Ce module convertit de mani√®re s√©lective toute syntaxe ECMAScript&#160;2015/2016/etc.
vers de l&#8217;ECMAScript&#160;5, compr√©hensible par les navigateurs modernes.
L&#8217;int√©r√™t de sa s√©lectivit√© fait que l&#8217;on peut progressivement arr√™ter de
convertir les √©l√©ments de syntaxe couverts par 100&#160;% des navigateurs.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Histoire</span> Traceur</div>
<div class="paragraph">
<p><em>Traceur</em> est un des premiers transpilateurs ECMAScript&#160;2015 vers
ECMAScript&#160;5 √† avoir √©merg√© dans l&#8217;√©cosyst√®me&#160;Node.</p>
</div>
<div class="paragraph">
<p>Gr√¢ce √† lui, il a √©t√© possible d&#8217;√©crire des modules en ECMAScript&#160;2015
bien avant que la sp√©cification ne soit enti√®rement termin√©e et donc on a pu
anticiper son apprentissage tout en mettant le langage √† l&#8217;√©preuve avant sa finalisation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre un code utilisant des √©l√©ments de syntaxe
d&#8217;ECMAScript&#160;2018.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">babel/es2018.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>one<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> two<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>three<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> four<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span>a<span class="token punctuation">,</span> <span class="token operator">...</span>b<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>{ one: 1, two: 2, three: 3, four: 4 }</code> si le navigateur supporte l&#8217;op√©rateur <em>spread</em> sur les objets (<a href="../chapter-03/index.html#object.assign">chapitre&#160;3</a>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce code repr√©sente l&#8217;id√©al de ce que l&#8217;on souhaite √©crire.
Le seul obstacle consiste √† traduire ce code pour l&#8217;ensemble des navigateurs
compatibles avec ECMAScript&#160;5.</p>
</div>
<div class="paragraph">
<p>Ex√©cutons cette commande&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>npm run babel -- examples/babel/es2018.js</pre>
</div>
</div>
<div class="paragraph">
<p>La sortie a chang√© et renvoie un code totalement fonctionnel sur des navigateurs
ne prenant pas ECMAScript&#160;2018 en charge&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">babel/es2018-es5.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">"use strict"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">var</span> source <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">var</span> ownKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Object<span class="token punctuation">.</span>getOwnPropertySymbols <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> ownKeys <span class="token operator">=</span> ownKeys<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sym</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> sym<span class="token punctuation">)</span><span class="token punctuation">.</span>enumerable<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> ownKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> target<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> value<span class="token punctuation">,</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>one<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> two<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>three<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> four<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_objectSpread</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque fonctionnalit√© d&#8217;ECMAScript est transform√©e selon une r√®gle personnalisable,
int√©gr√©e √† <em>Babel</em> ou disponible sous forme d&#8217;un plug-in.
Les <em>presets</em> sont des modules&#160;<code>npm</code> qui regroupent les r√®gles
de transformation selon un certaine logique.</p>
</div>
<div class="paragraph">
<p><em>preset-env</em> <span class="URL"><a href="https://npmjs.com/babel-preset-env" class="bare">npmjs.com/babel-preset-env</a></span> convertit
notre code dans une version compatible avec la majorit√© des navigateurs
support√©s sur le march√©.
Si vos besoins sont diff√©rents, sa configuration sait cibler des navigateurs
en fonction soit de leur version, soit de leur part de march√©.</p>
</div>
<div class="paragraph">
<p>La configuration des presets et d&#8217;autres aspects de Babel se fait
dans un fichier nomm√© <code>.babelrc</code>.
L&#8217;exemple suivant configure Babel pour pr√©server les commentaires,
transformer la syntaxe JSX pour <a href="#react"><em>React</em></a> et transformer pour les
derni√®res versions des navigateurs sur le march√©&#160;:</p>
</div>
<div class="listingblock">
<div class="title">.babelrc</div>
<div class="content">
<pre>{
  "comments": false,
  "presets": [
    "@babel/preset-react",
    "@babel/preset-env"
  ],
  "plugins": [
    "@babel/plugin-proposal-object-rest-spread"
  ]
}</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Documentation de Babel</div>
<div class="paragraph">
<p>Toutes les options de configuration sont document√©es sur le site officiel
de Babel&#160;: <span class="URL"><a href="https://babeljs.io/docs/en/babel-core/#options" class="bare">babeljs.io/docs/en/babel-core/#options</a></span>.</p>
</div>
<div class="paragraph">
<p>Une autre page explique o√π placer et quoi mettre dans les fichiers
<code>.babelrc</code>&#160;: <span class="URL"><a href="https://babeljs.io/docs/en/config-files/" class="bare">babeljs.io/docs/en/config-files/</a></span>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="polyfills">2.3. Combler les manques avec des polyfills</h3>
<div class="paragraph">
<p>Des outils comme Babel nous permettent d&#8217;√©crire avec une syntaxe moderne qui
<strong>comblent les fonctionnalit√©s manquantes</strong>&#160;‚Äì leur impl√©mentation.</p>
</div>
<div class="paragraph">
<p>Un <em>polyfill</em> harmonise la pr√©sence d&#8217;une fonctionnalit√© au sein d&#8217;une vari√©t√© de
navigateurs et d&#8217;environnements ECMAScript.
Cela se fera au prix de quelques kilo-octets de code √† charger en plus
dans nos applications.
L&#8217;appel √† un service de <em>polyfill</em> externe entra√Æne un l√©ger ralentissement du
chargement de notre&#160;page.</p>
</div>
<div class="paragraph">
<p>Prenons le bloc de code suivant&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprenons que&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cette syntaxe est valide dans toutes les versions d&#8217;ECMAScript
(Babel ne change rien √† ce code).</p>
</li>
<li>
<p>L&#8217;objet global <code>Promise</code> existe dans un navigateur moderne.</p>
</li>
<li>
<p>L&#8217;objet global <code>Promise</code> n&#8217;existe pas dans <em>Internet Explorer 11</em>, entre autres.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce code fonctionnerait donc sur un navigateur moderne mais pas dans <em>IE11</em>.
L&#8217;inclusion d&#8217;un <em>polyfill</em> de <code>Promise</code> r√©soudrait le probl√®me.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Bonne pratique</span> Quand inclure les polyfills ?</div>
<div class="paragraph">
<p><strong>Un <em>polyfill</em> se charge toujours en premier</strong>.
On inclut tous les <em>polyfills</em> en une seule fois avant notre propre code.</p>
</div>
<div class="paragraph">
<p>Nous garantissons ainsi coh√©rence et stabilit√© de comportement au sein de
notre application, peu importe l&#8217;ordre d&#8217;ex√©cution de nos scripts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Parlons maintenant des m√©thodes d&#8217;inclusion des <em>polyfills</em> pour mieux
comprendre comment proc√©der.</p>
</div>
<div class="paragraph">
<p>Le service <em>polyfill.io</em> est de loin la m√©thode la plus simple √† utiliser.
Il suffit d&#8217;inclure un script dans toutes vos pages web et cet outil
d√©termine les <em>polyfills</em> √† charger en fonction de la
compatibilit√© du navigateur&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">polyfill.io.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Example polyfill.io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.polyfill.io/v2/polyfill.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> polyfill.io</div>
<div class="paragraph">
<p>polyfill.io poss√®de une documentation tr√®s compl√®te qui aide √† configurer
finement le service en fonction de nos besoins&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://qa.polyfill.io/v2/docs/" class="bare">qa.polyfill.io/v2/docs/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous pouvons d√©duire deux r√®gles de cet exemple&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inclure les <em>polyfills</em> en tout premier.</p>
</li>
<li>
<p>Les inclure en dehors de notre code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La deuxi√®me m√©thode est d&#8217;embarquer les <em>polyfills</em> dans notre base de code.
L&#8217;avantage est de ma√Ætriser notre base de code et de ne pas d√©pendre d&#8217;un service externe.
L&#8217;inconv√©nient est que nous chargeons du code qui sera inutile dans les
navigateurs et environnements disposant d√©j√† de ces fonctionnalit√©s.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">polyfill-import.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Exemple polyfill custom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">import</span> <span class="token string">'es6-promise/auto'</span><span class="token punctuation">;</span>        <span class="token comment">// <b class="conum">(1)</b></span>
      <span class="token keyword">import</span> <span class="token string">'core-js/fn/number/is-nan'</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(2)</b></span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous verrons <a href="#modules">comment importer des modules</a> ci-apr√®s.</p>
</li>
<li>
<p>On importe un deuxi√®me <em>polyfill</em>, celui de la m√©thode <code>Number.isNaN</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le module <em>npm</em> <code>core-js</code> est une biblioth√®que exhaustive de <em>polyfills</em>
pouvant √™tre inclus un √† un ou par versions d&#8217;ECMAScript.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> core-js</div>
<div class="paragraph">
<p>La documentation en ligne de <code>core-js</code> liste l&#8217;ensemble des <em>polyfills</em>
pris en charge, ainsi que des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/core-js" class="bare">npmjs.com/core-js</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">‚ö†Ô∏è</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Performance et duplication</div>
<div class="paragraph">
<p>Il faut veiller √† ne pas alourdir inutilement une application.</p>
</div>
<div class="paragraph">
<p>Laissons la responsabilit√© de <em>polyfiller</em> aux utilisateurs de notre code&#160;;
particuli√®rement si celui-ci est redistribu√© en tant que module&#160;<code>npm</code> public.</p>
</div>
<div class="paragraph">
<p>Si plusieurs scripts n√©cessitent des <em>polyfills</em>, mieux vaut inclure ces
derniers en une&#160;fois&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>polyfills.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-a.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-b.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enfin, une derni√®re m√©thode est d&#8217;importer la fonction de <em>polyfill</em> sans
r√©√©crire les objets globaux.
Cette pratique a l&#8217;avantage de ne pas entra√Æner d&#8217;effets secondaires et de
garantir le m√™me comportement dans tous les navigateurs.
L&#8217;inconv√©nient est qu&#8217;on n&#8217;utilise pas la fonctionnalit√© native des navigateurs
lorsqu&#8217;elle est pr√©sente.
Nous nous retrouvons tributaires de la qualit√© d&#8217;impl√©mentation du <em>polyfill</em>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">polyfill-require.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>Promise <span class="token keyword">as</span> PromisePolyfill<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'es6-promise'</span><span class="token punctuation">;</span>

PromisePolyfill<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>PromisePolyfill <span class="token operator">===</span> window<span class="token punctuation">.</span>Promise<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>true</code> si le navigateur impl√©mente l&#8217;API <em>Promise</em>&#160;‚Äì sinon affiche <code>false</code> et l&#8217;utilisation d&#8217;un <em>polyfill</em> prend tout son&#160;sens.</p>
</li>
<li>
<p>Affiche <code>false</code>, car le <em>polyfill</em> de <em>Promise</em> est une fonction strictement diff√©rente de <code>window.Promise</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Bonnes pratiques constat√©es</div>
<div class="paragraph">
<p>De bons usages des <em>polyfills</em> ainsi que les risques li√©s √† leur utilisation
sont compil√©s dans un guide √©dit√© par le&#160;W3C&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://w3ctag.github.io/polyfills/" class="bare">w3ctag.github.io/polyfills/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modules">3. Importer des modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Importer des modules est une pratique courante avec Node.
Elle l&#8217;est en revanche beaucoup moins dans l&#8217;univers du Web puisqu&#8217;il n&#8217;existait
rien de natif avant les <a href="#modules-es2015">modules ECMAScript</a>.</p>
</div>
<div class="paragraph">
<p>Auparavant, on aura vu d√©barquer les modules AMD (<em>Asynchronous Module Definition</em>)
pour g√©rer les d√©pendances entre scripts.
Les biblioth√®ques Dojo, RequireJS et YUI ont popularis√© ce motif de conception.
Un d√©sir d&#8217;universalit√© a ensuite √©merg√© avec la popularit√© croissante de Node,
conduisant aux modules&#160;UMD, conciliant AMD et CommonJS.</p>
</div>
<div class="paragraph">
<p>Les modules ECMAScript ont √©merg√© de ce bouillonnement.</p>
</div>
<div class="sect2">
<h3 id="modules-script">3.1. La balise &lt;script&gt;</h3>
<div class="paragraph">
<p>Rappelons-le, la m√©thode incontournable pour charger du code dans un navigateur
est l&#8217;utilisation de la base <code>&lt;script&gt;</code>.
Le chargement, l&#8217;√©valuation et l&#8217;ex√©cution du script bloquent le temps
n√©cessaire au rendu d&#8217;un document&#160;HTML.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/script.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>global-dom-log.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les diff√©rents scripts partagent le m√™me espace m√©moire, permettant ainsi √†
<code>script.js</code> d&#8217;avoir acc√®s √† la fonction <code>log</code> d√©finie dans <code>global-dom-log.js</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/global-dom-log.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#logs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/script.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">/* global log */</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'KO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche une erreur car <code>&lt;div id="logs"&gt;</code> n&#8217;existe pas encore dans le document
√† ce stade de l&#8217;ex√©cution.</p>
</li>
<li>
<p>Cette ligne est ex√©cut√©e une fois le document charg√©&#160;‚Äì <code>&lt;div id="logs"&gt;</code>
contient d√©sormais le texte&#160;<code>OK</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>S&#8217;il est facile d&#8217;ajouter du code dans le navigateur, on constate plusieurs probl√®mes&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Partager du code entre scripts repose sur une attente explicite.</p>
</li>
<li>
<p>Le partage de variables entre scripts risque d&#8217;entra√Æner des collisions
(par exemple, deux variables du m√™me nom d√©finies dans des scripts diff√©rents).</p>
</li>
<li>
<p>Il n&#8217;y a pas de moyen √©vident de rendre des parties de code priv√©es au sein de
chaque script.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le d√©veloppement <em>front-end</em> bas√© sur de l&#8217;outillage Node va justement nous aider
√† <strong>solidifier et renforcer la r√©utilisabilit√© de notre&#160;code</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="modules-es2015">3.2. Les modules ECMAScript</h3>
<div class="paragraph">
<p>Nous avons √©voqu√© les <a href="../chapter-03/index.html#primitives">primitives ECMAScript&#160;2015</a> dans le chapitre&#160;3.
Les modules font partie des fonctionnalit√©s tant attendues.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/module-import.png" alt="module import" width="85%">
</div>
<div class="title">Figure 1. Utilisation des modules ECMAScript dans un navigateur web (ici, Safari pour macOS)</div>
</div>
<div class="paragraph">
<p>L&#8217;attribut <code>type="module"</code> sert √† maintenir une compatibilit√© entre les scripts
classiques et les modules ECMAScript.
Ce m√©canisme s&#8217;appuie sur plusieurs concepts importants&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Toute variable est priv√©e sauf si elle est export√©e avec l&#8217;op√©rateur <code>export</code>.</p>
</li>
<li>
<p>Les modules sont explicitement inclus avec l&#8217;op√©rateur <code>import</code>.</p>
</li>
<li>
<p>Les variables globales d√©finies par l&#8217;utilisateur ne sont pas accessibles depuis un module.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Retravaillons le document HTML de la section pr√©c√©dente&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/import.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token keyword">const</span> pro <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-import.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous voulons maintenant (sa)voir si la variable&#160;<code>pro</code> d√©finie avant l&#8217;inclusion
du module <code>script-import.js</code> est accessible.
Nous voulons √©galement savoir si la syntaxe d&#8217;import de la fonction&#160;<code>log</code> fonctionne&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/script-import.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>log<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dom-log.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> pro<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>undefined</code>.</p>
</li>
<li>
<p>Affiche <code>function</code>.</p>
</li>
<li>
<p>Affiche <code>object</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>De m√™me que nous avons utilis√© <code>import</code> pour importer de mani√®re s√©lective une
fonction du module <code>dom-log.js</code>, l&#8217;op√©rateur <code>export</code> nous aide √† exposer des
objets, fonctions et variables&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/dom-log.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> target <span class="token operator">=</span> <span class="token string">'#logs'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="browserify">3.3. Importer des modules&#160;npm pour le&#160;Web</h3>
<div class="paragraph">
<p>Qu&#8217;en est-il alors des modules&#160;<code>npm</code>&#160;?
Nous pouvons transpiler et importer du code.
Ce serait tr√®s utile si nous pouvions √©galement importer du code tiers.
Cela nous √©viterait de r√©inventer la roue, nous donnerait acc√®s √† du code bien test√©
et trop co√ªteux √† √©crire nous-m√™mes.</p>
</div>
<div class="paragraph">
<p>Nous avons vu comment <a href="../chapter-05/index.html#modules">charger des modules&#160;<code>npm</code></a>
dans le chapitre 5.
Int√©ressons-nous √† leur utilisation dans le contexte d&#8217;une application <em>front-end</em>.
Pour cela, adaptons l&#8217;exemple de la section pr√©c√©dente&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/script-import-jquery.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>jquery<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#logs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>$.fn.jquery</code> contient le num√©ro de version de jQuery.</p>
</li>
<li>
<p>Substitut jQuery pour remplacer le texte dans <code>&lt;div id="logs"&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le document HTML chargeant ce module est en tout point similaire au pr√©c√©dent exemple&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/import-jquery.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-import-jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le seul hic, c&#8217;est que <strong>cela ne fonctionne pas</strong>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Le navigateur ne peut pas savoir o√π se trouve la d√©pendance demand√©e.</p>
</li>
<li>
<p>Rien ne garantit que <code>jquery</code> expose son code en tant que module ECMAScript.</p>
</li>
<li>
<p>On n&#8217;a certainement pas envie d&#8217;exposer publiquement le r√©pertoire <code>node_modules</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est alors qu&#8217;entre en jeu <em>Browserify</em>.
Il s&#8217;agit d&#8217;un outil g√©n√©rique de transformation de code.
Il peut √™tre utilis√© en ligne de commandes, via son API Node, mais aussi par
le biais de plug-in pour d&#8217;autres outils (comme Gulp ou Grunt).</p>
</div>
<div class="paragraph">
<p><em>Browserify</em> a √©t√© initialement cr√©√© pour transformer du code √©crit pour Node en
code fonctionnel dans les navigateurs.
Il expose notamment un concept d&#8217;int√©grations (les <em>transforms</em>) afin d&#8217;effectuer
des remplacements ligne √† ligne.</p>
</div>
<div class="paragraph">
<p>L√† o√π <em>Babel</em> cherche uniquement √† traduire un langage vers un autre,
<em>Browserify</em> est le couteau suisse pour effectuer des remplacements majeurs dans le code&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>portage de la fonction <code>require()</code> et inclusion du code des modules sous-jacents&#160;;</p>
</li>
<li>
<p>suppression de code conditionnel&#160;;</p>
</li>
<li>
<p>remplacement d&#8217;API sp√©cifiques √† Node par des <em>polyfills</em> pour le&#160;Web&#160;;</p>
</li>
<li>
<p>extraction de&#160;CSS&#160;;</p>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Browserify</em> est int√©ressant au sens o√π il nous apprend √† nous constituer
notre outillage, pour nos propres besoins.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Utiliser Browserify</div>
<div class="paragraph">
<p><em>Browserify</em> (<span class="URL"><a href="https://npmjs.com/browserify" class="bare">npmjs.com/browserify</a></span>) est un outil extr√™mement
adaptable, modulaire et puissant.
Son apprentissage progressif peut faire de lui un alli√© de choix dans tous
vos projets Node et&#160;Web.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://github.com/substack/browserify-handbook" class="bare">github.com/substack/browserify-handbook</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Revenons maintenant √† notre code auquel il manque la compr√©hension des
modules&#160;<code>npm</code>.
Nous allons maintenant chercher √† transformer le fichier <code>script-import-jquery.js</code>,
non seulement pour rendre la syntaxe <code>import</code> intelligible
(c&#8217;est le <a href="#transpilation">r√¥le de Babel</a>), mais aussi pour faire le
lien avec les modules&#160;<code>npm</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>npm run browserify -- \
  -t babelify \
  -e examples/import/script-import-jquery.js \
  -o examples/import/script-import-jquery-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande ex√©cute trois choses&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-t babelify</code> indique d&#8217;utiliser une int√©gration Babel (un <em>transform</em>) pour
transformer la syntaxe ECMAScript&#160;2015.</p>
</li>
<li>
<p><code>-e &#8230;&#8203;</code> indique le script d&#8217;entr√©e √† transformer.</p>
</li>
<li>
<p><code>-o &#8230;&#8203;</code> indique o√π stocker le script transform√©.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il en r√©sultera un fichier nomm√© <code>script-import-jquery-browserify.js</code> compatible
ECMAScript&#160;5 et qui inclut d√©sormais le code source de jQuery.</p>
</div>
<div class="paragraph">
<p>Il ne nous reste plus qu&#8217;√† charger le fichier transform√© dans notre page web pour
voir le r√©sultat&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">import/import-jquery-browserify.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script-import-jquery-browserify.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="r√©capitulatif">3.4. R√©capitulatif</h3>
<div class="paragraph">
<p>En r√©sum√©, nous avons besoin de nous baser sur deux ou trois outils pour √©crire
un code modulaire et compatible avec n&#8217;importe quel type de syntaxe&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Babel pour transformer la syntaxe&#160;;</p>
</li>
<li>
<p>des <em>polyfills</em> pour harmoniser les fonctionnalit√©s&#160;;</p>
</li>
<li>
<p><em>browserify</em> pour l&#8217;int√©gration avec les modules&#160;<code>npm</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ceux-ci ont l&#8217;avantage d&#8217;√™tre faciles √† prendre en main, modulaires et √©volutifs.
Nous pourrons aussi nous tourner vers d&#8217;autres outils de transformation de code
pour explorer d&#8217;autres horizons&#160;‚Äì et il en existe √©norm√©ment&#160;: webpack, rollup,
broccoli, etc.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conception_modulaire">4. Conception modulaire</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un autre paradigme change avec la mise √† disposition des modules et de
l&#8217;outillage&#160;: le code que l&#8217;on √©crit d√©pend surtout d&#8217;ECMAScript et de
l&#8217;environnement dans lequel on l&#8217;ex√©cute, √† savoir Node ou un navigateur.</p>
</div>
<div class="paragraph">
<p>La section suivante s&#8217;int√©resse √† l&#8217;√©volution de l&#8217;√©criture du code, autrefois
dirig√©e par la structure du document HTML, vers un monde de
fonctions consommant des donn√©es, transform√©es pour un type d&#8217;affichage, que ce
soit HTML ou autre.</p>
</div>
<div class="paragraph">
<p>Nous illustrerons cette √©volution au travers d&#8217;un exemple relativement simple&#160;:
une balise HTML affichant l&#8217;heure dont nous actualisons le contenu toutes les secondes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/modules-time.png" alt="modules time" width="85%">
</div>
<div class="title">Figure 2. R√©sultat de l&#8217;exemple d√©velopp√© dans les sections suivantes</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>jQuery</em></div>
<div class="paragraph">
<p>Les exemples suivants se basent sur l&#8217;utilisation de la biblioth√®que <em>jQuery</em>
(<span class="URL"><a href="https://api.jquery.com" class="bare">api.jquery.com</a></span>).</p>
</div>
<div class="paragraph">
<p>Elle facilite la manipulation du DOM tout en g√©rant les incompatibilit√©s des
diff√©rents navigateurs.
Son utilisation est devenue moins dominante du fait d&#8217;une nette am√©lioration de
la qualit√© de ces derniers.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://learn.jquery.com/using-jquery-core/" class="bare">learn.jquery.com/using-jquery-core/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="le_syndrome_du_plug_in_jquery">4.1. Le syndrome du plug-in jQuery</h3>
<div class="paragraph">
<p>Ce que j&#8217;appelle le &#8220;syndrome du plug-in <em>jQuery</em>&#8221;, c&#8217;est une combinaison
des √©l√©ments suivants&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cr√©ation de code m√©tier inutilisable en dehors de <em>jQuery</em>&#160;;</p>
</li>
<li>
<p>m√©lange de la pr√©sentation des donn√©es et de l&#8217;organisation du code m√©tier&#160;;</p>
</li>
<li>
<p>un code aveugle car √©loign√© de la structure HTML n√©cessaire √† son fonctionnement&#160;;</p>
</li>
<li>
<p>fragilit√© du code en cas de changement de la structure HTML associ√©e&#160;;</p>
</li>
<li>
<p>en g√©n√©ral, un code difficilement testable&#160;‚Äì difficile de ne pas aboutir √† une interface bogu√©e.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voici un exemple de document HTML fragile et m√©langeant tous les concepts en m√™me temps.
Il est parfaitement valide, mais illustre un ensemble de pratiques courantes que
nous allons chercher √† d√©construire.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/jquery-plugin.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time</span> <span class="token attr-name">datetime</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">data-interval</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>---<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>../../node_modules/jquery/dist/jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jquery-plugin.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que la structure HTML est d√©finie, nous devons √©crire le
code affichant l&#8217;heure dans un √©l√©ment HTML toutes les secondes.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/jquery-plugin.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">/* global jQuery */</span>

<span class="token punctuation">(</span><span class="token parameter">$</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  $<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">displaySeconds</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">displaySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> dateElement</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                  <span class="token comment">// <b class="conum">(1)</b></span>
        <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(2)</b></span>
        <span class="token keyword">const</span> seconds <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">$</span><span class="token punctuation">(</span>dateElement<span class="token punctuation">)</span>                     <span class="token comment">// <b class="conum">(3)</b></span>
          <span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span>seconds <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">'pair'</span><span class="token punctuation">:</span> <span class="token string">'impair'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span>seconds <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">'impair'</span><span class="token punctuation">:</span> <span class="token string">'pair'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'datetime'</span><span class="token punctuation">,</span> now<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span>dateElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'interval'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(4)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>      <span class="token comment">// <b class="conum">(5)</b></span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">displaySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(6)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>jQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ce bloc de code est ex√©cut√© toutes les secondes.</p>
</li>
<li>
<p>La donn√©e de temps est obtenue chaque seconde par notre plug-in <em>jQuery</em>.</p>
</li>
<li>
<p>Certaines d√©cisions m√©tier sont m√©lang√©es avec l&#8217;affichage de la donn√©e temps.</p>
</li>
<li>
<p>L&#8217;intervalle est d√©termin√© par la valeur de l&#8217;attribut <code>data-interval</code>.</p>
</li>
<li>
<p>Ce bloc de code est ex√©cut√© d√®s que le document HTML est pr√™t&#160;‚Äì toute sa structure HTML est disponible.</p>
</li>
<li>
<p>Le plug-in <em>jQuery</em> est appliqu√© √† toutes les occurrences de <code>&lt;time&gt;</code> dans lequel il est ex√©cut√©.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Certains motifs illustr√©s dans la section &#8220;<a href="#modules">Importer des modules</a>&#8221;
refont surface&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Variables globales&#160;: que faire si <code>jQuery</code> n&#8217;existe pas&#160;?</p>
</li>
<li>
<p>Connaissance implicite du document&#160;: que faire si une personne tierce remplace
la balise <code>&lt;time&gt;</code> par une autre balise&#160;?</p>
</li>
<li>
<p>Code ECMAScript pilot√© par le document&#160;: que faire si une personne tierce
exprime l&#8217;intervalle en secondes et non en millisecondes&#160;?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La faute n&#8217;est pas vraiment celle de <em>jQuery</em> mais plut√¥t la n√¥tre&#160;‚Äì enfin, la mienne.
Nous avons m√©lang√© r√®gles de fonctionnement (contenu de balise, classe&#160;CSS
√† ajouter/enlever) et donn√©es (date courante, parit√© des secondes, √©v√©nement de
mise √† jour <code>setInterval()</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="vers_une_approche_jquery_composite">4.2. Vers une approche jQuery composite</h3>
<div class="paragraph">
<p>Nous allons maintenant reprendre les concepts appris pr√©c√©demment et conserver
le m√™me outil, √† savoir <em>jQuery</em>.
Certains outils encouragent de bons motifs de conception et donnent la sensation
de r√©soudre des probl√®mes.
Apprendre ces motifs et √† capitaliser sur les outils que nous connaissons d√©j√†
peuvent nous emmener tout aussi&#160;loin.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/jquery-app.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time</span> <span class="token attr-name">datetime</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>---<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jquery-app-browserify.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le changement majeur r√©side dans la r√©organisation du code applicatif&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/jquery-app.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> timerFn <span class="token keyword">from</span> <span class="token string">'./timer.js'</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(4)</b></span>

<span class="token keyword">const</span> <span class="token function-variable function">displaySeconds</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tickData<span class="token punctuation">,</span> dateElement</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(5)</b></span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>className<span class="token punctuation">,</span> now<span class="token punctuation">}</span> <span class="token operator">=</span> tickData<span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span>dateElement<span class="token punctuation">)</span>                                    <span class="token comment">// <b class="conum">(6)</b></span>
    <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'datetime'</span><span class="token punctuation">,</span> now<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dateElements <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">const</span> <span class="token function-variable function">onTick</span> <span class="token operator">=</span> <span class="token parameter">tickData</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                      <span class="token comment">// <b class="conum">(2)</b></span>
    dateElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> <span class="token function">displaySeconds</span><span class="token punctuation">(</span>tickData<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">timerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> interval<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> onTick <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous s√©lectionnons les √©l√©ments de la page √† actualiser chaque seconde.</p>
</li>
<li>
<p>Nous d√©finissons quoi faire avec les donn√©es transmises chaque seconde.</p>
</li>
<li>
<p>Nous d√©marrons un minuteur.</p>
</li>
<li>
<p>Le minuteur est une fonction externe, dont le comportement n&#8217;est pas r√©gi par <em>jQuery</em> ou une autre biblioth√®que.</p>
</li>
<li>
<p>Cette fonction est responsable de l&#8217;affichage de donn√©es dans un √©l√©ment&#160;HTML.</p>
</li>
<li>
<p>Cette fois-ci, nous nous contentons de seulement mettre √† jour attributs et contenus&#160;‚Äì la logique m√©tier a √©t√© d√©plac√©e dans le module <code>timer.js</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le code a √©t√© divis√© en deux sections distinctes&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>celle qui d√©crit la r√©action √† une donn√©e&#160;;</p>
</li>
<li>
<p>celle qui int√®gre le minuteur avec les √©l√©ments du DOM.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous n&#8217;avons pas r√©ellement besoin de savoir comment fonctionne le minuteur √†
ce niveau&#160;‚Äì nous devons pouvoir compter sur les donn√©es qu&#8217;il nous fournit.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/timer.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">tick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>              <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>                        <span class="token comment">// <b class="conum">(2)</b></span>
    now<span class="token punctuation">,</span>
    className<span class="token punctuation">:</span> now<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">'impair'</span><span class="token punctuation">:</span> <span class="token string">'pair'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">timer</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onTick<span class="token punctuation">,</span> interval <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onTick</span><span class="token punctuation">(</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(4)</b></span>

  <span class="token keyword">return</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(5)</b></span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Cette fonction (priv√©e) est charg√©e de d√©crire le temps pr√©sent sous forme d&#8217;une structure de donn√©es.</p>
</li>
<li>
<p>Cette structure de donn√©es pourra retourner de nouvelles cl√©s/valeurs sans remettre en cause le fonctionnement du code y ayant recours.</p>
</li>
<li>
<p>Le param√®tre <code>onTick</code> est une fonction pass√©e en argument qui sera appel√©e √† chaque nouvel intervalle de temps.</p>
</li>
<li>
<p>La responsabilit√© de <code>timer</code> est de communiquer une nouvelle structure de donn√©es √† un intervalle de temps donn√©.</p>
</li>
<li>
<p>On retourne imm√©diatement une structure de donn√©es par commodit√© et de mani√®re synchrone.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour un r√©sultat identique, nous avons d√©sormais s√©par√© notre code en trois
domaines distincts&#160;: le minuteur, son int√©gration, sa repr√©sentation sous forme HTML.
Cerise sur le g√¢teau, cette distinction se constate visuellement,
au premier coup&#160;d&#8217;≈ìil.</p>
</div>
<div class="paragraph">
<p>Tout n&#8217;est pas parfait, car nous sommes encore li√©s √† la structure du
document&#160;HTML.</p>
</div>
</div>
<div class="sect2">
<h3 id="partager_le_code_m√©tier_avecnode">4.3. Partager le code m√©tier avec&#160;Node</h3>
<div class="paragraph">
<p>Cette s√©paration de principes (<em>separation of concerns</em>) va au-del√† du plaisir
de l&#8217;esth√®te.
Nous venons sans le savoir de cr√©er du <strong>code ECMAScript universel</strong>.</p>
</div>
<div class="paragraph">
<p>Pourquoi universel&#160;?
Parce que nous pouvons tout aussi bien l&#8217;inclure et l&#8217;ex√©cuter dans Node que
dans un navigateur&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/node-timer.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> timerFn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./timer.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">timerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> interval<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> onTick<span class="token punctuation">:</span> console<span class="token punctuation">.</span>log <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;ex√©cution du script <code>node-timer.js</code> afficherait quelque chose comme ce
qui suit dans votre terminal&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node examples/modules/node-timer.js
{ now: 2017-02-17T11:07:29.752Z, className: 'impair' }
{ now: 2017-02-17T11:07:30.762Z, className: 'pair' }
{ now: 2017-02-17T11:07:31.768Z, className: 'impair' }
{ now: 2017-02-17T11:07:32.770Z, className: 'pair' }
{ now: 2017-02-17T11:07:33.775Z, className: 'impair' }
{ now: 2017-02-17T11:07:34.779Z, className: 'pair' }
<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque seconde, la fonction <code>console.log</code> est appel√©e et affiche la structure
de donn√©es de notre minuteur dans la sortie standard du terminal.</p>
</div>
<div class="paragraph">
<p>Nous pourrions d√®s √† pr√©sent utiliser le minuteur dans d&#8217;autres applications,
c√¥t√© client, c√¥t√© serveur et, pourquoi pas, un jour le publier sur le
registre&#160;<code>npm</code>&#160;?</p>
</div>
</div>
<div class="sect2">
<h3 id="s√©paration_du_fond_et_de_la_forme_donn√©es_rendu_et_interactions">4.4. S√©paration du fond et de la forme : donn√©es, rendu et interactions</h3>
<div class="paragraph">
<p>Les praticien¬∑ne¬∑s de l&#8217;int√©gration web nous le dirons souvent&#160;: il faut
<strong>s√©parer le fond de la forme</strong>.
Il en est de m√™me dans notre code&#160;‚Äì et pas que pour le d√©veloppement <em>front-end</em>.</p>
</div>
<div class="paragraph">
<p>Un code maintenable n&#8217;a pas besoin d&#8217;√™tre complexe.
Il n√©cessite surtout de bien isoler ses p√©rim√®tres d&#8217;intervention.</p>
</div>
<div class="paragraph">
<p>Les exemples pr√©c√©dents nous ont permis de d√©celer trois p√©rim√®tres phares&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>donn√©es&#160;: des structures pr√©dictibles, obtenues ou modifi√©es&#160;;</p>
</li>
<li>
<p>rendu&#160;: la repr√©sentation des donn√©es en contexte, que ce soit une page HTML,
un terminal ou un fichier&#160;CSV&#160;;</p>
</li>
<li>
<p>interactions&#160;: des √©v√©nements d√©clench√©s par les utilisateurs, par des
facteurs externes ou des r√®gles m√©tier&#160;‚Äì ils affectent les donn√©es et leur
repr√©sentation.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="react">4.5. Rapprocher donn√©es, rendu et interactions avec&#160;React</h3>
<div class="paragraph">
<p><em>React</em> a atteint un pic de popularit√© certain en&#160;2015 et&#160;2016,
pas seulement parce que c&#8217;est un outil bien con√ßu, mais justement parce
qu&#8217;il encourage cette pratique de la repr√©sentation des donn√©es.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> API&#160;React</div>
<div class="paragraph">
<p>Les exemples suivants se basent sur la biblioth√®que <em>React</em> (<span class="URL"><a href="https://reactjs.org" class="bare">reactjs.org</a></span>).
Sa documentation offre de bons exemples pour se familiariser avec son utilisation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notre code HTML n&#8217;est qu&#8217;un r√©sultat exposant des surfaces d&#8217;interaction.
Il se structure en composants.
Un composant est responsable de deux choses&#160;: la repr√©sentation de donn√©es et
la r√©action √† des √©v√©nements.</p>
</div>
<div class="paragraph">
<p>Cela se traduira par un changement de taille&#160;: l&#8217;exemple que nous avons fait
√©voluer ne fait plus mention de balise <code>&lt;time&gt;</code> mais expose une balise d√©di√©e √†
contenir notre composant minuteur&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/react-app.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>react-app-browserify.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notre code applicatif est r√©duit √† son plus strict minimum&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/react-app.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> DateInterval <span class="token keyword">from</span> <span class="token string">'./date-interval.jsx'</span><span class="token punctuation">;</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>                                  <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token function">createElement</span><span class="token punctuation">(</span>DateInterval<span class="token punctuation">,</span> <span class="token punctuation">{</span>interval<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// <b class="conum">(2)</b></span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>                  <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>M√©thode responsable du rendu HTML de notre composant <code>TimeInterval</code> dans l&#8217;√©l√©ment <code>&lt;div id="app"&gt;</code>.</p>
</li>
<li>
<p>Cr√©ation de notre composant minuteur avec un intervalle de mise √† jour de 1&#160;000 millisecondes.</p>
</li>
<li>
<p>Indication que le rendu du composant sera effectu√© dans l&#8217;√©l√©ment <code>&lt;div id="app"&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cela ressemble fortement au contenu de nos pr√©c√©dentes invocations de
<code>$(document).ready()</code> mais sans avoir √† se soucier du fonctionnement interne du minuteur.</p>
</div>
<div class="paragraph">
<p>La repr√©sentation et le fonctionnement du minuteur sont d√©sormais regroup√©s
dans un seul composant.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/date-interval.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> timerFn <span class="token keyword">from</span> <span class="token string">'./timer.js'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">DateInterval</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>    <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                   <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>interval<span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onTick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onTick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      tickData<span class="token punctuation">:</span> <span class="token function">timerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> interval<span class="token punctuation">,</span> onTick<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onTick <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onTick</span> <span class="token punctuation">(</span><span class="token parameter">tickData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tickData <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                       <span class="token comment">// <b class="conum">(5)</b></span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>className<span class="token punctuation">,</span> now<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>tickData<span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(6)</b></span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span> <span class="token attr-name">dateTime</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>now<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>
      <span class="token punctuation">{</span>now<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous exportons un composant <em>React</em> gr√¢ce √† l&#8217;op√©rateur <code>extends</code> (<a href="../chapter-03/index.html#primitive-class">chapitre&#160;3</a>).</p>
</li>
<li>
<p>Le <code>constructor</code> est ex√©cut√© quand le composant est rendu dans le document.</p>
</li>
<li>
<p>La propri√©t√© <code>interval</code> nous est fournie dans <code>react-app.js</code> et nous stockons la structure de donn√©e retourn√©e par le minuteur tout en d√©clenchant son actualisation toutes les 1&#160;000 millisecondes.</p>
</li>
<li>
<p>√Ä chaque intervalle, nous mettons √† jour la valeur <code>tickData</code> de l&#8217;√©tat interne du composant (<code>this.state</code>).</p>
</li>
<li>
<p>La m√©thode <code>render()</code> est ex√©cut√©e quand le composant est ins√©r√© dans un document pour la premi√®re fois et quand l&#8217;√©tat interne (<code>this.state</code>) change.</p>
</li>
<li>
<p>Nous d√©structurons la valeur connue de <code>tickData</code> pour effectuer une op√©ration qui nous rappelle les diff√©rents appels √† <code>.attr('class')</code> et <code>.text()</code> de <em>jQuery</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>React</em> introduit trois concepts au sein des composants&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un cycle de vie bas√© sur des propri√©t√©s (<em>props</em>) et un √©tat interne (<em>state</em>)&#160;;</p>
</li>
<li>
<p>des propri√©t√©s immuables pour le param√©trage initial&#160;;</p>
</li>
<li>
<p>un √©tat interne mutable pour contenir les changements et demander une
actualisation de leur repr√©sentation dans le document.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>React</em> d√©termine les op√©rations √† effectuer dans le document HTML en fonction
de leur lourdeur&#160;: (re)cr√©ation compl√®te de <code>&lt;time&gt;</code> dans le n≈ìud
parent, simple mise √† jour d&#8217;un ou plusieurs attribut(s) ou encore d√©placement
du composant ailleurs dans le document HTML, etc.</p>
</div>
<div class="paragraph">
<p>L&#8217;intelligence d&#8217;une biblioth√®que comme <em>React</em> est d&#8217;encourager √† d√©crire
les donn√©es et leur rendu pour se charger des op√©rations d&#8217;√©criture dans le DOM.
Cela conduit √† cr√©er des composants faciles √† isoler, √† r√©utiliser et √† tester.</p>
</div>
<div class="paragraph">
<p>Cette approche nous a laiss√©s r√©utiliser notre minuteur simplement en l&#8217;adaptant.
<em>React</em> nous permet de diriger l&#8217;affichage du document plut√¥t que d&#8217;en d√©pendre.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Outil</span> React Developer Tools</div>
<div class="paragraph">
<p>Une extension pour les navigateurs Chrome et Firefox d√©taille l&#8217;arborescence
des composants mont√©s dans le document HTML ainsi qu&#8217;une vue de leurs propri√©t√©s
respectives&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://chrome.google.com/webstore/detail/fmkadmapgofadopljbjfkapdkoienihi" class="bare">chrome.google.com/webstore/detail/fmkadmapgofadopljbjfkapdkoienihi</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://addons.mozilla.org/firefox/addon/react-devtools/" class="bare">addons.mozilla.org/firefox/addon/react-devtools/</a></span></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/react-devtools.png" alt="react devtools" width="85%">
</div>
<div class="title">Figure 3. React Developer Tools</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="io">5. Des requ√™tes Ajax vers du temps&#160;r√©el</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les technologies web offrent un panel de fonctionnalit√©s cr√©atives et adaptables.
L&#8217;explosion du <em>Web 2.0</em> a co√Øncid√© avec la red√©couverte de <code>XMLHttpRequest</code>,
une API initialement cr√©√©e par Microsoft pour transf√©rer des donn√©es entre
client et serveur, de mani√®re non&#160;bloquante.
Cette fonctionnalit√© a permis de basculer vers un monde de pages dynamiques et
rapides √† charger.
Des applications web comme Google&#160;Maps, Gmail ou la recherche instantan√©e de
Google ont parachev√© la popularisation de cette technique.</p>
</div>
<div class="paragraph">
<p>Toutefois, son API est peu intuitive et est unidirectionnelle, dirig√©e
du client vers le serveur.
Le terme <code>XMLHttpRequest</code> est parfois nomm√© <code>Ajax</code> ou <code>xhr</code>.</p>
</div>
<div class="paragraph">
<p>Un m√™me exemple c√¥t√© client sera d√©velopp√© et successivement adapt√© aux
technologies <code>fetch()</code>, <em>EventSource</em> puis <em>WebSocket</em>.
Il nous permettra d&#8217;en faire √©merger les principes, leurs cas d&#8217;usage ainsi
que leur possible int√©gration avec&#160;Node.</p>
</div>
<div class="paragraph">
<p>L&#8217;impl√©mentation c√¥t√© serveur est bas√©e sur un serveur
<a href="../chapter-07/index.html#express">Express.js</a> dont l&#8217;usage est expliqu√© au
<a href="../chapter-07/index.html">chapitre&#160;7</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/io-example.png" alt="io example" width="85%">
</div>
<div class="title">Figure 4. R√©sultat attendu dans les exemples des sections suivantes</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Node, mais pas&#160;que</div>
<div class="paragraph">
<p><code>fetch()</code>, <em>EventSource</em> et <em>WebSocket</em> reposent sur le protocole HTTP/1 et ses extensions.
Il est important de comprendre que leur contrepartie &#8220;c√¥t√© serveur&#8221; existe aussi
dans d&#8217;autres langages et environnements comme Ruby, Python et PHP.</p>
</div>
<div class="paragraph">
<p>Il se trouve que la nature asynchrone m√™me de Node rend cette int√©gration
relativement ais√©e et triviale, aussi et en grande partie gr√¢ce √† l&#8217;√©cosyst√®me&#160;<code>npm</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="io-fetch">5.1. √âchange ponctuel de donn√©es avec <code>fetch()</code></h3>
<div class="paragraph">
<p><code>fetch()</code> offre une interface tr√®s simple pour appeler une ressource HTTP.
Le r√©sultat est retourn√© sous forme de promesse
(<a href="../chapter-03/index.html#promise">chapitre&#160;3</a>).
Cette fonction sert aussi bien √† obtenir des ressources avec des requ√™tes de
type&#160;<code>GET</code> et <code>HEAD</code> qu&#8217;√† en cr√©er et modifier avec des requ√™tes de type <code>POST</code>,
<code>PUT</code>, <code>DELETE</code> et <code>PATCH</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple associ√© est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/fetch.html" class="bare">localhost:4000/examples/io/fetch.html</a></span>.
Nous pouvons v√©rifier la compatibilit√© navigateur de <code>fetch()</code> sur
<span class="URL"><a href="http://caniuse.com#feat=fetch" class="bare">caniuse.com#feat=fetch</a></span>.</p>
</div>
<div class="paragraph">
<p>Le d√©roul√© d&#8217;ex√©cution d&#8217;un appel √† <code>fetch()</code> est le suivant&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Construction de la requ√™te (URL ou objet <code>Request</code>, options).</p>
</li>
<li>
<p>R√©ception des en-t√™tes de la r√©ponse (objet <code>Response</code>).</p>
</li>
<li>
<p>D√©codage de la r√©ponse.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Plusieurs d√©codeurs de r√©ponse sont fournis nativement&#160;: texte
(<code>response.text()</code>), JSON (<code>response.json()</code>), ArrayBuffer
(<code>response.arrayBuffer()</code>), Blob (<code>response.blob()</code>) et FormData
(<code>response.formData()</code>).</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/fetch-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> userList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#user-list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/new-users'</span><span class="token punctuation">)</span>                             <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                               <span class="token comment">// <b class="conum">(3)</b></span>
      <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>now<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
      userList<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ex√©cution de la requ√™te HTTP <em>GET</em> vers <code>/new-users</code> depuis le navigateur courant.</p>
</li>
<li>
<p>D√©codage progressif de la r√©ponse.</p>
</li>
<li>
<p>Une fois le d√©codage termin√©, le r√©sultat de la requ√™te HTTP est mis √† disposition&#160;‚Äì ici, sous forme de cha√Æne de caract√®res.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/fetch-frames.png" alt="fetch frames" width="85%">
</div>
<div class="title">Figure 5. Traces r√©seau d&#8217;appels successifs √† <code>fetch()</code> ; chacun r√©sultant en une nouvelle requ√™te&#160;HTTP</div>
</div>
<div class="paragraph">
<p>L&#8217;impl√©mentation d&#8217;une ressource HTTP c√¥t√© serveur s&#8217;effectue simplement
en retournant une r√©ponse lors d&#8217;une requ√™te.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/fetch-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> chance <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Chance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/new-users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>chance<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Collection d&#8217;exemples</div>
<div class="paragraph">
<p>Le site communautaire MDN met √† disposition une dizaine d&#8217;exemples
pour illustrer diff√©rents cas d&#8217;utilisation de <code>fetch()</code>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://github.com/mdn/fetch-examples" class="bare">github.com/mdn/fetch-examples</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En r√©sum√©, <code>fetch()</code> est id√©al pour des demandes ponctuelles de donn√©es,
du client vers le serveur.
Le module&#160;<code>npm</code> <code>node-fetch</code> (<span class="URL"><a href="https://npmjs.com/node-fetch" class="bare">npmjs.com/node-fetch</a></span>) est une
impl√©mentation de <code>fetch()</code> pour Node, tandis que <code>whatwg-fetch</code>
(<span class="URL"><a href="https://npmjs.com/whatwg-fetch" class="bare">npmjs.com/whatwg-fetch</a></span>) s&#8217;occupe uniquement de <em>polyfiller</em> les
navigateurs.</p>
</div>
</div>
<div class="sect2">
<h3 id="io-eventsource">5.2. Approche unidirectionnelle avec EventSource</h3>
<div class="paragraph">
<p><em>EventSource</em> est un m√©canisme moins connu que <code>fetch()</code> ou <em>WebSocket</em> mais qui
tire ses origines de la technologie <em>Comet</em>.
On peut l&#8217;assimiler √† une inversion de <code>fetch()</code>&#160;: le client appelle une ressource
serveur, maintient une connexion de longue dur√©e et attend un ou plusieurs
message(s) dudit serveur.</p>
</div>
<div class="paragraph">
<p>Chaque connexion est ouverte en faisant appel √† la construction d&#8217;un objet
<code>EventSource</code>, qui √©met alors plusieurs types d&#8217;√©v√©nements en fonction des actions&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>open</code>&#160;: lorsque le client s&#8217;est connect√© au serveur&#160;;</p>
</li>
<li>
<p><code>message</code>&#160;: lorsque le serveur √©met des donn√©es √† destination du client&#160;;</p>
</li>
<li>
<p><code>close</code>&#160;: lorsque la connexion est ferm√©e par le serveur&#160;;</p>
</li>
<li>
<p><code>error</code>&#160;: lorsque la connexion est accidentellement interrompue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce mod√®le de connexion permet tout aussi bien d&#8217;avoir un canal de donn√©es
unique avec chaque utilisateur ou encore d&#8217;√©mettre les m√™mes donn√©es en temps
r√©el √† destination de tous les usagers.</p>
</div>
<div class="paragraph">
<p>L‚Äôexemple associ√© est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/eventsource.html" class="bare">localhost:4000/examples/io/eventsource.html</a></span>.
Nous pouvons v√©rifier la compatibilit√© navigateur de <em>EventSource</em> sur
<span class="URL"><a href="http://caniuse.com#feat=eventsource" class="bare">caniuse.com#feat=eventsource</a></span>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/eventsource-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">'/new-users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> userList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#user-list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>now<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  userList<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous ouvrons une nouvelle connexion <em>EventSource</em> de longue dur√©e depuis
le navigateur courant.</p>
</li>
<li>
<p>Fonction appel√©e √† chaque fois que le serveur transmet un message au client.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/eventsource-frames.png" alt="eventsource frames" width="85%">
</div>
<div class="title">Figure 6. Plusieurs messages peuvent √™tre transmis par le biais d&#8217;une seule connexion HTTP avec <em>EventSource</em></div>
</div>
<div class="paragraph">
<p>L&#8217;impl√©mentation d'<em>EventSource</em> demande un peu d&#8217;efforts c√¥t√© serveur, mais ne
n√©cessite pas de framework particulier.
La complexit√© r√©side dans le maintien d&#8217;une transmission de donn√©es d√©di√©e √†
chaque client ainsi qu&#8217;√† la lib√©ration de la connexion lorsque le client se d√©connecte.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/eventsource-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'faye-websocket'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>EventSource<span class="token punctuation">}</span> <span class="token operator">=</span> WebSocket<span class="token punctuation">;</span>

<span class="token keyword">const</span> chance <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Chance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/new-users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>EventSource<span class="token punctuation">.</span><span class="token function">isEventSource</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// <b class="conum">(1)</b></span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> es <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">const</span> loop <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      es<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>chance<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    es<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
      es <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Une connexion <em>EventSource</em> s&#8217;effectue (presque) comme une requ√™te HTTP classique&#160;‚Äì il convient de v√©rifier qu&#8217;elle s&#8217;annonce en tant que&#160;telle.</p>
</li>
<li>
<p>Cr√©ation d&#8217;un canal unique entre le client et le serveur.</p>
</li>
<li>
<p>Chaque appel √† <code>es.send</code> enverra un nouveau message au client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le serveur est responsable de la gestion des connexions demand√©es par les
diff√©rents clients.</p>
</div>
<div class="admonitionblock note info">
<table>
<tr>
<td class="icon">
<div class="title">üìñ</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> EventSource</div>

Rendez-vous sur <em>MDN web docs</em> pour en savoir plus sur EventSource.<br>
<a href="https://developer.mozilla.org/docs/fr/Server-sent_events" class="bare URL" target="_blank" rel="noopener">developer.mozilla.org/docs/fr/Server-sent_events</a>

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En r√©sum√©, <em>EventSource</em> est id√©al pour maintenir une connexion avec le serveur
et souscrire √† des mises √† jour en continu.
Chaque connexion <em>EventSource</em> devrait concerner qu&#8217;un seul et m√™me type d&#8217;√©v√©nement.</p>
</div>
</div>
<div class="sect2">
<h3 id="io-websocket">5.3. √âchanges en temps&#160;r√©el avec WebSocket</h3>
<div class="paragraph">
<p><em>WebSocket</em> est une technologie web favorisant les √©changes bidirectionnels
entre client et serveur.</p>
</div>
<div class="paragraph">
<p>√Ä l&#8217;inverse du protocole HTTP/1, tout message envoy√© par le client ou par le
serveur n&#8217;appelle pas √† une r√©ponse de la part du receveur.
Cet √©l√©ment et le maintien d&#8217;une connexion permanente expliquent la
rapidit√© du protocole en comparaison avec le mod√®le requ√™te/r√©ponse.</p>
</div>
<div class="paragraph">
<p>L‚Äôexemple associ√© est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/websocket.html" class="bare">localhost:4000/examples/io/websocket.html</a></span>.
Nous pouvons v√©rifier la compatibilit√© navigateur de <em>WebSocket</em> sur
<span class="URL"><a href="http://caniuse.com#feat=websocket" class="bare">caniuse.com#feat=websocket</a></span>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/websocket-client.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:4000/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> userList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#user-list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> interval<span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> action<span class="token punctuation">:</span> <span class="token string">'getName'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>          <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>now<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  userList<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  ws <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous ouvrons une connexion <em>WebSocket</em> depuis le navigateur courant.</p>
</li>
<li>
<p>√âmission d&#8217;un message √† destination du serveur.</p>
</li>
<li>
<p>R√©action √† un message √©mis par le serveur.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/websocket-frames.png" alt="websocket frames" width="85%">
</div>
<div class="title">Figure 7. Trame de messages envoy√©s par le client (sur fond vert) et par le serveur</div>
</div>
<div class="paragraph">
<p>L&#8217;impl√©mentation c√¥t√© serveur est l√©g√®rement plus compliqu√©e qu&#8217;avec
<em>EventSource</em> pour la simple et bonne raison que <em>Websocket</em> est une surcouche
du protocole&#160;<code>ws</code>.
HTTP n&#8217;est utilis√© que comme canal de communication pour √©tablir un lien avec
le serveur&#160;<code>ws</code>.
HTTP sert de tunnel tandis que le dialogue entre client et serveur s&#8217;effectue
dans un dialecte compr√©hensible uniquement de clients <em>WebSocket</em>.</p>
</div>
<div class="paragraph">
<p>Il est n√©cessaire d&#8217;utiliser un module&#160;<code>npm</code> <em>WebSocket</em> comme <em>faye</em>
(<span class="URL"><a href="https://npmjs.com/faye-websocket" class="bare">npmjs.com/faye-websocket</a></span>) ou <em>socket.io</em>
(<span class="URL"><a href="https://npmjs.com/socket.io" class="bare">npmjs.com/socket.io</a></span>) √† moins de vouloir r√©impl√©menter le protocole
soi-m√™me.
Le motif de conception est similaire √† celui d'<em>EventSource</em>, √† la diff√©rence pr√®s
qu&#8217;il faut aussi √©couter les messages transmis par le client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> HTTP et le statut 101 Switching Protocols</div>
<div class="paragraph">
<p>Voici ce qui se passe lorsqu&#8217;un client <em>WebSocket</em> se connecte sur <code>ws://example.com</code>&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Requ√™te HTTP <code><a href="http://example.com" class="bare">example.com</a></code> standard contenant les en-t√™tes <code>Upgrade: websocket</code> et <code>Connection: Upgrade</code>.</p>
</li>
<li>
<p>Le serveur HTTP r√©pond avec un statut <code>101 Switching Protocols</code>.</p>
</li>
<li>
<p>Le serveur <em>WebSocket</em> prend le relais dans le dialogue client/serveur.</p>
</li>
<li>
<p>Client et serveur communiquent d√©sormais via le protocole <code>ws</code> au sein de la connexion HTTP initiale.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Par extension et de par la nature m√™me du protocole <code>ws</code>, il serait tout √†
fait possible que <em>et</em> clients <em>et</em> serveur soient des agents Node.
Autrement dit, un client <em>WebSocket</em> ne doit pas n√©cessairement √™tre un navigateur.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">io/websocket-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'faye-websocket'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chance <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chance'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Chance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">server</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'upgrade'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> body<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>WebSocket<span class="token punctuation">.</span><span class="token function">isWebSocket</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment">// <b class="conum">(2)</b></span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(3)</b></span>

    ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                  <span class="token comment">// <b class="conum">(4)</b></span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">'getName'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>chance<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(5)</b></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      ws <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le serveur HTTP vient de r√©pondre avec un statut <code>101 Switching Protocols</code> et d√©l√®gue d√©sormais la responsabilit√© du dialogue client/serveur.</p>
</li>
<li>
<p>Nous v√©rifions que le changement de protocole concerne le protocole <code>ws</code>.</p>
</li>
<li>
<p>La connexion r√©seau (<code>socket</code>) est transmise au serveur <em>WebSocket</em> pour amorcer le dialogue client/serveur avec le protocole <code>ws</code>.</p>
</li>
<li>
<p>R√©action √† la r√©ception d&#8217;un message client.</p>
</li>
<li>
<p>√âmission d&#8217;un message √† destination d&#8217;un client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L√† aussi, le serveur est responsable de la gestion des connexions demand√©es par
les diff√©rents clients.</p>
</div>
<div class="admonitionblock note info">
<table>
<tr>
<td class="icon">
<div class="title">üìñ</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> WebSockets</div>

Rendez-vous sur <em>MDN web docs</em> pour en savoir plus sur WebSockets.<br>
<a href="https://developer.mozilla.org/docs/fr/WebSockets" class="bare URL" target="_blank" rel="noopener">developer.mozilla.org/docs/fr/WebSockets</a>

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En r√©sum√©, <em>WebSocket</em> est id√©al pour maintenir une connexion en temps&#160;r√©el et
pour relayer plusieurs messages √† l&#8217;initiative du serveur et de tout client
connect√©&#160;‚Äì qu&#8217;il s&#8217;agisse d&#8217;un navigateur ou d&#8217;un agent Node.
Chaque connexion <em>WebSocket</em> peut encapsuler plusieurs types de messages.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="d√©velopper_au_quotidien">6. D√©velopper au quotidien</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons beaucoup parl√© de nouvelles techniques et de modularisation.
Cela peut sembler rebutant, notamment par l&#8217;introduction d&#8217;outils auxquels
nous ne sommes pas encore familiers.</p>
</div>
<div class="paragraph">
<p>L&#8217;√©cosyst√®me Node fournit √©norm√©ment d&#8217;outils qui devraient nous faire
gagner du temps, en nous aidant √† organiser notre travail ou √† ex√©cuter des actions
lorsqu&#8217;un fichier est modifi√©, mais aussi en actualisant automatiquement
notre application web au fil du d√©veloppement
(fini les appuis r√©p√©t√©s sur la touche&#160;<kbd>F5</kbd>) ou encore en
optimisant nos fichiers graphiques.</p>
</div>
<div class="sect2">
<h3 id="watchify">6.1. Reconstruire en continu avec <code>watchify</code></h3>
<div class="paragraph">
<p>L&#8217;utilisation de <a href="#browserify">browserify</a> nous apporte du confort avec la
possibilit√© d&#8217;inclure des modules&#160;<code>npm</code> dans les navigateurs.
En revanche, cela nous demande de g√©n√©rer des artefacts&#160;‚Äì des <em>bundles</em>&#160;‚Äì √†
chaque modification pour consolider ces changements.</p>
</div>
<div class="paragraph">
<p>C&#8217;est √† ce moment qu&#8217;intervient le module <em>watchify</em> (<span class="URL"><a href="https://npmjs.com/watchify" class="bare">npmjs.com/watchify</a></span>).
Il fonctionne exactement comme <em>browserify</em>, mais au lieu de compiler une seule
fois, il compile d√®s qu&#8217;un changement est d√©tect√©&#160;‚Äì o√π que ce soit dans l&#8217;arbre
de d√©pendances du point d&#8217;entr√©e (param√®tre&#160;<code>-e</code>, <code>--entrypoint</code>).</p>
</div>
<div class="paragraph">
<p>La commande suivante compilerait le fichier <code>examples/modules/react-app.js</code>
une seule fois&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/browserify -t babelify \
  -e examples/modules/react-app.js \
  -o examples/modules/react-app-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit de remplacer <code>browserify</code> par <code>watchify</code>&#160;‚Äì le programme garde la main
et indique chaque nouvelle compilation sur une nouvelle ligne.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/watchify -dv -t babelify \
  -e examples/modules/react-app.js \
  -o examples/modules/react-app-browserify.js
1840601 bytes written to react-app-browserify.js (2.58 seconds) at 4:44:28 PM
352482 bytes written to react-app-browserify.js (0.10 seconds) at 4:45:09 PM
1840605 bytes written to react-app-browserify.js (0.25 seconds) at 4:45:15 PM</pre>
</div>
</div>
<div class="paragraph">
<p><em>watchify</em> utilise un m√©canisme dit de <strong>compilation incr√©mentale</strong>&#160;: il ne
recompile pas tout, mais uniquement les diff√©rences depuis le dernier changement.
C&#8217;est beaucoup plus rapide et tout aussi efficace.</p>
</div>
<div class="paragraph">
<p>Trois arguments sont utiles √† <em>watchify</em>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-v</code>&#160;(<code>--verbose</code>)&#160;: force la cr√©ation du fichier compil√© au lancement de la commande.</p>
</li>
<li>
<p><code>-o</code>&#160;(<code>--outfile</code>)&#160;: sp√©cifie le chemin d&#8217;enregistrement du fichier compil√©&#160;‚Äì il est impossible d&#8217;utiliser la <a href="../chapter-04/index.html#stdio">sortie standard</a> (<a href="../chapter-04/index.html">chapitre&#160;4</a>).</p>
</li>
<li>
<p><code>-d</code>&#160;(<code>--debug</code>)&#160;: (lire &#8220;<a href="#browserify-sourcemaps">Les source&#160;maps</a>&#8221; dans ce m√™me chapitre).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="livereload">6.2. Changements en temps&#160;r√©el dans le navigateur</h3>
<div class="paragraph">
<p>Modifier un fichier. Changer de fen√™tre. Recharger. Changer de fen√™tre. Re-modifier
un fichier. Changer de fen√™tre. Recharger. L√† c&#8217;est bon.</p>
</div>
<div class="paragraph">
<p>La quantit√© d&#8217;outils √† disposition et leurs diff√©rentes opinions sur notre mani√®re
de travailler nous obligent √† prendre des postures de travail qui ne vont
pas n√©cessairement dans le sens de la productivit√©.</p>
</div>
<div class="paragraph">
<p>L&#8217;int√©gration de Node avec le syst√®me d&#8217;exploitation va nous aider √† d√©clencher
des actions lorsque des fichiers sont modifi√©s.
Ces modifications sont parfois de notre fait, directement ou par le biais d&#8217;un
autre logiciel (un optimiseur d&#8217;images ou la <a href="#node-sass">compilation d&#8217;un fichier Sass</a> par exemple).</p>
</div>
<div class="paragraph">
<p>Nous allons explorer deux strat√©gies d&#8217;actualisation&#160;: le rafra√Æchissement
automatique du navigateur et le remplacement de modules √† chaud
(<em>Hot Module Replacement</em>, HMR).</p>
</div>
<div class="paragraph">
<p><em>browser-sync</em> est un outil formidable de d√©veloppement pour
rafra√Æchir automatiquement une page web si son contenu ou une des ressources
associ√©es change.
Il offre √©galement la possibilit√© de propager les changements sur plusieurs
fen√™tres et terminaux&#160;‚Äì y compris les clics, d√©filements et toute interaction
avec des formulaires.</p>
</div>
<div class="videoblock">
<div class="title">Exemple de synchronisation d&#8217;affichage et de contenus entre deux fen√™tres avec browser-sync</div>
<div class="content">
<video src="./videos/browser-sync.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p><em>browser-sync</em> maintient la position du curseur de d√©filement lors d&#8217;un rechargement de contenu.
L&#8217;outil se lance soit de mani√®re autonome, soit en <em>proxy</em> entre l&#8217;utilisateur
et tout autre serveur web.
Il ne n√©cessite pas non plus de plug-in ou d&#8217;extension navigateur pour fonctionner,
ce qui le rend id√©al pour du prototypage, de la recherche utilisateur ou du
d√©veloppement local.</p>
</div>
<div class="listingblock">
<div class="title">Lancement d&#8217;un serveur web autonome avec synchronisation sur le port&#160;4000</div>
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/browser-sync start --server --port 4000 .</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre l&#8217;int√©gration de <em>browser-sync</em> avec le serveur
web exposant les exemples de ce chapitre (voir le d√©tail dans le fichier <code>server.js</code>)&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">livereload/server-sync.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">server</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>             <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">return</span> <span class="token parameter">port</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                         <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">const</span> <span class="token constant">PUBLIC_PORT</span> <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>              <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(4)</b></span>

    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                              <span class="token comment">// <b class="conum">(5)</b></span>
      files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./examples'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      port<span class="token punctuation">:</span> <span class="token constant">PUBLIC_PORT</span><span class="token punctuation">,</span>
      open<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      logPrefix<span class="token punctuation">:</span> <span class="token string">'nodebook'</span><span class="token punctuation">,</span>
      proxy<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span><span class="token comment">// <b class="conum">(6)</b></span>
        ws<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On passe un serveur&#160;HTTP en argument (obtenu via <code>http.createServer()</code> par exemple).</p>
</li>
<li>
<p>Ce port sera affect√© au serveur web mais ne sera pas vou√© √† √™tre public.</p>
</li>
<li>
<p>Ce port, lui, sera public.</p>
</li>
<li>
<p>D√©marrage du serveur web sur le port priv√©.</p>
</li>
<li>
<p>Initialisation de <em>browser-sync</em>.</p>
</li>
<li>
<p>Interfa√ßage avec le serveur web cr√©√© au point&#160;4.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La synchronisation peut √™tre activ√©e avec tous les exemples du chapitre en
suffixant la commande <code>npm start</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>cd $(nodebook dir chapter-09)
<span data-bash-subs="$"></span>npm start -- --with-sync</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>browser-sync</em></div>
<div class="paragraph">
<p><em>browser-sync</em> (<span class="URL"><a href="https://browsersync.io" class="bare">browsersync.io</a></span>) est richement document√© et
illustr√©, y&#160;compris ses int√©grations avec les outils Gulp et Grunt.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>browser-sync</em> a beau maintenir la position du d√©filement, il n&#8217;en reste pas
moins que chaque changement remet √† z√©ro l&#8217;espace m√©moire de la page.
C&#8217;est l√† qu&#8217;entre en jeu le remplacement des modules √† chaud.</p>
</div>
<div class="paragraph">
<p>Le <strong>remplacement des modules √† chaud</strong> (<em>Hot Module Replacement</em> ou HMR) est
une technique bas√©e sur le remplacement de fonctions ou d&#8217;objets tout en assurant
le maintien de leurs variables ou √©tats internes.
Cette technique a notamment √©t√© popularis√©e par la combinaison de la biblioth√®que
<em>React</em> et de l&#8217;outil d&#8217;assemblage <em>Webpack</em>.
Il est toutefois possible de proc√©der √† du remplacement √† chaud sans <em>React</em>
et sans <em>Webpack</em>.</p>
</div>
<div class="paragraph">
<p>Quatre actions sont effectu√©es&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un serveur de remplacement √† chaud est d√©marr√© localement.</p>
</li>
<li>
<p>L&#8217;outil d&#8217;assemblage (<em>browserify</em>, <em>Webpack</em>, etc.) ins√®re du code client
pour √©tablir un lien entre la page web et le serveur de remplacement √† chaud.</p>
</li>
<li>
<p>L&#8217;outil d&#8217;assemblage d√©clare les fichiers modifi√©s, transmis par le serveur
de remplacement √† chaud vers le navigateur.</p>
</li>
<li>
<p>Le code client remplace les modules et maintient leur √©tat interne.</p>
</li>
</ul>
</div>
<div class="videoblock">
<div class="title">Exemple de rechargement √† chaud avec des composants React</div>
<div class="content">
<video src="./videos/react-hmr.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Le plug-in <em>Browserify</em> nomm√© <em>livereactload</em> (<span class="URL"><a href="https://npmjs.com/livereactload" class="bare">npmjs.com/livereactload</a></span>)
est tr√®s certainement le plus facile √† mettre en place pour remplacer des
modules <em>React</em> √† la vol√©e.
Il n√©cessite une ligne de configuration c√¥t√© <em>browserify</em> mais aucun
changement de code c√¥t√© client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> livereactload</div>
<div class="paragraph">
<p>Des aides √† l&#8217;installation du module <em>livereactload</em> sont disponibles dans
son fichier README.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le remplacement √† chaud n&#8217;est possible que lorsque nous sommes dans un √©tat
de reconstruction en continu, par exemple avec <a href="#watchify">watchify</a>.</p>
</div>
<div class="paragraph">
<p>Nous pouvons constater les effets du remplacement √† chaud avec un des exemples
de ce chapitre, accessible sur <span class="URL"><a href="http://localhost:4000/examples/livereload/react-app-hmr.html" class="bare">localhost:4000/examples/livereload/react-app-hmr.html</a></span>.
La commande <code>npm run watch</code> de ce chapitre d√©marre un serveur web et reconstruit
en continu le fichier <code>./examples/livereload/react-app-hmr.js</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>cd $(nodebook dir chapter-09)
<span data-bash-subs="$"></span>npm run watch</pre>
</div>
</div>
<div class="paragraph">
<p>Qui n&#8217;est autre qu&#8217;un √©quivalent de&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/watchify -dv \
  -t babelify \
  -p livereactload \
  -e ./examples/livereload/react-app-hmr.js \
  -o ./examples/livereload/react-app-hmr-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>Dans cet exemple, le <em>transform</em>&#160;(<code>-t</code>) modifie le code source √† la vol√©e&#160;‚Äì
ici, pour adapter le code √©crit dans une syntaxe compr√©hensible par la majorit√©
des navigateurs gr√¢ce √† l&#8217;outil <a href="#transpilation">Babel</a>.</p>
</div>
<div class="paragraph">
<p>Le plug-in &#160;(<code>-p</code>) ne transforme pas le code mais le fonctionnement de
<em>watchify</em> pour y ajouter des fonctionnalit√©s&#160;‚Äì ici, refl√©ter les
changements du fichier source vers le navigateur en temps r√©el.</p>
</div>
<div class="paragraph">
<p>Il faudra ensuite modifier l&#8217;un des deux fichiers suivants&#160;‚Äì en d√©commentant les lignes concern√©es par exemple&#160;‚Äì pour constater les changements dans notre navigateur.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">livereload/react-app-hmr.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ButtonCount <span class="token keyword">from</span> <span class="token string">'./button-count.jsx'</span><span class="token punctuation">;</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span>ButtonCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span>ButtonCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// createElement(ButtonCount),</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque instance du composant <code>livereload/button-count.jsx</code> g√®re un √©tat interne
ind√©pendant des autres instances de m√™me type.
Nous aurions perdu cet √©tat interne en cas d&#8217;utilisation de <em>browser-sync</em>, sans
remplacement √† chaud&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">livereload/button-count.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ButtonCount</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      clickCount<span class="token punctuation">:</span> <span class="token number">0</span>                                           <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleClick</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> clickCount<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>clickCount <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// style = {</span>
    <span class="token comment">//   fontFamily: 'monospace',</span>
    <span class="token comment">//   fontWeight: 'bold',</span>
    <span class="token comment">//   textTransform:' uppercase',</span>
    <span class="token comment">// };</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>
      Clics <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>clickCount<span class="token punctuation">}</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initialisation du compteur de clics propre √† chaque instance de <code>ButtonCount</code>.</p>
</li>
<li>
<p>Incr√©mentation du compteur de clics en r√©action √† un clic sur le composant <code>ButtonCount</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> ud et browserify-hmr</div>
<div class="paragraph">
<p>Deux modules vont nous aider&#160;: <em>ud</em> (<span class="URL"><a href="https://npmjs.com/ud" class="bare">npmjs.com/ud</a></span>)
et <em>browserify-hmr</em> (<span class="URL"><a href="https://npmjs.com/browserify-hmr" class="bare">npmjs.com/browserify-hmr</a></span>), respectivement pour
d√©clarer des modules rempla√ßables et pour d√©marrer un serveur de remplacement
√† chaud minimaliste.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="node-sass">6.3. Modulariser ses feuilles de styles avec&#160;Sass</h3>
<div class="paragraph">
<p>La modularit√© et l&#8217;√©criture d&#8217;un code isol√© facilitent sa r√©utilisation et
pr√©viennent les effets de bord.
Dans le cas des feuilles de styles CSS, cela peut √©viter de faire
d√©border la cascade&#160;‚Äì si l&#8217;on peut&#160;dire.</p>
</div>
<div class="paragraph">
<p>Avec le langage Sass (<span class="URL"><a href="http://sass-lang.com" class="bare">sass-lang.com</a></span>), nous pourrions songer √†
g√©n√©rer des blocs de code selon des listes (id√©al pour des th√®mes de couleurs,
des rubriques produits, etc.), √† concevoir des composants comme des fonctions
ou √† b√©n√©ficier de fonctions de calcul de couleurs ou d&#8217;unit√©s de mesure.</p>
</div>
<div class="paragraph">
<p>Le langage Sass est originaire du monde Ruby, mais il a √©t√© depuis rendu
accessible nativement √† l&#8217;√©cosyst√®me Node par le biais de <em>node-sass</em>
(<span class="URL"><a href="https://npmjs.com/node-sass" class="bare">npmjs.com/node-sass</a></span>)‚Äì et, par extension,
par la biblioth√®que&#160;C <em>libsass</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lecture</span> CSS maintenables avec Sass et Compass</div>
<div class="paragraph">
<p>Je recommande la lecture de l&#8217;ouvrage de r√©f√©rence
<em>CSS&#160;maintenables avec Sass et Compass</em>,
√©crit par Kaelig&#160;Deloumeau-Prigent aux √©ditions Eyrolles.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://editions-eyrolles.com/Livre/9782212136401" class="bare">editions-eyrolles.com/Livre/9782212136401</a></span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il d√©crit tr√®s bien les tenants et aboutissants de Sass, ainsi que de bonnes
m√©thodes d&#8217;organisation du code et de maintenabilit√© au sein d&#8217;une √©quipe de
travail.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>node-sass</em> offre un outil en ligne de commande pour compiler un fichier Sass,
plusieurs fichiers Sass ou encore une arborescence de r√©pertoires contenant des
fichiers Sass vers des fichiers CSS compr√©hensibles par les navigateurs.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">ui/buttons.scss</div>
<div class="content">
<pre class="highlight"><code class="language-sass" data-lang="sass"><span class="token variable-line"><span class="token variable">$sizes</span><span class="token punctuation">:</span> (                             <span class="token operator">/</span><span class="token operator">/</span> <b class="conum">(1)</b></span>
<span class="token property-line">  <span class="token property">small</span><span class="token punctuation">:</span> .8,</span>
<span class="token property-line">  <span class="token property">regular</span><span class="token punctuation">:</span> 1,</span>
<span class="token property-line">  <span class="token property">large</span><span class="token punctuation">:</span> 1.2</span>
<span class="token selector">);</span>

<span class="token selector">.btn {</span>
<span class="token atrule-line">  <span class="token atrule">@each</span> $size, $factor in $sizes {    // <b class="conum">(2)</b></span>
    <span class="token selector">&amp;amp;.btn--#{$size} {                 // <b class="conum">(3)</b></span>
<span class="token property-line">      <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token variable">$factor</span> <span class="token operator">*</span> 1em;       <span class="token operator">/</span><span class="token operator">/</span> <b class="conum">(4)</b></span>
    <span class="token selector">}</span>
  <span class="token selector">}</span>

  <span class="token selector">&amp;amp;.btn--icon {                       // <b class="conum">(5)</b></span>
    <span class="token selector">svg {</span>
<span class="token property-line">      <span class="token property">height</span><span class="token punctuation">:</span> 16px;</span>
<span class="token property-line">      <span class="token property">width</span><span class="token punctuation">:</span> 16px;</span>
<span class="token property-line">      <span class="token property">margin-right</span><span class="token punctuation">:</span> .5em;</span>
    <span class="token selector">}</span>
  <span class="token selector">}</span>
<span class="token selector">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>D√©finition d&#8217;une <code>Map</code> nomm√©e <code>$sizes</code> (ensemble cl√©/valeur) d√©crivant des tailles et leur facteur multiplicateur.</p>
</li>
<li>
<p>It√©ration et extraction des cl√©s/valeurs de <code>$sizes</code>.</p>
</li>
<li>
<p>Interpolation d&#8217;une variable pour composer un s√©lecteur CSS (<code>.btn&#8212;&#8203;small</code>, <code>.btn&#8212;&#8203;regular</code> etc.).</p>
</li>
<li>
<p>Calcul de la taille de la police de caract√®res (<code>.8em</code>, <code>1em</code>, etc.).</p>
</li>
<li>
<p>Composition d&#8217;un s√©lecteur de classe √† partir du s√©lecteur courant (<code>.btn.btn&#8212;&#8203;icon</code>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La compilation des fichiers s&#8217;effectue tr√®s simplement&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/node-sass -o ./examples ./examples/buttons.scss</pre>
</div>
</div>
<div class="paragraph">
<p>Elle produit le fichier CSS <code>button.css</code>, lisible par tout navigateur&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">ui/buttons.css</div>
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css"><span class="token selector">.btn.btn--small</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token selector">.btn.btn--regular</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token selector">.btn.btn--large</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 1.2em<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token selector">.btn.btn--icon svg</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
  <span class="token property">margin-right</span><span class="token punctuation">:</span> .5em<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Astuce</span> Oublions les vendor prefix</div>
<div class="paragraph">
<p>Les navigateurs √©voluent plus vite que le cycle de vie de nos projets.
Certaines propri√©t√©s CSS sont abrit√©es derri√®re des pr√©fixes (<code>-moz</code>, <code>-webkit</code>,
etc.) avant d&#8217;√™tre standardis√©es.</p>
</div>
<div class="paragraph">
<p>Les modules <em>autoprefixer</em> (<span class="URL"><a href="https://npmjs.com/autoprefixer" class="bare">npmjs.com/autoprefixer</a></span>) et
<em>postcss</em> (<span class="URL"><a href="https://npmjs.com/postcss" class="bare">npmjs.com/postcss</a></span>) nous facilitent la t√¢che en pr√©fixant
et r√©√©crivant automatiquement les attributs en fonction de nos exigences de
compatibilit√© avec les navigateurs.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ui-bundling">6.4. Lier composants visuels et feuilles de&#160;styles</h3>
<div class="paragraph">
<p>Souvenons-nous de la section expliquant le
<a href="#react">rapprochement entre donn√©es, rendu et interactions avec React</a>.
Finalement, nous avons presque tout rapproch√©, exception faite de la pr√©sentation
avec Sass ou CSS.</p>
</div>
<div class="paragraph">
<p>En suivant la logique de notre approche modulaire, nous pourrions imaginer
un <em>transform browserify</em> pour compiler et/ou extraire notre code Sass ou
CSS depuis nos modules CommonJS ou ECMAScript.</p>
</div>
<div class="paragraph">
<p>C&#8217;est exactement la proposition du module <em>sassify</em>.
Il int√®gre <em>node-sass</em> en tant que <em>transform browserify</em> et transforme le
code √† la vol√©e durant la phase de compilation.
Il se charge lui-m√™me d&#8217;ajouter les styles dans le document HTML ou expose le
code CSS compil√© via la fonction <code>require()</code>.</p>
</div>
<div class="paragraph">
<p>Une saine strat√©gie serait de charger des CSS de base dans une feuille de styles
en t√™te de <code>&lt;head&gt;</code> puis de laisser les composants graphiques injecter leurs
feuilles CSS respectives apr√®s coup.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant expose deux composants <em>React</em>, regroup√©s dans une th√©matique
de composants de boutons HTML.
Une feuille de styles est import√©e √† m√™me le module afin de g√©rer au m√™me niveau
pr√©sentation, rendu et interactions&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">ui/Buttons.jsx</div>
<div class="content">
<pre class="highlight"><code class="language-jsx" data-lang="jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./buttons.scss'</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">const</span> <span class="token function-variable function">Icon</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>use</span> <span class="token attr-name">xlinkHref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">'symbols.svg#'</span> <span class="token operator">+</span> props<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">BaseButton</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">'btn btn--'</span> <span class="token operator">+</span> props<span class="token punctuation">.</span>variant<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">IconButton</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn--icon<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Icon</span></span> <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>icon<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
    <span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Import d&#8217;un fichier Sass qui sera par la suite compil√© en CSS par le <em>transform sassify</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Sans surprise, le module <em>sassify</em> se charge comme la majorit√© des
<em>transforms browserify</em> comme vu dans la section
&#8220;<a href="#browserify">Importer des modules&#160;<code>npm</code> pour le Web</a>&#8221; dans ce m√™me chapitre&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/browserify \
  -t sassify \
  -t babelify \
  -e ./examples/Buttons.jsx \
  -o ./examples/Button-browserify.js</pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante injectera automatiquement les feuilles de style compil√©es
dans le document HTML lors de son ex√©cution dans un navigateur&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/browserify \
  -t [ sassify --auto-inject ] \
  -t babelify \
  -e ./examples/Buttons.jsx \
  -o ./examples/Button-browserify.js</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="optimiser_ses_ressources_graphiques">6.5. Optimiser ses ressources graphiques</h3>
<div class="paragraph">
<p>Node est un outil de choix lorsque l&#8217;on souhaite s&#8217;atteler au d√©veloppement
<em>front-end</em> et ce n&#8217;est pas sans raison.
Outre l&#8217;outillage li√© √† la r√©√©criture du code, il regorge de modules&#160;<code>npm</code>
r√©duisant les t√¢ches manuelles r√©p√©titives et possiblement sujettes √† erreur.</p>
</div>
<div class="paragraph">
<p>Nous retrouvons l&#8217;optimisation des ressources graphiques parmi cet ensemble de
t√¢ches r√©barbatives.
Quand j&#8217;√©cris ressources graphiques, j&#8217;entends par l√† le redimensionnement ou
la cr√©ation de vignettes d&#8217;images, l&#8217;optimisation de leur poids, la fusion de
fichiers&#160;SVG sous forme de symboles, la cr√©ation de piles de
polices de caract√®res et m√™me l&#8217;encodage audio/vid√©o&#160;‚Äì via des logiciels
sp√©cialis√©s comme <em>FFmpeg</em> ou <em>LAME</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;outil en ligne de commande <em>imagemin-cli</em> (<span class="URL"><a href="https://npmjs.com/imagemin-cli" class="bare">npmjs.com/imagemin-cli</a></span>)
est le module de r√©f√©rence pour optimiser les fichiers graphiques.
Il est bas√© sur la biblioth√®que <em>imagemin</em> (<span class="URL"><a href="https://npmjs.com/imagemin" class="bare">npmjs.com/imagemin</a></span>) et
se charge de r√©duire le poids de nos images JPEG, PNG mais aussi GIF (anim√©s
et statiques) ainsi que le format vectoriel&#160;SVG.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/imagemin images/* --out-dir images
8 images minified</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Glossaire</span> Compression destructive et non&#160;destructive</div>
<div class="paragraph">
<p>Il existe deux types de compression&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>destructive&#160;: poids r√©duit au maximum, possibles artefacts visuels, destruction
potentielle de couleurs dans le cas d&#8217;images complexes&#160;;</p>
</li>
<li>
<p>sans perte&#160;: poids r√©duit, les couleurs supprim√©es ne sont pas perceptibles
√† l&#8217;≈ìil&#160;nu.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il vaut mieux privil√©gier la <em>compression sans perte</em> pour √©viter les artefacts
visuels et respecter la cr√©ation d&#8217;origine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le redimensionnement d&#8217;images est une autre de ces t√¢ches courantes et r√©currentes
qui tombe rapidement aux oubliettes de par sa gourmandise en temps.
On voudra par exemple redimensionner des photos depuis des fichiers originaux,
g√©n√©rer des vignettes ou encore diff√©rentes tailles d&#8217;image adapt√©es
aux diff√©rentes dispositions d&#8217;un site web <em>responsive</em>.</p>
</div>
<div class="paragraph">
<p><em>sharp-cli</em> (<span class="URL"><a href="https://npmjs.com/sharp-cli" class="bare">npmjs.com/sharp-cli</a></span>) r√©pond exactement √† ce cahier
des charges.
Ce module en ligne de commande est bas√© sur <em>sharp</em> (<span class="URL"><a href="https://npmjs.com/sharp" class="bare">npmjs.com/sharp</a></span>),
une biblioth√®que Node de modification d&#8217;images √©crite en ECMAScript et <em>C&#43;&#43;</em>.
<em>sharp</em> nous aidera entre autres √† redimensionner, d√©couper, retourner, recentrer,
assembler et appliquer des effets graphiques de mani√®re pr√©dictible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/sharp resize 500 \
  --min \
  -i images/*.png \
  --output ./images/thumbs</pre>
</div>
</div>
<div class="paragraph">
<p>La commande pr√©c√©dente illustre une op√©ration de redimensionnement d&#8217;images&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>d&#8217;une dimension de 500 pixels de largeur&#160;;</p>
</li>
<li>
<p>minimum, pour respecter les proportions initiales&#160;‚Äì sans cet attribut les images seraient des carr√©s
de 500 pixels de large et de haut&#160;;</p>
</li>
<li>
<p>ciblant toutes les images PNG du r√©pertoire <code>images</code>&#160;;</p>
</li>
<li>
<p>puis export√©es dans le r√©pertoire <code>images/thumbs</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/sharp grayscale \
  -i images/*.png \
  --output ./images/square</pre>
</div>
</div>
<div class="paragraph">
<p>√Ä l&#8217;inverse, cette commande illustre la conversion en noir et blanc
d&#8217;images ainsi que leur export dans un r√©pertoire diff√©rent.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface en ligne de commande de <em>sharp-cli</em> ne permet pas de cr√©er
des op√©rations composites (redimensionner et convertir en niveaux de gris par exemple).
Il faudra recourir √† l&#8217;API Node de <em>sharp</em> et cha√Æner les op√©rations en
s&#8217;aidant des exemples document√©s sur <span class="URL"><a href="http://sharp.dimens.io" class="bare">sharp.dimens.io</a></span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> gm</div>
<div class="paragraph">
<p><em>gm</em>&#160;(<span class="URL"><a href="https://npmjs.com/gm" class="bare">npmjs.com/gm</a></span>) est le module classique de
redimensionnement dans l&#8217;√©cosyst√®me Node.
Il s&#8217;interface avec les programmes <em>GraphicsMagick</em> et <em>ImageMagick</em>&#160;‚Äì
et n√©cessite donc leur pr√©sence sur le syst√®me d&#8217;exploitation.</p>
</div>
<div class="paragraph">
<p>Cela rend l&#8217;utilisation de <em>gm</em> l√©g√®rement moins triviale que celle de <em>sharp</em>
mais la quantit√© de ressources et la qualit√© du module en font une bonne
alternative √† consid√©rer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation d&#8217;un <a href="../chapter-05/index.html#npm-scripts">script&#160;<code>npm</code></a>
(<a href="../chapter-05/index.html">chapitre&#160;5</a>) est id√©ale pour d√©crire les
diff√©rentes actions d&#8217;optimisation.
Les scripts sont alors √† invoquer manuellement, sur un crochet Git
(<em>git&#160;hook</em>) ou automatiquement lors du d√©ploiement avec un
<a href="../chapter-06/index.html#deploy.ci">service d&#8217;int√©gration continue</a>, par
exemple.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">7. Tester son code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>C&#8217;est bien connu&#160;: &#8220;lorsqu&#8217;on produit du code de qualit√©, √©crire des tests est amplement superflu et ne sert qu&#8217;√† nous ralentir&#8221;.</p>
</div>
<div class="paragraph">
<p>La r√©alit√© est tout autre et suit un paradigme tr√®s simple&#160;:
<strong>plus il y a de lignes de code, plus il y a de risques de commettre des erreurs</strong>.
Cela vaut aussi bien pour du HTML que du CSS ou encore de l&#8217;ECMAScript.</p>
</div>
<div class="paragraph">
<p>Cette derni√®re section nous aidera √† comprendre quoi et comment tester
pour diminuer le co√ªt de maintenance de nos applications.</p>
</div>
<div class="sect2">
<h3 id="testing-101">7.1. Que tester ?</h3>
<div class="paragraph">
<p>L&#8217;id√©e d&#8217;√©crire des tests pour am√©liorer la qualit√© de son code est attrayante,
mais quand on ne sait pas quoi tester et ni √† qui demander pour se lancer,
il est √©vident qu&#8217;on ne va pas s&#8217;y mettre pour s&#8217;assurer que 1+1 valent bien 2.</p>
</div>
<div class="paragraph">
<p>Je pense √† ces trois r√®gles lorsque je souhaite √©crire des tests&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Qu&#8217;est-ce qui est public/export√©&#160;?</p>
</li>
<li>
<p>Qu&#8217;est-ce qui cr√©e des branches dans mon code&#160;?</p>
</li>
<li>
<p>Qu&#8217;est-ce qui vient du monde ext√©rieur&#160;?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La syntaxe de modules ECMAScript est id√©ale pour visualiser les segments
de code qui sont export√©s par nos diff√©rents fichiers.
√âl√©ment marquant&#160;: ce code est simple et devrait arriver √† compter le nombre
de mots mais nous n&#8217;avons aucune id√©e s&#8217;il fera correctement le travail sans
l&#8217;ex√©cuter dans une application.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">test-export.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">isString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">thing</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">typeof</span> thing <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">isWord</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">word</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">isString</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> <span class="token regex">/^[\w\s.,\-?!;+]{2,}$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">countWords</span> <span class="token punctuation">(</span><span class="token parameter">sentence</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">return</span> sentence<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isWord<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La fonction <code>countWords</code> est le seul √©l√©ment export√© par notre module et devrait donc √™tre le seul sujet de nos&#160;tests.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Une branche est une portion de code qui s&#8217;ex√©cute de mani√®re ponctuelle.
Ces sections de code s&#8217;activent ou non selon l&#8217;√©tat d&#8217;une structure de donn√©es.
Il faut pr√©voir au moins autant de tests que de branches pour valider les
attentes.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">test-branches.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">isOdd</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isFinite</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'number devrait √™tre un nombre'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Premi√®re branche activ√©e dans deux cas de figure.</p>
</li>
<li>
<p>Seconde branche.</p>
</li>
<li>
<p>Troisi√®me branche.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Enfin, l&#8217;acc√®s √† toute donn√©e externe est susceptible de mal fonctionner
sans que nous puissions ma√Ætriser l&#8217;origine des probl√®mes.
En revanche, l&#8217;√©criture de tests nous aidera √† accepter ce cas de figure et
√† le signaler √† nos applications.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">test-outside-world.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getLinkElementContent</span> <span class="token punctuation">(</span><span class="token parameter">linkElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>href<span class="token punctuation">}</span> <span class="token operator">=</span> linkElement<span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(1)</b></span>

  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>                    <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">pkg</span> <span class="token operator">=></span> pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>linkElement</code> peut ne pas √™tre un lien hypertexte (<code>document.querySelector</code> retourne&#160;<code>null</code>).</p>
</li>
<li>
<p>Ici, tout peut arriver&#160;: <code>href</code> n&#8217;est pas une URL valide (balise <code>href</code> vide), serveur indisponible, etc.</p>
</li>
<li>
<p>Et l√†, le fichier JSON peut √™tre mal form√© ou la r√©ponse est exprim√©e dans un autre format que&#160;JSON.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous savons d√©sormais √† peu pr√®s tout ce qu&#8217;il faut suspecter pour renforcer
nos applications en √©crivant quelques tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="soutiller_pour_√©crire_des_assertions">7.2. S&#8217;outiller pour √©crire des assertions</h3>
<div class="paragraph">
<p>Avant de nous lancer directement dans la conception et l&#8217;√©criture des tests,
penchons-nous sur la structure de l&#8217;outillage.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Assertion</dt>
<dd>
<p>C&#8217;est la v√©rification d&#8217;une v√©rit√©, d&#8217;une attente, du r√©sultat d&#8217;une op√©ration.
Une assertion couvre une branche de&#160;code.</p>
</dd>
<dt class="hdlist1">Test</dt>
<dd>
<p>C&#8217;est un regroupement d&#8217;assertions couvrant toutes les branches des
fonctionnalit√©s publiques de notre&#160;code.</p>
</dd>
<dt class="hdlist1">Suite de tests</dt>
<dd>
<p>C&#8217;est un ensemble de tests couvrant un aspect logique d&#8217;un code applicatif.
Une application peut comporter plusieurs suites selon sa complexit√©&#160;:
tests <strong>unitaires</strong> (interface de code),
tests <strong>fonctionnels</strong> (sc√©narios d&#8217;utilisation d&#8217;une application),
tests d'<strong>int√©gration</strong> (d√©pendance vis √† vis d&#8217;autres applications et services).</p>
</dd>
<dt class="hdlist1">Ex√©cuteur de tests</dt>
<dd>
<p>C&#8217;est le logiciel responsable de cr√©er l&#8217;environnement d&#8217;ex√©cution d&#8217;une suite de tests.
Il exprime une opinion sur la structuration des tests ainsi que sur des
automatismes √† fournir pour acc√©l√©rer l&#8217;√©criture des&#160;tests.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>L&#8217;outillage varie selon chacun de ces niveaux.
Certains outils offrent une √©criture d&#8217;assertion plus fluide, d&#8217;autres proposent une √©criture plus sp√©cifiquement adapt√©e.</p>
</div>
<div class="paragraph">
<p>Les sections suivantes sont compl√©mentaires.
J&#8217;ai favoris√© des approches it√©ratives et modulaires pour faciliter l&#8217;ajout ou le retrait de tout outil de notre outillage&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la biblioth√®que <em>chai</em> pour les assertions&#160;;</p>
</li>
<li>
<p>la biblioth√®que <em>mocha</em> pour les tests&#160;;</p>
</li>
<li>
<p>la biblioth√®que <em>mocha</em> pour la suite de tests ex√©cutable par&#160;Node&#160;;</p>
</li>
<li>
<p>l&#8217;ex√©cuteur de tests nomm√©  <em>karma</em> pour faire fonctionner la suite de tests
dans les navigateurs.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> chai, mocha et karma</div>
<div class="paragraph">
<p>Ces trois biblioth√®ques disposent d&#8217;une documentation en ligne expliquant leurs
options respectives, ainsi que des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>chai</em>&#160;: <span class="URL"><a href="http://chaijs.com/api/bdd/" class="bare">chaijs.com/api/bdd/</a></span>&#160;;</p>
</li>
<li>
<p><em>mocha</em>&#160;: <span class="URL"><a href="https://mochajs.org" class="bare">mochajs.org</a></span>&#160;;</p>
</li>
<li>
<p><em>karma</em>&#160;: <span class="URL"><a href="https://karma-runner.github.io" class="bare">karma-runner.github.io</a></span>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">Exemple d&#8217;assertion avec la biblioth√®que&#160;chai</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>expect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span><span class="token punctuation">;</span>

<span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">Exemple de test avec la biblioth√®que mocha</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'functionName'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should succeed with parameter cheese'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should throw an error with parameter meat'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Exemple d&#8217;ex√©cution de suites de tests avec mocha et karma</div>
<div class="content">
<pre><span data-bash-subs="$"></span>mocha tests/**/*.js
<span data-bash-subs="$"></span>karma start</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;ex√©cuteur de tests <em>karma</em> se configure par le biais d&#8217;un fichier <code>karma.conf.js</code>.
Nous en trouverons un √† la racine du r√©pertoire des ressources du
<a href="../chapter-04/index.html">chapitre&#160;4</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="tester_ses_composants_react_sans_navigateur">7.3. Tester ses composants React sans navigateur</h3>
<div class="paragraph">
<p>Un des points forts de <a href="#react">React</a> √©voqu√©s dans ce chapitre est la
description de son rendu √† m√™me le composant.
Nous b√©n√©ficions ainsi du r√©sultat final (son HTML par exemple) ainsi que d&#8217;un
arbre repr√©sentant une structure de sous-√©l√©ments et de propri√©t√©s.</p>
</div>
<div class="paragraph">
<p>Nous disposons de deux strat√©gies pour tester les diff√©rents comportements d&#8217;un
composant <em>React</em>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tester le rendu en comparant des cha√Ænes de caract√®res&#160;;</p>
</li>
<li>
<p>tester l&#8217;√©tat en validant la pr√©sence d&#8217;attributs ou le d√©clenchement de
certaines m√©thodes du composant.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La biblioth√®que <em>Enzyme</em> (<span class="URL"><a href="https://npmjs.com/enzyme" class="bare">npmjs.com/enzyme</a></span>) s&#8217;occupe tr√®s bien des
deux, en plus de s&#8217;int√©grer avec n&#8217;importe quelle biblioth√®que de tests.
Dans tous les cas, elle nous permettra de monter nos composants, soit de mani√®re
isol√©e, soit dans un v√©ritable arbre DOM, soit en rendu&#160;HTML.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Enzyme</div>
<div class="paragraph">
<p>L&#8217;√©quipe d&#8217;Airbnb offre une documentation exhaustive sur <span class="URL"><a href="http://airbnb.io/enzyme/" class="bare">airbnb.io/enzyme/</a></span>.
J&#8217;ai beaucoup appr√©ci√© les exemples complets d&#8217;int√©gration avec
<em>mocha</em>, <em>webpack</em> et&#160;<em>tape</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons nous baser sur le composant cr√©√© dans la section
&#8220;<a href="#react">Rapprocher donn√©es, rendu et interactions avec React</a>&#8221; pour s&#8217;assurer
de son comportement avant m√™me de l&#8217;inclure dans notre application.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests/date-interval.js (configuration)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> expect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> shallow <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'enzyme'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> DateInterval <span class="token keyword">from</span> <span class="token string">'../modules/date-interval.jsx'</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;DateInterval />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ... (tests)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Import du module <code>DateInterval</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notre premier test consiste √† v√©rifier que notre composant React g√©n√®re
bien une balise <code>&lt;time&gt;</code> en sortie.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests/date-interval.js (tests)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">// (configuration)</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;DateInterval />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>DateInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'affiche un √©l√©ment &lt;time>'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>               <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(2)</b></span>

    <span class="token function">expect</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>have<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Cr√©ation d&#8217;un test destin√© √† v√©rifier la nature de la balise HTML √† g√©n√©rer.</p>
</li>
<li>
<p>Cr√©ation du composant isol√© (<em>shallow</em>)&#160;‚Äì aucun √©l√©ment DOM ne sera cr√©√© ni ins√©r√© dans le document.</p>
</li>
<li>
<p>On √©crit une assertion garantissant que l&#8217;on retourne un √©l√©ment <code>&lt;time&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le deuxi√®me aspect √† tester concerne les donn√©es du composant, et leur effet
sur la valeur de classe de l&#8217;√©l√©ment HTML g√©n√©r√© en sortie.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests/date-interval.js (tests, suite)</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token comment">// (configuration)</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;DateInterval />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>DateInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'la propri√©t√© tickDate influence la classe HTML'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">OK_CLASS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'pair'</span><span class="token punctuation">,</span> <span class="token string">'impair'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>tickData<span class="token punctuation">}</span> <span class="token operator">=</span> component<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(2)</b></span>

    <span class="token keyword">const</span> time <span class="token operator">=</span> tickData<span class="token punctuation">.</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">closeTo</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token function">expect</span><span class="token punctuation">(</span>tickData<span class="token punctuation">.</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">oneOf</span><span class="token punctuation">(</span><span class="token constant">OK_CLASS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Cr√©ation d&#8217;un second composant isol√© dont l&#8217;√©tat est ind√©pendant du premier.</p>
</li>
<li>
<p>R√©cup√©ration de l&#8217;√©tat (<em>state</em>) du composant.</p>
</li>
<li>
<p>Assertion v√©rifiant que la date utilis√©e par le composant est proche de la date courante (√† quelques millisecondes&#160;pr√®s).</p>
</li>
<li>
<p>Assertion v√©rifiant qu&#8217;une propri√©t√© de l&#8217;√©tat ne peut √™tre qu&#8217;une des deux valeurs parmi <code>pair</code> et <code>impair</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En compl√©ment, la biblioth√®que <em>chai-enzyme</em> (<span class="URL"><a href="https://npmjs.com/chai-enzyme" class="bare">npmjs.com/chai-enzyme</a></span>)
√©tend le vocabulaire de <em>chai</em> pour ajouter des assertions de composants.
C&#8217;est une question de go√ªt plus qu&#8217;une n√©cessit√©.<br>
L&#8217;exemple suivant reprend le composant cr√©√© dans la section
&#8220;<a href="#livereload">Changements en temps&#160;r√©el dans le navigateur</a>&#8221; et illustre une
assertion suite √† un clic sur le bouton&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests/button-count.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> chai<span class="token punctuation">,</span> <span class="token punctuation">{</span> expect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> chaiEnzyme <span class="token keyword">from</span> <span class="token string">'chai-enzyme'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> shallow <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'enzyme'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ButtonCount <span class="token keyword">from</span> <span class="token string">'../livereload/button-count.jsx'</span><span class="token punctuation">;</span>

chai<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">chaiEnzyme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;ButtonCount />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should increment state on click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>       <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>ButtonCount <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    component<span class="token punctuation">.</span><span class="token function">simulate</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(2)</b></span>

    <span class="token function">expect</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>have<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'clickCount'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le libell√© du test d√©crit le r√©sultat attendu dans les assertions.</p>
</li>
<li>
<p>Simulation du clic sur le composant.</p>
</li>
<li>
<p>L&#8217;√©tat interne a bien √©t√© chang√© et correspond √† la valeur attendue.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le fichier <code>package.json</code> des ressources de ce chapitre
contient une t√¢che ex√©cutant les tests ex√©cutables dans un environnement Node uniquement.
Elle se lance de la mani√®re suivante&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>npm run test:node</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/mocha-react.png" alt="mocha react" width="80%">
</div>
<div class="title">Figure 8. Extrait de la sortie de la commande npm&#160;run&#160;test:node</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> jest</div>
<div class="paragraph">
<p><em>jest</em> (<span class="URL"><a href="https://npmjs.com/jest" class="bare">npmjs.com/jest</a></span>) est un ex√©cuteur de tests moderne et
rapide particuli√®rement adapt√© au test de composants c√¥t√© serveur.
Au moment d&#8217;√©crire cet ouvrage, il n&#8217;√©tait pas encore possible de l&#8217;ex√©cuter
dans un navigateur.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est int√©ressant de retenir que les tests navigateurs ne sont pas indispensables
pour s&#8217;assurer du bon fonctionnement de nos composants.
Des biblioth√®ques comme <em>React</em> sont d√©j√† solidement test√©es.
Cela nous laisse l&#8217;opportunit√© de nous concentrer uniquement sur notre logique m√©tier.</p>
</div>
<div class="paragraph">
<p>Les tests navigateurs sont en revanche utiles pour tester la compatibilit√©
navigateurs, que ce soit au niveau de la syntaxe ECMAScript ou du rendu&#160;CSS.</p>
</div>
</div>
<div class="sect2">
<h3 id="tester_code_et_composants_dans_les_navigateurs">7.4. Tester code et composants dans les navigateurs</h3>
<div class="paragraph">
<p>C&#8217;est bien beau de tester uniquement l&#8217;interface de composants <em>React</em>
(ou autre technologie) mais comment faire lorsqu&#8217;on a besoin de tester avec un
vrai DOM ou dans plusieurs navigateurs&#160;?</p>
</div>
<div class="paragraph">
<p>Il est n√©cessaire d&#8217;effectuer des tests dans des navigateurs pour&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>s&#8217;assurer de la compatibilit√© de notre code avec les variations d&#8217;impl√©mentation de navigateurs&#160;;</p>
</li>
<li>
<p>valider notre choix de <em>polyfills</em>&#160;;</p>
</li>
<li>
<p>tester fid√®lement contre des API de navigateurs ou du DOM (comme <em>Web&#160;Audio</em> ou
<em>Service&#160;Workers</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Autrement dit, nous avons besoin d&#8217;un ex√©cuteur de tests qui les fasse fonctionner
dans l&#8217;environnement d&#8217;un navigateur.
Id√©alement, nous voulons que cet ex√©cuteur de tests n&#8217;influe pas sur l&#8217;outillage
employ√© pour √©crire nos tests et donc nous permette d&#8217;utiliser <em>mocha</em> et <em>chai</em>
comme dans la section pr√©c√©dente.</p>
</div>
<div class="paragraph">
<p><em>karma</em> (<span class="URL"><a href="https://npmjs.com/karma" class="bare">npmjs.com/karma</a></span>) est l&#8217;outil phare de l&#8217;√©cosyst√®me
Node d√©di√© aux tests dans les navigateurs.
Il a √©t√© cr√©√© en&#160;2012 pour faciliter l&#8217;ex√©cution des suites de tests de la
biblioth√®que <em>Angular</em> et s&#8217;ex√©cute en ligne de commandes.</p>
</div>
<div class="paragraph">
<p>Les fonctionnalit√©s de <em>karma</em> s&#8217;√©tendent √† l&#8217;aide de modules&#160;<code>npm</code>&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>int√©grations avec des suites de tests&#160;;</p>
</li>
<li>
<p>lanceurs de navigateurs&#160;;</p>
</li>
<li>
<p>pr√©processeurs pour transformer des fichiers, les servir et/ou les inclure
dans l&#8217;environnement de tests.</p>
</li>
</ul>
</div>
<div class="videoblock">
<div class="title">Exemple de tests multi-navigateurs en continu avec <em>karma</em></div>
<div class="content">
<video src="./videos/karma-browsers.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Le pilotage de <em>karma</em> se fait via un fichier de configuration <code>karma.conf.js</code>.
Il est possible de surcharger ult√©rieurement cette configuration avec des
arguments de la ligne de commandes.</p>
</div>
<div class="listingblock">
<div class="title">Initialisation automatique d&#8217;un fichier de configuration <code>karma.conf.js</code></div>
<div class="content">
<pre><span data-bash-subs="$"></span>./node_modules/.bin/karma init</pre>
</div>
</div>
<div class="paragraph">
<p><em>karma</em> fonctionne avec des navigateurs install√©s sur notre machine de
d√©veloppement tout comme avec des services distants comme <em>SauceLabs</em> ou
<em>BrowserStack</em> (voir &#8220;<a href="#ci">Int√©gration continue et compatibilit√© navigateurs</a>&#8221;).
Les navigateurs doivent d√©j√† √™tre disponibles sur la machine de test (Firefox
et Chrome par exemple) et nous devons en parall√®le installer les lanceurs
(<code>karma-firefox-launcher</code> et <code>karma-chrome-launcher</code> respectivement).</p>
</div>
<div class="paragraph">
<p>Les navigateurs lanc√©s par d√©faut lors des tests sont list√©s dans l&#8217;option <code>browsers</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L49</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">autoWatch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>karma</em> se charge d&#8217;inclure les fichiers ECMAScript ou de servir des fichiers
statiques en fonction de motifs de chemins.
Ces fichiers peuvent √™tre locaux (de pr√©f√©rence) ou distants et m√™me de
types diff√©rents comme JSON ou&#160;HTML.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L7-17</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">files<span class="token punctuation">:</span> <span class="token punctuation">[</span>
  <span class="token comment">//'https://cdn.polyfill.io/v2/polyfill.min.js',  // <b class="conum">(1)</b></span>
  <span class="token string">'examples/tests-browser/**/*.js'</span><span class="token punctuation">,</span>                <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token string">'examples/tests/**/*.js'</span><span class="token punctuation">,</span>
  <span class="token string">'examples/tests-browser/**/*.html'</span><span class="token punctuation">,</span>              <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">{</span>
    pattern<span class="token punctuation">:</span> <span class="token string">'package.json'</span><span class="token punctuation">,</span>                       <span class="token comment">// <b class="conum">(4)</b></span>
    served<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    included<span class="token punctuation">:</span> <span class="token boolean">false</span>                                <span class="token comment">// <b class="conum">(5)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Il suffirait de d√©commenter cette ligne pour inclure les <a href="#polyfills"><em>polyfills</em> de navigateurs</a> sans toucher √† notre&#160;code.</p>
</li>
<li>
<p>Inclusion des fichiers de tests&#160;‚Äì ils sont appel√©s dans des balises HTML <code>&lt;script&gt;</code>.</p>
</li>
<li>
<p>Inclusion de fichiers HTML&#160;‚Äì ils sont accessibles via&#160;HTTP.</p>
</li>
<li>
<p>Mise √† disposition du fichier <code>package.json</code>&#160;‚Äì accessible via HTTP √† l&#8217;adresse <code>/base/package.json</code>.</p>
</li>
<li>
<p>Indique que ce fichier ne doit pas √™tre inclus dans une balise HTML <code>&lt;script&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Des int√©grations doivent √™tre d√©clar√©es pour augmenter les fonctionnalit√©s de
base de <em>karma</em>.
Ces derni√®res se r√©sument √† charger des fichiers ECMAScript
dans une balise <code>&lt;script&gt;</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;extrait de configuration suivant illustre le chargement des plug-ins pour
<em>Browserify</em> (modules <em>CommonJS</em> et transpilation), <em>mocha</em> (suites de tests)
et <em>fixture</em> (donn√©es repr√©sentant des cas d&#8217;utilisation)&#160;‚Äì respectivement
les modules <code>npm</code> <code>karma-browserify</code>, <code>karma-mocha</code> et <code>karma-fixture</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L5</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">frameworks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'browserify'</span><span class="token punctuation">,</span> <span class="token string">'mocha'</span><span class="token punctuation">,</span> <span class="token string">'fixture'</span><span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une fois encore, des motifs de chemins sont utilis√©s pour indiquer aux plug-ins
leur responsabilit√© de prise en charge.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L21-25</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">preprocessors<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token string">'examples/tests/**/*.js'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'browserify'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token string">'examples/tests-browser/**/*.js'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'browserify'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">'examples/tests-browser/**/*.html'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'html2js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ces fichiers seront transpil√©s par <em>browserify</em> avant d&#8217;√™tre charg√©s dans les tests de navigateurs.</p>
</li>
<li>
<p>Ces fichiers seront pris en charge par le pr√©processeur nomm√© <em>html2js</em>, utilis√© par <code>karma-fixture</code> pour transformer du HTML en arbre&#160;DOM.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous avons vu un exemple de code reposant sur un √©l√©ment du DOM dans la section
&#8220;<a href="#testing-101">Que tester&#160;?</a>&#8221;.
Nous allons nous int√©resser √† une mani√®re possible de tester la fonction
export√©e <code>getLinkElementContent()</code> en se basant sur un v√©ritable appel HTTP et
un v√©ritable √©l√©ment du DOM, cr√©√© √† partir du fichier de <em>fixture</em> suivant&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests-browser/fixtures/link-package.html</div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/base/package.json<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce fichier de fixture est charg√© dans le DOM par le plug-in <code>karma-fixture</code>
pour prouver que l&#8217;on peut r√©cup√©rer les d√©pendances expos√©es par le fichier
<code>package.json</code> des ressources de ce chapitre&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">tests-browser/test-outside-world.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> expect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getLinkElementContent <span class="token keyword">from</span> <span class="token string">'../test-outside-world.js'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'getLinkElementContent'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fixture<span class="token punctuation">.</span><span class="token function">setBase</span><span class="token punctuation">(</span><span class="token string">'examples/tests-browser/fixtures'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'fetches dependencies from remote package.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>link<span class="token punctuation">]</span> <span class="token operator">=</span> fixture<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'link-package.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span>

    <span class="token keyword">return</span> <span class="token function">getLinkElementContent</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">deps</span> <span class="token operator">=></span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(3)</b></span>
      <span class="token function">expect</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>contain<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>                 <span class="token comment">// <b class="conum">(4)</b></span>
        <span class="token string">'@babel/core'</span><span class="token punctuation">,</span> <span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'enzyme'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>before()</code> indique √† <em>mocha</em> d&#8217;ex√©cuter ce bloc de code avant tout&#160;test.</p>
</li>
<li>
<p>Appel du plug-in de fixture pour obtenir l&#8217;√©l√©ment du DOM n√©cessaire √† la fonction <code>getLinkElementContent()</code>.</p>
</li>
<li>
<p>Appel r√©el de la fonction <code>getLinkElementContent()</code>, r√©solu comme une <a href="../chapter-03/index.html#promise">promesse</a> et dont nous testons le r√©sultat √† la ligne suivante.</p>
</li>
<li>
<p>Assertion v√©rifiant que le r√©sultat contient bien les cl√©s de d√©pendances&#160;<code>npm</code> attendues&#160;‚Äì nous avons bien r√©cup√©r√© le bon fichier et le bon contenu&#160;!</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;invocation de <em>karma</em> se fait en invoquant <code>./node_modules/.bin/karma start</code>.
Par mesure de simplicit√©, cette commande a √©t√© abstraite en tant que
<a href="../chapter-05/index.html#npm-scripts">script&#160;<code>npm</code></a>&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Ex√©cution ponctuelle de karma</div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm run test:browser</pre>
</div>
</div>
<div class="paragraph">
<p>Les tests peuvent √™tre relanc√©s en continu&#160;‚Äì d√®s qu&#8217;un fichier change&#160;‚Äì en
d√©sactivant l&#8217;ex√©cution unique (<em>single run</em>).
C&#8217;est id√©al lorsque les tests sont √©crits en parall√®le de l&#8217;impl√©mentation du
code ou que des ajustements fr√©quents ont lieu en phase de d√©veloppement&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Ex√©cution continue de karma</div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm run test:browser -- --no-single-run</pre>
</div>
</div>
<div class="paragraph">
<p>Comme tout processus de longue dur√©e, il s&#8217;interrompt √† l&#8217;aide de la combinaison
de touches <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span>.</p>
</div>
<div class="paragraph">
<p>Nous en savons d√©sormais suffisamment pour tester dans les conditions des
navigateurs avec du code modulaire et r√©utilisable.
La question qui se pose d√©sormais est la suivante&#160;:
<strong>comment faire pour tester plusieurs versions d&#8217;un m√™me navigateur</strong>, pour
tester sur un syst√®me d&#8217;exploitation que l&#8217;on n&#8217;a pas ou encore plusieurs
terminaux mobiles de type <em>smartphone</em> ou tablette&#160;?</p>
</div>
</div>
<div class="sect2">
<h3 id="ci">7.5. Int√©gration continue et compatibilit√© navigateurs</h3>
<div class="paragraph">
<p>Deux cas de figure se pr√©sentent en compl√©ment de la section pr√©c√©dente&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la difficult√© d&#8217;acc√®s √† certaines combinaisons navigateur + syst√®me d&#8217;exploitation&#160;;</p>
</li>
<li>
<p>l&#8217;envie d&#8217;automatiser les tests de navigateurs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sous Windows, il sera difficile de tester la version macOS de Safari.
Inversement, sous macOS, il sera difficile de tester
Internet&#160;Explorer ou Edge.
Que dire d&#8217;anciennes versions de navigateurs Android, dont la rapidit√© de
d√©veloppement et donc la compatibilit√© sont bien en-de√ß√† des versions de Chrome
pour ordinateur ou mobile&#160;?</p>
</div>
<div class="videoblock">
<div class="title">Exemple de tests multi-navigateurs en continu avec karma et BrowserStack</div>
<div class="content">
<video src="./videos/karma-browserstack.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>L&#8217;√©cosyst√®me de modules&#160;<code>npm</code> li√©s √† <em>karma</em> s&#8217;est d√©j√† pench√© sur la question.
C&#8217;est le cas notamment du produit <em>BrowserStack</em> qui offre une int√©gration pour
d√©l√©guer l&#8217;ex√©cution des tests sur leur plate-forme commerciale.
Il s&#8217;agit du module <code>karma-browserstack-launcher</code>
(<span class="URL"><a href="https://npmjs.com/karma-browserstack-launcher" class="bare">npmjs.com/karma-browserstack-launcher</a></span>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> BrowserStack</div>
<div class="paragraph">
<p>La documentation de <em>BrowserStack</em> (<span class="URL"><a href="https://www.browserstack.com/automate/node" class="bare">www.browserstack.com/automate/node</a></span>)
d√©crit les diff√©rents syst√®mes d&#8217;exploitation √† disposition ainsi que les
navigateurs compatibles, pour PC, Mac, iOS et Android.</p>
</div>
<div class="paragraph">
<p>L&#8217;int√©gration avec Node est √©galement document√©e au cas o√π vous souhaiteriez
effectuer des tests sans passer par <em>karma</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>BrowserStack</em> n&#8217;est pas un navigateur en soi, mais offre un acc√®s √† une multitude
de navigateurs.
Il faut donc cr√©er de nouvelles configurations dans la propri√©t√© <code>customLaunchers</code>.
L&#8217;extrait de configuration suivant illustre la cr√©ation d&#8217;un navigateur Safari
pour iPhone&#160;4S sous iOS&#160;5.1.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L51-58</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

customLaunchers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  iphone4<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    base<span class="token punctuation">:</span> <span class="token string">'BrowserStack'</span><span class="token punctuation">,</span>
    device<span class="token punctuation">:</span> <span class="token string">'iPhone 4S'</span><span class="token punctuation">,</span>
    os<span class="token punctuation">:</span> <span class="token string">'ios'</span><span class="token punctuation">,</span>
    os_version<span class="token punctuation">:</span> <span class="token string">'5.1'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <em>BrowserStack</em> n√©cessite un compte et l&#8217;obtention d&#8217;une cl√©
d&#8217;API afin d&#8217;utiliser leur service.
Notre nom d&#8217;utilisateur et la cl√© d&#8217;API doivent √™tre renseign√©s en tant que
variables d&#8217;environnement pour √©tablir une connexion au service et d√©marrer
notre bon vieil iPhone&#160;4&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>export BROWSER_STACK_USERNAME=...
<span data-bash-subs="$"></span>export BROWSER_STACK_ACCESS_KEY=...
<span data-bash-subs="$"></span>npm run test:browser -- --browsers iphone4</pre>
</div>
</div>
<div class="paragraph">
<p><em>BrowserStack</em> est configurable plus finement selon nos besoins.
Le r√©glage suivant s&#8217;assure de faire transiter les donn√©es HTTP
(scripts, HTML) via la connexion s√©curis√©e entre notre ordinateur et
<em>BrowserStack</em>.
C&#8217;est un r√©glage utile en cas de proxy exigeant ou de
r√©glages de connexion √† Internet bien sp√©cifiques.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">karma.conf.js#L41-43</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">browserStack<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  forcelocal<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> Sauce&#160;Labs</div>
<div class="paragraph">
<p><em>Sauce&#160;Labs</em> (<span class="URL"><a href="https://saucelabs.com" class="bare">saucelabs.com</a></span>) est un concurrent de <em>BrowserStack</em>.
Il offre des fonctionnalit√©s similaires et il est gratuit pour les projets open source.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ind√©pendamment de <em>BrowserStack</em>, l&#8217;int√©gration continue est un m√©canisme
permettant l&#8217;ex√©cution automatique des tests, de mani√®re reproductible et
dans un environnement syst√©matiquement propre&#160;‚Äì sans trace d&#8217;ex√©cution d&#8217;un
pr√©c√©dent&#160;test.</p>
</div>
<div class="paragraph">
<p>Cela a deux avantages ind√©niables&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ex√©cuter les tests pour tout changement de code, peu importe qui en est l&#8217;auteur&#160;;</p>
</li>
<li>
<p>s&#8217;assurer de l&#8217;ex√©cution syst√©matique des tests&#160;;</p>
</li>
<li>
<p>mettre en commun la logique d&#8217;ex√©cution de tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On √©vite ainsi les <em>oublis</em> tout en enlevant le co√ªt de mise en place de
l&#8217;infrastructure de tests chez des personnes contribuant de mani√®re occasionnelle.
Cerise sur le g√¢teau, on pr√©vient en partie les r√©gressions&#160;‚Äì changements qui
cassent le fonctionnement attendu d&#8217;une fonctionnalit√©.</p>
</div>
<div class="paragraph">
<p>Le service Travis&#160;CI (<span class="URL"><a href="https://travis-ci.com" class="bare">travis-ci.com</a></span>) est un service
d&#8217;int√©gration continue (<em>Continuous Integration</em>, <em>CI</em>) parmi d&#8217;autres, mais
qui a √©t√© rendu populaire pour son int√©gration avec GitHub.
Il est gratuit pour les projets open source.</p>
</div>
<div class="paragraph">
<p>Un service d&#8217;int√©gration continue est configur√© pour d√©finir ce qui est
ex√©cut√© avant, pendant et apr√®s les tests.
Il a donc l&#8217;avantage de faciliter l&#8217;automatisation des tests de navigateurs
√† m√™me la machine virtuelle (<em>Virtual Machine</em>, <em>VM</em>) de test ou bien
vers des plates-formes comme <em>BrowserStack</em>.
Son m√©canisme de variables d&#8217;environnement crypt√©es nous √©vitera de donner
acc√®s √† notre compte au premier&#160;venu.</p>
</div>
<div class="paragraph">
<p>Un fichier de configuration minimal au format YAML est n√©cessaire.
Des services comme GitHub facilitent la connexion avec Travis&#160;CI et
d√©clenchent automatiquement l&#8217;ex√©cution des tests √† chaque <em>commit</em>
ou <em>pull&#160;request</em>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">.travis.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml"><span class="token key atrule">language</span><span class="token punctuation">:</span> node_js             <span class="token comment"># <b class="conum">(1)</b></span>
<span class="token key atrule">node_js</span><span class="token punctuation">:</span> v10                  <span class="token comment"># <b class="conum">(2)</b></span>

<span class="token key atrule">addons</span><span class="token punctuation">:</span>
  <span class="token key atrule">firefox</span><span class="token punctuation">:</span> latest             <span class="token comment"># <b class="conum">(3)</b></span>

<span class="token key atrule">env</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> MOZ_HEADLESS=1                                      <span class="token comment"># <b class="conum">(4)</b></span>
<span class="token punctuation">-</span> BROWSER_STACK_USERNAME="$BROWSER_STACK_USERNAME"    <span class="token comment"># <b class="conum">(5)</b></span>
<span class="token punctuation">-</span> BROWSER_STACK_ACCESS_KEY="$BROWSER_STACK_ACCESS_KEY"

<span class="token key atrule">script</span><span class="token punctuation">:</span> npm run test<span class="token punctuation">:</span>browser <span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>browsers Firefox</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configuration de la&#160;VM pour utiliser&#160;Node.</p>
</li>
<li>
<p>Configuration de la&#160;VM pour utiliser la version la plus r√©cente de Node&#160;v10.</p>
</li>
<li>
<p>Installation de la derni√®re version stable de Firefox.</p>
</li>
<li>
<p>La variable d&#8217;environnement <code>MOZ_HEADLESS</code> indique √† Firefox de d√©marrer sans afficher d&#8217;interface graphique √† l&#8217;√©cran.</p>
</li>
<li>
<p>J&#8217;ai param√©tr√© la cl√© d&#8217;acc√®s √† <em>BrowserStack</em> dans les r√©glages de <a href="#travis-ci">Travis&#160;CI</a> (voir encadr√©).</p>
</li>
</ol>
</div>
<div id="travis-ci" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Travis&#160;CI</div>
<div class="paragraph">
<p>Des services comme Travis&#160;CI sont puissants et amplement configurable
pour de nombreux besoins&#160;‚Äì dont Node (<span class="URL"><a href="https://docs.travis-ci.com/user/languages/javascript-with-nodejs/" class="bare">docs.travis-ci.com/user/languages/javascript-with-nodejs/</a></span>)&#160;‚Äì
et y&#160;compris pour se connecter √† des bases de donn√©es PostgreSQL ou MariaDB.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/travis-ci-encrypted-env.png" alt="travis ci encrypted env" width="85%">
</div>
<div class="title">Figure 9. √âcran de param√©trage des variables d&#8217;environnement secr√®tes sur Travis&#160;CI</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">8. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous sommes d√©sormais en mesure d'<strong>ex√©cuter des tests unitaires</strong> impliquant
des <strong>navigateurs web</strong> sur notre machine, sur des <strong>services distants</strong> mais
√©galement de mani√®re automatique avec des services d'<strong>int√©gration continue</strong>
comme Travis&#160;CI.</p>
</div>
<div class="paragraph">
<p>Le recours aux modules&#160;<code>npm</code> combin√©s aux modules ECMAScript facilite
<strong>la conception et la maintenance de code testable et r√©utilisable</strong>.</p>
</div>
<div class="paragraph">
<p>Ces pratiques de modularisation&#160;‚Äì jusqu&#8217;au rendu interm√©diaire de <em>React</em>
‚Äì incitent √† la <strong>rigueur qui a un effet positif</strong> sur la qualit√© de notre
code et renforce notre confiance √† le d√©ployer en production.</p>
</div>
</div>
</div>
</div>
<section class="next">
  <a href="#top">Haut de page</a> ou
  <a href="https://oncletom.io/node.js/#apprendre-node-js-en-ligne" class="read-more">retour au sommaire</a>.
</section>
</body>
</html>