<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Jouer avec Node.js</title>
<style>
#header,
#content,
#footer {
  margin: 2rem auto;
  max-width: 46rem;
}

#header {
  margin-top: 0;
}

.title,
#toctitle {
  color: var(--dark-accent);
}

a {
  /* white-space: nowrap; */
}

img, iframe, video, audio {
  max-width: 100%;
}

p {
  font-weight: normal;
}

/* Taken out from book.css */
dl dt {
  margin-bottom: 0.3125em;
  font-weight: bold;
}
dl dd {
  margin-bottom: 1.25em;
}

dt,
th.tableblock,
td.content,
div.footnote {
  text-rendering: optimizeLegibility;
}

.literalblock pre,
.literalblock pre[class],
.listingblock pre,
.listingblock pre[class] {
  overflow: auto;
  word-wrap: break-word;
}
.literalblock pre.nowrap,
.literalblock pre[class].nowrap,
.listingblock pre.nowrap,
.listingblock pre[class].nowrap {
  overflow-x: auto;
  white-space: pre;
  word-wrap: normal;
}

.listingblock {
  margin: 0 0 2em;
}
.listingblock > .content {
  position: relative;
}
.listingblock > .title {
  font-weight: bold;
}
.listingblock code[data-lang]::before {
  display: none;
  content: attr(data-lang);
  position: absolute;
  font-size: 0.75em;
  top: 1em;
  right: 1em;
  line-height: 1;
  text-transform: uppercase;
  color: #999;
}
.listingblock:hover code[data-lang]::before {
  display: block;
}
.listingblock.terminal pre .command::before {
  content: attr(data-prompt);
  padding-right: 0.5em;
  color: #999;
}

td.hdlist1,
td.hdlist2 {
  vertical-align: top;
  padding-right: 0.625em;
}
td.hdlist1 {
  font-weight: bold;
}
.literalblock + .colist,
.listingblock + .colist {
  margin-top: -1.5em;
}
.colist td:not([class]):first-child {
  padding: 0.4em 0.75em 0 0.75em;
  line-height: 1;
  vertical-align: top;
}
.colist td:not([class]):first-child img {
  max-width: none;
}
.colist td:not([class]):last-child {
  padding: 0.25em 0;
}

/* Custom classes */

.line-through {
  text-decoration: line-through;
}

.RemarquePreTitre,
#toctitle {
  font-style: normal;
  font-weight: bold;
}
  .RemarquePreTitre::after {
    content: "‚Ä¢";
    padding-left: 5px;
  }
.admonitionblock {
}
.admonitionblock > table,
.exampleblock {
  --commented: rgba(17, 17, 68, .65);
  --border-radius-base: 8px;

  background-color: #fafafa;
  border: 1px solid var(--dark-shade);
  border-left: none;
  border-right: none;
  margin: 1.5em 0;
  padding: 1em;
}
.exampleblock .title {
  font-weight: bold;
}
.icon .title {
  font-size: 2em;
}
  .admonitionblock > table td.icon {
    display: none;
  }

  @media screen and (min-width: 769px) {
    .admonitionblock > table td.icon {
      display: table-cell;
    }
  }

  .admonitionblock > table td.icon {
    padding-right: 1em;
  }
  .admonitionblock > table td.icon img {
    max-width: none;
  }

.colist ol {
  margin-left: 1.5em;  /* aligns with the listing edge */
  padding-left: 0;
  font-weight: bold;   /* makes it stand out more */
}
  .colist ol p {
    margin: 0 0 .5em;
  }
.listingblock:not(.prismjs) pre,
.language-bash.hljs {
  background: #323232;
  color: wheat;
  margin: 0;
  padding: 1rem;
}
.language-bash.hljs .hljs-built_in,
.language-bash.hljs .hljs-builtin-name {
  color: white;
}
.language-bash.hljs .hljs-string {
  color: lightgreen;
}
.language-bash.hljs .hljs-variable {
  color: lightskyblue;
}
.keyseq {
  font-weight: normal;
  white-space: nowrap;
}
.language-bash.hljs .keyseq {
  color: white;
}
.language-bash.hljs kbd {
  background: transparent;
  box-shadow: none;
  color: white;
  font-size: 0.8em;
  font-weight: bold;
  padding: 0.1em 0.4em;
}
.listingblock pre.highlightjs,
.listingblock.prismjs pre {
  background-color: transparent;
  margin: 0;
  padding: 0;
}
.listingblock pre.highlightjs > code,
.listingblock.prismjs .highlight {
  border-left: 4px solid var(--dark-accent);
  padding-left: 1em;
  font-size: .8em;
}
.listingblock pre.highlightjs > code.language-bash {
  border-left-color: limegreen;
}

.hdlist .hdlist1 {
  text-align: right;
  white-space: nowrap;
}

td > p:first-child {
  margin-top: 0;
}

.hljs-comment {
  font-style: normal !important;
}

#toc.toc2 a {
  text-decoration: none;
  white-space: normal;
}
  #toc.toc2 a:hover,
  #toc.toc2 a:focus {
    text-decoration: underline;
  }

#toc.toc2 ul {
  list-style: none;
}

  #toc.toc2 > ul {
    padding-left: 0;
  }

  #toc.toc2 ul ul {
    padding-left: 1em;
  }

@media screen and (min-width: 769px) {
  body {
    padding-left: 25vw !important;
  }

  #header,
  #content,
  #footer {
    margin-left: 0;
  }

  #toc.toc2 {
    height: 100%;
    left: 0;
    max-width: 20vw;
    overflow: auto;
    padding: 1rem;
    position: fixed;
    top: 0;
    z-index: 1000;
  }

  #toc.toc2 > ul {
    font-size: 0.85em;
  }

  #toc li.active > a[href^="#"],
  [id]:target {
    background: #ffc;
  }
}

.admonitionblock.context-callout > table {
  border-width: 5px;
  border-color: var(--brand-color);
}

</style>
<link rel="stylesheet" href="https://oncletom.io/styles/blog.css?v=v3.3.2">
<!-- WebMentions -->
<link rel="pingback" href="https://webmention.io/oncletom.io/xmlrpc">
<link rel="webmention" href="https://webmention.io/oncletom.io/webmention">
<!-- Open Graph -->
<meta property="og:type" content="book">
<meta property="og:book:author" content="Thomas Parisot">
<meta property="og:book:isbn" content="978-2212139938">
<meta property="og:book:release_date" content="978-2212139938">
<meta property="og:book:tag" content="Node.js">
<meta property="og:book:tag" content="JavaScript">
<meta property="og:book:tag" content="npm">
<meta property="og:book:tag" content="D√©veloppement front-end">
<meta property="og:book:tag" content="D√©veloppement back-end">
<meta property="og:locale" content="fr_FR">
<meta property="og:site_name" content="Node.js ‚Ä¢¬†Apprendre par la pratique">
<!-- Twitter OpenGraph -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@oncletom">
<meta name="twitter:creator" content="@oncletom">
<style type="text/css" class="prism-theme">/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<style type="text/css" class="extension-interactive-runner">[data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
  background-color: #fcfcfc;
  border: 1px solid #0c2;
  border-radius: 1px;
  color: #0c2;
  cursor: pointer;
  display: inline-block;
  font-weight: bold;
  padding: .5em 1em;
  top: -2em;
}

  [lang="en"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "‚ñ∂ run code";
  }
  [lang="fr"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "‚ñ∂ voir le r√©sultat";
  }
  .interactive--javascript code[data-label]:before {
    content: attr(data-label);
  }

.interactive iframe {
  position: absolute;
  visibility: hidden;
}

.interactive.status--loaded iframe {
  position: inherit;
  visibility: visible;
}

.interactive.status--loading {
  opacity: .5;
}
</style>
<script class="extension-interactive-runner">
(function(d){
  document.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://embed.runkit.com/';
    script.async = true;
    script.onload = function(){
      function makeListingInteractive (element){
  if (element.classList.contains('interactive--installed') || element.classList.contains('status--loading')) {
    return;
  }

  const code = element.querySelector('code');
  const nodeVersion = /interactive--runtime--node-([^\s]+)/.exec(element.className)[1];
  const isEndpoint = element.classList.contains('interactive--endpoint');
  const mode = isEndpoint ? 'endpoint' : null;
  let preamble = '';

  const source = code
    .textContent
    .replace(/\/\/\s*\(\d+\)$/gm, '')
    .replace(/^["']?use strict["'][; ]*\n/, '');

  if (isEndpoint) {
    preamble = `process.nextTick(() => {
      if (typeof module.exports === 'function') {
        exports.endpoint = module.exports;
      }
      else if (typeof server !== 'undefined') {
        exports.endpoint = server.listeners("request").pop();
      }
});`
  }

  element.classList.add('status--loading');

  // eslint-disable-next-line no-undef
  RunKit.createNotebook({
    nodeVersion,
    element,
    source,
    mode,
    preamble,
    onLoad: function(ntbk) {
      element.classList.add('interactive--installed');
      element.classList.remove('status--loading');
      element.classList.add('status--loaded');
      code.parentNode.setAttribute('hidden', true);

      ntbk.evaluate();
    }
  });
}
function installEvents () {
  function getParent(el, condition) {
    let parent = el;

    while(parent = parent.parentNode) {
      if (condition(parent)) {
        return parent;
      }
    }
  }

  function hasClass(className) {
    return function check(el) {
      return el.classList.contains(className);
    }
  }

  document.querySelector('body').addEventListener('click', function(el) {
    if (el.target.classList.contains('language-javascript') || el.target.classList.contains('language-js')) {
      const parentNode = getParent(
        el.target,
        hasClass('interactive--javascript')
      );

      makeListingInteractive(parentNode);
    }
  });
}
      installEvents();
      document.body.dataset.interactiveRuntime = 'loaded';
    };
    document.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
.listingblock [data-bash-subs]::before {
  content: attr(data-bash-subs) " ";
  opacity: .5; }

.listingblock [data-bash-conum]::before {
  content: "(" attr(data-bash-conum) ")";
  font-weight: bold;
  opacity: .7;
}</style>
<script>
(function(d){
  d.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://unpkg.com/menuspy@1.3.0/dist/menuspy.js';
    script.async = true;
    script.onload = () => new MenuSpy(document.querySelector('#toc'), {enableLocationHash: false});
    d.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
#toc li.active > a[href^="#"] {
  font-weight: bold;
}
#toc li.active > a[href^="#"]::before {
  content: "‚ñ∂ ";
  display: inline-block;
  position: absolute;
  margin-left: -1.2em;
  font-size: .8em;
  margin-top: 3px;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Jouer avec Node.js</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table des mati√®res</div>
<ul class="sectlevel1">
<li><a href="#interagir_avec_linterpr√©teur_node">1. Interagir avec l&#8217;interpr√©teur Node</a>
<ul class="sectlevel2">
<li><a href="#node-version">1.1. Afficher la version</a></li>
<li><a href="#script">1.2. Avec un script</a></li>
<li><a href="#repl">1.3. Avec l&#8217;invite de commandes interactive (REPL)</a></li>
</ul>
</li>
<li><a href="#modules-builtin">2. Les modules de base</a>
<ul class="sectlevel2">
<li><a href="#console">2.1. console : d√©boguer rapidement des variables</a></li>
<li><a href="#path">2.2. path : manipuler des chemins de&#160;fichiers</a></li>
<li><a href="#url">2.3. url : manipuler des URL</a></li>
<li><a href="#fs">2.4. fs : manipuler le syst√®me de fichiers</a></li>
<li><a href="#events">2.5. events : programmer des √©v√©nements</a></li>
<li><a href="#util">2.6. util : transformer des fonctions de rappel en promesses</a></li>
<li><a href="#http">2.7. http : cr√©er et interroger des ressources via le protocole&#160;HTTP</a></li>
<li><a href="#os">2.8. os : en savoir plus sur les capacit√©s de l&#8217;ordinateur</a></li>
<li><a href="#child_process">2.9. child_process : appeler un ex√©cutable syst√®me</a></li>
<li><a href="#process">2.10. process : en savoir plus sur le processus en cours</a></li>
<li><a href="#stream">2.11. stream : manipuler des flux de donn√©es</a></li>
<li><a href="#dautres_modules_pour_aller_plus_loin">2.12. D&#8217;autres modules pour aller plus loin</a></li>
</ul>
</li>
<li><a href="#modules">3. Cr√©er ses propres modules Node</a>
<ul class="sectlevel2">
<li><a href="#modules.require">3.1. Importer et exporter des valeurs</a></li>
<li><a href="#require">3.2. Aller plus loin avec <code>require()</code></a></li>
<li><a href="#esm">3.3. Le futur : les modules ECMAScript</a></li>
</ul>
</li>
<li><a href="#errors">4. S&#8217;en sortir quand √ßa ne se passe pas comme&#160;pr√©vu</a>
<ul class="sectlevel2">
<li><a href="#une_erreur_est_nich√©e_dans_notrecode">4.1. Une erreur est nich√©e dans notre&#160;code</a></li>
<li><a href="#une_erreur_est_retourn√©e_dans_une_fonction_de_rappel">4.2. Une erreur est retourn√©e dans une fonction de rappel</a></li>
<li><a href="#une_erreur_est_retourn√©e_dans_une_promesse">4.3. Une erreur est retourn√©e dans une promesse</a></li>
<li><a href="#une_erreur_est_retourn√©e_dans_un_√©v√©nement">4.4. Une erreur est retourn√©e dans un √©v√©nement</a></li>
<li><a href="#errors.system">4.5. Une erreur est renvoy√©e par le syst√®me d&#8217;exploitation</a></li>
<li><a href="#le_programme_ne_se_termine_pas">4.6. Le programme ne se termine pas</a></li>
<li><a href="#deprecation">4.7. Une alerte de d√©pr√©ciation s&#8217;affiche</a></li>
</ul>
</li>
<li><a href="#les_diff√©rences_decmascript_entre_node_et_les_navigateursweb">5. Les diff√©rences d&#8217;ECMAScript entre Node et les navigateurs&#160;web</a>
<ul class="sectlevel2">
<li><a href="#labsence_du_dom_et_des_variables_window_et_document">5.1. L&#8217;absence du DOM et des variables <code>window</code> et <code>document</code></a></li>
<li><a href="#il_ny_a_pas_dinterface_graphique">5.2. Il n&#8217;y a pas d&#8217;interface graphique</a></li>
<li><a href="#le_m√©canisme_de_modules">5.3. Le m√©canisme de modules</a></li>
<li><a href="#linterfa√ßage_avec_le_syst√®me_dexploitation">5.4. L&#8217;interfa√ßage avec le syst√®me d&#8217;exploitation</a></li>
<li><a href="#node_est_un_processus_syst√®me">5.5. Node est un processus syst√®me</a></li>
</ul>
</li>
<li><a href="#options">6. Options utiles pour d√©marrer&#160;Node</a>
<ul class="sectlevel2">
<li><a href="#print-eval">6.1. Afficher le r√©sultat d&#8217;une expression, sans&#160;script</a></li>
<li><a href="#options-require">6.2. Pr√©charger un module</a></li>
<li><a href="#inspect">6.3. Inspecter notre code avec Google&#160;Chrome</a></li>
<li><a href="#options-v8">6.4. Ajuster les options de compatibilit√© et de tra√ßabilit√© de&#160;V8</a></li>
</ul>
</li>
<li><a href="#conclusion">7. Conclusion</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock tip context-callout">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="paragraph">
<p>Vous √™tes en train de lire le
<a href="https://oncletom.io/node.js/">livre &#8220;Node.js&#8221;</a>, √©crit par
<a href="https://oncletom.io">Thomas Parisot</a> et publi√© par les
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">√âditions Eyrolles</a>.</p>
</div>
<div class="paragraph">
<p>Il vous pla√Æt&#160;? Achetez-le en ligne sur
<a href="https://amzn.to/2E58PEw">Amazon</a>,
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">Eyrolles</a> ou
<a href="https://www.placedeslibraires.fr/livre/9782212139938">Place des Libraires</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons faire un tour d&#8217;horizon des capacit√©s de Node et de son syst√®me
de modules pour nous interfacer avec les syst√®mes d&#8217;exploitation Linux, macOS
et Windows.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Sommaire</div>
<ul>
<li>
<p>Interagir avec l&#8217;interpr√©teur&#160;Node</p>
</li>
<li>
<p>Les modules de base</p>
</li>
<li>
<p>Cr√©er ses propres modules</p>
</li>
<li>
<p>S&#8217;en sortir quand √ßa ne se passe pas comme pr√©vu</p>
</li>
<li>
<p>Les diff√©rences de JavaScript entre Node et les navigateurs&#160;web</p>
</li>
<li>
<p>Options utiles pour d√©marrer&#160;Node</p>
</li>
</ul>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Apr√®s avoir ex√©cut√© notre premier script Node, nous allons d√©couvrir
l&#8217;√©tendue des modules Node et ce qu&#8217;ils nous offrent en termes de capacit√©
d&#8217;interaction avec le syst√®me d&#8217;exploitation&#160;‚Äì disque, r√©seau, calculs, etc.</p>
</div>
<div class="paragraph">
<p>Nous apprendrons ensuite √† cr√©er et organiser nos propres modules&#160;‚Äì nous
d√©couvrirons comment les partager et les distribuer dans le chapitre 5.</p>
</div>
<div class="paragraph">
<p>Enfin, nous passerons en revue des erreurs typiques pour apprendre √† les lire
et √† mieux r√©agir avant de terminer sur des mani√®res alternatives d&#8217;ex√©cuter
des scripts Node, par exemple pour d√©bogueur ou charger d&#8217;autres modules.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Versions de Node et npm</div>
<div class="paragraph">
<p>Le contenu de ce chapitre utilise les versions <strong>Node&#160;v10</strong>
et <strong>npm&#160;v6</strong>.
Ce sont les versions stables recommand√©es en&#160;2019.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interagir_avec_linterpr√©teur_node">1. Interagir avec l&#8217;interpr√©teur Node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;interpr√©teur Node est le programme qui nous fournit des r√©sultats
en √©change d&#8217;instructions ECMAScript.
Le terminal est un autre programme permettant de faire dialoguer
un ordinateur avec les programmes install√©s.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="paragraph">
<p>Le <a href="../chapter-02/index.html">chapitre 2</a> d√©taille comment installer
Node et un terminal.
Il contient √©galement des conseils pour utiliser Node depuis un
navigateur web.
Cela peut rendre l&#8217;acc√®s au terminal plus facile.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ce chapitre se base sur le principe que vous avez un terminal install√©,
sur lequel vous allez saisir des instructions ECMAScript.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/terminal.png" alt="terminal" width="85%">
</div>
<div class="title">Figure 1. Exemple de terminal sous macOS</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Jouer avec les exemples dans un terminal</div>
<div class="paragraph">
<p>Les exemples titr√©s d&#8217;un nom de fichier peuvent √™tre install√©s sur votre ordinateur.
Ex√©cutez-les dans un terminal et amusez-vous √† les modifier en parall√®le de
votre lecture pour voir ce qui change.</p>
</div>
<div class="listingblock">
<div class="title">Installation des exemples via le module npm <code>nodebook</code></div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm install --global nodebook
<span data-bash-subs="$"></span>nodebook install chapter-04
<span data-bash-subs="$"></span>cd $(nodebook dir chapter-04)</pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante devrait afficher un r√©sultat qui confirme que vous √™tes
au bon endroit&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node hello.js</pre>
</div>
</div>
<div class="paragraph">
<p>Suivez √† nouveau les instructions d&#8217;installation pour r√©tablir les exemples
dans leur √©tat initial.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="node-version">1.1. Afficher la version</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Commen√ßons par afficher la version de l&#8217;interpr√©teur Node.
Nous nous assurons ainsi que nous pouvons interagir avec
lui avec succ√®s et qu&#8217;il est celui que nous attendons, dans la bonne version.
La version de Node conditionne la liste des fonctionnalit√©s du langage
ECMAScript √† disposition.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Compatibilit√©</span> Syntaxe ECMAScript</div>
<div class="paragraph">
<p>Le site web <span class="URL"><a href="https://node.green" class="bare">node.green</a></span> liste le niveau de compatibilit√©
des fonctionnalit√©s ECMAScript.</p>
</div>
<div class="paragraph">
<p>Cette page vous aidera √† comprendre quelles fonctionnalit√©s utiliser en toute
s√©curit√©, version par version de&#160;Node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une fois votre terminal ouvert, saisissez la commande suivante&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --version</pre>
</div>
</div>
<div class="paragraph">
<p>Le num√©ro de version de l&#8217;interpr√©teur Node s&#8217;affiche alors,
par exemple <code>v10.9.0</code>.</p>
</div>
<div class="paragraph">
<p>Si c&#8217;est ce √† quoi vous vous attendiez, passez √† la suite.
√Ä l&#8217;inverse, si une erreur se produit ou si la version
n&#8217;est pas la bonne, retournez √† la section
&#8220;<a href="../chapter-02/index.html#install">Installer Node.js</a>&#8221; du chapitre&#160;2.</p>
</div>
</div>
<div class="sect2">
<h3 id="script">1.2. Avec un script</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;ex√©cution d&#8217;un script Node est tr√®s certainement la pratique la plus courante.</p>
</div>
<div class="paragraph">
<p>L&#8217;interpr√©teur Node lit le contenu d&#8217;un fichier et ex√©cute les instructions.
L&#8217;interpr√©teur reste actif jusqu&#8217;√† ce que toutes les instructions
soient trait√©es.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">script.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">.</span><span class="token function">toLocaleUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier exemple <code>script.js</code> contient deux instructions.
Node les interpr√®te lorsqu&#8217;on lui passe le chemin du fichier en param√®tre
dans une invite de commandes&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node script.js
4
ABC</pre>
</div>
</div>
<div class="paragraph">
<p>Node nous rend ensuite la main pour ex√©cuter d&#8217;autres commandes.</p>
</div>
<div class="paragraph">
<p>On apprendra √† passer des <a href="#process.argv">arguments d&#8217;ex√©cution</a>
dans la section sur le <a href="#process">module <code>process</code></a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performances</span> Ressources machine</div>
<div class="paragraph">
<p>D√©marrer un processus Node a un co√ªt incompressible en ressources machine&#160;:
environ <strong>30&#160;Mo de&#160;RAM</strong> et <strong>40&#160;ms de CPU</strong> avant d&#8217;ex√©cuter nos
instructions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="repl">1.3. Avec l&#8217;invite de commandes interactive (REPL)</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;invite de commandes interactive est un moyen de parler
√† l&#8217;interpr√©teur Node sans √©crire de fichier.
Je l&#8217;utilise pour tester des id√©es et des √©l√©ments de syntaxe
quand je ne m&#8217;en rappelle&#160;plus.</p>
</div>
<div class="paragraph">
<p>Le mode interactif s&#8217;active en ex√©cutant Node sans aucun argument&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span></pre>
</div>
</div>
<div class="paragraph">
<p>On notera au passage que l&#8217;invite est pr√©fix√©e par le caract√®re&#160;`&gt;`
afin de marquer notre pr√©sence dans un environnement diff√©rent.
On retrouve un comportement similaire dans les invites de commande
des langages Ruby&#160;(<code>irb</code>), Python&#160;(<code>python</code>) et PHP&#160;(<code>php -a</code>)</p>
</div>
<div class="paragraph">
<p>Lorsque nous sommes dans l&#8217;interpr√©teur interactif,
toutes les expressions sont interpr√©t√©es par Node&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>2 + 2
4
<span data-bash-subs=">"></span>"abc".toLocaleUpperCase()
'ABC'
<span data-bash-subs=">"></span></pre>
</div>
</div>
<div class="paragraph">
<p>Des expressions sont r√©serv√©es pour obtenir de l&#8217;aide, sortir de l&#8217;interpr√©teur
ou simplement nettoyer ce que l&#8217;on voit √† l&#8217;√©cran.
Pour cela on fait appel √† l&#8217;instruction <code>.help</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>.help
.break    Sometimes you get stuck, this gets you out
.clear    Alias for .break
.editor   Enter editor mode
.exit     Exit the repl
.help     Print this help message
.load     Load JS from a file into the REPL session
.save     Save all evaluated commands in this REPL session to a file</pre>
</div>
</div>
<div class="paragraph">
<p>



</p>
</div>
<div class="paragraph">
<p>Les touches ou combinaisons de touches suivantes sont utiles pour naviguer dans
l&#8217;invite de commandes&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> annule
la saisie de la ligne en cours&#160;‚Äì c&#8217;est <span class="keyseq"><kbd>‚åÉ</kbd>+<kbd>C</kbd></span> sous macOS.</p>
</li>
<li>
<p><kbd>&#11014;</kbd> et <kbd>&#11015;</kbd> aident √† naviguer dans l&#8217;historique des commandes.</p>
</li>
<li>
<p><kbd>TAB</kbd> tente de compl√©ter la saisie avec une expression ou variable connue.

</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>conso<kbd>TAB</kbd>
<span data-bash-subs=">"></span>console
<span data-bash-subs=">"></span>console.<kbd>TAB</kbd>
...
console.assert                console.clear                 console.count
...</pre>
</div>
</div>
<div class="paragraph">
<p>On notera que l&#8217;utilisation de <kbd>TAB</kbd> apr√®s un caract√®re <em>point</em>&#160;(<code>.</code>)
liste l&#8217;int√©gralit√© des propri√©t√©s de cet objet.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Afficher toutes les variables connues</div>
<div class="paragraph">
<p>La touche <kbd>TAB</kbd> affiche toutes les variables connues
de la session interactive en cours.
Il suffit d&#8217;appuyer une ou deux fois dessus dans une invite vide&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span><kbd>TAB</kbd><kbd>TAB</kbd>
Array                         Boolean                       Date
Error                         EvalError                     Function
Infinity                      JSON                          Math
NaN                           Number                        Object
...</pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est un excellent moyen de d√©couvrir des √©l√©ments du langage qui nous
√©taient inconnus jusque-l√†.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La sortie de l&#8217;invite de commandes se fait √† l&#8217;aide de
l&#8217;utilisation r√©p√©t√©e de la combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>
(ou <span class="keyseq"><kbd>‚åÉ</kbd>+<kbd>C</kbd></span> sous macOS).
On revient ainsi √† l&#8217;√©tat initial o√π l&#8217;on √©tait avant de
saisir la commande&#160;`node`&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>
(To exit, press ^C again or type .exit)
<span data-bash-subs=">"></span>
<span data-bash-subs="$"></span></pre>
</div>
</div>
<div class="paragraph">
<p>Ce m√™me r√©sultat s&#8217;obtient en saisissant <code>.exit</code>
ou en utilisant la combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>D</kbd></span> (ou <span class="keyseq"><kbd>‚åÉ</kbd>+<kbd>D</kbd></span> sous macOS).

</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Variable magique&#160;<code>_</code></div>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>La variable&#160;<code>_</code> est sp√©cifique √† l&#8217;invite de commandes Node.
Elle contient syst√©matiquement le r√©sultat retourn√© par
la derni√®re √©valuation de code&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>2 + 2
4
<span data-bash-subs=">"></span>_ + 2
6</pre>
</div>
</div>
<div class="paragraph">
<p>Elle est √©quivalente √† la variable&#160;<code>$_</code> dans la console
des outils de d√©veloppement des navigateurs web.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modules-builtin">2. Les modules de base</h2>
<div class="sectionbody">
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Les modules de base <strong>√©tendent le champ d&#8217;action de Node</strong>.
Ils servent d&#8217;interfaces pour communiquer avec le syst√®me d&#8217;exploitation,
le syst√®me de fichiers, des ressources HTTP et des connexions r√©seau, entre autres.
Ils sont inclus avec chaque installation de Node.
On peut donc en b√©n√©ficier sans effort suppl√©mentaire.</p>
</div>
<div class="paragraph">
<p>Un module de base se charge en passant son identifiant
√† la fonction <code>require()</code>, qui retourne alors un objet avec un certain nombre
de propri√©t√©s et de fonctions.</p>
</div>
<div class="paragraph">
<p>Ainsi, on charge le <a href="#fs">module <code>fs</code></a> (pour <em>file system</em>&#160;‚Äì <em>syst√®me de fichiers</em>)
afin d&#8217;interagir avec les fichiers et les r√©pertoires pr√©sents sur l&#8217;ordinateur&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/read-dir.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(1)</b></span>

fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On charge les fonctions et attributs du module <code>fs</code> dans la variable du m√™me nom (on pourrait l&#8217;appeler autrement).</p>
</li>
<li>
<p>L&#8217;appel √† la fonction <code>fs.readdir()</code> passe un objet d&#8217;erreur ainsi que la liste des fichiers et r√©pertoires contenus dans le chemin indiqu√©.</p>
</li>
<li>
<p>Affiche un tableau contenant les noms de fichiers et de r√©pertoires pr√©sents dans le dossier courant.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ces modules de base repr√©sentent la pierre angulaire de nos applications Node.
Ils fournissent le n√©cessaire pour tout faire&#160;!
On apprendra √† √©tendre encore plus le champ des possibles dans
le <a href="../chapter-05/index.html">chapitre&#160;5</a>,
gr√¢ce aux <a href="../chapter-05/index.html#modules">modules&#160;<code>npm</code></a>.
</p>
</div>
<div class="paragraph">
<p>Les modules de base changent au fil du temps&#160;:
les nouvelles versions de Node ajoutent, corrigent et compl√®tent les modules et
fonctions existants.
La documentation officielle de Node refl√®te ces changements et
affiche un indice de stabilit√© pour savoir √† quoi s&#8217;en&#160;tenir.
</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/api-fs.png" alt="api fs" width="85%">
</div>
<div class="title">Figure 2. Documentation du module <code>fs</code> et son indice de stabilit√©</div>
</div>
<div class="paragraph">
<p>Exceptionnellement, un module de base (ou une de ses fonctions) peut √™tre supprim√©.
L&#8217;√©quipe de Node annonce ces changements en d√©pr√©ciant le module en question&#160;:
le code reste en place et sera supprim√© dans une version ult√©rieure.
En g√©n√©ral, c&#8217;est une question de mois voire d&#8217;ann√©es.
On verra plus loin comment <a href="#deprecation">afficher les alertes de d√©pr√©ciation</a>.
</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/api-deprecation-fs-exists.png" alt="api deprecation fs exists" width="85%">
</div>
<div class="title">Figure 3. Documentation de la fonction <code>fs.exists()</code>, affich√©e comme d√©pr√©ci√©e depuis Node&#160;v1</div>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Lecture des indices de stabilit√©</div>
<div class="paragraph">
<p>Node communique un indice de stabilit√© pour les modules de base.
Cette √©chelle se d√©compose en trois niveaux&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>D√©pr√©ci√©</strong>&#160;: le module sera supprim√© dans une prochaine version majeure.
√Ä l&#8217;avenir, il vaut mieux ne pas se compter dessus.</p>
</li>
<li>
<p><strong>Exp√©rimental</strong>&#160;: le module est en cours de d√©veloppement.
Une fonctionnalit√© exp√©rimentale peut changer radicalement entre deux
versions de Node.</p>
</li>
<li>
<p><strong>Stable</strong>&#160;: on peut faire confiance √† ce module.
Des choses peuvent changer exceptionnellement mais l&#8217;intention est d&#8217;offrir
une stabilit√©.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;indice est parfois appliqu√© √† des fonctions dont les attentes
changeraient d&#8217;une version √† l&#8217;autre de&#160;Node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les sections suivantes illustrent des usages courants des modules de base
pour mieux comprendre ce qu&#8217;on peut en attendre et comment les utiliser.</p>
</div>
<div class="sect2">
<h3 id="console">2.1. console : d√©boguer rapidement des variables</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;objet <code>console</code> est une bo√Æte √† outils pour afficher
ce qui se passe √† un moment donn√© dans un de nos scripts.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">console/log.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

count<span class="token operator">++</span><span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Valeur de count :'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La fonction √©crit les messages et la valeur des variables dans la
<a href="#process.std">sortie standard</a> du terminal&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node console/log.js
Valeur de count : 3</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Variable globale console</div>
<div class="paragraph">
<p>Node charge automatiquement le module pour nous et
le rend utilisable √† tout moment √† travers la variable globale <code>console</code>.</p>
</div>
<div class="paragraph">
<p>Il est donc inutile de charger le module manuellement avec <code>require('console')</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>console.log()</code> sait interpoler les valeurs pass√©es en argument avec le marqueur&#160;<code>%s</code>.
C&#8217;est utile pour structurer un message complexe en gardant les variables √† part&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">console/interpolate.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Soupe %s et carottes'</span><span class="token punctuation">,</span> <span class="token string">'lentilles'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>Soupe lentilles et carottes</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>%s</code>&#160;ne sait afficher que des cha√Ænes de caract√®res.
D&#8217;autres marqueurs savent afficher d&#8217;autres types de donn√©es&#160;:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>%d</code>
</td>
<td class="hdlist2">
<p>Affiche la valeur en tant que <a href="../chapter-03/index.html#number">nombre</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>%j</code>
</td>
<td class="hdlist2">
<p>Affiche la valeur en tant que <a href="../chapter-03/index.html#json">structure&#160;JSON</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>%O</code>
</td>
<td class="hdlist2">
<p>Affiche l&#8217;objet avec une profondeur maximum de 4&#160;√©l√©ments.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>%o</code>
</td>
<td class="hdlist2">
<p>Idem que&#160;<code>%O</code> mais sur une profondeur maximum de 2&#160;√©l√©ments.</p>
</td>
</tr>
</table>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables</div>
<table>
<tr>
<td class="hdlist1">
<code>console.log()</code>
</td>
<td class="hdlist2">
<p>Affichage de messages et de variables dans le terminal.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>console.error()</code>
</td>
<td class="hdlist2">
<p>Comportement identique √† <code>console.log()</code> mais √† r√©server aux erreurs.
La fonction √©crit dans la <a href="#process.std">sortie erreur</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>console.dir()</code>
</td>
<td class="hdlist2">
<p>Affichage d√©di√© aux objets et tableaux.
On peut param√©trer la profondeur d&#8217;affichage
(par d√©faut, jusqu&#8217;√† deux niveaux).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>console.group()</code>
</td>
<td class="hdlist2">
<p>Regroupe visuellement les appels √† <code>console.log</code> et <code>console.error</code>.
Un groupe se cl√¥t avec <code>console.groupEnd()</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>console.time()</code>
</td>
<td class="hdlist2">
<p>D√©marre un chronom√®tre en lui attribuant un nom.
Le chronom√®tre s&#8217;arr√™te et sa dur√©e s&#8217;affiche avec <code>console.timeEnd()</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
classe <code>Console</code>
</td>
<td class="hdlist2">
<p>  Cr√©e un objet similaire √† <code>console</code> mais en dirigeant l&#8217;affichage ailleurs
  que vers les <a href="#process.std">flux standards</a>.




</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Web</span> Console et navigateurs&#160;web</div>
<div class="paragraph">
<p>L&#8217;objet <code>console</code> est originaire du monde des navigateurs web.
C&#8217;est un onglet de la bo√Æte √† outils de d√©veloppement.
On peut y lire des messages plac√©s dans le code JavaScript de la page web.
On l&#8217;utilise aussi pour inspecter la page et interagir avec du&#160;code.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/web-console.png" alt="web console">
</div>
<div class="title">Figure 4. Console web dans le navigateur web Firefox</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module console</div>
<div class="paragraph">
<p>La documentation du module <code>console</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/console.html" class="bare">nodejs.org/docs/latest-v10.x/api/console.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="path">2.2. path : manipuler des chemins de&#160;fichiers</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le module <code>path</code> offre un ensemble de fonctions et de propri√©t√©s pour
manipuler et construire des chemins vers des fichiers et r√©pertoires.</p>
</div>
<div class="paragraph">
<p>Ces op√©rations permettent √† notre code de fonctionner de mani√®re identique
sur des syst√®mes d&#8217;exploitation qui expriment diff√©remment les chemins&#160;‚Äì
Linux et Windows par exemple.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token string">'/tmp/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/tmp/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'/tmp/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>/tmp</code>.</p>
</li>
<li>
<p>Affiche <code>package.json</code>.</p>
</li>
<li>
<p>Affiche <code>.json</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Certaines fonctions comme <code>path.join()</code> tiennent compte de la nature du syst√®me
d&#8217;exploitation.
Le r√©sultat d&#8217;un m√™me appel de fonction sera diff√©rent, mais correspondra
√† la m√™me intention&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path/platform.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'tmp'</span><span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche&#160;<code>/</code> (<code>\</code>&#160;sous Windows).</p>
</li>
<li>
<p>Affiche <code>tmp/package.json</code>&#160;‚Äì <code>tmp\package.json</code> sous Windows.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On constate que <code>path.join()</code> assemble les chemins en utilisant la valeur de
<code>path.sep</code>.
Ce qui est bien pour nous, c&#8217;est qu&#8217;on n&#8217;a pas besoin d&#8217;y penser&#160;:
<strong>Node se charge de la compatibilit√© avec le syst√®me d&#8217;exploitation</strong>.</p>
</div>
<div class="paragraph">
<p>La diff√©rence de r√©sultats se pr√©cise un peu plus lorsque l&#8217;on tente de calculer
des chemins complets, <em>relatifs √† notre emplacement</em> actuel&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path/relative.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> relative_diff <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>
  <span class="token string">'/tmp/package.json'</span><span class="token punctuation">,</span> <span class="token string">'/tmp/source'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolve_diff <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
  <span class="token string">'/tmp/package.json'</span><span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'./source'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>relative_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resolve_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>../source</code> (<code>..\source</code> sous Windows)&#160;‚Äì c&#8217;est ce qu&#8217;il faut parcourir pour aller du premier chemin au second.</p>
</li>
<li>
<p>Affiche <code>/tmp/source</code> (<code>C:\tmp\source</code> sous Windows)&#160;‚Äì on constate que le chemin <em>r√©solu</em> est absolu, et int√®gre la lettre du lecteur sous Windows.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les r√©sultats produits par les fonctions du module <code>path</code>
se combinent particuli√®rement bien avec celles <a href="#fs">du module&#160;<code>fs</code></a>, pour
acc√©der aux fichiers.
</p>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables</div>
<table>
<tr>
<td class="hdlist1">
<code>path.basename()</code>
</td>
<td class="hdlist2">
<p>Retourne le nom de fichier.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.dirname()</code>
</td>
<td class="hdlist2">
<p>Retourne le nom de r√©pertoire.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.extname()</code>
</td>
<td class="hdlist2">
<p>Retourne l&#8217;extension d&#8217;un fichier.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.isAbsolute()</code>
</td>
<td class="hdlist2">
<p>Indique si le chemin est <em>absolu</em> ou&#160;non.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.join()</code>
</td>
<td class="hdlist2">
<p>Assemble des bouts de chemin.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.parse()</code>
</td>
<td class="hdlist2">
<p>Retourne des informations li√©es √† la compr√©hension d&#8217;un chemin
(extension, nom de fichier, nom de r√©pertoire).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.relative()</code>
</td>
<td class="hdlist2">
<p>Calcule le chemin relatif entre un chemin source et un de destination.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.resolve()</code>
</td>
<td class="hdlist2">
<p>Calcule un chemin absolu √† partir de plusieurs bouts de chemin.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>path.sep</code>
</td>
<td class="hdlist2">
<p>  Retourne le caract√®re servant de s√©parateur de r√©pertoires
  pour le syst√®me d&#8217;exploitation sur lequel est ex√©cut√© le script&#160;:
  <code>/</code>&#160;pour Linux et macOS, <code>\</code>&#160;pour Windows.







</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Compatibilit√©</span> Manipuler des chemins Windows sous Linux et vice-versa</div>
<div class="paragraph">
<p>On peut avoir besoin de manipuler des chemins Windows avec du code
ex√©cut√© sur un autre syst√®me d&#8217;exploitation comme Linux ou macOS.
C&#8217;est exactement ce que proposent les fonctions de <code>path.win32</code>.

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path/win32.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">,</span>resolve<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>win32<span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'tmp'</span><span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'C:\\tmp'</span><span class="token punctuation">,</span> <span class="token string">'../etc'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On d√©structure les fonctions depuis la variante <code>win32</code> du module <code>path</code>.</p>
</li>
<li>
<p>Affiche <code>tmp\package.json</code>.</p>
</li>
<li>
<p>Affiche <code>C:\etc</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;objet <code>path.posix</code> fonctionne de la m√™me mani√®re pour des chemins Linux.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module path</div>
<div class="paragraph">
<p>La documentation du module <code>path</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/path.html" class="bare">nodejs.org/docs/latest-v10.x/api/path.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="url">2.3. url : manipuler des URL</h3>
<div class="paragraph">
<p>


</p>
</div>
<div class="paragraph">
<p>Le module <code>url</code> offre des outils pour interpr√©ter des URL, les transformer
et les assembler √† nouveau sous forme de cha√Æne de caract√®res.
La variable <code>URL</code> (en majuscules) est disponible de mani√®re globale.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://oncletom.io/node.js/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>oncletom.io</code>.</p>
</li>
<li>
<p>Affiche <code>/node.js/</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Web</span> Compatibilit√© avec les navigateurs</div>
<div class="paragraph">
<p>
La classe <code>URL</code> que nous utilisons dans Node est la m√™me que dans les
navigateurs web modernes.
Son fonctionnement suit le standard <span class="URL"><a href="https://url.spec.whatwg.org" class="bare">url.spec.whatwg.org</a></span>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;objet retourn√© par le constructeur de <code>URL</code> est modifiable.
Il est ainsi possible de changer les parties de l&#8217;URL qui nous int√©ressent
et de r√©cup√©rer une URL sous forme d&#8217;une cha√Æne de caract√®res&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/to-string.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://oncletom.io/node.js/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
example<span class="token punctuation">.</span>pathname <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
example<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">'#top'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code><a href="https://oncletom.io/#top" class="bare">oncletom.io/#top</a></code>&#160;‚Äì le chemin et le fragment ont √©t√© modifi√©s.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La fonction <code>format()</code> va plus loin que <code>url.toString()</code>.
Ses options contr√¥lent plus finement ce qui sera conserv√© ou retir√© lors
de la conversion en cha√Æne de caract√®res.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/format.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>format<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://user:password@oncletom.io/#top?test=1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  auth<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  search<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  fragment<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span>example<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code><a href="https://oncletom.io/" class="bare">oncletom.io/</a></code>&#160;‚Äì¬†les identifiants, l&#8217;ancre et les arguments ont √©t√© retir√©s par la fonction <code>format()</code>.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le constructeur <code>URL</code> accepte une URL de r√©f√©rence en second argument.
Cette adresse r√©sout un chemin absolu √† partir du premier argument&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/resolve.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> url1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'/node.js/'</span><span class="token punctuation">,</span> <span class="token string">'https://oncletom.io'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'https://oncletom.io/node.js/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code><a href="https://oncletom.io/node.js/" class="bare">oncletom.io/node.js/</a></code>.</p>
</li>
<li>
<p>Affiche <code><a href="https://oncletom.io/" class="bare">oncletom.io/</a></code>.</p>
</li>
</ol>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables</div>
<table>
<tr>
<td class="hdlist1">
<code>url.parse()</code>
</td>
<td class="hdlist2">
<p>Transforme une cha√Æne de caract√®res en un objet utilisable avec la fonction
<a href="#http.request"><code>http.request()</code></a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
classe <code>URL</code>
</td>
<td class="hdlist2">
<p>Repr√©sentation de la structure d&#8217;une&#160;URL.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
classe <code>URLSearchParams</code>
</td>
<td class="hdlist2">
<p>  Repr√©sentation des param√®tres&#160;d&#8217;URL.


</p>
</td>
</tr>
</table>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables de la classe <code>URL</code></div>
<table>
<tr>
<td class="hdlist1">
<code>url.format()</code>
</td>
<td class="hdlist2">
<p>Transforme un objet <code>URL</code> en cha√Æne de caract√®res gr√¢ce √† des contr√¥les&#160;fins.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>url.toString()</code>
</td>
<td class="hdlist2">
<p>Transforme l&#8217;objet <code>URL</code> en cha√Æne de caract√®res.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.hash</code>
</td>
<td class="hdlist2">
<p>Fragment de&#160;l&#8217;URL.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.hostname</code>
</td>
<td class="hdlist2">
<p>Nom de l&#8217;h√¥te.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.pathname</code>
</td>
<td class="hdlist2">
<p>Chemin d&#8217;acc√®s √† la ressource.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.protocol</code>
</td>
<td class="hdlist2">
<p>Protocole sp√©cifi√©.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.search</code>
</td>
<td class="hdlist2">
<p>Param√®tres de l&#8217;URL, caract√®re&#160;<code>?</code> inclus.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.searchParams</code>
</td>
<td class="hdlist2">
<p>Objet permettant de manipuler les param√®tres.
Voir ci-apr√®s.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Manipuler une URL est plus ais√© lorsqu&#8217;elle est structur√©e sous forme d&#8217;objet.
Les param√®tres ne sont pas en reste avec l&#8217;attribut <code>searchParams</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/search-params.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://oncletom.io/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
example<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">,</span> <span class="token string">'node.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>

example<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code><a href="https://oncletom.io/?search=node.js" class="bare">oncletom.io/?search=node.js</a></code>&#160;‚Äì repr√©sentation de l&#8217;URL compl√®te.</p>
</li>
<li>
<p>Affiche <code>search=node.js</code>&#160;‚Äì repr√©sentation des param√®tres seulement.</p>
</li>
<li>
<p>Affiche <code><a href="https://oncletom.io/" class="bare">oncletom.io/</a></code>&#160;‚Äì le param√®tre <code>search</code> et sa valeur ont √©t√© supprim√©s de&#160;l&#8217;URL.</p>
</li>
</ol>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables de la classe <code>URLSearchParams</code></div>
<table>
<tr>
<td class="hdlist1">
<code>searchParams.append()</code>
</td>
<td class="hdlist2">
<p>Ajoute un param√®tre √† la suite de l&#8217;URL.
Cette fonction permet d&#8217;ajouter plusieurs fois une m√™me cl√©, peu importe sa valeur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.delete()</code>
</td>
<td class="hdlist2">
<p>Supprime un param√®tre&#160;d&#8217;URL.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.get()</code>
</td>
<td class="hdlist2">
<p>Retoure la valeur d&#8217;un param√®tre donn√©.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.getAll()</code>
</td>
<td class="hdlist2">
<p>Renvoie toutes les valeurs d&#8217;un param√®tre donn√©.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.has()</code>
</td>
<td class="hdlist2">
<p>Indique <code>true</code> si les param√®tres contiennent une cl√© donn√©e.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.set()</code>
</td>
<td class="hdlist2">
<p>Affecte une valeur √† un param√®tre&#160;d&#8217;URL.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.toString()</code>
</td>
<td class="hdlist2">
<p>Retourne une repr√©sentation de l&#8217;objet sous forme d&#8217;une cha√Æne
de caract√®res exploitable dans une&#160;URL.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module url</div>
<div class="paragraph">
<p>La documentation du module <code>url</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/url.html" class="bare">nodejs.org/docs/latest-v10.x/api/url.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="fs">2.4. fs : manipuler le syst√®me de fichiers</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le module&#160;<code>fs</code> est un incontournable.
On y a recours d√®s que l&#8217;on a besoin de lire ou d&#8217;√©crire dans un fichier.
On s&#8217;en sert √©galement pour cr√©er, d√©placer ou supprimer des fichiers
et des r√©pertoires.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Lorsque la lecture du fichier aboutit, la <a href="#callbacks">fonction de rappel</a> est appel√©e avec deux param√®tres&#160;: un objet d&#8217;erreur et le contenu.</p>
</li>
<li>
<p>Affiche le contenu d&#8217;un fichier <code>package.json</code>.
</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Variables __filename et __dirname</div>
<div class="paragraph">
<p><code>__filename</code> est une cha√Æne de caract√®res faisant r√©f√©rence au fichier actuel.<br>
<code>__dirname</code> fait r√©f√©rence au r√©pertoire du fichier actuel.

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">dirname-filename.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>filename <span class="token operator">===</span> __filename<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>/&#8230;&#8203;/chapter-04/examples/dirname-filename.js</code>.</p>
</li>
<li>
<p>Affiche <code>true</code>&#160;‚Äì √ßa ne serait pas un <em>raccourci</em> sinon&#160;;-).</p>
</li>
<li>
<p>Affiche <code>/&#8230;&#8203;/chapter-04/examples</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ces variables sont utiles pour op√©rer sur des <em>chemins relatifs au fichier actuel</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dans l&#8217;exemple pr√©c√©dent, nous avons parcouru le contenu d&#8217;un fichier.
<code>fs.readdir()</code> parcourt un r√©pertoire&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/ls.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>readdir<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En l&#8217;ex√©cutant, nous obtenons le r√©sultat suivant&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node fs/ls.js
[ '.eslintrc.yaml',
  'console',
  'debug.txt',
  'deprecation-warning.js',
  'process/env.js',
  ...
  'util' ]</pre>
</div>
</div>
<div class="paragraph">
<p>Dans les environnements UNIX, le point&#160;(<code>.</code>) pour faire r√©f√©rence au
<em>r√©pertoire courant</em> et deux points (<code>..</code>) pour le <em>r√©pertoire parent</em>.
C&#8217;est le cas avec Node √©galement.
La notion de <em>courant</em> fait r√©f√©rence √† l&#8217;emplacement depuis lequel nous
appelons l&#8217;ex√©cutable <code>node</code>.</p>
</div>
<div class="paragraph">
<p>Changeons de r√©pertoire&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>cd ../..
<span data-bash-subs="$"></span>node chapter-04/examples/fs/ls.js
[ '.eslintignore',
  'README.md',
  'chapter-01'
  'chapter-02'
  ...
  'tests' ]</pre>
</div>
</div>
<div class="paragraph">
<p>Les <em>chemins relatifs</em> se d√©finissent par rapport √† l&#8217;emplacement depuis
lequel on ex√©cute la commande <code>node</code>.
<code>__dirname</code> et <code>__filename</code> sont d√©termin√©es par rapport
√† l&#8217;emplacement du script qui fait r√©f√©rence √† ces variables.</p>
</div>
<div class="paragraph">
<p>Puisque les op√©rations li√©es au syst√®me de fichiers ne sont pas imm√©diates
les fonctions de ce module sont en majorit√© <strong>asynchrones</strong>.
Leur rapidit√© d&#8217;ex√©cution varie en fonction du support de stockage utilis√©
(disque, m√©moire), de son usure et de la capacit√© de traitement de la CPU
de l&#8217;ordinateur.</p>
</div>
<div class="paragraph">
<p>Cela veut aussi dire que les erreurs sont obtenues de mani√®re asynchrone&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/rmdir.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Indique que la suppression n&#8217;a pas abouti car le r√©pertoire en question n&#8217;est pas vide&#160;‚Äì et pour cause, c&#8217;est celui qui contient notre fichier d&#8217;exemple.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On peut articuler plusieurs op√©rations entre elles et utiliser le <a href="#path">module&#160;<code>path</code></a>
pour construire des chemins robustes qui fonctionnent avec tous les syst√®mes
d&#8217;exploitation, sans effort.
</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant cr√©e un r√©pertoire dans un <a href="#os">dossier temporaire</a>,
copie un fichier sous un autre nom et liste le contenu du r√©pertoire
une fois la copie effectu√©e.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/copy-tmp.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>tmpdir<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dest_dir <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token function">tmpdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span>

fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dest_dir<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                   <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">const</span> dest <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>dest_dir<span class="token punctuation">,</span> <span class="token string">'example-copy.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  fs<span class="token punctuation">.</span><span class="token function">copyFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>      <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`La copie vers </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dest<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> s'est bien pass√©e.`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On assemble un chemin compos√© √† partir du <a href="#os">r√©pertoire temporaire</a> fourni par le syst√®me d&#8217;exploitation.</p>
</li>
<li>
<p>Cr√©e le r√©pertoire en question.</p>
</li>
<li>
<p>Copie le contenu de ce script d&#8217;exemple vers le r√©pertoire en question en lui attribuant un nouveau nom.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">üö®</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">S√©curit√©</span> Utilisateur et permissions</div>
<div class="paragraph">
<p>

Le script Node ex√©cut√© a le droit d&#8217;acc√©der, d&#8217;alt√©rer et de supprimer
au m√™me titre que l&#8217;utilisateur syst√®me qui lance le script.</p>
</div>
<div class="paragraph">
<p>Ce n&#8217;est pas grave si on ex√©cute du code √©crit soi-m√™me.
Il faut √™tre vigilant¬∑e si le code ex√©cut√© provient d&#8217;une autre personne.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si l&#8217;exemple pr√©c√©dent semble agr√©able √† lire, il r√©v√®le deux points de vigilance.</p>
</div>
<div class="paragraph">
<p>J&#8217;ai √©crit le code de mani√®re "optimiste", pour des questions de lisibilit√©.
Pourtant, √† chaque op√©ration, il y a une possibilit√© d&#8217;erreur √† g√©rer&#160;:
de la cr√©ation du r√©pertoire jusqu&#8217;√† la lecture des fichiers qu&#8217;il contient.
Il faudrait v√©rifier l&#8217;argument <code>error</code> √† chaque fois et d√©cider quoi faire
en fonction de la <a href="#errors">nature du probl√®me</a>.</p>
</div>
<div class="paragraph">
<p>Je vous invite √† modifier ce code
pour afficher la valeur des variables <code>error</code> √† l&#8217;aide des
<a href="#console">fonctions du module <code>console</code></a>.
Certaines erreurs apparaissent quand nous invoquons le script une seconde fois.
</p>
</div>
<div class="paragraph">
<p>L&#8217;imbrication des <a href="#callbacks">fonctions de rappel</a> fait qu&#8217;il est
<strong>difficile d&#8217;en interrompre la suite</strong>.
Une bonne piste serait d&#8217;appliquer l'<a href="#util">utilitaire <code>promisify</code></a>
sur les fonctions du module&#160;<code>fs</code> afin de cr√©er une
<a href="../chapter-03/index.html#promise">cha√Æne de promesses</a>.<br>
Nous apprendrons √† le faire dans la section sur le <a href="#util">module&#160;<code>util</code></a>.


</p>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables</div>
<table>
<tr>
<td class="hdlist1">
<code>fs.appendFile()</code>
</td>
<td class="hdlist2">
<p>Ajoute un contenu √† la suite d&#8217;un fichier existant.
Le fichier sera cr√©√© le cas √©ch√©ant.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.copyFile()</code>
</td>
<td class="hdlist2">
<p>Copie un fichier depuis un emplacement vers un autre.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.mkdir()</code>
</td>
<td class="hdlist2">
<p>Cr√©e un nouveau r√©pertoire.
Le r√©pertoire parent doit d√©j√† exister.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.readdir()</code>
</td>
<td class="hdlist2">
<p>Obtient la liste des fichiers et dossiers contenus dans un r√©pertoire donn√©.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.readFile()</code>
</td>
<td class="hdlist2">
<p>Lit le contenu d&#8217;un fichier.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.rename()</code>
</td>
<td class="hdlist2">
<p>Renomme un fichier ou un r√©pertoire.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.rmdir()</code>
</td>
<td class="hdlist2">
<p>Supprime un r√©pertoire.
Il doit √™tre vide.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.stat()</code>
</td>
<td class="hdlist2">
<p>Retourne des informations √† propos d&#8217;un chemin d&#8217;acc√®s&#160;:
est-ce que c&#8217;est un fichier, un r√©pertoire, un lecteur, un lien symbolique&#160;?
Des attributs pr√©cisent la taille du fichier (en octets), l&#8217;identifiant
syst√®me de son propri√©taire, la date de cr√©ation/modification/dernier acc√®s, etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.symlink()</code>
</td>
<td class="hdlist2">
<p>Cr√©e un lien symbolique vers un emplacement.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.truncate()</code>
</td>
<td class="hdlist2">
<p>Raccourcit le contenu d&#8217;un fichier √† une longueur donn√©e (en nombre d&#8217;octets).
Si aucun argument n&#8217;est donn√©, le contenu du fichier est remis √†&#160;z√©ro.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.createReadStream()</code>
</td>
<td class="hdlist2">
<p>Cr√©e un <a href="#stream">flux de lecture</a>, pour lire un fichier en continu.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.createWriteStream()</code>
</td>
<td class="hdlist2">
<p>Cr√©e un <a href="#stream">flux d&#8217;√©criture</a>, pour √©crire en continu dans un fichier.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">D√©finition</span> Lien symbolique</div>
<div class="paragraph">
<p>Fichier qui fait r√©f√©rence √† un autre fichier&#160;‚Äì c&#8217;est comme un <em>alias</em>.
Toutes les modifications effectu√©es sur le lien symbolique sont
r√©percut√©es sur le fichier d&#8217;origine.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://fr.wikipedia.org/wiki/Lien_symbolique" class="bare">fr.wikipedia.org/wiki/Lien_symbolique</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module fs</div>
<div class="paragraph">
<p>La documentation du module <code>fs</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/fs.html" class="bare">nodejs.org/docs/latest-v10.x/api/fs.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="events">2.5. events : programmer des √©v√©nements</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Le module <code>events</code> contient le n√©cessaire pour cr√©er du code communiquant
√† l&#8217;aide de fonctions d&#8217;√©coute et d&#8217;√©mission de messages.
C&#8217;est comme un <em>centre de tri postal</em>, mais avec des variables
en guise de courriers.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">events/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>

emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">date</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                    <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Ann√©e : %d'</span><span class="token punctuation">,</span> date<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2018-03-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(3)</b></span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'1983-03-24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Cr√©ation d&#8217;un gestionnaire d&#8217;√©v√©nements.</p>
</li>
<li>
<p>Enregistrement d&#8217;une fonction d&#8217;√©coute&#160;‚Äì elle sera ex√©cut√©e √† chaque √©mission de l&#8217;√©v√©nement&#160;<code>date</code>.</p>
</li>
<li>
<p>√âmission d&#8217;un √©v√©nement <code>date</code>, avec comme argument, un <a href="../chapter-03/index.html#date">objet&#160;<code>Date</code></a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Un √©v√©nement se d√©compose en trois parties&#160;: les fonctions d&#8217;√©coute,
les √©missions de message et un objet <code>EventEmitter</code>
qui fait le lien entre les deux.
</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Langage</span> ECMAScript n&#8217;est pas √©v√©nementiel</div>
<div class="paragraph">
<p>Contrairement √† ce que l&#8217;on pourrait penser, le langage ECMAScript ne poss√®de
aucune structure de gestion d&#8217;√©v√©nements.</p>
</div>
<div class="paragraph">
<p>S&#8217;il est possible de r√©agir √† des √©v√©nements dans les navigateurs web,
c&#8217;est gr√¢ce √† la sp√©cification DOM&#160;‚Äì l&#8217;API JavaScript pour manipuler
une structure de document&#160;HTML.
</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://developer.mozilla.org/fr/docs/Web/Events" class="bare">developer.mozilla.org/fr/docs/Web/Events</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On peut d√©cider d&#8217;√©couter un √©v√©nement une seule fois avec&#160;<code>once()</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">events/once.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">date</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                  <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Ann√©e : %d'</span><span class="token punctuation">,</span> date<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2018-03-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'1983-03-24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Bien que l&#8217;√©v√©nement <code>date</code> soit appel√© deux fois, la fonction d&#8217;√©coute ne r√©agira qu&#8217;une seule fois.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La fonction <code>removeListener()</code> d√©branche une fonction d&#8217;√©coute selon
les crit√®res de notre choix&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">events/remove.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">tick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  counter<span class="token operator">++</span><span class="token punctuation">;</span>
  emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(1)</b></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">===</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> tick<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(2)</b></span>
emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    emitter<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> tick<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>L&#8217;√©v√©nement <code>date</code> est √©mis toutes les secondes.</p>
</li>
<li>
<p>La fonction <code>tick</code> est appel√©e toutes les secondes.</p>
</li>
<li>
<p>La fonction <code>tick</code> est d√©branch√©e de l&#8217;√©v√©nement <code>date</code> au bout de trois incr√©ments.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On remarquera qu&#8217;il faut pouvoir faire r√©f√©rence √† la fonction d&#8217;√©coute
afin de la d√©brancher.</p>
</div>
<div class="paragraph">
<p>Une utilisation alternative des √©v√©nements consiste √† √©tendre la classe <code>EventEmitter</code>.
Une fois √©tendue, notre nouvelle classe b√©n√©ficiera des m√©thodes <code>.on()</code> etc.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">events/class.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>                   <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">start</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'d√©marrer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> auto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">'Boombo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
auto<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">car<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>               <span class="token comment">// <b class="conum">(4)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s est en train de %s'</span><span class="token punctuation">,</span> car<span class="token punctuation">.</span>name<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

auto<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Extension de la classe <code>EventEmitter</code>.</p>
</li>
<li>
<p>L&#8217;utilisation de la fonction sp√©ciale <code>super()</code> est indispensable. Elle revient √† invoquer <code>new EventEmitter()</code> par m√©canisme de cascade.</p>
</li>
<li>
<p>La m√©thode <code>.start()</code> encapsule un appel √† la m√©thode <code>.emit()</code>.</p>
</li>
<li>
<p>La fonction r√©agira √† l&#8217;√©mission de l&#8217;√©v√©nement <code>action</code> quand la m√©thode <code>.start()</code> sera appel√©e.



</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce m√©canisme est utile pour cacher de la complexit√© applicative,
pour ex√©cuter une fonction plusieurs fois lors d&#8217;un √©v√©nement donn√©,
pour exposer une surface d&#8217;action compr√©hensible,
tout en rendant notre code communiquant vers l&#8217;ext√©rieur.</p>
</div>
<div class="paragraph">
<p>Plusieurs modules Node utilisent les √©v√©nements pour nous permettre d&#8217;y
r√©agir de mani√®re totalement optionnelle.
Tout ce que l&#8217;on vient d&#8217;expliquer s&#8217;applique √† l&#8217;identique aux modules
<a href="#process"><code>process</code></a>, <a href="#child_process"><code>child_process</code></a> et <a href="#http"><code>http</code></a>.


</p>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables de la classe <code>EventEmitter</code></div>
<table>
<tr>
<td class="hdlist1">
<code>on()</code>
</td>
<td class="hdlist2">
<p>Enregistre une nouvelle fonction r√©agissant √† un √©v√©nement donn√©.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>once()</code>
</td>
<td class="hdlist2">
<p>Enregistre une nouvelle fonction r√©agissant <em>une seule fois</em> √† un √©v√©nement donn√©.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>emit()</code>
</td>
<td class="hdlist2">
<p>√âmet un √©v√©nement.
Si des arguments additonnels sont pr√©sents,
ils sont transmis aux fonctions √©coutant cet √©v√©nement.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>eventNames()</code>
</td>
<td class="hdlist2">
<p>Liste les √©v√©nements pour lesquels on a enregistr√© au moins une fonction d&#8217;√©coute.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>listeners()</code>
</td>
<td class="hdlist2">
<p>Liste les fonctions √©coutant les √©v√©nements.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>removeListener()</code>
</td>
<td class="hdlist2">
<p>Supprime une fonction d&#8217;√©coute d&#8217;un √©v√©nement donn√©.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>removeAllListeners()</code>
</td>
<td class="hdlist2">
<p>Supprime toutes les fonctions d&#8217;√©coute d&#8217;un √©v√©nement donn√©.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>setMaxListeners()</code>
</td>
<td class="hdlist2">
<p>  Change le nombre maximum de fonctions d&#8217;√©coute possibles (10&#160;par d√©faut,
  c&#8217;est&#160;peu).
</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module events</div>
<div class="paragraph">
<p>La documentation du module <code>events</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/events.html" class="bare">nodejs.org/docs/latest-v10.x/api/events.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="util">2.6. util : transformer des fonctions de rappel en promesses</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le petit module <code>util</code> contient des fonctions utilitaires
qui n&#8217;entreraient pas dans le p√©rim√®tre d&#8217;autres modules.</p>
</div>
<div class="paragraph">
<p>On y trouve <code>util.format()</code>, une fonction qui fait beaucoup penser √†
<a href="#console"><code>console.log()</code></a> mais sans afficher le message&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">util/format.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>format<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span>           <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token string">'Il fait %s aujourd\'hui'</span><span class="token punctuation">,</span>
  <span class="token string">'‚òÄÔ∏è '</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// console.log(message);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affecte le message format√© √† une variable sans l&#8217;afficher.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour afficher la valeur de la variable <code>message</code> de l&#8217;exemple pr√©c√©dent,
il suffirait de d√©commenter la derni√®re ligne et de (re)lancer le script.</p>
</div>
<div class="paragraph">
<p>La fonction <code>util.debuglog()</code> formate aussi des messages.
Son affichage est toutefois conditionnel, ce qui est pratique quand on veut
d√©boguer des variables sans toucher au code entre deux ex√©cutions.

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">util/debuglog.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>debuglog<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>cpus<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">debuglog</span><span class="token punctuation">(</span><span class="token string">'nodebook'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> infos <span class="token operator">=</span> <span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cpu</span> <span class="token operator">=></span> cpu<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Cet ordinateur a %d CPU.'</span><span class="token punctuation">,</span> infos<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Le mod√®le de CPU est %s.'</span><span class="token punctuation">,</span> infos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Cr√©ation d&#8217;un d√©bogueur nomm√© <code>nodebook</code>.</p>
</li>
<li>
<p>Ce message s&#8217;affiche syst√©matiquement quand on ex√©cute le script.</p>
</li>
<li>
<p>Le mod√®le de CPU sera affich√© en invoquant Node en pr√©sence de la variable d&#8217;environnement <code>NODE_DEBUG</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En lan√ßant la commande suivante, seul le message de <code>console.log()</code> s&#8217;affiche&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node util/debuglog.js
Cet ordinateur a 4 CPU.</pre>
</div>
</div>
<div class="paragraph">
<p>Il nous faut alors utiliser la <a href="#process.env">variable d&#8217;environnement</a> <code>NODE_DEBUG</code>.
En lui attribuant la m√™me valeur que notre d√©bogueur, celui-ci affichera alors
le contenu attendu&#160;:


</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>NODE_DEBUG=nodebook node util/debuglog.js
Cet ordinateur a 4 CPU.
NODEBOOK 32486: Le mod√®le de CPU est Intel(R) Core(TM) i5-6267U CPU @ 2.90GHz.</pre>
</div>
</div>
<div class="paragraph">
<p>Si l&#8217;on souhaite avoir plusieurs d√©bogueurs, dans un ou plusieurs script(s),
il suffit de s√©parer leurs noms par des virgules
(ex: <code>NODE_DEBUG=nodebook,test,fromage</code>).</p>
</div>
<div class="paragraph">
<p>Une de mes fonctions pr√©f√©r√©es est <code>util.promisify()</code>.
Elle convertit une fonction acceptant un <a href="#callback">callback</a> en une fonction
retournant une <a href="../chapter-03/index.html#promise">promesse</a>.
C&#8217;est particuli√®rement pratique quand on n&#8217;a pas la ma√Ætrise du
code source original.



</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">util/fs-readdir-promisified.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>promisify<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readdir <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readdir<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">readdir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span>                                  <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affecte une version transform√©e de <code>fs.readdir()</code> gr√¢ce √† <code>util.promisify()</code>.</p>
</li>
<li>
<p>On ne passe pas de <a href="#callbacks">fonction de rappel</a> contrairement √† <code>fs.readdir()</code>.</p>
</li>
<li>
<p>Le r√©sultat de l&#8217;op√©ration est pass√© √† la r√©solution de promesse.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cela ne para√Æt pas important mais cela ouvre un potentiel de simplification
√©norme pour nous.
Fini l&#8217;argument <code>error</code> qui nous emb√™te&#160;: on peut le collecter quand cela
nous arrange gr√¢ce √† <code>.catch()</code>.</p>
</div>
<div class="paragraph">
<p>Cela limite √©galement le nombre de lignes de code √† √©crire
pour arriver au m√™me r√©sultat&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">util/fs-readdir-promise.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">readdir</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      error <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">readdir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables</div>
<table>
<tr>
<td class="hdlist1">
<code>util.debuglog()</code>
</td>
<td class="hdlist2">
<p>Cr√©e une fonction de d√©bogage similaire √† <a href="#console"><code>console.error</code></a>.
Les messages ne s&#8217;afficheront que si la <a href="#process.env">variable d&#8217;environnement</a>
<code>NODE_DEBUG</code> mentionne l&#8217;identifiant du d√©bogueur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>util.deprecate()</code>
</td>
<td class="hdlist2">
<p>Affiche un message d&#8217;avertissement lorsque vous souhaitez retirer une fonction
partag√©e dans une version ult√©rieure de votre&#160;code.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>util.format()</code>
</td>
<td class="hdlist2">
<p>Retourne une cha√Æne de caract√®res format√©e, comme <a href="#console"><code>console.log</code></a>
mais sans l&#8217;envoyer dans un <a href="#process.std">flux de sortie</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>util.promisify()</code>
</td>
<td class="hdlist2">
<p>Transforme une <a href="#callbacks">fonction de rappel</a> en
<a href="../chapter-03/index.html#promise">promesse</a>.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module util</div>
<div class="paragraph">
<p>La documentation du module <code>util</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/util.html" class="bare">nodejs.org/docs/latest-v10.x/api/util.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="http">2.7. http : cr√©er et interroger des ressources via le protocole&#160;HTTP</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Le module <code>http</code> est un incontournable de Node.
Il a deux facettes&#160;: la cr√©ation de requ√™tes et celle de serveurs.
Dans le premier cas, on utilise le protocole HTTP pour acc√©der √† une ressource distante
et recevoir une r√©ponse.
Dans le second, on utilise le protocole HTTP pour
<strong>mettre √† disposition des ressources</strong> et les envoyer en r√©ponse.</p>
</div>
<div class="paragraph">
<p>Le module <code>https</code> offre exactement les m√™mes propri√©t√©s.
Il est √† privil√©gier pour √©tablir des connexions s√©curis√©es
vers des adresses commen√ßant par&#160;<code>https://</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">http/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://oncletom.io/node.js/package.json'</span><span class="token punctuation">;</span>

<span class="token keyword">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                        <span class="token comment">// <b class="conum">(1)</b></span>
  response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initialisation de la requ√™te&#160;‚Äì un objet repr√©sentant la <a href="#http.IncomingMessage">r√©ponse du serveur distant</a> nous est transmis. √Ä ce stade-l√†, le serveur n&#8217;a pas encore commenc√© √† renvoyer des donn√©es.</p>
</li>
<li>
<p>On en est √† l&#8217;√©tape o√π on re√ßoit des donn√©es. Le contenu du fichier <code>package.json</code> est affich√© sous forme de cha√Ænes de caract√®res.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce premier exemple met en lumi√®re <strong>la nature asynchrone et non-bloquante par d√©faut de Node</strong>.
La cr√©ation d&#8217;une requ√™te et l&#8217;obtention de la r√©ponse sont s√©par√©es d&#8217;un d√©lai
variable, pendant lequel Node ne bloque pas le reste du code.
Les <a href="#callbacks">fonctions de rappel</a> sont appel√©es lorsque l&#8217;action est termin√©e.
</p>
</div>
<div class="paragraph">
<p>En regardant le code de l&#8217;exemple pr√©c√©dent, on en apprend un peu plus sur
le fonctionnement d&#8217;une requ√™te&#160;HTTP&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Envoi de la requ√™te au serveur distant&#160;: <code>get()</code>.</p>
</li>
<li>
<p>Obtention d&#8217;une r√©ponse&#160;: objet <code>response</code> dans la fonction de rappel.</p>
</li>
<li>
<p>Transmission d&#8217;informations&#160;: √©v√©nement <code>data</code>.</p>
</li>
<li>
<p>Cl√¥ture de la transmission&#160;: √©v√©nement <code>end</code>&#160;‚Äì voir exemple suivant.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour rester rapide, Node fait aussi le choix de transmettre les donn√©es
au fur et √† mesure.
L'<a href="#events">√©v√©nement</a> <code>data</code> renvoie en r√©alit√© environ 10&#160;Ko de donn√©es.
L&#8217;exemple pr√©c√©dent a tout renvoy√© d&#8217;un coup car le volume des donn√©es
√©tait inf√©rieur √† 10&#160;Ko.
</p>
</div>
<div class="paragraph">
<p>Voyons maintenant ce qui se passe lorsqu&#8217;on fait appel √† un fichier
plus volumineux&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">http/get.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'https://oncletom.io/node.js/index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ko <span class="token operator">=</span> data<span class="token punctuation">.</span>length<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Morceau #%d : %iKo'</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> ko<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                      <span class="token comment">// <b class="conum">(2)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Fini (%d morceaux)'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche ce message √† chaque morceau/paquet re√ßu.</p>
</li>
<li>
<p>L&#8217;√©v√©nement <code>end</code> se d√©clenche lorsque la requ√™te n&#8217;a plus de donn√©es √† recevoir.</p>
</li>
<li>
<p>Affiche le nombre de morceaux re√ßus pour obtenir une r√©ponse compl√®te.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Param√®tre&#160;URL</div>
<div class="paragraph">
<p>

Les fonctions <code>http.get()</code> et <code>http.request()</code> acceptent une cha√Æne de caract√®res
comme premier argument.</p>
</div>
<div class="paragraph">
<p>Il est aussi possible de leur passer un <a href="#url">objet&#160;URL</a>.
C&#8217;est plus pratique si vous manipulez des URL complexes ou si vous paginez.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En clair, on peut recevoir une r√©ponse en plusieurs fois, petit bout par petit bout.
Les donn√©es re√ßues ne sont pas forc√©ment compl√®tes.
Cela pose probl√®me √† des fonctions comme
<a href="../chapter-03/index.html#json"><code>JSON.parse()</code></a>, qui n√©cessitent un document
JSON complet pour produire un r√©sultat.
</p>
</div>
<div class="paragraph">
<p>Une solution consiste √† accumuler les morceaux de r√©ponse et √† les assembler.
Cela veut aussi dire que l&#8217;on consomme autant de m√©moire que l&#8217;on re√ßoit de donn√©es.</p>
</div>
<div class="paragraph">
<p>Une autre solution repose sur l&#8217;utilisation des <a href="#stream">flux de donn√©es</a>.
Ils pompent et brassent les donn√©es comme du liquide, en consommant peu de m√©moire.
On en parle plus loin, dans la section sur le <a href="#stream">module <code>stream</code></a>.

</p>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables</div>
<table>
<tr>
<td class="hdlist1">
<code>http.createServer()</code>
</td>
<td class="hdlist2">
<p>Initialise un serveur HTTP et fournit une bo√Æte √† outils pour
g√©rer les connexions entrantes via <a href="#http.Server"><code>http.Server</code></a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>http.get()</code>
</td>
<td class="hdlist2">
<p>Cr√©e une connexion HTTP de type&#160;<code>GET</code>.
Il s&#8217;agit d&#8217;une version simplifi√©e de <code>http.request()</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>http.request()</code>
</td>
<td class="hdlist2">
<p>Cr√©e une connexion HTTP du type de son choix&#160;: <code>GET</code>, <code>POST</code>, <code>OPTION</code>, <code>PUT</code>,
etc.</p>
</td>
</tr>
</table>
</div>
<div id="http.request" class="paragraph">
<p>La fonction <code>http.request()</code> g√®re une requ√™te plus finement.
On peut ais√©ment r√©gler les en-t√™tes, le verbe HTTP et les modalit√©s de
transmission des donn√©es.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre l&#8217;envoi d&#8217;une requ√™te <code>HEAD</code>.
Ce verbe HTTP indique au serveur distant de r√©pondre avec les m√©tadonn√©es
de la ressource, mais sans les donn√©es (<code>response.on('data')</code>)&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">http/request.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>                                 <span class="token comment">// <b class="conum">(1)</b></span>
  protocol<span class="token punctuation">:</span> <span class="token string">'https:'</span><span class="token punctuation">,</span>
  host<span class="token punctuation">:</span> <span class="token string">'oncletom.io'</span><span class="token punctuation">,</span>
  path<span class="token punctuation">:</span> <span class="token string">'/node.js/package.json'</span><span class="token punctuation">,</span>
  method<span class="token punctuation">:</span> <span class="token string">'HEAD'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> request <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Accept'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>
request<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">// <b class="conum">(3)</b></span>

request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lastModified <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'last-modified'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Modifi√© le %s'</span><span class="token punctuation">,</span> lastModified<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(4)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Construction des param√®tres de requ√™te pour <code>http.request()</code>.</p>
</li>
<li>
<p>Explicite au serveur distant la nature du contenu que l&#8217;on s&#8217;appr√™te √† recevoir.</p>
</li>
<li>
<p>D√©clenche l&#8217;envoi de la requ√™te sur le r√©seau.</p>
</li>
<li>
<p>Affiche la date de modification de la ressource distante.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Avanc√©</span> Parser, destructurer, combiner</div>
<div class="paragraph">
<p>La fonction <code>url.parse()</code> du <a href="#url">module&#160;<code>url</code></a> est une alternative √† la
construction manuelle de l&#8217;URL.
Les op√©rateurs de <a href="../chapter-03/index.html#object">manipulation d&#8217;objets</a>
comme le <em>destructuring</em> et l&#8217;expansion (<em>rest</em>) favorisent
une √©criture concise et √©l√©gante.
</p>
</div>
<div class="listingblock">
<div class="title">http/request-advanced.js</div>
<div class="content">
<pre>const https = require('https');
const {parse} = require('url');
const url = parse('https://oncletom.io/node.js/package.json');

const request = https.request({ ...url, method: 'HEAD'});</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <code>http.get()</code> et <code>http.request()</code> est simple tant qu&#8217;on √©vite
la personnalisation de la requ√™te.
On ajoute progressivement de plus en plus de travail pour bien envoyer une
requ√™te, collecter les donn√©es et g√©rer les erreurs.</p>
</div>
<div class="paragraph">
<p>Nous verrons comment arriver au m√™me r√©sultat en √©crivant moins de code gr√¢ce aux
<a href="../chapter-05/index.html#modules">modules&#160;<code>npm</code></a>
(<a href="../chapter-05/index.html">chapitre&#160;5</a>).
</p>
</div>
<div id="http.ClientRequest" class="hdlist">
<div class="title">Propri√©t√©s notables de <code>http.ClientRequest</code></div>
<table>
<tr>
<td class="hdlist1">
<code>request.on('response')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsque la ressource distante a accept√© la requ√™te et s&#8217;appr√™te
√† nous transmettre les donn√©es.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.on('end')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsque la ressource distante a signal√© ne plus avoir de donn√©es
√† nous transmettre.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.end()</code>
</td>
<td class="hdlist2">
<p>Termine l&#8217;initialisation et entame la connexion vers la ressource distante.
Dans le cas d&#8217;une requ√™te <code>POST</code>, <code>PUT</code> ou <code>DELETE</code>, le premier param√®tre
sert √† passer une donn√©e au serveur distant.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.getHeader()</code>
</td>
<td class="hdlist2">
<p>Retourne la valeur d&#8217;un en-t√™te de requ√™te.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.setHeader()</code>
</td>
<td class="hdlist2">
<p>Change la valeur d&#8217;un en-t√™te de requ√™te.
C&#8217;est une pratique courante pour pr√©ciser nos intentions aupr√®s du serveur
distant&#160;: format de fichier r√©ponse attendu (<code>Accept</code>), agent utilisateur
(<code>User-Agent</code>), nature des donn√©es envoy√©es (<code>Content-Type</code>), etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.setTimeout()</code>
</td>
<td class="hdlist2">
<p>D√©finit un chronom√®tre pour d√©clarer la requ√™te en erreur si aucune r√©ponse
n&#8217;a √©t√© obtenue dans ce d√©lai imparti.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.write()</code>
</td>
<td class="hdlist2">
<p>Transmet un morceau de contenu vers la ressource distante.
Cette m√©thode s&#8217;utilise lorsque l&#8217;on effectue un t√©l√©versement progressif.</p>
</td>
</tr>
</table>
</div>
<div id="http.IncomingMessage" class="hdlist">
<div class="title">Propri√©t√©s notables de <code>http.IncomingMessage</code></div>
<table>
<tr>
<td class="hdlist1">
<code>message.on('data')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche quand un morceau de donn√©es est obtenu par le client.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>message.on('end')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche quand nous avons obtenu toutes les donn√©es √©mises par le serveur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>message.on('readable')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche quand nous pouvons commencer √† lire les donn√©es.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>message.read()</code>
</td>
<td class="hdlist2">
<p>Obtient un morceau de donn√©es manuellement&#160;‚Äì au lieu d&#8217;utiliser
l&#8217;√©v√©nement <code>data</code>, automatique.
On apprendra √† mieux manipuler cette fonction dans la section sur le
<a href="#stream">module <code>stream</code></a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>message.destroy()</code>
</td>
<td class="hdlist2">
<p>Termine la transmission des donn√©es sans que le serveur distant
nous aie tout transmis.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>message.headers</code>
</td>
<td class="hdlist2">
<p>Objet contenant les en-t√™tes de la r√©ponse&#160;‚Äì le serveur distant d√©cide
de leur contenu.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>message.statusCode</code>
</td>
<td class="hdlist2">
<p>Code qui refl√®te l&#8217;√©tat de compr√©hension de notre requ√™te par le serveur distant.
<code>200</code>&#160;correspond √† <em>tout va bien</em>, <code>404</code>&#160;√† <em>ressource introuvable</em>,
<code>301</code>&#160;√† <em>la ressource a √©t√© d√©plac√©e</em>.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est temps de nous pencher sur l&#8217;autre versant du module&#160;: la cr√©ation
d&#8217;un serveur&#160;HTTP.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10 interactive--endpoint">
<div class="title">http/server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(1)</b></span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                      <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Serveur d√©marr√© !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>method<span class="token punctuation">,</span> url<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'URL demand√©e : %s %s'</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>

  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Coucou'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// <b class="conum">(4)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ouverture de l&#8217;acceptation des connexions r√©seau sur le port <code>4000</code>, uniquement sur la boucle locale (<code>localhost</code>)&#160;‚Äì une erreur sera affich√©e si ce port r√©seau est d√©j√† pris par un autre processus.</p>
</li>
<li>
<p>Affiche <code>Serveur d√©marr√©&#160;!</code> quand Node a fini de n√©gocier l&#8217;acc√®s aux ressources r√©seau avec le syst√®me d&#8217;exploitation&#160;‚Äì √† ce stade, le serveur est pr√™t √† recevoir des <em>connexions entrantes</em>.</p>
</li>
<li>
<p>Lorsqu&#8217;une requ√™te arrive, affiche l&#8217;URL demand√©e par le client.</p>
</li>
<li>
<p>Termine la connexion avec le client&#160;‚Äì ce dernier consid√®re sa requ√™te comme termin√©e.
</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Apart√©</span> Pourquoi d√©marrer un serveur&#160;HTTP ?</div>
<div class="paragraph">
<p>

Ce concept peut sembler √©trange lorsqu&#8217;on vient d&#8217;un autre langage de programmation.
Apr√®s tout, Apache ou nginx s&#8217;en chargent tr√®s bien pour nous.</p>
</div>
<div class="paragraph">
<p>Un serveur HTTP embarqu√© avec Node, c&#8217;est avant tout
<strong>une question d&#8217;autonomie et d&#8217;interop√©rabilit√©</strong>.
Il n&#8217;y a pas besoin de module sp√©cial pour Apache ni pour nginx.</p>
</div>
<div class="paragraph">
<p>On peut d√©velopper un site web et le faire fonctionner instantan√©ment sans
installer autre chose.
L&#8217;int√©gration avec un serveur Apache, nginx ou autre n√©cessite ensuite
tr√®s peu d&#8217;efforts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le serveur se d√©marre de la m√™me mani√®re qu&#8217;un script ordinaire&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node http/server.js
Serveur d√©marr√© !</pre>
</div>
</div>
<div class="paragraph">
<p>Le serveur continuera d&#8217;accepter les requ√™tes entrantes jusqu&#8217;√† ce que le
<a href="#process">processus</a> soit interrompu par une erreur ou par un
<a href="#signals">signal d&#8217;arr√™t</a>
‚Äì en utilisant la combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> par exemple.

</p>
</div>
<div class="paragraph">
<p>Acc√©dez au serveur HTTP en ouvrant un navigateur web comme Firefox ou Chrome
puis en inscrivant <code><a href="http://localhost:4000" class="bare">localhost:4000</a></code> dans la barre d&#8217;adresses.
Dirigez ensuite le navigateur vers <code><a href="http://localhost:4000/test" class="bare">localhost:4000/test</a></code> et observez les
changements.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Parler au serveur depuis le terminal</div>
<div class="paragraph">
<p>La commande Unix <code>curl</code> sait envoyer des requ√™tes HTTP.
On peut l&#8217;utiliser pour lire les r√©ponses de notre serveur&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>curl -i http://localhost:4000/test
<span data-bash-subs="$"></span>curl -i -XHEAD http://localhost:4000/test</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;option&#160;<code>-i</code> affiche les en-t√™tes de r√©ponse.
C&#8217;est l&#8217;√©quivalent de <code>response.headers</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On a pos√© les bases d&#8217;un serveur HTTP minimaliste sur lequel on pourra
construire pas √† pas tout type d&#8217;application web.
Que manque-t-il pour en faire un serveur web&#160;?
Il faut encore typer les ressources renvoy√©es afin qu&#8217;elles soient comprises
par un navigateur, c&#8217;est-√†-dire signaler que nos r√©ponses
contiennent du HTML, du CSS, des images, etc.</p>
</div>
<div class="paragraph">
<p>Modifions notre exemple pr√©c√©dent pour renvoyer du&#160;HTML&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10 interactive--endpoint">
<div class="title">http/web-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Salut √† toi&lt;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">üö®</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Important</span> La fonction <code>response.end()</code></div>
<div class="paragraph">
<p>L&#8217;appel de la fonction <code>response.end()</code> est imp√©ratif.
Sinon, le client&#160;‚Äì ici, le navigateur&#160;‚Äì pense que des donn√©es vont encore arriver.</p>
</div>
<div class="paragraph">
<p>Si on supprime l&#8217;appel √† <code>response.end()</code> dans l&#8217;exemple pr√©c√©dent,
l&#8217;indicateur de chargement du navigateur sera actif pendant deux minutes,
suite √† quoi Node interrompra la connexion, consid√©rant qu&#8217;elle met trop
de temps pour aboutir.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dirigeons notre navigateur vers <code><a href="http://localhost:4000" class="bare">localhost:4000</a></code> pour observer
le r√©sultat.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/web-server.png" alt="web server" width="65%">
</div>
<div class="title">Figure 5. Rendu navigateur de l&#8217;exemple <code>http/web-server.js</code></div>
</div>
<div class="paragraph">
<p>La balise HTML&#160;<code>&lt;h1&gt;</code> a bien √©t√© prise en compte, mais le
caract√®re&#160;<code>√†</code> n&#8217;a pas √©t√© compris par le navigateur, qui affiche <code>√É&#160;</code>.
</p>
</div>
<div class="paragraph">
<p>Si le serveur distant ne pr√©cise pas l&#8217;encodage des caract√®res,
le navigateur l&#8217;interpr√®te en <a href="#ascii">ASCII</a>.

Or, les √©diteurs de code enregistrent les fichiers avec un autre encodage&#160;: UTF-8.
Ce standard englobe les alphabets du monde entier, dont les accents et
signes diacritiques de la langue fran√ßaise.
</p>
</div>
<div id="ascii" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Histoire</span> American Standard Code for Information Interchange&#160;(ASCII)</div>
<div class="paragraph">
<p>Au d√©but de l&#8217;informatique contemporaire, les syst√®mes √©taient con√ßus
pour comprendre l&#8217;alphabet anglais, les signes de ponctuations et
des caract√®res sp√©ciaux.
On parle alors de standard d&#8217;encodage&#160;ASCII.</p>
</div>
<div class="paragraph">
<p>L&#8217;√©mergence d&#8217;Internet et du World&#160;Wide&#160;Web ont popularis√© l&#8217;encodage UTF-8
afin d&#8217;exprimer de mani√®re commune les caract√®res sp√©ciaux de toutes les
langues du monde entier.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour indiquer aux navigateurs web quel est l&#8217;encodage utilis√©,
le protocole HTTP dispose de l&#8217;en-t√™te <code>Content-Type</code>&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">http/web-server-ok.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content_type <span class="token operator">=</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> content_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Salut √† toi&lt;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>L&#8217;en-t√™te HTTP <code>Content-Type</code> indique explicitement que le contenu transf√©r√© est du HTML, encod√© en&#160;UTF-8.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette indication suffit au navigateur pour d√©coder les caract√®res
et les afficher comme on l&#8217;esp√©rait.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/web-server-ok.png" alt="web server ok" width="65%">
</div>
<div class="title">Figure 6. Rendu navigateur de l&#8217;exemple <code>http/web-server-ok.js</code></div>
</div>
<div class="paragraph">
<p>L&#8217;√©tape suivante consisterait √† transmettre deux contenus diff√©rents selon
l&#8217;URL demand√©e, par exemple, une page HTML et un fichier CSS pour l&#8217;habiller.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10 interactive--endpoint">
<div class="title">http/web-server-routes.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/main.css'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'body{ font-size: 18px; color: blue; }'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> content_type <span class="token operator">=</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">;</span>

    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> content_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;link rel="stylesheet" href="/main.css">'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Salut √† toi&lt;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Si la requ√™te entrante indique <code>/main.css</code> comme chemin, alors on lui renvoie du contenu interpr√©table comme du&#160;CSS.</p>
</li>
<li>
<p>On indique au client que ce contenu est du texte contenant une feuille de styles&#160;CSS.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si tout se passe bien, le chargement de la page HTML devrait d√©clencher
une requ√™te vers <code><a href="http://localhost:4000/main.css" class="bare">localhost:4000/main.css</a></code>.
Nous en avons la confirmation visuelle en visitant le serveur gr√¢ce √† un
navigateur&#160;web&#160;:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/web-server-routes.png" alt="web server routes" width="65%">
</div>
<div class="title">Figure 7. Rendu navigateur de l&#8217;exemple <code>http/web-server-routes.js</code></div>
</div>
<div class="paragraph">
<p>On est en situation de contr√¥le&#160;: on d√©cide de ce qu&#8217;on r√©pond.
C&#8217;est une mani√®re d&#8217;apprendre petit √† petit comment fonctionne
le protocole HTTP sur lequel repose une majorit√© de notre activit√© sur Internet.</p>
</div>
<div class="paragraph">
<p>On a couvert les principes du module&#160;<code>http</code>, mais il reste beaucoup de choses
√† apprendre pour d√©velopper une application web maintenable.
Ce sera le sujet du <a href="#../chapter-07/index.adoc">chapitre&#160;7</a>,
aid√© par les <a href="../chapter-05/index.html#modules">modules&#160;<code>npm</code></a> que l&#8217;on apprendra
√† manipuler dans le <a href="../chapter-05/index.html">chapitre&#160;5</a>.</p>
</div>
<div id="http.Server" class="hdlist">
<div class="title">Propri√©t√©s notables de <code>http.Server</code> et de <code>https.Server</code></div>
<table>
<tr>
<td class="hdlist1">
<code>server.close()</code>
</td>
<td class="hdlist2">
<p>Arr√™te l&#8217;√©coute de nouvelles connexions.
Les connexions existantes sont maintenues jusqu&#8217;√† ce qu&#8217;elles soient honor√©es.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.listen()</code>
</td>
<td class="hdlist2">
<p>D√©marre l&#8217;acceptation des connexions sur un port et une adresse donn√©s.
Combin√©e avec <a href="#os"><code>os.networkInterfaces()</code></a>, vous pourriez choisir
sur quelle carte/adresse r√©seau √©couter les requ√™tes entrantes.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.on('close')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsque le serveur s&#8217;arr√™te et a termin√© d&#8217;honorer toutes les
connexions d√©j√† ouvertes.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.on('connection')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsqu&#8217;une nouvelle connexion r√©seau est √©tablie.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.on('request')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsqu&#8217;une nouvelle requ√™te entrante est adress√©e au serveur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.on('upgrade')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsqu&#8217;une requ√™te entrante demande un changement de protocole.
Utilis√©e pour basculer vers HTTP/2 et
<a href="../chapter-09/index.html#io-websocket">WebSocket</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.on('close')</code>
</td>
<td class="hdlist2">
<p>Se d√©lenche lorsque la requ√™te a √©t√© termin√©e par le client,
avant qu&#8217;on ait pu transmettre l&#8217;int√©gralit√© des donn√©es.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.on('finish')</code>
</td>
<td class="hdlist2">
<p>Se d√©lenche apr√®s l&#8217;envoi du dernier morceau de donn√©es.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.end()</code>
</td>
<td class="hdlist2">
<p>Signale au client que nous n&#8217;avons plus de donn√©es √† transmettre.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.getHeader()</code>
</td>
<td class="hdlist2">
<p>Retourne la valeur d&#8217;un en-t√™te de la r√©ponse.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.removeHeader()</code>
</td>
<td class="hdlist2">
<p>Supprime un en-t√™te de la r√©ponse.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.setHeader()</code>
</td>
<td class="hdlist2">
<p>Affecte une valeur √† un en-t√™te de la r√©ponse.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.write()</code>
</td>
<td class="hdlist2">
<p>Transmet un morceau de donn√©es au client.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.writeHead()</code>
</td>
<td class="hdlist2">
<p>Transmet le code de r√©ponse et un ensemble d&#8217;en-t√™tes au client.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>response.statusCode</code>
</td>
<td class="hdlist2">
<p>  Contient le code de r√©ponse qui sera transmis au client.
</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module http</div>
<div class="paragraph">
<p>La documentation du module <code>http</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/http.html" class="bare">nodejs.org/docs/latest-v10.x/api/http.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="os">2.8. os : en savoir plus sur les capacit√©s de l&#8217;ordinateur</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le module&#160;<code>os</code> donne des informations sur l&#8217;environnement syst√®me dans lequel
le script est ex√©cut√©.
Cela permet par exemple de <strong>prendre des d√©cisions par rapport aux ressources disponibles</strong>
(m√©moire, CPU, r√©seau) et par rapport au syst√®me d&#8217;exploitation (Windows, Linux, macOS).</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">os/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">}</span> <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">userInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token string">`Salut </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, cet ordinateur a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cpus<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> CPU.`</span></span> <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche un message comme <code>Salut anonymous, cet ordinateur a 4&#160;CPU</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Node a pour vocation de nous abstraire du syst√®me d&#8217;exploitation
en faisant en sorte que notre code fonctionne partout de la m√™me fa√ßon.
Pourtant, des situations nous obligent √† prendre en compte certains crit√®res
pour d√©terminer un choix.</p>
</div>
<div class="paragraph">
<p>Par exemple, lister les applications install√©es sur l&#8217;ordinateur d√©pend
du syst√®me&#160;; leur emplacement d&#8217;installation est diff√©rent sous Linux, Windows
et macOS.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">os/apps.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>type<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>readdir<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> modules</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> error
    <span class="token operator">?</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'Windows_NT'</span><span class="token punctuation">:</span> <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'C:\\Program Files'</span><span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'Linux'</span><span class="token punctuation">:</span>      <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'/usr/bin'</span><span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'Darwin'</span><span class="token punctuation">:</span>     <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'/Applications'</span><span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;exemple pr√©c√©dent se base sur la valeur retourn√©e par la fonction <code>os.type()</code>
afin de choisir le r√©pertoire √† lister.</p>
</div>
<div class="paragraph">
<p>On pourrait combiner ce m√©canisme avec le <a href="#child_process">module <code>child_process</code></a>,
pour appeler une application syst√®me diff√©rente et parvenir √† un r√©sultat similaire.</p>
</div>
<div class="paragraph">
<p>√Ä l&#8217;inverse, on peut <strong>acc√©der √† une ressource de mani√®re uniforme</strong>, peu importe
le nom du compte utilisateur ou du type de syst√®me d&#8217;exploitation.
Nous allons maintenant lire le contenu du fichier <code>.npmrc</code>,
le fichier de configuration de
l'<a href="../chapter-05/index.html#cli">ex√©cutable&#160;npm</a>&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">os/npmrc.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>homedir<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token function">homedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.npmrc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">readFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> error<span class="token punctuation">.</span>code <span class="token operator">!==</span> <span class="token string">'ENOENT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Construit un chemin sans connaissance pr√©alable du syst√®me d&#8217;exploitation sur lequel tournera le script&#160;: par exemple <code>C:\Users\anonymous\.npmrc</code> pour Windows, <code>/Users/anonymous/.npmrc</code> pour macOS et <code>/home/anonymous/.npmrc</code> pour Linux.</p>
</li>
<li>
<p><code>ENOENT</code> est un <a href="#fs.errors">code d&#8217;erreur</a> indiquant que le fichier n&#8217;existe pas&#160;; on se permet de l&#8217;ignorer et de consid√©rer que le fichier est vide.
</p>
</li>
</ol>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables</div>
<table>
<tr>
<td class="hdlist1">
<code>os.arch()</code>
</td>
<td class="hdlist2">
<p>Retourne l&#8217;architecture CPU.
Les valeurs les plus courantes sont g√©n√©ralement <code>x64</code>, <code>arm</code> et&#160;<code>arm64</code>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.cpus()</code>
</td>
<td class="hdlist2">
<p>Retourne un tableau contenant des informations √† propos de la ou des CPU.
Entre autres, on retrouve leur mod√®le, leur fr√©quence et
le temps pass√© en attente ou en action depuis le d√©marrage de l&#8217;ordinateur.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.homedir()</code>
</td>
<td class="hdlist2">
<p>Retourne le chemin vers le r√©pertoire utilisateur.
√âquivalent de la variable <code>$HOME</code> sous Unix et <code>%USERPROFILE%</code> ou <code>%AppData%</code>
sous Windows.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.hostname()</code>
</td>
<td class="hdlist2">
<p>Retourne l&#8217;identifiant r√©seau de la machine.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.networkInterfaces()</code>
</td>
<td class="hdlist2">
<p>Retourne un tableau contenant des informations √† propos de la ou des
carte(s) r√©seau de l&#8217;ordinateur.
Entre autres, on retrouve l&#8217;adresse&#160;IP (IPv4, IPv6), l&#8217;adresse MAC
et le masque r√©seau.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.platform()</code>
</td>
<td class="hdlist2">
<p>Retourne la nature du syst√®me d&#8217;exploitation.
Les valeurs les plus courantes sont g√©n√©ralement <code>win32</code>, <code>linux</code>, <code>darwin</code>
et <code>freebsd</code>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.tmpdir()</code>
</td>
<td class="hdlist2">
<p>Retourne l&#8217;emplacement du r√©pertoire temporaire fourni par
le syst√®me d&#8217;exploitation.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.type()</code>
</td>
<td class="hdlist2">
<p>Retourne une forme normalis√©e de la nature du syst√®me d&#8217;exploitation,
√©quivalent √† ce que retournerait la commande Unix <code>uname -s</code>.
Les valeurs les plus courantes sont g√©n√©ralement
<code>Windows_NT</code>, <code>Linux</code>, <code>Darwin</code> et <code>FreeBSD</code>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>os.constants</code>
</td>
<td class="hdlist2">
<p>Objet contenant la liste des <a href="#signals">signaux syst√®me</a> et des codes d&#8217;erreur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>os.EOL</code>
</td>
<td class="hdlist2">
<p>Caract√®re utilis√© pour marquer les fins de ligne.
En g√©n√©ral le caract√®re&#160;<code>\n</code> sous Unix et <code>\r\n</code> sous Windows.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module os</div>
<div class="paragraph">
<p>La documentation du module&#160;<code>os</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/os.html" class="bare">nodejs.org/docs/latest-v10.x/api/os.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="child_process">2.9. child_process : appeler un ex√©cutable syst√®me</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le module <code>child_process</code> ex√©cute des programmes externes,
leur transmet des donn√©es et consulte leurs r√©sultats via
les <a href="#process.std">flux standards</a>.



</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>exec<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'npm --version'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`npm version </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stdout<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ex√©cute la commande ex√©cute la fonction de rappel, avec comme arguments la <a href="#process.std">sortie standard</a> et la <a href="#process.std">sortie erreur</a> du processus enfant.</p>
</li>
<li>
<p>Affiche <code>npm version 6.4.0</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;utilisation du module <code>child_process</code> se justifie quand un programme
externe fournit une fonctionnalit√© mais ne s&#8217;interface pas avec Node,
ou encore quand on veut sortir l&#8217;ex√©cution d&#8217;un script Node du processus courant
pour tirer parti des autres CPU de l&#8217;ordinateur sans ralentir l&#8217;application principale.</p>
</div>
<div class="paragraph">
<p>La fonction <code>child_process.exec()</code> accepte un deuxi√®me argument optionnel.
<code>cwd</code> (<em>current working directory</em>) en est une des options utiles.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/ls.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>exec<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'ls .'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>cwd<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On lance la commande syst√®me&#160;<code>ls</code> sans sp√©cifier le r√©pertoire de travail.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ex√©cutons le script pour observer le r√©sultat&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node child_process/ls.js</pre>
</div>
</div>
<div class="paragraph">
<p>Le constat est similaire √† celui produit avec le <a href="#fs">module&#160;<code>fs</code></a>&#160;:
les fichiers list√©s sont ceux du <em>r√©pertoire courant</em>,
notre emplacement dans le terminal.</p>
</div>
<div class="paragraph">
<p>Modifions maintenant la valeur de l&#8217;option&#160;<code>cwd</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/ls-root.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>exec<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'ls .'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>cwd<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La valeur de&#160;<code>cwd</code> est r√©gl√©e sur&#160;<code>/</code>, c&#8217;est-√†-dire le r√©pertoire racine du syst√®me de fichiers.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node child_process/ls-root.js</pre>
</div>
</div>
<div class="paragraph">
<p>La liste des fichiers et r√©pertoires affich√©s est d√©sormais diff√©rente,
m√™me si la commande pass√©e √† <code>child_process.exec()</code> est la m√™me.
<code>cwd</code>&#160;a chang√© le r√©pertoire courant l&#8217;espace d&#8217;une commande.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performance</span> ls&#160;vs. fs.readdir</div>
<div class="paragraph">
<p>

Si on arrive au m√™me r√©sultat avec <code>exec('ls')</code>, pourquoi utiliser
la fonction <code>fs.readdir()</code> du <a href="#fs">module&#160;<code>fs</code></a>&#160;?
Cette derni√®re pr√©sente au moins trois avantages&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Elle est plus rapide&#160;‚Äì √† √©crire, √† ex√©cuter, √† diagnostiquer.</p>
</li>
<li>
<p>On √©conomise la cr√©ation d&#8217;un processus syst√®me.</p>
</li>
<li>
<p>Elle est compatible avec tous les syst√®mes d&#8217;exploitation.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>env</code>&#160;est une deuxi√®me option √† passer √† <code>child_process.exec()</code>.
Elle red√©finit les <a href="#process.env">variables d&#8217;environnement</a> utilisables
par le processus enfant&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">child_process/ping.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>exec<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token constant">PING_COUNT</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>process<span class="token punctuation">.</span>env<span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token string">'ping -c $PING_COUNT oncletom.io'</span><span class="token punctuation">;</span>

<span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">{</span>env<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>           <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">return</span> error
    <span class="token operator">?</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On transmet les variables d&#8217;environnement existantes au processus enfant.</p>
</li>
<li>
<p>Utilisation de la variable d&#8217;environnement <code>PING_COUNT</code> comme valeur d&#8217;option du programme&#160;<code>ping</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si on ne transmettait pas les valeurs de <code>process.env</code> au processus enfant,
la variable d&#8217;environnement <code>PATH</code> ne serait pas d√©finie.

Le processus enfant ne saurait plus o√π chercher l&#8217;ex√©cutable&#160;<code>ping</code>.<br>
On aurait pu appeler le programme <code>ping</code> en utilisant un chemin absolu comme
<code>/sbin/ping</code> mais son emplacement varie selon les syst√®mes d&#8217;exploitation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node child_process/ping.js
PING oncletom.io (185.31.40.11): 56 data bytes
64 bytes from 185.31.40.11: icmp_seq=0 ttl=56 time=23.763 ms

--- oncletom.io ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 23.763/23.763/23.763/0.000 ms</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">üö®</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Compatibilit√©</span> Mon programme ne fonctionne pas sous Windows/Linux/macOS</div>
<div class="paragraph">
<p>Le programme externe peut ne pas exister sur tous les syst√®mes d&#8217;exploitation,
ou ne pas s&#8217;appeler avec les m√™mes arguments, ni avec le m√™me&#160;nom.</p>
</div>
<div class="paragraph">
<p>Une des solutions consiste √† se reposer sur le <a href="#os">module&#160;<code>os</code></a>
et adapter la commande en fonction du syst√®me d&#8217;exploitation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>child_process.spawn()</code> est une autre approche de d√©marrage
et de communication avec un processus externe.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/spawn.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>spawn<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> subprocess <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'package.json'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

subprocess<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>            <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>cat</code>&#160;est un programme qui affiche le contenu d&#8217;un fichier&#160;‚Äì un peu comme <code>fs.readFile</code>.</p>
</li>
<li>
<p>Les donn√©es retourn√©es par la commande externe se lisent depuis les <a href="#process.std">flux de sortie</a>.</p>
</li>
<li>
<p>Affiche le contenu du fichier <code>package.json</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les arguments et options √† transmettre au programme sont pass√©s dans un tableau.
Dans le programme externe, on y acc√®de avec <a href="#process.argv"><code>process.argv</code></a>.
</p>
</div>
<div class="paragraph">
<p>Pour transmettre un volume de donn√©es plus important en param√®tre,
il vaut mieux faire appel √† la propri√©t√© <code>stdin</code>.
C&#8217;est un <a href="#stream">flux d&#8217;√©criture</a> dont le fonctionnement est identique
√† <a href="#process.std"><code>process.stdin</code></a>.

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/spawn-stdin.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>spawn<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> subprocess <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'tr'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'0-9a-f'</span><span class="token punctuation">,</span> <span class="token string">'a-p'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
subprocess<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

subprocess<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'0123 abcd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(1)</b></span>
subprocess<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>√âcrit <code>0123 abcd</code> dans le flux d&#8217;entr√©e.</p>
</li>
<li>
<p>Signale au processus externe qu&#8217;il n&#8217;aura plus de donn√©e&#160;‚Äì le programme&#160;<code>tr</code> rendra la main d√®s qu&#8217;il nous aura tout transmis.</p>
</li>
<li>
<p>Affiche <code>abcd klmn</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;ex√©cutable <code>tr</code> (<span class="URL"><a href="https://fr.wikipedia.org/wiki/Tr_(Unix" class="bare">fr.wikipedia.org/wiki/Tr_(Unix</a>)</span>)
remplace des plages de caract√®res.
On lui a transmis des caract√®res en entr√©e et sp√©cifi√© les plages de traduction
en arguments.
Nous avons utilis√© la <a href="#process.std">sortie standard</a> pour lire les r√©sultats.

</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple pr√©c√©dent revient au m√™me que la commande suivante&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>echo -n '0123 abcd' | tr 0-9a-f a-p
abcd klmn</pre>
</div>
</div>
<div class="paragraph">
<p>Dans ce cas pr√©cis, je trouve que l&#8217;instruction en ligne de commande est plus
concise que l&#8217;utilisation d&#8217;un script Node faisant appel √† <code>child_process.spawn()</code>.
J&#8217;aurais plut√¥t tendance √† transmettre le r√©sultat de cette commande
√† l'<a href="#process.std">entr√©e standard</a> d&#8217;un script Node.</p>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables du module child_process</div>
<table>
<tr>
<td class="hdlist1">
<code>child_process.exec()</code>
</td>
<td class="hdlist2">
<p>Ex√©cute une commande et retourne son r√©sultat.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>child_process.spawn()</code>
</td>
<td class="hdlist2">
<p>Ex√©cute une commande et retourne un objet <a href="#process">processus</a>.
Le script Node et le nouveau processus peuvent communiquer entre eux.
</p>
</td>
</tr>
</table>
</div>
<div class="hdlist">
<div class="title">Propri√©t√©s notables de la classe <code>ChildProcess</code></div>
<table>
<tr>
<td class="hdlist1">
<code>process.on('message')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsque le processus enfant re√ßoit un message envoy√© par l&#8217;autre script.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>process.kill()</code>
</td>
<td class="hdlist2">
<p>Envoie un <a href="#signals">signal d&#8217;arr√™t</a> au processus enfant.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>process.send()</code>
</td>
<td class="hdlist2">
<p>Envoie un message au processus enfant.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>process.stdin</code>
<br>
<code>process.stdout</code>
<br>
<code>process.stderr</code>
</td>
<td class="hdlist2">
<p><a href="#process.std">Flux standards</a> du processus enfant.
Id√©al pour envoyer et r√©cup√©rer des donn√©es en continu.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module child_process</div>
<div class="paragraph">
<p>La documentation du module <code>child_process</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/child_process.html" class="bare">nodejs.org/docs/latest-v10.x/api/child_process.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="process">2.10. process : en savoir plus sur le processus en cours</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>La module <code>process</code> retourne des informations
sur l&#8217;environnement dans lequel le script est ex√©cut√©.
√Ä l&#8217;instar de <a href="#console"><code>console</code></a>, la variable <code>process</code>
est globale.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">process/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> variables <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>variables<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche quelque chose comme <code>['LANG', 'SHELL', 'PATH', 'HOME', 'USER', ‚Ä¶]</code>&#160;‚Äì voir plus bas, les &#8220;<a href="#process.env">variables d&#8217;environnement</a>&#8221;.</p>
</li>
<li>
<p>Affiche <code>[ '&#8230;&#8203;/v10.9.0/bin/node', '&#8230;&#8203;/chapter-04/examples/process/intro.js' ]</code>&#160;‚Äì voir plus bas, les &#8220;&#160;<a href="#process.argv">arguments d&#8217;ex√©cution</a>&#8221;.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notre code peut √™tre interpr√©t√© par Node
sur plusieurs types de machines
(ordinateur r√©cent ou fatigu√©, Raspberry&#160;Pi, etc.) et sur diff√©rents
syst√®mes d&#8217;exploitation (Windows, Linux, macOS, etc.).
Nous avons avec le module <code>process</code> tout le loisir d&#8217;adapter nos scripts
√† ces diverses conditions.</p>
</div>
<div id="process.env" class="paragraph">
<p>Les variables d&#8217;environnement sont <strong>d√©finies au niveau du syst√®me d&#8217;exploitation</strong>.
Elles contiennent des informations comme le r√©pertoire courant, la langue du
syst√®me d&#8217;exploitation, l&#8217;utilisateur syst√®me courant, le type de terminal,
les emplacements d&#8217;installation des ex√©cutables, etc.


</p>
</div>
<div class="paragraph">
<p>On retrouve ces variables sous la forme d&#8217;un
<a href="../chapter-03/index.html#object">objet ECMAScript</a> nomm√© <code>process.env</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -p 'process.env'
{ ITERM_PROFILE: 'Default',
  LANG: 'en_GB.UTF-8',
  PWD: '/Users/oncletom/workspace/nodebook',
  SHELL: '/bin/zsh',
  TERM_PROGRAM_VERSION: '3.1.5',
  TERM_PROGRAM: 'iTerm.app',
  ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>En cr√©ant des variables d&#8217;environnement, nous sommes en mesure de
<strong>transmettre des informations contextuelles</strong> √† nos programmes&#160;:
des chemins d&#8217;acc√®s √† une base de donn√©es, si on est en situation de test
ou de production, l&#8217;emplacement de fichiers n√©cessaires au fonctionnement
de notre programme, etc.</p>
</div>
<div class="paragraph">
<p>Par exemple et par convention, la variable <code>NODE_ENV</code> est utilis√©e pour indiquer au programme
s&#8217;il est lanc√© dans le cadre du d√©veloppement, de l&#8217;ex√©cution des tests
ou s&#8217;il tourne sur le serveur de production.
</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Variable d&#8217;environnement √©ph√©m√®re</dt>
<dd>
<p>
La variable n&#8217;existe que pendant la dur√©e de vie du programme.
La d√©finition <code>CL√â=valeur</code> est plac√©e sur la m√™me ligne que le programme
en question.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>NODE_ENV=production node process/env.js
mode : production</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Variable d&#8217;environnement permanente</dt>
<dd>
<p>
La variable existe pendant la dur√©e de la session
gr√¢ce √† l&#8217;op√©rateur <code>export</code> sous Linux et macOS et
avec l&#8217;op√©rateur <code>set</code> sous Windows.<br>
La d√©finition <code>export CL√â=valeur</code> est plac√©e sur sa propre ligne.
Elle restera accessible par tout programme jusqu&#8217;√† la fin de la session
ou jusqu&#8217;√† ce qu&#8217;on efface la variable.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>export NODE_ENV=production
<span data-bash-subs="$"></span>node process/env.js
mode : production</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Revenir en arri√®re</span> Effacer une variable d&#8217;environnement</div>
<div class="paragraph">
<p>
L&#8217;op√©rateur <code>unset</code> dans un terminal efface le contenu
d&#8217;une variable d&#8217;environnement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>export NODE_ENV=dev
<span data-bash-subs="$"></span>echo $NODE_ENV
<span data-bash-subs="$"></span>unset NODE_ENV
<span data-bash-subs="$"></span>echo $NODE_ENV</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Voici le contenu du fichier <code>process/env.js</code> utilis√© dans les exemples pr√©c√©dents&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">process/env.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token constant">NODE_ENV</span><span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'dev'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'On est en mode d√©veloppement.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mode : %s'</span><span class="token punctuation">,</span> <span class="token constant">NODE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On notera que son comportement s&#8217;adapte √† la pr√©sence et √† la valeur
de la variable d&#8217;environnement <code>NODE_ENV</code>.
Elle est accessible dans Node en tant que <code>process.env.NODE_ENV</code>.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>NODE_ENV=dev node process/env.js
On est en mode d√©veloppement.
mode : dev</pre>
</div>
</div>
<div class="paragraph">
<p>Nous verrons d&#8217;autres mises en situation des variables d&#8217;environnement pour
<a href="../chapter-06/index.html#configuration">configurer une application</a>
dans le <a href="../chapter-06/index.html">chapitre&#160;6</a> et pour
<a href="../chapter-08/index.html#debug">d√©boguer une application en ligne de commande</a>
dans le <a href="../chapter-08/index.html">chapitre&#160;8</a>.</p>
</div>
<div id="process.argv" class="paragraph">
<p>Les arguments d&#8217;ex√©cution sont des morceaux d&#8217;information transmis
√† un script Node.
On les place √† droite du nom du fichier&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-first.js salut
"salut"</pre>
</div>
</div>
<div class="paragraph">
<p>On utilise les arguments pour affiner le comportement d&#8217;un programme.
Je pense par exemple au num√©ro du port sur lequel lancer un serveur web,
une liste de fichiers √† traiter ou
encore des fonctionnalit√©s √† activer ou √† d√©sactiver.</p>
</div>
<div class="paragraph">
<p>Il faut imaginer les arguments comme des param√®tres de fonction,
accessibles dans un programme Node dans
le <a href="../chapter-03/index.html#array">tableau</a> <code>process.argv</code>&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">print-first.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">,</span>first_arg<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first_arg<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les deux premiers √©l√©ments de <code>process.argv</code> sont rarement utilis√©s.
Ils correspondent respectivement √† l&#8217;emplacement de l&#8217;ex√©cutable Node
et √† l&#8217;emplacement du script.</p>
</div>
<div class="paragraph">
<p>Tous les autres arguments sont accessibles √† partir de l&#8217;index&#160;2 de
<code>process.argv</code>, dans l&#8217;ordre o√π ils sont plac√©s&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-first.js salut √ßa va ?
"salut"</pre>
</div>
</div>
<div class="paragraph">
<p>Le script <code>print-first.js</code> affiche le premier argument.
On en conclut que les arguments sont s√©par√©s par le caract√®re &#8220;espace&#8221;.</p>
</div>
<div class="paragraph">
<p>Dans le cas o√π un argument doit contenir un espace, on l&#8217;encadre alors
de guillemets&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-first.js "salut √ßa va ?" "oui et toi ?"
"salut √ßa va ?"</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;inconv√©nient des arguments est que leur ordre compte
et qu&#8217;il devient difficile de conna√Ætre leur r√¥le sans se r√©f√©rer
au manuel d&#8217;utilisation.</p>
</div>
<div class="paragraph">
<p>C&#8217;est l√† qu&#8217;interviennent les options.
Comme leur nom l&#8217;indique, ce sont des arguments optionnels.
Elles sont pr√©fix√©es de deux traits d&#8217;union (<code>--</code>).
On leur associe ou non une valeur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-text.js "salut √ßa va ?" --uppercase
SALUT √áA VA ?</pre>
</div>
</div>
<div class="paragraph">
<p>Quand on n&#8217;associe pas de valeur √† une option,
on consid√®re qu&#8217;elle √©quivaut √† un <a href="../chapter-03/index.html#boolean">bool√©en</a>
de valeur&#160;<code>true</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">print-text.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">,</span>text<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'--uppercase'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(1)</b></span>
  text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">toLocaleUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La condition est positive si l&#8217;on d√©tecte <code>--uppercase</code> dans la liste des arguments.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les options se combinent tr√®s bien avec les arguments.
Il faut les imaginer comme des interrupteurs.</p>
</div>
<div class="paragraph">
<p>Dans d&#8217;autres situations, on a besoin de passer une valeur √† une option&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-text-limit.js "salut √ßa va ?" --limit 2
salut √ßa</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exemple pr√©c√©dent illustre la c√©sure d&#8217;une phrase apr√®s deux&#160;mots
lorsque l&#8217;option <code>--limit</code> est associ√©e √† la valeur&#160;`2`.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">print-text-limit.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">,</span>text<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">;</span>

<span class="token keyword">const</span> limitIndex <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'--limit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>limitIndex <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> limitValue <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span>limitIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span>
  text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> limitValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On r√©cup√®re l&#8217;index de l&#8217;option <code>--limit</code> dans le tableau <code>process.argv</code>.</p>
</li>
<li>
<p>On r√©cup√®re la valeur de l&#8217;√©l√©ment suivant <code>--limit</code> dans <code>process.argv</code>.</p>
</li>
<li>
<p>La troncature est param√©tr√©e en fonction de la valeur associ√©e √† <code>--limit</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Au fond, <strong>les options sont des rep√®res pour les utilisateurs</strong> de nos programmes.
Elles leur permettent de s&#8217;interfacer avec leurs fonctionnalit√©s, un peu √† la
mani√®re des diff√©rents boutons qu&#8217;on retrouve
en fa√ßade d&#8217;une machine √† laver.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant est totalement fictif, mais il illustre comment
on s&#8217;interfacerait avec une machine √† laver en ligne de commande&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>machine-a-laver P-ECO 40 --fast --no-dry --room kitchen</pre>
</div>
</div>
<div class="paragraph">
<p>Ce qu&#8217;il faut en comprendre, c&#8217;est qu&#8217;on d√©marrerait la machine situ√©e
dans la cuisine avec un programme √©conomique <em>et</em> √†&#160;40¬∞C,
en activant l&#8217;option rapide et en d√©sactivant l&#8217;option s√©chage.</p>
</div>
<div class="paragraph">
<p>Nous verrons d&#8217;autres mises en situation pour
<a href="../chapter-08/index.html#argv">passer des param√®tres √† une application en ligne de commande</a>
dans le <a href="../chapter-08/index.html">chapitre&#160;8</a>.</p>
</div>
<div id="process.std" class="paragraph">
<p>Chaque processus syst√®me est dot√© de trois flux de donn√©es&#160;:
le flux d&#8217;entr√©e (<code>stdin</code>), le flux de sortie (<code>stdout</code>)
et le flux d&#8217;erreur (<code>stderr</code>).



</p>
</div>
<div class="paragraph">
<p>Les flux standards peuvent √™tre aliment√©s pendant la dur√©e de vie du processus
en utilisant peu de m√©moire.
On les utilisera pour passer le r√©sultat d&#8217;un autre programme
√† notre script Node, pour informer l&#8217;utilisateur de notre programme,
mais aussi pour consigner les erreurs.</p>
</div>
<div class="paragraph">
<p>Node expose ces flux standards via les variables <code>process.stdin</code> (entr√©e),
<code>process.stdout</code> (sortie) et <code>process.stderr</code> (erreur).
Chacune poss√®de des m√©thodes pour √©couter ce qui s&#8217;y passe,
pour y √©crire du contenu et pour <a href="#stream">rediriger leur&#160;flux</a>.</p>
</div>
<div class="paragraph">
<p>Commen√ßons par l&#8217;utilisation de <code>process.stdout</code> pour √©crire un message
dans notre terminal&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout.js
un deuxtrois
quatre</pre>
</div>
</div>
<div class="paragraph">
<p>Le code source de <code>process/stdout.js</code> fait appel √† la fonction
<code>process.stdout.write()</code> par deux fois.
On notera que le caract√®re&#160;<code>\n</code> symbolise un retour √† la ligne
(<code>\r\n</code> sous Windows)&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/stdout.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'un deux'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'trois\nquatre'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela rappelle nos pr√©c√©dentes utilisations de la fonction <code>console.log()</code>,
qui se repose en effet sur <code>process.stdout</code> (voir encadr√©).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Les fonctions <code>console.log</code> et <code>console.error</code></div>
<div class="paragraph">
<p>
La fonction d&#8217;affichage <code>console.log()</code> √©crit dans le flux de sortie
<code>process.stdout</code>.
Sans surprise, <code>console.error()</code> √©crit dans le flux d&#8217;erreur
<code>process.stderr</code>.
</p>
</div>
<div class="paragraph">
<p>Elles ajoutent un retour √† la ligne et des options de formatage pour
notre confort.</p>
</div>
<div class="paragraph">
<p>On en parle davantage dans la section sur le <a href="#console">module <code>console</code></a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les flux de sortie et d&#8217;erreur sont manipulables en continu,
√† l&#8217;aide d&#8217;utilitaires syst√®mes existants (<code>grep</code>, <code>awk</code>, etc.)
ou de programmes sp√©cifiques (analyse de <em>logs</em>).
On peut ainsi se concentrer sur un programme qui fait juste ce dont on a besoin.
On laisse le travail de sp√©cialisation √† d&#8217;autres programmes.</p>
</div>
<div class="paragraph">
<p>Filtrons la sortie de l&#8217;exemple pr√©c√©dent sans √©crire une ligne de code de plus.
Le programme <code>grep</code> (<span class="URL"><a href="https://fr.wikipedia.org/wiki/Grep" class="bare">fr.wikipedia.org/wiki/Grep</a></span>)
est fourni par d√©faut sur les syst√®mes Linux et macOS.
Il ne retourne que les lignes qui contiennent le motif
donn√© en <a href="#process.argv">argument</a>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout.js | grep 'tre'
qua<mark>tre</mark></pre>
</div>
</div>
<div class="paragraph">
<p>La sortie standard de <code>process/stdout.js</code> est devenue l&#8217;entr√©e standard
de <code>grep</code> gr√¢ce √† l&#8217;utilisation du <em>pipe</em>&#160;(<code>|</code>).
</p>
</div>
<div class="paragraph">
<p>C&#8217;est le moment id√©al pour regarder du c√¥t√© de l&#8217;entr√©e standard de Node.
Impl√©mentons quelque chose qui transforme un message&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>echo "un deuxtrois\nquatre" | node process/stdin-uppercase.js
UN DEUXTROIS
QUATRE</pre>
</div>
</div>
<div class="paragraph">
<p>On aurait aussi pu r√©utiliser la sortie de l&#8217;exemple <code>process/stdout.js</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout.js | node process/stdin-uppercase.js
UN DEUXTROIS
QUATRE</pre>
</div>
</div>
<div class="paragraph">
<p>Voyons comment cela fonctionne&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/stdin-uppercase.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>             <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(2)</b></span>

  process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">toLocaleUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Chaque afflux de donn√©es appelle notre fonction en lui fournissant un seul param√®tre contenant les donn√©es en question.</p>
</li>
<li>
<p>Le param√®tre est de <a href="#buffer">type Buffer</a>&#160;‚Äì on souhaite le transformer en <a href="../chapter-03/index.html#string">cha√Æne de caract√®res</a>.</p>
</li>
<li>
<p>La cha√Æne de caract√®res est transform√©e en majuscules et √©crite dans le flux de sortie.

</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Terminons avec la sortie erreur (<code>process.stderr</code>).

Elle fonctionne de mani√®re identique √† la sortie standard (<code>process.stdout</code>).
S&#8217;il n&#8217;y a visuellement aucune diff√©rence, la sortie erreur √©crit son contenu
dans un canal diff√©rent&#160;‚Äì un descripteur diff√©rent.
On l&#8217;utilise pour <strong>d√©boguer des programmes</strong>, pour <strong>lister des erreurs</strong> ou des
contenus que l&#8217;on souhaite dissocier de la sortie standard.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant affiche un nombre toutes les demi-secondes et l&#8217;√©tat
du compteur de nombres tous les cinq affichages&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout-long.js
7
24
3
19
25
Compteur = 5
22
...</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Rappel</span> Interrompre un programme avec&#160;<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span></div>
<div class="paragraph">
<p>Un programme peut √™tre interrompu √† tout moment en utilisant la combinaison
de touches&#160;<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/stdout-long.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">limit</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  counter<span class="token operator">++</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(1)</b></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span>counter <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// <b class="conum">(2)</b></span>
    process<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Compteur = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>counter<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>√âcrit un nombre entre&#160;0 et 30&#160;dans la sortie standard.</p>
</li>
<li>
<p>On v√©rifie si la valeur du compteur est divisible par&#160;5&#160;‚Äì c&#8217;est le cas si la division produit un entier au lieu d&#8217;un nombre √† virgule.</p>
</li>
<li>
<p>Affiche <code>Compteur = 5</code> puis <code>Compteur = 10</code> (et ainsi de suite) dans la sortie erreur.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On pourrait d√©cider de n&#8217;afficher que le flux d&#8217;erreur.
Utilisons l&#8217;op√©rateur&#160;<code>&gt;</code> pour <strong>rediriger la sortie standard vers un fichier</strong>&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout-long.js > stdout.txt
Compteur = 5
Compteur = 10
...</pre>
</div>
</div>
<div class="paragraph">
<p>En ouvrant le fichier <code>stdout.txt</code>, on voit
la liste de nombres g√©n√©r√©e par notre programme.</p>
</div>
<div class="paragraph">
<p>En ma√Ætrisant les flux standards, on est capable de <strong>cr√©er des programmes modulaires</strong>
qui consomment du contenu sans avoir √† conna√Ætre leur provenance.
<strong>Les donn√©es circulent</strong> depuis et vers des programmes externes,
des fichiers ou des sites web distants.</p>
</div>
<div class="paragraph">
<p>Pour mieux comprendre la logique de flux continu que l&#8217;on vient de d√©couvrir,
je vous invite √† lire la section li√©e au <a href="#stream">module <code>stream</code></a>.

On y d√©taillera la liste des √©v√©nements √† √©couter, ainsi que les diff√©rentes
m√©thodes d&#8217;√©criture, de pause et de lecture.</p>
</div>
<div id="process.on" class="paragraph">
<p>Un processus syst√®me re√ßoit et √©met des donn√©es, mais il peut aussi
<strong>√©couter des √©v√©nements</strong> gr√¢ce √† la fonction <code>process.on</code>.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/exit.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Le processus d√©marre'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Le processus termine avec le code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cet exemple illustre l&#8217;√©v√©nement <code>exit</code>, qui est d√©clench√© quand le processus se termine.
√Ä ce titre, un <strong>code de sortie</strong> est fourni pour signaler l&#8217;√©tat dans
lequel le programme se termine.
On parlera davantage du code de sortie et de sa signification
dans la section &#8220;<a href="#process.exit">Mettre fin au processus</a>&#8221;.
</p>
</div>
<div class="paragraph">
<p>Lan√ßons le script pr√©c√©dent&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/exit.js
Le processus d√©marre
Le processus termine avec le code 0</pre>
</div>
</div>
<div class="paragraph">
<p>Tout s&#8217;est pass√© correctement.
Le code de sortie est alors&#160;<code>0</code>.</p>
</div>
<div class="paragraph">
<p>Si le programme venait √† se terminer de mani√®re impr√©vue, le code serait diff√©rent.
L&#8217;exemple suivant provoque volontairement une erreur en faisant
r√©f√©rence √† une variable qui n&#8217;existe pas&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/exit-error.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Le processus termine avec le code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jenexistepas<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lan√ßons le script&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/exit-error.js
Le processus termine avec le code 1

<mark>ReferenceError</mark>: jenexistepas is not defined
    at Object.<anonymous> (/.../examples/process/<mark>exit-error.js</mark>:<mark>5</mark>:13)</pre>
</div>
</div>
<div class="paragraph">
<p>Cette fois-ci, le code de sortie est&#160;<code>1</code>.
Cela correspond √† une erreur qui n&#8217;a pas √©t√© captur√©e.
Le reste du message d√©crit pourquoi l&#8217;erreur s&#8217;est manifest√©e.</p>
</div>
<div class="paragraph">
<p>D&#8217;autres √©v√©nements li√©s au cycle de vie de nos applications sont disponibles&#160;:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 1. √âv√©nements li√©s au cycle de vie du processus Node</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">√âv√©nement</th>
<th class="tableblock halign-left valign-top">Param√®tres</th>
<th class="tableblock halign-left valign-top">Raison du d√©clenchement</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(exitCode)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Le programme se termine et va rendre la main au syst√®me d&#8217;exploitation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unhandledRejection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(reason, promise)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Une <a href="../chapter-03/index.html#promise">promesse</a> a √©chou√©
et n&#8217;a pas √©t√© captur√©e √† l&#8217;aide de la m√©thode <code>.catch()</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uncaughtException</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(error)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Une erreur s&#8217;est produite et n&#8217;a pas √©t√© captur√©e.
Si rien n&#8217;est fait, le processus va s&#8217;arr√™ter avec un code erreur.<br>
<strong>Note</strong> : il vaut mieux qu&#8217;un programme s&#8217;arr√™te en cas de probl√®me.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>message</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(message, sourceSocket)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Un <a href="#child_process">processus parent</a> nous envoie un message.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p></p>
</div>
<div id="signals" class="paragraph">
<p>La m√©thode <code>process.on</code> est √† l&#8217;√©coute des signaux syst√®me.
Par exemple, la combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> met en r√©alit√©
un signal d&#8217;interruption qui r√©pond √† l&#8217;identifiant <code>SIGINT</code>.</p>
</div>
<div class="paragraph">
<p>Node g√®re ces signaux pour nous, mais on peut aussi se mettre √† les √©couter
et d√©cider de faire autrement que son comportement par d√©faut.</p>
</div>
<div class="paragraph">
<p>Par exemple, affichons l&#8217;heure de l&#8217;arr√™t du processus avant de rendre la main&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/interrupt.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Processus d√©marr√©'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// <b class="conum">(1)</b></span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'SIGINT'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                  <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Processus termin√© (manuellement)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                            <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Processus termin√© (timeout)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Un premier message s&#8217;affiche au d√©marrage du script.</p>
</li>
<li>
<p>Cette <a href="../chapter-03/index.html#function">fonction</a> se d√©clenche lors de la r√©ception du <em>signal d&#8217;interruption</em> (<code>SIGINT</code>), lorsque le syst√®me d&#8217;exploitation lui relaie notre combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>.</p>
</li>
<li>
<p>La fonction <a href="#process.exit"><code>process.exit()</code></a> termine le processus.</p>
</li>
<li>
<p>Sinon, ce chronom√®tre mettra fin au processus au bout de 5 secondes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En pratique le r√©sultat ressemble √† ceci&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/interrupt.js
2018-03-16T10:58:32.855Z - Processus d√©marr√©
<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>
2018-03-16T10:58:40.000Z - Processus termin√© (manuellement)</pre>
</div>
</div>
<div class="paragraph">
<p>En plus du signal <code>SIGINT</code>, Node nous relaie les signaux suivants&#160;:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 2. √âv√©nements li√©s aux signaux syst√®mes</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">√âv√©nement</th>
<th class="tableblock halign-left valign-top">Raison du d√©clenchement</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGINT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interruption de la commande en&#160;cours</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGTERM</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Demande au processus de s&#8217;arr√™ter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGUSR1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node re√ßoit le signal d&#8217;attacher l'<a href="#inspect">inspecteur</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGHUP</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Le terminal est en train d&#8217;√™tre ferm√©</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGWINCH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Le terminal a √©t√© redimensionn√©</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>SIGKILL</code> est un autre √©v√©nement important, mais on ne peut pas l&#8217;√©couter.
Quand il est √©mis, le processus doit √™tre arr√™t√© quoiqu&#8217;il arrive.
On l&#8217;utilise justement en dernier recours, quand <code>SIGINT</code>
et <code>SIGTERM</code> ne font pas effet&#160;; par exemple √† cause d&#8217;un bogue dans notre code,
ou d&#8217;une ressource qui ne rend pas la main.</p>
</div>
<div id="process.exit" class="paragraph">
<p><strong>Un processus Node se termine quand il n&#8217;a plus d&#8217;instructions √† ex√©cuter</strong>.
Ce peut √™tre provoqu√© via
l'<a href="#signals">√©mission d&#8217;un signal ext√©rieur</a>, mais aussi de l&#8217;int√©rieur
par l&#8217;interm√©diaire de la fonction <code>process.exit()</code>.
</p>
</div>
<div class="paragraph">
<p>On utilise cette fonction car le programme a atteint son but.
On le fait aussi lorsqu&#8217;on intercepte une erreur en souhaitant
effectuer un <strong>traitement sp√©cial avant de mettre fin au processus</strong>.
Il se peut aussi qu&#8217;il vaille mieux terminer l&#8217;application en cas de perte
d&#8217;acc√®s √† des ressources distantes (base de donn√©es, stockage de fichiers)
au lieu de pr√©senter une application web instable.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre que l&#8217;on souhaite cl√¥turer notre script
si on trouve le bon nombre&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/exit-devinette.js
JEU ! Trouve le nombre auquel je pense :
10<kbd>ENTR√âE</kbd>
Hm hm, essaie encore.
3<kbd>ENTR√âE</kbd>
Tu as trouv√©, bravo !</pre>
</div>
</div>
<div class="paragraph">
<p>Dans cet exemple, on √©coute l&#8217;utilisateur de mani√®re ind√©finie, jusqu&#8217;√† ce qu&#8217;il
ou elle trouve le bon nombre.
Lorsque c&#8217;est le cas, on interrompt le programme en transmettant
un code de sortie de r√©ussite&#160;: le code <code>0</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/exit-devinette.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> secret_number <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JEU ! Trouve le nombre auquel je pense :'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>               <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">===</span> secret_number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Tu as trouv√©, bravo !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hm hm, essaie encore.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le nombre secret est&#160;<code>3</code> par d√©faut, sauf s&#8217;il est pass√© <a href="#process.argv">en argument</a> du script.</p>
</li>
<li>
<p>Cette fonction est invoqu√©e √† chaque saisie suivie de l&#8217;appui sur la touche <kbd>ENTR√âE</kbd>.</p>
</li>
<li>
<p>Cette ligne met fin au script, apr√®s avoir affich√© un message de f√©licitations.</p>
</li>
<li>
<p>Ce message s&#8217;affiche √† chaque saisie erron√©e, jusqu&#8217;√† ce que le nombre secret soit trouv√©.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On pourrait tout √† fait imaginer une variante de ce script dans laquelle
on limiterait le nombre de mauvaises r√©ponses.
Lorsqu&#8217;on atteindrait cette limite, le programme utiliserait un code de sortie
diff√©rent de&#160;<code>0</code>.
Le code&#160;<code>9</code> ferait l&#8217;affaire puisqu&#8217;il indique qu&#8217;un argument invalide a √©t√©
pass√©.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Avanc√©</span> process.abort()</div>
<div class="paragraph">
<p>
Comme avec <code>process.exit()</code>, le programme est termin√© imm√©diatement.
On l&#8217;utilise quand quelque chose d&#8217;inopin√© et n√©cessitant un d√©bogage
avanc√© se produit.</p>
</div>
<div class="paragraph">
<p>La fonction g√©n√®re un fichier de d√©bogage (<em>core file</em>) qui contient tout le contenu
de la m√©moire utilis√©e par Node.

Ce fichier s&#8217;analyse avec des logiciels avanc√©s comme <code>mdb_v8</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module process</div>
<div class="paragraph">
<p>La documentation du module <code>process</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/process.html" class="bare">nodejs.org/docs/latest-v10.x/api/process.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="stream">2.11. stream : manipuler des flux de donn√©es</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Le module <code>stream</code> contient les √©l√©ments de base pour lire, √©crire et
transformer des flux de donn√©es rapidement et avec peu de m√©moire.</p>
</div>
<div class="paragraph">
<p>Cr√©er ses propres flux est une chose assez compliqu√©e √† r√©aliser.
Dans cette section, nous allons nous focaliser sur l&#8217;utilisation des modules
Node qui g√©n√®rent de tels&#160;flux.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span>                    <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                       <span class="token comment">// <b class="conum">(2)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%d octets lus'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On cr√©e un flux de lecture qui ouvre le fichier courant (<code>__filename</code>).</p>
</li>
<li>
<p>Invoque cette fonction √† chaque morceau de donn√©es&#160;lu.</p>
</li>
<li>
<p>Affiche le nombre d&#8217;octets lus dans ce morceau.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node stream/intro.js
214 octets lus</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Un flux de lecture consomme les donn√©es petit √† petit</strong>.
Il correspond √† une instance de l&#8217;objet <a href="#stream.Readable"><code>stream.Readable</code></a>.


L&#8217;exemple pr√©c√©dent n&#8217;a affich√© qu&#8217;un seul morceau car la taille maximale
par d√©faut est d&#8217;environ <code>16&#160;Ko</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/read.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">{</span>highWaterMark<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Lecture termin√©e'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%d octets re√ßus'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On sp√©cifie cette fois qu&#8217;on lit <code>100&#160;octets</code> √† la fois.</p>
</li>
<li>
<p>Affiche <code>Lecture termin√©e</code> lorsque tous les morceaux ont √©t√©&#160;lus.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;option <code>highWaterMark</code> adapte le d√©bit de lecture.
Cette valeur est exprim√©e en octets.
Plus ce nombre est petit, moins Node utilise de m√©moire&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node stream/read.js
100 octets lus
100 octets lus
78 octets lus
Lecture termin√©e</pre>
</div>
</div>
<div class="paragraph">
<p>Le m√©canisme de flux s&#8217;applique √©galement √† l&#8217;√©criture.


<strong>Un flux d&#8217;√©criture √©crit des donn√©es petit √† petit</strong>.
Il correspond √† une instance de l&#8217;objet <a href="#stream.Writeable"><code>stream.Writeable</code></a>.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre une succession d&#8217;√©critures dans un m√™me&#160;flux&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/write.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createWriteStream<span class="token punctuation">,</span> readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dest <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'debug.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>

stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">readFile</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>         <span class="token comment">// <b class="conum">(4)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Hell'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(2)</b></span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'o Worl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'d!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On cr√©e un flux d&#8217;√©criture vers le fichier <code>stream/debug.txt</code>.</p>
</li>
<li>
<p>√âcrit <code>Hell</code> dans le&#160;flux.</p>
</li>
<li>
<p>√âcrit&#160;<code>d!</code> dans le flux et signale que nous n&#8217;avons plus de donn√©es √† transmettre.</p>
</li>
<li>
<p>L&#8217;utilisation de <code>stream.end()</code> d√©clenche l&#8217;√©v√©nement <code>finish</code>&#160;‚Äì nous lisons le contenu du fichier √† ce moment&#160;l√†.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette √©criture par morceaux a pour effet de r√©duire la pression m√©moire
exerc√©e par Node sur le syst√®me d&#8217;exploitation et pour le reste du programme.
Ce m√©canisme est particuli√®rement adapt√© lorsque l&#8217;√©criture prend du temps
ou implique un certain volume de donn√©es.</p>
</div>
<div class="paragraph">
<p><strong>Les flux de lecture et d&#8217;√©criture se combinent</strong>.


Les donn√©es lues depuis une source (<code>Readable</code>) sont redirig√©es vers
une destination (<code>Writeable</code>) √† l&#8217;aide de la fonction <code>pipe()</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/pipe.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">,</span> createWriteStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filename_copy <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'copie.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> dest <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span>filename_copy<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(2)</b></span>

source<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span>                                       <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Copie termin√©e !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(4)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On cr√©e un flux de lecture.</p>
</li>
<li>
<p>On cr√©e un flux d&#8217;√©criture.</p>
</li>
<li>
<p>On redirige le flux de lecture vers celui d&#8217;√©criture.</p>
</li>
<li>
<p>La redirection retourne le flux d&#8217;√©criture, que l&#8217;on √©coute pour savoir quand il a termin√© d&#8217;√©crire sur le disque.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dans cet exemple, nous avons pris deux fichiers respectivement comme source de lecture
et destination d&#8217;√©criture.
Nous avons assembl√© les deux flux avec <code>pipe()</code> puis d√©tect√© la fin de la copie.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Unix</span> Op√©rateur pipe&#160;(<code>|</code>)</div>
<div class="paragraph">
<p>La fonction <code>stream.pipe()</code> correspond litt√©ralement √† l&#8217;op√©rateur Unix&#160;<code>|</code>.</p>
</div>
<div class="paragraph">
<p>Les morceaux de donn√©es d&#8217;un premier programme sont transmis en entr√©e √† un
second programme.
Ici, le m√©canisme s&#8217;applique √† des fonctions&#160;Node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <code>pipe()</code> semble superflue pour copier des fichiers.
√Ä vrai dire, la fonction <a href="#fs"><code>fs.copyFile()</code></a> fait exactement la m√™me chose.


Toutefois, le m√©canisme de redirection propos√© par <code>pipe()</code> est modulaire et composable.
On peut par exemple diriger une source de donn√©es vers plusieurs flux d&#8217;√©criture
en m√™me temps.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/pipe-multi.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filename_copy <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'copie.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> read <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Lecture termin√©e !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

read<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>filename_copy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
read<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>√âcrit une copie du fichier comme dans l&#8217;exemple <code>stream/pipe.js</code>.</p>
</li>
<li>
<p>Redirige le contenu de lecture vers la <a href="#process.std">sortie standard</a> de notre terminal.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette technique agit comme une gare de triage&#160;: nous avons la libert√©
d&#8217;agir sur les donn√©es avant de les envoyer vers leur flux d&#8217;√©criture distinct.</p>
</div>
<div class="paragraph">
<p>On peut aussi <strong>transformer les contenus √† la vol√©e</strong> en utilisant plusieurs
fois la fonction <code>pipe()</code>.
Les donn√©es sont pass√©es √† des objets capables de lire et d&#8217;√©crire des flux.
C&#8217;est le cas du <a href="#extras">module <code>zlib</code></a>, responsable de compresser et de
d√©compresser des donn√©es&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/pipe-transform.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>createGzip<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'zlib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Compresse les donn√©es √† la vol√©e.</p>
</li>
<li>
<p>Les donn√©es compress√©es sont transmises √† la <a href="#process.std">sortie standard</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cet exemple devrait afficher le contenu de notre fichier source avec une taille
r√©duite&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node stream/pipe-transform.js</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;affichage semble bizarre et c&#8217;est normal&#160;: ce sont des donn√©es compress√©es
au format Gzip&#160;‚Äì un format de compression libre.</p>
</div>
<div class="paragraph">
<p>Le programme Unix <code>gzip</code> sait d√©coder des donn√©es compress√©es dans ce format.
Il sait aussi les d√©coder √† la vol√©e avec un&#160;<em>pipe</em>&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node stream/pipe-transform.js | gzip</pre>
</div>
</div>
<div class="paragraph">
<p>Nous avons vu comment transmettre des flux de donn√©es de mani√®re interop√©rable
entre un script Node et un programme externe, entre deux programmes externes
et entre deux scripts&#160;Node.</p>
</div>
<div id="stream.Readable" class="hdlist">
<div class="title">Principaux attributs d&#8217;un flux Readable</div>
<table>
<tr>
<td class="hdlist1">
<code>stream.pipe()</code>
</td>
<td class="hdlist2">
<p>Redirige un flux de lecture vers un flux d&#8217;√©criture.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('data')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsqu&#8217;un morceau de donn√©es a √©t√©&#160;lu.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('error')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorqu&#8217;une erreur se produit.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('end')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsqu&#8217;il n&#8217;y a plus de donn√©es √†&#160;lire.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('readable')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsque la lecture de donn√©es est pr√™te √† d√©marrer.</p>
</td>
</tr>
</table>
</div>
<div id="stream.Writeable" class="hdlist">
<div class="title">Principaux attributs d&#8217;un flux Writeable</div>
<table>
<tr>
<td class="hdlist1">
<code>stream.write()</code>
</td>
<td class="hdlist2">
<p>√âcrit des donn√©es dans le flux.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.end()</code>
</td>
<td class="hdlist2">
<p>Signale que nous n&#8217;avons plus de donn√©es √† transmettre.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('drain')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsque la m√©moire d&#8217;√©criture est vide et pr√™te √† accepter
de nouvelles donn√©es.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('error')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche lorsqu&#8217;une erreur se produit.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('finish')</code>
</td>
<td class="hdlist2">
<p>Se d√©clenche √† la cl√¥ture du flux d&#8217;√©criture.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module stream</div>
<div class="paragraph">
<p>La documentation du module <code>stream</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/stream.html" class="bare">nodejs.org/docs/latest-v10.x/api/stream.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="dautres_modules_pour_aller_plus_loin">2.12. D&#8217;autres modules pour aller plus loin</h3>
<div class="paragraph">
<p>Node embarque d&#8217;autres modules que ceux list√©s pr√©c√©demment.
Ils n√©cessitent des connaissances sur des sujets bas niveau,
plus proches du mat√©riel et des protocoles r√©seau.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="cluster"></a><code>cluster</code></dt>
<dd>
<p>G√®re la distribution d&#8217;une application sur plusieurs CPU d&#8217;un m√™me ordinateur.
</p>
</dd>
<dt class="hdlist1"><a id="crypto"></a><code>crypto</code></dt>
<dd>
<p>Fonctions cryptographiques pour chiffrer, signer et v√©rifier des donn√©es.
</p>
</dd>
<dt class="hdlist1"><a id="dgram"></a><code>dgram</code></dt>
<dd>
<p>Cr√©ation et consommation de ressources&#160;UDP.
</p>
</dd>
<dt class="hdlist1"><a id="dns"></a><code>dns</code></dt>
<dd>
<p>R√©solution et lecture d&#8217;enregistrements&#160;DNS.
</p>
</dd>
<dt class="hdlist1"><a id="net"></a><code>net</code></dt>
<dd>
<p>Cr√©ation et consommation de ressources TCP.
Les modules <code>http</code>, <code>https</code> et <code>http2</code> se basent dessus.
</p>
</dd>
<dt class="hdlist1"><a id="readline"></a><code>readline</code></dt>
<dd>
<p>Manipulation ligne par ligne d&#8217;un <a href="#stream">flux</a>.
Ce module est particuli√®rement utilis√© dans des
<a href="../chapter-08/index.html">applications en ligne de commande</a> (chapitre&#160;8),
pour mettre √† jour une barre de progression et animer des √©l√©ments d&#8217;affichage.
</p>
</dd>
<dt class="hdlist1"><a id="tty"></a><code>tty</code></dt>
<dd>
<p>Gestion d&#8217;interface de terminal en mode texte.
Le module <code>readline</code> se base dessus.
</p>
</dd>
<dt class="hdlist1"><a id="v8"></a><code>v8</code></dt>
<dd>
<p>Lecture et √©criture d&#8217;instructions de la machine virtuelle&#160;V8
dans le processus actuel.

</p>
</dd>
<dt class="hdlist1"><a id="vm"></a><code>vm</code></dt>
<dd>
<p>Cr√©ation de nouveaux contextes d&#8217;interpr√©tation de la machine virtuelle&#160;V8.

</p>
</dd>
<dt class="hdlist1"><a id="zlib"></a><code>zlib</code></dt>
<dd>
<p>Compression et d√©compression de donn√©es (Gzip, Inflate/Deflate).
Ces formats sont utilis√©s pour la compression de requ√™tes&#160;HTTP.
</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modules">3. Cr√©er ses propres modules Node</h2>
<div class="sectionbody">
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Les <a href="#modules-builtin">modules de base</a> nous fournissent de nombreuses fonctionnalit√©s.
Nous pouvons r√©utiliser le m√™me m√©canisme pour
<strong>organiser notre code dans plusieurs fichiers</strong>.
C&#8217;est un m√©canisme comparable √† ce que l&#8217;on retrouve en Python (<code>import</code>),
PHP (<code>require</code>) et Ruby (<code>require</code> et <code>require_relative</code>).</p>
</div>
<div class="sect2">
<h3 id="modules.require">3.1. Importer et exporter des valeurs</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/enfant.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier d&#8217;exemple <code>modules/enfant.js</code> contient une variable, <code>number</code>.
Essayons de la r√©utiliser dans le fichier <code>modules/parent.js</code>
√† l&#8217;aide de la fonction <code>require()</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/parent.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> enfant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./enfant.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(1)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Contrairement aux <a href="#modules-builtin">modules de base</a>, on passe un chemin relatif au fichier courant.</p>
</li>
<li>
<p>Est-ce que cela affichera la valeur de la variable <code>number</code>&#160;?</p>
</li>
<li>
<p>Mais au fond, que contient notre variable <code>enfant</code>&#160;?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ex√©cutons le fichier <code>modules/parent.js</code> avec Node pour en avoir le c≈ìur&#160;net&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node modules/parent.js
undefined
{}</pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons en tirer un apprentissage important&#160;:
on ne peut pas voir ce qu&#8217;il y a dans un module depuis l&#8217;ext√©rieur.</p>
</div>
<div class="paragraph">
<p>Choisissons maintenant ce que l&#8217;on souhaite exporter en affectant
la valeur de notre choix √† <code>module.exports</code>&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/enfant-export.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> number<span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comment cela √ßa se traduit-il lorsqu&#8217;on l&#8217;appelle avec <code>require()</code>&#160;?</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/parent-export.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> enfant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./enfant-export.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>undefined</code>.</p>
</li>
<li>
<p>Affiche&#160;<code>42</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>module.exports</code> rend visible depuis l&#8217;ext√©rieur ce qui est export√© par un module.
Par d√©faut, <code>module.exports</code> est un objet.</p>
</div>
<div class="paragraph">
<p>Essayons maintenant d&#8217;exporter plusieurs valeurs en une seule fois.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/enfant-export-multiple.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>number <span class="token operator">=</span> number<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">limit <span class="token operator">=</span> <span class="token number">100</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous avons cr√©√© deux nouvelles valeurs&#160;: <code>number</code> (un nombre) et
<code>random()</code> (une fonction).</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/parent-export-multiple.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> enfant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./enfant-export-multiple.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(2)</b></span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> enfant<span class="token punctuation">.</span>random<span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche&#160;<code>42</code>.</p>
</li>
<li>
<p>Affiche un nombre al√©atoire entre&#160;0 et&#160;100.</p>
</li>
<li>
<p>R√©exporte la fonction <code>enfant.number</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Exporter un objet</div>
<div class="paragraph">
<p>
L&#8217;utilisation de la syntaxe d&#8217;objet raccourcie √©vite la r√©p√©tition
du nom des variables lors de l&#8217;export.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">limit <span class="token operator">=</span> <span class="token number">100</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>number<span class="token punctuation">,</span> random<span class="token punctuation">}</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Liste des valeurs retourn√©e par l&#8217;objet <code>module.exports</code>.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En r√©sum√©, <strong>pour Node</strong>, <strong>tout fichier&#160;<code>.js</code> est un module</strong>.
Le m√©canisme d&#8217;import et d&#8217;export est bas√© sur des chemins de fichiers.
Si on n&#8217;utilise pas de chemin, Node pense que l&#8217;on fait
r√©f√©rence √† un <a href="#modules-builtin">module de base</a> ou √† un
<a href="../chapter-05/index.html#modules">module&#160;<code>npm</code></a>
(<a href="../chapter-05/index.html">chapitre&#160;5</a>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Histoire</span> Modules CommonJS</div>
<div class="paragraph">
<p>

Le m√©canisme de modules impl√©ment√© dans Node est bas√© sur la
sp√©cification <em>CommonJS</em>, √† peu de choses pr√®s.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://www.commonjs.org/specs/modules/1.0/" class="bare">www.commonjs.org/specs/modules/1.0/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="require">3.2. Aller plus loin avec <code>require()</code></h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Lorsqu&#8217;on fait appel √† la fonction <code>require()</code>, Node effectue les actions suivantes&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>R√©sout le chemin vers le module en question.</p>
</li>
<li>
<p>Lit du fichier.</p>
</li>
<li>
<p>Interpr√®te le code.</p>
</li>
<li>
<p>Ex√©cute le code.</p>
</li>
<li>
<p>Retourne la valeur de <code>module.exports</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <code>require()</code> est synchrone et bloquante.
Si l&#8217;ex√©cution du code dans le module charg√© prend du temps
‚Äì code lent, acc√®s √† une ressource distante&#160;‚Äì le temps de chargement
du module sera affect√©.</p>
</div>
<div class="paragraph">
<p><code>require()</code> permet de charger trois types de modules&#160;:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fichiers relatifs au module actuel</dt>
<dd>
<p><code>require('./module.js')</code> cherche le fichier <code>module.js</code> dans le r√©pertoire courant.
<code>require('../module.js')</code> cherche <code>module.js</code> dans le r√©pertoire parent.</p>
</dd>
<dt class="hdlist1">Modules Node de base</dt>
<dd>
<p>Ils sont disponibles avec chaque installation de Node.</p>
</dd>
<dt class="hdlist1">Modules&#160;<code>npm</code></dt>
<dd>
<p>Ils sont disponibles avec une √©tape d&#8217;installation suppl√©mentaire
(<a href="../chapter-05/index.html">chapitre 5</a>).
</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><strong>Node met les modules en cache</strong>.
Si on inclut deux fois le m√™me module, le deuxi√®me import ira directement
√† la derni√®re √©tape de la liste d&#8217;actions.
Cela implique aussi que si le module modifie une de ses variables priv√©e,
cette modification affectera le deuxi√®me import.</p>
</div>
<div class="paragraph">
<p>Voici un module illustrant une variable priv√©e et une variable export√©e&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/increment.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">const</span> <span class="token function-variable function">increment</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">++</span>counter<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> increment<span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Variable priv√©e.</p>
</li>
<li>
<p><code>increment</code> est rendue publique √† cet endroit&#160;‚Äì la fonction incr√©mente la variable priv√©e <code>counter</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous allons importer ce module par deux fois, dans deux variables diff√©rentes.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/double-import.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> first <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> second <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche&#160;<code>1</code>.</p>
</li>
<li>
<p>Affiche&#160;<code>2</code>.</p>
</li>
<li>
<p>Affiche&#160;<code>1</code> ou&#160;<code>3</code>&#160;?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Quel est le verdict √† votre avis&#160;?
Rien ne vaut une v√©rification, quitte √† remettre en question
notre avis initial&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node modules/double-import.js
1
2
3</pre>
</div>
</div>
<div class="paragraph">
<p>Il faut garder cette information en t√™te lorsqu&#8217;on importe un module.
Ce m√©canisme se transforme en atout afin de partager
une variable entre plusieurs modules.
Il est pratique dans le cas d&#8217;un cache de donn√©es ou d&#8217;une configuration partag√©e.</p>
</div>
<div class="paragraph">
<p>Enfin, plusieurs <strong>probl√®mes</strong> sont susceptibles d&#8217;appara√Ætre lors du chargement d&#8217;un module&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Le chemin vers le module est erron√©&#160;;</p>
</li>
<li>
<p>Le module contient une erreur de syntaxe.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Node lance alors une <a href="#errors">exception</a> et le programme s&#8217;arr√™te aussit√¥t.
</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module &#8220;modules&#8221;</div>
<div class="paragraph">
<p>L&#8217;int√©gralit√© des variables, fonctions et classes du module <code>modules</code>
est document√©e sur le site web du projet Node.
La documentation contient des informations √† jour et qui ne sont pas
forc√©ment list√©es dans cet ouvrage.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/modules.html" class="bare">nodejs.org/docs/latest-v10.x/api/modules.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="esm">3.3. Le futur : les modules ECMAScript</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Pendant que le m√©canisme de modules de Node montait en puissance,
les navigateurs web √©taient en attente d&#8217;une solution native.
La sp√©cification des modules ECMAScript a √©t√© valid√©e en&#160;2013,
mais les navigateurs ont tard√© √† en impl√©menter le m√©canisme&#160;:
en&#160;2017 pour la plupart.
C&#8217;est le cas du navigateur web Chrome et de
sa <a href="../chapter-01/index.html#v8">machine virtuelle&#160;V8</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">üö®</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Fonctionnalit√© exp√©rimentale</div>
<div class="paragraph">
<p>Si la syntaxe des modules ECMAScript est standardis√©e,
ce n&#8217;est pas encore aussi stable du c√¥t√© de&#160;Node.</p>
</div>
<div class="paragraph">
<p>Les modules ECMAScript sont suffix√©s de l&#8217;extension <code>.mjs</code>
et n√©cessitent l&#8217;utilisation de l'<a href="#options">option de d√©marrage</a>
<code>--experimental-modules</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Reprenons l&#8217;exemple <code>modules/increment.js</code> pour le
transformer en module ECMAScript.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/increment.mjs</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">++</span>counter<span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Export par d√©faut.</p>
</li>
<li>
<p>Export nomm√©.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La syntaxe <code>export</code> sert √† exporter des variables.
Elle se combine avec <code>import</code>&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/ecmascript.mjs</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> increment <span class="token keyword">from</span> <span class="token string">'./increment.js'</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On n&#8217;importe ici que la valeur par d√©faut.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il ne nous reste maintenant plus qu&#8217;√† ex√©cuter notre script <code>.mjs</code>
pour observer le r√©sultat.
On notera l&#8217;utilisation de <code>--experimental-modules</code>&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --experimental-modules modules/ecmascript.mjs
(node:35074) ExperimentalWarning: The ESM module loader is experimental.
1</pre>
</div>
</div>
<div class="paragraph">
<p>Reprenons cet exemple pour importer plusieurs exports d&#8217;un coup&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/ecmascript-multiple.mjs</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> increment<span class="token punctuation">,</span> <span class="token punctuation">{</span>reset<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./increment.mjs'</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                          <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On importe la valeur par d√©faut, ainsi qu&#8217;une valeur nomm√©e&#160;‚Äì c&#8217;est particuli√®rement pratique pour s√©lectionner avec finesse ce que l&#8217;on veut utiliser d&#8217;un module.</p>
</li>
<li>
<p>La fonction <code>reset()</code> remet le compteur √†&#160;z√©ro.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On notera au passage qu&#8217;on utilise la
<a href="../chapter-03/index.html#object-destructuring">d√©composition d&#8217;objet</a>
pour extraire un export nomm√© depuis un module ECMAScript.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --experimental-modules modules/ecmascript-multiple.mjs
(node:35074) ExperimentalWarning: The ESM module loader is experimental.
2
1</pre>
</div>
</div>
<div class="paragraph">
<p>La fonction <code>reset()</code> a bien remis le compteur √† z√©ro entre-temps.
Objectif accompli&#160;!</p>
</div>
<div class="paragraph">
<p>R√©sumons les diff√©rences notables avec le m√©canisme de modules&#160;Node&#160;:




</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tous les appels √† <code>import</code> doivent se faire en d√©but de fichier.</p>
</li>
<li>
<p>On ne peut pas utiliser <code>import</code> de mani√®re dynamique
(dans un <code>if &#8230;&#8203; else</code> par exemple).</p>
</li>
<li>
<p>On peut exporter une variable par d√©faut et plusieurs variables nomm√©es.</p>
</li>
<li>
<p>Il est possible d&#8217;importer des modules Node depuis un module ECMAScript&#160;‚Äì
l&#8217;inverse n&#8217;est pas&#160;vrai.</p>
</li>
<li>
<p>Les fichiers doivent √™tre suffix√©s par&#160;<code>.mjs</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce dernier point est le plus emb√™tant car il ralentit l&#8217;interop√©rabilit√©
entre les scripts destin√©s au d√©veloppement web <em>front-end</em> et les scripts&#160;Node.</p>
</div>
<div class="paragraph">
<p>L&#8217;histoire nous dira si les modalit√©s s&#8217;assoupliront avec le temps.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Module&#160;esm</div>
<div class="paragraph">
<p>Le <a href="../chapter-05/index.html#modules">module&#160;<code>npm</code></a>&#160;<code>esm</code>
(<span class="URL"><a href="https://npmjs.com/esm" class="bare">npmjs.com/esm</a></span>) a pris le parti de d√©blayer le chemin
de l&#8217;interop√©rabilit√©.
Il suffit de le charger avant de d√©marrer un script Node,
peu importe son m√©canisme de chargement de modules&#160;:
<code>esm</code> rend le chargement des modules totalement transparent.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -r esm modules/ecmascript.js
1
<span data-bash-subs="$"></span>node -r esm modules/ecmascript.mjs
1</pre>
</div>
</div>
<div class="paragraph">
<p>Pour en savoir plus sur l&#8217;option&#160;<code>-r</code>, rendez-vous
dans la section &#8220;<a href="#require">Pr√©charger un module</a>&#8221;.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Modules ECMAScript</div>
<div class="paragraph">
<p>L&#8217;int√©gralit√© des fonctionnalit√©s des modules ECMAScript
est document√©e sur le site web du projet Node.
La documentation contient des informations √† jour et qui ne sont pas
forc√©ment list√©es dans cet ouvrage.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/esm.html" class="bare">nodejs.org/docs/latest-v10.x/api/esm.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="errors">4. S&#8217;en sortir quand √ßa ne se passe pas comme&#160;pr√©vu</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>On fait toutes et tous des erreurs.
Notre code va forc√©ment mener √† des plantages applicatifs.
La nature des causes varie et affecte notre lecture des messages d&#8217;erreur.</p>
</div>
<div class="paragraph">
<p>Cette section a pour intention de nous aider √† prendre confiance dans ce qu&#8217;on
voit et de piocher l&#8217;information qui va nous aider √† r√©soudre le probl√®me.</p>
</div>
<div class="sect2">
<h3 id="une_erreur_est_nich√©e_dans_notrecode">4.1. Une erreur est nich√©e dans notre&#160;code</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Il y a deux familles d&#8217;erreurs dans du code ECMAScript&#160;: celles de syntaxe
et celles d&#8217;ex√©cution.</p>
</div>
<div class="paragraph">
<p>Dans tous les cas, Node lance une exception compl√©t√©e d&#8217;une trace d&#8217;erreur.
Le but est de comprendre o√π l&#8217;interpr√©teur se prend les pieds dans le tapis
et quel est le chemin parcouru au sein du code pour y parvenir.</p>
</div>
<div class="paragraph">
<p>Commen√ßons avec une erreur de syntaxe&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node <mark>syntax-error.js</mark>
console.log(<mark>'oups j'</mark>ai fait une erreur de guillemets);
            ^^^^^^^^

<mark>SyntaxError</mark>: <mark>missing ) after argument list</mark>
    at new Script (vm.js:74:7)
    at createScript (vm.js:246:10)
    at Object.runInThisContext (vm.js:298:10)</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Une erreur de syntaxe est imm√©diate</strong>.
Node la d√©tecte lorsqu&#8217;il <em>parse</em> notre code.</p>
</div>
<div class="paragraph">
<p>Dans l&#8217;exemple pr√©c√©dent, Node indique qu&#8217;il manque une parenth√®se apr√®s le
deuxi√®me guillemet, car c&#8217;est le symbole que l&#8217;interpr√©teur attend.
En effet, le guillemet indique une intention incorrecte&#160;: on ne veut pas qu&#8217;il
signifie la fin de la cha√Æne, mais qu&#8217;il repr√©sente un caract√®re apostrophe dans
la cha√Æne.</p>
</div>
<div class="paragraph">
<p>La correction √† entreprendre ne sera pas d&#8217;ajouter une parenth√®se apr√®s le
guillemet mais bien de l&#8217;√©chapper en le pr√©fixant d&#8217;un caract√®re&#160;<code>\</code>.
Node l&#8217;interpr√©tera alors correctement.</p>
</div>
<div class="paragraph">
<p>Penchons-nous √† pr√©sent sur les erreurs provoqu√©es lorsque le code est ex√©cut√©&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/exit-error.js
console.log(<mark>jenexistepas</mark>);
            ^
<mark>ReferenceError</mark>: <mark>jenexistepas</mark> <mark>is not defined</mark>
    at Object.<anonymous> (/.../chapter-04/examples/process/<mark>exit-error.js</mark>:<mark>5</mark>:13)
    at Module._compile (module.js:643:30)</pre>
</div>
</div>
<div class="paragraph">
<p>Le marqueur <code>+^+</code>&#160;indique l&#8217;emplacement o√π le probl√®me est rencontr√©.
La ligne en-dessous documente le type d&#8217;erreur (<code>ReferenceError</code>)
en pr√©cisant ce qui n&#8217;est pas d√©fini (la variable <code>jenexistepas</code>).
La notation <code>exit-error.js:5:13</code> indique que l&#8217;origine de l&#8217;erreur
se trouve √† la <em>ligne&#160;5</em> du fichier <code>exit-error.js</code>.</p>
</div>
<div class="paragraph">
<p>Pour y rem√©dier, il faut v√©rifier si on appelle bien la bonne variable ou la
cr√©er avec la valeur attendue le cas √©ch√©ant.</p>
</div>
<div class="paragraph">
<p>Les erreurs d&#8217;ex√©cution sont pernicieuses&#160;; elles sont parfois
provoqu√©es apr√®s le d√©marrage de l&#8217;application.
Dans l&#8217;exemple qui suit, l&#8217;une d&#8217;elles se produit deux secondes apr√®s le
d√©marrage du script&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node runtime-error.js
setTimeout(() => console.log(<mark>secret.toLocaleUperCase()</mark>), 2000);
                                    ^
<mark>TypeError</mark>: <mark>secret.toLocaleUperCase</mark> <mark>is not a function</mark>
    at Timeout.setTimeout [as _onTimeout] (/.../chapter-04/examples/runtime-error.js:4:37)</pre>
</div>
</div>
<div class="paragraph">
<p>La notation <code>runtime-error.js:4:37</code> indique que l&#8217;origine de l&#8217;erreur
se trouve √† la <em>ligne&#160;4</em> du fichier <code>runtime-error.js</code>, <em>colonne&#160;37</em>.
Le type d&#8217;erreur (<code>TypeError</code>) signifie qu&#8217;on cherche √† manipuler une variable
de mani√®re <strong>inattendue par rapport √† son type</strong>.
Le message d&#8217;erreur nous pr√©cise qu&#8217;on appelle comme une fonction quelque chose
qui ne serait donc pas une fonction.</p>
</div>
<div class="paragraph">
<p>En effet, le nom de la fonction est mal orthographi√© et <code>secret.toLocaleUperCase</code>
vaut <code>undefined</code>.
L&#8217;erreur sera corrig√©e en utilisant <code>secret.toLocaleUpperCase</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Module eslint</div>
<div class="paragraph">
<p>
Le module&#160;<code>npm</code>&#160;<code>eslint</code> (<span class="URL"><a href="https://npmjs.com/eslint" class="bare">npmjs.com/eslint</a></span>)
est un v√©rificateur syntaxique.
Son intention est de s&#8217;accorder sur le style d&#8217;√©criture et d&#8217;√©viter des
effets de bord du langage
qui causent des probl√®mes difficiles √† d√©celer.</p>
</div>
<div class="paragraph">
<p>On apprendra √† le configurer dans l'<a href="../appendix-a/index.html#eslint">annexe&#160;A</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les erreurs affich√©es affichent des informations importantes.
Si elles n&#8217;indiquent pas forc√©ment le chemin de r√©solution √©vident,
elles demandent qu&#8217;on cherche √† en comprendre la nature.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Module pretty-error</div>
<div class="paragraph">
<p>
Le module&#160;<code>npm</code>&#160;<code>pretty-error</code> (<span class="URL"><a href="https://npmjs.com/pretty-error" class="bare">npmjs.com/pretty-error</a></span>)
enjolive l&#8217;affichage des erreurs.
Il suffit de l&#8217;installer, de le <a href="#require">pr√©charger</a> et
d&#8217;ex√©cuter un script pour en b√©n√©ficier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -r pretty-error/start process/exit-error.js</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="une_erreur_est_retourn√©e_dans_une_fonction_de_rappel">4.2. Une erreur est retourn√©e dans une fonction de rappel</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>La fonction de rappel est un des moyens de retourner le r√©sultat
d&#8217;une ex√©cution asynchrone.
Par convention, le premier param√®tre est une erreur.</p>
</div>
<div class="paragraph">
<p>Ce param√®tre est nul (<code>null</code>) ou ind√©fini (<code>undefined</code>) lorsqu&#8217;il n&#8217;y a pas eu
d&#8217;erreurs en cours de route.
En revanche, il contient un objet d&#8217;erreur lorsque un probl√®me s&#8217;est produit.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/callback.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'je-n-existe-pas.txt'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                          <span class="token comment">// <b class="conum">(1)</b></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(2)</b></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On v√©rifie la pr√©sence de l&#8217;erreur.</p>
</li>
<li>
<p><code>error.message</code> contient une raison textuelle de l&#8217;erreur.</p>
</li>
<li>
<p>Affichage de l&#8217;objet d&#8217;erreur complet.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/callback.js
<mark>ENOENT</mark>: <mark>no such file or directory</mark>, open '<mark>je-n-existe-pas.txt</mark>'
{ Error: ENOENT: no such file or directory, open 'je-n-existe-pas.txt'
  errno: -2,
  code: 'ENOENT',
  syscall: 'open',
  path: 'je-n-existe-pas.txt' }</pre>
</div>
</div>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;erreur affich√©e nous pr√©cise que le fichier demand√© n&#8217;existe pas.
Son code (<code>ENOENT</code>) signifie la m√™me chose, mais a l&#8217;avantage d&#8217;√™tre plus
facile √† v√©rifier dans une condition.</p>
</div>
<div class="paragraph">
<p>L&#8217;objet <code>error</code> donn√© en argument de la fonction de rappel est utile
pour v√©rifier des d√©tails pr√©cis de l&#8217;erreur et mieux interagir avec
au niveau du code.
Nous y retrouvons le type d&#8217;erreur (<code>errno</code>),
la r√©f√©rence vers la ressource concern√©e (<code>path</code>) et le nom de la fonction
syst√®me utilis√©e par Node pour acc√©der √† la ressource (<code>syscall</code>).</p>
</div>
<div class="paragraph">
<p>La valeur et la signification du code d&#8217;erreur varie en fonction
du module Node employ√© √† ce moment-l√†.
Le <a href="#fs">module&#160;<code>fs</code></a> ne retourne pas les m√™mes codes
que le <a href="#http">module&#160;<code>http</code></a>.
Les appels √† des ressources syst√®me retournent
<a href="#errors.system">une vari√©t√© de codes d&#8217;erreur</a>.</p>
</div>
<div class="paragraph">
<p>La d√©cision nous appartient de savoir quoi faire quand l&#8217;erreur se produit.
Doit-on arr√™ter le programme avec <a href="#process.exit"><code>process.exit()</code></a>&#160;?
Passe-t-on √† la suite en consid√©rant que ce n&#8217;est pas grave&#160;?
Ou peut-√™tre que ce fichier √©tait cens√© exister et qu&#8217;on devrait
informer l&#8217;√©quipe de maintenance et
afficher une page d&#8217;erreur c√¥t√© utilisateur.</p>
</div>
</div>
<div class="sect2">
<h3 id="une_erreur_est_retourn√©e_dans_une_promesse">4.3. Une erreur est retourn√©e dans une promesse</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>La gestion d&#8217;erreur des <a href="../chapter-03/index.html#promise">promesses</a>
s&#8217;effectue √† l&#8217;aide de la fonction <code>.catch()</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/promise.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On g√©n√®re une erreur dans notre code.</p>
</li>
<li>
<p>L&#8217;objet d&#8217;erreur est transmis √† la prochaine occurrence de <code>.catch()</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le contenu de l&#8217;erreur est accessible dans le seul argument de la fonction
de rappel pass√©e √† <code>.catch()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/promise.js
Error: <mark>Oops !</mark>
    at <mark>Promise.resolve</mark>.<mark>then</mark> (/.../chapter-04/examples/errors/<mark>promise.js</mark>:<mark>5</mark>:11)
    at process._tickCallback (internal/process/next_tick.js:178:7)</pre>
</div>
</div>
<div class="paragraph">
<p>La trace indique que l&#8217;erreur s&#8217;est produite √† la <em>ligne&#160;5</em>,
dans la m√©thode <code>.then()</code> suite √† l&#8217;utilisation de <code>Promise.resolve()</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;utilisation multiple de <code>.catch()</code> nous aide √† g√©rer finement les erreurs&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/promise-chain.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Erreur : %s'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">return</span> <span class="token string">'Aaah'</span><span class="token punctuation">;</span>                                <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// <b class="conum">(4)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On g√®re l&#8217;erreur en la signalant dans le terminal.</p>
</li>
<li>
<p>La fonction de rappel a la possibilit√© de retourner un r√©sultat.</p>
</li>
<li>
<p>Ce r√©sultat est transmis √† la prochaine occurrence de <code>.then()</code>.</p>
</li>
<li>
<p>Dans ce cas, le dernier <code>.catch()</code> n&#8217;affiche rien car nous n&#8217;avons pas rencontr√© d&#8217;autre erreur entre-temps.</p>
</li>
</ol>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/promise-no-catch.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;absence de <code>.catch()</code> provoque un plantage applicatif et le d√©lenchement
de l'<a href="#process.on">√©v√©nement de processus</a> <code>unhandledRejection</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/promise-no-catch.js
(node:27412) <mark>UnhandledPromiseRejectionWarning</mark>: Error: Oops !
    at <mark>Promise.resolve</mark>.<mark>then</mark> (/.../chapter-04/examples/errors/<mark>promise-no-catch.js</mark>:<mark>5</mark>:11)
    at process._tickCallback (internal/process/next_tick.js:178:7)</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;affichage de <code>UnhandledPromiseRejectionWarning</code> indique que l&#8217;erreur s&#8217;est
produite mais qu&#8217;aucun <code>.catch()</code> ne l&#8217;a pris en charge.
Nous savons cependant que l&#8217;erreur s&#8217;est produite dans la m√©thode <code>.then()</code>
suite √† l&#8217;utilisation de <code>Promise.resolve()</code>.
</p>
</div>
</div>
<div class="sect2">
<h3 id="une_erreur_est_retourn√©e_dans_un_√©v√©nement">4.4. Une erreur est retourn√©e dans un √©v√©nement</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Tout √©l√©ment dot√© d&#8217;une m√©thode <code>.on()</code> a un √©v√©nement sp√©cial&#160;: <code>.on('error')</code>.
Il est appel√© √† chaque fois qu&#8217;une erreur se produit.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/on-error.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(1)</b></span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On √©met un √©v√©nement <code>error</code> avec un objet <code>Error</code> pr√©cisant la nature du probl√®me.</p>
</li>
<li>
<p>L&#8217;objet d&#8217;erreur est transmis √† l&#8217;√©v√©nement <code>error</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/on-error.js
Error: <mark>Oops !</mark>
    at Object.<mark>&lt;anonymous&gt;</mark> (/.../chapter-04/examples/errors/<mark>on-error.js</mark>:<mark>5</mark>:23)
    at Module._compile (internal/modules/cjs/loader.js:678:30)</pre>
</div>
</div>
<div class="paragraph">
<p>La trace d&#8217;erreur est similaire √† celle des promesses et des fonctions de rappel.
Le message d&#8217;erreur pr√©cise le probl√®me tandis que son origine (fichier, ligne)
nous indiquent quoi regarder pour mieux comprendre la cause.</p>
</div>
<div class="paragraph">
<p>Si une erreur est √©mise et si aucune fonction n&#8217;est √† l&#8217;√©coute,
l&#8217;√©v√©nement <code>uncaughtException</code> est produit&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/on-error.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/on-error-uncaught.js
events.js:167
      throw er; // <mark>Unhandled 'error'</mark> event
      ^

Error: Oops !
    at Object.<mark>&lt;anonymous&gt;</mark> (/.../chapter-04/examples/errors/<mark>on-error-uncaught.js</mark>:<mark>3</mark>:23)
    at Module._compile (internal/modules/cjs/loader.js:678:30)</pre>
</div>
</div>
<div class="paragraph">
<p>La section li√©e au <a href="#events">module <code>events</code></a> explique plus en d√©tail
la gestion des √©v√©nements.

On les retrouve par exemple dans les modules <a href="#http"><code>http</code></a>, <a href="#stream"><code>stream</code></a>
et <a href="#process"><code>process</code></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="errors.system">4.5. Une erreur est renvoy√©e par le syst√®me d&#8217;exploitation</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;acc√®s √† une ressource distante est plus complexe qu&#8217;il n&#8217;y para√Æt
car les erreurs sont de natures vari√©es et sujettes √† interpr√©tation au cas par cas,
en fonction de notre intention et du contexte d&#8217;ex√©cution.</p>
</div>
<div class="paragraph">
<p>Les erreurs syst√®me indiquent la raison du probl√®me.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 3. Erreurs couramment rencontr√©es</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Code erreur</th>
<th class="tableblock halign-left valign-top">Raison</th>
<th class="tableblock halign-left valign-top">Piste de r√©solution</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EACCES</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission refus√©e : nous n&#8217;avons pas le droit d&#8217;acc√©der √† cette ressource.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Changer les permissions d&#8217;acc√®s sans mettre en p√©ril la s√©curit√©.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EADDRINUSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse d√©j√† utilis√©e : nous tentons de cr√©er une ressource r√©seau alors qu&#8217;une
interface existe d√©j√† √† la m√™me adresse.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">V√©rifier l&#8217;origine du serveur d√©j√† en place √† cette adresse. Attribuer une autre adresse/port √† la ressource r√©seau.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ECONNREFUSED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource distante a refus√© la connexion.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">V√©rifier si c&#8217;est normal que la ressource distante soit inactive. V√©rifier qu&#8217;on se connecte √† la bonne ressource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ECONNRESET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource distante a √©t√© interrompue en cours de route.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retenter la connexion. V√©rifier la stabilit√© de la connexion r√©seau.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EEXIST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource √† cr√©er existe&#160;d√©j√†.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C&#8217;est un probl√®me seulement si la ressource n&#8217;√©tait pas cens√©e exister au pr√©alable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EMFILE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trop de fichiers sont ouverts simultan√©ment.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Les syst√®mes d&#8217;exploitation peuvent travailler sur une quantit√© finie de fichiers. Peut-√™tre que vous avez ouvert trop de fichiers en m√™me temps. Fermer l&#8217;acc√®s aux fichiers ouverts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENOENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ressource inexistante.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">V√©rifier que le chemin d&#8217;acc√®s est correct. Inspecter la raison de l&#8217;inexistance de la ressource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EPERM</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L&#8217;op√©ration n&#8217;est pas autoris√©e.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Des droits d&#8217;administration sont n√©cessaires pour effectuer cette op√©ration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EPIPE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L&#8217;acc√®s √† la ressource distante a √©t√© interrompu.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retenter l&#8217;op√©ration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ETIMEDOUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L&#8217;op√©ration a √©t√© annul√©e car la ressource distante a mis trop de temps pour aboutir.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retenter l&#8217;op√©ration. V√©rifier la disponibilit√© de la ressource distante. S&#8217;assurer que le volume demand√© n&#8217;est pas trop important.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>







</p>
</div>
</div>
<div class="sect2">
<h3 id="le_programme_ne_se_termine_pas">4.6. Le programme ne se termine pas</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Il arrive qu&#8217;un programme ne se termine pas contrairement √† nos attentes.
Il peut y avoir plusieurs raisons √† cela&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une ressource distante <strong>met du temps √† r√©pondre</strong>&#160;‚Äì
un <em>timeout</em> d√©clenchera une erreur (g√©n√©ralement sous&#160;30&#160;s).</p>
</li>
<li>
<p>Un traitement prend du temps.</p>
</li>
<li>
<p>Un <strong>√©v√©nement est en cours d&#8217;√©coute</strong>&#160;‚Äì typiquement un serveur web qui attend
des requ√™tes entrantes.</p>
</li>
<li>
<p>Une erreur n&#8217;a pas √©t√© captur√©e et perturbe les instructions suivantes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il faudra inspecter le syst√®me pour en savoir plus et observer la
consommation m√©moire et CPU du processus Node en question.</p>
</div>
<div class="paragraph">
<p>Peut-√™tre qu&#8217;il faudra sonder le programme pour d√©celer le point de blocage.
L'<a href="#inspect">inspecteur Node</a> est un outil particuli√®rement adapt√© √† cet usage.
</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Module debug</div>
<div class="paragraph">
<p>
Le module&#160;<code>npm</code>&#160;<code>debug</code> (<span class="URL"><a href="https://npmjs.com/debug" class="bare">npmjs.com/debug</a></span>) affiche des
messages dans la console de mani√®re conditionnelle.
Les messages s&#8217;affichent lorsque les variables d&#8217;environnement de notre choix
sont renseign√©es au d√©marrage de l&#8217;application.</p>
</div>
<div class="paragraph">
<p>On apprendra √† le configurer dans l'<a href="../appendix-a/index.html#debug">annexe&#160;A</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="deprecation">4.7. Une alerte de d√©pr√©ciation s&#8217;affiche</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Un des objectifs de l&#8217;√©quipe d√©veloppant Node est de maintenir
la stabilit√© de la plate-forme.
Certains de leurs choix de conception sont revisit√©s en changeant
leur comportement ou en les retirant des modules de&#160;base.</p>
</div>
<div class="paragraph">
<p>Quand ce changement affecte notre code, une alerte de d√©pr√©ciation s&#8217;affiche.
Par exemple&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">deprecation-warning.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node deprecation-warning.js
(node:8130) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.</pre>
</div>
</div>
<div class="paragraph">
<p>Nous avons ainsi le temps de modifier notre code pour migrer
vers la nouvelle recommandation petit √† petit.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="les_diff√©rences_decmascript_entre_node_et_les_navigateursweb">5. Les diff√©rences d&#8217;ECMAScript entre Node et les navigateurs&#160;web</h2>
<div class="sectionbody">
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Puisqu&#8217;on utilise du code ECMAScript avec Node et avec les navigateurs web,
qu&#8217;est-ce qui les distingue vraiment&#160;?</p>
</div>
<div class="sect2">
<h3 id="labsence_du_dom_et_des_variables_window_et_document">5.1. L&#8217;absence du DOM et des variables <code>window</code> et <code>document</code></h3>
<div class="paragraph">
<p>


</p>
</div>
<div class="paragraph">
<p>Dans Node, il n&#8217;est pas possible de faire appel aux variables <code>window</code>
et <code>document</code> (raccourci pour <code>window.document</code>).</p>
</div>
<div class="paragraph">
<p>Ces variables repr√©sentent respectivement la fen√™tre/onglet et le document
HTML interpr√©t√© par le navigateur web.
Les fonctions <code>document.querySelector()</code> et <code>document.createElement()</code>
rel√®vent du DOM (<em>Document Object Model</em>), une repr√©sentation JavaScript interactive
du document&#160;HTML.</p>
</div>
<div class="paragraph">
<p>L&#8217;√©quivalent de <code>window</code> pour Node serait la variable <a href="#process"><code>process</code></a>&#160;:
elle d√©crit le processus ex√©cutant notre code.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Variables globales</div>
<div class="paragraph">
<p>La documentation des variables globales est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/globals.html" class="bare">nodejs.org/docs/latest-v10.x/api/globals.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="il_ny_a_pas_dinterface_graphique">5.2. Il n&#8217;y a pas d&#8217;interface graphique</h3>
<div class="paragraph">
<p>Suite logique du point pr√©c√©dent&#160;: Node n&#8217;a pas d&#8217;interface graphique.
Le code ex√©cut√© n&#8217;affiche rien en tant que tel, √† part les messages dirig√©s
vers la <a href="#console">console</a>.</p>
</div>
<div class="paragraph">
<p>L'<a href="#inspect">inspecteur Node</a> est un moyen de visualiser l&#8217;√©tat interne
d&#8217;un script.</p>
</div>
<div class="paragraph">
<p>On peut toutefois construire des applications graphiques en ligne de commande
(<a href="../chapter-08/index.html">chapitre&#160;8</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="le_m√©canisme_de_modules">5.3. Le m√©canisme de modules</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Pour l&#8217;instant, Node utilise un <a href="#modules">m√©canisme de modules</a> (CommonJS)
diff√©rent des modules ECMAScript des navigateurs.</p>
</div>
<div class="paragraph">
<p>La convergence vers les modules ECMAScript est en cours.
Il y a fort √† parier qu&#8217;ils seront pris en charge nativement par Node dans une
version ult√©rieure.</p>
</div>
<div class="paragraph">
<p>Nous verrons au <a href="../chapter-08/index.html">chapitre&#160;9</a> comment utiliser
les modules Node dans les navigateurs.</p>
</div>
</div>
<div class="sect2">
<h3 id="linterfa√ßage_avec_le_syst√®me_dexploitation">5.4. L&#8217;interfa√ßage avec le syst√®me d&#8217;exploitation</h3>
<div class="paragraph">
<p>Les fonctions ECMAScript sp√©cifiques aux navigateurs sont li√©es
√† la r√©cup√©ration d&#8217;informations (<code>AJAX</code>, <code>fetch()</code>),
√† l&#8217;affichage (Canvas, WebGL, WebVR) ainsi qu&#8217;√† la manipulation de
documents&#160;HTML.</p>
</div>
<div class="paragraph">
<p>Les fonctions ECMAScript fournies par les <a href="#modules-builtin">modules Node</a>
sont li√©es √† la gestion des ressources dont le syst√®me d&#8217;exploitation
se fait l&#8217;interface&#160;: fichiers&#160;(<a href="#fs"><code>fs</code></a>),
r√©seau&#160;(<a href="#http"><code>http</code></a>, <a href="#net"><code>net</code></a>, <a href="#dns"><code>dns</code></a>,
<a href="#dgram"><code>dgram</code></a>), terminal&#160;(<a href="#tty"><code>tty</code></a>, <a href="#readline"><code>readline</code></a>)
et processus&#160;(<a href="#process"><code>process</code></a>, <a href="#child_process"><code>child_process</code></a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="node_est_un_processus_syst√®me">5.5. Node est un processus syst√®me</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le syst√®me d&#8217;exploitation cr√©e un nouveau processus d√®s
qu&#8217;on ex√©cute le programme <code>node</code>.
Il peut √™tre de courte ou de longue dur√©e, selon qu&#8217;il dure quelques secondes
ou un temps ind√©fini.</p>
</div>
<div class="paragraph">
<p>Le processus s&#8217;arr√™te en cas d&#8217;erreur, lorsqu&#8217;il n&#8217;y a plus d&#8217;op√©ration
√† effectuer ou en cas d&#8217;interruption volontaire.</p>
</div>
<div class="paragraph">
<p>Le code ECMAScript ex√©cut√© dans un navigateur d√©passe rarement la dur√©e
d&#8217;une session utilisateur, de quelques secondes √† quelques heures.
En cas de probl√®me, un rafra√Æchissement de la page remet √† z√©ro son&#160;√©tat.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performances</span> Utilisation des&#160;CPU</div>
<div class="paragraph">
<p>Un processus Node est <em>mono</em> CPU.
Tous les autres processus syst√®me affect√©s √† cette m√™me CPU
se partageront une quantit√© finie de puissance.</p>
</div>
<div class="paragraph">
<p>Par exemple, si un processus Node partage la m√™me CPU qu&#8217;une base de donn√©es
et si une requ√™te gourmande s&#8217;ex√©cute, la rapidit√© de notre application
en sera affect√©e.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="options">6. Options utiles pour d√©marrer&#160;Node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;ex√©cutable <code>node</code> accepte plusieurs options afin de personnaliser
son comportement et l&#8217;affichage des r√©sultats.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Ex√©cutable&#160;node</div>
<div class="paragraph">
<p>La documentation de l&#8217;ex√©cutable <code>node</code> est disponible sur le site officiel&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/cli.html" class="bare">nodejs.org/docs/latest-v10.x/api/cli.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="print-eval">6.1. Afficher le r√©sultat d&#8217;une expression, sans&#160;script</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;interpr√©teur Node sait interpr√©ter du code qu&#8217;on lui donne
via l&#8217;option&#160;<code>-p</code> (pour <em>print</em>, c&#8217;est-√†-dire <em>afficher</em>).
Il affiche le r√©sultat de l&#8217;expression ou d√©taille la <a href="#errors">raison de l&#8217;erreur</a>.</p>
</div>
<div class="paragraph">
<p>J&#8217;utilise cette forme d&#8217;interaction pour obtenir un r√©sultat rapide,
sans cr√©er de nouveau fichier, par exemple, pour une op√©ration math√©matique&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -p '2 + 2'
4</pre>
</div>
</div>
<div class="paragraph">
<p>Toute expression ECMAScript valide est accept√©e&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -p '"abc".toLocaleUpperCase()'
ABC</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="options-require">6.2. Pr√©charger un module</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;option de d√©marrage <code>--require</code> charge le module indiqu√© avant le script&#160;Node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --require ./print-exit.js url/intro.js</pre>
</div>
</div>
<div class="paragraph">
<p>Dans cet exemple, le <a href="#modules">module <code>print-exit.js</code></a> sera charg√©
avant <code>url/intro.js</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">print-exit.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>filename<span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>mainModule<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : arr√™t avec le code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le chargement de ce module aura pour effet d&#8217;afficher un message
avec le chemin du fichier charg√© et le <a href="#process.exit">code de sortie</a>.</p>
</div>
<div class="paragraph">
<p>On peut appeler l&#8217;option <code>--require</code> plusieurs fois, ou son raccourci&#160;`-r`.</p>
</div>
<div class="paragraph">
<p>Ce m√©canisme fonctionne tr√®s bien avec des
<a href="../chapter-05/index.html">modules&#160;<code>npm</code></a> con√ßus pour
rendre nos scripts <a href="#esm">compatibles avec les modules ECMAScript</a>
ou pour <a href="#pretty-error">simplifier les erreurs</a> affich√©es
lors d&#8217;un plantage applicatif, entre autres.</p>
</div>
</div>
<div class="sect2">
<h3 id="inspect">6.3. Inspecter notre code avec Google&#160;Chrome</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Node accepte deux options <code>--inspect</code> et <code>--inspect-brk</code>.
Elles exposent un protocole de d√©bogage auquel on peut se connecter
avec le navigateur Chrome.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --inspect-brk print-text.js texte --uppercase
Debugger listening on ws://127.0.0.1:9229/ddd9bbfd-09ac-4426-a53e-c8abe4fc36da
For help see https://nodejs.org/en/docs/inspector</pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande lance un de nos exemples de la section
sur le <a href="#process">module&#160;<code>process</code></a>.
L&#8217;option <code>--inspect-brk</code> d√©marre l&#8217;inspecteur
et met aussit√¥t son ex√©cution en pause.</p>
</div>
<div class="paragraph">
<p>Le logo de Node s&#8217;affiche dans les outils de d√©veloppement de Chrome&#160;:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/chrome-devtools.png" alt="chrome devtools" width="85%">
</div>
<div class="title">Figure 8. Outils de d√©veloppement Google Chrome avec l&#8217;ic√¥ne de l&#8217;inspecteur&#160;Node</div>
</div>
<div class="paragraph">
<p>Un clic sur le logo Node ouvre une nouvelle fen√™tre, outill√©e pour inspecter
ce qui se passe dans notre script.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/inspector-paused.png" alt="inspector paused" width="85%">
</div>
<div class="title">Figure 9. Inspecteur en pause sur la premi√®re ligne de notre script&#160;Node</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">üí°</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Outils de d√©veloppement</span> Point d&#8217;arr√™t</div>
<div class="paragraph">
<p>Un point d&#8217;arr√™t se cr√©e en cliquant sur le num√©ro de ligne souhait√©.</p>
</div>
<div class="paragraph">
<p>Le d√©bogueur se mettra en pause √† chaque fois que le chemin d&#8217;ex√©cution
de l&#8217;interpr√©teur atteindra cette ligne.</p>
</div>
<div class="paragraph">
<p>La valeur des variables ECMAScript courantes s&#8217;affichent au survol de la souris
ou en interagissant avec la console.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/inspector-breakpoint.png" alt="inspector breakpoint" width="85%">
</div>
<div class="title">Figure 10. Inspecteur en pause, avec un point d&#8217;arr√™t marqu√© sur une des lignes du&#160;script</div>
</div>
<div class="paragraph">
<p>C&#8217;est le moment id√©al pour placer un ou plusieurs point(s) d&#8217;arr√™t.</p>
</div>
<div class="paragraph">
<p>Un clic sur le bouton&#160;<b class="button">&#9654;</b> met alors fin √† la pause.
Le script s&#8217;ex√©cutera jusqu&#8217;√† l&#8217;√©puisement des instructions
ou jusqu&#8217;au <em>prochain point d&#8217;arr√™t</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/inspector-breakpoint-in.png" alt="inspector breakpoint in" width="85%">
</div>
<div class="title">Figure 11. Inspecteur en pause, suite √† la rencontre d&#8217;un point d&#8217;arr√™t</div>
</div>
<div class="paragraph">
<p>L&#8217;option <code>--inspect</code> est adapt√©e √† des processus de longue dur√©e,
comme un serveur HTTP.
L&#8217;option <code>--inspect-brk</code> est adapt√©e √† des processus de courte dur√©e et qui
se termineraient avant qu&#8217;on ait le temps de jeter un ≈ìil au contenu.</p>
</div>
</div>
<div class="sect2">
<h3 id="options-v8">6.4. Ajuster les options de compatibilit√© et de tra√ßabilit√© de&#160;V8</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Node repose sur la <a href="../chapter-01/index.html#v8">machine virtuelle&#160;V8</a>
pour interpr√©ter nos instructions ECMAScript et en expose diff√©rentes options
pour affiner son comportement en fonction
de notre environnement.</p>
</div>
<div class="paragraph">
<p>L&#8217;int√©gralit√© des options de configuration de&#160;V8 s&#8217;affiche
avec l&#8217;option <code>--v8-options</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --v8-options</pre>
</div>
</div>
<div class="paragraph">
<p>Il n&#8217;y a pas de meilleure configuration qui conviendrait √† chacun de nos usages.
Le mieux reste encore d&#8217;explorer les options possibles, les diff√©rents concepts
et d&#8217;ajuster les valeurs offrant le meilleur rapport stabilit√©/performances.</p>
</div>
<div class="dlist">
<div class="title">Options notables de V8</div>
<dl>
<dt class="hdlist1"><code>--optimize_for_size</code></dt>
<dd>
<p>Optimise le fonctionnement interne pour utiliser moins de m√©moire,
au d√©triment de la vitesse.
Id√©al pour l&#8217;ex√©cution de scripts Node sur des environnements √† faible m√©moire,
comme les Raspberry&#160;Pi.</p>
</dd>
<dt class="hdlist1"><code>--mem_old_space_limit</code></dt>
<dd>
<p>D√©termine la quantit√© de m√©moire maximale qu&#8217;un processus Node pourra utiliser.
Id√©al pour le confiner sur des environnements √† faible m√©moire.</p>
</dd>
<dt class="hdlist1"><code>--gc_inverval</code></dt>
<dd>
<p>D√©termine le nombre de cycles entre chaque d√©clenchement du ramasse-miettes.</p>
</dd>
<dt class="hdlist1"><code>--expose_gc</code></dt>
<dd>
<p>Expose les fonctions de manipulation du ramasse-miettes.
Id√©al si vous souhaitez contr√¥ler finement l&#8217;optimisation de la m√©moire.</p>
</dd>
<dt class="hdlist1"><code>--stack_trace_limit</code></dt>
<dd>
<p>Change la limite du nombre de lignes affich√©es dans une trace d&#8217;erreur
(10 par d√©faut).</p>
</dd>
<dt class="hdlist1"><code>--trace-deopt</code></dt>
<dd>
<p>Signale les optimisations invalid√©es par&#160;V8.
Les portions de code indiqu√©es gagneraient √† √™tre retravaill√©es, pour rendre
uniforme le type de variables pass√©es en arguments par exemple.</p>
</dd>
<dt class="hdlist1"><code>--trace-gc</code></dt>
<dd>
<p>Signale les moments o√π le ramasse-miettes se d√©clenche.
On peut ainsi mieux en comprendre les raisons.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">üí¨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Notion</span> Ramasse-miettes (<em>garbage collector</em>)</div>
<div class="paragraph">
<p>Le ramasse-miettes est un m√©canisme informatique qui lib√®re les objets inutilis√©s
de la m√©moire.
Il est d√©clench√© de mani√®re cyclique par la
<a href="../chapter-01/index.html#v8">machine virtuelle&#160;V8</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://fr.wikipedia.org/wiki/Ramasse-miettes_(informatique" class="bare">fr.wikipedia.org/wiki/Ramasse-miettes_(informatique</a>)</span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les options pr√©fix√©es par <code>harmony</code> activent la prise en charge
de fonctionnalit√©s ECMAScript qui ne font pas encore partie du standard.
Elles sont encore au stade exp√©rimental.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">7. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les modules de base sont un √©l√©ment diff√©renciant entre Node et le langage
ECMAScript.
Ils nous interfacent avec le syst√®me d&#8217;exploitation pour naviguer dans les fichiers,
ouvrir des connexions r√©seau et t√©l√©charger des fichiers distants.
<strong>Bien les conna√Ætre nous aidera au quotidien</strong>.</p>
</div>
<div class="paragraph">
<p>L&#8217;organisation des modules CommonJS&#160;‚Äì voire des modules ECMAScript&#160;‚Äì est l&#8217;autre
√©l√©ment majeur de ce chapitre.
Avec cela, nous rendons notre <strong>code modulaire, r√©utilisable et donc testable</strong>.</p>
</div>
<div class="paragraph">
<p>Toutes ces connaissances seront largement r√©utilis√©es dans les chapitres suivants.
Elles nous aideront √† mieux choisir nos modules&#160;<code>npm</code> dans le chapitre&#160;5,
√† structurer une application web au chapitre&#160;7, √† cr√©er de belles applications
en ligne de commande au chapitre&#160;8 et m√™me √† partager du code entre Node
et les navigateurs au chapitre&#160;9.</p>
</div>
</div>
</div>
</div>
<section class="next">
  <a href="#top">Haut de page</a> ou
  <a href="https://oncletom.io/node.js/#apprendre-node-js-en-ligne" class="read-more">retour au sommaire</a>.
</section>
</body>
</html>