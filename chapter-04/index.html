<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Jouer avec Node.js</title>
<style>
#header,
#content,
#footer {
  margin: 2rem auto;
  max-width: 46rem;
}

#header {
  margin-top: 0;
}

.title,
#toctitle {
  color: var(--dark-accent);
}

a {
  /* white-space: nowrap; */
}

img, iframe, video, audio {
  max-width: 100%;
}

p {
  font-weight: normal;
}

/* Taken out from book.css */
dl dt {
  margin-bottom: 0.3125em;
  font-weight: bold;
}
dl dd {
  margin-bottom: 1.25em;
}

dt,
th.tableblock,
td.content,
div.footnote {
  text-rendering: optimizeLegibility;
}

.literalblock pre,
.literalblock pre[class],
.listingblock pre,
.listingblock pre[class] {
  overflow: auto;
  word-wrap: break-word;
}
.literalblock pre.nowrap,
.literalblock pre[class].nowrap,
.listingblock pre.nowrap,
.listingblock pre[class].nowrap {
  overflow-x: auto;
  white-space: pre;
  word-wrap: normal;
}

.listingblock {
  margin: 0 0 2em;
}
.listingblock > .content {
  position: relative;
}
.listingblock > .title {
  font-weight: bold;
}
.listingblock code[data-lang]::before {
  display: none;
  content: attr(data-lang);
  position: absolute;
  font-size: 0.75em;
  top: 1em;
  right: 1em;
  line-height: 1;
  text-transform: uppercase;
  color: #999;
}
.listingblock:hover code[data-lang]::before {
  display: block;
}
.listingblock.terminal pre .command::before {
  content: attr(data-prompt);
  padding-right: 0.5em;
  color: #999;
}

td.hdlist1,
td.hdlist2 {
  vertical-align: top;
  padding-right: 0.625em;
}
td.hdlist1 {
  font-weight: bold;
}
.literalblock + .colist,
.listingblock + .colist {
  margin-top: -1.5em;
}
.colist td:not([class]):first-child {
  padding: 0.4em 0.75em 0 0.75em;
  line-height: 1;
  vertical-align: top;
}
.colist td:not([class]):first-child img {
  max-width: none;
}
.colist td:not([class]):last-child {
  padding: 0.25em 0;
}

/* Custom classes */

.line-through {
  text-decoration: line-through;
}

.RemarquePreTitre,
#toctitle {
  font-style: normal;
  font-weight: bold;
}
  .RemarquePreTitre::after {
    content: "•";
    padding-left: 5px;
  }
.admonitionblock {
}
.admonitionblock > table,
.exampleblock {
  --commented: rgba(17, 17, 68, .65);
  --border-radius-base: 8px;

  background-color: #fafafa;
  border: 1px solid var(--dark-shade);
  border-left: none;
  border-right: none;
  margin: 1.5em 0;
  padding: 1em;
}
.exampleblock .title {
  font-weight: bold;
}
.icon .title {
  font-size: 2em;
}
  .admonitionblock > table td.icon {
    display: none;
  }

  @media screen and (min-width: 769px) {
    .admonitionblock > table td.icon {
      display: table-cell;
    }
  }

  .admonitionblock > table td.icon {
    padding-right: 1em;
  }
  .admonitionblock > table td.icon img {
    max-width: none;
  }

.colist ol {
  margin-left: 1.5em;  /* aligns with the listing edge */
  padding-left: 0;
  font-weight: bold;   /* makes it stand out more */
}
  .colist ol p {
    margin: 0 0 .5em;
  }
.listingblock:not(.prismjs) pre,
.language-bash.hljs {
  background: #323232;
  color: wheat;
  margin: 0;
  padding: 1rem;
}
.language-bash.hljs .hljs-built_in,
.language-bash.hljs .hljs-builtin-name {
  color: white;
}
.language-bash.hljs .hljs-string {
  color: lightgreen;
}
.language-bash.hljs .hljs-variable {
  color: lightskyblue;
}
.keyseq {
  font-weight: normal;
  white-space: nowrap;
}
.language-bash.hljs .keyseq {
  color: white;
}
.language-bash.hljs kbd {
  background: transparent;
  box-shadow: none;
  color: white;
  font-size: 0.8em;
  font-weight: bold;
  padding: 0.1em 0.4em;
}
.listingblock pre.highlightjs,
.listingblock.prismjs pre {
  background-color: transparent;
  margin: 0;
  padding: 0;
}
.listingblock pre.highlightjs > code,
.listingblock.prismjs .highlight {
  border-left: 4px solid var(--dark-accent);
  padding-left: 1em;
  font-size: .8em;
}
.listingblock pre.highlightjs > code.language-bash {
  border-left-color: limegreen;
}

.hdlist .hdlist1 {
  text-align: right;
  white-space: nowrap;
}

td > p:first-child {
  margin-top: 0;
}

.hljs-comment {
  font-style: normal !important;
}

#toc.toc2 a {
  text-decoration: none;
  white-space: normal;
}
  #toc.toc2 a:hover,
  #toc.toc2 a:focus {
    text-decoration: underline;
  }

#toc.toc2 ul {
  list-style: none;
}

  #toc.toc2 > ul {
    padding-left: 0;
  }

  #toc.toc2 ul ul {
    padding-left: 1em;
  }

@media screen and (min-width: 769px) {
  body {
    padding-left: 25vw !important;
  }

  #header,
  #content,
  #footer {
    margin-left: 0;
  }

  #toc.toc2 {
    height: 100%;
    left: 0;
    max-width: 20vw;
    overflow: auto;
    padding: 1rem;
    position: fixed;
    top: 0;
    z-index: 1000;
  }

  #toc.toc2 > ul {
    font-size: 0.85em;
  }

  #toc li.active > a[href^="#"],
  [id]:target {
    background: #ffc;
  }
}

.admonitionblock.context-callout > table {
  border-width: 5px;
  border-color: var(--brand-color);
}

</style>
<link rel="stylesheet" href="https://oncletom.io/styles/blog.css?v=v3.3.2">
<!-- WebMentions -->
<link rel="pingback" href="https://webmention.io/oncletom.io/xmlrpc">
<link rel="webmention" href="https://webmention.io/oncletom.io/webmention">
<!-- Open Graph -->
<meta property="og:type" content="book">
<meta property="og:book:author" content="Thomas Parisot">
<meta property="og:book:isbn" content="978-2212139938">
<meta property="og:book:release_date" content="978-2212139938">
<meta property="og:book:tag" content="Node.js">
<meta property="og:book:tag" content="JavaScript">
<meta property="og:book:tag" content="npm">
<meta property="og:book:tag" content="Développement front-end">
<meta property="og:book:tag" content="Développement back-end">
<meta property="og:locale" content="fr_FR">
<meta property="og:site_name" content="Node.js • Apprendre par la pratique">
<!-- Twitter OpenGraph -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@oncletom">
<meta name="twitter:creator" content="@oncletom">
<style type="text/css" class="prism-theme">/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<style type="text/css" class="extension-interactive-runner">[data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
  background-color: #fcfcfc;
  border: 1px solid #0c2;
  border-radius: 1px;
  color: #0c2;
  cursor: pointer;
  display: inline-block;
  font-weight: bold;
  padding: .5em 1em;
  top: -2em;
}

  [lang="en"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "▶ run code";
  }
  [lang="fr"] [data-interactive-runtime="loaded"] .interactive--javascript code[data-lang]:before {
    content: "▶ voir le résultat";
  }
  .interactive--javascript code[data-label]:before {
    content: attr(data-label);
  }

.interactive iframe {
  position: absolute;
  visibility: hidden;
}

.interactive.status--loaded iframe {
  position: inherit;
  visibility: visible;
}

.interactive.status--loading {
  opacity: .5;
}
</style>
<script class="extension-interactive-runner">
(function(d){
  document.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://embed.runkit.com/';
    script.async = true;
    script.onload = function(){
      function makeListingInteractive (element){
  if (element.classList.contains('interactive--installed') || element.classList.contains('status--loading')) {
    return;
  }

  const code = element.querySelector('code');
  const nodeVersion = /interactive--runtime--node-([^\s]+)/.exec(element.className)[1];
  const isEndpoint = element.classList.contains('interactive--endpoint');
  const mode = isEndpoint ? 'endpoint' : null;
  let preamble = '';

  const source = code
    .textContent
    .replace(/\/\/\s*\(\d+\)$/gm, '')
    .replace(/^["']?use strict["'][; ]*\n/, '');

  if (isEndpoint) {
    preamble = `process.nextTick(() => {
      if (typeof module.exports === 'function') {
        exports.endpoint = module.exports;
      }
      else if (typeof server !== 'undefined') {
        exports.endpoint = server.listeners("request").pop();
      }
});`
  }

  element.classList.add('status--loading');

  // eslint-disable-next-line no-undef
  RunKit.createNotebook({
    nodeVersion,
    element,
    source,
    mode,
    preamble,
    onLoad: function(ntbk) {
      element.classList.add('interactive--installed');
      element.classList.remove('status--loading');
      element.classList.add('status--loaded');
      code.parentNode.setAttribute('hidden', true);

      ntbk.evaluate();
    }
  });
}
function installEvents () {
  function getParent(el, condition) {
    let parent = el;

    while(parent = parent.parentNode) {
      if (condition(parent)) {
        return parent;
      }
    }
  }

  function hasClass(className) {
    return function check(el) {
      return el.classList.contains(className);
    }
  }

  document.querySelector('body').addEventListener('click', function(el) {
    if (el.target.classList.contains('language-javascript') || el.target.classList.contains('language-js')) {
      const parentNode = getParent(
        el.target,
        hasClass('interactive--javascript')
      );

      makeListingInteractive(parentNode);
    }
  });
}
      installEvents();
      document.body.dataset.interactiveRuntime = 'loaded';
    };
    document.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
.listingblock [data-bash-subs]::before {
  content: attr(data-bash-subs) " ";
  opacity: .5; }

.listingblock [data-bash-conum]::before {
  content: "(" attr(data-bash-conum) ")";
  font-weight: bold;
  opacity: .7;
}</style>
<script>
(function(d){
  d.addEventListener('DOMContentLoaded', function(){
    const script = d.createElement('script');
    script.src = 'https://unpkg.com/menuspy@1.3.0/dist/menuspy.js';
    script.async = true;
    script.onload = () => new MenuSpy(document.querySelector('#toc'), {enableLocationHash: false});
    d.body.appendChild(script);
  });
})(document);</script>
<style type="text/css">
#toc li.active > a[href^="#"] {
  font-weight: bold;
}
#toc li.active > a[href^="#"]::before {
  content: "▶ ";
  display: inline-block;
  position: absolute;
  margin-left: -1.2em;
  font-size: .8em;
  margin-top: 3px;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Jouer avec Node.js</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table des matières</div>
<ul class="sectlevel1">
<li><a href="#interagir_avec_linterpréteur_node">1. Interagir avec l&#8217;interpréteur Node</a>
<ul class="sectlevel2">
<li><a href="#node-version">1.1. Afficher la version</a></li>
<li><a href="#script">1.2. Avec un script</a></li>
<li><a href="#repl">1.3. Avec l&#8217;invite de commandes interactive (REPL)</a></li>
</ul>
</li>
<li><a href="#modules-builtin">2. Les modules de base</a>
<ul class="sectlevel2">
<li><a href="#console">2.1. console : déboguer rapidement des variables</a></li>
<li><a href="#path">2.2. path : manipuler des chemins de&#160;fichiers</a></li>
<li><a href="#url">2.3. url : manipuler des URL</a></li>
<li><a href="#fs">2.4. fs : manipuler le système de fichiers</a></li>
<li><a href="#events">2.5. events : programmer des événements</a></li>
<li><a href="#util">2.6. util : transformer des fonctions de rappel en promesses</a></li>
<li><a href="#http">2.7. http : créer et interroger des ressources via le protocole&#160;HTTP</a></li>
<li><a href="#os">2.8. os : en savoir plus sur les capacités de l&#8217;ordinateur</a></li>
<li><a href="#child_process">2.9. child_process : appeler un exécutable système</a></li>
<li><a href="#process">2.10. process : en savoir plus sur le processus en cours</a></li>
<li><a href="#stream">2.11. stream : manipuler des flux de données</a></li>
<li><a href="#dautres_modules_pour_aller_plus_loin">2.12. D&#8217;autres modules pour aller plus loin</a></li>
</ul>
</li>
<li><a href="#modules">3. Créer ses propres modules Node</a>
<ul class="sectlevel2">
<li><a href="#modules.require">3.1. Importer et exporter des valeurs</a></li>
<li><a href="#require">3.2. Aller plus loin avec <code>require()</code></a></li>
<li><a href="#esm">3.3. Le futur : les modules ECMAScript</a></li>
</ul>
</li>
<li><a href="#errors">4. S&#8217;en sortir quand ça ne se passe pas comme&#160;prévu</a>
<ul class="sectlevel2">
<li><a href="#une_erreur_est_nichée_dans_notrecode">4.1. Une erreur est nichée dans notre&#160;code</a></li>
<li><a href="#une_erreur_est_retournée_dans_une_fonction_de_rappel">4.2. Une erreur est retournée dans une fonction de rappel</a></li>
<li><a href="#une_erreur_est_retournée_dans_une_promesse">4.3. Une erreur est retournée dans une promesse</a></li>
<li><a href="#une_erreur_est_retournée_dans_un_événement">4.4. Une erreur est retournée dans un événement</a></li>
<li><a href="#errors.system">4.5. Une erreur est renvoyée par le système d&#8217;exploitation</a></li>
<li><a href="#le_programme_ne_se_termine_pas">4.6. Le programme ne se termine pas</a></li>
<li><a href="#deprecation">4.7. Une alerte de dépréciation s&#8217;affiche</a></li>
</ul>
</li>
<li><a href="#les_différences_decmascript_entre_node_et_les_navigateursweb">5. Les différences d&#8217;ECMAScript entre Node et les navigateurs&#160;web</a>
<ul class="sectlevel2">
<li><a href="#labsence_du_dom_et_des_variables_window_et_document">5.1. L&#8217;absence du DOM et des variables <code>window</code> et <code>document</code></a></li>
<li><a href="#il_ny_a_pas_dinterface_graphique">5.2. Il n&#8217;y a pas d&#8217;interface graphique</a></li>
<li><a href="#le_mécanisme_de_modules">5.3. Le mécanisme de modules</a></li>
<li><a href="#linterfaçage_avec_le_système_dexploitation">5.4. L&#8217;interfaçage avec le système d&#8217;exploitation</a></li>
<li><a href="#node_est_un_processus_système">5.5. Node est un processus système</a></li>
</ul>
</li>
<li><a href="#options">6. Options utiles pour démarrer&#160;Node</a>
<ul class="sectlevel2">
<li><a href="#print-eval">6.1. Afficher le résultat d&#8217;une expression, sans&#160;script</a></li>
<li><a href="#options-require">6.2. Précharger un module</a></li>
<li><a href="#inspect">6.3. Inspecter notre code avec Google&#160;Chrome</a></li>
<li><a href="#options-v8">6.4. Ajuster les options de compatibilité et de traçabilité de&#160;V8</a></li>
</ul>
</li>
<li><a href="#conclusion">7. Conclusion</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock tip context-callout">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="paragraph">
<p>Vous êtes en train de lire le
<a href="https://oncletom.io/node.js/">livre &#8220;Node.js&#8221;</a>, écrit par
<a href="https://oncletom.io">Thomas Parisot</a> et publié par les
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">Éditions Eyrolles</a>.</p>
</div>
<div class="paragraph">
<p>Il vous plaît&#160;? Achetez-le en ligne sur
<a href="https://amzn.to/2E58PEw">Amazon</a>,
<a href="https://www.eyrolles.com/Informatique/Livre/node-js-9782212139938/">Eyrolles</a> ou
<a href="https://www.placedeslibraires.fr/livre/9782212139938">Place des Libraires</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons faire un tour d&#8217;horizon des capacités de Node et de son système
de modules pour nous interfacer avec les systèmes d&#8217;exploitation Linux, macOS
et Windows.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Sommaire</div>
<ul>
<li>
<p>Interagir avec l&#8217;interpréteur&#160;Node</p>
</li>
<li>
<p>Les modules de base</p>
</li>
<li>
<p>Créer ses propres modules</p>
</li>
<li>
<p>S&#8217;en sortir quand ça ne se passe pas comme prévu</p>
</li>
<li>
<p>Les différences de JavaScript entre Node et les navigateurs&#160;web</p>
</li>
<li>
<p>Options utiles pour démarrer&#160;Node</p>
</li>
</ul>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Après avoir exécuté notre premier script Node, nous allons découvrir
l&#8217;étendue des modules Node et ce qu&#8217;ils nous offrent en termes de capacité
d&#8217;interaction avec le système d&#8217;exploitation&#160;– disque, réseau, calculs, etc.</p>
</div>
<div class="paragraph">
<p>Nous apprendrons ensuite à créer et organiser nos propres modules&#160;– nous
découvrirons comment les partager et les distribuer dans le chapitre 5.</p>
</div>
<div class="paragraph">
<p>Enfin, nous passerons en revue des erreurs typiques pour apprendre à les lire
et à mieux réagir avant de terminer sur des manières alternatives d&#8217;exécuter
des scripts Node, par exemple pour débogueur ou charger d&#8217;autres modules.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Versions de Node et npm</div>
<div class="paragraph">
<p>Le contenu de ce chapitre utilise les versions <strong>Node&#160;v10</strong>
et <strong>npm&#160;v6</strong>.
Ce sont les versions stables recommandées en&#160;2019.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interagir_avec_linterpréteur_node">1. Interagir avec l&#8217;interpréteur Node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;interpréteur Node est le programme qui nous fournit des résultats
en échange d&#8217;instructions ECMAScript.
Le terminal est un autre programme permettant de faire dialoguer
un ordinateur avec les programmes installés.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="paragraph">
<p>Le <a href="../chapter-02/index.html">chapitre 2</a> détaille comment installer
Node et un terminal.
Il contient également des conseils pour utiliser Node depuis un
navigateur web.
Cela peut rendre l&#8217;accès au terminal plus facile.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ce chapitre se base sur le principe que vous avez un terminal installé,
sur lequel vous allez saisir des instructions ECMAScript.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/terminal.png" alt="terminal" width="85%">
</div>
<div class="title">Figure 1. Exemple de terminal sous macOS</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Jouer avec les exemples dans un terminal</div>
<div class="paragraph">
<p>Les exemples titrés d&#8217;un nom de fichier peuvent être installés sur votre ordinateur.
Exécutez-les dans un terminal et amusez-vous à les modifier en parallèle de
votre lecture pour voir ce qui change.</p>
</div>
<div class="listingblock">
<div class="title">Installation des exemples via le module npm <code>nodebook</code></div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm install --global nodebook
<span data-bash-subs="$"></span>nodebook install chapter-04
<span data-bash-subs="$"></span>cd $(nodebook dir chapter-04)</pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante devrait afficher un résultat qui confirme que vous êtes
au bon endroit&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node hello.js</pre>
</div>
</div>
<div class="paragraph">
<p>Suivez à nouveau les instructions d&#8217;installation pour rétablir les exemples
dans leur état initial.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="node-version">1.1. Afficher la version</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Commençons par afficher la version de l&#8217;interpréteur Node.
Nous nous assurons ainsi que nous pouvons interagir avec
lui avec succès et qu&#8217;il est celui que nous attendons, dans la bonne version.
La version de Node conditionne la liste des fonctionnalités du langage
ECMAScript à disposition.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Compatibilité</span> Syntaxe ECMAScript</div>
<div class="paragraph">
<p>Le site web <span class="URL"><a href="https://node.green" class="bare">node.green</a></span> liste le niveau de compatibilité
des fonctionnalités ECMAScript.</p>
</div>
<div class="paragraph">
<p>Cette page vous aidera à comprendre quelles fonctionnalités utiliser en toute
sécurité, version par version de&#160;Node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Une fois votre terminal ouvert, saisissez la commande suivante&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --version</pre>
</div>
</div>
<div class="paragraph">
<p>Le numéro de version de l&#8217;interpréteur Node s&#8217;affiche alors,
par exemple <code>v10.9.0</code>.</p>
</div>
<div class="paragraph">
<p>Si c&#8217;est ce à quoi vous vous attendiez, passez à la suite.
À l&#8217;inverse, si une erreur se produit ou si la version
n&#8217;est pas la bonne, retournez à la section
&#8220;<a href="../chapter-02/index.html#install">Installer Node.js</a>&#8221; du chapitre&#160;2.</p>
</div>
</div>
<div class="sect2">
<h3 id="script">1.2. Avec un script</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;exécution d&#8217;un script Node est très certainement la pratique la plus courante.</p>
</div>
<div class="paragraph">
<p>L&#8217;interpréteur Node lit le contenu d&#8217;un fichier et exécute les instructions.
L&#8217;interpréteur reste actif jusqu&#8217;à ce que toutes les instructions
soient traitées.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">script.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">.</span><span class="token function">toLocaleUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier exemple <code>script.js</code> contient deux instructions.
Node les interprète lorsqu&#8217;on lui passe le chemin du fichier en paramètre
dans une invite de commandes&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node script.js
4
ABC</pre>
</div>
</div>
<div class="paragraph">
<p>Node nous rend ensuite la main pour exécuter d&#8217;autres commandes.</p>
</div>
<div class="paragraph">
<p>On apprendra à passer des <a href="#process.argv">arguments d&#8217;exécution</a>
dans la section sur le <a href="#process">module <code>process</code></a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performances</span> Ressources machine</div>
<div class="paragraph">
<p>Démarrer un processus Node a un coût incompressible en ressources machine&#160;:
environ <strong>30&#160;Mo de&#160;RAM</strong> et <strong>40&#160;ms de CPU</strong> avant d&#8217;exécuter nos
instructions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="repl">1.3. Avec l&#8217;invite de commandes interactive (REPL)</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;invite de commandes interactive est un moyen de parler
à l&#8217;interpréteur Node sans écrire de fichier.
Je l&#8217;utilise pour tester des idées et des éléments de syntaxe
quand je ne m&#8217;en rappelle&#160;plus.</p>
</div>
<div class="paragraph">
<p>Le mode interactif s&#8217;active en exécutant Node sans aucun argument&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span></pre>
</div>
</div>
<div class="paragraph">
<p>On notera au passage que l&#8217;invite est préfixée par le caractère&#160;`&gt;`
afin de marquer notre présence dans un environnement différent.
On retrouve un comportement similaire dans les invites de commande
des langages Ruby&#160;(<code>irb</code>), Python&#160;(<code>python</code>) et PHP&#160;(<code>php -a</code>)</p>
</div>
<div class="paragraph">
<p>Lorsque nous sommes dans l&#8217;interpréteur interactif,
toutes les expressions sont interprétées par Node&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>2 + 2
4
<span data-bash-subs=">"></span>"abc".toLocaleUpperCase()
'ABC'
<span data-bash-subs=">"></span></pre>
</div>
</div>
<div class="paragraph">
<p>Des expressions sont réservées pour obtenir de l&#8217;aide, sortir de l&#8217;interpréteur
ou simplement nettoyer ce que l&#8217;on voit à l&#8217;écran.
Pour cela on fait appel à l&#8217;instruction <code>.help</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>.help
.break    Sometimes you get stuck, this gets you out
.clear    Alias for .break
.editor   Enter editor mode
.exit     Exit the repl
.help     Print this help message
.load     Load JS from a file into the REPL session
.save     Save all evaluated commands in this REPL session to a file</pre>
</div>
</div>
<div class="paragraph">
<p>



</p>
</div>
<div class="paragraph">
<p>Les touches ou combinaisons de touches suivantes sont utiles pour naviguer dans
l&#8217;invite de commandes&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> annule
la saisie de la ligne en cours&#160;– c&#8217;est <span class="keyseq"><kbd>⌃</kbd>+<kbd>C</kbd></span> sous macOS.</p>
</li>
<li>
<p><kbd>&#11014;</kbd> et <kbd>&#11015;</kbd> aident à naviguer dans l&#8217;historique des commandes.</p>
</li>
<li>
<p><kbd>TAB</kbd> tente de compléter la saisie avec une expression ou variable connue.

</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>conso<kbd>TAB</kbd>
<span data-bash-subs=">"></span>console
<span data-bash-subs=">"></span>console.<kbd>TAB</kbd>
...
console.assert                console.clear                 console.count
...</pre>
</div>
</div>
<div class="paragraph">
<p>On notera que l&#8217;utilisation de <kbd>TAB</kbd> après un caractère <em>point</em>&#160;(<code>.</code>)
liste l&#8217;intégralité des propriétés de cet objet.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Afficher toutes les variables connues</div>
<div class="paragraph">
<p>La touche <kbd>TAB</kbd> affiche toutes les variables connues
de la session interactive en cours.
Il suffit d&#8217;appuyer une ou deux fois dessus dans une invite vide&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span><kbd>TAB</kbd><kbd>TAB</kbd>
Array                         Boolean                       Date
Error                         EvalError                     Function
Infinity                      JSON                          Math
NaN                           Number                        Object
...</pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est un excellent moyen de découvrir des éléments du langage qui nous
étaient inconnus jusque-là.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La sortie de l&#8217;invite de commandes se fait à l&#8217;aide de
l&#8217;utilisation répétée de la combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>
(ou <span class="keyseq"><kbd>⌃</kbd>+<kbd>C</kbd></span> sous macOS).
On revient ainsi à l&#8217;état initial où l&#8217;on était avant de
saisir la commande&#160;`node`&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>
(To exit, press ^C again or type .exit)
<span data-bash-subs=">"></span>
<span data-bash-subs="$"></span></pre>
</div>
</div>
<div class="paragraph">
<p>Ce même résultat s&#8217;obtient en saisissant <code>.exit</code>
ou en utilisant la combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>D</kbd></span> (ou <span class="keyseq"><kbd>⌃</kbd>+<kbd>D</kbd></span> sous macOS).

</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Variable magique&#160;<code>_</code></div>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>La variable&#160;<code>_</code> est spécifique à l&#8217;invite de commandes Node.
Elle contient systématiquement le résultat retourné par
la dernière évaluation de code&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node
<span data-bash-subs=">"></span>2 + 2
4
<span data-bash-subs=">"></span>_ + 2
6</pre>
</div>
</div>
<div class="paragraph">
<p>Elle est équivalente à la variable&#160;<code>$_</code> dans la console
des outils de développement des navigateurs web.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modules-builtin">2. Les modules de base</h2>
<div class="sectionbody">
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Les modules de base <strong>étendent le champ d&#8217;action de Node</strong>.
Ils servent d&#8217;interfaces pour communiquer avec le système d&#8217;exploitation,
le système de fichiers, des ressources HTTP et des connexions réseau, entre autres.
Ils sont inclus avec chaque installation de Node.
On peut donc en bénéficier sans effort supplémentaire.</p>
</div>
<div class="paragraph">
<p>Un module de base se charge en passant son identifiant
à la fonction <code>require()</code>, qui retourne alors un objet avec un certain nombre
de propriétés et de fonctions.</p>
</div>
<div class="paragraph">
<p>Ainsi, on charge le <a href="#fs">module <code>fs</code></a> (pour <em>file system</em>&#160;– <em>système de fichiers</em>)
afin d&#8217;interagir avec les fichiers et les répertoires présents sur l&#8217;ordinateur&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/read-dir.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(1)</b></span>

fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On charge les fonctions et attributs du module <code>fs</code> dans la variable du même nom (on pourrait l&#8217;appeler autrement).</p>
</li>
<li>
<p>L&#8217;appel à la fonction <code>fs.readdir()</code> passe un objet d&#8217;erreur ainsi que la liste des fichiers et répertoires contenus dans le chemin indiqué.</p>
</li>
<li>
<p>Affiche un tableau contenant les noms de fichiers et de répertoires présents dans le dossier courant.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ces modules de base représentent la pierre angulaire de nos applications Node.
Ils fournissent le nécessaire pour tout faire&#160;!
On apprendra à étendre encore plus le champ des possibles dans
le <a href="../chapter-05/index.html">chapitre&#160;5</a>,
grâce aux <a href="../chapter-05/index.html#modules">modules&#160;<code>npm</code></a>.
</p>
</div>
<div class="paragraph">
<p>Les modules de base changent au fil du temps&#160;:
les nouvelles versions de Node ajoutent, corrigent et complètent les modules et
fonctions existants.
La documentation officielle de Node reflète ces changements et
affiche un indice de stabilité pour savoir à quoi s&#8217;en&#160;tenir.
</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/api-fs.png" alt="api fs" width="85%">
</div>
<div class="title">Figure 2. Documentation du module <code>fs</code> et son indice de stabilité</div>
</div>
<div class="paragraph">
<p>Exceptionnellement, un module de base (ou une de ses fonctions) peut être supprimé.
L&#8217;équipe de Node annonce ces changements en dépréciant le module en question&#160;:
le code reste en place et sera supprimé dans une version ultérieure.
En général, c&#8217;est une question de mois voire d&#8217;années.
On verra plus loin comment <a href="#deprecation">afficher les alertes de dépréciation</a>.
</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/api-deprecation-fs-exists.png" alt="api deprecation fs exists" width="85%">
</div>
<div class="title">Figure 3. Documentation de la fonction <code>fs.exists()</code>, affichée comme dépréciée depuis Node&#160;v1</div>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Lecture des indices de stabilité</div>
<div class="paragraph">
<p>Node communique un indice de stabilité pour les modules de base.
Cette échelle se décompose en trois niveaux&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Déprécié</strong>&#160;: le module sera supprimé dans une prochaine version majeure.
À l&#8217;avenir, il vaut mieux ne pas se compter dessus.</p>
</li>
<li>
<p><strong>Expérimental</strong>&#160;: le module est en cours de développement.
Une fonctionnalité expérimentale peut changer radicalement entre deux
versions de Node.</p>
</li>
<li>
<p><strong>Stable</strong>&#160;: on peut faire confiance à ce module.
Des choses peuvent changer exceptionnellement mais l&#8217;intention est d&#8217;offrir
une stabilité.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;indice est parfois appliqué à des fonctions dont les attentes
changeraient d&#8217;une version à l&#8217;autre de&#160;Node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les sections suivantes illustrent des usages courants des modules de base
pour mieux comprendre ce qu&#8217;on peut en attendre et comment les utiliser.</p>
</div>
<div class="sect2">
<h3 id="console">2.1. console : déboguer rapidement des variables</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;objet <code>console</code> est une boîte à outils pour afficher
ce qui se passe à un moment donné dans un de nos scripts.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">console/log.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

count<span class="token operator">++</span><span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Valeur de count :'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La fonction écrit les messages et la valeur des variables dans la
<a href="#process.std">sortie standard</a> du terminal&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node console/log.js
Valeur de count : 3</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Variable globale console</div>
<div class="paragraph">
<p>Node charge automatiquement le module pour nous et
le rend utilisable à tout moment à travers la variable globale <code>console</code>.</p>
</div>
<div class="paragraph">
<p>Il est donc inutile de charger le module manuellement avec <code>require('console')</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>console.log()</code> sait interpoler les valeurs passées en argument avec le marqueur&#160;<code>%s</code>.
C&#8217;est utile pour structurer un message complexe en gardant les variables à part&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">console/interpolate.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Soupe %s et carottes'</span><span class="token punctuation">,</span> <span class="token string">'lentilles'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>Soupe lentilles et carottes</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>%s</code>&#160;ne sait afficher que des chaînes de caractères.
D&#8217;autres marqueurs savent afficher d&#8217;autres types de données&#160;:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>%d</code>
</td>
<td class="hdlist2">
<p>Affiche la valeur en tant que <a href="../chapter-03/index.html#number">nombre</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>%j</code>
</td>
<td class="hdlist2">
<p>Affiche la valeur en tant que <a href="../chapter-03/index.html#json">structure&#160;JSON</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>%O</code>
</td>
<td class="hdlist2">
<p>Affiche l&#8217;objet avec une profondeur maximum de 4&#160;éléments.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>%o</code>
</td>
<td class="hdlist2">
<p>Idem que&#160;<code>%O</code> mais sur une profondeur maximum de 2&#160;éléments.</p>
</td>
</tr>
</table>
</div>
<div class="hdlist">
<div class="title">Propriétés notables</div>
<table>
<tr>
<td class="hdlist1">
<code>console.log()</code>
</td>
<td class="hdlist2">
<p>Affichage de messages et de variables dans le terminal.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>console.error()</code>
</td>
<td class="hdlist2">
<p>Comportement identique à <code>console.log()</code> mais à réserver aux erreurs.
La fonction écrit dans la <a href="#process.std">sortie erreur</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>console.dir()</code>
</td>
<td class="hdlist2">
<p>Affichage dédié aux objets et tableaux.
On peut paramétrer la profondeur d&#8217;affichage
(par défaut, jusqu&#8217;à deux niveaux).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>console.group()</code>
</td>
<td class="hdlist2">
<p>Regroupe visuellement les appels à <code>console.log</code> et <code>console.error</code>.
Un groupe se clôt avec <code>console.groupEnd()</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>console.time()</code>
</td>
<td class="hdlist2">
<p>Démarre un chronomètre en lui attribuant un nom.
Le chronomètre s&#8217;arrête et sa durée s&#8217;affiche avec <code>console.timeEnd()</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
classe <code>Console</code>
</td>
<td class="hdlist2">
<p>  Crée un objet similaire à <code>console</code> mais en dirigeant l&#8217;affichage ailleurs
  que vers les <a href="#process.std">flux standards</a>.




</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Web</span> Console et navigateurs&#160;web</div>
<div class="paragraph">
<p>L&#8217;objet <code>console</code> est originaire du monde des navigateurs web.
C&#8217;est un onglet de la boîte à outils de développement.
On peut y lire des messages placés dans le code JavaScript de la page web.
On l&#8217;utilise aussi pour inspecter la page et interagir avec du&#160;code.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/web-console.png" alt="web console">
</div>
<div class="title">Figure 4. Console web dans le navigateur web Firefox</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module console</div>
<div class="paragraph">
<p>La documentation du module <code>console</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/console.html" class="bare">nodejs.org/docs/latest-v10.x/api/console.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="path">2.2. path : manipuler des chemins de&#160;fichiers</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le module <code>path</code> offre un ensemble de fonctions et de propriétés pour
manipuler et construire des chemins vers des fichiers et répertoires.</p>
</div>
<div class="paragraph">
<p>Ces opérations permettent à notre code de fonctionner de manière identique
sur des systèmes d&#8217;exploitation qui expriment différemment les chemins&#160;–
Linux et Windows par exemple.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token string">'/tmp/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/tmp/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'/tmp/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>/tmp</code>.</p>
</li>
<li>
<p>Affiche <code>package.json</code>.</p>
</li>
<li>
<p>Affiche <code>.json</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Certaines fonctions comme <code>path.join()</code> tiennent compte de la nature du système
d&#8217;exploitation.
Le résultat d&#8217;un même appel de fonction sera différent, mais correspondra
à la même intention&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path/platform.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'tmp'</span><span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche&#160;<code>/</code> (<code>\</code>&#160;sous Windows).</p>
</li>
<li>
<p>Affiche <code>tmp/package.json</code>&#160;– <code>tmp\package.json</code> sous Windows.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On constate que <code>path.join()</code> assemble les chemins en utilisant la valeur de
<code>path.sep</code>.
Ce qui est bien pour nous, c&#8217;est qu&#8217;on n&#8217;a pas besoin d&#8217;y penser&#160;:
<strong>Node se charge de la compatibilité avec le système d&#8217;exploitation</strong>.</p>
</div>
<div class="paragraph">
<p>La différence de résultats se précise un peu plus lorsque l&#8217;on tente de calculer
des chemins complets, <em>relatifs à notre emplacement</em> actuel&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path/relative.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> relative_diff <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>
  <span class="token string">'/tmp/package.json'</span><span class="token punctuation">,</span> <span class="token string">'/tmp/source'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolve_diff <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
  <span class="token string">'/tmp/package.json'</span><span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'./source'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>relative_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resolve_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>../source</code> (<code>..\source</code> sous Windows)&#160;– c&#8217;est ce qu&#8217;il faut parcourir pour aller du premier chemin au second.</p>
</li>
<li>
<p>Affiche <code>/tmp/source</code> (<code>C:\tmp\source</code> sous Windows)&#160;– on constate que le chemin <em>résolu</em> est absolu, et intègre la lettre du lecteur sous Windows.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les résultats produits par les fonctions du module <code>path</code>
se combinent particulièrement bien avec celles <a href="#fs">du module&#160;<code>fs</code></a>, pour
accéder aux fichiers.
</p>
</div>
<div class="hdlist">
<div class="title">Propriétés notables</div>
<table>
<tr>
<td class="hdlist1">
<code>path.basename()</code>
</td>
<td class="hdlist2">
<p>Retourne le nom de fichier.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.dirname()</code>
</td>
<td class="hdlist2">
<p>Retourne le nom de répertoire.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.extname()</code>
</td>
<td class="hdlist2">
<p>Retourne l&#8217;extension d&#8217;un fichier.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.isAbsolute()</code>
</td>
<td class="hdlist2">
<p>Indique si le chemin est <em>absolu</em> ou&#160;non.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.join()</code>
</td>
<td class="hdlist2">
<p>Assemble des bouts de chemin.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.parse()</code>
</td>
<td class="hdlist2">
<p>Retourne des informations liées à la compréhension d&#8217;un chemin
(extension, nom de fichier, nom de répertoire).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.relative()</code>
</td>
<td class="hdlist2">
<p>Calcule le chemin relatif entre un chemin source et un de destination.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>path.resolve()</code>
</td>
<td class="hdlist2">
<p>Calcule un chemin absolu à partir de plusieurs bouts de chemin.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>path.sep</code>
</td>
<td class="hdlist2">
<p>  Retourne le caractère servant de séparateur de répertoires
  pour le système d&#8217;exploitation sur lequel est exécuté le script&#160;:
  <code>/</code>&#160;pour Linux et macOS, <code>\</code>&#160;pour Windows.







</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Compatibilité</span> Manipuler des chemins Windows sous Linux et vice-versa</div>
<div class="paragraph">
<p>On peut avoir besoin de manipuler des chemins Windows avec du code
exécuté sur un autre système d&#8217;exploitation comme Linux ou macOS.
C&#8217;est exactement ce que proposent les fonctions de <code>path.win32</code>.

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">path/win32.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">,</span>resolve<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>win32<span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'tmp'</span><span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'C:\\tmp'</span><span class="token punctuation">,</span> <span class="token string">'../etc'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On déstructure les fonctions depuis la variante <code>win32</code> du module <code>path</code>.</p>
</li>
<li>
<p>Affiche <code>tmp\package.json</code>.</p>
</li>
<li>
<p>Affiche <code>C:\etc</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;objet <code>path.posix</code> fonctionne de la même manière pour des chemins Linux.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module path</div>
<div class="paragraph">
<p>La documentation du module <code>path</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/path.html" class="bare">nodejs.org/docs/latest-v10.x/api/path.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="url">2.3. url : manipuler des URL</h3>
<div class="paragraph">
<p>


</p>
</div>
<div class="paragraph">
<p>Le module <code>url</code> offre des outils pour interpréter des URL, les transformer
et les assembler à nouveau sous forme de chaîne de caractères.
La variable <code>URL</code> (en majuscules) est disponible de manière globale.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://oncletom.io/node.js/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>oncletom.io</code>.</p>
</li>
<li>
<p>Affiche <code>/node.js/</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Web</span> Compatibilité avec les navigateurs</div>
<div class="paragraph">
<p>
La classe <code>URL</code> que nous utilisons dans Node est la même que dans les
navigateurs web modernes.
Son fonctionnement suit le standard <span class="URL"><a href="https://url.spec.whatwg.org" class="bare">url.spec.whatwg.org</a></span>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;objet retourné par le constructeur de <code>URL</code> est modifiable.
Il est ainsi possible de changer les parties de l&#8217;URL qui nous intéressent
et de récupérer une URL sous forme d&#8217;une chaîne de caractères&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/to-string.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://oncletom.io/node.js/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
example<span class="token punctuation">.</span>pathname <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
example<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">'#top'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code><a href="https://oncletom.io/#top" class="bare">oncletom.io/#top</a></code>&#160;– le chemin et le fragment ont été modifiés.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La fonction <code>format()</code> va plus loin que <code>url.toString()</code>.
Ses options contrôlent plus finement ce qui sera conservé ou retiré lors
de la conversion en chaîne de caractères.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/format.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>format<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://user:password@oncletom.io/#top?test=1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  auth<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  search<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  fragment<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">format</span><span class="token punctuation">(</span>example<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code><a href="https://oncletom.io/" class="bare">oncletom.io/</a></code>&#160;– les identifiants, l&#8217;ancre et les arguments ont été retirés par la fonction <code>format()</code>.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le constructeur <code>URL</code> accepte une URL de référence en second argument.
Cette adresse résout un chemin absolu à partir du premier argument&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/resolve.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> url1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'/node.js/'</span><span class="token punctuation">,</span> <span class="token string">'https://oncletom.io'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'https://oncletom.io/node.js/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code><a href="https://oncletom.io/node.js/" class="bare">oncletom.io/node.js/</a></code>.</p>
</li>
<li>
<p>Affiche <code><a href="https://oncletom.io/" class="bare">oncletom.io/</a></code>.</p>
</li>
</ol>
</div>
<div class="hdlist">
<div class="title">Propriétés notables</div>
<table>
<tr>
<td class="hdlist1">
<code>url.parse()</code>
</td>
<td class="hdlist2">
<p>Transforme une chaîne de caractères en un objet utilisable avec la fonction
<a href="#http.request"><code>http.request()</code></a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
classe <code>URL</code>
</td>
<td class="hdlist2">
<p>Représentation de la structure d&#8217;une&#160;URL.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
classe <code>URLSearchParams</code>
</td>
<td class="hdlist2">
<p>  Représentation des paramètres&#160;d&#8217;URL.


</p>
</td>
</tr>
</table>
</div>
<div class="hdlist">
<div class="title">Propriétés notables de la classe <code>URL</code></div>
<table>
<tr>
<td class="hdlist1">
<code>url.format()</code>
</td>
<td class="hdlist2">
<p>Transforme un objet <code>URL</code> en chaîne de caractères grâce à des contrôles&#160;fins.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>url.toString()</code>
</td>
<td class="hdlist2">
<p>Transforme l&#8217;objet <code>URL</code> en chaîne de caractères.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.hash</code>
</td>
<td class="hdlist2">
<p>Fragment de&#160;l&#8217;URL.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.hostname</code>
</td>
<td class="hdlist2">
<p>Nom de l&#8217;hôte.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.pathname</code>
</td>
<td class="hdlist2">
<p>Chemin d&#8217;accès à la ressource.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.protocol</code>
</td>
<td class="hdlist2">
<p>Protocole spécifié.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.search</code>
</td>
<td class="hdlist2">
<p>Paramètres de l&#8217;URL, caractère&#160;<code>?</code> inclus.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
attribut <code>url.searchParams</code>
</td>
<td class="hdlist2">
<p>Objet permettant de manipuler les paramètres.
Voir ci-après.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Manipuler une URL est plus aisé lorsqu&#8217;elle est structurée sous forme d&#8217;objet.
Les paramètres ne sont pas en reste avec l&#8217;attribut <code>searchParams</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">url/search-params.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://oncletom.io/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
example<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">,</span> <span class="token string">'node.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>

example<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code><a href="https://oncletom.io/?search=node.js" class="bare">oncletom.io/?search=node.js</a></code>&#160;– représentation de l&#8217;URL complète.</p>
</li>
<li>
<p>Affiche <code>search=node.js</code>&#160;– représentation des paramètres seulement.</p>
</li>
<li>
<p>Affiche <code><a href="https://oncletom.io/" class="bare">oncletom.io/</a></code>&#160;– le paramètre <code>search</code> et sa valeur ont été supprimés de&#160;l&#8217;URL.</p>
</li>
</ol>
</div>
<div class="hdlist">
<div class="title">Propriétés notables de la classe <code>URLSearchParams</code></div>
<table>
<tr>
<td class="hdlist1">
<code>searchParams.append()</code>
</td>
<td class="hdlist2">
<p>Ajoute un paramètre à la suite de l&#8217;URL.
Cette fonction permet d&#8217;ajouter plusieurs fois une même clé, peu importe sa valeur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.delete()</code>
</td>
<td class="hdlist2">
<p>Supprime un paramètre&#160;d&#8217;URL.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.get()</code>
</td>
<td class="hdlist2">
<p>Retoure la valeur d&#8217;un paramètre donné.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.getAll()</code>
</td>
<td class="hdlist2">
<p>Renvoie toutes les valeurs d&#8217;un paramètre donné.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.has()</code>
</td>
<td class="hdlist2">
<p>Indique <code>true</code> si les paramètres contiennent une clé donnée.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.set()</code>
</td>
<td class="hdlist2">
<p>Affecte une valeur à un paramètre&#160;d&#8217;URL.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>searchParams.toString()</code>
</td>
<td class="hdlist2">
<p>Retourne une représentation de l&#8217;objet sous forme d&#8217;une chaîne
de caractères exploitable dans une&#160;URL.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module url</div>
<div class="paragraph">
<p>La documentation du module <code>url</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/url.html" class="bare">nodejs.org/docs/latest-v10.x/api/url.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="fs">2.4. fs : manipuler le système de fichiers</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le module&#160;<code>fs</code> est un incontournable.
On y a recours dès que l&#8217;on a besoin de lire ou d&#8217;écrire dans un fichier.
On s&#8217;en sert également pour créer, déplacer ou supprimer des fichiers
et des répertoires.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Lorsque la lecture du fichier aboutit, la <a href="#callbacks">fonction de rappel</a> est appelée avec deux paramètres&#160;: un objet d&#8217;erreur et le contenu.</p>
</li>
<li>
<p>Affiche le contenu d&#8217;un fichier <code>package.json</code>.
</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Variables __filename et __dirname</div>
<div class="paragraph">
<p><code>__filename</code> est une chaîne de caractères faisant référence au fichier actuel.<br>
<code>__dirname</code> fait référence au répertoire du fichier actuel.

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">dirname-filename.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>filename <span class="token operator">===</span> __filename<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>/&#8230;&#8203;/chapter-04/examples/dirname-filename.js</code>.</p>
</li>
<li>
<p>Affiche <code>true</code>&#160;– ça ne serait pas un <em>raccourci</em> sinon&#160;;-).</p>
</li>
<li>
<p>Affiche <code>/&#8230;&#8203;/chapter-04/examples</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ces variables sont utiles pour opérer sur des <em>chemins relatifs au fichier actuel</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dans l&#8217;exemple précédent, nous avons parcouru le contenu d&#8217;un fichier.
<code>fs.readdir()</code> parcourt un répertoire&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/ls.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>readdir<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En l&#8217;exécutant, nous obtenons le résultat suivant&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node fs/ls.js
[ '.eslintrc.yaml',
  'console',
  'debug.txt',
  'deprecation-warning.js',
  'process/env.js',
  ...
  'util' ]</pre>
</div>
</div>
<div class="paragraph">
<p>Dans les environnements UNIX, le point&#160;(<code>.</code>) pour faire référence au
<em>répertoire courant</em> et deux points (<code>..</code>) pour le <em>répertoire parent</em>.
C&#8217;est le cas avec Node également.
La notion de <em>courant</em> fait référence à l&#8217;emplacement depuis lequel nous
appelons l&#8217;exécutable <code>node</code>.</p>
</div>
<div class="paragraph">
<p>Changeons de répertoire&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>cd ../..
<span data-bash-subs="$"></span>node chapter-04/examples/fs/ls.js
[ '.eslintignore',
  'README.md',
  'chapter-01'
  'chapter-02'
  ...
  'tests' ]</pre>
</div>
</div>
<div class="paragraph">
<p>Les <em>chemins relatifs</em> se définissent par rapport à l&#8217;emplacement depuis
lequel on exécute la commande <code>node</code>.
<code>__dirname</code> et <code>__filename</code> sont déterminées par rapport
à l&#8217;emplacement du script qui fait référence à ces variables.</p>
</div>
<div class="paragraph">
<p>Puisque les opérations liées au système de fichiers ne sont pas immédiates
les fonctions de ce module sont en majorité <strong>asynchrones</strong>.
Leur rapidité d&#8217;exécution varie en fonction du support de stockage utilisé
(disque, mémoire), de son usure et de la capacité de traitement de la CPU
de l&#8217;ordinateur.</p>
</div>
<div class="paragraph">
<p>Cela veut aussi dire que les erreurs sont obtenues de manière asynchrone&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/rmdir.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Indique que la suppression n&#8217;a pas abouti car le répertoire en question n&#8217;est pas vide&#160;– et pour cause, c&#8217;est celui qui contient notre fichier d&#8217;exemple.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On peut articuler plusieurs opérations entre elles et utiliser le <a href="#path">module&#160;<code>path</code></a>
pour construire des chemins robustes qui fonctionnent avec tous les systèmes
d&#8217;exploitation, sans effort.
</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant crée un répertoire dans un <a href="#os">dossier temporaire</a>,
copie un fichier sous un autre nom et liste le contenu du répertoire
une fois la copie effectuée.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">fs/copy-tmp.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>tmpdir<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dest_dir <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token function">tmpdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span>

fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dest_dir<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                   <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">const</span> dest <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>dest_dir<span class="token punctuation">,</span> <span class="token string">'example-copy.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  fs<span class="token punctuation">.</span><span class="token function">copyFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>      <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`La copie vers </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dest<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> s'est bien passée.`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On assemble un chemin composé à partir du <a href="#os">répertoire temporaire</a> fourni par le système d&#8217;exploitation.</p>
</li>
<li>
<p>Crée le répertoire en question.</p>
</li>
<li>
<p>Copie le contenu de ce script d&#8217;exemple vers le répertoire en question en lui attribuant un nouveau nom.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">🚨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Sécurité</span> Utilisateur et permissions</div>
<div class="paragraph">
<p>

Le script Node exécuté a le droit d&#8217;accéder, d&#8217;altérer et de supprimer
au même titre que l&#8217;utilisateur système qui lance le script.</p>
</div>
<div class="paragraph">
<p>Ce n&#8217;est pas grave si on exécute du code écrit soi-même.
Il faut être vigilant·e si le code exécuté provient d&#8217;une autre personne.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si l&#8217;exemple précédent semble agréable à lire, il révèle deux points de vigilance.</p>
</div>
<div class="paragraph">
<p>J&#8217;ai écrit le code de manière "optimiste", pour des questions de lisibilité.
Pourtant, à chaque opération, il y a une possibilité d&#8217;erreur à gérer&#160;:
de la création du répertoire jusqu&#8217;à la lecture des fichiers qu&#8217;il contient.
Il faudrait vérifier l&#8217;argument <code>error</code> à chaque fois et décider quoi faire
en fonction de la <a href="#errors">nature du problème</a>.</p>
</div>
<div class="paragraph">
<p>Je vous invite à modifier ce code
pour afficher la valeur des variables <code>error</code> à l&#8217;aide des
<a href="#console">fonctions du module <code>console</code></a>.
Certaines erreurs apparaissent quand nous invoquons le script une seconde fois.
</p>
</div>
<div class="paragraph">
<p>L&#8217;imbrication des <a href="#callbacks">fonctions de rappel</a> fait qu&#8217;il est
<strong>difficile d&#8217;en interrompre la suite</strong>.
Une bonne piste serait d&#8217;appliquer l'<a href="#util">utilitaire <code>promisify</code></a>
sur les fonctions du module&#160;<code>fs</code> afin de créer une
<a href="../chapter-03/index.html#promise">chaîne de promesses</a>.<br>
Nous apprendrons à le faire dans la section sur le <a href="#util">module&#160;<code>util</code></a>.


</p>
</div>
<div class="hdlist">
<div class="title">Propriétés notables</div>
<table>
<tr>
<td class="hdlist1">
<code>fs.appendFile()</code>
</td>
<td class="hdlist2">
<p>Ajoute un contenu à la suite d&#8217;un fichier existant.
Le fichier sera créé le cas échéant.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.copyFile()</code>
</td>
<td class="hdlist2">
<p>Copie un fichier depuis un emplacement vers un autre.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.mkdir()</code>
</td>
<td class="hdlist2">
<p>Crée un nouveau répertoire.
Le répertoire parent doit déjà exister.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.readdir()</code>
</td>
<td class="hdlist2">
<p>Obtient la liste des fichiers et dossiers contenus dans un répertoire donné.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.readFile()</code>
</td>
<td class="hdlist2">
<p>Lit le contenu d&#8217;un fichier.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.rename()</code>
</td>
<td class="hdlist2">
<p>Renomme un fichier ou un répertoire.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.rmdir()</code>
</td>
<td class="hdlist2">
<p>Supprime un répertoire.
Il doit être vide.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.stat()</code>
</td>
<td class="hdlist2">
<p>Retourne des informations à propos d&#8217;un chemin d&#8217;accès&#160;:
est-ce que c&#8217;est un fichier, un répertoire, un lecteur, un lien symbolique&#160;?
Des attributs précisent la taille du fichier (en octets), l&#8217;identifiant
système de son propriétaire, la date de création/modification/dernier accès, etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.symlink()</code>
</td>
<td class="hdlist2">
<p>Crée un lien symbolique vers un emplacement.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.truncate()</code>
</td>
<td class="hdlist2">
<p>Raccourcit le contenu d&#8217;un fichier à une longueur donnée (en nombre d&#8217;octets).
Si aucun argument n&#8217;est donné, le contenu du fichier est remis à&#160;zéro.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.createReadStream()</code>
</td>
<td class="hdlist2">
<p>Crée un <a href="#stream">flux de lecture</a>, pour lire un fichier en continu.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>fs.createWriteStream()</code>
</td>
<td class="hdlist2">
<p>Crée un <a href="#stream">flux d&#8217;écriture</a>, pour écrire en continu dans un fichier.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Définition</span> Lien symbolique</div>
<div class="paragraph">
<p>Fichier qui fait référence à un autre fichier&#160;– c&#8217;est comme un <em>alias</em>.
Toutes les modifications effectuées sur le lien symbolique sont
répercutées sur le fichier d&#8217;origine.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://fr.wikipedia.org/wiki/Lien_symbolique" class="bare">fr.wikipedia.org/wiki/Lien_symbolique</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module fs</div>
<div class="paragraph">
<p>La documentation du module <code>fs</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/fs.html" class="bare">nodejs.org/docs/latest-v10.x/api/fs.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="events">2.5. events : programmer des événements</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>Le module <code>events</code> contient le nécessaire pour créer du code communiquant
à l&#8217;aide de fonctions d&#8217;écoute et d&#8217;émission de messages.
C&#8217;est comme un <em>centre de tri postal</em>, mais avec des variables
en guise de courriers.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">events/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>

emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">date</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                    <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Année : %d'</span><span class="token punctuation">,</span> date<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2018-03-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(3)</b></span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'1983-03-24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création d&#8217;un gestionnaire d&#8217;événements.</p>
</li>
<li>
<p>Enregistrement d&#8217;une fonction d&#8217;écoute&#160;– elle sera exécutée à chaque émission de l&#8217;événement&#160;<code>date</code>.</p>
</li>
<li>
<p>Émission d&#8217;un événement <code>date</code>, avec comme argument, un <a href="../chapter-03/index.html#date">objet&#160;<code>Date</code></a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Un événement se décompose en trois parties&#160;: les fonctions d&#8217;écoute,
les émissions de message et un objet <code>EventEmitter</code>
qui fait le lien entre les deux.
</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Langage</span> ECMAScript n&#8217;est pas événementiel</div>
<div class="paragraph">
<p>Contrairement à ce que l&#8217;on pourrait penser, le langage ECMAScript ne possède
aucune structure de gestion d&#8217;événements.</p>
</div>
<div class="paragraph">
<p>S&#8217;il est possible de réagir à des événements dans les navigateurs web,
c&#8217;est grâce à la spécification DOM&#160;– l&#8217;API JavaScript pour manipuler
une structure de document&#160;HTML.
</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://developer.mozilla.org/fr/docs/Web/Events" class="bare">developer.mozilla.org/fr/docs/Web/Events</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On peut décider d&#8217;écouter un événement une seule fois avec&#160;<code>once()</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">events/once.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">date</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                  <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Année : %d'</span><span class="token punctuation">,</span> date<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2018-03-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'1983-03-24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Bien que l&#8217;événement <code>date</code> soit appelé deux fois, la fonction d&#8217;écoute ne réagira qu&#8217;une seule fois.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La fonction <code>removeListener()</code> débranche une fonction d&#8217;écoute selon
les critères de notre choix&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">events/remove.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">tick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  counter<span class="token operator">++</span><span class="token punctuation">;</span>
  emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(1)</b></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">===</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> tick<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(2)</b></span>
emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    emitter<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> tick<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>L&#8217;événement <code>date</code> est émis toutes les secondes.</p>
</li>
<li>
<p>La fonction <code>tick</code> est appelée toutes les secondes.</p>
</li>
<li>
<p>La fonction <code>tick</code> est débranchée de l&#8217;événement <code>date</code> au bout de trois incréments.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On remarquera qu&#8217;il faut pouvoir faire référence à la fonction d&#8217;écoute
afin de la débrancher.</p>
</div>
<div class="paragraph">
<p>Une utilisation alternative des événements consiste à étendre la classe <code>EventEmitter</code>.
Une fois étendue, notre nouvelle classe bénéficiera des méthodes <code>.on()</code> etc.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">events/class.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>                   <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">start</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'démarrer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> auto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">'Boombo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
auto<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">car<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>               <span class="token comment">// <b class="conum">(4)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s est en train de %s'</span><span class="token punctuation">,</span> car<span class="token punctuation">.</span>name<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

auto<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Extension de la classe <code>EventEmitter</code>.</p>
</li>
<li>
<p>L&#8217;utilisation de la fonction spéciale <code>super()</code> est indispensable. Elle revient à invoquer <code>new EventEmitter()</code> par mécanisme de cascade.</p>
</li>
<li>
<p>La méthode <code>.start()</code> encapsule un appel à la méthode <code>.emit()</code>.</p>
</li>
<li>
<p>La fonction réagira à l&#8217;émission de l&#8217;événement <code>action</code> quand la méthode <code>.start()</code> sera appelée.



</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce mécanisme est utile pour cacher de la complexité applicative,
pour exécuter une fonction plusieurs fois lors d&#8217;un événement donné,
pour exposer une surface d&#8217;action compréhensible,
tout en rendant notre code communiquant vers l&#8217;extérieur.</p>
</div>
<div class="paragraph">
<p>Plusieurs modules Node utilisent les événements pour nous permettre d&#8217;y
réagir de manière totalement optionnelle.
Tout ce que l&#8217;on vient d&#8217;expliquer s&#8217;applique à l&#8217;identique aux modules
<a href="#process"><code>process</code></a>, <a href="#child_process"><code>child_process</code></a> et <a href="#http"><code>http</code></a>.


</p>
</div>
<div class="hdlist">
<div class="title">Propriétés notables de la classe <code>EventEmitter</code></div>
<table>
<tr>
<td class="hdlist1">
<code>on()</code>
</td>
<td class="hdlist2">
<p>Enregistre une nouvelle fonction réagissant à un événement donné.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>once()</code>
</td>
<td class="hdlist2">
<p>Enregistre une nouvelle fonction réagissant <em>une seule fois</em> à un événement donné.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>emit()</code>
</td>
<td class="hdlist2">
<p>Émet un événement.
Si des arguments additonnels sont présents,
ils sont transmis aux fonctions écoutant cet événement.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>eventNames()</code>
</td>
<td class="hdlist2">
<p>Liste les événements pour lesquels on a enregistré au moins une fonction d&#8217;écoute.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>listeners()</code>
</td>
<td class="hdlist2">
<p>Liste les fonctions écoutant les événements.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>removeListener()</code>
</td>
<td class="hdlist2">
<p>Supprime une fonction d&#8217;écoute d&#8217;un événement donné.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>removeAllListeners()</code>
</td>
<td class="hdlist2">
<p>Supprime toutes les fonctions d&#8217;écoute d&#8217;un événement donné.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>setMaxListeners()</code>
</td>
<td class="hdlist2">
<p>  Change le nombre maximum de fonctions d&#8217;écoute possibles (10&#160;par défaut,
  c&#8217;est&#160;peu).
</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module events</div>
<div class="paragraph">
<p>La documentation du module <code>events</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/events.html" class="bare">nodejs.org/docs/latest-v10.x/api/events.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="util">2.6. util : transformer des fonctions de rappel en promesses</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le petit module <code>util</code> contient des fonctions utilitaires
qui n&#8217;entreraient pas dans le périmètre d&#8217;autres modules.</p>
</div>
<div class="paragraph">
<p>On y trouve <code>util.format()</code>, une fonction qui fait beaucoup penser à
<a href="#console"><code>console.log()</code></a> mais sans afficher le message&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">util/format.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>format<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span>           <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token string">'Il fait %s aujourd\'hui'</span><span class="token punctuation">,</span>
  <span class="token string">'☀️ '</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// console.log(message);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affecte le message formaté à une variable sans l&#8217;afficher.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour afficher la valeur de la variable <code>message</code> de l&#8217;exemple précédent,
il suffirait de décommenter la dernière ligne et de (re)lancer le script.</p>
</div>
<div class="paragraph">
<p>La fonction <code>util.debuglog()</code> formate aussi des messages.
Son affichage est toutefois conditionnel, ce qui est pratique quand on veut
déboguer des variables sans toucher au code entre deux exécutions.

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">util/debuglog.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>debuglog<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>cpus<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">debuglog</span><span class="token punctuation">(</span><span class="token string">'nodebook'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> infos <span class="token operator">=</span> <span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cpu</span> <span class="token operator">=></span> cpu<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Cet ordinateur a %d CPU.'</span><span class="token punctuation">,</span> infos<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Le modèle de CPU est %s.'</span><span class="token punctuation">,</span> infos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Création d&#8217;un débogueur nommé <code>nodebook</code>.</p>
</li>
<li>
<p>Ce message s&#8217;affiche systématiquement quand on exécute le script.</p>
</li>
<li>
<p>Le modèle de CPU sera affiché en invoquant Node en présence de la variable d&#8217;environnement <code>NODE_DEBUG</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En lançant la commande suivante, seul le message de <code>console.log()</code> s&#8217;affiche&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node util/debuglog.js
Cet ordinateur a 4 CPU.</pre>
</div>
</div>
<div class="paragraph">
<p>Il nous faut alors utiliser la <a href="#process.env">variable d&#8217;environnement</a> <code>NODE_DEBUG</code>.
En lui attribuant la même valeur que notre débogueur, celui-ci affichera alors
le contenu attendu&#160;:


</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>NODE_DEBUG=nodebook node util/debuglog.js
Cet ordinateur a 4 CPU.
NODEBOOK 32486: Le modèle de CPU est Intel(R) Core(TM) i5-6267U CPU @ 2.90GHz.</pre>
</div>
</div>
<div class="paragraph">
<p>Si l&#8217;on souhaite avoir plusieurs débogueurs, dans un ou plusieurs script(s),
il suffit de séparer leurs noms par des virgules
(ex: <code>NODE_DEBUG=nodebook,test,fromage</code>).</p>
</div>
<div class="paragraph">
<p>Une de mes fonctions préférées est <code>util.promisify()</code>.
Elle convertit une fonction acceptant un <a href="#callback">callback</a> en une fonction
retournant une <a href="../chapter-03/index.html#promise">promesse</a>.
C&#8217;est particulièrement pratique quand on n&#8217;a pas la maîtrise du
code source original.



</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">util/fs-readdir-promisified.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>promisify<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readdir <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readdir<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">readdir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span>                                  <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affecte une version transformée de <code>fs.readdir()</code> grâce à <code>util.promisify()</code>.</p>
</li>
<li>
<p>On ne passe pas de <a href="#callbacks">fonction de rappel</a> contrairement à <code>fs.readdir()</code>.</p>
</li>
<li>
<p>Le résultat de l&#8217;opération est passé à la résolution de promesse.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cela ne paraît pas important mais cela ouvre un potentiel de simplification
énorme pour nous.
Fini l&#8217;argument <code>error</code> qui nous embête&#160;: on peut le collecter quand cela
nous arrange grâce à <code>.catch()</code>.</p>
</div>
<div class="paragraph">
<p>Cela limite également le nombre de lignes de code à écrire
pour arriver au même résultat&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">util/fs-readdir-promise.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">readdir</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      error <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">readdir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="hdlist">
<div class="title">Propriétés notables</div>
<table>
<tr>
<td class="hdlist1">
<code>util.debuglog()</code>
</td>
<td class="hdlist2">
<p>Crée une fonction de débogage similaire à <a href="#console"><code>console.error</code></a>.
Les messages ne s&#8217;afficheront que si la <a href="#process.env">variable d&#8217;environnement</a>
<code>NODE_DEBUG</code> mentionne l&#8217;identifiant du débogueur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>util.deprecate()</code>
</td>
<td class="hdlist2">
<p>Affiche un message d&#8217;avertissement lorsque vous souhaitez retirer une fonction
partagée dans une version ultérieure de votre&#160;code.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>util.format()</code>
</td>
<td class="hdlist2">
<p>Retourne une chaîne de caractères formatée, comme <a href="#console"><code>console.log</code></a>
mais sans l&#8217;envoyer dans un <a href="#process.std">flux de sortie</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>util.promisify()</code>
</td>
<td class="hdlist2">
<p>Transforme une <a href="#callbacks">fonction de rappel</a> en
<a href="../chapter-03/index.html#promise">promesse</a>.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module util</div>
<div class="paragraph">
<p>La documentation du module <code>util</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/util.html" class="bare">nodejs.org/docs/latest-v10.x/api/util.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="http">2.7. http : créer et interroger des ressources via le protocole&#160;HTTP</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Le module <code>http</code> est un incontournable de Node.
Il a deux facettes&#160;: la création de requêtes et celle de serveurs.
Dans le premier cas, on utilise le protocole HTTP pour accéder à une ressource distante
et recevoir une réponse.
Dans le second, on utilise le protocole HTTP pour
<strong>mettre à disposition des ressources</strong> et les envoyer en réponse.</p>
</div>
<div class="paragraph">
<p>Le module <code>https</code> offre exactement les mêmes propriétés.
Il est à privilégier pour établir des connexions sécurisées
vers des adresses commençant par&#160;<code>https://</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">http/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://oncletom.io/node.js/package.json'</span><span class="token punctuation">;</span>

<span class="token keyword">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                        <span class="token comment">// <b class="conum">(1)</b></span>
  response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initialisation de la requête&#160;– un objet représentant la <a href="#http.IncomingMessage">réponse du serveur distant</a> nous est transmis. À ce stade-là, le serveur n&#8217;a pas encore commencé à renvoyer des données.</p>
</li>
<li>
<p>On en est à l&#8217;étape où on reçoit des données. Le contenu du fichier <code>package.json</code> est affiché sous forme de chaînes de caractères.
</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce premier exemple met en lumière <strong>la nature asynchrone et non-bloquante par défaut de Node</strong>.
La création d&#8217;une requête et l&#8217;obtention de la réponse sont séparées d&#8217;un délai
variable, pendant lequel Node ne bloque pas le reste du code.
Les <a href="#callbacks">fonctions de rappel</a> sont appelées lorsque l&#8217;action est terminée.
</p>
</div>
<div class="paragraph">
<p>En regardant le code de l&#8217;exemple précédent, on en apprend un peu plus sur
le fonctionnement d&#8217;une requête&#160;HTTP&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Envoi de la requête au serveur distant&#160;: <code>get()</code>.</p>
</li>
<li>
<p>Obtention d&#8217;une réponse&#160;: objet <code>response</code> dans la fonction de rappel.</p>
</li>
<li>
<p>Transmission d&#8217;informations&#160;: événement <code>data</code>.</p>
</li>
<li>
<p>Clôture de la transmission&#160;: événement <code>end</code>&#160;– voir exemple suivant.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour rester rapide, Node fait aussi le choix de transmettre les données
au fur et à mesure.
L'<a href="#events">événement</a> <code>data</code> renvoie en réalité environ 10&#160;Ko de données.
L&#8217;exemple précédent a tout renvoyé d&#8217;un coup car le volume des données
était inférieur à 10&#160;Ko.
</p>
</div>
<div class="paragraph">
<p>Voyons maintenant ce qui se passe lorsqu&#8217;on fait appel à un fichier
plus volumineux&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">http/get.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'https://oncletom.io/node.js/index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ko <span class="token operator">=</span> data<span class="token punctuation">.</span>length<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Morceau #%d : %iKo'</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> ko<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                      <span class="token comment">// <b class="conum">(2)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Fini (%d morceaux)'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche ce message à chaque morceau/paquet reçu.</p>
</li>
<li>
<p>L&#8217;événement <code>end</code> se déclenche lorsque la requête n&#8217;a plus de données à recevoir.</p>
</li>
<li>
<p>Affiche le nombre de morceaux reçus pour obtenir une réponse complète.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Paramètre&#160;URL</div>
<div class="paragraph">
<p>

Les fonctions <code>http.get()</code> et <code>http.request()</code> acceptent une chaîne de caractères
comme premier argument.</p>
</div>
<div class="paragraph">
<p>Il est aussi possible de leur passer un <a href="#url">objet&#160;URL</a>.
C&#8217;est plus pratique si vous manipulez des URL complexes ou si vous paginez.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En clair, on peut recevoir une réponse en plusieurs fois, petit bout par petit bout.
Les données reçues ne sont pas forcément complètes.
Cela pose problème à des fonctions comme
<a href="../chapter-03/index.html#json"><code>JSON.parse()</code></a>, qui nécessitent un document
JSON complet pour produire un résultat.
</p>
</div>
<div class="paragraph">
<p>Une solution consiste à accumuler les morceaux de réponse et à les assembler.
Cela veut aussi dire que l&#8217;on consomme autant de mémoire que l&#8217;on reçoit de données.</p>
</div>
<div class="paragraph">
<p>Une autre solution repose sur l&#8217;utilisation des <a href="#stream">flux de données</a>.
Ils pompent et brassent les données comme du liquide, en consommant peu de mémoire.
On en parle plus loin, dans la section sur le <a href="#stream">module <code>stream</code></a>.

</p>
</div>
<div class="hdlist">
<div class="title">Propriétés notables</div>
<table>
<tr>
<td class="hdlist1">
<code>http.createServer()</code>
</td>
<td class="hdlist2">
<p>Initialise un serveur HTTP et fournit une boîte à outils pour
gérer les connexions entrantes via <a href="#http.Server"><code>http.Server</code></a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>http.get()</code>
</td>
<td class="hdlist2">
<p>Crée une connexion HTTP de type&#160;<code>GET</code>.
Il s&#8217;agit d&#8217;une version simplifiée de <code>http.request()</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>http.request()</code>
</td>
<td class="hdlist2">
<p>Crée une connexion HTTP du type de son choix&#160;: <code>GET</code>, <code>POST</code>, <code>OPTION</code>, <code>PUT</code>,
etc.</p>
</td>
</tr>
</table>
</div>
<div id="http.request" class="paragraph">
<p>La fonction <code>http.request()</code> gère une requête plus finement.
On peut aisément régler les en-têtes, le verbe HTTP et les modalités de
transmission des données.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre l&#8217;envoi d&#8217;une requête <code>HEAD</code>.
Ce verbe HTTP indique au serveur distant de répondre avec les métadonnées
de la ressource, mais sans les données (<code>response.on('data')</code>)&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">http/request.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>                                 <span class="token comment">// <b class="conum">(1)</b></span>
  protocol<span class="token punctuation">:</span> <span class="token string">'https:'</span><span class="token punctuation">,</span>
  host<span class="token punctuation">:</span> <span class="token string">'oncletom.io'</span><span class="token punctuation">,</span>
  path<span class="token punctuation">:</span> <span class="token string">'/node.js/package.json'</span><span class="token punctuation">,</span>
  method<span class="token punctuation">:</span> <span class="token string">'HEAD'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> request <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Accept'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(2)</b></span>
request<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">// <b class="conum">(3)</b></span>

request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lastModified <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'last-modified'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Modifié le %s'</span><span class="token punctuation">,</span> lastModified<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(4)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Construction des paramètres de requête pour <code>http.request()</code>.</p>
</li>
<li>
<p>Explicite au serveur distant la nature du contenu que l&#8217;on s&#8217;apprête à recevoir.</p>
</li>
<li>
<p>Déclenche l&#8217;envoi de la requête sur le réseau.</p>
</li>
<li>
<p>Affiche la date de modification de la ressource distante.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Avancé</span> Parser, destructurer, combiner</div>
<div class="paragraph">
<p>La fonction <code>url.parse()</code> du <a href="#url">module&#160;<code>url</code></a> est une alternative à la
construction manuelle de l&#8217;URL.
Les opérateurs de <a href="../chapter-03/index.html#object">manipulation d&#8217;objets</a>
comme le <em>destructuring</em> et l&#8217;expansion (<em>rest</em>) favorisent
une écriture concise et élégante.
</p>
</div>
<div class="listingblock">
<div class="title">http/request-advanced.js</div>
<div class="content">
<pre>const https = require('https');
const {parse} = require('url');
const url = parse('https://oncletom.io/node.js/package.json');

const request = https.request({ ...url, method: 'HEAD'});</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <code>http.get()</code> et <code>http.request()</code> est simple tant qu&#8217;on évite
la personnalisation de la requête.
On ajoute progressivement de plus en plus de travail pour bien envoyer une
requête, collecter les données et gérer les erreurs.</p>
</div>
<div class="paragraph">
<p>Nous verrons comment arriver au même résultat en écrivant moins de code grâce aux
<a href="../chapter-05/index.html#modules">modules&#160;<code>npm</code></a>
(<a href="../chapter-05/index.html">chapitre&#160;5</a>).
</p>
</div>
<div id="http.ClientRequest" class="hdlist">
<div class="title">Propriétés notables de <code>http.ClientRequest</code></div>
<table>
<tr>
<td class="hdlist1">
<code>request.on('response')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsque la ressource distante a accepté la requête et s&#8217;apprête
à nous transmettre les données.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.on('end')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsque la ressource distante a signalé ne plus avoir de données
à nous transmettre.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.end()</code>
</td>
<td class="hdlist2">
<p>Termine l&#8217;initialisation et entame la connexion vers la ressource distante.
Dans le cas d&#8217;une requête <code>POST</code>, <code>PUT</code> ou <code>DELETE</code>, le premier paramètre
sert à passer une donnée au serveur distant.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.getHeader()</code>
</td>
<td class="hdlist2">
<p>Retourne la valeur d&#8217;un en-tête de requête.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.setHeader()</code>
</td>
<td class="hdlist2">
<p>Change la valeur d&#8217;un en-tête de requête.
C&#8217;est une pratique courante pour préciser nos intentions auprès du serveur
distant&#160;: format de fichier réponse attendu (<code>Accept</code>), agent utilisateur
(<code>User-Agent</code>), nature des données envoyées (<code>Content-Type</code>), etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.setTimeout()</code>
</td>
<td class="hdlist2">
<p>Définit un chronomètre pour déclarer la requête en erreur si aucune réponse
n&#8217;a été obtenue dans ce délai imparti.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>request.write()</code>
</td>
<td class="hdlist2">
<p>Transmet un morceau de contenu vers la ressource distante.
Cette méthode s&#8217;utilise lorsque l&#8217;on effectue un téléversement progressif.</p>
</td>
</tr>
</table>
</div>
<div id="http.IncomingMessage" class="hdlist">
<div class="title">Propriétés notables de <code>http.IncomingMessage</code></div>
<table>
<tr>
<td class="hdlist1">
<code>message.on('data')</code>
</td>
<td class="hdlist2">
<p>Se déclenche quand un morceau de données est obtenu par le client.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>message.on('end')</code>
</td>
<td class="hdlist2">
<p>Se déclenche quand nous avons obtenu toutes les données émises par le serveur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>message.on('readable')</code>
</td>
<td class="hdlist2">
<p>Se déclenche quand nous pouvons commencer à lire les données.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>message.read()</code>
</td>
<td class="hdlist2">
<p>Obtient un morceau de données manuellement&#160;– au lieu d&#8217;utiliser
l&#8217;événement <code>data</code>, automatique.
On apprendra à mieux manipuler cette fonction dans la section sur le
<a href="#stream">module <code>stream</code></a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>message.destroy()</code>
</td>
<td class="hdlist2">
<p>Termine la transmission des données sans que le serveur distant
nous aie tout transmis.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>message.headers</code>
</td>
<td class="hdlist2">
<p>Objet contenant les en-têtes de la réponse&#160;– le serveur distant décide
de leur contenu.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>message.statusCode</code>
</td>
<td class="hdlist2">
<p>Code qui reflète l&#8217;état de compréhension de notre requête par le serveur distant.
<code>200</code>&#160;correspond à <em>tout va bien</em>, <code>404</code>&#160;à <em>ressource introuvable</em>,
<code>301</code>&#160;à <em>la ressource a été déplacée</em>.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est temps de nous pencher sur l&#8217;autre versant du module&#160;: la création
d&#8217;un serveur&#160;HTTP.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10 interactive--endpoint">
<div class="title">http/server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(1)</b></span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                      <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Serveur démarré !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>method<span class="token punctuation">,</span> url<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'URL demandée : %s %s'</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>

  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Coucou'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// <b class="conum">(4)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ouverture de l&#8217;acceptation des connexions réseau sur le port <code>4000</code>, uniquement sur la boucle locale (<code>localhost</code>)&#160;– une erreur sera affichée si ce port réseau est déjà pris par un autre processus.</p>
</li>
<li>
<p>Affiche <code>Serveur démarré&#160;!</code> quand Node a fini de négocier l&#8217;accès aux ressources réseau avec le système d&#8217;exploitation&#160;– à ce stade, le serveur est prêt à recevoir des <em>connexions entrantes</em>.</p>
</li>
<li>
<p>Lorsqu&#8217;une requête arrive, affiche l&#8217;URL demandée par le client.</p>
</li>
<li>
<p>Termine la connexion avec le client&#160;– ce dernier considère sa requête comme terminée.
</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Aparté</span> Pourquoi démarrer un serveur&#160;HTTP ?</div>
<div class="paragraph">
<p>

Ce concept peut sembler étrange lorsqu&#8217;on vient d&#8217;un autre langage de programmation.
Après tout, Apache ou nginx s&#8217;en chargent très bien pour nous.</p>
</div>
<div class="paragraph">
<p>Un serveur HTTP embarqué avec Node, c&#8217;est avant tout
<strong>une question d&#8217;autonomie et d&#8217;interopérabilité</strong>.
Il n&#8217;y a pas besoin de module spécial pour Apache ni pour nginx.</p>
</div>
<div class="paragraph">
<p>On peut développer un site web et le faire fonctionner instantanément sans
installer autre chose.
L&#8217;intégration avec un serveur Apache, nginx ou autre nécessite ensuite
très peu d&#8217;efforts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le serveur se démarre de la même manière qu&#8217;un script ordinaire&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node http/server.js
Serveur démarré !</pre>
</div>
</div>
<div class="paragraph">
<p>Le serveur continuera d&#8217;accepter les requêtes entrantes jusqu&#8217;à ce que le
<a href="#process">processus</a> soit interrompu par une erreur ou par un
<a href="#signals">signal d&#8217;arrêt</a>
– en utilisant la combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> par exemple.

</p>
</div>
<div class="paragraph">
<p>Accédez au serveur HTTP en ouvrant un navigateur web comme Firefox ou Chrome
puis en inscrivant <code><a href="http://localhost:4000" class="bare">localhost:4000</a></code> dans la barre d&#8217;adresses.
Dirigez ensuite le navigateur vers <code><a href="http://localhost:4000/test" class="bare">localhost:4000/test</a></code> et observez les
changements.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Pratique</span> Parler au serveur depuis le terminal</div>
<div class="paragraph">
<p>La commande Unix <code>curl</code> sait envoyer des requêtes HTTP.
On peut l&#8217;utiliser pour lire les réponses de notre serveur&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>curl -i http://localhost:4000/test
<span data-bash-subs="$"></span>curl -i -XHEAD http://localhost:4000/test</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;option&#160;<code>-i</code> affiche les en-têtes de réponse.
C&#8217;est l&#8217;équivalent de <code>response.headers</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On a posé les bases d&#8217;un serveur HTTP minimaliste sur lequel on pourra
construire pas à pas tout type d&#8217;application web.
Que manque-t-il pour en faire un serveur web&#160;?
Il faut encore typer les ressources renvoyées afin qu&#8217;elles soient comprises
par un navigateur, c&#8217;est-à-dire signaler que nos réponses
contiennent du HTML, du CSS, des images, etc.</p>
</div>
<div class="paragraph">
<p>Modifions notre exemple précédent pour renvoyer du&#160;HTML&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10 interactive--endpoint">
<div class="title">http/web-server.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Salut à toi&lt;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">🚨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Important</span> La fonction <code>response.end()</code></div>
<div class="paragraph">
<p>L&#8217;appel de la fonction <code>response.end()</code> est impératif.
Sinon, le client&#160;– ici, le navigateur&#160;– pense que des données vont encore arriver.</p>
</div>
<div class="paragraph">
<p>Si on supprime l&#8217;appel à <code>response.end()</code> dans l&#8217;exemple précédent,
l&#8217;indicateur de chargement du navigateur sera actif pendant deux minutes,
suite à quoi Node interrompra la connexion, considérant qu&#8217;elle met trop
de temps pour aboutir.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dirigeons notre navigateur vers <code><a href="http://localhost:4000" class="bare">localhost:4000</a></code> pour observer
le résultat.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/web-server.png" alt="web server" width="65%">
</div>
<div class="title">Figure 5. Rendu navigateur de l&#8217;exemple <code>http/web-server.js</code></div>
</div>
<div class="paragraph">
<p>La balise HTML&#160;<code>&lt;h1&gt;</code> a bien été prise en compte, mais le
caractère&#160;<code>à</code> n&#8217;a pas été compris par le navigateur, qui affiche <code>Ã&#160;</code>.
</p>
</div>
<div class="paragraph">
<p>Si le serveur distant ne précise pas l&#8217;encodage des caractères,
le navigateur l&#8217;interprète en <a href="#ascii">ASCII</a>.

Or, les éditeurs de code enregistrent les fichiers avec un autre encodage&#160;: UTF-8.
Ce standard englobe les alphabets du monde entier, dont les accents et
signes diacritiques de la langue française.
</p>
</div>
<div id="ascii" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Histoire</span> American Standard Code for Information Interchange&#160;(ASCII)</div>
<div class="paragraph">
<p>Au début de l&#8217;informatique contemporaire, les systèmes étaient conçus
pour comprendre l&#8217;alphabet anglais, les signes de ponctuations et
des caractères spéciaux.
On parle alors de standard d&#8217;encodage&#160;ASCII.</p>
</div>
<div class="paragraph">
<p>L&#8217;émergence d&#8217;Internet et du World&#160;Wide&#160;Web ont popularisé l&#8217;encodage UTF-8
afin d&#8217;exprimer de manière commune les caractères spéciaux de toutes les
langues du monde entier.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour indiquer aux navigateurs web quel est l&#8217;encodage utilisé,
le protocole HTTP dispose de l&#8217;en-tête <code>Content-Type</code>&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">http/web-server-ok.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content_type <span class="token operator">=</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> content_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

  response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Salut à toi&lt;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>L&#8217;en-tête HTTP <code>Content-Type</code> indique explicitement que le contenu transféré est du HTML, encodé en&#160;UTF-8.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette indication suffit au navigateur pour décoder les caractères
et les afficher comme on l&#8217;espérait.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/web-server-ok.png" alt="web server ok" width="65%">
</div>
<div class="title">Figure 6. Rendu navigateur de l&#8217;exemple <code>http/web-server-ok.js</code></div>
</div>
<div class="paragraph">
<p>L&#8217;étape suivante consisterait à transmettre deux contenus différents selon
l&#8217;URL demandée, par exemple, une page HTML et un fichier CSS pour l&#8217;habiller.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10 interactive--endpoint">
<div class="title">http/web-server-routes.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/main.css'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'body{ font-size: 18px; color: blue; }'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> content_type <span class="token operator">=</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">;</span>

    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> content_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;link rel="stylesheet" href="/main.css">'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Salut à toi&lt;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Si la requête entrante indique <code>/main.css</code> comme chemin, alors on lui renvoie du contenu interprétable comme du&#160;CSS.</p>
</li>
<li>
<p>On indique au client que ce contenu est du texte contenant une feuille de styles&#160;CSS.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si tout se passe bien, le chargement de la page HTML devrait déclencher
une requête vers <code><a href="http://localhost:4000/main.css" class="bare">localhost:4000/main.css</a></code>.
Nous en avons la confirmation visuelle en visitant le serveur grâce à un
navigateur&#160;web&#160;:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/web-server-routes.png" alt="web server routes" width="65%">
</div>
<div class="title">Figure 7. Rendu navigateur de l&#8217;exemple <code>http/web-server-routes.js</code></div>
</div>
<div class="paragraph">
<p>On est en situation de contrôle&#160;: on décide de ce qu&#8217;on répond.
C&#8217;est une manière d&#8217;apprendre petit à petit comment fonctionne
le protocole HTTP sur lequel repose une majorité de notre activité sur Internet.</p>
</div>
<div class="paragraph">
<p>On a couvert les principes du module&#160;<code>http</code>, mais il reste beaucoup de choses
à apprendre pour développer une application web maintenable.
Ce sera le sujet du <a href="#../chapter-07/index.adoc">chapitre&#160;7</a>,
aidé par les <a href="../chapter-05/index.html#modules">modules&#160;<code>npm</code></a> que l&#8217;on apprendra
à manipuler dans le <a href="../chapter-05/index.html">chapitre&#160;5</a>.</p>
</div>
<div id="http.Server" class="hdlist">
<div class="title">Propriétés notables de <code>http.Server</code> et de <code>https.Server</code></div>
<table>
<tr>
<td class="hdlist1">
<code>server.close()</code>
</td>
<td class="hdlist2">
<p>Arrête l&#8217;écoute de nouvelles connexions.
Les connexions existantes sont maintenues jusqu&#8217;à ce qu&#8217;elles soient honorées.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.listen()</code>
</td>
<td class="hdlist2">
<p>Démarre l&#8217;acceptation des connexions sur un port et une adresse donnés.
Combinée avec <a href="#os"><code>os.networkInterfaces()</code></a>, vous pourriez choisir
sur quelle carte/adresse réseau écouter les requêtes entrantes.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.on('close')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsque le serveur s&#8217;arrête et a terminé d&#8217;honorer toutes les
connexions déjà ouvertes.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.on('connection')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsqu&#8217;une nouvelle connexion réseau est établie.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.on('request')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsqu&#8217;une nouvelle requête entrante est adressée au serveur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>server.on('upgrade')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsqu&#8217;une requête entrante demande un changement de protocole.
Utilisée pour basculer vers HTTP/2 et
<a href="../chapter-09/index.html#io-websocket">WebSocket</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.on('close')</code>
</td>
<td class="hdlist2">
<p>Se délenche lorsque la requête a été terminée par le client,
avant qu&#8217;on ait pu transmettre l&#8217;intégralité des données.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.on('finish')</code>
</td>
<td class="hdlist2">
<p>Se délenche après l&#8217;envoi du dernier morceau de données.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.end()</code>
</td>
<td class="hdlist2">
<p>Signale au client que nous n&#8217;avons plus de données à transmettre.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.getHeader()</code>
</td>
<td class="hdlist2">
<p>Retourne la valeur d&#8217;un en-tête de la réponse.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.removeHeader()</code>
</td>
<td class="hdlist2">
<p>Supprime un en-tête de la réponse.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.setHeader()</code>
</td>
<td class="hdlist2">
<p>Affecte une valeur à un en-tête de la réponse.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.write()</code>
</td>
<td class="hdlist2">
<p>Transmet un morceau de données au client.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>response.writeHead()</code>
</td>
<td class="hdlist2">
<p>Transmet le code de réponse et un ensemble d&#8217;en-têtes au client.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>response.statusCode</code>
</td>
<td class="hdlist2">
<p>  Contient le code de réponse qui sera transmis au client.
</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module http</div>
<div class="paragraph">
<p>La documentation du module <code>http</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/http.html" class="bare">nodejs.org/docs/latest-v10.x/api/http.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="os">2.8. os : en savoir plus sur les capacités de l&#8217;ordinateur</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le module&#160;<code>os</code> donne des informations sur l&#8217;environnement système dans lequel
le script est exécuté.
Cela permet par exemple de <strong>prendre des décisions par rapport aux ressources disponibles</strong>
(mémoire, CPU, réseau) et par rapport au système d&#8217;exploitation (Windows, Linux, macOS).</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">os/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">}</span> <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">userInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token string">`Salut </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, cet ordinateur a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cpus<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> CPU.`</span></span> <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche un message comme <code>Salut anonymous, cet ordinateur a 4&#160;CPU</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Node a pour vocation de nous abstraire du système d&#8217;exploitation
en faisant en sorte que notre code fonctionne partout de la même façon.
Pourtant, des situations nous obligent à prendre en compte certains critères
pour déterminer un choix.</p>
</div>
<div class="paragraph">
<p>Par exemple, lister les applications installées sur l&#8217;ordinateur dépend
du système&#160;; leur emplacement d&#8217;installation est différent sous Linux, Windows
et macOS.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">os/apps.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>type<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>readdir<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> modules</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> error
    <span class="token operator">?</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'Windows_NT'</span><span class="token punctuation">:</span> <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'C:\\Program Files'</span><span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'Linux'</span><span class="token punctuation">:</span>      <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'/usr/bin'</span><span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'Darwin'</span><span class="token punctuation">:</span>     <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'/Applications'</span><span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;exemple précédent se base sur la valeur retournée par la fonction <code>os.type()</code>
afin de choisir le répertoire à lister.</p>
</div>
<div class="paragraph">
<p>On pourrait combiner ce mécanisme avec le <a href="#child_process">module <code>child_process</code></a>,
pour appeler une application système différente et parvenir à un résultat similaire.</p>
</div>
<div class="paragraph">
<p>À l&#8217;inverse, on peut <strong>accéder à une ressource de manière uniforme</strong>, peu importe
le nom du compte utilisateur ou du type de système d&#8217;exploitation.
Nous allons maintenant lire le contenu du fichier <code>.npmrc</code>,
le fichier de configuration de
l'<a href="../chapter-05/index.html#cli">exécutable&#160;npm</a>&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">os/npmrc.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>homedir<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token function">homedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.npmrc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">readFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> error<span class="token punctuation">.</span>code <span class="token operator">!==</span> <span class="token string">'ENOENT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// <b class="conum">(2)</b></span>
    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Construit un chemin sans connaissance préalable du système d&#8217;exploitation sur lequel tournera le script&#160;: par exemple <code>C:\Users\anonymous\.npmrc</code> pour Windows, <code>/Users/anonymous/.npmrc</code> pour macOS et <code>/home/anonymous/.npmrc</code> pour Linux.</p>
</li>
<li>
<p><code>ENOENT</code> est un <a href="#fs.errors">code d&#8217;erreur</a> indiquant que le fichier n&#8217;existe pas&#160;; on se permet de l&#8217;ignorer et de considérer que le fichier est vide.
</p>
</li>
</ol>
</div>
<div class="hdlist">
<div class="title">Propriétés notables</div>
<table>
<tr>
<td class="hdlist1">
<code>os.arch()</code>
</td>
<td class="hdlist2">
<p>Retourne l&#8217;architecture CPU.
Les valeurs les plus courantes sont généralement <code>x64</code>, <code>arm</code> et&#160;<code>arm64</code>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.cpus()</code>
</td>
<td class="hdlist2">
<p>Retourne un tableau contenant des informations à propos de la ou des CPU.
Entre autres, on retrouve leur modèle, leur fréquence et
le temps passé en attente ou en action depuis le démarrage de l&#8217;ordinateur.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.homedir()</code>
</td>
<td class="hdlist2">
<p>Retourne le chemin vers le répertoire utilisateur.
Équivalent de la variable <code>$HOME</code> sous Unix et <code>%USERPROFILE%</code> ou <code>%AppData%</code>
sous Windows.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.hostname()</code>
</td>
<td class="hdlist2">
<p>Retourne l&#8217;identifiant réseau de la machine.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.networkInterfaces()</code>
</td>
<td class="hdlist2">
<p>Retourne un tableau contenant des informations à propos de la ou des
carte(s) réseau de l&#8217;ordinateur.
Entre autres, on retrouve l&#8217;adresse&#160;IP (IPv4, IPv6), l&#8217;adresse MAC
et le masque réseau.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.platform()</code>
</td>
<td class="hdlist2">
<p>Retourne la nature du système d&#8217;exploitation.
Les valeurs les plus courantes sont généralement <code>win32</code>, <code>linux</code>, <code>darwin</code>
et <code>freebsd</code>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.tmpdir()</code>
</td>
<td class="hdlist2">
<p>Retourne l&#8217;emplacement du répertoire temporaire fourni par
le système d&#8217;exploitation.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>os.type()</code>
</td>
<td class="hdlist2">
<p>Retourne une forme normalisée de la nature du système d&#8217;exploitation,
équivalent à ce que retournerait la commande Unix <code>uname -s</code>.
Les valeurs les plus courantes sont généralement
<code>Windows_NT</code>, <code>Linux</code>, <code>Darwin</code> et <code>FreeBSD</code>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>os.constants</code>
</td>
<td class="hdlist2">
<p>Objet contenant la liste des <a href="#signals">signaux système</a> et des codes d&#8217;erreur.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Attribut <code>os.EOL</code>
</td>
<td class="hdlist2">
<p>Caractère utilisé pour marquer les fins de ligne.
En général le caractère&#160;<code>\n</code> sous Unix et <code>\r\n</code> sous Windows.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module os</div>
<div class="paragraph">
<p>La documentation du module&#160;<code>os</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/os.html" class="bare">nodejs.org/docs/latest-v10.x/api/os.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="child_process">2.9. child_process : appeler un exécutable système</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le module <code>child_process</code> exécute des programmes externes,
leur transmet des données et consulte leurs résultats via
les <a href="#process.std">flux standards</a>.



</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>exec<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'npm --version'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`npm version </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stdout<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Exécute la commande exécute la fonction de rappel, avec comme arguments la <a href="#process.std">sortie standard</a> et la <a href="#process.std">sortie erreur</a> du processus enfant.</p>
</li>
<li>
<p>Affiche <code>npm version 6.4.0</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;utilisation du module <code>child_process</code> se justifie quand un programme
externe fournit une fonctionnalité mais ne s&#8217;interface pas avec Node,
ou encore quand on veut sortir l&#8217;exécution d&#8217;un script Node du processus courant
pour tirer parti des autres CPU de l&#8217;ordinateur sans ralentir l&#8217;application principale.</p>
</div>
<div class="paragraph">
<p>La fonction <code>child_process.exec()</code> accepte un deuxième argument optionnel.
<code>cwd</code> (<em>current working directory</em>) en est une des options utiles.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/ls.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>exec<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'ls .'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>cwd<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On lance la commande système&#160;<code>ls</code> sans spécifier le répertoire de travail.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Exécutons le script pour observer le résultat&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node child_process/ls.js</pre>
</div>
</div>
<div class="paragraph">
<p>Le constat est similaire à celui produit avec le <a href="#fs">module&#160;<code>fs</code></a>&#160;:
les fichiers listés sont ceux du <em>répertoire courant</em>,
notre emplacement dans le terminal.</p>
</div>
<div class="paragraph">
<p>Modifions maintenant la valeur de l&#8217;option&#160;<code>cwd</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/ls-root.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>exec<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'ls .'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>cwd<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(1)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La valeur de&#160;<code>cwd</code> est réglée sur&#160;<code>/</code>, c&#8217;est-à-dire le répertoire racine du système de fichiers.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node child_process/ls-root.js</pre>
</div>
</div>
<div class="paragraph">
<p>La liste des fichiers et répertoires affichés est désormais différente,
même si la commande passée à <code>child_process.exec()</code> est la même.
<code>cwd</code>&#160;a changé le répertoire courant l&#8217;espace d&#8217;une commande.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performance</span> ls&#160;vs. fs.readdir</div>
<div class="paragraph">
<p>

Si on arrive au même résultat avec <code>exec('ls')</code>, pourquoi utiliser
la fonction <code>fs.readdir()</code> du <a href="#fs">module&#160;<code>fs</code></a>&#160;?
Cette dernière présente au moins trois avantages&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Elle est plus rapide&#160;– à écrire, à exécuter, à diagnostiquer.</p>
</li>
<li>
<p>On économise la création d&#8217;un processus système.</p>
</li>
<li>
<p>Elle est compatible avec tous les systèmes d&#8217;exploitation.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>env</code>&#160;est une deuxième option à passer à <code>child_process.exec()</code>.
Elle redéfinit les <a href="#process.env">variables d&#8217;environnement</a> utilisables
par le processus enfant&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">child_process/ping.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>exec<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token constant">PING_COUNT</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>process<span class="token punctuation">.</span>env<span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token string">'ping -c $PING_COUNT oncletom.io'</span><span class="token punctuation">;</span>

<span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">{</span>env<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>           <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">return</span> error
    <span class="token operator">?</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On transmet les variables d&#8217;environnement existantes au processus enfant.</p>
</li>
<li>
<p>Utilisation de la variable d&#8217;environnement <code>PING_COUNT</code> comme valeur d&#8217;option du programme&#160;<code>ping</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si on ne transmettait pas les valeurs de <code>process.env</code> au processus enfant,
la variable d&#8217;environnement <code>PATH</code> ne serait pas définie.

Le processus enfant ne saurait plus où chercher l&#8217;exécutable&#160;<code>ping</code>.<br>
On aurait pu appeler le programme <code>ping</code> en utilisant un chemin absolu comme
<code>/sbin/ping</code> mais son emplacement varie selon les systèmes d&#8217;exploitation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node child_process/ping.js
PING oncletom.io (185.31.40.11): 56 data bytes
64 bytes from 185.31.40.11: icmp_seq=0 ttl=56 time=23.763 ms

--- oncletom.io ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 23.763/23.763/23.763/0.000 ms</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">🚨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Compatibilité</span> Mon programme ne fonctionne pas sous Windows/Linux/macOS</div>
<div class="paragraph">
<p>Le programme externe peut ne pas exister sur tous les systèmes d&#8217;exploitation,
ou ne pas s&#8217;appeler avec les mêmes arguments, ni avec le même&#160;nom.</p>
</div>
<div class="paragraph">
<p>Une des solutions consiste à se reposer sur le <a href="#os">module&#160;<code>os</code></a>
et adapter la commande en fonction du système d&#8217;exploitation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>child_process.spawn()</code> est une autre approche de démarrage
et de communication avec un processus externe.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/spawn.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>spawn<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> subprocess <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'package.json'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>

subprocess<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>            <span class="token comment">// <b class="conum">(2)</b></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>cat</code>&#160;est un programme qui affiche le contenu d&#8217;un fichier&#160;– un peu comme <code>fs.readFile</code>.</p>
</li>
<li>
<p>Les données retournées par la commande externe se lisent depuis les <a href="#process.std">flux de sortie</a>.</p>
</li>
<li>
<p>Affiche le contenu du fichier <code>package.json</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les arguments et options à transmettre au programme sont passés dans un tableau.
Dans le programme externe, on y accède avec <a href="#process.argv"><code>process.argv</code></a>.
</p>
</div>
<div class="paragraph">
<p>Pour transmettre un volume de données plus important en paramètre,
il vaut mieux faire appel à la propriété <code>stdin</code>.
C&#8217;est un <a href="#stream">flux d&#8217;écriture</a> dont le fonctionnement est identique
à <a href="#process.std"><code>process.stdin</code></a>.

</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">child_process/spawn-stdin.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>spawn<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> subprocess <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'tr'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'0-9a-f'</span><span class="token punctuation">,</span> <span class="token string">'a-p'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
subprocess<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

subprocess<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'0123 abcd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(1)</b></span>
subprocess<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Écrit <code>0123 abcd</code> dans le flux d&#8217;entrée.</p>
</li>
<li>
<p>Signale au processus externe qu&#8217;il n&#8217;aura plus de donnée&#160;– le programme&#160;<code>tr</code> rendra la main dès qu&#8217;il nous aura tout transmis.</p>
</li>
<li>
<p>Affiche <code>abcd klmn</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;exécutable <code>tr</code> (<span class="URL"><a href="https://fr.wikipedia.org/wiki/Tr_(Unix" class="bare">fr.wikipedia.org/wiki/Tr_(Unix</a>)</span>)
remplace des plages de caractères.
On lui a transmis des caractères en entrée et spécifié les plages de traduction
en arguments.
Nous avons utilisé la <a href="#process.std">sortie standard</a> pour lire les résultats.

</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple précédent revient au même que la commande suivante&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>echo -n '0123 abcd' | tr 0-9a-f a-p
abcd klmn</pre>
</div>
</div>
<div class="paragraph">
<p>Dans ce cas précis, je trouve que l&#8217;instruction en ligne de commande est plus
concise que l&#8217;utilisation d&#8217;un script Node faisant appel à <code>child_process.spawn()</code>.
J&#8217;aurais plutôt tendance à transmettre le résultat de cette commande
à l'<a href="#process.std">entrée standard</a> d&#8217;un script Node.</p>
</div>
<div class="hdlist">
<div class="title">Propriétés notables du module child_process</div>
<table>
<tr>
<td class="hdlist1">
<code>child_process.exec()</code>
</td>
<td class="hdlist2">
<p>Exécute une commande et retourne son résultat.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>child_process.spawn()</code>
</td>
<td class="hdlist2">
<p>Exécute une commande et retourne un objet <a href="#process">processus</a>.
Le script Node et le nouveau processus peuvent communiquer entre eux.
</p>
</td>
</tr>
</table>
</div>
<div class="hdlist">
<div class="title">Propriétés notables de la classe <code>ChildProcess</code></div>
<table>
<tr>
<td class="hdlist1">
<code>process.on('message')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsque le processus enfant reçoit un message envoyé par l&#8217;autre script.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>process.kill()</code>
</td>
<td class="hdlist2">
<p>Envoie un <a href="#signals">signal d&#8217;arrêt</a> au processus enfant.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>process.send()</code>
</td>
<td class="hdlist2">
<p>Envoie un message au processus enfant.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>process.stdin</code>
<br>
<code>process.stdout</code>
<br>
<code>process.stderr</code>
</td>
<td class="hdlist2">
<p><a href="#process.std">Flux standards</a> du processus enfant.
Idéal pour envoyer et récupérer des données en continu.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module child_process</div>
<div class="paragraph">
<p>La documentation du module <code>child_process</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/child_process.html" class="bare">nodejs.org/docs/latest-v10.x/api/child_process.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="process">2.10. process : en savoir plus sur le processus en cours</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>La module <code>process</code> retourne des informations
sur l&#8217;environnement dans lequel le script est exécuté.
À l&#8217;instar de <a href="#console"><code>console</code></a>, la variable <code>process</code>
est globale.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">process/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> variables <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>variables<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche quelque chose comme <code>['LANG', 'SHELL', 'PATH', 'HOME', 'USER', …]</code>&#160;– voir plus bas, les &#8220;<a href="#process.env">variables d&#8217;environnement</a>&#8221;.</p>
</li>
<li>
<p>Affiche <code>[ '&#8230;&#8203;/v10.9.0/bin/node', '&#8230;&#8203;/chapter-04/examples/process/intro.js' ]</code>&#160;– voir plus bas, les &#8220;&#160;<a href="#process.argv">arguments d&#8217;exécution</a>&#8221;.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notre code peut être interprété par Node
sur plusieurs types de machines
(ordinateur récent ou fatigué, Raspberry&#160;Pi, etc.) et sur différents
systèmes d&#8217;exploitation (Windows, Linux, macOS, etc.).
Nous avons avec le module <code>process</code> tout le loisir d&#8217;adapter nos scripts
à ces diverses conditions.</p>
</div>
<div id="process.env" class="paragraph">
<p>Les variables d&#8217;environnement sont <strong>définies au niveau du système d&#8217;exploitation</strong>.
Elles contiennent des informations comme le répertoire courant, la langue du
système d&#8217;exploitation, l&#8217;utilisateur système courant, le type de terminal,
les emplacements d&#8217;installation des exécutables, etc.


</p>
</div>
<div class="paragraph">
<p>On retrouve ces variables sous la forme d&#8217;un
<a href="../chapter-03/index.html#object">objet ECMAScript</a> nommé <code>process.env</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -p 'process.env'
{ ITERM_PROFILE: 'Default',
  LANG: 'en_GB.UTF-8',
  PWD: '/Users/oncletom/workspace/nodebook',
  SHELL: '/bin/zsh',
  TERM_PROGRAM_VERSION: '3.1.5',
  TERM_PROGRAM: 'iTerm.app',
  ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>En créant des variables d&#8217;environnement, nous sommes en mesure de
<strong>transmettre des informations contextuelles</strong> à nos programmes&#160;:
des chemins d&#8217;accès à une base de données, si on est en situation de test
ou de production, l&#8217;emplacement de fichiers nécessaires au fonctionnement
de notre programme, etc.</p>
</div>
<div class="paragraph">
<p>Par exemple et par convention, la variable <code>NODE_ENV</code> est utilisée pour indiquer au programme
s&#8217;il est lancé dans le cadre du développement, de l&#8217;exécution des tests
ou s&#8217;il tourne sur le serveur de production.
</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Variable d&#8217;environnement éphémère</dt>
<dd>
<p>
La variable n&#8217;existe que pendant la durée de vie du programme.
La définition <code>CLÉ=valeur</code> est placée sur la même ligne que le programme
en question.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>NODE_ENV=production node process/env.js
mode : production</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Variable d&#8217;environnement permanente</dt>
<dd>
<p>
La variable existe pendant la durée de la session
grâce à l&#8217;opérateur <code>export</code> sous Linux et macOS et
avec l&#8217;opérateur <code>set</code> sous Windows.<br>
La définition <code>export CLÉ=valeur</code> est placée sur sa propre ligne.
Elle restera accessible par tout programme jusqu&#8217;à la fin de la session
ou jusqu&#8217;à ce qu&#8217;on efface la variable.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>export NODE_ENV=production
<span data-bash-subs="$"></span>node process/env.js
mode : production</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Revenir en arrière</span> Effacer une variable d&#8217;environnement</div>
<div class="paragraph">
<p>
L&#8217;opérateur <code>unset</code> dans un terminal efface le contenu
d&#8217;une variable d&#8217;environnement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>export NODE_ENV=dev
<span data-bash-subs="$"></span>echo $NODE_ENV
<span data-bash-subs="$"></span>unset NODE_ENV
<span data-bash-subs="$"></span>echo $NODE_ENV</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Voici le contenu du fichier <code>process/env.js</code> utilisé dans les exemples précédents&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">process/env.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token constant">NODE_ENV</span><span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'dev'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'On est en mode développement.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mode : %s'</span><span class="token punctuation">,</span> <span class="token constant">NODE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On notera que son comportement s&#8217;adapte à la présence et à la valeur
de la variable d&#8217;environnement <code>NODE_ENV</code>.
Elle est accessible dans Node en tant que <code>process.env.NODE_ENV</code>.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>NODE_ENV=dev node process/env.js
On est en mode développement.
mode : dev</pre>
</div>
</div>
<div class="paragraph">
<p>Nous verrons d&#8217;autres mises en situation des variables d&#8217;environnement pour
<a href="../chapter-06/index.html#configuration">configurer une application</a>
dans le <a href="../chapter-06/index.html">chapitre&#160;6</a> et pour
<a href="../chapter-08/index.html#debug">déboguer une application en ligne de commande</a>
dans le <a href="../chapter-08/index.html">chapitre&#160;8</a>.</p>
</div>
<div id="process.argv" class="paragraph">
<p>Les arguments d&#8217;exécution sont des morceaux d&#8217;information transmis
à un script Node.
On les place à droite du nom du fichier&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-first.js salut
"salut"</pre>
</div>
</div>
<div class="paragraph">
<p>On utilise les arguments pour affiner le comportement d&#8217;un programme.
Je pense par exemple au numéro du port sur lequel lancer un serveur web,
une liste de fichiers à traiter ou
encore des fonctionnalités à activer ou à désactiver.</p>
</div>
<div class="paragraph">
<p>Il faut imaginer les arguments comme des paramètres de fonction,
accessibles dans un programme Node dans
le <a href="../chapter-03/index.html#array">tableau</a> <code>process.argv</code>&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">print-first.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">,</span>first_arg<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first_arg<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les deux premiers éléments de <code>process.argv</code> sont rarement utilisés.
Ils correspondent respectivement à l&#8217;emplacement de l&#8217;exécutable Node
et à l&#8217;emplacement du script.</p>
</div>
<div class="paragraph">
<p>Tous les autres arguments sont accessibles à partir de l&#8217;index&#160;2 de
<code>process.argv</code>, dans l&#8217;ordre où ils sont placés&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-first.js salut ça va ?
"salut"</pre>
</div>
</div>
<div class="paragraph">
<p>Le script <code>print-first.js</code> affiche le premier argument.
On en conclut que les arguments sont séparés par le caractère &#8220;espace&#8221;.</p>
</div>
<div class="paragraph">
<p>Dans le cas où un argument doit contenir un espace, on l&#8217;encadre alors
de guillemets&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-first.js "salut ça va ?" "oui et toi ?"
"salut ça va ?"</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;inconvénient des arguments est que leur ordre compte
et qu&#8217;il devient difficile de connaître leur rôle sans se référer
au manuel d&#8217;utilisation.</p>
</div>
<div class="paragraph">
<p>C&#8217;est là qu&#8217;interviennent les options.
Comme leur nom l&#8217;indique, ce sont des arguments optionnels.
Elles sont préfixées de deux traits d&#8217;union (<code>--</code>).
On leur associe ou non une valeur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-text.js "salut ça va ?" --uppercase
SALUT ÇA VA ?</pre>
</div>
</div>
<div class="paragraph">
<p>Quand on n&#8217;associe pas de valeur à une option,
on considère qu&#8217;elle équivaut à un <a href="../chapter-03/index.html#boolean">booléen</a>
de valeur&#160;<code>true</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">print-text.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">,</span>text<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'--uppercase'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// <b class="conum">(1)</b></span>
  text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">toLocaleUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La condition est positive si l&#8217;on détecte <code>--uppercase</code> dans la liste des arguments.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les options se combinent très bien avec les arguments.
Il faut les imaginer comme des interrupteurs.</p>
</div>
<div class="paragraph">
<p>Dans d&#8217;autres situations, on a besoin de passer une valeur à une option&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node print-text-limit.js "salut ça va ?" --limit 2
salut ça</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exemple précédent illustre la césure d&#8217;une phrase après deux&#160;mots
lorsque l&#8217;option <code>--limit</code> est associée à la valeur&#160;`2`.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">print-text-limit.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">,</span>text<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">;</span>

<span class="token keyword">const</span> limitIndex <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'--limit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>limitIndex <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> limitValue <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span>limitIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span>
  text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> limitValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On récupère l&#8217;index de l&#8217;option <code>--limit</code> dans le tableau <code>process.argv</code>.</p>
</li>
<li>
<p>On récupère la valeur de l&#8217;élément suivant <code>--limit</code> dans <code>process.argv</code>.</p>
</li>
<li>
<p>La troncature est paramétrée en fonction de la valeur associée à <code>--limit</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Au fond, <strong>les options sont des repères pour les utilisateurs</strong> de nos programmes.
Elles leur permettent de s&#8217;interfacer avec leurs fonctionnalités, un peu à la
manière des différents boutons qu&#8217;on retrouve
en façade d&#8217;une machine à laver.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant est totalement fictif, mais il illustre comment
on s&#8217;interfacerait avec une machine à laver en ligne de commande&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>machine-a-laver P-ECO 40 --fast --no-dry --room kitchen</pre>
</div>
</div>
<div class="paragraph">
<p>Ce qu&#8217;il faut en comprendre, c&#8217;est qu&#8217;on démarrerait la machine située
dans la cuisine avec un programme économique <em>et</em> à&#160;40°C,
en activant l&#8217;option rapide et en désactivant l&#8217;option séchage.</p>
</div>
<div class="paragraph">
<p>Nous verrons d&#8217;autres mises en situation pour
<a href="../chapter-08/index.html#argv">passer des paramètres à une application en ligne de commande</a>
dans le <a href="../chapter-08/index.html">chapitre&#160;8</a>.</p>
</div>
<div id="process.std" class="paragraph">
<p>Chaque processus système est doté de trois flux de données&#160;:
le flux d&#8217;entrée (<code>stdin</code>), le flux de sortie (<code>stdout</code>)
et le flux d&#8217;erreur (<code>stderr</code>).



</p>
</div>
<div class="paragraph">
<p>Les flux standards peuvent être alimentés pendant la durée de vie du processus
en utilisant peu de mémoire.
On les utilisera pour passer le résultat d&#8217;un autre programme
à notre script Node, pour informer l&#8217;utilisateur de notre programme,
mais aussi pour consigner les erreurs.</p>
</div>
<div class="paragraph">
<p>Node expose ces flux standards via les variables <code>process.stdin</code> (entrée),
<code>process.stdout</code> (sortie) et <code>process.stderr</code> (erreur).
Chacune possède des méthodes pour écouter ce qui s&#8217;y passe,
pour y écrire du contenu et pour <a href="#stream">rediriger leur&#160;flux</a>.</p>
</div>
<div class="paragraph">
<p>Commençons par l&#8217;utilisation de <code>process.stdout</code> pour écrire un message
dans notre terminal&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout.js
un deuxtrois
quatre</pre>
</div>
</div>
<div class="paragraph">
<p>Le code source de <code>process/stdout.js</code> fait appel à la fonction
<code>process.stdout.write()</code> par deux fois.
On notera que le caractère&#160;<code>\n</code> symbolise un retour à la ligne
(<code>\r\n</code> sous Windows)&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/stdout.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'un deux'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'trois\nquatre'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela rappelle nos précédentes utilisations de la fonction <code>console.log()</code>,
qui se repose en effet sur <code>process.stdout</code> (voir encadré).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Les fonctions <code>console.log</code> et <code>console.error</code></div>
<div class="paragraph">
<p>
La fonction d&#8217;affichage <code>console.log()</code> écrit dans le flux de sortie
<code>process.stdout</code>.
Sans surprise, <code>console.error()</code> écrit dans le flux d&#8217;erreur
<code>process.stderr</code>.
</p>
</div>
<div class="paragraph">
<p>Elles ajoutent un retour à la ligne et des options de formatage pour
notre confort.</p>
</div>
<div class="paragraph">
<p>On en parle davantage dans la section sur le <a href="#console">module <code>console</code></a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les flux de sortie et d&#8217;erreur sont manipulables en continu,
à l&#8217;aide d&#8217;utilitaires systèmes existants (<code>grep</code>, <code>awk</code>, etc.)
ou de programmes spécifiques (analyse de <em>logs</em>).
On peut ainsi se concentrer sur un programme qui fait juste ce dont on a besoin.
On laisse le travail de spécialisation à d&#8217;autres programmes.</p>
</div>
<div class="paragraph">
<p>Filtrons la sortie de l&#8217;exemple précédent sans écrire une ligne de code de plus.
Le programme <code>grep</code> (<span class="URL"><a href="https://fr.wikipedia.org/wiki/Grep" class="bare">fr.wikipedia.org/wiki/Grep</a></span>)
est fourni par défaut sur les systèmes Linux et macOS.
Il ne retourne que les lignes qui contiennent le motif
donné en <a href="#process.argv">argument</a>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout.js | grep 'tre'
qua<mark>tre</mark></pre>
</div>
</div>
<div class="paragraph">
<p>La sortie standard de <code>process/stdout.js</code> est devenue l&#8217;entrée standard
de <code>grep</code> grâce à l&#8217;utilisation du <em>pipe</em>&#160;(<code>|</code>).
</p>
</div>
<div class="paragraph">
<p>C&#8217;est le moment idéal pour regarder du côté de l&#8217;entrée standard de Node.
Implémentons quelque chose qui transforme un message&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>echo "un deuxtrois\nquatre" | node process/stdin-uppercase.js
UN DEUXTROIS
QUATRE</pre>
</div>
</div>
<div class="paragraph">
<p>On aurait aussi pu réutiliser la sortie de l&#8217;exemple <code>process/stdout.js</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout.js | node process/stdin-uppercase.js
UN DEUXTROIS
QUATRE</pre>
</div>
</div>
<div class="paragraph">
<p>Voyons comment cela fonctionne&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/stdin-uppercase.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>             <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// <b class="conum">(2)</b></span>

  process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">toLocaleUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Chaque afflux de données appelle notre fonction en lui fournissant un seul paramètre contenant les données en question.</p>
</li>
<li>
<p>Le paramètre est de <a href="#buffer">type Buffer</a>&#160;– on souhaite le transformer en <a href="../chapter-03/index.html#string">chaîne de caractères</a>.</p>
</li>
<li>
<p>La chaîne de caractères est transformée en majuscules et écrite dans le flux de sortie.

</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Terminons avec la sortie erreur (<code>process.stderr</code>).

Elle fonctionne de manière identique à la sortie standard (<code>process.stdout</code>).
S&#8217;il n&#8217;y a visuellement aucune différence, la sortie erreur écrit son contenu
dans un canal différent&#160;– un descripteur différent.
On l&#8217;utilise pour <strong>déboguer des programmes</strong>, pour <strong>lister des erreurs</strong> ou des
contenus que l&#8217;on souhaite dissocier de la sortie standard.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant affiche un nombre toutes les demi-secondes et l&#8217;état
du compteur de nombres tous les cinq affichages&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout-long.js
7
24
3
19
25
Compteur = 5
22
...</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Rappel</span> Interrompre un programme avec&#160;<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span></div>
<div class="paragraph">
<p>Un programme peut être interrompu à tout moment en utilisant la combinaison
de touches&#160;<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/stdout-long.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">limit</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  counter<span class="token operator">++</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(1)</b></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span>counter <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// <b class="conum">(2)</b></span>
    process<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Compteur = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>counter<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Écrit un nombre entre&#160;0 et 30&#160;dans la sortie standard.</p>
</li>
<li>
<p>On vérifie si la valeur du compteur est divisible par&#160;5&#160;– c&#8217;est le cas si la division produit un entier au lieu d&#8217;un nombre à virgule.</p>
</li>
<li>
<p>Affiche <code>Compteur = 5</code> puis <code>Compteur = 10</code> (et ainsi de suite) dans la sortie erreur.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On pourrait décider de n&#8217;afficher que le flux d&#8217;erreur.
Utilisons l&#8217;opérateur&#160;<code>&gt;</code> pour <strong>rediriger la sortie standard vers un fichier</strong>&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/stdout-long.js > stdout.txt
Compteur = 5
Compteur = 10
...</pre>
</div>
</div>
<div class="paragraph">
<p>En ouvrant le fichier <code>stdout.txt</code>, on voit
la liste de nombres générée par notre programme.</p>
</div>
<div class="paragraph">
<p>En maîtrisant les flux standards, on est capable de <strong>créer des programmes modulaires</strong>
qui consomment du contenu sans avoir à connaître leur provenance.
<strong>Les données circulent</strong> depuis et vers des programmes externes,
des fichiers ou des sites web distants.</p>
</div>
<div class="paragraph">
<p>Pour mieux comprendre la logique de flux continu que l&#8217;on vient de découvrir,
je vous invite à lire la section liée au <a href="#stream">module <code>stream</code></a>.

On y détaillera la liste des événements à écouter, ainsi que les différentes
méthodes d&#8217;écriture, de pause et de lecture.</p>
</div>
<div id="process.on" class="paragraph">
<p>Un processus système reçoit et émet des données, mais il peut aussi
<strong>écouter des événements</strong> grâce à la fonction <code>process.on</code>.
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/exit.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Le processus démarre'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Le processus termine avec le code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cet exemple illustre l&#8217;événement <code>exit</code>, qui est déclenché quand le processus se termine.
À ce titre, un <strong>code de sortie</strong> est fourni pour signaler l&#8217;état dans
lequel le programme se termine.
On parlera davantage du code de sortie et de sa signification
dans la section &#8220;<a href="#process.exit">Mettre fin au processus</a>&#8221;.
</p>
</div>
<div class="paragraph">
<p>Lançons le script précédent&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/exit.js
Le processus démarre
Le processus termine avec le code 0</pre>
</div>
</div>
<div class="paragraph">
<p>Tout s&#8217;est passé correctement.
Le code de sortie est alors&#160;<code>0</code>.</p>
</div>
<div class="paragraph">
<p>Si le programme venait à se terminer de manière imprévue, le code serait différent.
L&#8217;exemple suivant provoque volontairement une erreur en faisant
référence à une variable qui n&#8217;existe pas&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/exit-error.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Le processus termine avec le code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jenexistepas<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lançons le script&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/exit-error.js
Le processus termine avec le code 1

<mark>ReferenceError</mark>: jenexistepas is not defined
    at Object.<anonymous> (/.../examples/process/<mark>exit-error.js</mark>:<mark>5</mark>:13)</pre>
</div>
</div>
<div class="paragraph">
<p>Cette fois-ci, le code de sortie est&#160;<code>1</code>.
Cela correspond à une erreur qui n&#8217;a pas été capturée.
Le reste du message décrit pourquoi l&#8217;erreur s&#8217;est manifestée.</p>
</div>
<div class="paragraph">
<p>D&#8217;autres événements liés au cycle de vie de nos applications sont disponibles&#160;:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 1. Événements liés au cycle de vie du processus Node</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Événement</th>
<th class="tableblock halign-left valign-top">Paramètres</th>
<th class="tableblock halign-left valign-top">Raison du déclenchement</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(exitCode)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Le programme se termine et va rendre la main au système d&#8217;exploitation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unhandledRejection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(reason, promise)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Une <a href="../chapter-03/index.html#promise">promesse</a> a échoué
et n&#8217;a pas été capturée à l&#8217;aide de la méthode <code>.catch()</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uncaughtException</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(error)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Une erreur s&#8217;est produite et n&#8217;a pas été capturée.
Si rien n&#8217;est fait, le processus va s&#8217;arrêter avec un code erreur.<br>
<strong>Note</strong> : il vaut mieux qu&#8217;un programme s&#8217;arrête en cas de problème.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>message</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(message, sourceSocket)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Un <a href="#child_process">processus parent</a> nous envoie un message.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p></p>
</div>
<div id="signals" class="paragraph">
<p>La méthode <code>process.on</code> est à l&#8217;écoute des signaux système.
Par exemple, la combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> met en réalité
un signal d&#8217;interruption qui répond à l&#8217;identifiant <code>SIGINT</code>.</p>
</div>
<div class="paragraph">
<p>Node gère ces signaux pour nous, mais on peut aussi se mettre à les écouter
et décider de faire autrement que son comportement par défaut.</p>
</div>
<div class="paragraph">
<p>Par exemple, affichons l&#8217;heure de l&#8217;arrêt du processus avant de rendre la main&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/interrupt.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Processus démarré'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// <b class="conum">(1)</b></span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'SIGINT'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                  <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Processus terminé (manuellement)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// <b class="conum">(3)</b></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                            <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Processus terminé (timeout)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Un premier message s&#8217;affiche au démarrage du script.</p>
</li>
<li>
<p>Cette <a href="../chapter-03/index.html#function">fonction</a> se déclenche lors de la réception du <em>signal d&#8217;interruption</em> (<code>SIGINT</code>), lorsque le système d&#8217;exploitation lui relaie notre combinaison de touches <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>.</p>
</li>
<li>
<p>La fonction <a href="#process.exit"><code>process.exit()</code></a> termine le processus.</p>
</li>
<li>
<p>Sinon, ce chronomètre mettra fin au processus au bout de 5 secondes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En pratique le résultat ressemble à ceci&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/interrupt.js
2018-03-16T10:58:32.855Z - Processus démarré
<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>
2018-03-16T10:58:40.000Z - Processus terminé (manuellement)</pre>
</div>
</div>
<div class="paragraph">
<p>En plus du signal <code>SIGINT</code>, Node nous relaie les signaux suivants&#160;:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 2. Événements liés aux signaux systèmes</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Événement</th>
<th class="tableblock halign-left valign-top">Raison du déclenchement</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGINT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interruption de la commande en&#160;cours</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGTERM</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Demande au processus de s&#8217;arrêter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGUSR1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node reçoit le signal d&#8217;attacher l'<a href="#inspect">inspecteur</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGHUP</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Le terminal est en train d&#8217;être fermé</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIGWINCH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Le terminal a été redimensionné</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>SIGKILL</code> est un autre événement important, mais on ne peut pas l&#8217;écouter.
Quand il est émis, le processus doit être arrêté quoiqu&#8217;il arrive.
On l&#8217;utilise justement en dernier recours, quand <code>SIGINT</code>
et <code>SIGTERM</code> ne font pas effet&#160;; par exemple à cause d&#8217;un bogue dans notre code,
ou d&#8217;une ressource qui ne rend pas la main.</p>
</div>
<div id="process.exit" class="paragraph">
<p><strong>Un processus Node se termine quand il n&#8217;a plus d&#8217;instructions à exécuter</strong>.
Ce peut être provoqué via
l'<a href="#signals">émission d&#8217;un signal extérieur</a>, mais aussi de l&#8217;intérieur
par l&#8217;intermédiaire de la fonction <code>process.exit()</code>.
</p>
</div>
<div class="paragraph">
<p>On utilise cette fonction car le programme a atteint son but.
On le fait aussi lorsqu&#8217;on intercepte une erreur en souhaitant
effectuer un <strong>traitement spécial avant de mettre fin au processus</strong>.
Il se peut aussi qu&#8217;il vaille mieux terminer l&#8217;application en cas de perte
d&#8217;accès à des ressources distantes (base de données, stockage de fichiers)
au lieu de présenter une application web instable.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre que l&#8217;on souhaite clôturer notre script
si on trouve le bon nombre&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/exit-devinette.js
JEU ! Trouve le nombre auquel je pense :
10<kbd>ENTRÉE</kbd>
Hm hm, essaie encore.
3<kbd>ENTRÉE</kbd>
Tu as trouvé, bravo !</pre>
</div>
</div>
<div class="paragraph">
<p>Dans cet exemple, on écoute l&#8217;utilisateur de manière indéfinie, jusqu&#8217;à ce qu&#8217;il
ou elle trouve le bon nombre.
Lorsque c&#8217;est le cas, on interrompt le programme en transmettant
un code de sortie de réussite&#160;: le code <code>0</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">process/exit-devinette.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> secret_number <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JEU ! Trouve le nombre auquel je pense :'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>               <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">===</span> secret_number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Tu as trouvé, bravo !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hm hm, essaie encore.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(4)</b></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le nombre secret est&#160;<code>3</code> par défaut, sauf s&#8217;il est passé <a href="#process.argv">en argument</a> du script.</p>
</li>
<li>
<p>Cette fonction est invoquée à chaque saisie suivie de l&#8217;appui sur la touche <kbd>ENTRÉE</kbd>.</p>
</li>
<li>
<p>Cette ligne met fin au script, après avoir affiché un message de félicitations.</p>
</li>
<li>
<p>Ce message s&#8217;affiche à chaque saisie erronée, jusqu&#8217;à ce que le nombre secret soit trouvé.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On pourrait tout à fait imaginer une variante de ce script dans laquelle
on limiterait le nombre de mauvaises réponses.
Lorsqu&#8217;on atteindrait cette limite, le programme utiliserait un code de sortie
différent de&#160;<code>0</code>.
Le code&#160;<code>9</code> ferait l&#8217;affaire puisqu&#8217;il indique qu&#8217;un argument invalide a été
passé.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Avancé</span> process.abort()</div>
<div class="paragraph">
<p>
Comme avec <code>process.exit()</code>, le programme est terminé immédiatement.
On l&#8217;utilise quand quelque chose d&#8217;inopiné et nécessitant un débogage
avancé se produit.</p>
</div>
<div class="paragraph">
<p>La fonction génère un fichier de débogage (<em>core file</em>) qui contient tout le contenu
de la mémoire utilisée par Node.

Ce fichier s&#8217;analyse avec des logiciels avancés comme <code>mdb_v8</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module process</div>
<div class="paragraph">
<p>La documentation du module <code>process</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/process.html" class="bare">nodejs.org/docs/latest-v10.x/api/process.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="stream">2.11. stream : manipuler des flux de données</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Le module <code>stream</code> contient les éléments de base pour lire, écrire et
transformer des flux de données rapidement et avec peu de mémoire.</p>
</div>
<div class="paragraph">
<p>Créer ses propres flux est une chose assez compliquée à réaliser.
Dans cette section, nous allons nous focaliser sur l&#8217;utilisation des modules
Node qui génèrent de tels&#160;flux.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/intro.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span>                    <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>                       <span class="token comment">// <b class="conum">(2)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%d octets lus'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On crée un flux de lecture qui ouvre le fichier courant (<code>__filename</code>).</p>
</li>
<li>
<p>Invoque cette fonction à chaque morceau de données&#160;lu.</p>
</li>
<li>
<p>Affiche le nombre d&#8217;octets lus dans ce morceau.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node stream/intro.js
214 octets lus</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Un flux de lecture consomme les données petit à petit</strong>.
Il correspond à une instance de l&#8217;objet <a href="#stream.Readable"><code>stream.Readable</code></a>.


L&#8217;exemple précédent n&#8217;a affiché qu&#8217;un seul morceau car la taille maximale
par défaut est d&#8217;environ <code>16&#160;Ko</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/read.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">{</span>highWaterMark<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Lecture terminée'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%d octets reçus'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On spécifie cette fois qu&#8217;on lit <code>100&#160;octets</code> à la fois.</p>
</li>
<li>
<p>Affiche <code>Lecture terminée</code> lorsque tous les morceaux ont été&#160;lus.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;option <code>highWaterMark</code> adapte le débit de lecture.
Cette valeur est exprimée en octets.
Plus ce nombre est petit, moins Node utilise de mémoire&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node stream/read.js
100 octets lus
100 octets lus
78 octets lus
Lecture terminée</pre>
</div>
</div>
<div class="paragraph">
<p>Le mécanisme de flux s&#8217;applique également à l&#8217;écriture.


<strong>Un flux d&#8217;écriture écrit des données petit à petit</strong>.
Il correspond à une instance de l&#8217;objet <a href="#stream.Writeable"><code>stream.Writeable</code></a>.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre une succession d&#8217;écritures dans un même&#160;flux&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/write.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createWriteStream<span class="token punctuation">,</span> readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dest <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'debug.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>

stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">readFile</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>         <span class="token comment">// <b class="conum">(4)</b></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Hell'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(2)</b></span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'o Worl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'d!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On crée un flux d&#8217;écriture vers le fichier <code>stream/debug.txt</code>.</p>
</li>
<li>
<p>Écrit <code>Hell</code> dans le&#160;flux.</p>
</li>
<li>
<p>Écrit&#160;<code>d!</code> dans le flux et signale que nous n&#8217;avons plus de données à transmettre.</p>
</li>
<li>
<p>L&#8217;utilisation de <code>stream.end()</code> déclenche l&#8217;événement <code>finish</code>&#160;– nous lisons le contenu du fichier à ce moment&#160;là.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette écriture par morceaux a pour effet de réduire la pression mémoire
exercée par Node sur le système d&#8217;exploitation et pour le reste du programme.
Ce mécanisme est particulièrement adapté lorsque l&#8217;écriture prend du temps
ou implique un certain volume de données.</p>
</div>
<div class="paragraph">
<p><strong>Les flux de lecture et d&#8217;écriture se combinent</strong>.


Les données lues depuis une source (<code>Readable</code>) sont redirigées vers
une destination (<code>Writeable</code>) à l&#8217;aide de la fonction <code>pipe()</code>&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/pipe.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">,</span> createWriteStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filename_copy <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'copie.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">const</span> dest <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span>filename_copy<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(2)</b></span>

source<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span>                                       <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Copie terminée !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(4)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On crée un flux de lecture.</p>
</li>
<li>
<p>On crée un flux d&#8217;écriture.</p>
</li>
<li>
<p>On redirige le flux de lecture vers celui d&#8217;écriture.</p>
</li>
<li>
<p>La redirection retourne le flux d&#8217;écriture, que l&#8217;on écoute pour savoir quand il a terminé d&#8217;écrire sur le disque.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dans cet exemple, nous avons pris deux fichiers respectivement comme source de lecture
et destination d&#8217;écriture.
Nous avons assemblé les deux flux avec <code>pipe()</code> puis détecté la fin de la copie.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Unix</span> Opérateur pipe&#160;(<code>|</code>)</div>
<div class="paragraph">
<p>La fonction <code>stream.pipe()</code> correspond littéralement à l&#8217;opérateur Unix&#160;<code>|</code>.</p>
</div>
<div class="paragraph">
<p>Les morceaux de données d&#8217;un premier programme sont transmis en entrée à un
second programme.
Ici, le mécanisme s&#8217;applique à des fonctions&#160;Node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <code>pipe()</code> semble superflue pour copier des fichiers.
À vrai dire, la fonction <a href="#fs"><code>fs.copyFile()</code></a> fait exactement la même chose.


Toutefois, le mécanisme de redirection proposé par <code>pipe()</code> est modulaire et composable.
On peut par exemple diriger une source de données vers plusieurs flux d&#8217;écriture
en même temps.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/pipe-multi.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filename_copy <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'copie.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> read <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Lecture terminée !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

read<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>filename_copy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>
read<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Écrit une copie du fichier comme dans l&#8217;exemple <code>stream/pipe.js</code>.</p>
</li>
<li>
<p>Redirige le contenu de lecture vers la <a href="#process.std">sortie standard</a> de notre terminal.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cette technique agit comme une gare de triage&#160;: nous avons la liberté
d&#8217;agir sur les données avant de les envoyer vers leur flux d&#8217;écriture distinct.</p>
</div>
<div class="paragraph">
<p>On peut aussi <strong>transformer les contenus à la volée</strong> en utilisant plusieurs
fois la fonction <code>pipe()</code>.
Les données sont passées à des objets capables de lire et d&#8217;écrire des flux.
C&#8217;est le cas du <a href="#extras">module <code>zlib</code></a>, responsable de compresser et de
décompresser des données&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">stream/pipe-transform.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>createGzip<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'zlib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Compresse les données à la volée.</p>
</li>
<li>
<p>Les données compressées sont transmises à la <a href="#process.std">sortie standard</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cet exemple devrait afficher le contenu de notre fichier source avec une taille
réduite&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node stream/pipe-transform.js</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;affichage semble bizarre et c&#8217;est normal&#160;: ce sont des données compressées
au format Gzip&#160;– un format de compression libre.</p>
</div>
<div class="paragraph">
<p>Le programme Unix <code>gzip</code> sait décoder des données compressées dans ce format.
Il sait aussi les décoder à la volée avec un&#160;<em>pipe</em>&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node stream/pipe-transform.js | gzip</pre>
</div>
</div>
<div class="paragraph">
<p>Nous avons vu comment transmettre des flux de données de manière interopérable
entre un script Node et un programme externe, entre deux programmes externes
et entre deux scripts&#160;Node.</p>
</div>
<div id="stream.Readable" class="hdlist">
<div class="title">Principaux attributs d&#8217;un flux Readable</div>
<table>
<tr>
<td class="hdlist1">
<code>stream.pipe()</code>
</td>
<td class="hdlist2">
<p>Redirige un flux de lecture vers un flux d&#8217;écriture.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('data')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsqu&#8217;un morceau de données a été&#160;lu.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('error')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorqu&#8217;une erreur se produit.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('end')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsqu&#8217;il n&#8217;y a plus de données à&#160;lire.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('readable')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsque la lecture de données est prête à démarrer.</p>
</td>
</tr>
</table>
</div>
<div id="stream.Writeable" class="hdlist">
<div class="title">Principaux attributs d&#8217;un flux Writeable</div>
<table>
<tr>
<td class="hdlist1">
<code>stream.write()</code>
</td>
<td class="hdlist2">
<p>Écrit des données dans le flux.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.end()</code>
</td>
<td class="hdlist2">
<p>Signale que nous n&#8217;avons plus de données à transmettre.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('drain')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsque la mémoire d&#8217;écriture est vide et prête à accepter
de nouvelles données.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('error')</code>
</td>
<td class="hdlist2">
<p>Se déclenche lorsqu&#8217;une erreur se produit.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>stream.on('finish')</code>
</td>
<td class="hdlist2">
<p>Se déclenche à la clôture du flux d&#8217;écriture.</p>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module stream</div>
<div class="paragraph">
<p>La documentation du module <code>stream</code> est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/stream.html" class="bare">nodejs.org/docs/latest-v10.x/api/stream.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="dautres_modules_pour_aller_plus_loin">2.12. D&#8217;autres modules pour aller plus loin</h3>
<div class="paragraph">
<p>Node embarque d&#8217;autres modules que ceux listés précédemment.
Ils nécessitent des connaissances sur des sujets bas niveau,
plus proches du matériel et des protocoles réseau.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="cluster"></a><code>cluster</code></dt>
<dd>
<p>Gère la distribution d&#8217;une application sur plusieurs CPU d&#8217;un même ordinateur.
</p>
</dd>
<dt class="hdlist1"><a id="crypto"></a><code>crypto</code></dt>
<dd>
<p>Fonctions cryptographiques pour chiffrer, signer et vérifier des données.
</p>
</dd>
<dt class="hdlist1"><a id="dgram"></a><code>dgram</code></dt>
<dd>
<p>Création et consommation de ressources&#160;UDP.
</p>
</dd>
<dt class="hdlist1"><a id="dns"></a><code>dns</code></dt>
<dd>
<p>Résolution et lecture d&#8217;enregistrements&#160;DNS.
</p>
</dd>
<dt class="hdlist1"><a id="net"></a><code>net</code></dt>
<dd>
<p>Création et consommation de ressources TCP.
Les modules <code>http</code>, <code>https</code> et <code>http2</code> se basent dessus.
</p>
</dd>
<dt class="hdlist1"><a id="readline"></a><code>readline</code></dt>
<dd>
<p>Manipulation ligne par ligne d&#8217;un <a href="#stream">flux</a>.
Ce module est particulièrement utilisé dans des
<a href="../chapter-08/index.html">applications en ligne de commande</a> (chapitre&#160;8),
pour mettre à jour une barre de progression et animer des éléments d&#8217;affichage.
</p>
</dd>
<dt class="hdlist1"><a id="tty"></a><code>tty</code></dt>
<dd>
<p>Gestion d&#8217;interface de terminal en mode texte.
Le module <code>readline</code> se base dessus.
</p>
</dd>
<dt class="hdlist1"><a id="v8"></a><code>v8</code></dt>
<dd>
<p>Lecture et écriture d&#8217;instructions de la machine virtuelle&#160;V8
dans le processus actuel.

</p>
</dd>
<dt class="hdlist1"><a id="vm"></a><code>vm</code></dt>
<dd>
<p>Création de nouveaux contextes d&#8217;interprétation de la machine virtuelle&#160;V8.

</p>
</dd>
<dt class="hdlist1"><a id="zlib"></a><code>zlib</code></dt>
<dd>
<p>Compression et décompression de données (Gzip, Inflate/Deflate).
Ces formats sont utilisés pour la compression de requêtes&#160;HTTP.
</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modules">3. Créer ses propres modules Node</h2>
<div class="sectionbody">
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Les <a href="#modules-builtin">modules de base</a> nous fournissent de nombreuses fonctionnalités.
Nous pouvons réutiliser le même mécanisme pour
<strong>organiser notre code dans plusieurs fichiers</strong>.
C&#8217;est un mécanisme comparable à ce que l&#8217;on retrouve en Python (<code>import</code>),
PHP (<code>require</code>) et Ruby (<code>require</code> et <code>require_relative</code>).</p>
</div>
<div class="sect2">
<h3 id="modules.require">3.1. Importer et exporter des valeurs</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/enfant.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier d&#8217;exemple <code>modules/enfant.js</code> contient une variable, <code>number</code>.
Essayons de la réutiliser dans le fichier <code>modules/parent.js</code>
à l&#8217;aide de la fonction <code>require()</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/parent.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> enfant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./enfant.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// <b class="conum">(1)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Contrairement aux <a href="#modules-builtin">modules de base</a>, on passe un chemin relatif au fichier courant.</p>
</li>
<li>
<p>Est-ce que cela affichera la valeur de la variable <code>number</code>&#160;?</p>
</li>
<li>
<p>Mais au fond, que contient notre variable <code>enfant</code>&#160;?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Exécutons le fichier <code>modules/parent.js</code> avec Node pour en avoir le cœur&#160;net&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node modules/parent.js
undefined
{}</pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons en tirer un apprentissage important&#160;:
on ne peut pas voir ce qu&#8217;il y a dans un module depuis l&#8217;extérieur.</p>
</div>
<div class="paragraph">
<p>Choisissons maintenant ce que l&#8217;on souhaite exporter en affectant
la valeur de notre choix à <code>module.exports</code>&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/enfant-export.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> number<span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comment cela ça se traduit-il lorsqu&#8217;on l&#8217;appelle avec <code>require()</code>&#160;?</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/parent-export.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> enfant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./enfant-export.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>undefined</code>.</p>
</li>
<li>
<p>Affiche&#160;<code>42</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>module.exports</code> rend visible depuis l&#8217;extérieur ce qui est exporté par un module.
Par défaut, <code>module.exports</code> est un objet.</p>
</div>
<div class="paragraph">
<p>Essayons maintenant d&#8217;exporter plusieurs valeurs en une seule fois.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/enfant-export-multiple.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>number <span class="token operator">=</span> number<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">limit <span class="token operator">=</span> <span class="token number">100</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous avons créé deux nouvelles valeurs&#160;: <code>number</code> (un nombre) et
<code>random()</code> (une fonction).</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/parent-export-multiple.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> enfant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./enfant-export-multiple.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>enfant<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(2)</b></span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> enfant<span class="token punctuation">.</span>random<span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche&#160;<code>42</code>.</p>
</li>
<li>
<p>Affiche un nombre aléatoire entre&#160;0 et&#160;100.</p>
</li>
<li>
<p>Réexporte la fonction <code>enfant.number</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Raccourci</span> Exporter un objet</div>
<div class="paragraph">
<p>
L&#8217;utilisation de la syntaxe d&#8217;objet raccourcie évite la répétition
du nom des variables lors de l&#8217;export.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">limit <span class="token operator">=</span> <span class="token number">100</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>number<span class="token punctuation">,</span> random<span class="token punctuation">}</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(1)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Liste des valeurs retournée par l&#8217;objet <code>module.exports</code>.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En résumé, <strong>pour Node</strong>, <strong>tout fichier&#160;<code>.js</code> est un module</strong>.
Le mécanisme d&#8217;import et d&#8217;export est basé sur des chemins de fichiers.
Si on n&#8217;utilise pas de chemin, Node pense que l&#8217;on fait
référence à un <a href="#modules-builtin">module de base</a> ou à un
<a href="../chapter-05/index.html#modules">module&#160;<code>npm</code></a>
(<a href="../chapter-05/index.html">chapitre&#160;5</a>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Histoire</span> Modules CommonJS</div>
<div class="paragraph">
<p>

Le mécanisme de modules implémenté dans Node est basé sur la
spécification <em>CommonJS</em>, à peu de choses près.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://www.commonjs.org/specs/modules/1.0/" class="bare">www.commonjs.org/specs/modules/1.0/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="require">3.2. Aller plus loin avec <code>require()</code></h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Lorsqu&#8217;on fait appel à la fonction <code>require()</code>, Node effectue les actions suivantes&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Résout le chemin vers le module en question.</p>
</li>
<li>
<p>Lit du fichier.</p>
</li>
<li>
<p>Interprète le code.</p>
</li>
<li>
<p>Exécute le code.</p>
</li>
<li>
<p>Retourne la valeur de <code>module.exports</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <code>require()</code> est synchrone et bloquante.
Si l&#8217;exécution du code dans le module chargé prend du temps
– code lent, accès à une ressource distante&#160;– le temps de chargement
du module sera affecté.</p>
</div>
<div class="paragraph">
<p><code>require()</code> permet de charger trois types de modules&#160;:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fichiers relatifs au module actuel</dt>
<dd>
<p><code>require('./module.js')</code> cherche le fichier <code>module.js</code> dans le répertoire courant.
<code>require('../module.js')</code> cherche <code>module.js</code> dans le répertoire parent.</p>
</dd>
<dt class="hdlist1">Modules Node de base</dt>
<dd>
<p>Ils sont disponibles avec chaque installation de Node.</p>
</dd>
<dt class="hdlist1">Modules&#160;<code>npm</code></dt>
<dd>
<p>Ils sont disponibles avec une étape d&#8217;installation supplémentaire
(<a href="../chapter-05/index.html">chapitre 5</a>).
</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><strong>Node met les modules en cache</strong>.
Si on inclut deux fois le même module, le deuxième import ira directement
à la dernière étape de la liste d&#8217;actions.
Cela implique aussi que si le module modifie une de ses variables privée,
cette modification affectera le deuxième import.</p>
</div>
<div class="paragraph">
<p>Voici un module illustrant une variable privée et une variable exportée&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/increment.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token keyword">const</span> <span class="token function-variable function">increment</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">++</span>counter<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> increment<span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Variable privée.</p>
</li>
<li>
<p><code>increment</code> est rendue publique à cet endroit&#160;– la fonction incrémente la variable privée <code>counter</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous allons importer ce module par deux fois, dans deux variables différentes.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/double-import.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> first <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> second <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(1)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(3)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche&#160;<code>1</code>.</p>
</li>
<li>
<p>Affiche&#160;<code>2</code>.</p>
</li>
<li>
<p>Affiche&#160;<code>1</code> ou&#160;<code>3</code>&#160;?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Quel est le verdict à votre avis&#160;?
Rien ne vaut une vérification, quitte à remettre en question
notre avis initial&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node modules/double-import.js
1
2
3</pre>
</div>
</div>
<div class="paragraph">
<p>Il faut garder cette information en tête lorsqu&#8217;on importe un module.
Ce mécanisme se transforme en atout afin de partager
une variable entre plusieurs modules.
Il est pratique dans le cas d&#8217;un cache de données ou d&#8217;une configuration partagée.</p>
</div>
<div class="paragraph">
<p>Enfin, plusieurs <strong>problèmes</strong> sont susceptibles d&#8217;apparaître lors du chargement d&#8217;un module&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Le chemin vers le module est erroné&#160;;</p>
</li>
<li>
<p>Le module contient une erreur de syntaxe.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Node lance alors une <a href="#errors">exception</a> et le programme s&#8217;arrête aussitôt.
</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Module &#8220;modules&#8221;</div>
<div class="paragraph">
<p>L&#8217;intégralité des variables, fonctions et classes du module <code>modules</code>
est documentée sur le site web du projet Node.
La documentation contient des informations à jour et qui ne sont pas
forcément listées dans cet ouvrage.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/modules.html" class="bare">nodejs.org/docs/latest-v10.x/api/modules.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
<div class="sect2">
<h3 id="esm">3.3. Le futur : les modules ECMAScript</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Pendant que le mécanisme de modules de Node montait en puissance,
les navigateurs web étaient en attente d&#8217;une solution native.
La spécification des modules ECMAScript a été validée en&#160;2013,
mais les navigateurs ont tardé à en implémenter le mécanisme&#160;:
en&#160;2017 pour la plupart.
C&#8217;est le cas du navigateur web Chrome et de
sa <a href="../chapter-01/index.html#v8">machine virtuelle&#160;V8</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">🚨</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Fonctionnalité expérimentale</div>
<div class="paragraph">
<p>Si la syntaxe des modules ECMAScript est standardisée,
ce n&#8217;est pas encore aussi stable du côté de&#160;Node.</p>
</div>
<div class="paragraph">
<p>Les modules ECMAScript sont suffixés de l&#8217;extension <code>.mjs</code>
et nécessitent l&#8217;utilisation de l'<a href="#options">option de démarrage</a>
<code>--experimental-modules</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Reprenons l&#8217;exemple <code>modules/increment.js</code> pour le
transformer en module ECMAScript.</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/increment.mjs</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">++</span>counter<span class="token punctuation">;</span>           <span class="token comment">// <b class="conum">(1)</b></span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Export par défaut.</p>
</li>
<li>
<p>Export nommé.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La syntaxe <code>export</code> sert à exporter des variables.
Elle se combine avec <code>import</code>&#160;:

</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/ecmascript.mjs</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> increment <span class="token keyword">from</span> <span class="token string">'./increment.js'</span><span class="token punctuation">;</span>     <span class="token comment">// <b class="conum">(1)</b></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On n&#8217;importe ici que la valeur par défaut.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il ne nous reste maintenant plus qu&#8217;à exécuter notre script <code>.mjs</code>
pour observer le résultat.
On notera l&#8217;utilisation de <code>--experimental-modules</code>&#160;:
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --experimental-modules modules/ecmascript.mjs
(node:35074) ExperimentalWarning: The ESM module loader is experimental.
1</pre>
</div>
</div>
<div class="paragraph">
<p>Reprenons cet exemple pour importer plusieurs exports d&#8217;un coup&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">modules/ecmascript-multiple.mjs</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">import</span> increment<span class="token punctuation">,</span> <span class="token punctuation">{</span>reset<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./increment.mjs'</span><span class="token punctuation">;</span> <span class="token comment">// <b class="conum">(1)</b></span>

<span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                          <span class="token comment">// <b class="conum">(2)</b></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On importe la valeur par défaut, ainsi qu&#8217;une valeur nommée&#160;– c&#8217;est particulièrement pratique pour sélectionner avec finesse ce que l&#8217;on veut utiliser d&#8217;un module.</p>
</li>
<li>
<p>La fonction <code>reset()</code> remet le compteur à&#160;zéro.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On notera au passage qu&#8217;on utilise la
<a href="../chapter-03/index.html#object-destructuring">décomposition d&#8217;objet</a>
pour extraire un export nommé depuis un module ECMAScript.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --experimental-modules modules/ecmascript-multiple.mjs
(node:35074) ExperimentalWarning: The ESM module loader is experimental.
2
1</pre>
</div>
</div>
<div class="paragraph">
<p>La fonction <code>reset()</code> a bien remis le compteur à zéro entre-temps.
Objectif accompli&#160;!</p>
</div>
<div class="paragraph">
<p>Résumons les différences notables avec le mécanisme de modules&#160;Node&#160;:




</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tous les appels à <code>import</code> doivent se faire en début de fichier.</p>
</li>
<li>
<p>On ne peut pas utiliser <code>import</code> de manière dynamique
(dans un <code>if &#8230;&#8203; else</code> par exemple).</p>
</li>
<li>
<p>On peut exporter une variable par défaut et plusieurs variables nommées.</p>
</li>
<li>
<p>Il est possible d&#8217;importer des modules Node depuis un module ECMAScript&#160;–
l&#8217;inverse n&#8217;est pas&#160;vrai.</p>
</li>
<li>
<p>Les fichiers doivent être suffixés par&#160;<code>.mjs</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce dernier point est le plus embêtant car il ralentit l&#8217;interopérabilité
entre les scripts destinés au développement web <em>front-end</em> et les scripts&#160;Node.</p>
</div>
<div class="paragraph">
<p>L&#8217;histoire nous dira si les modalités s&#8217;assoupliront avec le temps.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Module&#160;esm</div>
<div class="paragraph">
<p>Le <a href="../chapter-05/index.html#modules">module&#160;<code>npm</code></a>&#160;<code>esm</code>
(<span class="URL"><a href="https://npmjs.com/esm" class="bare">npmjs.com/esm</a></span>) a pris le parti de déblayer le chemin
de l&#8217;interopérabilité.
Il suffit de le charger avant de démarrer un script Node,
peu importe son mécanisme de chargement de modules&#160;:
<code>esm</code> rend le chargement des modules totalement transparent.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -r esm modules/ecmascript.js
1
<span data-bash-subs="$"></span>node -r esm modules/ecmascript.mjs
1</pre>
</div>
</div>
<div class="paragraph">
<p>Pour en savoir plus sur l&#8217;option&#160;<code>-r</code>, rendez-vous
dans la section &#8220;<a href="#require">Précharger un module</a>&#8221;.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Modules ECMAScript</div>
<div class="paragraph">
<p>L&#8217;intégralité des fonctionnalités des modules ECMAScript
est documentée sur le site web du projet Node.
La documentation contient des informations à jour et qui ne sont pas
forcément listées dans cet ouvrage.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/esm.html" class="bare">nodejs.org/docs/latest-v10.x/api/esm.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="errors">4. S&#8217;en sortir quand ça ne se passe pas comme&#160;prévu</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>On fait toutes et tous des erreurs.
Notre code va forcément mener à des plantages applicatifs.
La nature des causes varie et affecte notre lecture des messages d&#8217;erreur.</p>
</div>
<div class="paragraph">
<p>Cette section a pour intention de nous aider à prendre confiance dans ce qu&#8217;on
voit et de piocher l&#8217;information qui va nous aider à résoudre le problème.</p>
</div>
<div class="sect2">
<h3 id="une_erreur_est_nichée_dans_notrecode">4.1. Une erreur est nichée dans notre&#160;code</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Il y a deux familles d&#8217;erreurs dans du code ECMAScript&#160;: celles de syntaxe
et celles d&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>Dans tous les cas, Node lance une exception complétée d&#8217;une trace d&#8217;erreur.
Le but est de comprendre où l&#8217;interpréteur se prend les pieds dans le tapis
et quel est le chemin parcouru au sein du code pour y parvenir.</p>
</div>
<div class="paragraph">
<p>Commençons avec une erreur de syntaxe&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node <mark>syntax-error.js</mark>
console.log(<mark>'oups j'</mark>ai fait une erreur de guillemets);
            ^^^^^^^^

<mark>SyntaxError</mark>: <mark>missing ) after argument list</mark>
    at new Script (vm.js:74:7)
    at createScript (vm.js:246:10)
    at Object.runInThisContext (vm.js:298:10)</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Une erreur de syntaxe est immédiate</strong>.
Node la détecte lorsqu&#8217;il <em>parse</em> notre code.</p>
</div>
<div class="paragraph">
<p>Dans l&#8217;exemple précédent, Node indique qu&#8217;il manque une parenthèse après le
deuxième guillemet, car c&#8217;est le symbole que l&#8217;interpréteur attend.
En effet, le guillemet indique une intention incorrecte&#160;: on ne veut pas qu&#8217;il
signifie la fin de la chaîne, mais qu&#8217;il représente un caractère apostrophe dans
la chaîne.</p>
</div>
<div class="paragraph">
<p>La correction à entreprendre ne sera pas d&#8217;ajouter une parenthèse après le
guillemet mais bien de l&#8217;échapper en le préfixant d&#8217;un caractère&#160;<code>\</code>.
Node l&#8217;interprétera alors correctement.</p>
</div>
<div class="paragraph">
<p>Penchons-nous à présent sur les erreurs provoquées lorsque le code est exécuté&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node process/exit-error.js
console.log(<mark>jenexistepas</mark>);
            ^
<mark>ReferenceError</mark>: <mark>jenexistepas</mark> <mark>is not defined</mark>
    at Object.<anonymous> (/.../chapter-04/examples/process/<mark>exit-error.js</mark>:<mark>5</mark>:13)
    at Module._compile (module.js:643:30)</pre>
</div>
</div>
<div class="paragraph">
<p>Le marqueur <code>+^+</code>&#160;indique l&#8217;emplacement où le problème est rencontré.
La ligne en-dessous documente le type d&#8217;erreur (<code>ReferenceError</code>)
en précisant ce qui n&#8217;est pas défini (la variable <code>jenexistepas</code>).
La notation <code>exit-error.js:5:13</code> indique que l&#8217;origine de l&#8217;erreur
se trouve à la <em>ligne&#160;5</em> du fichier <code>exit-error.js</code>.</p>
</div>
<div class="paragraph">
<p>Pour y remédier, il faut vérifier si on appelle bien la bonne variable ou la
créer avec la valeur attendue le cas échéant.</p>
</div>
<div class="paragraph">
<p>Les erreurs d&#8217;exécution sont pernicieuses&#160;; elles sont parfois
provoquées après le démarrage de l&#8217;application.
Dans l&#8217;exemple qui suit, l&#8217;une d&#8217;elles se produit deux secondes après le
démarrage du script&#160;:

</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node runtime-error.js
setTimeout(() => console.log(<mark>secret.toLocaleUperCase()</mark>), 2000);
                                    ^
<mark>TypeError</mark>: <mark>secret.toLocaleUperCase</mark> <mark>is not a function</mark>
    at Timeout.setTimeout [as _onTimeout] (/.../chapter-04/examples/runtime-error.js:4:37)</pre>
</div>
</div>
<div class="paragraph">
<p>La notation <code>runtime-error.js:4:37</code> indique que l&#8217;origine de l&#8217;erreur
se trouve à la <em>ligne&#160;4</em> du fichier <code>runtime-error.js</code>, <em>colonne&#160;37</em>.
Le type d&#8217;erreur (<code>TypeError</code>) signifie qu&#8217;on cherche à manipuler une variable
de manière <strong>inattendue par rapport à son type</strong>.
Le message d&#8217;erreur nous précise qu&#8217;on appelle comme une fonction quelque chose
qui ne serait donc pas une fonction.</p>
</div>
<div class="paragraph">
<p>En effet, le nom de la fonction est mal orthographié et <code>secret.toLocaleUperCase</code>
vaut <code>undefined</code>.
L&#8217;erreur sera corrigée en utilisant <code>secret.toLocaleUpperCase</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Module eslint</div>
<div class="paragraph">
<p>
Le module&#160;<code>npm</code>&#160;<code>eslint</code> (<span class="URL"><a href="https://npmjs.com/eslint" class="bare">npmjs.com/eslint</a></span>)
est un vérificateur syntaxique.
Son intention est de s&#8217;accorder sur le style d&#8217;écriture et d&#8217;éviter des
effets de bord du langage
qui causent des problèmes difficiles à déceler.</p>
</div>
<div class="paragraph">
<p>On apprendra à le configurer dans l'<a href="../appendix-a/index.html#eslint">annexe&#160;A</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les erreurs affichées affichent des informations importantes.
Si elles n&#8217;indiquent pas forcément le chemin de résolution évident,
elles demandent qu&#8217;on cherche à en comprendre la nature.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Module pretty-error</div>
<div class="paragraph">
<p>
Le module&#160;<code>npm</code>&#160;<code>pretty-error</code> (<span class="URL"><a href="https://npmjs.com/pretty-error" class="bare">npmjs.com/pretty-error</a></span>)
enjolive l&#8217;affichage des erreurs.
Il suffit de l&#8217;installer, de le <a href="#require">précharger</a> et
d&#8217;exécuter un script pour en bénéficier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -r pretty-error/start process/exit-error.js</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="une_erreur_est_retournée_dans_une_fonction_de_rappel">4.2. Une erreur est retournée dans une fonction de rappel</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>La fonction de rappel est un des moyens de retourner le résultat
d&#8217;une exécution asynchrone.
Par convention, le premier paramètre est une erreur.</p>
</div>
<div class="paragraph">
<p>Ce paramètre est nul (<code>null</code>) ou indéfini (<code>undefined</code>) lorsqu&#8217;il n&#8217;y a pas eu
d&#8217;erreurs en cours de route.
En revanche, il contient un objet d&#8217;erreur lorsque un problème s&#8217;est produit.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/callback.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'je-n-existe-pas.txt'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                          <span class="token comment">// <b class="conum">(1)</b></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// <b class="conum">(2)</b></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment">// <b class="conum">(3)</b></span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On vérifie la présence de l&#8217;erreur.</p>
</li>
<li>
<p><code>error.message</code> contient une raison textuelle de l&#8217;erreur.</p>
</li>
<li>
<p>Affichage de l&#8217;objet d&#8217;erreur complet.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/callback.js
<mark>ENOENT</mark>: <mark>no such file or directory</mark>, open '<mark>je-n-existe-pas.txt</mark>'
{ Error: ENOENT: no such file or directory, open 'je-n-existe-pas.txt'
  errno: -2,
  code: 'ENOENT',
  syscall: 'open',
  path: 'je-n-existe-pas.txt' }</pre>
</div>
</div>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;erreur affichée nous précise que le fichier demandé n&#8217;existe pas.
Son code (<code>ENOENT</code>) signifie la même chose, mais a l&#8217;avantage d&#8217;être plus
facile à vérifier dans une condition.</p>
</div>
<div class="paragraph">
<p>L&#8217;objet <code>error</code> donné en argument de la fonction de rappel est utile
pour vérifier des détails précis de l&#8217;erreur et mieux interagir avec
au niveau du code.
Nous y retrouvons le type d&#8217;erreur (<code>errno</code>),
la référence vers la ressource concernée (<code>path</code>) et le nom de la fonction
système utilisée par Node pour accéder à la ressource (<code>syscall</code>).</p>
</div>
<div class="paragraph">
<p>La valeur et la signification du code d&#8217;erreur varie en fonction
du module Node employé à ce moment-là.
Le <a href="#fs">module&#160;<code>fs</code></a> ne retourne pas les mêmes codes
que le <a href="#http">module&#160;<code>http</code></a>.
Les appels à des ressources système retournent
<a href="#errors.system">une variété de codes d&#8217;erreur</a>.</p>
</div>
<div class="paragraph">
<p>La décision nous appartient de savoir quoi faire quand l&#8217;erreur se produit.
Doit-on arrêter le programme avec <a href="#process.exit"><code>process.exit()</code></a>&#160;?
Passe-t-on à la suite en considérant que ce n&#8217;est pas grave&#160;?
Ou peut-être que ce fichier était censé exister et qu&#8217;on devrait
informer l&#8217;équipe de maintenance et
afficher une page d&#8217;erreur côté utilisateur.</p>
</div>
</div>
<div class="sect2">
<h3 id="une_erreur_est_retournée_dans_une_promesse">4.3. Une erreur est retournée dans une promesse</h3>
<div class="paragraph">
<p>

</p>
</div>
<div class="paragraph">
<p>La gestion d&#8217;erreur des <a href="../chapter-03/index.html#promise">promesses</a>
s&#8217;effectue à l&#8217;aide de la fonction <code>.catch()</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/promise.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// <b class="conum">(1)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On génère une erreur dans notre code.</p>
</li>
<li>
<p>L&#8217;objet d&#8217;erreur est transmis à la prochaine occurrence de <code>.catch()</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le contenu de l&#8217;erreur est accessible dans le seul argument de la fonction
de rappel passée à <code>.catch()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/promise.js
Error: <mark>Oops !</mark>
    at <mark>Promise.resolve</mark>.<mark>then</mark> (/.../chapter-04/examples/errors/<mark>promise.js</mark>:<mark>5</mark>:11)
    at process._tickCallback (internal/process/next_tick.js:178:7)</pre>
</div>
</div>
<div class="paragraph">
<p>La trace indique que l&#8217;erreur s&#8217;est produite à la <em>ligne&#160;5</em>,
dans la méthode <code>.then()</code> suite à l&#8217;utilisation de <code>Promise.resolve()</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;utilisation multiple de <code>.catch()</code> nous aide à gérer finement les erreurs&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/promise-chain.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Erreur : %s'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// <b class="conum">(1)</b></span>
    <span class="token keyword">return</span> <span class="token string">'Aaah'</span><span class="token punctuation">;</span>                                <span class="token comment">// <b class="conum">(2)</b></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">// <b class="conum">(3)</b></span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// <b class="conum">(4)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On gère l&#8217;erreur en la signalant dans le terminal.</p>
</li>
<li>
<p>La fonction de rappel a la possibilité de retourner un résultat.</p>
</li>
<li>
<p>Ce résultat est transmis à la prochaine occurrence de <code>.then()</code>.</p>
</li>
<li>
<p>Dans ce cas, le dernier <code>.catch()</code> n&#8217;affiche rien car nous n&#8217;avons pas rencontré d&#8217;autre erreur entre-temps.</p>
</li>
</ol>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/promise-no-catch.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;absence de <code>.catch()</code> provoque un plantage applicatif et le délenchement
de l'<a href="#process.on">événement de processus</a> <code>unhandledRejection</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/promise-no-catch.js
(node:27412) <mark>UnhandledPromiseRejectionWarning</mark>: Error: Oops !
    at <mark>Promise.resolve</mark>.<mark>then</mark> (/.../chapter-04/examples/errors/<mark>promise-no-catch.js</mark>:<mark>5</mark>:11)
    at process._tickCallback (internal/process/next_tick.js:178:7)</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;affichage de <code>UnhandledPromiseRejectionWarning</code> indique que l&#8217;erreur s&#8217;est
produite mais qu&#8217;aucun <code>.catch()</code> ne l&#8217;a pris en charge.
Nous savons cependant que l&#8217;erreur s&#8217;est produite dans la méthode <code>.then()</code>
suite à l&#8217;utilisation de <code>Promise.resolve()</code>.
</p>
</div>
</div>
<div class="sect2">
<h3 id="une_erreur_est_retournée_dans_un_événement">4.4. Une erreur est retournée dans un événement</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Tout élément doté d&#8217;une méthode <code>.on()</code> a un événement spécial&#160;: <code>.on('error')</code>.
Il est appelé à chaque fois qu&#8217;une erreur se produit.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/on-error.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// <b class="conum">(1)</b></span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// <b class="conum">(2)</b></span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On émet un événement <code>error</code> avec un objet <code>Error</code> précisant la nature du problème.</p>
</li>
<li>
<p>L&#8217;objet d&#8217;erreur est transmis à l&#8217;événement <code>error</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/on-error.js
Error: <mark>Oops !</mark>
    at Object.<mark>&lt;anonymous&gt;</mark> (/.../chapter-04/examples/errors/<mark>on-error.js</mark>:<mark>5</mark>:23)
    at Module._compile (internal/modules/cjs/loader.js:678:30)</pre>
</div>
</div>
<div class="paragraph">
<p>La trace d&#8217;erreur est similaire à celle des promesses et des fonctions de rappel.
Le message d&#8217;erreur précise le problème tandis que son origine (fichier, ligne)
nous indiquent quoi regarder pour mieux comprendre la cause.</p>
</div>
<div class="paragraph">
<p>Si une erreur est émise et si aucune fonction n&#8217;est à l&#8217;écoute,
l&#8217;événement <code>uncaughtException</code> est produit&#160;:
</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">errors/on-error.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Oops !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node errors/on-error-uncaught.js
events.js:167
      throw er; // <mark>Unhandled 'error'</mark> event
      ^

Error: Oops !
    at Object.<mark>&lt;anonymous&gt;</mark> (/.../chapter-04/examples/errors/<mark>on-error-uncaught.js</mark>:<mark>3</mark>:23)
    at Module._compile (internal/modules/cjs/loader.js:678:30)</pre>
</div>
</div>
<div class="paragraph">
<p>La section liée au <a href="#events">module <code>events</code></a> explique plus en détail
la gestion des événements.

On les retrouve par exemple dans les modules <a href="#http"><code>http</code></a>, <a href="#stream"><code>stream</code></a>
et <a href="#process"><code>process</code></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="errors.system">4.5. Une erreur est renvoyée par le système d&#8217;exploitation</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;accès à une ressource distante est plus complexe qu&#8217;il n&#8217;y paraît
car les erreurs sont de natures variées et sujettes à interprétation au cas par cas,
en fonction de notre intention et du contexte d&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>Les erreurs système indiquent la raison du problème.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Tableau 3. Erreurs couramment rencontrées</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Code erreur</th>
<th class="tableblock halign-left valign-top">Raison</th>
<th class="tableblock halign-left valign-top">Piste de résolution</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EACCES</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission refusée : nous n&#8217;avons pas le droit d&#8217;accéder à cette ressource.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Changer les permissions d&#8217;accès sans mettre en péril la sécurité.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EADDRINUSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse déjà utilisée : nous tentons de créer une ressource réseau alors qu&#8217;une
interface existe déjà à la même adresse.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vérifier l&#8217;origine du serveur déjà en place à cette adresse. Attribuer une autre adresse/port à la ressource réseau.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ECONNREFUSED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource distante a refusé la connexion.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vérifier si c&#8217;est normal que la ressource distante soit inactive. Vérifier qu&#8217;on se connecte à la bonne ressource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ECONNRESET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource distante a été interrompue en cours de route.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retenter la connexion. Vérifier la stabilité de la connexion réseau.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EEXIST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">La ressource à créer existe&#160;déjà.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C&#8217;est un problème seulement si la ressource n&#8217;était pas censée exister au préalable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EMFILE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trop de fichiers sont ouverts simultanément.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Les systèmes d&#8217;exploitation peuvent travailler sur une quantité finie de fichiers. Peut-être que vous avez ouvert trop de fichiers en même temps. Fermer l&#8217;accès aux fichiers ouverts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENOENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ressource inexistante.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vérifier que le chemin d&#8217;accès est correct. Inspecter la raison de l&#8217;inexistance de la ressource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EPERM</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L&#8217;opération n&#8217;est pas autorisée.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Des droits d&#8217;administration sont nécessaires pour effectuer cette opération.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EPIPE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L&#8217;accès à la ressource distante a été interrompu.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retenter l&#8217;opération.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ETIMEDOUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L&#8217;opération a été annulée car la ressource distante a mis trop de temps pour aboutir.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retenter l&#8217;opération. Vérifier la disponibilité de la ressource distante. S&#8217;assurer que le volume demandé n&#8217;est pas trop important.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>







</p>
</div>
</div>
<div class="sect2">
<h3 id="le_programme_ne_se_termine_pas">4.6. Le programme ne se termine pas</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Il arrive qu&#8217;un programme ne se termine pas contrairement à nos attentes.
Il peut y avoir plusieurs raisons à cela&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une ressource distante <strong>met du temps à répondre</strong>&#160;–
un <em>timeout</em> déclenchera une erreur (généralement sous&#160;30&#160;s).</p>
</li>
<li>
<p>Un traitement prend du temps.</p>
</li>
<li>
<p>Un <strong>événement est en cours d&#8217;écoute</strong>&#160;– typiquement un serveur web qui attend
des requêtes entrantes.</p>
</li>
<li>
<p>Une erreur n&#8217;a pas été capturée et perturbe les instructions suivantes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il faudra inspecter le système pour en savoir plus et observer la
consommation mémoire et CPU du processus Node en question.</p>
</div>
<div class="paragraph">
<p>Peut-être qu&#8217;il faudra sonder le programme pour déceler le point de blocage.
L'<a href="#inspect">inspecteur Node</a> est un outil particulièrement adapté à cet usage.
</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">npm</span> Module debug</div>
<div class="paragraph">
<p>
Le module&#160;<code>npm</code>&#160;<code>debug</code> (<span class="URL"><a href="https://npmjs.com/debug" class="bare">npmjs.com/debug</a></span>) affiche des
messages dans la console de manière conditionnelle.
Les messages s&#8217;affichent lorsque les variables d&#8217;environnement de notre choix
sont renseignées au démarrage de l&#8217;application.</p>
</div>
<div class="paragraph">
<p>On apprendra à le configurer dans l'<a href="../appendix-a/index.html#debug">annexe&#160;A</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="deprecation">4.7. Une alerte de dépréciation s&#8217;affiche</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Un des objectifs de l&#8217;équipe développant Node est de maintenir
la stabilité de la plate-forme.
Certains de leurs choix de conception sont revisités en changeant
leur comportement ou en les retirant des modules de&#160;base.</p>
</div>
<div class="paragraph">
<p>Quand ce changement affecte notre code, une alerte de dépréciation s&#8217;affiche.
Par exemple&#160;:</p>
</div>
<div class="listingblock prismjs highlight-prismjs">
<div class="title">deprecation-warning.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node deprecation-warning.js
(node:8130) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.</pre>
</div>
</div>
<div class="paragraph">
<p>Nous avons ainsi le temps de modifier notre code pour migrer
vers la nouvelle recommandation petit à petit.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="les_différences_decmascript_entre_node_et_les_navigateursweb">5. Les différences d&#8217;ECMAScript entre Node et les navigateurs&#160;web</h2>
<div class="sectionbody">
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Puisqu&#8217;on utilise du code ECMAScript avec Node et avec les navigateurs web,
qu&#8217;est-ce qui les distingue vraiment&#160;?</p>
</div>
<div class="sect2">
<h3 id="labsence_du_dom_et_des_variables_window_et_document">5.1. L&#8217;absence du DOM et des variables <code>window</code> et <code>document</code></h3>
<div class="paragraph">
<p>


</p>
</div>
<div class="paragraph">
<p>Dans Node, il n&#8217;est pas possible de faire appel aux variables <code>window</code>
et <code>document</code> (raccourci pour <code>window.document</code>).</p>
</div>
<div class="paragraph">
<p>Ces variables représentent respectivement la fenêtre/onglet et le document
HTML interprété par le navigateur web.
Les fonctions <code>document.querySelector()</code> et <code>document.createElement()</code>
relèvent du DOM (<em>Document Object Model</em>), une représentation JavaScript interactive
du document&#160;HTML.</p>
</div>
<div class="paragraph">
<p>L&#8217;équivalent de <code>window</code> pour Node serait la variable <a href="#process"><code>process</code></a>&#160;:
elle décrit le processus exécutant notre code.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Variables globales</div>
<div class="paragraph">
<p>La documentation des variables globales est disponible sur le site officiel de Node&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/globals.html" class="bare">nodejs.org/docs/latest-v10.x/api/globals.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="il_ny_a_pas_dinterface_graphique">5.2. Il n&#8217;y a pas d&#8217;interface graphique</h3>
<div class="paragraph">
<p>Suite logique du point précédent&#160;: Node n&#8217;a pas d&#8217;interface graphique.
Le code exécuté n&#8217;affiche rien en tant que tel, à part les messages dirigés
vers la <a href="#console">console</a>.</p>
</div>
<div class="paragraph">
<p>L'<a href="#inspect">inspecteur Node</a> est un moyen de visualiser l&#8217;état interne
d&#8217;un script.</p>
</div>
<div class="paragraph">
<p>On peut toutefois construire des applications graphiques en ligne de commande
(<a href="../chapter-08/index.html">chapitre&#160;8</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="le_mécanisme_de_modules">5.3. Le mécanisme de modules</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Pour l&#8217;instant, Node utilise un <a href="#modules">mécanisme de modules</a> (CommonJS)
différent des modules ECMAScript des navigateurs.</p>
</div>
<div class="paragraph">
<p>La convergence vers les modules ECMAScript est en cours.
Il y a fort à parier qu&#8217;ils seront pris en charge nativement par Node dans une
version ultérieure.</p>
</div>
<div class="paragraph">
<p>Nous verrons au <a href="../chapter-08/index.html">chapitre&#160;9</a> comment utiliser
les modules Node dans les navigateurs.</p>
</div>
</div>
<div class="sect2">
<h3 id="linterfaçage_avec_le_système_dexploitation">5.4. L&#8217;interfaçage avec le système d&#8217;exploitation</h3>
<div class="paragraph">
<p>Les fonctions ECMAScript spécifiques aux navigateurs sont liées
à la récupération d&#8217;informations (<code>AJAX</code>, <code>fetch()</code>),
à l&#8217;affichage (Canvas, WebGL, WebVR) ainsi qu&#8217;à la manipulation de
documents&#160;HTML.</p>
</div>
<div class="paragraph">
<p>Les fonctions ECMAScript fournies par les <a href="#modules-builtin">modules Node</a>
sont liées à la gestion des ressources dont le système d&#8217;exploitation
se fait l&#8217;interface&#160;: fichiers&#160;(<a href="#fs"><code>fs</code></a>),
réseau&#160;(<a href="#http"><code>http</code></a>, <a href="#net"><code>net</code></a>, <a href="#dns"><code>dns</code></a>,
<a href="#dgram"><code>dgram</code></a>), terminal&#160;(<a href="#tty"><code>tty</code></a>, <a href="#readline"><code>readline</code></a>)
et processus&#160;(<a href="#process"><code>process</code></a>, <a href="#child_process"><code>child_process</code></a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="node_est_un_processus_système">5.5. Node est un processus système</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Le système d&#8217;exploitation crée un nouveau processus dès
qu&#8217;on exécute le programme <code>node</code>.
Il peut être de courte ou de longue durée, selon qu&#8217;il dure quelques secondes
ou un temps indéfini.</p>
</div>
<div class="paragraph">
<p>Le processus s&#8217;arrête en cas d&#8217;erreur, lorsqu&#8217;il n&#8217;y a plus d&#8217;opération
à effectuer ou en cas d&#8217;interruption volontaire.</p>
</div>
<div class="paragraph">
<p>Le code ECMAScript exécuté dans un navigateur dépasse rarement la durée
d&#8217;une session utilisateur, de quelques secondes à quelques heures.
En cas de problème, un rafraîchissement de la page remet à zéro son&#160;état.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Performances</span> Utilisation des&#160;CPU</div>
<div class="paragraph">
<p>Un processus Node est <em>mono</em> CPU.
Tous les autres processus système affectés à cette même CPU
se partageront une quantité finie de puissance.</p>
</div>
<div class="paragraph">
<p>Par exemple, si un processus Node partage la même CPU qu&#8217;une base de données
et si une requête gourmande s&#8217;exécute, la rapidité de notre application
en sera affectée.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="options">6. Options utiles pour démarrer&#160;Node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>L&#8217;exécutable <code>node</code> accepte plusieurs options afin de personnaliser
son comportement et l&#8217;affichage des résultats.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> Exécutable&#160;node</div>
<div class="paragraph">
<p>La documentation de l&#8217;exécutable <code>node</code> est disponible sur le site officiel&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://nodejs.org/docs/latest-v10.x/api/cli.html" class="bare">nodejs.org/docs/latest-v10.x/api/cli.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="print-eval">6.1. Afficher le résultat d&#8217;une expression, sans&#160;script</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;interpréteur Node sait interpréter du code qu&#8217;on lui donne
via l&#8217;option&#160;<code>-p</code> (pour <em>print</em>, c&#8217;est-à-dire <em>afficher</em>).
Il affiche le résultat de l&#8217;expression ou détaille la <a href="#errors">raison de l&#8217;erreur</a>.</p>
</div>
<div class="paragraph">
<p>J&#8217;utilise cette forme d&#8217;interaction pour obtenir un résultat rapide,
sans créer de nouveau fichier, par exemple, pour une opération mathématique&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -p '2 + 2'
4</pre>
</div>
</div>
<div class="paragraph">
<p>Toute expression ECMAScript valide est acceptée&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node -p '"abc".toLocaleUpperCase()'
ABC</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="options-require">6.2. Précharger un module</h3>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>L&#8217;option de démarrage <code>--require</code> charge le module indiqué avant le script&#160;Node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --require ./print-exit.js url/intro.js</pre>
</div>
</div>
<div class="paragraph">
<p>Dans cet exemple, le <a href="#modules">module <code>print-exit.js</code></a> sera chargé
avant <code>url/intro.js</code>.</p>
</div>
<div class="listingblock prismjs highlight-prismjs interactive interactive--javascript interactive--runtime--node-v10">
<div class="title">print-exit.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>filename<span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>mainModule<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : arrêt avec le code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le chargement de ce module aura pour effet d&#8217;afficher un message
avec le chemin du fichier chargé et le <a href="#process.exit">code de sortie</a>.</p>
</div>
<div class="paragraph">
<p>On peut appeler l&#8217;option <code>--require</code> plusieurs fois, ou son raccourci&#160;`-r`.</p>
</div>
<div class="paragraph">
<p>Ce mécanisme fonctionne très bien avec des
<a href="../chapter-05/index.html">modules&#160;<code>npm</code></a> conçus pour
rendre nos scripts <a href="#esm">compatibles avec les modules ECMAScript</a>
ou pour <a href="#pretty-error">simplifier les erreurs</a> affichées
lors d&#8217;un plantage applicatif, entre autres.</p>
</div>
</div>
<div class="sect2">
<h3 id="inspect">6.3. Inspecter notre code avec Google&#160;Chrome</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Node accepte deux options <code>--inspect</code> et <code>--inspect-brk</code>.
Elles exposent un protocole de débogage auquel on peut se connecter
avec le navigateur Chrome.</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --inspect-brk print-text.js texte --uppercase
Debugger listening on ws://127.0.0.1:9229/ddd9bbfd-09ac-4426-a53e-c8abe4fc36da
For help see https://nodejs.org/en/docs/inspector</pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande lance un de nos exemples de la section
sur le <a href="#process">module&#160;<code>process</code></a>.
L&#8217;option <code>--inspect-brk</code> démarre l&#8217;inspecteur
et met aussitôt son exécution en pause.</p>
</div>
<div class="paragraph">
<p>Le logo de Node s&#8217;affiche dans les outils de développement de Chrome&#160;:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/chrome-devtools.png" alt="chrome devtools" width="85%">
</div>
<div class="title">Figure 8. Outils de développement Google Chrome avec l&#8217;icône de l&#8217;inspecteur&#160;Node</div>
</div>
<div class="paragraph">
<p>Un clic sur le logo Node ouvre une nouvelle fenêtre, outillée pour inspecter
ce qui se passe dans notre script.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/inspector-paused.png" alt="inspector paused" width="85%">
</div>
<div class="title">Figure 9. Inspecteur en pause sur la première ligne de notre script&#160;Node</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Outils de développement</span> Point d&#8217;arrêt</div>
<div class="paragraph">
<p>Un point d&#8217;arrêt se crée en cliquant sur le numéro de ligne souhaité.</p>
</div>
<div class="paragraph">
<p>Le débogueur se mettra en pause à chaque fois que le chemin d&#8217;exécution
de l&#8217;interpréteur atteindra cette ligne.</p>
</div>
<div class="paragraph">
<p>La valeur des variables ECMAScript courantes s&#8217;affichent au survol de la souris
ou en interagissant avec la console.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/inspector-breakpoint.png" alt="inspector breakpoint" width="85%">
</div>
<div class="title">Figure 10. Inspecteur en pause, avec un point d&#8217;arrêt marqué sur une des lignes du&#160;script</div>
</div>
<div class="paragraph">
<p>C&#8217;est le moment idéal pour placer un ou plusieurs point(s) d&#8217;arrêt.</p>
</div>
<div class="paragraph">
<p>Un clic sur le bouton&#160;<b class="button">&#9654;</b> met alors fin à la pause.
Le script s&#8217;exécutera jusqu&#8217;à l&#8217;épuisement des instructions
ou jusqu&#8217;au <em>prochain point d&#8217;arrêt</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/inspector-breakpoint-in.png" alt="inspector breakpoint in" width="85%">
</div>
<div class="title">Figure 11. Inspecteur en pause, suite à la rencontre d&#8217;un point d&#8217;arrêt</div>
</div>
<div class="paragraph">
<p>L&#8217;option <code>--inspect</code> est adaptée à des processus de longue durée,
comme un serveur HTTP.
L&#8217;option <code>--inspect-brk</code> est adaptée à des processus de courte durée et qui
se termineraient avant qu&#8217;on ait le temps de jeter un œil au contenu.</p>
</div>
</div>
<div class="sect2">
<h3 id="options-v8">6.4. Ajuster les options de compatibilité et de traçabilité de&#160;V8</h3>
<div class="paragraph">
<p>
</p>
</div>
<div class="paragraph">
<p>Node repose sur la <a href="../chapter-01/index.html#v8">machine virtuelle&#160;V8</a>
pour interpréter nos instructions ECMAScript et en expose différentes options
pour affiner son comportement en fonction
de notre environnement.</p>
</div>
<div class="paragraph">
<p>L&#8217;intégralité des options de configuration de&#160;V8 s&#8217;affiche
avec l&#8217;option <code>--v8-options</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node --v8-options</pre>
</div>
</div>
<div class="paragraph">
<p>Il n&#8217;y a pas de meilleure configuration qui conviendrait à chacun de nos usages.
Le mieux reste encore d&#8217;explorer les options possibles, les différents concepts
et d&#8217;ajuster les valeurs offrant le meilleur rapport stabilité/performances.</p>
</div>
<div class="dlist">
<div class="title">Options notables de V8</div>
<dl>
<dt class="hdlist1"><code>--optimize_for_size</code></dt>
<dd>
<p>Optimise le fonctionnement interne pour utiliser moins de mémoire,
au détriment de la vitesse.
Idéal pour l&#8217;exécution de scripts Node sur des environnements à faible mémoire,
comme les Raspberry&#160;Pi.</p>
</dd>
<dt class="hdlist1"><code>--mem_old_space_limit</code></dt>
<dd>
<p>Détermine la quantité de mémoire maximale qu&#8217;un processus Node pourra utiliser.
Idéal pour le confiner sur des environnements à faible mémoire.</p>
</dd>
<dt class="hdlist1"><code>--gc_inverval</code></dt>
<dd>
<p>Détermine le nombre de cycles entre chaque déclenchement du ramasse-miettes.</p>
</dd>
<dt class="hdlist1"><code>--expose_gc</code></dt>
<dd>
<p>Expose les fonctions de manipulation du ramasse-miettes.
Idéal si vous souhaitez contrôler finement l&#8217;optimisation de la mémoire.</p>
</dd>
<dt class="hdlist1"><code>--stack_trace_limit</code></dt>
<dd>
<p>Change la limite du nombre de lignes affichées dans une trace d&#8217;erreur
(10 par défaut).</p>
</dd>
<dt class="hdlist1"><code>--trace-deopt</code></dt>
<dd>
<p>Signale les optimisations invalidées par&#160;V8.
Les portions de code indiquées gagneraient à être retravaillées, pour rendre
uniforme le type de variables passées en arguments par exemple.</p>
</dd>
<dt class="hdlist1"><code>--trace-gc</code></dt>
<dd>
<p>Signale les moments où le ramasse-miettes se déclenche.
On peut ainsi mieux en comprendre les raisons.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">💬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Notion</span> Ramasse-miettes (<em>garbage collector</em>)</div>
<div class="paragraph">
<p>Le ramasse-miettes est un mécanisme informatique qui libère les objets inutilisés
de la mémoire.
Il est déclenché de manière cyclique par la
<a href="../chapter-01/index.html#v8">machine virtuelle&#160;V8</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://fr.wikipedia.org/wiki/Ramasse-miettes_(informatique" class="bare">fr.wikipedia.org/wiki/Ramasse-miettes_(informatique</a>)</span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les options préfixées par <code>harmony</code> activent la prise en charge
de fonctionnalités ECMAScript qui ne font pas encore partie du standard.
Elles sont encore au stade expérimental.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">7. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les modules de base sont un élément différenciant entre Node et le langage
ECMAScript.
Ils nous interfacent avec le système d&#8217;exploitation pour naviguer dans les fichiers,
ouvrir des connexions réseau et télécharger des fichiers distants.
<strong>Bien les connaître nous aidera au quotidien</strong>.</p>
</div>
<div class="paragraph">
<p>L&#8217;organisation des modules CommonJS&#160;– voire des modules ECMAScript&#160;– est l&#8217;autre
élément majeur de ce chapitre.
Avec cela, nous rendons notre <strong>code modulaire, réutilisable et donc testable</strong>.</p>
</div>
<div class="paragraph">
<p>Toutes ces connaissances seront largement réutilisées dans les chapitres suivants.
Elles nous aideront à mieux choisir nos modules&#160;<code>npm</code> dans le chapitre&#160;5,
à structurer une application web au chapitre&#160;7, à créer de belles applications
en ligne de commande au chapitre&#160;8 et même à partager du code entre Node
et les navigateurs au chapitre&#160;9.</p>
</div>
</div>
</div>
</div>
<section class="next">
  <a href="#top">Haut de page</a> ou
  <a href="https://oncletom.io/node.js/#apprendre-node-js-en-ligne" class="read-more">retour au sommaire</a>.
</section>
</body>
</html>